!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@milque/display"),require("@milque/input"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["exports","@milque/display","@milque/input","gl-matrix"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Milque={},t.display,t.input,t.glMatrix)}(this,(function(t,e,r,n){"use strict";class s{next(){return Math.random()}}let i;class o{constructor(t=new s){this.generator=t}static next(){return i.next()}next(){return this.generator.next()}static choose(t){return i.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return i.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static sign(){return i.sign()}sign(){return this.generator.next()<.5?-1:1}}i=new o;var a=Object.freeze({__proto__:null,line:function(t,e,r,n,s){let i=Math.floor(t),o=Math.floor(e),a=Math.floor(r),l=Math.floor(n),u=Math.abs(r-t),c=t<r?1:-1,h=-Math.abs(n-e),f=e<n?1:-1,d=u+h,p=i,m=o,y=s(p,m);if(void 0!==y)return y;let g=u*u+h*h,b=0;for(;b<g&&(p!==a||m!==l);){++b;let t=2*d;if(t>=h&&(d+=h,p+=c),t<=u&&(d+=u,m+=f),y=s(p,m),void 0!==y)return y}}});function l(t,e){const r=document.createElement("a"),n=e.indexOf(";");e=e.substring(0,n+1)+"headers=Content-Disposition%3A%20attachment%3B%20filename="+t+";"+e.substring(n+1),r.setAttribute("href",e),r.setAttribute("download",t),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}const u=["svg","g"];function c(t,e=t.cloneNode(!0)){let r=t.childNodes,n=e.childNodes;for(var s=0;s<n.length;s++){let t=n[s],e=t.tagName;if(-1!=u.indexOf(e))c(r[s],t);else if(r[s]instanceof Element){const e=window.getComputedStyle(r[s]);let n=[];for(let t of Object.keys(e))n.push(`${t}:${e.getPropertyValue(t)};`);t.setAttribute("style",n.join(""))}}return e}var h=Object.freeze({__proto__:null,FILE_TYPE_PNG:"png",FILE_TYPE_SVG:"svg",downloadText:function(t,e){l(t,"data:text/plain; charset=utf-8,"+encodeURIComponent(e))},downloadImageFromSVG:function(t,e,r,n,s){const i=function(t){const e=c(t),r=(new XMLSerializer).serializeToString(e);return new Blob([r],{type:"image/svg+xml"})}(r);switch(e){case"png":{const r=URL.createObjectURL(i),o=document.createElement("canvas"),a=o.getContext("2d"),u=window.devicePixelRatio||1;o.width=n*u,o.height=s*u,o.style.width=n+"px",o.style.height=s+"px",a.setTransform(u,0,0,u,0,0);const c=new Image;c.onload=()=>{a.drawImage(c,0,0),URL.revokeObjectURL(r);const n=o.toDataURL("image/"+e).replace("image/"+e,"image/octet-stream");l(t,n)},c.src=r}break;case"svg":{const e=new FileReader;e.onload=()=>{l(t,e.result)},e.readAsDataURL(i)}break;default:throw new Error("Unknown file type '"+e+"'")}},downloadURL:l});var f=Object.freeze({__proto__:null,uploadFile:async function(t=[],e=!1){return new Promise(((r,n)=>{const s=document.createElement("input");s.addEventListener("change",(t=>{r(e?t.target.files:t.target.files[0])})),s.type="file",s.accept=t.join(","),s.style.display="none",s.toggleAttribute("multiple",e),document.body.appendChild(s),s.click(),document.body.removeChild(s)}))}});const d={5:m("#7F8C8D"),4:m("#2ECC71"),3:m("#4794C8"),2:m("#F39C12"),1:m("#C0392B"),0:[""]};function p(t,e){return t-e}function m(t){return[`background: ${t}`,"border-radius: 0.5em","color: white","font-weight: bold","padding: 2px 0.5em"]}function y(){}function g(t){switch(t){case 5:return console.trace;case 4:case 3:return console.log;case 2:return console.warn;case 1:return console.error;case 0:return y;default:return console.log}}function b(t,e,r,n){if(e&&t.unshift(`[${e}]`),r){let e=[`%c${r}`,d[n].join(";")];t.unshift(e[0],e[1])}return t}const x=Symbol("level"),_=Symbol("domain"),w={};let A=2,v="app";class M{static get TRACE(){return 5}static get DEBUG(){return 4}static get INFO(){return 3}static get WARN(){return 2}static get ERROR(){return 1}static get OFF(){return 0}static getLogger(t){return t in w?w[t]:w[t]=new M(t)}static useDefaultLevel(t){return A=t,this}static useDefaultDomain(t){return v=t,this}constructor(t){this.name=t,this[x]=A,this[_]=v}setLevel(t){return this[x]=t,this}getLevel(){return this[x]}setDomain(t){return this[_]=t,this}getDomain(){return this[_]}log(t,...e){if(p(this[x],t)<0)return this;b(e,this.name,this[_],t),g(t)(...e)}trace(...t){if(p(this[x],5)<0)return this;b(t,this.name,this[_],5),g(5)(...t)}debug(...t){if(p(this[x],4)<0)return this;b(t,this.name,this[_],4),g(4)(...t)}info(...t){if(p(this[x],3)<0)return this;b(t,this.name,this[_],3),g(3)(...t)}warn(...t){if(p(this[x],2)<0)return this;b(t,this.name,this[_],2),g(2)(...t)}error(...t){if(p(this[x],1)<0)return this;b(t,this.name,this[_],1),g(1)(...t)}}var N=Object.freeze({__proto__:null,Logger:M});const E={on(t,e,r=e){let n;if(this.__events.has(t)?n=this.__events.get(t):(n=new Map,this.__events.set(t,n)),n.has(r))throw new Error(`Found callback for event '${t}' with the same handle '${r}'.`);return n.set(r,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const r=this.__events.get(t);if(!r.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);r.delete(e)}return this},once(t,e,r=e){return this.on(t,((...n)=>{this.off(t,r),e.apply(this.__context||this,n)}),r)},emit(t,...e){if(this.__events.has(t)){let r=[];const n=Array.from(this.__events.get(t).values());for(const t of n){let n=t.apply(this.__context||this,e);n&&r.push(n)}return r}return this.__events.set(t,new Map),[]}};function T(t){const e=Object.create(E);return e.__events=new Map,e.__context=t,e}function S(t,e){const r=Object.assign(t,E);return r.__events=new Map,r.__context=e,r}function I(t,e){const r=t.prototype;return Object.assign(r,E),r.__events=new Map,r.__context=e,r}var F={create:T,assign:S,mixin:I},O=Object.freeze({__proto__:null,create:T,assign:S,mixin:I,default:F});class R{constructor(t){this._heap=[],this._comparator=t}get size(){return this._heap.length}clear(){this._heap.length=0}push(...t){for(const e of t)this._heap.push(e),this._shiftUp()}pop(){const t=this.peek();let e=this._heap.length-1;return e>0&&this._swap(0,e),this._heap.pop(),this._shiftDown(),t}replace(t){const e=this.peek();return this._heap[0]=t,this._shiftDown(),e}peek(){return this._heap[0]}_compare(t,e){return this._comparator(this._heap[t],this._heap[e])}_swap(t,e){let r=this._heap[t];this._heap[t]=this._heap[e],this._heap[e]=r}_shiftUp(){let t,e=this._heap.length-1;for(;e>0&&this._compare(e,t=(e+1>>>1)-1);)this._swap(e,t),e=t}_shiftDown(){const t=this._heap.length;let e,r=0,n=k(r),s=n<t,i=B(r),o=i<t;for(;s&&this._compare(n,r)||o&&this._compare(i,r);)e=o&&this._compare(i,n)?i:n,this._swap(r,e),r=e,n=k(r),s=n<t,i=B(r),o=i<t}values(){return this._heap}[Symbol.iterator](){return this._heap[Symbol.iterator]()}}function k(t){return 1+(t<<1)}function B(t){return t+1<<1}function z(t,e,r){return Math.min(r,Math.max(e,t))}function L(t,e,r){let n=r-e,s=(t-e)%n;return s<0&&(s+=n),s+e}const C=Math.PI/180,U=180/Math.PI;function j(t,e,r){if(r.has(e))throw new Error(`Found cyclic dependency for '${e.name||e}'.`);if(!t.visited.has(e)){if(t.visited.add(e),t.edgeMap.has(e)){let n=t.edgeMap.get(e);if(n.size>0){r.add(e);for(let e of n)j(t,e,r);r.delete(e)}}t.dst.push(e)}}async function P(t,e){return new Promise(((e,r)=>{let n=new Image;n.addEventListener("load",(()=>{e(n)})),n.addEventListener("error",(t=>{r(t)})),n.src=t}))}var D=Object.freeze({__proto__:null,loadImage:P});async function V(t,e){return(await fetch(t)).text()}var G=Object.freeze({__proto__:null,loadText:V});async function $(t,e){let r=await fetch(t);return await r.arrayBuffer()}var q=Object.freeze({__proto__:null,loadBytes:$});async function W(t,e){let r=await fetch(t);return await r.json()}var Y=Object.freeze({__proto__:null,loadJSON:W});async function X(t,e){let r=await fetch(t),n=await r.text();{const t=10;for(let e=0;e<t;++e){performance.now();Q(n);performance.now()}}{const t=10;for(let e=0;e<t;++e){performance.now();H(n);performance.now()}}return H(n)}function H(t){const e=[],r=[],n=[],s=[],i=[],o=[],a=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,l=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,u=/vt\s+(\S+)\s+(\S+)/g,c=/f\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))(\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*)))?/g,h=/f\s+([^/\s]+)\s+([^/\s]+)\s+([^/\s]+)/g;let f,d,p,m,y,g,b=!1,x=null;for(t=t.replace(/^#.*/g,"");null!=(x=a.exec(t));)f=Number.parseFloat(x[1]),d=Number.parseFloat(x[2]),p=Number.parseFloat(x[3]),e.push(f),e.push(d),e.push(p);for(;null!=(x=l.exec(t));)f=Number.parseFloat(x[1]),d=Number.parseFloat(x[2]),p=Number.parseFloat(x[3]),n.push(f),n.push(d),n.push(p);for(;null!=(x=u.exec(t));)f=Number.parseFloat(x[1]),d=Number.parseFloat(x[2]),r.push(f),r.push(d);for(;null!=(x=c.exec(t));)f=Number.parseInt(x[2]),Number.isNaN(f)&&(f=1),d=Number.parseInt(x[6]),Number.isNaN(d)&&(d=1),p=Number.parseInt(x[10]),Number.isNaN(p)&&(p=1),s.push(f),s.push(d),s.push(p),f=Number.parseInt(x[4]),Number.isNaN(f)?(f=Number.parseInt(x[3]),d=Number.parseInt(x[7]),p=Number.parseInt(x[11]),o.push(f),o.push(d),o.push(p),i.push(1),i.push(1),i.push(1)):(d=Number.parseInt(x[8]),Number.isNaN(d)&&(d=1),p=Number.parseInt(x[12]),Number.isNaN(p)&&(p=1),o.push(f),o.push(d),o.push(p),f=Number.parseInt(x[3]),Number.isNaN(f)&&(f=1),d=Number.parseInt(x[7]),Number.isNaN(d)&&(d=1),p=Number.parseInt(x[11]),Number.isNaN(p)&&(p=1),i.push(f),i.push(d),i.push(p)),void 0!==x[13]&&(m=Number.parseInt(x[15]),Number.isNaN(m)&&(m=1),s.push(m),m=Number.parseInt(x[17]),Number.isNaN(m)?(m=Number.parseInt(x[16]),o.push(m),i.push(1)):(o.push(m),m=Number.parseInt(x[16]),i.push(m)),b=!0);for(;null!=(x=h.exec(t));)f=Number.parseInt(x[2]),d=Number.parseInt(x[6]),p=Number.parseInt(x[10]),s.push(f),s.push(d),s.push(p),i.push(1),i.push(1),i.push(1),o.push(1),o.push(1),o.push(1),void 0!==x[13]&&(m=Number.parseInt(x[14]),s.push(m),i.push(1),o.push(1),b=!0);g=s.length;const _=new Float32Array(3*g);for(let t=0;t<g;++t)y=s[t]-1,_[3*t+0]=e[3*y+0],_[3*t+1]=e[3*y+1],_[3*t+2]=e[3*y+2];g=i.length;const w=new Float32Array(2*g);for(let t=0;t<g;++t)y=i[t]-1,w[2*t+0]=r[2*y+0],w[2*t+1]=r[2*y+1];g=o.length;const A=new Float32Array(3*g);for(let t=0;t<g;++t)y=o[t]-1,A[3*t+0]=n[3*y+0],A[3*t+1]=n[3*y+1],A[3*t+2]=n[3*y+2];g=s.length;const v=new Uint16Array(g);for(let t=0;t<g;++t)v[t]=t;return b&&console.warn("WebGL does not support quad faces, only triangles."),{positions:_,texcoords:w,normals:A,indices:v}}function Q(t){const e=[],r=[],n=[],s=[],i=[],o=[],a=/v( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,l=/vn( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,u=/vt( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,c=/f( +([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))?/g,h=/f( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g;let f,d,p,m,y,g,b=!1,x=null;for(t=t.replace(/^#.*/g,"");null!=(x=a.exec(t));)f=Number.parseFloat(x[1]),d=Number.parseFloat(x[2]),p=Number.parseFloat(x[3]),e.push(f),e.push(d),e.push(p);for(;null!=(x=l.exec(t));)f=Number.parseFloat(x[1]),d=Number.parseFloat(x[2]),p=Number.parseFloat(x[3]),n.push(f),n.push(d),n.push(p);for(;null!=(x=u.exec(t));)f=Number.parseFloat(x[1]),d=Number.parseFloat(x[2]),r.push(f),r.push(d);for(;null!=(x=c.exec(t));)f=Number.parseInt(x[2]),Number.isNaN(f)&&(f=1),d=Number.parseInt(x[6]),Number.isNaN(d)&&(d=1),p=Number.parseInt(x[10]),Number.isNaN(p)&&(p=1),s.push(f),s.push(d),s.push(p),f=Number.parseInt(x[3]),Number.isNaN(f)&&(f=1),d=Number.parseInt(x[7]),Number.isNaN(d)&&(d=1),p=Number.parseInt(x[11]),Number.isNaN(p)&&(p=1),i.push(f),i.push(d),i.push(p),f=Number.parseInt(x[4]),Number.isNaN(f)&&(f=1),d=Number.parseInt(x[8]),Number.isNaN(d)&&(d=1),p=Number.parseInt(x[12]),Number.isNaN(p)&&(p=1),o.push(f),o.push(d),o.push(p),void 0!==x[13]&&(m=Number.parseInt(x[14]),Number.isNaN(m)&&(m=1),s.push(m),m=Number.parseInt(x[15]),Number.isNaN(m)&&(m=1),i.push(m),m=Number.parseInt(x[16]),Number.isNaN(m)&&(m=1),o.push(m),b=!0);for(;null!=(x=h.exec(t));)f=Number.parseInt(x[2]),d=Number.parseInt(x[6]),p=Number.parseInt(x[10]),s.push(f),s.push(d),s.push(p),i.push(1),i.push(1),i.push(1),o.push(1),o.push(1),o.push(1),void 0!==x[13]&&(m=Number.parseInt(x[14]),s.push(m),i.push(1),o.push(1),b=!0);g=s.length;const _=new Float32Array(3*g);for(let t=0;t<g;++t)y=s[t]-1,_[3*t+0]=e[3*y+0],_[3*t+1]=e[3*y+1],_[3*t+2]=e[3*y+2];g=i.length;const w=new Float32Array(2*g);for(let t=0;t<g;++t)y=i[t]-1,w[2*t+0]=r[2*y+0],w[2*t+1]=r[2*y+1];g=o.length;const A=new Float32Array(3*g);for(let t=0;t<g;++t)y=o[t]-1,A[3*t+0]=n[3*y+0],A[3*t+1]=n[3*y+1],A[3*t+2]=n[3*y+2];g=s.length;const v=new Uint16Array(g);for(let t=0;t<g;++t)v[t]=t;return b&&console.warn("WebGL does not support quad faces, only triangles."),{positions:_,texcoords:w,normals:A,indices:v}}var J=Object.freeze({__proto__:null,loadOBJ:X});let Z={};function K(t,e){Z[t]=e}function tt(t){if(t in Z)return Z[t];throw new Error(`Unknown asset type '${t}'.`)}async function et(t,e={},r="."){if(t.indexOf(":")<0)throw new Error("Missing type for asset source.");let[n,s]=t.split(":"),i=tt(n);return await i(r+"/"+s,e)}K("image",P),K("text",V),K("json",W),K("bytes",$),K("obj",X);var rt=Object.freeze({__proto__:null,defineAssetLoader:K,getAssetLoader:tt,loadAssetMap:async function(t,e="."){let r={};for(let n of Object.keys(t)){let s=t[n];if("string"==typeof s)r[n]=await et(s,void 0,e);else{if("object"!=typeof s)throw new Error("Unknown entry type in asset map.");if(!("src"in s))throw new Error("Missing required field 'src' for entry in asset map.");if("name"in s&&s.name!==n)throw new Error(`Cannot redefine name for asset '${n}' for entry in asset map.`);r[n]=await et(s.src,s,e)}}return r},loadAssetList:async function(t,e="."){let r={};for(let n of t)if("string"==typeof n)r[n]=await et(n,void 0,e);else{if("object"!=typeof n)throw new Error("Unknown entry type in asset list.");if(!("src"in n))throw new Error("Missing required field 'src' for entry in asset list.");r["name"in n?n.name:n.src]=await et(n.src,n,e)}return r},loadAsset:et});const nt=1e-8;function st(t,e,r){return Math.min(Math.max(t,e),r)}function it(t,e,r,n){return{x:t,y:e,rx:r,ry:n}}function ot(t,e,r){let n=r.x-e.x,s=r.rx+e.rx-Math.abs(n);if(s<0)return null;let i=r.y-e.y,o=r.ry+e.ry-Math.abs(i);if(o<0)return null;if(s<o){let i=Math.sign(n);t.dx=s*i,t.dy=0,t.nx=i,t.ny=0,t.x=e.x+e.rx*i,t.y=r.y}else{let n=Math.sign(i);t.dx=0,t.dy=o*n,t.nx=0,t.ny=n,t.x=r.x,t.y=e.y+e.ry*n}return t}function at(t,e,r,n){let s=r-e.x,i=e.rx-Math.abs(s);if(i<0)return null;let o=n-e.y,a=e.ry-Math.abs(o);if(a<0)return null;if(i<a){let r=Math.sign(s);t.dx=i*r,t.dy=0,t.nx=r,t.ny=0,t.x=e.x+e.rx*r,t.y=n}else{let n=Math.sign(o);t.dx=0,t.dy=a*n,t.nx=0,t.ny=n,t.x=r,t.y=e.y+e.ry*n}return t}function lt(t,e,r,n,s,i,o=0,a=0){if(Math.abs(s)<nt&&Math.abs(i)<nt&&0===o&&0===a)return at(t,e,r,n);let l=e.rx,u=e.ry,c=o,h=a,f=1/(s||nt),d=1/(i||nt),p=Math.sign(f),m=Math.sign(d),y=(e.x-p*(l+c)-r)*f,g=(e.y-m*(u+h)-n)*d,b=(e.x+p*(l+c)-r)*f,x=(e.y+m*(u+h)-n)*d;if(y>x||g>b)return null;let _=Math.max(y,g),w=Math.min(b,x);if(_>1||w<0)return null;let A=st(_,0,1),v=(1-A)*-s,M=(1-A)*-i,N=r+s*A,E=n+i*A;return y>g?(t.time=A,t.nx=-p,t.ny=0,t.dx=v,t.dy=M,t.x=N,t.y=E):(t.time=A,t.nx=0,t.ny=-m,t.dx=v,t.dy=M,t.x=N,t.y=E),t}function ut(t,e,r,n,s){if(Math.abs(n)<nt&&Math.abs(s)<nt){let n=ot({},r,e);return n&&(n.time=0),t.x=e.x,t.y=e.y,t.time=n?0:1,t.hit=n,t}let i=function(t,e,r,n,s){return lt(t,e,r.x,r.y,n,s,r.rx,r.ry)}({},r,e,n,s);if(i){let o,a,l=st(i.time,0,1),u=Math.sqrt(n*n+s*s);u?(o=n/u,a=s/u):(o=0,a=0),i.x=st(i.x+o*e.rx,r.x-r.rx,r.x+r.rx),i.y=st(i.y+a*e.ry,r.y-r.ry,r.y+r.ry),t.time=l,t.x=e.x+n*l,t.y=e.y+s*l,t.hit=i}else t.time=1,t.x=e.x+n,t.y=e.y+s,t.hit=i;return t}function ct(t,e,r,n,s){let i={};t.time=1,t.x=e.x+n,t.y=e.y+s,t.hit=null;for(let o=0,a=r.length;o<a;++o){let a=ut(i,e,r[o],n,s);a.time<=t.time&&(t.time=a.time,t.x=a.x,t.y=a.y,t.hit=a.hit)}return t}var ht=Object.freeze({__proto__:null,EPSILON:nt,clamp:st,createAABB:it,createRect:function(t,e,r,n){let s=Math.abs(r-t)/2,i=Math.abs(n-e)/2;return it(Math.min(t,r)+s,Math.min(e,n)+i,s,i)},testAABB:function(t,e){return!(Math.abs(t.x-e.x)>t.rx+e.rx)&&!(Math.abs(t.y-e.y)>t.ry+e.ry)},intersectAABB:ot,intersectPoint:at,intersectSegment:lt,sweepInto:ct});function ft(t,e=[]){for(let r of t)switch(r.type){case"point":r.hit=null;for(let t of e)if(r.hit=at({},t,r.x,r.y),r.hit)break;break;case"segment":r.hit=null;for(let t of e)if(r.hit=lt({},t,r.x,r.y,r.dx,r.dy,r.px,r.py),r.hit)break;break;case"aabb":r.hit=null;for(let t of e)if(r.hit=ot({},t,r),r.hit)break}}function dt(t,e=[],r=1){for(let n of t){let t,s=n.dx*r,i=n.dy*r,o=0,a={},l=null,u=100;do{if(t=ct(a,n,e,s,i),n.x=t.x-Math.sign(s)*nt,n.y=t.y-Math.sign(i)*nt,o+=t.time,t.hit){s+=t.hit.nx*Math.abs(s),i+=t.hit.ny*Math.abs(i),l=t.hit;let e=Math.max(1-o,0);s*=e,i*=e,Math.abs(s)<nt&&(s=0),Math.abs(i)<nt&&(i=0)}}while(o<1&&--u>=0);n.dx=s,n.dy=i,n.hit=l}}var pt=Object.freeze({__proto__:null,computeIntersections:ft,resolveIntersections:dt});var mt=Object.freeze({__proto__:null,createIntersectionWorld:function(){return{dynamics:[],masks:[],statics:[],update(t){dt(this.dynamics,this.statics,t),ft(this.masks,this.statics)},render(t){t.save(),t.strokeStyle="green";for(let e of this.statics)t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry);t.strokeStyle="lime";for(let e of this.dynamics)t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry);t.strokeStyle="blue";for(let e of this.masks)switch(e.type){case"point":t.save(),t.fillStyle="red",t.fillRect(e.x-1,e.y-1,2,2),t.restore();break;case"segment":t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+e.dx,e.y+e.dy),t.stroke();break;case"aabb":t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry)}t.restore()}}}});const yt=new AudioContext;!async function(t){document.addEventListener("click",(()=>{"suspended"===t.state&&t.resume()}))}(yt);const gt={gain:0,pitch:0,pan:0,loop:!1};class bt{constructor(t,e,r=!1){this.context=t,this.buffer=e,this._source=null,this.playing=!1,this.loop=r,this.onAudioSourceEnded=this.onAudioSourceEnded.bind(this)}onAudioSourceEnded(){this._playing=!1}play(t=gt){if(!this.buffer)return;this._source&&this.destroy();const e=this.context;let r=e.createBufferSource();r.addEventListener("ended",this.onAudioSourceEnded),r.buffer=this.buffer,r.loop=t.loop;let n=r;if(t.pitch&&(r.detune.value=100*t.pitch),t.gain){const r=e.createGain();r.gain.value=t.gain,n=n.connect(r)}if(t.pan){const r=e.createStereoPanner();r.pan.value=t.pan,n=n.connect(r)}n.connect(e.destination),r.start(),this._source=r,this._playing=!0}pause(){this._source.stop(),this._playing=!1}destroy(){this._source&&this._source.disconnect(),this._source=null}}var xt=Object.freeze({__proto__:null,AUDIO_CONTEXT:yt,AUDIO_ASSET_TAG:"audio",loadAudio:async function(t,e={}){const r=yt;let n=await fetch(t),s=await n.arrayBuffer(),i=await r.decodeAudioData(s);return new bt(r,i,Boolean(e.loop))}});class _t{static currentTime(){return performance.now()}static start(t){let e=new _t(t,!1);return e.start(),e}constructor(t,e=!1){this.app=t,this._controlled=e,this._animationFrameHandle=null,this.prevFrameTime=0,this.started=!1,this.paused=!1,this.fixedTimeStep=1/60,this.prevAccumulatedTime=0,this._onstart=null,this._onstop=null,this._onpreupdate=null,this._onupdate=null,this._onfixedupdate=null,this._onpostupdate=null,this._onpause=null,this._onresume=null,this.onAnimationFrame=this.onAnimationFrame.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this)}setFixedUpdatesPerSecond(t){return this.fixedTimeStep=1/t,this}onWindowFocus(){this.started&&this.resume()}onWindowBlur(){this.started&&this.pause()}onAnimationFrame(t){if(this._controlled)throw new Error("Cannot run controlled game loop; call step() instead.");if(!this.started)throw new Error("Must be called after start().");this.animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.step(t)}step(t=_t.currentTime()){if(!this.started)return!1;const e=t-this.prevFrameTime;if(this.prevFrameTime=t,this.paused)return!1;if(this.app.preUpdate&&this.app.preUpdate(e),this.app.update&&this.app.update(e),this.prevAccumulatedTime+=e/1e3,this.prevAccumulatedTime>250*this.fixedTimeStep){let t=250*this.fixedTimeStep,e=Math.floor((this.prevAccumulatedTime-t)/this.fixedTimeStep);this.prevAccumulatedTime=t,console.error(`[ApplicationLoop] Too many updates! Skipped ${e} fixed updates.`)}for(;this.prevAccumulatedTime>=this.fixedTimeStep;)this.prevAccumulatedTime-=this.fixedTimeStep,this.app.fixedUpdate&&this.app.fixedUpdate();this.app.postUpdate&&this.app.postUpdate(e)}start(){if(this.started)throw new Error("Loop already started.");return window.addEventListener("focus",this.onWindowFocus),window.addEventListener("blur",this.onWindowBlur),this.started=!0,this.prevFrameTime=_t.currentTime(),this.app.start&&this.app.start(),this.controlled||this.onAnimationFrame(this.prevFrameTime),this}stop(){if(!this.started)throw new Error("Loop not yet started.");return window.removeEventListener("focus",this.onWindowFocus),window.removeEventListener("blur",this.onWindowBlur),this.started=!1,this.app.stop&&this.app.stop(),this._controlled||this.animationFrameHandle&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null),this}pause(){return this.paused||(this.paused=!0,this.app.pause&&this.app.pause()),this}resume(){return this.pause?(this.prevFrameTime=_t.currentTime(),this.paused=!1,this.app.resume&&this.app.resume(),this):this}}class wt{constructor(t){this.context=t,this.display=null,this.renderContext=null}setDisplay(t){return this.display=t,this.renderContext=t.canvas.getContext("2d"),this}start(){this.context.start()}update(t){this.context.update(t),this.context.render(this.renderContext)}}const At=Symbol("game"),vt=Symbol("loop");var Mt=Object.freeze({__proto__:null,start:function(t){let e={...t},r=new wt(e),n=new _t(r);return e[At]=r,e[vt]=n,e.display=null,window.addEventListener("DOMContentLoaded",(()=>{let t=document.querySelector("display-port");if(!t)throw new Error("Cannot find display-port in document.");r.setDisplay(t),e.display=t,e.load().then((()=>n.start()))})),e},stop:function(t){t[vt].stop(),delete t[At],delete t[vt]}});const Nt={x:0,y:0,width:1,height:1,color:"dodgerblue",solid:!0},Et=Symbol("BoxRendererInfo");function Tt(t,e,r,n){return e?t in e?e[t]:t in r?r[t]:n[t]:r&&t in r?r[t]:n[t]}const St={x:0,y:0,width:1,height:1,spriteImage:null},It=Symbol("SpriteRendererInfo");function Ft(t,e,r,n){return e?t in e?e[t]:t in r?r[t]:n[t]:r&&t in r?r[t]:n[t]}class Ot{static createBounds(t,e,r,n){return{x:t,y:e,rx:r,ry:n}}constructor(t=0,e=Ot.createBounds(0,0,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)){this.level=t,this.bounds=e,this.boxes=[],this.nodes=new Array(4)}insertAll(t){for(let e of t)this.insert(e)}insert(t){let e=this.nodes[0];if(e){let e=this.findQuadIndex(t);if(e>=0)return void this.nodes[e].insert(t)}if(this.boxes.push(t),this.boxes.length>10&&this.level<5){e||this.split();for(let t=this.boxes.length-1;t>=0;--t){let e=this.boxes[t],r=this.findQuadIndex(e);r>=0&&(this.boxes.splice(t,1),this.nodes[r].insert(e))}}}retrieve(t,e=[],r={}){const{includeSelf:n=!1}=r;if(this.nodes[0]){let r=this.findQuadIndex(t);r>=0&&this.nodes[r].retrieve(t,e)}let s=this.boxes;if(n)e.push(...s);else{let r=s.indexOf(t);for(let t=0;t<r;++t)e.push(s[t]);let n=s.length;for(let t=r+1;t<n;++t)e.push(s[t])}return e}clear(){this.boxes.length=0;for(let t=0;t<this.nodes.length;++t){let e=this.nodes[t];e&&(e.clear(),this.nodes[t]=null)}}split(){let{x:t,y:e,rx:r,ry:n}=this.bounds,s=this.level+1,i=this.constructor;this.nodes[0]=new i(s,Ot.createBounds(t+r,e,r,n)),this.nodes[1]=new i(s,Ot.createBounds(t,e,r,n)),this.nodes[2]=new i(s,Ot.createBounds(t,e+n,r,n)),this.nodes[3]=new i(s,Ot.createBounds(t+r,e+n,r,n))}findQuadIndex(t){const{x:e,y:r,rx:n,ry:s}=this.bounds,i=e+n,o=r+s,{x:a,y:l,rx:u,ry:c}=t,h=l<o&&l+2*c<o,f=l>o;let d=-1;return a<i&&a+2*u<i?h?d=1:f&&(d=2):a>i&&(h?d=0:f&&(d=3)),d}}function Rt(t,e,r,n,s,i,o){return{x:t,y:e,dx:r,dy:n,nx:s,ny:i,time:o}}function kt(t,e){let r=e.x-t.x,n=e.rx+t.rx-Math.abs(r);if(n<0)return null;let s=e.y-t.y,i=e.ry+t.ry-Math.abs(s);if(i<0)return null;if(n<i){let s=Math.sign(r);return Rt(t.x+t.rx*s,e.y,n*s,0,s,0,0)}{let r=Math.sign(s);return Rt(e.x,t.y+t.ry*r,0,i*r,0,r,0)}}const Bt=Symbol("maskCount");class zt{constructor(t,e,r,n,s,i){this.aabbGraph=t,this.mask=e,this.x=r,this.y=n,this.rx=s,this.ry=i}setPosition(t,e){return this.x=t,this.y=e,this}setSize(t,e){return this.setHalfSize(t/2,e/2)}setHalfSize(t,e){return this.rx=t,this.ry=e,this}}const Lt={};function Ct(t,e,r){null===t?(r.rootNodes.push(e),e.parentNode=null):(t.childNodes.push(e),e.parentNode=t)}function Ut(t,e,r){if(null===t){let t=r.rootNodes.indexOf(e);r.rootNodes.splice(t,1),e.parentNode=void 0}else{let r=t.childNodes.indexOf(e);t.childNodes.splice(r,1),e.parentNode=void 0}}function jt(t,e,r,n,s){if(r>=100)return;let i=n(e.owner,e);if(!1===i)return;let o=e.childNodes;s&&Pt(t.nodes,o,e,s);for(let t of o)jt(t,r+1,n);"function"==typeof i&&i(e.owner,e)}function Pt(t,e,r,n){let s=e.map((t=>t.owner));n(s,r);for(let r=0;r<s.length;++r)e[r]=t.get(s[r]);e.length=s.length}class Dt{constructor(t,e,r,n){this.sceneGraph=t,this.owner=e,this.parentNode=r,this.childNodes=n}}const Vt=n.vec3.fromValues(0,0,0),Gt=n.vec3.fromValues(1,0,0),$t=n.vec3.fromValues(0,1,0),qt=n.vec3.fromValues(0,0,1);function Wt(){return{translation:n.vec3.create(),rotation:n.quat.create(),scale:n.vec3.fromValues(1,1,1)}}function Yt(t,e=n.mat4.create()){return n.mat4.fromRotationTranslationScale(e,t.rotation,t.translation,t.scale)}var Xt=Object.freeze({__proto__:null,ORIGIN:Vt,XAXIS:Gt,YAXIS:$t,ZAXIS:qt,create:Wt,lookAt:function(t,e=Vt){const r=n.vec3.create();n.vec3.subtract(r,e,t.position),n.vec3.normalize(r,r);const s=n.vec3.dot(qt,r);if(Math.abs(s- -1)<Number.EPSILON)return n.quat.set(t.rotation,0,0,1,Math.PI),t;if(Math.abs(s-1)<Number.EPSILON)return n.quat.set(t.rotation,0,0,0,1),t;n.vec3.cross(r,qt,r),n.vec3.normalize(r,r);const i=Math.acos(s)/2,o=Math.sin(i);return t.rotation[0]=r[0]*o,t.rotation[1]=r[1]*o,t.rotation[2]=r[2]*o,t.rotation[3]=Math.cos(i),t},getTransformationMatrix:Yt,getForwardVector:function(t,e=n.vec3.create()){return n.vec3.transformQuat(e,qt,t.rotation),e},getUpVector:function(t,e=n.vec3.create()){return n.vec3.transformQuat(e,$t,t.rotation),e},getRightVector:function(t,e=n.vec3.create()){return n.vec3.transformQuat(e,Gt,t.rotation),e}});function Ht(t,e,r,n,s){if(!s){const e=Math.random(),r=Math.random(),n=Math.random();s=[];for(let i=0;i<t.length;i+=3)s.push(e,r,n)}return{position:t,texcoord:e,normal:r,indices:n,color:s,elementSize:3,elementCount:n.length}}function Qt(t,e,r,n){for(let s=0;s<n.color.length;s+=3)n.color[s+0]=t,n.color[s+1]=e,n.color[s+2]=r;return n}function Jt(t,e){const r=e.position,s=e.normal,i=n.mat3.create();n.mat3.normalFromMat4(i,t);const o=n.vec3.create();for(let e=0;e<r.length;e+=3)o[0]=r[e+0],o[1]=r[e+1],o[2]=r[e+2],n.vec3.transformMat4(o,o,t),r[e+0]=o[0],r[e+1]=o[1],r[e+2]=o[2],o[0]=s[e+0],o[1]=s[e+1],o[2]=s[e+2],n.vec3.transformMat3(o,o,i),s[e+0]=o[0],s[e+1]=o[1],s[e+2]=o[2];return e}function Zt(...t){const e=[],r=[],n=[],s=[],i=[];let o=0;for(const a of t)e.push(...a.position),r.push(...a.texcoord),n.push(...a.normal),i.push(...a.color),s.push(...a.indices.map((t=>t+o))),o+=a.position.length/3;return Ht(e,r,n,s,i)}function Kt(t=!1){let e;if(t){const t=.5,r=.5;e=[0-t,0-r,0,0+t,0-r,0,0-t,0+r,0,0+t,0+r,0]}else e=[0,0,0,1,0,0,0,1,0,1,1,0];return Ht(e,[0,0,1,0,0,1,1,1],[0,0,1,0,0,1,0,0,1,0,0,1],[0,1,2,2,1,3])}var te=Object.freeze({__proto__:null,create:Kt});function ee(t=!0){const e=Kt(!0);if(t){const t=Kt(!0);return Jt(n.mat4.fromYRotation(n.mat4.create(),Math.PI),t),Qt(e.color[0],e.color[1],e.color[2],t),Zt(e,t)}return e}var re=Object.freeze({__proto__:null,create:ee});function ne(t=!0,e=!0,r=!0,s=!0,i=!0,o=!0){const a=Math.PI/2,l=n.mat4.create(),u=[];if(t){const t=ee(!1);n.mat4.fromTranslation(l,[0,0,.5]),Jt(l,t),u.push(t)}if(r){const t=ee(!1);n.mat4.fromXRotation(l,-a),n.mat4.translate(l,l,[0,0,.5]),Jt(l,t),u.push(t)}if(e){const t=ee(!1);n.mat4.fromYRotation(l,Math.PI),n.mat4.translate(l,l,[0,0,.5]),Jt(l,t),u.push(t)}if(s){const t=ee(!1);n.mat4.fromXRotation(l,a),n.mat4.translate(l,l,[0,0,.5]),Jt(l,t),u.push(t)}if(i){const t=ee(!1);n.mat4.fromYRotation(l,-a),n.mat4.translate(l,l,[0,0,.5]),Jt(l,t),u.push(t)}if(o){const t=ee(!1);n.mat4.fromYRotation(l,a),n.mat4.translate(l,l,[0,0,.5]),Jt(l,t),u.push(t)}return Zt(...u)}var se=Object.freeze({__proto__:null,create:ne});var ie=Object.freeze({__proto__:null,create:function(){const t=.2,e=n.mat4.create(),r=ne(!0,!0,!0,!0,!1,!0);n.mat4.fromTranslation(e,[.1,.4,0]),n.mat4.scale(e,e,[.4,t,t]),Jt(e,r),Qt(r.color[0],r.color[1],r.color[2],r);const s=ne(!0,!0,!0,!0,!1,!0);n.mat4.fromScaling(e,[t,t,t]),Jt(e,s),Qt(r.color[0],r.color[1],r.color[2],s);const i=ne(!0,!0,!0,!0,!0,!0);return n.mat4.fromTranslation(e,[-.2,0,0]),n.mat4.scale(e,e,[t,1,t]),Jt(e,i),Qt(r.color[0],r.color[1],r.color[2],i),Zt(i,r,s)}}),oe=Object.freeze({__proto__:null,Quad:te,Plane:re,Cube:se,GlyphF:ie,create:Ht,applyColor:Qt,applyTransformation:Jt,joinGeometry:Zt});function ae(t,e,r,n){if(!n){const e=Math.random(),r=Math.random(),s=Math.random();n=[];for(let i=0;i<t.length;i+=3)n.push(e,r,s)}return{position:t,texcoord:e,indices:r,color:n,elementSize:2,elementCount:r.length}}function le(t,e){const r=e.position,s=n.vec2.create();for(let e=0;e<r.length;e+=2)s[0]=r[e+0],s[1]=r[e+1],n.vec3.transformMat3(s,s,t),r[e+0]=s[0],r[e+1]=s[1];return e}function ue(...t){const e=[],r=[],n=[],s=[];let i=0;for(const o of t){e.push(...o.position),r.push(...o.texcoord),s.push(...o.color);for(let t=0;t<o.indices.length;++t){const e=o.indices[t];n.push(e+i)}i+=o.position.length/2}return ae(e,r,n,s)}function ce(t=!1){let e;if(t){const t=.5,r=.5;e=[0-t,0-r,0+t,0-r,0-t,0+r,0+t,0+r]}else e=[0,0,1,0,0,1,1,1];return ae(e,[0,0,1,0,0,1,1,1],[0,1,2,2,1,3])}var he=Object.freeze({__proto__:null,create:ce});var fe=Object.freeze({__proto__:null,create:function(){const t=.2,e=n.mat3.create(),r=ce();n.mat3.fromTranslation(e,[.1,.4]),n.mat3.scale(e,e,[.4,t]),le(e,r),Qt(r.color[0],r.color[1],r.color[2],r);const s=ce();n.mat3.fromScaling(e,[t,t]),le(e,s),Qt(r.color[0],r.color[1],r.color[2],s);const i=ce();return n.mat3.fromTranslation(e,[-.2,0]),n.mat3.scale(e,e,[t,1]),le(e,i),Qt(r.color[0],r.color[1],r.color[2],i),ue(i,r,s)}}),de=Object.freeze({__proto__:null,Quad2D:he,GlyphF2D:fe,applyColor2D:Qt,create:ae,applyTransformation2D:le,joinGeometry2D:ue});function pe(t,e,r){const n=t.createShader(e);if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(n);throw t.deleteShader(n),new Error(e)}return n}function me(t,e,r,n=[]){const s=t.createProgram();t.attachShader(s,e),t.attachShader(s,r);for(let e=0;e<n.length;++e)t.bindAttribLocation(s,e,n[e]);if(t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){const e=t.getProgramInfoLog(s);throw t.deleteProgram(s),new Error(e)}return s}function ye(t,e){const r={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<n;++s){const n=t.getActiveAttrib(e,s);if(!n)break;const i=n.name,o=t.getAttribLocation(e,i);r[i]=ge(o)}return r}function ge(t){const e=function(t,e,r){e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,r.handle),e.vertexAttribPointer(t,r.size,r.type,r.normalize,r.stride,r.offset)}.bind(null,t);return e.location=t,e}function be(t,e){const r={},n={textureUnit:0},s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<s;++i){const s=t.getActiveUniform(e,i);if(!s)break;let o=s.name;"[0]"===o.substring(o.length-3)&&(o=o.substring(0,o.length-3));const a=xe(t,e,s,n);r[o]=a}return r}function xe(t,e,r,n){const s=r.name,i=t.getUniformLocation(e,s),o=r.type,a=r.size>1&&"[0]"===s.substring(s.length-3),l=we(t,o);if(!l)throw new Error(`Unknown uniform type 0x${o.toString(16)}.`);switch(o){case t.FLOAT:case t.INT:case t.BOOL:return l.setter(i,a);case t.SAMPLER_2D:case t.SAMPLER_CUBE:{let t;if(a){t=[];for(let e=0;e<r.size;++e)t.push(n.textureUnit++)}else t=n.textureUnit++;return l.setter(i,a,t)}default:return l.setter(i)}}let _e=null;function we(t,e){if(_e)return _e[e];function r(t,e,r=!1,n=0){if(r&&!Array.isArray(n))throw new Error("Cannot create sampler array for non-array texture unit.");const s=(r?function(t,e,r,n,s){n.uniform1fv(t,e),s.forEach(((t,s)=>{n.activeTexture(n.TEXTURE0+e[s]),n.bindTexture(r,t)}))}:function(t,e,r,n,s){n.uniform1i(t,e),n.activeTexture(n.TEXTURE0+e),n.bindTexture(r,s)}).bind(null,e,n,t);return s.location=e,s}return _e={[t.FLOAT]:{TypedArray:Float32Array,size:4,setter(t,e=!1){const r=(e?function(t,e,r){e.uniform1fv(t,r)}:function(t,e,r){e.uniform1f(t,r)}).bind(null,t);return r.location=t,r}},[t.FLOAT_VEC2]:{TypedArray:Float32Array,size:8,setter(t){const e=function(t,e,r){e.uniform2fv(t,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_VEC3]:{TypedArray:Float32Array,size:12,setter(t){const e=function(t,e,r){e.uniform3fv(t,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_VEC4]:{TypedArray:Float32Array,size:16,setter(t){const e=function(t,e,r){e.uniform4fv(t,r)}.bind(null,t);return e.location=t,e}},[t.INT]:{TypedArray:Int32Array,size:4,setter(t,e=!1){const r=(e?function(t,e,r){e.uniform1iv(t,r)}:function(t,e,r){e.uniform1i(t,r)}).bind(null,t);return r.location=t,r}},[t.INT_VEC2]:{TypedArray:Int32Array,size:8,setter(t){const e=function(t,e,r){e.uniform2iv(t,r)}.bind(null,t);return e.location=t,e}},[t.INT_VEC3]:{TypedArray:Int32Array,size:12,setter(t){const e=function(t,e,r){e.uniform3iv(t,r)}.bind(null,t);return e.location=t,e}},[t.INT_VEC4]:{TypedArray:Int32Array,size:16,setter(t){const e=function(t,e,r){e.uniform4iv(t,r)}.bind(null,t);return e.location=t,e}},[t.BOOL]:{TypedArray:Uint32Array,size:4,setter(t,e=!1){const r=(e?function(t,e,r){e.uniform1iv(t,r)}:function(t,e,r){e.uniform1i(t,r)}).bind(null,t);return r.location=t,r}},[t.BOOL_VEC2]:{TypedArray:Uint32Array,size:8,setter(t){const e=function(t,e,r){e.uniform2iv(t,r)}.bind(null,t);return e.location=t,e}},[t.BOOL_VEC3]:{TypedArray:Uint32Array,size:12,setter(t){const e=function(t,e,r){e.uniform3iv(t,r)}.bind(null,t);return e.location=t,e}},[t.BOOL_VEC4]:{TypedArray:Uint32Array,size:16,setter(t){const e=function(t,e,r){e.uniform4iv(t,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT2]:{TypedArray:Float32Array,size:16,setter(t){const e=function(t,e,r){e.uniformMatrix2fv(t,!1,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT3]:{TypedArray:Float32Array,size:36,setter(t){const e=function(t,e,r){e.uniformMatrix3fv(t,!1,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT4]:{TypedArray:Float32Array,size:64,setter(t){const e=function(t,e,r){e.uniformMatrix4fv(t,!1,r)}.bind(null,t);return e.location=t,e}},[t.SAMPLER_2D]:{TypedArray:null,size:0,setter:r.bind(null,t.TEXTURE_2D)},[t.SAMPLER_CUBE]:{TypedArray:null,size:0,setter:r.bind(null,t.TEXTURE_CUBE)}},_e[e]}function Ae(t,e,r,n,s=!1,i=0,o=0,a=t.ARRAY_BUFFER,l=t.STATIC_DRAW){const u=t.createBuffer(),c=Me(t,e);if(!c)throw new Error(`Unknown uniform type 0x${e.toString(16)}.`);if(r instanceof c.TypedArray)t.bindBuffer(a,u),t.bufferData(a,r,l);else if(Array.isArray(r))r=new c.TypedArray(r),t.bindBuffer(a,u),t.bufferData(a,r,l);else{if("number"!=typeof r)throw new Error("Unknown buffer data type - can only be a TypedArray, an Array, or a number.");t.bindBuffer(a,u),t.bufferData(a,r,l)}return{handle:u,size:n,type:e,normalize:s,stride:i,offset:o,updateData(t,r,n=0,s=t.STATIC_DRAW){t.bindBuffer(t.ARRAY_BUFFER,this.handle);const i=Me(t,e);r instanceof i.TypedArray||(r=new i.TypedArray(r)),n>0?t.bufferSubData(t.ARRAY_BUFFER,n,r):t.bufferData(t.ARRAY_BUFFER,r,s)}}}let ve=null;function Me(t,e){return ve||(ve={[t.BYTE]:{TypedArray:Int8Array,size:1},[t.SHORT]:{TypedArray:Int16Array,size:2},[t.UNSIGNED_BYTE]:{TypedArray:Uint8Array,size:1},[t.UNSIGNED_SHORT]:{TypedArray:Uint16Array,size:2},[t.FLOAT]:{TypedArray:Float32Array,size:4}}),ve[e]}var Ne=Object.freeze({__proto__:null,SceneGraph:class{constructor(){this.root=this.createSceneNode(Wt(),null)}update(){this.root.updateWorldMatrix()}createSceneNode(t=Wt(),e=this.root){const r={sceneGraph:this,transform:t,localMatrix:n.mat4.create(),worldMatrix:n.mat4.create(),parent:null,children:[],setParent(t){if(this.parent){const t=this.parent.children.indexOf(this);this.parent.children.splice(t,1)}return t&&t.children.push(this),this.parent=e,this},updateWorldMatrix(t){Yt(this.transform,this.localMatrix),t?n.mat4.multiply(this.worldMatrix,t,this.localMatrix):n.mat4.copy(this.worldMatrix,this.localMatrix);for(const t of this.children)t.updateWorldMatrix(this.worldMatrix)}};return e&&r.setParent(e),r}},Transform:Xt,Geometry:oe,Geometry2D:de,createShaderProgramInfo:function(t,e,r,n=[]){const s=pe(t,t.VERTEX_SHADER,e),i=pe(t,t.FRAGMENT_SHADER,r),o=me(t,s,i,n);return t.detachShader(o,s),t.detachShader(o,i),t.deleteShader(s),t.deleteShader(i),{handle:o,_gl:t,uniforms:be(t,o),attributes:ye(t,o),uniform(t,e){return t in this.uniforms&&this.uniforms[t](this._gl,e),this},attribute(t,e){return t in this.attributes&&this.attributes[t](this._gl,e),this},elementAttribute(t){return this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t),this}}},createShader:pe,createShaderProgram:me,createShaderProgramAttributeSetters:ye,createShaderProgramAttributeSetter:ge,createShaderProgramUniformSetters:be,createShaderProgramUniformSetter:xe,getUniformTypeInfo:we,createBufferInfo:Ae,createElementBufferInfo:function(t,e,r,n=0,s=0,i=t.STATIC_DRAW){return Ae(t,e,r,1,!1,n,s,t.ELEMENT_ARRAY_BUFFER,i)},getBufferTypeInfo:Me,createVertexArrayInfo:function(t,e=[]){const r=t.createVertexArray(),n={};for(let t=0;t<e.length;++t)n[e[t]]={location:t,setter:ge(t)};return{handle:r,attributes:n,_gl:t,elementBuffer:null,elementType:null,elementCount:0,attributeBuffers:{},setElementCount(t){return this.elementCount=t,this},elementAttribute(t){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t.handle);const e=Me(this._gl,t.type);return this.elementCount=this._gl.getBufferParameter(this._gl.ELEMENT_ARRAY_BUFFER,this._gl.BUFFER_SIZE)/e.size,this.elementBuffer=t,this.elementType=t.type,this},sharedAttribute(t,e){return t in this.attributes&&this.attributes[t].setter(this._gl,e),this.attributeBuffers[t]=e,this},programAttribute(t,e,...r){for(const n of r)n.attribute(t,e);return this.attributeBuffers[t]=e,this}}},createTextureInfo:function(t){return{handle:t.createTexture()}},createDrawInfo:function(t,e,r,n=0,s=null){return{programInfo:t,vertexArrayInfo:e,uniforms:r,drawArrayOffset:n,drawMode:s}},draw:function(t,e,r={}){for(const n of e){const e=n.programInfo,s=n.vertexArrayInfo,i=n.uniforms,o=n.drawArrayOffset,a=n.drawMode||t.TRIANGLES;t.useProgram(e.handle),t.bindVertexArray(s.handle);for(const[t,n]of Object.entries(r))e.uniform(t,n);for(const[t,r]of Object.entries(i))e.uniform(t,r);s.elementBuffer?t.drawElements(a,s.elementCount,s.elementType,o*s.elementBuffer.size):t.drawArrays(a,o,s.elementCount)}}});class Ee{getViewMatrix(t){}getProjectionMatrix(t){}}class Te extends Ee{constructor(t=-1,e=1,r=-1,s=1,i=0,o=1){super(),this.position=n.vec3.create(),this.rotation=n.quat.create(),this.scale=n.vec3.fromValues(1,1,1),this.clippingPlane={left:t,right:e,top:r,bottom:s,near:i,far:o}}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,r=0,s=1){let i=n.vec3.fromValues(t,e,r);return n.vec3.lerp(this.position,this.position,i,Math.max(Math.min(s,1),0)),this}getViewMatrix(t){let e=-Math.round(this.x),r=-Math.round(this.y),s=0===this.z?1:1/this.z,i=n.vec3.fromValues(e,r,0),o=n.vec3.fromValues(this.scale[0]*s,this.scale[1]*s,1);return n.mat4.fromRotationTranslationScale(t,this.rotation,i,o),t}getProjectionMatrix(t){let{left:e,right:r,top:s,bottom:i,near:o,far:a}=this.clippingPlane;return n.mat4.ortho(t,e,r,s,i,o,a),t}}function Se(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}var Ie=Object.freeze({__proto__:null,CanvasView2D:class{constructor(t,e=new Te){this.display=t,this.camera=e,this.viewTransformDOMMatrix=new DOMMatrix}transformScreenToWorld(t,e){let r=n.mat4.create();this.getViewProjectionMatrix(r),n.mat4.invert(r,r);let s=n.vec3.fromValues(t,e,0);return n.vec3.transformMat4(s,s,r),s}transformCanvas(t){let e=this.viewTransformDOMMatrix,r=n.mat4.create();this.getViewProjectionMatrix(r),Se(e,r);const{a:s,b:i,c:o,d:a,e:l,f:u}=e;t.transform(s,i,o,a,l,u)}getViewProjectionMatrix(t){const e=this.display.width,r=this.display.height;let s=n.mat4.create();const i=this.camera.getProjectionMatrix(s),o=this.camera.getViewMatrix(t);n.mat4.multiply(s,o,i);const a=n.mat4.fromTranslation(t,[e/2,r/2,0]);return n.mat4.multiply(t,a,s),t}},setDOMMatrix:Se,Camera:Ee,Camera2D:Te,Camera3D:class extends Ee{static screenToWorld(t,e,r,s){let i=n.mat4.multiply(n.mat4.create(),s,r);n.mat4.invert(i,i);let o=n.vec3.fromValues(t,e,0);return n.vec3.transformMat4(o,o,i),o}constructor(t,e,r=.1,s=1e3){super(),this.position=n.vec3.create(),this.rotation=n.quat.create(),this.fieldOfView=t,this.aspectRatio=e,this.clippingPlane={near:r,far:s},this._viewMatrix=n.mat4.create(),this._projectionMatrix=n.mat4.create()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,r,s=1){let i=n.vec3.fromValues(t,e,r);n.vec3.lerp(this.position,this.position,i,Math.min(1,s))}getViewMatrix(t=this._viewMatrix){let e=-this.x,r=-this.y,s=-this.z,i=n.vec3.fromValues(e,r,s);return n.mat4.fromRotationTranslation(t,this.rotation,i),t}getProjectionMatrix(t=this._projectionMatrix){let{near:e,far:r}=this.clippingPlane;return n.mat4.perspective(t,this.fieldOfView,this.aspectRatio,e,r),t}}});Object.keys(e).forEach((function(r){"default"!==r&&Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[r]}})})),Object.keys(r).forEach((function(e){"default"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})})),t.ApplicationLoop=_t,t.AssetLoader=rt,t.Audio=xt,t.AxisAlignedBoundingBox=zt,t.AxisAlignedBoundingBoxGraph=class{constructor(t={}){this.masks=new Map,this.boxes=new Set,this.dynamics=new Map,this.quadtree=new Ot}add(t,e,r={}){let n=function(t,e,r,n){return{owner:t,name:e,box:r,get:n}}(t,e,null,null);if(this.masks.has(t)){if(e in this.masks.get(t))throw new Error(`Mask ${e} already exists for owner.`);{let r=this.masks.get(t);r[e]=n,r[Bt]++}}else this.masks.set(t,{[Bt]:1,[e]:n});if(Array.isArray(r)){const t=r[0]||0,e=r[1]||0,s=r[2]/2||0,i=r[3]/2||0;let o=new zt(this,n,t,e,s,i);this.boxes.add(o),n.box=o}else if("object"==typeof r){let e=r.x||0,s=r.y||0,i=r.rx||r.width/2||0,o=r.ry||r.height/2||0;"object"==typeof t&&(e||(e=t.x||0),s||(s=t.y||0),i||(i=t.width/2||0),o||(o=t.height/2||0));let a=new zt(this,n,e,s,i,o);this.boxes.add(a),n.box=a,"get"in r&&(n.get=r.get,n.get(a,t),this.dynamics.set(n,{halfdx:0,halfdy:0}))}else{if("function"!=typeof r)throw new Error("Invalid mask option type.");{let e=new zt(this,n,0,0,0,0);this.boxes.add(e),n.box=e,n.get=r,n.get(e,t),this.dynamics.set(n,{halfdx:0,halfdy:0})}}}remove(t,e){if(this.masks.has(t)){let r=this.masks.get(t),n=r[e];if(n){return n.get&&this.dynamics.delete(n),this.boxes.delete(n.box),r[e]=null,--r[Bt]<=0&&this.masks.delete(t),!0}return!1}return!1}get(t,e){return this.masks.has(t)?this.masks.get(t)[e]:null}count(t){return this.masks.has(t)?this.masks.get(t)[Bt]:0}clear(){this.boxes.clear(),this.masks.clear(),this.dynamics.clear(),this.quadtree.clear()}solve(t){for(let t of this.dynamics.keys()){let{box:e,owner:r}=t,n=e.x,s=e.y;t.get(e,r);let i=this.dynamics.get(t),o=(e.x-n)/2,a=(e.y-s)/2;i.halfMotionX=o,i.halfMotionY=a,e.x-=o,e.y-=a,e.rx+=Math.abs(o),e.ry+=Math.abs(a)}null==t&&(t=this.masks.keys());let e=[],r=this.quadtree;r.clear(),r.insertAll(this.boxes);for(let t of this.dynamics.keys()){const{box:e}=t,{halfMotionX:r,halfMotionY:n}=this.dynamics.get(t);e.x+=r,e.y+=n,e.rx-=Math.abs(r),e.ry-=Math.abs(n)}let n=[];for(let s of t){let t=Object.values(this.masks.get(s));for(let i of t){const{box:t}=i;r.retrieve(t,n);let o=0,a=0;if(this.dynamics.has(i)){const{halfMotionX:t,halfMotionY:e}=this.dynamics.get(i);o=2*t,a=2*e}for(let r of n){let n=kt(t,r);n&&e.push({owner:s,other:r.mask.owner,ownerMask:i,otherMask:r.mask,hit:n,dx:o,dy:a})}n.length=0}}return e}},t.BoxRenderer=class{static get Info(){return Et}static draw(t,e,r){const n=r?{...Nt,...r}:Nt;for(let r of e){const e=r[Et],s=Tt("x",e,r,n),i=Tt("y",e,r,n),o=Tt("width",e,r,n),a=Tt("height",e,r,n),l=Tt("color",e,r,n),u=Tt("solid",e,r,n);t.translate(s,i);{const e=o/2,r=a/2;u?(t.fillStyle=l,t.fillRect(-e,-r,o,a)):(t.strokeStyle=l,t.strokeRect(-e,-r,o,a))}t.translate(-s,-i)}}},t.ByteLoader=q,t.Discrete=a,t.Downloader=h,t.EntityManager=class{constructor(t={}){const{componentFactoryMap:e={},strictMode:r=!1}=t;let n={},s={};for(let t in e){let r,i,o=e[t];try{r="create"in o?o.create:"function"==typeof o?o:null,i="destroy"in o?o.destroy:null}catch(t){throw new Error("Unsupported component factory options.")}n[t]={owner:o,create:r,destroy:i},s[t]={}}this.factoryMap=n,this.instances=s,this.entities=new Set,this.nextAvailableEntityId=1,this.strictMode=r}create(t){if(void 0!==t){if("string"!=typeof t)throw new Error("Invalid type for entity id - must be a string.")}else t=String(this.nextAvailableEntityId++);if(this.entities.has(t))throw new Error(`Invalid duplicate entity id '${t}' allocated for new entity.`);return this.entities.add(t),t}destroy(t){for(let e in this.instances)this.remove(e,t);this.entities.delete(t)}add(t,e,r){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);this.factoryMap[t]={owner:{},create:null,destroy:null},this.instances[t]={}}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);if(!this.entities.has(e))throw new Error(`Entity '${e}' does not exist.`);if(this.instances[t][e])throw new Error(`Entity already has component '${t}'.`);const{create:n}=this.factoryMap[t];let s=n?n(void 0!==r?r:Lt,e,this):r?{...r}:{};s&&(this.instances[t][e]=s)}remove(t,e){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);return}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);let r=this.instances[t],n=r[e];if(n){r[e]=null;const{destroy:s}=this.factoryMap[t];s&&s(n,e,this)}}get(t,e){if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);return this.instances[t][e]||null}has(t,e){return t in this.instances&&Boolean(this.instances[t][e])}clear(t){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);return}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);let e=this.instances[t];const{destroy:r}=this.factoryMap[t];if(r)for(let n in e){let s=e[n];e[n]=null,r(s,t,n,this)}this.instances[t]={}}getEntityIds(){return this.entities}getComponentFactory(t){return t in this.factoryMap?this.factoryMap[t].owner:null}getComponentNames(){return Object.keys(this.factoryMap)}getComponentEntityIds(t){return t in this.instances?Object.keys(this.instances[t]):[]}getComponentInstances(t){return t in this.instances?Object.values(this.instances[t]):[]}},t.Eventable=O,t.Game=Mt,t.ImageLoader=D,t.IntersectionHelper=ht,t.IntersectionResolver=pt,t.IntersectionWorld=mt,t.JSONLoader=Y,t.Logger=N,t.Mogli=Ne,t.OBJLoader=J,t.PriorityQueue=R,t.QuadTree=Ot,t.Random=o,t.RandomGenerator=s,t.SceneGraph=class{constructor(t={}){this.nodeConstructor=t.nodeConstructor||Dt,this.nodes=new Map,this.rootNodes=[]}add(t,e=null){if(null===t)throw new Error("Cannot add null as child to scene graph.");if(null===e||this.nodes.has(e)){let r=null===e?null:this.nodes.get(e);if(this.nodes.has(t)){let e=this.nodes.get(t);return Ut(e.parentNode,e,this),Ct(r,e,this),e}{let e=new this.nodeConstructor(this,t,null,[]);return this.nodes.set(t,e),Ct(r,e,this),e}}throw new Error("No node in scene graph exists for parent.")}remove(t){if(null===t)return this.clear(),!0;if(this.nodes.has(t)){let e=this.nodes.get(t);return Ut(e.parentNode,e,this),jt(this,e,0,(t=>{this.nodes.delete(t)})),!0}return!1}replace(t,e){if(null===t)throw new Error("Cannot replace null for child in scene graph.");if(this.nodes.has(t)){let r=this.nodes.get(t),n=r.parentNode,s=[...r.childNodes];if(Ut(n,r,this),r.childNodes.length=0,null===e)null===n?this.rootNodes.push(...s):n.childNodes.push(...s);else{let t;this.nodes.has(e)?(t=this.nodes.get(e),Ut(t.parentNode,t,this),t.childNodes.push(...s)):(t=new this.nodeConstructor(this,e,null,s),this.nodes.set(e,t)),Ct(n,t,this)}for(let t of s)t.parentNode=n;return e}if(null===t)return this.replace(this.root.owner,e);throw new Error("Cannot find target object to replace in scene graph.")}clear(){this.nodes.clear(),this.rootNodes.length=0}get(t){return this.nodes.get(t)}walk(t,e,r={}){const{childrenOnly:n=!0,childrenCallback:s}=r;if(null===t){Pt(this.nodes,this.rootNodes,null,s);for(let t of this.rootNodes)jt(this,t,0,e,s)}else{const r=this.get(t);if(r)throw new Error("No node in scene graph exists for walk start.");if(n){Pt(this.nodes,r.childNodes,r,s);for(let t of r.childNodes)jt(this,t,0,e,s)}else jt(this,r,0,e,s)}}},t.SceneNode=Dt,t.SimpleRandomGenerator=class extends s{constructor(t=0){super(),this._seed=Math.abs(t%2147483647),this._next=this._seed}next(){return this._next=Math.abs(16807*this._next%2147483647-1),this._next/2147483646}get seed(){return this._seed}set seed(t){this._seed=Math.abs(t%2147483647),this._next=this._seed}},t.SpriteRenderer=class{static get Info(){return It}static draw(t,e,r){const n=r?{...St,...r}:St;for(let r of e){const e=r[It],s=Ft("x",e,r,n),i=Ft("y",e,r,n),o=Ft("spriteImage",e,r,n);if(o){const e=o.width,r=o.height;t.translate(s,i);{const n=e/2,s=r/2;t.drawImage(o,-n,-s)}t.translate(-s,-i)}else{const e=10,r=10;t.translate(s,i);{const n=e/2,s=r/2;t.strokeStyle="black",t.strokeRect(-n,-s,e,r),t.textAlign="center",t.textBaseline="middle",t.strokeText("?",0,0,e)}t.translate(-s,-i)}}}},t.TextLoader=G,t.Uploader=f,t.View=Ie,t.clamp=z,t.cycle=L,t.direction2=function(t,e,r,n){let s=r-t,i=n-e;return Math.atan2(i,s)},t.distance2=function(t,e,r,n){let s=r-t,i=n-e;return Math.sqrt(s*s+i*i)},t.lerp=function(t,e,r){return t+(e-t)*r},t.lookAt2=function(t,e,r){return z(t+L(e-t,-Math.PI,Math.PI),t-r,t+r)},t.testAxisAlignedBoundingBox=function(t,e){return!(Math.abs(t.x-e.x)>t.rx+e.rx||Math.abs(t.y-e.y)>t.ry+e.ry)},t.toDegrees=function(t){return t*U},t.toRadians=function(t){return t*C},t.topoSort=function(t,e){let r=[];for(let n of t){let t=e(n);if(Array.isArray(t))r.push([n,...t]);else if(t)throw new Error("Dependency callback must return an array.")}return function(t,e,r=[]){let n=new Map;for(let t of e)if(t.length>1){let e=t[0],r=t[1];n.has(e)||n.set(e,new Set),n.has(r)||n.set(r,new Set),n.get(e).add(r)}let s={edgeMap:n,index:t.length,visited:new Set,dst:r};for(let e of t)j(s,e,new Set);return r}(function(t){let e=new Set;for(let r of t)for(let t of r)e.add(t);return Array.from(e)}(r),function(t){let e=[];for(let r of t){let t=r[0];for(let n=1;n<r.length;++n){let s=r[n];e.push([t,s])}}return e}(r))},t.uuid=function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)},t.withinRadius=function(t,e,r,n,s){const i=t-r,o=e-n;return i*i+o*o<=s*s},Object.defineProperty(t,"__esModule",{value:!0})}));
