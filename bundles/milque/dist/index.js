!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gl-matrix")):"function"==typeof define&&define.amd?define(["exports","gl-matrix"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Milque={},t.glMatrix)}(this,(function(t,e){"use strict";const n="noscale";class s extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <canvas></canvas>\n    <slot></slot>\n</div>',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block;color:#555}.container{display:flex;position:relative;width:100%;height:100%}canvas{background:#000;margin:auto;-ms-interpolation-mode:nearest-neighbor;image-rendering:-moz-crisp-edges;image-rendering:pixelated}label{font-family:monospace;color:currentColor;position:absolute}#title{left:.5rem;top:.5rem}#fps{right:.5rem;top:.5rem}#dimension{left:.5rem;bottom:.5rem}.hidden{display:none}:host([debug]) .container{outline:6px dashed rgba(0,0,0,.1);outline-offset:-4px;background-color:rgba(0,0,0,.1)}:host([mode=noscale]) canvas{margin:0;top:0;left:0}:host([mode=center]),:host([mode=fit]),:host([mode=stretch]){width:100%;height:100%}:host([full]){width:100vw!important;height:100vh!important}:host([disabled]){display:none}slot{display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}::slotted(*){pointer-events:auto}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get observedAttributes(){return["onframe","width","height","disabled","debug","id","class"]}static get properties(){return{width:Number,height:Number,disabled:Boolean,debug:Boolean,mode:{type:String,value:"fit",observed:!1}}}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get height(){return this._height}set height(t){this.setAttribute("height",String(t))}get width(){return this._width}set width(t){this.setAttribute("width",String(t))}static get customEvents(){return["frame"]}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onframe")){let t=this.onframe;delete this.onframe,this.onframe=t}if(Object.prototype.hasOwnProperty.call(this,"width")){let t=this.width;delete this.width,this.width=t}if(Object.prototype.hasOwnProperty.call(this,"height")){let t=this.height;delete this.height,this.height=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}if(Object.prototype.hasOwnProperty.call(this,"mode")){let t=this.mode;delete this.mode,this.mode=t}this.hasAttribute("mode")||this.setAttribute("mode","fit"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=Number(n);break;case"height":this._height=Number(n);break;case"disabled":this._disabled=null!==n;break;case"debug":this._debug=null!==n;break;case"onframe":this.onframe=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}})(t,0,n)}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}update(t){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const e=t-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=t,this.debug){const t=e<=0?"--":String(Math.round(1e3/e)).padStart(2,"0");if(this._fpsElement.innerText!==t&&(this._fpsElement.innerText=t),this.mode===n){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:t,prevTime:this._prevAnimationFrameTime,deltaTime:e,canvas:this._canvasElement},bubbles:!1,composed:!0}))}updateCanvasSize(){let t=this.shadowRoot.host.getBoundingClientRect();const e=t.width,s=t.height;let r=this._canvasElement,i=this._width,o=this._height;const a=this.mode;if("stretch"===a)i=e,o=s;else if(a!==n){if(e<i||s<o||"fit"===a){let t=e/i,n=s/o;t<n?(i=e,o*=t):(i*=n,o=s)}}i=Math.floor(i),o=Math.floor(o),r.clientWidth===i&&r.clientHeight===o||(r.width=this._width,r.height=this._height,r.style=`width: ${i}px; height: ${o}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:i,height:o},bubbles:!1,composed:!0})))}}window.customElements.define("display-port",s);const r={NULL:0,KEY:1,POS:2,WHEEL:3},i={NULL:0,DOWN:1,UP:2,MOVE:3,parse(t){if("string"!=typeof t)return i.NULL;switch(t.toLowerCase()){case"down":return i.DOWN;case"up":return i.UP;case"move":return i.MOVE;default:return i.NULL}}},o="*";class a{static isAxis(t){return!1}static isButton(t){return!1}constructor(t,e){this.deviceName=t,this.eventTarget=e,this.listeners={}}destroy(){this.listeners={}}addInputListener(t,e){let n=this.listeners[t];n?n.push(e):(n=[e],this.listeners[t]=n)}removeInputListener(t,e){let n=this.listeners[t];n&&(n.indexOf(e),n.splice(e,1))}dispatchInput(t){const{keyCode:e}=t,n=this.listeners[e];let s=!1;if(n){for(let e of n)s|=e(t);return s}for(let e of this.listeners["*"])s|=e(t);return s}}class l{static createAdapter(t,e,n,s,r,i){return{target:t,adapterId:e,deviceName:n,keyCode:s,scale:r,eventCode:i}}constructor(){this.adapters={"*":h()}}add(t){for(let e of t){const{deviceName:t,keyCode:n}=e;let s;t in this.adapters?s=this.adapters[t]:(s=h(),this.adapters[t]=s),n in s?s[n].push(e):s[n]=[e]}}delete(t){for(let e of t){const{deviceName:t,keyCode:n}=e;if(t in this.adapters){let s=this.adapters[t];if(n in s){let t=s[n],r=t.indexOf(e);r>=0&&t.splice(r,1)}}}}clear(){for(let t in this.adapters)this.adapters[t]=h()}poll(t,e,n){const s=this.findAdapters(t,e);for(let t of s){const e=t.eventCode;if(e===i.NULL){const{target:e,scale:s}=t,r=n.value*s;e.poll(r,t)}else{const{target:s,scale:r}=t,i=n.getEvent(e)*r;s.poll(i,t)}}return s.length>0}update(t,e,n){let s=!1;for(let r of this.findAdapters(t,e)){const t=r.eventCode;if(t!==i.NULL){const{target:e,scale:i}=r,o=n.getEvent(t)*i;e.update(o,r),s=!0}}return s}reset(t,e,n){let s=!1;for(let n of this.findAdapters(t,e))n.target.reset(),s=!0;return s}findAdapters(t,e){let n=[];if(t in this.adapters){let s=this.adapters[t];e in s&&n.push(...s[e]),n.push(...s["*"])}let s=this.adapters["*"];return e in s&&n.push(...s[e]),n.push(...s["*"]),n}}function h(){return{[o]:[]}}class u{constructor(){this.value=0,this.prev=0}update(t){this.value=t}poll(){this.prev=this.value,this.value=0}getEvent(t){return 0}getState(){return this.value}getPrevState(){return this.prev}}class c extends u{constructor(){super(),this.delta=0,this.next={delta:0}}update(t,e){this.value=t,this.next.delta+=e}poll(){this.prev=this.value,this.delta=this.next.delta,this.next.delta=0}getEvent(t){switch(t){case i.MOVE:return this.delta;default:return super.getEvent(t)}}}class d extends u{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(t){t?this.next.down=!0:this.next.up=!0}poll(){this.prev=this.value;const{up:t,down:e}=this.next;this.value?this.up&&!t&&(this.value=0):e&&(this.value=1),this.down=e,this.up=t,this.next.down=!1,this.next.up=!1}getEvent(t){switch(t){case i.DOWN:return 1&this.down;case i.UP:return 1&this.up;default:return super.getEvent(t)}}}const p={NULL:0,UPDATE:1,POLL:2};class f{constructor(t=[]){this.onInputEvent=this.onInputEvent.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this);let e={},n={};for(let s of t){const t=s.deviceName;if(t in e)throw new Error(`Another device with name '${t}' already exists.`);e[t]=s,n[t]={},s.addInputListener(o,this.onInputEvent)}this.devices=e,this.keyMap=n,this.listeners={poll:[],update:[]},this._lastPollTime=-1,this._autopoll=!1,this._animationFrameHandle=null}get polling(){return performance.now()-this._lastPollTime<1e3}destroy(){this.clearKeys();for(let t in this.devices){let e=this.devices[t];e.removeInputListener(o,this.onInputEvent),e.destroy()}this.devices={}}poll(t=performance.now()){for(const t in this.keyMap){let e=this.keyMap[t];for(const n in e){let s=m(e[n]);s.poll(),this.dispatchInputEvent(p.POLL,t,n,s)}}this.dispatchPollEvent(t),this._lastPollTime=t}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let n=this.listeners[t],s=n.indexOf(e);n.splice(s,1)}}countEventListeners(t){if(!(t in this.listeners))throw new Error(`Cannot count listeners for unknown event '${t}'.`);return this.listeners[t].length}dispatchEvent(t,e){for(let n of this.listeners[t])n(e)}dispatchInputEvent(t,e,n,s){this.dispatchEvent("input",{stage:t,deviceName:e,keyCode:n,input:s})}dispatchPollEvent(t){this.dispatchEvent("poll",{now:t})}onInputEvent(t){const e=t.deviceName,n=this.keyMap[e];switch(t.type){case r.KEY:{const s=t.keyCode;let r=m(n[s]);if(r)return r.update(t.event===i.DOWN),this.dispatchInputEvent(p.UPDATE,e,s,r),!0}break;case r.POS:{let s=m(n.PosX);s&&(s.update(t.x,t.dx),this.dispatchInputEvent(p.UPDATE,e,"PosX",s));let r=m(n.PosY);r&&(r.update(t.y,t.dy),this.dispatchInputEvent(p.UPDATE,e,"PosY",r))}break;case r.WHEEL:{let s=m(n.WheelX);s&&(s.update(t.dx,t.dx),this.dispatchInputEvent(p.UPDATE,e,"WheelX",s));let r=m(n.WheelY);r&&(r.update(t.dy,t.dy),this.dispatchInputEvent(p.UPDATE,e,"WheelY",r));let i=m(n.WheelZ);i&&(i.update(t.dz,t.dz),this.dispatchInputEvent(p.UPDATE,e,"WheelZ",i))}}}onAnimationFrame(t){this._autopoll&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.poll(t))}set autopoll(t){this._autopoll=t,this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=null),t&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame))}get autopoll(){return this._autopoll}registerKey(t,e){if(!(t in this.devices))throw new Error(`Invalid device name - missing device with name '${t}' in source.`);let n=this.keyMap[t];if(e in n)n[e].refs+=1;else{let s,r=this.devices[t];if(r.constructor.isAxis(e))s=new c;else{if(!r.constructor.isButton(e))throw new Error(`Unknown key code '${e}' for device ${t}.`);s=new d}n[e]=function(t=null){return{refs:1,input:t}}(s)}return this}unregisterKey(t,e){let n=this.keyMap[t];if(n){let t=n[e];t&&(!function(t){t.refs-=1}(t),t.refs<=0&&delete n[e])}}hasKey(t,e){return t in this.keyMap&&e in this.keyMap[t]}clearKeys(){for(let t in this.devices){let e=this.keyMap[t];for(let t in e)e[t].refs=0;this.keyMap[t]={}}}getInputByKey(t,e){return m(this.keyMap[t][e])}}function m(t){return t?t.input:null}const y=":";class b extends u{constructor(){super(),this.update=this.update.bind(this),this.adapters=[],this.values=[],this.next={values:[],value:0}}hydrate(t){if(!t)return;Array.isArray(t)||(t=[t]);let e=[],n=0;for(let s of t){"string"==typeof s&&(s={key:s});const{key:t,scale:r=1,event:o="null"}=s,{deviceName:a,keyCode:h}=g(t),u=i.parse(o),c=Number(r);let d=l.createAdapter(this,n,a,h,c,u);e.push(d),++n}this.adapters=e,this.values=new Array(e.length).fill(0),this.next={values:new Array(e.length).fill(0),value:0}}poll(t,e){this.prev=this.value;const n=e.adapterId;let s=this.values[n];this.values[n]=t,this.value=this.value-s+t,this.next.values[n]=0,this.next.value+=t-s}update(t,e){const n=e.adapterId;let s=this.next.values[n];this.next.values[n]=t,this.next.value+=t-s}reset(){this.prev=0,this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function g(t){let e=t.indexOf(y);if(e>=0)return{deviceName:t.substring(0,e),keyCode:t.substring(e+1)};throw new Error("Invalid key string - missing device separator ':'.")}class v{constructor(){this._source=null,this._mapping=null,this._disabled=!0,this._ignoreInputs=this._disabled,this.adapters=new l,this.inputs={},this.listeners={change:[],attach:[],detach:[]},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this)}get source(){return this._source}get mapping(){return this._mapping}get disabled(){return this._disabled}set disabled(t){this.toggle(!t)}setInputMapping(t){const e=this.disabled;this.disabled=!0;let n=this.source,s=this.inputs;n&&w(n,s),this.adapters.clear();let r=this.source,i={};if(t){for(let e in t){let n=t[e],r=s[e]||new b;r.hydrate(n);let o=r.adapters;this.adapters.add(o),i[e]=r}r&&_(r,i)}return this.inputs=i,this._mapping=t,this.dispatchChangeEvent(),this.disabled=!this.source||!this.inputs||e,this}attach(t){if(this.source)throw new Error("Already attached to existing input source.");if(!t)throw new Error("Missing input source to attach context.");return _(t,this.inputs),t.addEventListener("poll",this.onSourcePoll),t.addEventListener("input",this.onSourceInput),this._source=t,this.toggle(!0),this.dispatchAttachEvent(),this}detach(){let t=this.source,e=this.inputs;return t&&(this.toggle(!1),t.removeEventListener("poll",this.onSourcePoll),t.removeEventListener("input",this.onSourceInput),e&&w(t,e),this._source=null,this.dispatchDetachEvent()),this}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let n=this.listeners[t],s=n.indexOf(e);n.splice(s,1)}}countEventListeners(t){if(!(t in this.listeners))throw new Error(`Cannot count listeners for unknown event '${t}'.`);return this.listeners[t].length}dispatchEvent(t,e){for(let n of this.listeners[t])n(e)}dispatchChangeEvent(){this.dispatchEvent("change",{})}dispatchAttachEvent(){this.dispatchEvent("attach",{})}dispatchDetachEvent(){this.dispatchEvent("detach",{})}onSourceInput(t){if(t.consumed||this._ignoreInputs){const{deviceName:e,keyCode:n,input:s}=t;this.adapters.reset(e,n,s)}else{const{stage:e,deviceName:n,keyCode:s,input:r}=t;switch(e){case p.POLL:this.adapters.poll(n,s,r);break;case p.UPDATE:this.adapters.update(n,s,r);break;default:throw new Error("Unknown input source stage.")}t.consumed=!0}}onSourcePoll(t){this._ignoreInputs!==this.disabled&&(this._ignoreInputs=this.disabled)}toggle(t=this._disabled){let e=!t;if(!e&&!this.source)throw new Error("Input source must be set before enabling input context.");return this._disabled=e,this}hasInput(t){return t in this.inputs&&this.inputs[t].adapters.length>0}getInput(t){if(t in this.inputs)return this.inputs[t];{let e=new b;return this.inputs[t]=e,this._mapping[t]="",this.dispatchChangeEvent(),e}}getInputState(t){return t in this.inputs?this.inputs[t].value:0}getInputChanged(t){if(t in this.inputs){let e=this.inputs[t];return e.value-e.prev}return 0}}function _(t,e){for(let n in e){let{adapters:s}=e[n];for(let e of s){const{deviceName:n,keyCode:s}=e;t.registerKey(n,s)}}}function w(t,e){for(let n in e){let{adapters:s}=e[n];for(let e of s){const{deviceName:n,keyCode:s}=e;t.unregisterKey(n,s)}}}class x extends a{static isAxis(t){return!1}static isButton(t){return!0}constructor(t,e={}){super("Keyboard",t);const{repeat:n=!1}=e;this.repeat=n,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:i.NULL,type:r.KEY,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)}destroy(){let t=this.eventTarget;t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._eventObject;return e.keyCode=t.code,e.event=i.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onKeyUp(t){let e=this._eventObject;if(e.keyCode=t.code,e.event=i.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}}class E extends a{static isAxis(t){return"PosX"===t||"PosY"===t||"WheelX"===t||"WheelY"===t||"WheelZ"===t}static isButton(t){return!this.isAxis(t)}constructor(t,e={eventsOnFocus:!0}){super("Mouse",t),this.canvasTarget=t instanceof HTMLCanvasElement&&t||t.canvas||t.querySelector("canvas")||t.shadowRoot&&t.shadowRoot.querySelector("canvas")||t,this.eventsOnFocus=e.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:i.NULL,type:r.KEY,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:t,deviceName:this.deviceName,keyCode:"Position",event:i.MOVE,type:r.POS,x:0,y:0,dx:0,dy:0},this._wheelObject={target:t,deviceName:this.deviceName,keyCode:"Wheel",event:i.MOVE,type:r.WHEEL,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("contextmenu",this.onContextMenu),t.addEventListener("wheel",this.onWheel),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let t=this.eventTarget;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("contextmenu",this.onContextMenu),t.removeEventListener("wheel",this.onWheel),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(t=!0){t?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(t){this._downHasFocus=!0;let e=this._eventObject;if(e.keyCode="Button"+t.button,e.event=i.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)&&document.activeElement===this.eventTarget)return t.preventDefault(),t.stopPropagation(),!1}onContextMenu(t){return t.preventDefault(),t.stopPropagation(),!1}onWheel(t){let e=this._wheelObject;switch(t.deltaMode){case WheelEvent.DOM_DELTA_LINE:e.dx=10*t.deltaX,e.dy=10*t.deltaY,e.dz=10*t.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:e.dx=100*t.deltaX,e.dy=100*t.deltaY,e.dz=100*t.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:e.dx=t.deltaX,e.dy=t.deltaY,e.dz=t.deltaZ}if(this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}onMouseUp(t){if(!this._downHasFocus)return;this._downHasFocus=!1;let e=this._eventObject;return e.keyCode="Button"+t.button,e.event=i.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onMouseMove(t){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const e=this.canvasTarget,{clientWidth:n,clientHeight:s}=e,r=e.getBoundingClientRect();let i=t.movementX/n,o=t.movementY/s,a=(t.clientX-r.left)/n,l=(t.clientY-r.top)/s,h=this._positionObject;h.x=a,h.y=l,h.dx=i,h.dy=o,this.dispatchInput(h)}}class A extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<kbd>\n    <span id="key"><slot></slot></span>\n    <span id="value" class="hidden"></span>\n</kbd>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML='kbd{position:relative;display:inline-block;border-radius:3px;border:1px solid #888;font-size:.85em;font-weight:700;text-rendering:optimizeLegibility;line-height:12px;height:14px;padding:2px 4px;color:#444;background-color:#eee;box-shadow:inset 0 -3px 0 #aaa;overflow:hidden}kbd:empty:after{content:"<?>";opacity:.6}.disabled{opacity:.6;box-shadow:none;background-color:#aaa}.hidden{display:none}#value{position:absolute;top:0;bottom:0;right:0;font-size:.85em;padding:2px 4px 0;color:#ccc;background-color:#333;box-shadow:inset 0 3px 0 #222}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{name:String,value:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get value(){return this._value}set value(t){this.setAttribute("value",t)}get name(){return this._name}set name(t){this.setAttribute("name",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._keyboardElement=this.shadowRoot.querySelector("kbd"),this._keyElement=this.shadowRoot.querySelector("#key"),this._valueElement=this.shadowRoot.querySelector("#value")}attributeChangedCallback(t,e,n){switch(t){case"name":this._name=n;break;case"value":this._value=n;break;case"disabled":this._disabled=null!==n}((t,e,n)=>{switch(t){case"name":this._keyElement.innerText=n;break;case"value":null!==n?(this._valueElement.classList.toggle("hidden",!1),this._valueElement.innerText=n,this._keyboardElement.style.paddingRight=`${this._valueElement.clientWidth+4}px`):this._valueElement.classList.toggle("hidden",!0);break;case"disabled":this._keyboardElement.classList.toggle("disabled",null!==n)}})(t,0,n)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"name")){let t=this.name;delete this.name,this.name=t}if(Object.prototype.hasOwnProperty.call(this,"value")){let t=this.value;delete this.value,this.value=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}}static get observedAttributes(){return["name","value","disabled"]}}window.customElements.define("input-key",A);class M extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<table>\n    <thead>\n        <tr class="tableHeader">\n            <th colspan=4>\n                <slot></slot>\n            </th>\n        </tr>\n        <tr class="colHeader">\n            <th>name</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:block}table{border-collapse:collapse}table,td,th{border:1px solid #666}td,th{padding:5px 10px}td{text-align:center}thead th{padding:0}.colHeader>th{font-size:.8em;padding:0 10px;letter-spacing:3px;background-color:#aaa;color:#666}.colHeader>th,output{font-family:monospace}output{border-radius:.3em;padding:3px}tr:not(.primary) .name,tr:not(.primary) .value{opacity:.3}tr:nth-child(2n){background-color:#eee}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get customEvents(){return["load"]}get onload(){return this._onload}set onload(t){this._onload&&this.removeEventListener("load",this._onload),this._onload=t,this._onload&&this.addEventListener("load",t)}static get observedAttributes(){return["onload","src"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._inputMap=null,this._tableElements={},this._titleElement=this.shadowRoot.querySelector("#title"),this._bodyElement=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot")}get map(){return this._inputMap}get mapElements(){return this._tableElements}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onload")){let t=this.onload;delete this.onload,this.onload=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let n=t[e];delete t[e],t[e]=n}}(this,"src")}attributeChangedCallback(t,e,n){switch(t){case"onload":this.onload=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"src":if(this._src!==n)if(this._src=n,n.trim().startsWith("{")){let t=JSON.parse(n);this._setInputMap(t)}else fetch(n).then((t=>t.json())).then((t=>this._setInputMap(t)))}})(t,0,n)}get src(){return this.getAttribute("src")}set src(t){switch(typeof t){case"object":{let e=JSON.stringify(t);this._src=e,this._setInputMap(t),this.setAttribute("src",e)}break;case"string":this.setAttribute("src",t);break;default:this.setAttribute("src",JSON.stringify(t))}}_setInputMap(t){let e={},n=[];for(let s in t){let r=[];S(r,s,t[s]),e[s]=r,n.push(...r)}this._bodyElement.innerHTML="";for(let t of n)this._bodyElement.appendChild(t);this._inputMap=t,this._tableElements=e,this.dispatchEvent(new CustomEvent("load",{bubbles:!1,composed:!0,detail:{map:t}}))}}function S(t,e,n){if(Array.isArray(n)){S(t,e,n[0]);let s=n.length;for(let r=1;r<s;++r)t.push(T(e,n[r],!1))}else t.push(T(e,n,!0));return t}function T(t,e,n=!0){if("object"==typeof e){const{key:s,event:r,scale:i}=e;return N(t,s,r,i,0,n)}return N(t,e,null,1,0,n)}function N(t,e,n,s,r,i=!0){let o=document.createElement("tr");i&&o.classList.add("primary");{let e=document.createElement("td");e.textContent=t,e.classList.add("name"),o.appendChild(e)}{let t=document.createElement("td");t.classList.add("key");let n=new A;n.innerText=e,t.appendChild(n),o.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp"),r=[];"string"==typeof n&&"null"!==n&&r.push(n),"number"==typeof s&&1!==s&&r.push(`×(${s.toFixed(2)})`),e.innerText=r.join(" "),t.classList.add("mod"),t.appendChild(e),o.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("output");e.innerText=Number(r).toFixed(2),e.classList.add("value"),t.appendChild(e),o.appendChild(t)}return o}window.customElements.define("input-map",M);const I=Symbol("inputSourceState");class k extends f{static for(t){if(t)return function(t){if(L(t)){let e=Object.getOwnPropertyDescriptor(t,I);return e.value.refs+=1,e.value.state}{let e=new f([new x(t),new E(t)]);return Object.defineProperty(t,I,{value:{state:e,refs:1},configurable:!0}),e}}(t);throw new Error("Cannot get input source for null event target.")}static delete(t){t&&function(t){if(L(t)){let e=Object.getOwnPropertyDescriptor(t,I);if(e.value.refs-=1,e.value.refs<=0){let n=e.value.state;delete t[I],n.destroy()}}}(t)}constructor(){throw super(),new Error("Cannot construct InputSource with new - use InputSourceState() instead.")}}function L(t){return Object.prototype.hasOwnProperty.call(t,I)&&Object.getOwnPropertyDescriptor(t,I).value}class O extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div>\n    <label id="title">\n        input-source\n    </label>\n    <span>|</span>\n    <p>\n        <label for="poll">poll</label>\n        <output id="poll"></output>\n    </p>\n    <p>\n        <label for="focus">focus</label>\n        <output id="focus"></output>\n    </p>\n</div>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=':host{display:inline-block}div{font-family:monospace;color:#666;outline:1px solid #666;padding:4px}p{display:inline;margin:0;padding:0}#focus:empty:after,#poll:empty:after{content:"✗";color:red}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean}}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get customEvents(){return["input","poll","change"]}get onchange(){return this._onchange}set onchange(t){this._onchange&&this.removeEventListener("change",this._onchange),this._onchange=t,this._onchange&&this.addEventListener("change",t)}get onpoll(){return this._onpoll}set onpoll(t){this._onpoll&&this.removeEventListener("poll",this._onpoll),this._onpoll=t,this._onpoll&&this.addEventListener("poll",t)}get oninput(){return this._oninput}set oninput(t){this._oninput&&this.removeEventListener("input",this._oninput),this._oninput=t,this._oninput&&this.addEventListener("input",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._containerElement=this.shadowRoot.querySelector("div"),this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._focusElement=this.shadowRoot.querySelector("#focus"),this._eventTarget=null,this._sourceState=null,this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceInput=this.onSourceInput.bind(this),this.onTargetFocus=this.onTargetFocus.bind(this),this.onTargetBlur=this.onTargetBlur.bind(this),this.onPollStatusCheck=this.onPollStatusCheck.bind(this),this._intervalHandle=0}get eventTarget(){return this._eventTarget}get source(){return this._sourceState}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"oninput")){let t=this.oninput;delete this.oninput,this.oninput=t}if(Object.prototype.hasOwnProperty.call(this,"onpoll")){let t=this.onpoll;delete this.onpoll,this.onpoll=t}if(Object.prototype.hasOwnProperty.call(this,"onchange")){let t=this.onchange;delete this.onchange,this.onchange=t}if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.hasAttribute("for")||this._eventTarget||this.setEventTarget(this),this._intervalHandle=setInterval(this.onPollStatusCheck,1e3)}disconnectedCallback(){this.clearEventTarget(),clearInterval(this._intervalHandle)}attributeChangedCallback(t,e,n){switch(t){case"for":this._for=n;break;case"autopoll":this._autopoll=null!==n;break;case"oninput":this.oninput=new Function("event","with(document){with(this){"+n+"}}").bind(this);break;case"onpoll":this.onpoll=new Function("event","with(document){with(this){"+n+"}}").bind(this);break;case"onchange":this.onchange=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"for":{let t,e;n?(t=document.getElementById(n),e=`${t.tagName.toLowerCase()}#${n}`):(t=this,e="input-source"),this.setEventTarget(n?document.getElementById(n):this),this._titleElement.innerHTML=`for(${e})`}break;case"autopoll":this._sourceState&&(this._sourceState.autopoll=this._autopoll)}})(t,0,n)}setEventTarget(t){if(this.clearEventTarget(),t){let e=k.for(t);this._sourceState=e,this._eventTarget=t,e.autopoll=this.autopoll,e.addEventListener("poll",this.onSourcePoll),e.addEventListener("input",this.onSourceInput),t.addEventListener("focus",this.onTargetFocus),t.addEventListener("blur",this.onTargetBlur),this.dispatchEvent(new CustomEvent("change",{composed:!0,bubbles:!1}))}return this}clearEventTarget(){if(this._eventTarget){let t=this._eventTarget,e=this._sourceState;this._eventTarget=null,this._sourceState=null,t&&(t.removeEventListener("focus",this.onTargetFocus),t.removeEventListener("blur",this.onTargetBlur),e.removeEventListener("poll",this.onSourcePoll),e.removeEventListener("input",this.onSourceInput),k.delete(t))}}poll(t){this._sourceState.poll(t)}onPollStatusCheck(){this._sourceState&&this._sourceState.polling?this._pollElement.innerHTML="✓":this._pollElement.innerHTML=""}onSourceInput({stage:t,deviceName:e,keyCode:n,input:s}){this.dispatchEvent(new CustomEvent("input",{composed:!0,bubbles:!1,detail:{stage:t,deviceName:e,keyCode:n,input:s}}))}onSourcePoll({now:t}){this.dispatchEvent(new CustomEvent("poll",{composed:!0,bubbles:!1,detail:{now:t}}))}onTargetFocus(){this._focusElement.innerHTML="✓"}onTargetBlur(){this._focusElement.innerHTML=""}static get observedAttributes(){return["oninput","onpoll","onchange","for","autopoll"]}}window.customElements.define("input-source",O);class C extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML="<input-map>\n    <slot></slot>\n    <input-source></input-source>\n</input-map>\n",Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get observedAttributes(){return["for","autopoll","disabled","src"]}constructor(t=new v){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._mapElement=this.shadowRoot.querySelector("input-map"),this._sourceElement=this.shadowRoot.querySelector("input-source"),this._context=t,this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceChange=this.onSourceChange.bind(this),this.onContextChange=this.onContextChange.bind(this),this._sourceElement.addEventListener("poll",this.onSourcePoll),this._sourceElement.addEventListener("change",this.onSourceChange),this._context.addEventListener("change",this.onContextChange)}get context(){return this._context}get source(){return this._sourceElement.source}get mapping(){return this._mapElement.map}get src(){return this._src}set src(t){this.setAttribute("src","string"==typeof t?t:JSON.stringify(t))}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let n=t[e];delete t[e],t[e]=n}}(this,"src")}attributeChangedCallback(t,e,n){switch(t){case"for":this._for=n;break;case"autopoll":this._autopoll=null!==n;break;case"disabled":this._disabled=null!==n}((t,e,n)=>{switch(t){case"for":this._sourceElement.for=n;break;case"src":if(this._src!==n)if(this._src=n,n.trim().startsWith("{")){let t=JSON.parse(n);this.updateMapping(t)}else fetch(n).then((t=>t.json())).then((t=>this.updateMapping(t)));break;case"autopoll":this._sourceElement.autopoll=this._autopoll;break;case"disabled":this._context.source&&(this._context.disabled=this._disabled)}})(t,0,n)}updateMapping(t){this._context.setInputMapping(t),this._mapElement.src=t}onSourcePoll(){for(let[t,e]of Object.entries(this._mapElement.mapElements)){let n=this._context.getInputState(t);e[0].querySelector("output").innerText=Number(n).toFixed(2)}}onSourceChange(){this._context.source&&this._context.detach(),this._sourceElement.source&&(this._context.attach(this._sourceElement.source),this._context.disabled=this._disabled)}onContextChange(){this._mapElement.src=this._context.mapping}hasInput(t){return this._context.hasInput(t)}getInput(t){return this._context.getInput(t)}getInputState(t){return this._context.getInputState(t)}getInputChanged(t){return this._context.getInputChanged(t)}}window.customElements.define("input-port",C);class P{next(){return Math.random()}}let F;class R{constructor(t=new P){this.generator=t}static next(){return F.next()}next(){return this.generator.next()}static choose(t){return F.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return F.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static sign(){return F.sign()}sign(){return this.generator.next()<.5?-1:1}}F=new R;var j=Object.freeze({__proto__:null,line:function(t,e,n,s,r){let i=Math.floor(t),o=Math.floor(e),a=Math.floor(n),l=Math.floor(s),h=Math.abs(n-t),u=t<n?1:-1,c=-Math.abs(s-e),d=e<s?1:-1,p=h+c,f=i,m=o,y=r(f,m);if(void 0!==y)return y;let b=h*h+c*c,g=0;for(;g<b&&(f!==a||m!==l);){++g;let t=2*p;if(t>=c&&(p+=c,f+=u),t<=h&&(p+=h,m+=d),y=r(f,m),void 0!==y)return y}}});function U(t,e){const n=document.createElement("a"),s=e.indexOf(";");e=e.substring(0,s+1)+"headers=Content-Disposition%3A%20attachment%3B%20filename="+t+";"+e.substring(s+1),n.setAttribute("href",e),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}const D=["svg","g"];function B(t,e=t.cloneNode(!0)){let n=t.childNodes,s=e.childNodes;for(var r=0;r<s.length;r++){let t=s[r],e=t.tagName;if(-1!=D.indexOf(e))B(n[r],t);else if(n[r]instanceof Element){const e=window.getComputedStyle(n[r]);let s=[];for(let t of Object.keys(e))s.push(`${t}:${e.getPropertyValue(t)};`);t.setAttribute("style",s.join(""))}}return e}var z=Object.freeze({__proto__:null,FILE_TYPE_PNG:"png",FILE_TYPE_SVG:"svg",downloadText:function(t,e){U(t,"data:text/plain; charset=utf-8,"+encodeURIComponent(e))},downloadImageFromSVG:function(t,e,n,s,r){const i=function(t){const e=B(t),n=(new XMLSerializer).serializeToString(e);return new Blob([n],{type:"image/svg+xml"})}(n);switch(e){case"png":{const n=URL.createObjectURL(i),o=document.createElement("canvas"),a=o.getContext("2d"),l=window.devicePixelRatio||1;o.width=s*l,o.height=r*l,o.style.width=s+"px",o.style.height=r+"px",a.setTransform(l,0,0,l,0,0);const h=new Image;h.onload=()=>{a.drawImage(h,0,0),URL.revokeObjectURL(n);const s=o.toDataURL("image/"+e).replace("image/"+e,"image/octet-stream");U(t,s)},h.src=n}break;case"svg":{const e=new FileReader;e.onload=()=>{U(t,e.result)},e.readAsDataURL(i)}break;default:throw new Error("Unknown file type '"+e+"'")}},downloadURL:U});var H=Object.freeze({__proto__:null,uploadFile:async function(t=[],e=!1){return new Promise(((n,s)=>{const r=document.createElement("input");r.addEventListener("change",(t=>{n(e?t.target.files:t.target.files[0])})),r.type="file",r.accept=t.join(","),r.style.display="none",r.toggleAttribute("multiple",e),document.body.appendChild(r),r.click(),document.body.removeChild(r)}))}});const W={5:$("#7F8C8D"),4:$("#2ECC71"),3:$("#4794C8"),2:$("#F39C12"),1:$("#C0392B"),0:[""]};function V(t,e){return t-e}function $(t){return[`background: ${t}`,"border-radius: 0.5em","color: white","font-weight: bold","padding: 2px 0.5em"]}function q(){}function K(t){switch(t){case 5:return console.trace;case 4:case 3:return console.log;case 2:return console.warn;case 1:return console.error;case 0:return q;default:return console.log}}function Y(t,e,n,s){if(e&&t.unshift(`[${e}]`),n){let e=[`%c${n}`,W[s].join(";")];t.unshift(e[0],e[1])}return t}const G=Symbol("level"),X=Symbol("domain"),Q={};let J=2,Z="app";class tt{static get TRACE(){return 5}static get DEBUG(){return 4}static get INFO(){return 3}static get WARN(){return 2}static get ERROR(){return 1}static get OFF(){return 0}static getLogger(t){return t in Q?Q[t]:Q[t]=new tt(t)}static useDefaultLevel(t){return J=t,this}static useDefaultDomain(t){return Z=t,this}constructor(t){this.name=t,this[G]=J,this[X]=Z}setLevel(t){return this[G]=t,this}getLevel(){return this[G]}setDomain(t){return this[X]=t,this}getDomain(){return this[X]}log(t,...e){if(V(this[G],t)<0)return this;Y(e,this.name,this[X],t),K(t)(...e)}trace(...t){if(V(this[G],5)<0)return this;Y(t,this.name,this[X],5),K(5)(...t)}debug(...t){if(V(this[G],4)<0)return this;Y(t,this.name,this[X],4),K(4)(...t)}info(...t){if(V(this[G],3)<0)return this;Y(t,this.name,this[X],3),K(3)(...t)}warn(...t){if(V(this[G],2)<0)return this;Y(t,this.name,this[X],2),K(2)(...t)}error(...t){if(V(this[G],1)<0)return this;Y(t,this.name,this[X],1),K(1)(...t)}}var et=Object.freeze({__proto__:null,Logger:tt});const nt={on(t,e,n=e){let s;if(this.__events.has(t)?s=this.__events.get(t):(s=new Map,this.__events.set(t,s)),s.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return s.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,((...s)=>{this.off(t,n),e.apply(this.__context||this,s)}),n)},emit(t,...e){if(this.__events.has(t)){let n=[];const s=Array.from(this.__events.get(t).values());for(const t of s){let s=t.apply(this.__context||this,e);s&&n.push(s)}return n}return this.__events.set(t,new Map),[]}};function st(t){const e=Object.create(nt);return e.__events=new Map,e.__context=t,e}function rt(t,e){const n=Object.assign(t,nt);return n.__events=new Map,n.__context=e,n}function it(t,e){const n=t.prototype;return Object.assign(n,nt),n.__events=new Map,n.__context=e,n}var ot={create:st,assign:rt,mixin:it},at=Object.freeze({__proto__:null,create:st,assign:rt,mixin:it,default:ot});class lt{constructor(t){this._heap=[],this._comparator=t}get size(){return this._heap.length}clear(){this._heap.length=0}push(...t){for(const e of t)this._heap.push(e),this._shiftUp()}pop(){const t=this.peek();let e=this._heap.length-1;return e>0&&this._swap(0,e),this._heap.pop(),this._shiftDown(),t}replace(t){const e=this.peek();return this._heap[0]=t,this._shiftDown(),e}peek(){return this._heap[0]}_compare(t,e){return this._comparator(this._heap[t],this._heap[e])}_swap(t,e){let n=this._heap[t];this._heap[t]=this._heap[e],this._heap[e]=n}_shiftUp(){let t,e=this._heap.length-1;for(;e>0&&this._compare(e,t=(e+1>>>1)-1);)this._swap(e,t),e=t}_shiftDown(){const t=this._heap.length;let e,n=0,s=ht(n),r=s<t,i=ut(n),o=i<t;for(;r&&this._compare(s,n)||o&&this._compare(i,n);)e=o&&this._compare(i,s)?i:s,this._swap(n,e),n=e,s=ht(n),r=s<t,i=ut(n),o=i<t}values(){return this._heap}[Symbol.iterator](){return this._heap[Symbol.iterator]()}}function ht(t){return 1+(t<<1)}function ut(t){return t+1<<1}function ct(t,e,n){return Math.min(n,Math.max(e,t))}function dt(t,e,n){let s=n-e,r=(t-e)%s;return r<0&&(r+=s),r+e}const pt=Math.PI/180,ft=180/Math.PI;function mt(t,e,n){if(n.has(e))throw new Error(`Found cyclic dependency for '${e.name||e}'.`);if(!t.visited.has(e)){if(t.visited.add(e),t.edgeMap.has(e)){let s=t.edgeMap.get(e);if(s.size>0){n.add(e);for(let e of s)mt(t,e,n);n.delete(e)}}t.dst.push(e)}}async function yt(t,e){return new Promise(((e,n)=>{let s=new Image;s.addEventListener("load",(()=>{e(s)})),s.addEventListener("error",(t=>{n(t)})),s.src=t}))}var bt=Object.freeze({__proto__:null,loadImage:yt});async function gt(t,e){return(await fetch(t)).text()}var vt=Object.freeze({__proto__:null,loadText:gt});async function _t(t,e){let n=await fetch(t);return await n.arrayBuffer()}var wt=Object.freeze({__proto__:null,loadBytes:_t});async function xt(t,e){let n=await fetch(t);return await n.json()}var Et=Object.freeze({__proto__:null,loadJSON:xt});async function At(t,e){let n=await fetch(t),s=await n.text();{const t=10;for(let e=0;e<t;++e)performance.now(),St(s),performance.now()}{const t=10;for(let e=0;e<t;++e)performance.now(),Mt(s),performance.now()}return Mt(s)}function Mt(t){const e=[],n=[],s=[],r=[],i=[],o=[],a=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,l=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,h=/vt\s+(\S+)\s+(\S+)/g,u=/f\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))(\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*)))?/g,c=/f\s+([^/\s]+)\s+([^/\s]+)\s+([^/\s]+)/g;let d,p,f,m,y,b,g=!1,v=null;for(t=t.replace(/^#.*/g,"");null!=(v=a.exec(t));)d=Number.parseFloat(v[1]),p=Number.parseFloat(v[2]),f=Number.parseFloat(v[3]),e.push(d),e.push(p),e.push(f);for(;null!=(v=l.exec(t));)d=Number.parseFloat(v[1]),p=Number.parseFloat(v[2]),f=Number.parseFloat(v[3]),s.push(d),s.push(p),s.push(f);for(;null!=(v=h.exec(t));)d=Number.parseFloat(v[1]),p=Number.parseFloat(v[2]),n.push(d),n.push(p);for(;null!=(v=u.exec(t));)d=Number.parseInt(v[2]),Number.isNaN(d)&&(d=1),p=Number.parseInt(v[6]),Number.isNaN(p)&&(p=1),f=Number.parseInt(v[10]),Number.isNaN(f)&&(f=1),r.push(d),r.push(p),r.push(f),d=Number.parseInt(v[4]),Number.isNaN(d)?(d=Number.parseInt(v[3]),p=Number.parseInt(v[7]),f=Number.parseInt(v[11]),o.push(d),o.push(p),o.push(f),i.push(1),i.push(1),i.push(1)):(p=Number.parseInt(v[8]),Number.isNaN(p)&&(p=1),f=Number.parseInt(v[12]),Number.isNaN(f)&&(f=1),o.push(d),o.push(p),o.push(f),d=Number.parseInt(v[3]),Number.isNaN(d)&&(d=1),p=Number.parseInt(v[7]),Number.isNaN(p)&&(p=1),f=Number.parseInt(v[11]),Number.isNaN(f)&&(f=1),i.push(d),i.push(p),i.push(f)),void 0!==v[13]&&(m=Number.parseInt(v[15]),Number.isNaN(m)&&(m=1),r.push(m),m=Number.parseInt(v[17]),Number.isNaN(m)?(m=Number.parseInt(v[16]),o.push(m),i.push(1)):(o.push(m),m=Number.parseInt(v[16]),i.push(m)),g=!0);for(;null!=(v=c.exec(t));)d=Number.parseInt(v[2]),p=Number.parseInt(v[6]),f=Number.parseInt(v[10]),r.push(d),r.push(p),r.push(f),i.push(1),i.push(1),i.push(1),o.push(1),o.push(1),o.push(1),void 0!==v[13]&&(m=Number.parseInt(v[14]),r.push(m),i.push(1),o.push(1),g=!0);b=r.length;const _=new Float32Array(3*b);for(let t=0;t<b;++t)y=r[t]-1,_[3*t+0]=e[3*y+0],_[3*t+1]=e[3*y+1],_[3*t+2]=e[3*y+2];b=i.length;const w=new Float32Array(2*b);for(let t=0;t<b;++t)y=i[t]-1,w[2*t+0]=n[2*y+0],w[2*t+1]=n[2*y+1];b=o.length;const x=new Float32Array(3*b);for(let t=0;t<b;++t)y=o[t]-1,x[3*t+0]=s[3*y+0],x[3*t+1]=s[3*y+1],x[3*t+2]=s[3*y+2];b=r.length;const E=new Uint16Array(b);for(let t=0;t<b;++t)E[t]=t;return g&&console.warn("WebGL does not support quad faces, only triangles."),{positions:_,texcoords:w,normals:x,indices:E}}function St(t){const e=[],n=[],s=[],r=[],i=[],o=[],a=/v( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,l=/vn( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,h=/vt( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,u=/f( +([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))?/g,c=/f( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g;let d,p,f,m,y,b,g=!1,v=null;for(t=t.replace(/^#.*/g,"");null!=(v=a.exec(t));)d=Number.parseFloat(v[1]),p=Number.parseFloat(v[2]),f=Number.parseFloat(v[3]),e.push(d),e.push(p),e.push(f);for(;null!=(v=l.exec(t));)d=Number.parseFloat(v[1]),p=Number.parseFloat(v[2]),f=Number.parseFloat(v[3]),s.push(d),s.push(p),s.push(f);for(;null!=(v=h.exec(t));)d=Number.parseFloat(v[1]),p=Number.parseFloat(v[2]),n.push(d),n.push(p);for(;null!=(v=u.exec(t));)d=Number.parseInt(v[2]),Number.isNaN(d)&&(d=1),p=Number.parseInt(v[6]),Number.isNaN(p)&&(p=1),f=Number.parseInt(v[10]),Number.isNaN(f)&&(f=1),r.push(d),r.push(p),r.push(f),d=Number.parseInt(v[3]),Number.isNaN(d)&&(d=1),p=Number.parseInt(v[7]),Number.isNaN(p)&&(p=1),f=Number.parseInt(v[11]),Number.isNaN(f)&&(f=1),i.push(d),i.push(p),i.push(f),d=Number.parseInt(v[4]),Number.isNaN(d)&&(d=1),p=Number.parseInt(v[8]),Number.isNaN(p)&&(p=1),f=Number.parseInt(v[12]),Number.isNaN(f)&&(f=1),o.push(d),o.push(p),o.push(f),void 0!==v[13]&&(m=Number.parseInt(v[14]),Number.isNaN(m)&&(m=1),r.push(m),m=Number.parseInt(v[15]),Number.isNaN(m)&&(m=1),i.push(m),m=Number.parseInt(v[16]),Number.isNaN(m)&&(m=1),o.push(m),g=!0);for(;null!=(v=c.exec(t));)d=Number.parseInt(v[2]),p=Number.parseInt(v[6]),f=Number.parseInt(v[10]),r.push(d),r.push(p),r.push(f),i.push(1),i.push(1),i.push(1),o.push(1),o.push(1),o.push(1),void 0!==v[13]&&(m=Number.parseInt(v[14]),r.push(m),i.push(1),o.push(1),g=!0);b=r.length;const _=new Float32Array(3*b);for(let t=0;t<b;++t)y=r[t]-1,_[3*t+0]=e[3*y+0],_[3*t+1]=e[3*y+1],_[3*t+2]=e[3*y+2];b=i.length;const w=new Float32Array(2*b);for(let t=0;t<b;++t)y=i[t]-1,w[2*t+0]=n[2*y+0],w[2*t+1]=n[2*y+1];b=o.length;const x=new Float32Array(3*b);for(let t=0;t<b;++t)y=o[t]-1,x[3*t+0]=s[3*y+0],x[3*t+1]=s[3*y+1],x[3*t+2]=s[3*y+2];b=r.length;const E=new Uint16Array(b);for(let t=0;t<b;++t)E[t]=t;return g&&console.warn("WebGL does not support quad faces, only triangles."),{positions:_,texcoords:w,normals:x,indices:E}}var Tt=Object.freeze({__proto__:null,loadOBJ:At});let Nt={};function It(t,e){Nt[t]=e}function kt(t){if(t in Nt)return Nt[t];throw new Error(`Unknown asset type '${t}'.`)}async function Lt(t,e={},n="."){if(t.indexOf(":")<0)throw new Error("Missing type for asset source.");let[s,r]=t.split(":"),i=kt(s);return await i(n+"/"+r,e)}It("image",yt),It("text",gt),It("json",xt),It("bytes",_t),It("obj",At);var Ot=Object.freeze({__proto__:null,defineAssetLoader:It,getAssetLoader:kt,loadAssetMap:async function(t,e="."){let n={};for(let s of Object.keys(t)){let r=t[s];if("string"==typeof r)n[s]=await Lt(r,void 0,e);else{if("object"!=typeof r)throw new Error("Unknown entry type in asset map.");if(!("src"in r))throw new Error("Missing required field 'src' for entry in asset map.");if("name"in r&&r.name!==s)throw new Error(`Cannot redefine name for asset '${s}' for entry in asset map.`);n[s]=await Lt(r.src,r,e)}}return n},loadAssetList:async function(t,e="."){let n={};for(let s of t)if("string"==typeof s)n[s]=await Lt(s,void 0,e);else{if("object"!=typeof s)throw new Error("Unknown entry type in asset list.");if(!("src"in s))throw new Error("Missing required field 'src' for entry in asset list.");n["name"in s?s.name:s.src]=await Lt(s.src,s,e)}return n},loadAsset:Lt});const Ct=1e-8;function Pt(t,e,n){return Math.min(Math.max(t,e),n)}function Ft(t,e,n,s){return{x:t,y:e,rx:n,ry:s}}function Rt(t,e,n){let s=n.x-e.x,r=n.rx+e.rx-Math.abs(s);if(r<0)return null;let i=n.y-e.y,o=n.ry+e.ry-Math.abs(i);if(o<0)return null;if(r<o){let i=Math.sign(s);t.dx=r*i,t.dy=0,t.nx=i,t.ny=0,t.x=e.x+e.rx*i,t.y=n.y}else{let s=Math.sign(i);t.dx=0,t.dy=o*s,t.nx=0,t.ny=s,t.x=n.x,t.y=e.y+e.ry*s}return t}function jt(t,e,n,s){let r=n-e.x,i=e.rx-Math.abs(r);if(i<0)return null;let o=s-e.y,a=e.ry-Math.abs(o);if(a<0)return null;if(i<a){let n=Math.sign(r);t.dx=i*n,t.dy=0,t.nx=n,t.ny=0,t.x=e.x+e.rx*n,t.y=s}else{let s=Math.sign(o);t.dx=0,t.dy=a*s,t.nx=0,t.ny=s,t.x=n,t.y=e.y+e.ry*s}return t}function Ut(t,e,n,s,r,i,o=0,a=0){if(Math.abs(r)<Ct&&Math.abs(i)<Ct&&0===o&&0===a)return jt(t,e,n,s);let l=e.rx,h=e.ry,u=o,c=a,d=1/(r||Ct),p=1/(i||Ct),f=Math.sign(d),m=Math.sign(p),y=(e.x-f*(l+u)-n)*d,b=(e.y-m*(h+c)-s)*p,g=(e.x+f*(l+u)-n)*d,v=(e.y+m*(h+c)-s)*p;if(y>v||b>g)return null;let _=Math.max(y,b),w=Math.min(g,v);if(_>1||w<0)return null;let x=Pt(_,0,1),E=(1-x)*-r,A=(1-x)*-i,M=n+r*x,S=s+i*x;return y>b?(t.time=x,t.nx=-f,t.ny=0,t.dx=E,t.dy=A,t.x=M,t.y=S):(t.time=x,t.nx=0,t.ny=-m,t.dx=E,t.dy=A,t.x=M,t.y=S),t}function Dt(t,e,n,s,r){if(Math.abs(s)<Ct&&Math.abs(r)<Ct){let s=Rt({},n,e);return s&&(s.time=0),t.x=e.x,t.y=e.y,t.time=s?0:1,t.hit=s,t}let i=function(t,e,n,s,r){return Ut(t,e,n.x,n.y,s,r,n.rx,n.ry)}({},n,e,s,r);if(i){let o,a,l=Pt(i.time,0,1),h=Math.sqrt(s*s+r*r);h?(o=s/h,a=r/h):(o=0,a=0),i.x=Pt(i.x+o*e.rx,n.x-n.rx,n.x+n.rx),i.y=Pt(i.y+a*e.ry,n.y-n.ry,n.y+n.ry),t.time=l,t.x=e.x+s*l,t.y=e.y+r*l,t.hit=i}else t.time=1,t.x=e.x+s,t.y=e.y+r,t.hit=i;return t}function Bt(t,e,n,s,r){let i={};t.time=1,t.x=e.x+s,t.y=e.y+r,t.hit=null;for(let o=0,a=n.length;o<a;++o){let a=Dt(i,e,n[o],s,r);a.time<=t.time&&(t.time=a.time,t.x=a.x,t.y=a.y,t.hit=a.hit)}return t}var zt=Object.freeze({__proto__:null,EPSILON:Ct,clamp:Pt,createAABB:Ft,createRect:function(t,e,n,s){let r=Math.abs(n-t)/2,i=Math.abs(s-e)/2;return Ft(Math.min(t,n)+r,Math.min(e,s)+i,r,i)},testAABB:function(t,e){return!(Math.abs(t.x-e.x)>t.rx+e.rx)&&!(Math.abs(t.y-e.y)>t.ry+e.ry)},intersectAABB:Rt,intersectPoint:jt,intersectSegment:Ut,sweepInto:Bt});function Ht(t,e=[]){for(let n of t)switch(n.type){case"point":n.hit=null;for(let t of e)if(n.hit=jt({},t,n.x,n.y),n.hit)break;break;case"segment":n.hit=null;for(let t of e)if(n.hit=Ut({},t,n.x,n.y,n.dx,n.dy,n.px,n.py),n.hit)break;break;case"aabb":n.hit=null;for(let t of e)if(n.hit=Rt({},t,n),n.hit)break}}function Wt(t,e=[],n=1){for(let s of t){let t,r=s.dx*n,i=s.dy*n,o=0,a={},l=null,h=100;do{if(t=Bt(a,s,e,r,i),s.x=t.x-Math.sign(r)*Ct,s.y=t.y-Math.sign(i)*Ct,o+=t.time,t.hit){r+=t.hit.nx*Math.abs(r),i+=t.hit.ny*Math.abs(i),l=t.hit;let e=Math.max(1-o,0);r*=e,i*=e,Math.abs(r)<Ct&&(r=0),Math.abs(i)<Ct&&(i=0)}}while(o<1&&--h>=0);s.dx=r,s.dy=i,s.hit=l}}var Vt=Object.freeze({__proto__:null,computeIntersections:Ht,resolveIntersections:Wt});var $t=Object.freeze({__proto__:null,createIntersectionWorld:function(){return{dynamics:[],masks:[],statics:[],update(t){Wt(this.dynamics,this.statics,t),Ht(this.masks,this.statics)},render(t){t.save(),t.strokeStyle="green";for(let e of this.statics)t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry);t.strokeStyle="lime";for(let e of this.dynamics)t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry);t.strokeStyle="blue";for(let e of this.masks)switch(e.type){case"point":t.save(),t.fillStyle="red",t.fillRect(e.x-1,e.y-1,2,2),t.restore();break;case"segment":t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+e.dx,e.y+e.dy),t.stroke();break;case"aabb":t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry)}t.restore()}}}});const qt=new AudioContext;!async function(t){document.addEventListener("click",(()=>{"suspended"===t.state&&t.resume()}))}(qt);const Kt={gain:0,pitch:0,pan:0,loop:!1};class Yt{constructor(t,e,n=!1){this.context=t,this.buffer=e,this._source=null,this.playing=!1,this.loop=n,this.onAudioSourceEnded=this.onAudioSourceEnded.bind(this)}onAudioSourceEnded(){this._playing=!1}play(t=Kt){if(!this.buffer)return;this._source&&this.destroy();const e=this.context;let n=e.createBufferSource();n.addEventListener("ended",this.onAudioSourceEnded),n.buffer=this.buffer,n.loop=t.loop;let s=n;if(t.pitch&&(n.detune.value=100*t.pitch),t.gain){const n=e.createGain();n.gain.value=t.gain,s=s.connect(n)}if(t.pan){const n=e.createStereoPanner();n.pan.value=t.pan,s=s.connect(n)}s.connect(e.destination),n.start(),this._source=n,this._playing=!0}pause(){this._source.stop(),this._playing=!1}destroy(){this._source&&this._source.disconnect(),this._source=null}}var Gt=Object.freeze({__proto__:null,AUDIO_CONTEXT:qt,AUDIO_ASSET_TAG:"audio",loadAudio:async function(t,e={}){const n=qt;let s=await fetch(t),r=await s.arrayBuffer(),i=await n.decodeAudioData(r);return new Yt(n,i,Boolean(e.loop))}});class Xt{static currentTime(){return performance.now()}static start(t){let e=new Xt(t,!1);return e.start(),e}constructor(t,e=!1){this.app=t,this._controlled=e,this._animationFrameHandle=null,this.prevFrameTime=0,this.started=!1,this.paused=!1,this.fixedTimeStep=1/60,this.prevAccumulatedTime=0,this._onstart=null,this._onstop=null,this._onpreupdate=null,this._onupdate=null,this._onfixedupdate=null,this._onpostupdate=null,this._onpause=null,this._onresume=null,this.onAnimationFrame=this.onAnimationFrame.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this)}setFixedUpdatesPerSecond(t){return this.fixedTimeStep=1/t,this}onWindowFocus(){this.started&&this.resume()}onWindowBlur(){this.started&&this.pause()}onAnimationFrame(t){if(this._controlled)throw new Error("Cannot run controlled game loop; call step() instead.");if(!this.started)throw new Error("Must be called after start().");this.animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.step(t)}step(t=Xt.currentTime()){if(!this.started)return!1;const e=t-this.prevFrameTime;if(this.prevFrameTime=t,this.paused)return!1;if(this.app.preUpdate&&this.app.preUpdate(e),this.app.update&&this.app.update(e),this.prevAccumulatedTime+=e/1e3,this.prevAccumulatedTime>250*this.fixedTimeStep){let t=250*this.fixedTimeStep,e=Math.floor((this.prevAccumulatedTime-t)/this.fixedTimeStep);this.prevAccumulatedTime=t,console.error(`[ApplicationLoop] Too many updates! Skipped ${e} fixed updates.`)}for(;this.prevAccumulatedTime>=this.fixedTimeStep;)this.prevAccumulatedTime-=this.fixedTimeStep,this.app.fixedUpdate&&this.app.fixedUpdate();this.app.postUpdate&&this.app.postUpdate(e)}start(){if(this.started)throw new Error("Loop already started.");return window.addEventListener("focus",this.onWindowFocus),window.addEventListener("blur",this.onWindowBlur),this.started=!0,this.prevFrameTime=Xt.currentTime(),this.app.start&&this.app.start(),this.controlled||this.onAnimationFrame(this.prevFrameTime),this}stop(){if(!this.started)throw new Error("Loop not yet started.");return window.removeEventListener("focus",this.onWindowFocus),window.removeEventListener("blur",this.onWindowBlur),this.started=!1,this.app.stop&&this.app.stop(),this._controlled||this.animationFrameHandle&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null),this}pause(){return this.paused||(this.paused=!0,this.app.pause&&this.app.pause()),this}resume(){return this.pause?(this.prevFrameTime=Xt.currentTime(),this.paused=!1,this.app.resume&&this.app.resume(),this):this}}class Qt{constructor(t){this.context=t,this.display=null,this.renderContext=null}setDisplay(t){return this.display=t,this.renderContext=t.canvas.getContext("2d"),this}start(){this.context.start()}update(t){this.context.update(t),this.context.render(this.renderContext)}}const Jt=Symbol("game"),Zt=Symbol("loop");var te=Object.freeze({__proto__:null,start:function(t){let e={...t},n=new Qt(e),s=new Xt(n);return e[Jt]=n,e[Zt]=s,e.display=null,window.addEventListener("DOMContentLoaded",(()=>{let t=document.querySelector("display-port");if(!t)throw new Error("Cannot find display-port in document.");n.setDisplay(t),e.display=t,e.load().then((()=>s.start()))})),e},stop:function(t){t[Zt].stop(),delete t[Jt],delete t[Zt]}});const ee={x:0,y:0,width:1,height:1,color:"dodgerblue",solid:!0},ne=Symbol("BoxRendererInfo");function se(t,e,n,s){return e?t in e?e[t]:t in n?n[t]:s[t]:n&&t in n?n[t]:s[t]}const re={x:0,y:0,width:1,height:1,spriteImage:null},ie=Symbol("SpriteRendererInfo");function oe(t,e,n,s){return e?t in e?e[t]:t in n?n[t]:s[t]:n&&t in n?n[t]:s[t]}class ae{static createBounds(t,e,n,s){return{x:t,y:e,rx:n,ry:s}}constructor(t=0,e=ae.createBounds(0,0,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)){this.level=t,this.bounds=e,this.boxes=[],this.nodes=new Array(4)}insertAll(t){for(let e of t)this.insert(e)}insert(t){let e=this.nodes[0];if(e){let e=this.findQuadIndex(t);if(e>=0)return void this.nodes[e].insert(t)}if(this.boxes.push(t),this.boxes.length>10&&this.level<5){e||this.split();for(let t=this.boxes.length-1;t>=0;--t){let e=this.boxes[t],n=this.findQuadIndex(e);n>=0&&(this.boxes.splice(t,1),this.nodes[n].insert(e))}}}retrieve(t,e=[],n={}){const{includeSelf:s=!1}=n;if(this.nodes[0]){let n=this.findQuadIndex(t);n>=0&&this.nodes[n].retrieve(t,e)}let r=this.boxes;if(s)e.push(...r);else{let n=r.indexOf(t);for(let t=0;t<n;++t)e.push(r[t]);let s=r.length;for(let t=n+1;t<s;++t)e.push(r[t])}return e}clear(){this.boxes.length=0;for(let t=0;t<this.nodes.length;++t){let e=this.nodes[t];e&&(e.clear(),this.nodes[t]=null)}}split(){let{x:t,y:e,rx:n,ry:s}=this.bounds,r=this.level+1,i=this.constructor;this.nodes[0]=new i(r,ae.createBounds(t+n,e,n,s)),this.nodes[1]=new i(r,ae.createBounds(t,e,n,s)),this.nodes[2]=new i(r,ae.createBounds(t,e+s,n,s)),this.nodes[3]=new i(r,ae.createBounds(t+n,e+s,n,s))}findQuadIndex(t){const{x:e,y:n,rx:s,ry:r}=this.bounds,i=e+s,o=n+r,{x:a,y:l,rx:h,ry:u}=t,c=l<o&&l+2*u<o,d=l>o;let p=-1;return a<i&&a+2*h<i?c?p=1:d&&(p=2):a>i&&(c?p=0:d&&(p=3)),p}}function le(t,e,n,s,r,i,o){return{x:t,y:e,dx:n,dy:s,nx:r,ny:i,time:o}}function he(t,e){let n=e.x-t.x,s=e.rx+t.rx-Math.abs(n);if(s<0)return null;let r=e.y-t.y,i=e.ry+t.ry-Math.abs(r);if(i<0)return null;if(s<i){let r=Math.sign(n);return le(t.x+t.rx*r,e.y,s*r,0,r,0,0)}{let n=Math.sign(r);return le(e.x,t.y+t.ry*n,0,i*n,0,n,0)}}const ue=Symbol("maskCount");class ce{constructor(t,e,n,s,r,i){this.aabbGraph=t,this.mask=e,this.x=n,this.y=s,this.rx=r,this.ry=i}setPosition(t,e){return this.x=t,this.y=e,this}setSize(t,e){return this.setHalfSize(t/2,e/2)}setHalfSize(t,e){return this.rx=t,this.ry=e,this}}const de={};function pe(t,e,n){null===t?(n.rootNodes.push(e),e.parentNode=null):(t.childNodes.push(e),e.parentNode=t)}function fe(t,e,n){if(null===t){let t=n.rootNodes.indexOf(e);n.rootNodes.splice(t,1),e.parentNode=void 0}else{let n=t.childNodes.indexOf(e);t.childNodes.splice(n,1),e.parentNode=void 0}}function me(t,e,n,s,r){if(n>=100)return;let i=s(e.owner,e);if(!1===i)return;let o=e.childNodes;r&&ye(t.nodes,o,e,r);for(let t of o)me(t,n+1,s);"function"==typeof i&&i(e.owner,e)}function ye(t,e,n,s){let r=e.map((t=>t.owner));s(r,n);for(let n=0;n<r.length;++n)e[n]=t.get(r[n]);e.length=r.length}class be{constructor(t,e,n,s){this.sceneGraph=t,this.owner=e,this.parentNode=n,this.childNodes=s}}const ge=e.vec3.fromValues(0,0,0),ve=e.vec3.fromValues(1,0,0),_e=e.vec3.fromValues(0,1,0),we=e.vec3.fromValues(0,0,1);function xe(){return{translation:e.vec3.create(),rotation:e.quat.create(),scale:e.vec3.fromValues(1,1,1)}}function Ee(t,n=e.mat4.create()){return e.mat4.fromRotationTranslationScale(n,t.rotation,t.translation,t.scale)}var Ae=Object.freeze({__proto__:null,ORIGIN:ge,XAXIS:ve,YAXIS:_e,ZAXIS:we,create:xe,lookAt:function(t,n=ge){const s=e.vec3.create();e.vec3.subtract(s,n,t.position),e.vec3.normalize(s,s);const r=e.vec3.dot(we,s);if(Math.abs(r- -1)<Number.EPSILON)return e.quat.set(t.rotation,0,0,1,Math.PI),t;if(Math.abs(r-1)<Number.EPSILON)return e.quat.set(t.rotation,0,0,0,1),t;e.vec3.cross(s,we,s),e.vec3.normalize(s,s);const i=Math.acos(r)/2,o=Math.sin(i);return t.rotation[0]=s[0]*o,t.rotation[1]=s[1]*o,t.rotation[2]=s[2]*o,t.rotation[3]=Math.cos(i),t},getTransformationMatrix:Ee,getForwardVector:function(t,n=e.vec3.create()){return e.vec3.transformQuat(n,we,t.rotation),n},getUpVector:function(t,n=e.vec3.create()){return e.vec3.transformQuat(n,_e,t.rotation),n},getRightVector:function(t,n=e.vec3.create()){return e.vec3.transformQuat(n,ve,t.rotation),n}});function Me(t,e,n,s,r){if(!r){const e=Math.random(),n=Math.random(),s=Math.random();r=[];for(let i=0;i<t.length;i+=3)r.push(e,n,s)}return{position:t,texcoord:e,normal:n,indices:s,color:r,elementSize:3,elementCount:s.length}}function Se(t,e,n,s){for(let r=0;r<s.color.length;r+=3)s.color[r+0]=t,s.color[r+1]=e,s.color[r+2]=n;return s}function Te(t,n){const s=n.position,r=n.normal,i=e.mat3.create();e.mat3.normalFromMat4(i,t);const o=e.vec3.create();for(let n=0;n<s.length;n+=3)o[0]=s[n+0],o[1]=s[n+1],o[2]=s[n+2],e.vec3.transformMat4(o,o,t),s[n+0]=o[0],s[n+1]=o[1],s[n+2]=o[2],o[0]=r[n+0],o[1]=r[n+1],o[2]=r[n+2],e.vec3.transformMat3(o,o,i),r[n+0]=o[0],r[n+1]=o[1],r[n+2]=o[2];return n}function Ne(...t){const e=[],n=[],s=[],r=[],i=[];let o=0;for(const a of t)e.push(...a.position),n.push(...a.texcoord),s.push(...a.normal),i.push(...a.color),r.push(...a.indices.map((t=>t+o))),o+=a.position.length/3;return Me(e,n,s,r,i)}function Ie(t=!1){let e;if(t){const t=.5,n=.5;e=[0-t,0-n,0,0+t,0-n,0,0-t,0+n,0,0+t,0+n,0]}else e=[0,0,0,1,0,0,0,1,0,1,1,0];return Me(e,[0,0,1,0,0,1,1,1],[0,0,1,0,0,1,0,0,1,0,0,1],[0,1,2,2,1,3])}var ke=Object.freeze({__proto__:null,create:Ie});function Le(t=!0){const n=Ie(!0);if(t){const t=Ie(!0);return Te(e.mat4.fromYRotation(e.mat4.create(),Math.PI),t),Se(n.color[0],n.color[1],n.color[2],t),Ne(n,t)}return n}var Oe=Object.freeze({__proto__:null,create:Le});function Ce(t=!0,n=!0,s=!0,r=!0,i=!0,o=!0){const a=Math.PI/2,l=e.mat4.create(),h=[];if(t){const t=Le(!1);e.mat4.fromTranslation(l,[0,0,.5]),Te(l,t),h.push(t)}if(s){const t=Le(!1);e.mat4.fromXRotation(l,-a),e.mat4.translate(l,l,[0,0,.5]),Te(l,t),h.push(t)}if(n){const t=Le(!1);e.mat4.fromYRotation(l,Math.PI),e.mat4.translate(l,l,[0,0,.5]),Te(l,t),h.push(t)}if(r){const t=Le(!1);e.mat4.fromXRotation(l,a),e.mat4.translate(l,l,[0,0,.5]),Te(l,t),h.push(t)}if(i){const t=Le(!1);e.mat4.fromYRotation(l,-a),e.mat4.translate(l,l,[0,0,.5]),Te(l,t),h.push(t)}if(o){const t=Le(!1);e.mat4.fromYRotation(l,a),e.mat4.translate(l,l,[0,0,.5]),Te(l,t),h.push(t)}return Ne(...h)}var Pe=Object.freeze({__proto__:null,create:Ce});var Fe=Object.freeze({__proto__:null,create:function(){const t=.2,n=e.mat4.create(),s=Ce(!0,!0,!0,!0,!1,!0);e.mat4.fromTranslation(n,[.1,.4,0]),e.mat4.scale(n,n,[.4,t,t]),Te(n,s),Se(s.color[0],s.color[1],s.color[2],s);const r=Ce(!0,!0,!0,!0,!1,!0);e.mat4.fromScaling(n,[t,t,t]),Te(n,r),Se(s.color[0],s.color[1],s.color[2],r);const i=Ce(!0,!0,!0,!0,!0,!0);return e.mat4.fromTranslation(n,[-.2,0,0]),e.mat4.scale(n,n,[t,1,t]),Te(n,i),Se(s.color[0],s.color[1],s.color[2],i),Ne(i,s,r)}}),Re=Object.freeze({__proto__:null,Quad:ke,Plane:Oe,Cube:Pe,GlyphF:Fe,create:Me,applyColor:Se,applyTransformation:Te,joinGeometry:Ne});function je(t,e,n,s){if(!s){const e=Math.random(),n=Math.random(),r=Math.random();s=[];for(let i=0;i<t.length;i+=3)s.push(e,n,r)}return{position:t,texcoord:e,indices:n,color:s,elementSize:2,elementCount:n.length}}function Ue(t,n){const s=n.position,r=e.vec2.create();for(let n=0;n<s.length;n+=2)r[0]=s[n+0],r[1]=s[n+1],e.vec3.transformMat3(r,r,t),s[n+0]=r[0],s[n+1]=r[1];return n}function De(...t){const e=[],n=[],s=[],r=[];let i=0;for(const o of t){e.push(...o.position),n.push(...o.texcoord),r.push(...o.color);for(let t=0;t<o.indices.length;++t){const e=o.indices[t];s.push(e+i)}i+=o.position.length/2}return je(e,n,s,r)}function Be(t=!1){let e;if(t){const t=.5,n=.5;e=[0-t,0-n,0+t,0-n,0-t,0+n,0+t,0+n]}else e=[0,0,1,0,0,1,1,1];return je(e,[0,0,1,0,0,1,1,1],[0,1,2,2,1,3])}var ze=Object.freeze({__proto__:null,create:Be});var He=Object.freeze({__proto__:null,create:function(){const t=.2,n=e.mat3.create(),s=Be();e.mat3.fromTranslation(n,[.1,.4]),e.mat3.scale(n,n,[.4,t]),Ue(n,s),Se(s.color[0],s.color[1],s.color[2],s);const r=Be();e.mat3.fromScaling(n,[t,t]),Ue(n,r),Se(s.color[0],s.color[1],s.color[2],r);const i=Be();return e.mat3.fromTranslation(n,[-.2,0]),e.mat3.scale(n,n,[t,1]),Ue(n,i),Se(s.color[0],s.color[1],s.color[2],i),De(i,s,r)}}),We=Object.freeze({__proto__:null,Quad2D:ze,GlyphF2D:He,applyColor2D:Se,create:je,applyTransformation2D:Ue,joinGeometry2D:De});function Ve(t,e,n){const s=t.createShader(e);if(t.shaderSource(s,n),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(s);throw t.deleteShader(s),new Error(e)}return s}function $e(t,e,n,s=[]){const r=t.createProgram();t.attachShader(r,e),t.attachShader(r,n);for(let e=0;e<s.length;++e)t.bindAttribLocation(r,e,s[e]);if(t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS)){const e=t.getProgramInfoLog(r);throw t.deleteProgram(r),new Error(e)}return r}function qe(t,e){const n={},s=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let r=0;r<s;++r){const s=t.getActiveAttrib(e,r);if(!s)break;const i=s.name,o=t.getAttribLocation(e,i);n[i]=Ke(o)}return n}function Ke(t){const e=function(t,e,n){e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,n.handle),e.vertexAttribPointer(t,n.size,n.type,n.normalize,n.stride,n.offset)}.bind(null,t);return e.location=t,e}function Ye(t,e){const n={},s={textureUnit:0},r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<r;++i){const r=t.getActiveUniform(e,i);if(!r)break;let o=r.name;"[0]"===o.substring(o.length-3)&&(o=o.substring(0,o.length-3));const a=Ge(t,e,r,s);n[o]=a}return n}function Ge(t,e,n,s){const r=n.name,i=t.getUniformLocation(e,r),o=n.type,a=n.size>1&&"[0]"===r.substring(r.length-3),l=Qe(t,o);if(!l)throw new Error(`Unknown uniform type 0x${o.toString(16)}.`);switch(o){case t.FLOAT:case t.INT:case t.BOOL:return l.setter(i,a);case t.SAMPLER_2D:case t.SAMPLER_CUBE:{let t;if(a){t=[];for(let e=0;e<n.size;++e)t.push(s.textureUnit++)}else t=s.textureUnit++;return l.setter(i,a,t)}default:return l.setter(i)}}let Xe=null;function Qe(t,e){if(Xe)return Xe[e];function n(t,e,n=!1,s=0){if(n&&!Array.isArray(s))throw new Error("Cannot create sampler array for non-array texture unit.");const r=(n?function(t,e,n,s,r){s.uniform1fv(t,e),r.forEach(((t,r)=>{s.activeTexture(s.TEXTURE0+e[r]),s.bindTexture(n,t)}))}:function(t,e,n,s,r){s.uniform1i(t,e),s.activeTexture(s.TEXTURE0+e),s.bindTexture(n,r)}).bind(null,e,s,t);return r.location=e,r}return Xe={[t.FLOAT]:{TypedArray:Float32Array,size:4,setter(t,e=!1){const n=(e?function(t,e,n){e.uniform1fv(t,n)}:function(t,e,n){e.uniform1f(t,n)}).bind(null,t);return n.location=t,n}},[t.FLOAT_VEC2]:{TypedArray:Float32Array,size:8,setter(t){const e=function(t,e,n){e.uniform2fv(t,n)}.bind(null,t);return e.location=t,e}},[t.FLOAT_VEC3]:{TypedArray:Float32Array,size:12,setter(t){const e=function(t,e,n){e.uniform3fv(t,n)}.bind(null,t);return e.location=t,e}},[t.FLOAT_VEC4]:{TypedArray:Float32Array,size:16,setter(t){const e=function(t,e,n){e.uniform4fv(t,n)}.bind(null,t);return e.location=t,e}},[t.INT]:{TypedArray:Int32Array,size:4,setter(t,e=!1){const n=(e?function(t,e,n){e.uniform1iv(t,n)}:function(t,e,n){e.uniform1i(t,n)}).bind(null,t);return n.location=t,n}},[t.INT_VEC2]:{TypedArray:Int32Array,size:8,setter(t){const e=function(t,e,n){e.uniform2iv(t,n)}.bind(null,t);return e.location=t,e}},[t.INT_VEC3]:{TypedArray:Int32Array,size:12,setter(t){const e=function(t,e,n){e.uniform3iv(t,n)}.bind(null,t);return e.location=t,e}},[t.INT_VEC4]:{TypedArray:Int32Array,size:16,setter(t){const e=function(t,e,n){e.uniform4iv(t,n)}.bind(null,t);return e.location=t,e}},[t.BOOL]:{TypedArray:Uint32Array,size:4,setter(t,e=!1){const n=(e?function(t,e,n){e.uniform1iv(t,n)}:function(t,e,n){e.uniform1i(t,n)}).bind(null,t);return n.location=t,n}},[t.BOOL_VEC2]:{TypedArray:Uint32Array,size:8,setter(t){const e=function(t,e,n){e.uniform2iv(t,n)}.bind(null,t);return e.location=t,e}},[t.BOOL_VEC3]:{TypedArray:Uint32Array,size:12,setter(t){const e=function(t,e,n){e.uniform3iv(t,n)}.bind(null,t);return e.location=t,e}},[t.BOOL_VEC4]:{TypedArray:Uint32Array,size:16,setter(t){const e=function(t,e,n){e.uniform4iv(t,n)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT2]:{TypedArray:Float32Array,size:16,setter(t){const e=function(t,e,n){e.uniformMatrix2fv(t,!1,n)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT3]:{TypedArray:Float32Array,size:36,setter(t){const e=function(t,e,n){e.uniformMatrix3fv(t,!1,n)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT4]:{TypedArray:Float32Array,size:64,setter(t){const e=function(t,e,n){e.uniformMatrix4fv(t,!1,n)}.bind(null,t);return e.location=t,e}},[t.SAMPLER_2D]:{TypedArray:null,size:0,setter:n.bind(null,t.TEXTURE_2D)},[t.SAMPLER_CUBE]:{TypedArray:null,size:0,setter:n.bind(null,t.TEXTURE_CUBE)}},Xe[e]}function Je(t,e,n,s,r=!1,i=0,o=0,a=t.ARRAY_BUFFER,l=t.STATIC_DRAW){const h=t.createBuffer(),u=tn(t,e);if(!u)throw new Error(`Unknown uniform type 0x${e.toString(16)}.`);if(n instanceof u.TypedArray)t.bindBuffer(a,h),t.bufferData(a,n,l);else if(Array.isArray(n))n=new u.TypedArray(n),t.bindBuffer(a,h),t.bufferData(a,n,l);else{if("number"!=typeof n)throw new Error("Unknown buffer data type - can only be a TypedArray, an Array, or a number.");t.bindBuffer(a,h),t.bufferData(a,n,l)}return{handle:h,size:s,type:e,normalize:r,stride:i,offset:o,updateData(t,n,s=0,r=t.STATIC_DRAW){t.bindBuffer(t.ARRAY_BUFFER,this.handle);const i=tn(t,e);n instanceof i.TypedArray||(n=new i.TypedArray(n)),s>0?t.bufferSubData(t.ARRAY_BUFFER,s,n):t.bufferData(t.ARRAY_BUFFER,n,r)}}}let Ze=null;function tn(t,e){return Ze||(Ze={[t.BYTE]:{TypedArray:Int8Array,size:1},[t.SHORT]:{TypedArray:Int16Array,size:2},[t.UNSIGNED_BYTE]:{TypedArray:Uint8Array,size:1},[t.UNSIGNED_SHORT]:{TypedArray:Uint16Array,size:2},[t.FLOAT]:{TypedArray:Float32Array,size:4}}),Ze[e]}var en=Object.freeze({__proto__:null,SceneGraph:class{constructor(){this.root=this.createSceneNode(xe(),null)}update(){this.root.updateWorldMatrix()}createSceneNode(t=xe(),n=this.root){const s={sceneGraph:this,transform:t,localMatrix:e.mat4.create(),worldMatrix:e.mat4.create(),parent:null,children:[],setParent(t){if(this.parent){const t=this.parent.children.indexOf(this);this.parent.children.splice(t,1)}return t&&t.children.push(this),this.parent=n,this},updateWorldMatrix(t){Ee(this.transform,this.localMatrix),t?e.mat4.multiply(this.worldMatrix,t,this.localMatrix):e.mat4.copy(this.worldMatrix,this.localMatrix);for(const t of this.children)t.updateWorldMatrix(this.worldMatrix)}};return n&&s.setParent(n),s}},Transform:Ae,Geometry:Re,Geometry2D:We,createShaderProgramInfo:function(t,e,n,s=[]){const r=Ve(t,t.VERTEX_SHADER,e),i=Ve(t,t.FRAGMENT_SHADER,n),o=$e(t,r,i,s);return t.detachShader(o,r),t.detachShader(o,i),t.deleteShader(r),t.deleteShader(i),{handle:o,_gl:t,uniforms:Ye(t,o),attributes:qe(t,o),uniform(t,e){return t in this.uniforms&&this.uniforms[t](this._gl,e),this},attribute(t,e){return t in this.attributes&&this.attributes[t](this._gl,e),this},elementAttribute(t){return this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t),this}}},createShader:Ve,createShaderProgram:$e,createShaderProgramAttributeSetters:qe,createShaderProgramAttributeSetter:Ke,createShaderProgramUniformSetters:Ye,createShaderProgramUniformSetter:Ge,getUniformTypeInfo:Qe,createBufferInfo:Je,createElementBufferInfo:function(t,e,n,s=0,r=0,i=t.STATIC_DRAW){return Je(t,e,n,1,!1,s,r,t.ELEMENT_ARRAY_BUFFER,i)},getBufferTypeInfo:tn,createVertexArrayInfo:function(t,e=[]){const n=t.createVertexArray(),s={};for(let t=0;t<e.length;++t)s[e[t]]={location:t,setter:Ke(t)};return{handle:n,attributes:s,_gl:t,elementBuffer:null,elementType:null,elementCount:0,attributeBuffers:{},setElementCount(t){return this.elementCount=t,this},elementAttribute(t){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t.handle);const e=tn(this._gl,t.type);return this.elementCount=this._gl.getBufferParameter(this._gl.ELEMENT_ARRAY_BUFFER,this._gl.BUFFER_SIZE)/e.size,this.elementBuffer=t,this.elementType=t.type,this},sharedAttribute(t,e){return t in this.attributes&&this.attributes[t].setter(this._gl,e),this.attributeBuffers[t]=e,this},programAttribute(t,e,...n){for(const s of n)s.attribute(t,e);return this.attributeBuffers[t]=e,this}}},createTextureInfo:function(t){return{handle:t.createTexture()}},createDrawInfo:function(t,e,n,s=0,r=null){return{programInfo:t,vertexArrayInfo:e,uniforms:n,drawArrayOffset:s,drawMode:r}},draw:function(t,e,n={}){for(const s of e){const e=s.programInfo,r=s.vertexArrayInfo,i=s.uniforms,o=s.drawArrayOffset,a=s.drawMode||t.TRIANGLES;t.useProgram(e.handle),t.bindVertexArray(r.handle);for(const[t,s]of Object.entries(n))e.uniform(t,s);for(const[t,n]of Object.entries(i))e.uniform(t,n);r.elementBuffer?t.drawElements(a,r.elementCount,r.elementType,o*r.elementBuffer.size):t.drawArrays(a,o,r.elementCount)}}});class nn{getViewMatrix(t){}getProjectionMatrix(t){}}class sn extends nn{constructor(t=-1,n=1,s=-1,r=1,i=0,o=1){super(),this.position=e.vec3.create(),this.rotation=e.quat.create(),this.scale=e.vec3.fromValues(1,1,1),this.clippingPlane={left:t,right:n,top:s,bottom:r,near:i,far:o}}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,n,s=0,r=1){let i=e.vec3.fromValues(t,n,s);return e.vec3.lerp(this.position,this.position,i,Math.max(Math.min(r,1),0)),this}getViewMatrix(t){let n=-Math.round(this.x),s=-Math.round(this.y),r=0===this.z?1:1/this.z,i=e.vec3.fromValues(n,s,0),o=e.vec3.fromValues(this.scale[0]*r,this.scale[1]*r,1);return e.mat4.fromRotationTranslationScale(t,this.rotation,i,o),t}getProjectionMatrix(t){let{left:n,right:s,top:r,bottom:i,near:o,far:a}=this.clippingPlane;return e.mat4.ortho(t,n,s,r,i,o,a),t}}function rn(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}var on=Object.freeze({__proto__:null,CanvasView2D:class{constructor(t,e=new sn){this.display=t,this.camera=e,this.viewTransformDOMMatrix=new DOMMatrix}transformScreenToWorld(t,n){let s=e.mat4.create();this.getViewProjectionMatrix(s),e.mat4.invert(s,s);let r=e.vec3.fromValues(t,n,0);return e.vec3.transformMat4(r,r,s),r}transformCanvas(t){let n=this.viewTransformDOMMatrix,s=e.mat4.create();this.getViewProjectionMatrix(s),rn(n,s);const{a:r,b:i,c:o,d:a,e:l,f:h}=n;t.transform(r,i,o,a,l,h)}getViewProjectionMatrix(t){const n=this.display.width,s=this.display.height;let r=e.mat4.create();const i=this.camera.getProjectionMatrix(r),o=this.camera.getViewMatrix(t);e.mat4.multiply(r,o,i);const a=e.mat4.fromTranslation(t,[n/2,s/2,0]);return e.mat4.multiply(t,a,r),t}},setDOMMatrix:rn,Camera:nn,Camera2D:sn,Camera3D:class extends nn{static screenToWorld(t,n,s,r){let i=e.mat4.multiply(e.mat4.create(),r,s);e.mat4.invert(i,i);let o=e.vec3.fromValues(t,n,0);return e.vec3.transformMat4(o,o,i),o}constructor(t,n,s=.1,r=1e3){super(),this.position=e.vec3.create(),this.rotation=e.quat.create(),this.fieldOfView=t,this.aspectRatio=n,this.clippingPlane={near:s,far:r},this._viewMatrix=e.mat4.create(),this._projectionMatrix=e.mat4.create()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,n,s,r=1){let i=e.vec3.fromValues(t,n,s);e.vec3.lerp(this.position,this.position,i,Math.min(1,r))}getViewMatrix(t=this._viewMatrix){let n=-this.x,s=-this.y,r=-this.z,i=e.vec3.fromValues(n,s,r);return e.mat4.fromRotationTranslation(t,this.rotation,i),t}getProjectionMatrix(t=this._projectionMatrix){let{near:n,far:s}=this.clippingPlane;return e.mat4.perspective(t,this.fieldOfView,this.aspectRatio,n,s),t}}});t.AdapterManager=l,t.ApplicationLoop=Xt,t.AssetLoader=Ot,t.Audio=Gt,t.Axis=c,t.AxisAlignedBoundingBox=ce,t.AxisAlignedBoundingBoxGraph=class{constructor(t={}){this.masks=new Map,this.boxes=new Set,this.dynamics=new Map,this.quadtree=new ae}add(t,e,n={}){let s=function(t,e,n,s){return{owner:t,name:e,box:n,get:s}}(t,e,null,null);if(this.masks.has(t)){if(e in this.masks.get(t))throw new Error(`Mask ${e} already exists for owner.`);{let n=this.masks.get(t);n[e]=s,n[ue]++}}else this.masks.set(t,{[ue]:1,[e]:s});if(Array.isArray(n)){const t=n[0]||0,e=n[1]||0,r=n[2]/2||0,i=n[3]/2||0;let o=new ce(this,s,t,e,r,i);this.boxes.add(o),s.box=o}else if("object"==typeof n){let e=n.x||0,r=n.y||0,i=n.rx||n.width/2||0,o=n.ry||n.height/2||0;"object"==typeof t&&(e||(e=t.x||0),r||(r=t.y||0),i||(i=t.width/2||0),o||(o=t.height/2||0));let a=new ce(this,s,e,r,i,o);this.boxes.add(a),s.box=a,"get"in n&&(s.get=n.get,s.get(a,t),this.dynamics.set(s,{halfdx:0,halfdy:0}))}else{if("function"!=typeof n)throw new Error("Invalid mask option type.");{let e=new ce(this,s,0,0,0,0);this.boxes.add(e),s.box=e,s.get=n,s.get(e,t),this.dynamics.set(s,{halfdx:0,halfdy:0})}}}remove(t,e){if(this.masks.has(t)){let n=this.masks.get(t),s=n[e];if(s){return s.get&&this.dynamics.delete(s),this.boxes.delete(s.box),n[e]=null,--n[ue]<=0&&this.masks.delete(t),!0}return!1}return!1}get(t,e){return this.masks.has(t)?this.masks.get(t)[e]:null}count(t){return this.masks.has(t)?this.masks.get(t)[ue]:0}clear(){this.boxes.clear(),this.masks.clear(),this.dynamics.clear(),this.quadtree.clear()}solve(t){for(let t of this.dynamics.keys()){let{box:e,owner:n}=t,s=e.x,r=e.y;t.get(e,n);let i=this.dynamics.get(t),o=(e.x-s)/2,a=(e.y-r)/2;i.halfMotionX=o,i.halfMotionY=a,e.x-=o,e.y-=a,e.rx+=Math.abs(o),e.ry+=Math.abs(a)}null==t&&(t=this.masks.keys());let e=[],n=this.quadtree;n.clear(),n.insertAll(this.boxes);for(let t of this.dynamics.keys()){const{box:e}=t,{halfMotionX:n,halfMotionY:s}=this.dynamics.get(t);e.x+=n,e.y+=s,e.rx-=Math.abs(n),e.ry-=Math.abs(s)}let s=[];for(let r of t){let t=Object.values(this.masks.get(r));for(let i of t){const{box:t}=i;n.retrieve(t,s);let o=0,a=0;if(this.dynamics.has(i)){const{halfMotionX:t,halfMotionY:e}=this.dynamics.get(i);o=2*t,a=2*e}for(let n of s){let s=he(t,n);s&&e.push({owner:r,other:n.mask.owner,ownerMask:i,otherMask:n.mask,hit:s,dx:o,dy:a})}s.length=0}}return e}},t.BoxRenderer=class{static get Info(){return ne}static draw(t,e,n){const s=n?{...ee,...n}:ee;for(let n of e){const e=n[ne],r=se("x",e,n,s),i=se("y",e,n,s),o=se("width",e,n,s),a=se("height",e,n,s),l=se("color",e,n,s),h=se("solid",e,n,s);t.translate(r,i);{const e=o/2,n=a/2;h?(t.fillStyle=l,t.fillRect(-e,-n,o,a)):(t.strokeStyle=l,t.strokeRect(-e,-n,o,a))}t.translate(-r,-i)}}},t.Button=d,t.ByteLoader=wt,t.Discrete=j,t.DisplayPort=s,t.Downloader=z,t.EntityManager=class{constructor(t={}){const{componentFactoryMap:e={},strictMode:n=!1}=t;let s={},r={};for(let t in e){let n,i,o=e[t];try{n="create"in o?o.create:"function"==typeof o?o:null,i="destroy"in o?o.destroy:null}catch(t){throw new Error("Unsupported component factory options.")}s[t]={owner:o,create:n,destroy:i},r[t]={}}this.factoryMap=s,this.instances=r,this.entities=new Set,this.nextAvailableEntityId=1,this.strictMode=n}create(t){if(void 0!==t){if("string"!=typeof t)throw new Error("Invalid type for entity id - must be a string.")}else t=String(this.nextAvailableEntityId++);if(this.entities.has(t))throw new Error(`Invalid duplicate entity id '${t}' allocated for new entity.`);return this.entities.add(t),t}destroy(t){for(let e in this.instances)this.remove(e,t);this.entities.delete(t)}add(t,e,n){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);this.factoryMap[t]={owner:{},create:null,destroy:null},this.instances[t]={}}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);if(!this.entities.has(e))throw new Error(`Entity '${e}' does not exist.`);if(this.instances[t][e])throw new Error(`Entity already has component '${t}'.`);const{create:s}=this.factoryMap[t];let r=s?s(void 0!==n?n:de,e,this):n?{...n}:{};r&&(this.instances[t][e]=r)}remove(t,e){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);return}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);let n=this.instances[t],s=n[e];if(s){n[e]=null;const{destroy:r}=this.factoryMap[t];r&&r(s,e,this)}}get(t,e){if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);return this.instances[t][e]||null}has(t,e){return t in this.instances&&Boolean(this.instances[t][e])}clear(t){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);return}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);let e=this.instances[t];const{destroy:n}=this.factoryMap[t];if(n)for(let s in e){let r=e[s];e[s]=null,n(r,t,s,this)}this.instances[t]={}}getEntityIds(){return this.entities}getComponentFactory(t){return t in this.factoryMap?this.factoryMap[t].owner:null}getComponentNames(){return Object.keys(this.factoryMap)}getComponentEntityIds(t){return t in this.instances?Object.keys(this.instances[t]):[]}getComponentInstances(t){return t in this.instances?Object.values(this.instances[t]):[]}},t.Eventable=at,t.Game=te,t.ImageLoader=bt,t.Input=u,t.InputContext=v,t.InputDevice=a,t.InputEventCode=i,t.InputKeyElement=A,t.InputMapElement=M,t.InputPort=C,t.InputSource=k,t.InputSourceElement=O,t.InputSourceEventStage=p,t.InputSourceState=f,t.InputType=r,t.IntersectionHelper=zt,t.IntersectionResolver=Vt,t.IntersectionWorld=$t,t.JSONLoader=Et,t.KEY_STRING_DEVICE_SEPARATOR=y,t.Keyboard=x,t.Logger=et,t.Mogli=en,t.Mouse=E,t.OBJLoader=Tt,t.PriorityQueue=lt,t.QuadTree=ae,t.Random=R,t.RandomGenerator=P,t.SceneGraph=class{constructor(t={}){this.nodeConstructor=t.nodeConstructor||be,this.nodes=new Map,this.rootNodes=[]}add(t,e=null){if(null===t)throw new Error("Cannot add null as child to scene graph.");if(null===e||this.nodes.has(e)){let n=null===e?null:this.nodes.get(e);if(this.nodes.has(t)){let e=this.nodes.get(t);return fe(e.parentNode,e,this),pe(n,e,this),e}{let e=new this.nodeConstructor(this,t,null,[]);return this.nodes.set(t,e),pe(n,e,this),e}}throw new Error("No node in scene graph exists for parent.")}remove(t){if(null===t)return this.clear(),!0;if(this.nodes.has(t)){let e=this.nodes.get(t);return fe(e.parentNode,e,this),me(this,e,0,(t=>{this.nodes.delete(t)})),!0}return!1}replace(t,e){if(null===t)throw new Error("Cannot replace null for child in scene graph.");if(this.nodes.has(t)){let n=this.nodes.get(t),s=n.parentNode,r=[...n.childNodes];if(fe(s,n,this),n.childNodes.length=0,null===e)null===s?this.rootNodes.push(...r):s.childNodes.push(...r);else{let t;this.nodes.has(e)?(t=this.nodes.get(e),fe(t.parentNode,t,this),t.childNodes.push(...r)):(t=new this.nodeConstructor(this,e,null,r),this.nodes.set(e,t)),pe(s,t,this)}for(let t of r)t.parentNode=s;return e}if(null===t)return this.replace(this.root.owner,e);throw new Error("Cannot find target object to replace in scene graph.")}clear(){this.nodes.clear(),this.rootNodes.length=0}get(t){return this.nodes.get(t)}walk(t,e,n={}){const{childrenOnly:s=!0,childrenCallback:r}=n;if(null===t){ye(this.nodes,this.rootNodes,null,r);for(let t of this.rootNodes)me(this,t,0,e,r)}else{const n=this.get(t);if(n)throw new Error("No node in scene graph exists for walk start.");if(s){ye(this.nodes,n.childNodes,n,r);for(let t of n.childNodes)me(this,t,0,e,r)}else me(this,n,0,e,r)}}},t.SceneNode=be,t.SimpleRandomGenerator=class extends P{constructor(t=0){super(),this._seed=Math.abs(t%2147483647),this._next=this._seed}next(){return this._next=Math.abs(16807*this._next%2147483647-1),this._next/2147483646}get seed(){return this._seed}set seed(t){this._seed=Math.abs(t%2147483647),this._next=this._seed}},t.SpriteRenderer=class{static get Info(){return ie}static draw(t,e,n){const s=n?{...re,...n}:re;for(let n of e){const e=n[ie],r=oe("x",e,n,s),i=oe("y",e,n,s),o=oe("spriteImage",e,n,s);if(o){const e=o.width,n=o.height;t.translate(r,i);{const s=e/2,r=n/2;t.drawImage(o,-s,-r)}t.translate(-r,-i)}else{const e=10,n=10;t.translate(r,i);{const s=e/2,r=n/2;t.strokeStyle="black",t.strokeRect(-s,-r,e,n),t.textAlign="center",t.textBaseline="middle",t.strokeText("?",0,0,e)}t.translate(-r,-i)}}}},t.Synthetic=b,t.TextLoader=vt,t.Uploader=H,t.View=on,t.WILDCARD_DEVICE_MATCHER="*",t.WILDCARD_KEY_MATCHER=o,t.clamp=ct,t.cycle=dt,t.direction2=function(t,e,n,s){let r=n-t,i=s-e;return Math.atan2(i,r)},t.distance2=function(t,e,n,s){let r=n-t,i=s-e;return Math.sqrt(r*r+i*i)},t.lerp=function(t,e,n){return t+(e-t)*n},t.lookAt2=function(t,e,n){return ct(t+dt(e-t,-Math.PI,Math.PI),t-n,t+n)},t.parseKeyString=g,t.stringifyDeviceKeyCodePair=function(t,e){return`${t}:${e}`},t.testAxisAlignedBoundingBox=function(t,e){return!(Math.abs(t.x-e.x)>t.rx+e.rx||Math.abs(t.y-e.y)>t.ry+e.ry)},t.toDegrees=function(t){return t*ft},t.toRadians=function(t){return t*pt},t.topoSort=function(t,e){let n=[];for(let s of t){let t=e(s);if(Array.isArray(t))n.push([s,...t]);else if(t)throw new Error("Dependency callback must return an array.")}return function(t,e,n=[]){let s=new Map;for(let t of e)if(t.length>1){let e=t[0],n=t[1];s.has(e)||s.set(e,new Set),s.has(n)||s.set(n,new Set),s.get(e).add(n)}let r={edgeMap:s,index:t.length,visited:new Set,dst:n};for(let e of t)mt(r,e,new Set);return n}(function(t){let e=new Set;for(let n of t)for(let t of n)e.add(t);return Array.from(e)}(n),function(t){let e=[];for(let n of t){let t=n[0];for(let s=1;s<n.length;++s){let r=n[s];e.push([t,r])}}return e}(n))},t.uuid=function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)},t.withinRadius=function(t,e,n,s,r){const i=t-n,o=e-s;return i*i+o*o<=r*r},Object.defineProperty(t,"__esModule",{value:!0})}));
