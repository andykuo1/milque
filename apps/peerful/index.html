<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PeerMem - Attempt 3</title>

    <style>
        html, body {
            margin: 0;
        }
        *:disabled {
            opacity: 0.3;
        }
        dialog {
            background-color: white;
            color: black;
        }
    </style>

    <script type="module" src="./PeerHandshake.js"></script>
</head>
<body>
    <peer-handshake></peer-handshake>
    <button onclick="document.querySelector('peer-handshake').open = true">Open</button>
    <section id="players">
    </section>
    <template id="player">
        <fieldset>
            <legend>Player</legend>
            <p style="border: 1px solid gray">
                <output></output>
            </p>
            <p style="display: flex;">
                <input type="text" style="flex: 1;">
                <button>Send</button>
            </p>
        </fieldset>
    </template>
    <script type="module">
        import { uuid } from '../../packages/util/src/uuidv4.js';

        let players = [];

        function createPlayer(handshake)
        {
            const playerContainer = document.querySelector('#players');
            const playerTemplate = document.querySelector('#player');

            let player = playerTemplate.content.cloneNode(true);
            const title = player.querySelector('legend');
            const output = player.querySelector('output');
            const input = player.querySelector('input');
            const send = player.querySelector('button');

            player.playerId = null;
            player.connection = handshake.connection;
            player.channels = handshake.channels;
            player.onOpen = () => {
                if (!handshake.remote)
                {
                    let playerId = uuid();
                    player.playerId = playerId;
                    title.textContent = playerId;
                    player.channels.reliable.send('pid:' + playerId);
                }
            };
            player.onClose = () => {
                console.log('Closed.');
            };
            player.onSend = () => {
                player.channels.data.send('msg:' + input.value);
                input.value = '';
            };
            player.onReceive = e => {
                let type = e.data.substring(0, 3);
                let data = e.data.substring(4);
                switch(type)
                {
                    case 'msg':
                        output.value = data;
                        break;
                    case 'pid':
                        player.playerId = data;
                        title.textContent = data;
                        break;
                    default:
                        console.log(type, '=>', data);
                }
            };
            send.addEventListener('click', player.onSend);
            player.channels.data.addEventListener('message', player.onReceive);
            player.channels.reliable.addEventListener('open', player.onOpen);
            player.channels.reliable.addEventListener('close', player.onClose);
            player.channels.reliable.addEventListener('message', player.onReceive);
            playerContainer.appendChild(player);
            players.push(player);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const peerHandshake = document.querySelector('peer-handshake');
            
            peerHandshake.addEventListener('complete', e => {
                let handshake = e.detail.handshake;
                createPlayer(handshake);
            });
        });
    </script>
</body>

</html>