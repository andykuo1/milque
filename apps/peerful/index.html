<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PeerMem - Attempt 3</title>

    <style>
        html, body {
            margin: 0;
        }
        *:disabled {
            opacity: 0.3;
        }
        dialog {
            background-color: white;
            color: black;
        }
    </style>

    <script type="module" src="./PeerHandshake.js"></script>
</head>
<body>
    <peer-handshake></peer-handshake>
    <button onclick="document.querySelector('peer-handshake').open = true">Open</button>
    <section id="players">
    </section>
    <template id="player">
        <fieldset>
            <legend>Player</legend>
            <p style="border: 1px solid gray">
                <canvas width="64" height="64"></canvas>
                <output></output>
            </p>
            <p style="display: flex;">
                <input type="text" style="flex: 1;">
                <button>Send</button>
            </p>
        </fieldset>
    </template>
    <script type="module">
        import { uuid } from '../../packages/util/src/uuidv4.js';

        let players = [];

        function createPlayer(handshake)
        {
            const playerContainer = document.querySelector('#players');
            const playerTemplate = document.querySelector('#player');

            let player = playerTemplate.content.cloneNode(true);
            const title = player.querySelector('legend');
            const output = player.querySelector('output');
            const input = player.querySelector('input');
            const send = player.querySelector('button');
            const canvas = player.querySelector('canvas');
            const context = canvas.getContext('2d');

            player.playerId = null;
            player.connection = handshake.connection;
            player.channels = handshake.channels;
            player.onOpen = function() {
                if (!handshake.remote)
                {
                    let playerId = uuid();
                    this.playerId = playerId;
                    title.textContent = playerId;
                    this.channels.reliable.send('pid:' + playerId);
                }
            }.bind(player);
            player.onClose = function() {
                console.log('Closed.');
            }.bind(player);
            player.onSend = function() {
                this.channels.data.send('msg:' + input.value);
                input.value = '';
            }.bind(player);
            player.onReceive = function(e) {
                let type = e.data.substring(0, 3);
                let data = e.data.substring(4);
                switch(type)
                {
                    case 'msg':
                        output.value = data;
                        break;
                    case 'pid':
                        this.playerId = data;
                        title.textContent = data;
                        break;
                    case 'pos':
                        let i = data.indexOf(',');
                        this.x = Number.parseFloat(data.substring(0, i));
                        this.y = Number.parseFloat(data.substring(i + 1));
                        break;
                    default:
                        console.log(type, '=>', data);
                }
            }.bind(player);
            player.onAnimationFrame = function(now) {
                requestAnimationFrame(this.onAnimationFrame);

                let ctx = context;
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);

                let x = ctx.canvas.clientWidth * this.x;
                let y = ctx.canvas.clientHeight * this.y;

                ctx.fillStyle = 'white';
                ctx.fillRect(x, y, 4, 4);

            }.bind(player);
            player.channels.data.addEventListener('message', player.onReceive);
            player.channels.reliable.addEventListener('open', player.onOpen);
            player.channels.reliable.addEventListener('close', player.onClose);
            player.channels.reliable.addEventListener('message', player.onReceive);

            send.addEventListener('click', player.onSend);
            player.onAnimationFrame(performance.now());

            document.addEventListener('mousemove', e => {
                const { clientX, clientY } = e;

                let x = clientX / window.innerWidth;
                let y = clientY / window.innerHeight;
                player.channels.data.send('pos:' + x + ',' + y);
            });

            playerContainer.appendChild(player);
            players.push(player);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const peerHandshake = document.querySelector('peer-handshake');
            
            peerHandshake.addEventListener('complete', e => {
                let handshake = e.detail.handshake;
                createPlayer(handshake);
            });
        });
    </script>
</body>

</html>