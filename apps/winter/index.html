<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">

        <title>Winter</title>

        <script type="module" src="../../packages/display/src/index.js"></script>
    </head>
    <body>
        <display-port contexttype="2d"></display-port>

        <script type="module">
            import { KeyMapBuilder, createKeyState, createDeviceMap } from './InputHelper.js';

            window.addEventListener('DOMContentLoaded', () => {
                const display = document.querySelector('display-port');
                
                // This is what the user sees and can edit.
                const keyMap = KeyMapBuilder()
                    .set('up', 'ArrowUp')
                    .set('down', 'ArrowDown')
                    .set('left', 'ArrowLeft')
                    .set('right', 'ArrowRight')
                    .build();
                const deviceMap = createDeviceMap(display);
                const keyState = createKeyState(deviceMap, keyMap);

                // input.getContextualInputState('playerControls');
                // Easy to access, fast, and serializable
                const playerControls = {
                    get down() { return keyState.state.down.value; },
                    get up() { return keyState.state.up.value; },
                    get left() { return keyState.state.left.value; },
                    get right() { return keyState.state.right.value; },
                };

                const world = {
                    entities: [],
                    update(dt)
                    {
                        for(let entity of this.entities)
                        {
                            entity.update(dt);
                        }
                    },
                    render(ctx)
                    {
                        ctx.fillStyle = 'black';
                        ctx.fillRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);

                        for(let entity of this.entities)
                        {
                            entity.render(ctx);
                        }
                    },
                    poll()
                    {
                        keyState.poll();
                    }
                };

                display.addEventListener('frame', e => {
                    const ctx = e.detail.context;
                    const dt = e.detail.delta;

                    if (world.poll) world.poll();
                    if (world.update) world.update(dt);
                    if (world.render) world.render(ctx);
                });

                main();

                function main()
                {
                    world.entities = [
                        Player()
                    ];
                }

                function Player()
                {
                    return {
                        x: 0,
                        y: 0,
                        update(dt)
                        {
                            if (playerControls.down) {
                                this.y += 1;
                            }
                            if (playerControls.up) {
                                this.y -= 1;
                            }
                            if (playerControls.left) {
                                this.x -= 1;
                            }
                            if (playerControls.right) {
                                this.x += 1;
                            }
                        },
                        render(ctx)
                        {
                            ctx.fillStyle = 'white';
                            ctx.fillRect(this.x, this.y, 16, 16);
                        }
                    };
                }
            });
        </script>
    </body>
</html>