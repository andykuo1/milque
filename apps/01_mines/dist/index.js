!function(){"use strict";const t="noscale";class e extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <canvas></canvas>\n    <slot></slot>\n</div>',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block;color:#555}.container{display:flex;position:relative;width:100%;height:100%}canvas{background:#000;margin:auto;-ms-interpolation-mode:nearest-neighbor;image-rendering:-moz-crisp-edges;image-rendering:pixelated}label{font-family:monospace;color:currentColor;position:absolute}#title{left:.5rem;top:.5rem}#fps{right:.5rem;top:.5rem}#dimension{left:.5rem;bottom:.5rem}.hidden{display:none}:host([debug]) .container{outline:6px dashed rgba(0,0,0,.1);outline-offset:-4px;background-color:rgba(0,0,0,.1)}:host([mode=noscale]) canvas{margin:0;top:0;left:0}:host([mode=center]),:host([mode=fit]),:host([mode=stretch]){width:100%;height:100%}:host([full]){width:100vw!important;height:100vh!important}:host([disabled]){display:none}slot{display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}::slotted(*){pointer-events:auto}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{width:Number,height:Number,disabled:Boolean,debug:Boolean,mode:{type:String,value:"fit",observed:!1}}}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get height(){return this._height}set height(t){this.setAttribute("height",String(t))}get width(){return this._width}set width(t){this.setAttribute("width",String(t))}static get customEvents(){return["frame"]}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}static get observedAttributes(){return["onframe","width","height","disabled","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this._onframe=null,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onframe")){let t=this.onframe;delete this.onframe,this.onframe=t}if(Object.prototype.hasOwnProperty.call(this,"width")){let t=this.width;delete this.width,this.width=t}if(Object.prototype.hasOwnProperty.call(this,"height")){let t=this.height;delete this.height,this.height=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}if(Object.prototype.hasOwnProperty.call(this,"mode")){let t=this.mode;delete this.mode,this.mode=t}this.hasAttribute("mode")||this.setAttribute("mode","fit"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,i){switch(t){case"width":this._width=Number(i);break;case"height":this._height=Number(i);break;case"disabled":this._disabled=null!==i;break;case"debug":this._debug=null!==i;break;case"onframe":this.onframe=new Function("event","with(document){with(this){"+i+"}}").bind(this)}((t,e,i)=>{switch(t){case"disabled":i?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",i),this._fpsElement.classList.toggle("hidden",i),this._dimensionElement.classList.toggle("hidden",i)}})(t,0,i)}update(e){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const i=e-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=e,this.debug){const e=i<=0?"--":String(Math.round(1e3/i)).padStart(2,"0");if(this._fpsElement.innerText!==e&&(this._fpsElement.innerText=e),this.mode===t){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:e,prevTime:this._prevAnimationFrameTime,deltaTime:i,canvas:this._canvasElement},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}updateCanvasSize(){let e=this.shadowRoot.host.getBoundingClientRect();const i=e.width,s=e.height;let n=this._canvasElement,o=this._width,r=this._height;const l=this.mode;if("stretch"===l)o=i,r=s;else if(l!==t){if(i<o||s<r||"fit"===l){let t=i/o,e=s/r;t<e?(o=i,r*=t):(o*=e,r=s)}}o=Math.floor(o),r=Math.floor(r),n.clientWidth===o&&n.clientHeight===r||(n.width=this._width,n.height=this._height,n.style=`width: ${o}px; height: ${r}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:o,height:r},bubbles:!1,composed:!0})))}}function i(t,e,i){return Math.min(i,Math.max(e,t))}window.customElements.define("display-port",e);class s{next(){return Math.random()}}let n;class o{constructor(t=new s){this.generator=t}static next(){return n.next()}next(){return this.generator.next()}static choose(t){return n.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return n.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static sign(){return n.sign()}sign(){return this.generator.next()<.5?-1:1}}n=new o;class r{constructor(t,e,i=new o){this.width=t,this.height=e,this.length=t*e,this.rand=i,this.dangerCount=.2*this.length,this.data={tiles:new Array(length),overlay:new Array(length),regions:new Array(length),solids:new Array(length),marks:new Array(length)},l(this,this.dangerCount,this.rand)}dig(t,e){const i=this.width,s=this.height;let n=this.data,o=t+e*i;if(n.solids[o]<=0)return!0;if(n.marks[o]>0)return!0;if(n.tiles[o]>0)return n.solids[o]=0,!1;let r=new Set,l=[];for(l.push(o);l.length>0;){let t=l.pop();r.add(t);let e=t%i,o=Math.floor(t/i);if(n.solids[t]=0,n.overlay[t]<=0){let t=h(e,o,i,s);for(let e of t)!r.has(e)&&n.marks[e]<=0&&l.push(e)}}return!0}mark(t,e){const i=this.width;let s=this.data,n=t+e*i;return!(s.solids[n]<=0)&&(s.marks[n]>0?s.marks[n]=0:s.marks[n]=1,!0)}checkWinCondition(){const t=this.data;for(let e=0;e<t.tiles.length;++e)if(t.solids[e]>0&&t.tiles[e]<=0)return!1;return!0}reset(){l(this,this.dangerCount,this.rand)}clear(){let t=this.data;for(let e=0;e<this.length;++e)t.tiles[e]=0,t.overlay[e]=0,t.solids[e]=1,t.regions[e]=0,t.marks[e]=0}}function l(t,e,i){t.clear();const s=t.width,n=t.height,o=t.rand;let r=t.data;for(let t=0;t<e;++t){let e=Math.floor(i.range(0,s)),o=Math.floor(i.range(0,n)),l=e+o*s,a=1;if(0===r.tiles[l]){r.tiles[l]+=a,r.overlay[l]=1/0;for(let t of h(e,o,s,n))r.overlay[t]+=a}else--t}const l=Array.from(function(t,e,i,s){const n=t.tiles.length;let o=new Map,r=new Map,l=1;for(let h=0;h<n;++h)if(s(h))t.regions[h]=-1;else{let n=a(t,e,i,h,l++,s);if(n){if(r.has(n.tileIndex)){const t=r.get(n.tileIndex);o.delete(t),r.delete(n.tileIndex)}r.set(n.tileIndex,n.regionIndex),o.set(n.regionIndex,n)}}return o}(r,s,n,(t=>r.overlay[t]>0)).values()).sort(((t,e)=>t.count-e.count)),d=[[l[0]]];let u=0;for(let t of l)d[u][0].count!==t.count?d[++u]=[t]:d[u].push(t);let c=d[Math.floor(d.length/2)],p=o.choose(c).tileIndex,m=p%s,f=Math.floor(p/s);t.dig(m,f)}function a(t,e,i,s,n,o){let r=1/0,l=new Set,a=[];for(a.push(s);a.length>0;){let s=a.pop();if(o(s))continue;l.add(s);let d=s%e,u=Math.floor(s/e);t.regions[s]=n,s<r&&(r=s);let c=h(d,u,e,i);for(let t of c)l.has(t)||a.push(t)}return r<1/0?{tileIndex:r,regionIndex:n,count:l.size}:null}function h(t,e,i,s){let n=[],o=t+e*i;return t>0&&n.push(o-1),t<i-1&&n.push(o+1),e>0&&n.push(o-i),e<s-1&&n.push(o+i),t>0&&e>0&&n.push(o-1-i),t<i-1&&e>0&&n.push(o+1-i),t>0&&e<s-1&&n.push(o-1+i),t<i-1&&e<s-1&&n.push(o+1+i),n}const d=1,u=2,c=3,p={NULL:0,DOWN:1,UP:2,MOVE:3,parse(t){if("string"!=typeof t)return p.NULL;switch(t.toLowerCase()){case"down":return p.DOWN;case"up":return p.UP;case"move":return p.MOVE;default:return p.NULL}}},m="*";class f{constructor(t,e){this.deviceName=t,this.eventTarget=e,this.listeners={}}destroy(){this.listeners={}}addInputListener(t,e){let i=this.listeners[t];i?i.push(e):(i=[e],this.listeners[t]=i)}removeInputListener(t,e){let i=this.listeners[t];i&&(i.indexOf(e),i.splice(e,1))}dispatchInput(t){const{keyCode:e}=t,i=this.listeners[e];let s=!1;if(i){for(let e of i)s|=e(t);return s}for(let e of this.listeners["*"])s|=e(t);return s}}class g{static createAdapter(t,e,i,s,n,o){return{target:t,adapterId:e,deviceName:i,keyCode:s,scale:n,eventCode:o}}constructor(){this.adapters={"*":b()}}add(t){for(let e of t){const{deviceName:t,keyCode:i}=e;let s;t in this.adapters?s=this.adapters[t]:(s=b(),this.adapters[t]=s),i in s?s[i].push(e):s[i]=[e]}}delete(t){for(let e of t){const{deviceName:t,keyCode:i}=e;if(t in this.adapters){let s=this.adapters[t];if(i in s){let t=s[i],n=t.indexOf(e);n>=0&&t.splice(n,1)}}}}clear(){for(let t in this.adapters)this.adapters[t]=b()}poll(t,e,i){const s=this.findAdapters(t,e);for(let t of s){const e=t.eventCode;if(e===p.NULL){const{target:e,scale:s}=t,n=i.value*s;e.poll(n,t)}else{const{target:s,scale:n}=t,o=i.getEvent(e)*n;s.poll(o,t)}}return s.length>0}update(t,e,i){let s=!1;for(let n of this.findAdapters(t,e)){const t=n.eventCode;if(t!==p.NULL){const{target:e,scale:o}=n,r=i.getEvent(t)*o;e.update(r,n),s=!0}}return s}reset(t,e,i){let s=!1;for(let i of this.findAdapters(t,e))i.target.reset(),s=!0;return s}findAdapters(t,e){let i=[];if(t in this.adapters){let s=this.adapters[t];e in s&&i.push(...s[e]),i.push(...s["*"])}let s=this.adapters["*"];return e in s&&i.push(...s[e]),i.push(...s["*"]),i}}function b(){return{[m]:[]}}class v{constructor(){this.value=0}update(t){this.value=t}poll(){this.value=0}getEvent(t){return 0}getState(){return this.value}}class y extends v{constructor(t){super(),this.update=this.update.bind(this),Array.isArray(t)||(t=[t]);let e=[],i=0;for(let s of t){"string"==typeof s&&(s={key:s});const{key:t,scale:n=1,event:o="null"}=s,{deviceName:r,keyCode:l}=w(t),a=p.parse(o),h=Number(n);let d=g.createAdapter(this,i,r,l,h,a);e.push(d),++i}this.adapters=e,this.values=new Array(e.length).fill(0),this.next={values:new Array(e.length).fill(0),value:0}}poll(t,e){const i=e.adapterId;let s=this.values[i];this.values[i]=t,this.value=this.value-s+t,this.next.values[i]=0,this.next.value+=t-s}update(t,e){const i=e.adapterId;let s=this.next.values[i];this.next.values[i]=t,this.next.value+=t-s}reset(){this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function w(t){let e=t.indexOf(":");if(e>=0)return{deviceName:t.substring(0,e),keyCode:t.substring(e+1)};throw new Error("Invalid key string - missing device separator ':'.")}function _(t,e){return`${t}:${e}`}class E extends f{constructor(t,e={}){super("Keyboard",t);const{repeat:i=!1}=e;this.repeat=i,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:p.NULL,type:d,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)}destroy(){let t=this.eventTarget;t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._eventObject;return e.keyCode=t.code,e.event=p.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onKeyUp(t){let e=this._eventObject;if(e.keyCode=t.code,e.event=p.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}}class x extends f{constructor(t,e={eventsOnFocus:!0}){super("Mouse",t),this.canvasTarget=t instanceof HTMLCanvasElement&&t||t.canvas||t.querySelector("canvas")||t.shadowRoot&&t.shadowRoot.querySelector("canvas")||t,this.eventsOnFocus=e.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:p.NULL,type:d,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:t,deviceName:this.deviceName,keyCode:"Position",event:p.MOVE,type:u,x:0,y:0,dx:0,dy:0},this._wheelObject={target:t,deviceName:this.deviceName,keyCode:"Wheel",event:p.MOVE,type:c,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("contextmenu",this.onContextMenu),t.addEventListener("wheel",this.onWheel),t.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let t=this.eventTarget;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("contextmenu",this.onContextMenu),t.removeEventListener("wheel",this.onWheel),t.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(t=!0){t?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(t){this._downHasFocus=!0;let e=this._eventObject;if(e.keyCode="Button"+t.button,e.event=p.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)&&document.activeElement===this.eventTarget)return t.preventDefault(),t.stopPropagation(),!1}onContextMenu(t){return t.preventDefault(),t.stopPropagation(),!1}onWheel(t){let e=this._wheelObject;switch(t.deltaMode){case WheelEvent.DOM_DELTA_LINE:e.dx=10*t.deltaX,e.dy=10*t.deltaY,e.dz=10*t.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:e.dx=100*t.deltaX,e.dy=100*t.deltaY,e.dz=100*t.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:e.dx=t.deltaX,e.dy=t.deltaY,e.dz=t.deltaZ}if(this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}onMouseUp(t){if(!this._downHasFocus)return;this._downHasFocus=!1;let e=this._eventObject;return e.keyCode="Button"+t.button,e.event=p.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onMouseMove(t){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const e=this.canvasTarget,{clientWidth:i,clientHeight:s}=e,n=e.getBoundingClientRect();let o=t.movementX/i,r=t.movementY/s,l=(t.clientX-n.left)/i,a=(t.clientY-n.top)/s,h=this._positionObject;h.x=l,h.y=a,h.dx=o,h.dy=r,this.dispatchInput(h)}}class M extends v{constructor(){super(),this.delta=0,this.next={delta:0}}update(t,e){this.value=t,this.next.delta+=e}poll(){this.delta=this.next.delta,this.next.delta=0}getEvent(t){switch(t){case p.MOVE:return this.delta;default:return super.getEvent(t)}}}class S extends v{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(t){t?this.next.down=!0:this.next.up=!0}poll(){const{up:t,down:e}=this.next;this.value?this.up&&!t&&(this.value=0):e&&(this.value=1),this.down=e,this.up=t,this.next.down=!1,this.next.up=!1}getEvent(t){switch(t){case p.DOWN:return 1&this.down;case p.UP:return 1&this.up;default:return super.getEvent(t)}}}const k=1,A=2;const L=Symbol("inputSource");class O{static for(t){if(Object.prototype.hasOwnProperty.call(t,L))return t[L];{let e=new O([new E(t),new x(t)]);return Object.defineProperty(t,L,{value:e}),e}}constructor(t){this.onInputEvent=this.onInputEvent.bind(this);let e={},i={};for(let s of t){const t=s.deviceName;e[t]=s,i[t]={},s.addInputListener(m,this.onInputEvent)}this.devices=e,this.inputs=i,this.listeners={poll:[],update:[]}}destroy(){this.clear();for(let t in this.devices){let e=this.devices[t];e.removeInputListener(m,this.onInputEvent),e.destroy()}}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let i=this.listeners[t],s=i.indexOf(e);i.splice(s,1)}}dispatchEvent(t,e){for(let i of this.listeners[t])i(e)}_dispatchInputEvent(t,e,i,s){this.dispatchEvent("input",{stage:t,deviceName:e,keyCode:i,input:s})}_dispatchPollEvent(){this.dispatchEvent("poll",{})}poll(){for(const t in this.inputs){const e=this.inputs[t];for(const i in e){let s=e[i];s.poll(),this._dispatchInputEvent(A,t,i,s)}}this._dispatchPollEvent()}onInputEvent(t){const e=t.deviceName;switch(t.type){case d:{const i=t.keyCode;let s=this.inputs[e][i];s&&(s.update(t.event===p.DOWN),this._dispatchInputEvent(k,e,i,s))}break;case u:{let i=this.inputs[e],s=i.PosX;s&&(s.update(t.x,t.dx),this._dispatchInputEvent(k,e,"PosX",s));let n=i.PosY;n&&(n.update(t.y,t.dy),this._dispatchInputEvent(k,e,"PosY",n))}break;case c:{let i=this.inputs[e],s=i.WheelX;s&&(s.update(t.dx,t.dx),this._dispatchInputEvent(k,e,"WheelX",s));let n=i.WheelY;n&&(n.update(t.dy,t.dy),this._dispatchInputEvent(k,e,"WheelY",n));let o=i.WheelZ;o&&(o.update(t.dz,t.dz),this._dispatchInputEvent(k,e,"WheelZ",o))}}}add(t,e){if(!(t in this.devices))throw new Error("Invalid device name - missing device with name in source.");let i=function(t,e){return"Mouse"===t&&("PosX"===e||"PosY"===e||"WheelX"===e||"WheelY"===e||"WheelZ"===e)}(t,e)?new M:new S;return this.inputs[t][e]=i,this}delete(t,e){delete this.inputs[t][e]}get(t,e){return this.inputs[t][e]}has(t,e){return t in this.inputs&&e in this.inputs[t]}clear(){for(let t in this.devices)this.inputs[t]={}}}class C{constructor(t={}){const{disabled:e=!0}=t;this.source=null,this._disabled=e,this._ignoreInput=e,this.adapters=new g,this.inputs={},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this)}get disabled(){return this._disabled}set disabled(t){this.toggle(!t)}setInputMap(t){return this._setupInputs(this.source,t),this}attach(t){return this._setupInputs(t,null),this.toggle(!0),this}detach(){return this.toggle(!1),this._setupInputs(null,null),this}_setupInputs(t,e){const i=this.disabled;this.disabled=!0;const s=this.source,n=this.inputs,o=s!==t&&s,r=this.inputs&&e;if(o||r){o&&(s.removeEventListener("poll",this.onSourcePoll),s.removeEventListener("input",this.onSourceInput));for(let t in n){let{adapters:e}=n[t];for(let t of e){const{deviceName:e,keyCode:i}=t;0===P(s,e,i)&&s.delete(e,i)}}r&&(this.adapters.clear(),this.inputs={})}if(e){let t={};for(let i in e){let s=e[i],n=new y(s),o=n.adapters;this.adapters.add(o),t[i]=n}this.inputs=t}if(t){!function(t){T in t||(t[T]={})}(t);const e=this.inputs;for(let i in e){let{adapters:s}=e[i];for(let e of s){const{deviceName:i,keyCode:s}=e;1===I(t,i,s)&&t.add(i,s)}}this.source!==t&&(t.addEventListener("poll",this.onSourcePoll),t.addEventListener("input",this.onSourceInput),this.source=t)}this.disabled=i}onSourceInput(t){if(t.consumed||this._ignoreInput){const{deviceName:e,keyCode:i,input:s}=t;this.adapters.reset(e,i,s)}else{const{stage:e,deviceName:i,keyCode:s,input:n}=t;switch(e){case A:this.adapters.poll(i,s,n);break;case k:this.adapters.update(i,s,n)}t.consumed=!0}}onSourcePoll(t){this._ignoreInput!==this.disabled&&(this._ignoreInput=this.disabled)}toggle(t=this._disabled){if(t){if(!this.source)throw new Error("Input source must be set before enabling input context.");Object.keys(this.inputs).length<=0&&console.warn("No inputs found for enabled input context - did you forget to setInputMap()?")}return this._disabled=!t,this}getInput(t){return this.inputs[t]}getInputValue(t){return t in this.inputs?this.inputs[t].value:0}}const T=Symbol("inputRefCounts");function I(t,e,i){const s=_(e,i);let n=t[T],o=n[s]+1||1;return n[s]=o,o}function P(t,e,i){const s=_(e,i);let n=t[T],o=n[s]-1||0;return n[s]=Math.max(o,0),o}class N extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<kbd>\n    <span id="key"><slot></slot></span>\n    <span id="value" class="hidden"></span>\n</kbd>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML='kbd{position:relative;display:inline-block;border-radius:3px;border:1px solid #888;font-size:.85em;font-weight:700;text-rendering:optimizeLegibility;line-height:12px;height:14px;padding:2px 4px;color:#444;background-color:#eee;box-shadow:inset 0 -3px 0 #aaa;overflow:hidden}kbd:empty:after{content:"<?>";opacity:.6}.disabled{opacity:.6;box-shadow:none;background-color:#aaa}.hidden{display:none}#value{position:absolute;top:0;bottom:0;right:0;font-size:.85em;padding:2px 4px 0;color:#ccc;background-color:#333;box-shadow:inset 0 3px 0 #222}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{name:String,value:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get value(){return this._value}set value(t){this.setAttribute("value",t)}get name(){return this._name}set name(t){this.setAttribute("name",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._keyboardElement=this.shadowRoot.querySelector("kbd"),this._keyElement=this.shadowRoot.querySelector("#key"),this._valueElement=this.shadowRoot.querySelector("#value")}attributeChangedCallback(t,e,i){switch(t){case"name":this._name=i;break;case"value":this._value=i;break;case"disabled":this._disabled=null!==i}((t,e,i)=>{switch(t){case"name":this._keyElement.innerText=i;break;case"value":null!==i?(this._valueElement.classList.toggle("hidden",!1),this._valueElement.innerText=i,this._keyboardElement.style.paddingRight=`${this._valueElement.clientWidth+4}px`):this._valueElement.classList.toggle("hidden",!0);break;case"disabled":this._keyboardElement.classList.toggle("disabled",null!==i)}})(t,0,i)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"name")){let t=this.name;delete this.name,this.name=t}if(Object.prototype.hasOwnProperty.call(this,"value")){let t=this.value;delete this.value,this.value=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}}static get observedAttributes(){return["name","value","disabled"]}}window.customElements.define("input-key",N);class j extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<table>\n    <thead>\n        <tr class="tableHeader">\n            <th colspan=4>\n                <slot id="title">input-map</slot>\n            </th>\n        </tr>\n        <tr class="colHeader">\n            <th>name</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:block}table{border-collapse:collapse}table,td,th{border:1px solid #666}td,th{padding:5px 10px}td{text-align:center}thead th{padding:0}.colHeader>th{font-size:.8em;padding:0 10px;letter-spacing:3px;background-color:#aaa;color:#666}.colHeader>th,output{font-family:monospace}output{border-radius:.3em;padding:3px}tr:not(.primary) .name,tr:not(.primary) .value{opacity:.3}tr:nth-child(2n){background-color:#eee}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get observedAttributes(){return["src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._inputMap={},this._titleElement=this.shadowRoot.querySelector("#title"),this._tableElements={},this._bodyElement=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot")}get map(){return this._inputMap}connectedCallback(){!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let i=t[e];delete t[e],t[e]=i}}(this,"src")}attributeChangedCallback(t,e,i){switch(t){case"src":if(this._src!==i)if(this._src=i,i.trim().startsWith("{")){let t=JSON.parse(i);this._setInputMap(t)}else fetch(i).then((t=>t.json())).then((t=>this._setInputMap(t)));break;case"id":case"class":this._titleElement.innerHTML=`input-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}}get src(){return this.getAttribute("src")}set src(t){switch(typeof t){case"object":{let e=JSON.stringify(t);this._src=e,this._setInputMap(t),this.setAttribute("src",e)}break;case"string":this.setAttribute("src",t);break;default:this.setAttribute("src",JSON.stringify(t))}}_setInputMap(t){let e=[];for(let i in t){R(e,i,t[i])}this._bodyElement.innerHTML="";for(let t of e)this._bodyElement.appendChild(t);this._inputMap=t}}function R(t,e,i){if(Array.isArray(i)){R(t,e,i[0]);let s=i.length;for(let n=1;n<s;++n)t.push(F(e,i[n],!1))}else t.push(F(e,i,!0));return t}function F(t,e,i=!0){if("object"==typeof e){const{key:s,event:n,scale:o}=e;return D(t,s,n,o,0,i)}return D(t,e,null,1,0,i)}function D(t,e,i,s,n,o=!0){let r=document.createElement("tr");o&&r.classList.add("primary");{let e=document.createElement("td");e.textContent=t,e.classList.add("name"),r.appendChild(e)}{let t=document.createElement("td");t.classList.add("key");let i=new N;i.innerText=e,t.appendChild(i),r.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp"),n=[];"string"==typeof i&&"null"!==i&&n.push(i),"number"==typeof s&&1!==s&&n.push(`×${s.toFixed(2)}`),e.innerText=n.join(" "),t.classList.add("mod"),t.appendChild(e),r.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("output");e.innerText=Number(n).toFixed(2),e.classList.add("value"),t.appendChild(e),r.appendChild(t)}return r}window.customElements.define("input-map",j);class W extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="hidden">\n    <label id="title">\n        input-source\n    </label>\n    <span>|</span>\n    <p>\n        <label for="poll">poll</label>\n        <output id="poll"></output>\n    </p>\n    <p>\n        <label for="focus">focus</label>\n        <output id="focus"></output>\n    </p>\n</div>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=':host{display:inline-block}.hidden{display:none}div{font-family:monospace;color:#666;outline:1px solid #666;padding:4px}p{display:inline;margin:0;padding:0}#focus:empty:after,#poll:empty:after{content:"✗";color:red}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean,debug:Boolean}}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get customEvents(){return["input","poll"]}get onpoll(){return this._onpoll}set onpoll(t){this._onpoll&&this.removeEventListener("poll",this._onpoll),this._onpoll=t,this._onpoll&&this.addEventListener("poll",t)}get oninput(){return this._oninput}set oninput(t){this._oninput&&this.removeEventListener("input",this._oninput),this._oninput=t,this._oninput&&this.addEventListener("input",t)}static get observedAttributes(){return["oninput","onpoll","for","autopoll","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._autopoll=!1,this._containerElement=this.shadowRoot.querySelector("div"),this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._focusElement=this.shadowRoot.querySelector("#focus"),this._pollCount=0,this._pollCountDelay=0,this._sourceElement=null,this._inputSource=null,this._animationFrameHandle=null,this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceFocus=this.onSourceFocus.bind(this),this.onSourceBlur=this.onSourceBlur.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this)}get source(){return this._inputSource}poll(){this._inputSource.poll()}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"oninput")){let t=this.oninput;delete this.oninput,this.oninput=t}if(Object.prototype.hasOwnProperty.call(this,"onpoll")){let t=this.onpoll;delete this.onpoll,this.onpoll=t}if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.hasAttribute("for")||this._setSourceElement(this),this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame)}disconnectedCallback(){cancelAnimationFrame(this._animationFrameHandle),this._clearSourceElement()}attributeChangedCallback(t,e,i){switch(t){case"for":this._for=i;break;case"autopoll":this._autopoll=null!==i;break;case"debug":this._debug=null!==i;break;case"oninput":this.oninput=new Function("event","with(document){with(this){"+i+"}}").bind(this);break;case"onpoll":this.onpoll=new Function("event","with(document){with(this){"+i+"}}").bind(this)}((t,e,i)=>{switch(t){case"for":this._setSourceElement(i?document.getElementById(i):this);break;case"id":case"class":{let t=this.className?"."+this.className:"",e=this.hasAttribute("id")?"#"+this.getAttribute("id"):"";this._titleElement.innerHTML=t+e}break;case"debug":this._containerElement.classList.toggle("hidden",i)}})(t,0,i)}onSourceInput(t){this.dispatchEvent(new CustomEvent("input",{composed:!0,bubbles:!1,detail:t}))}onSourcePoll(){this._pollCount+=1,this.dispatchEvent(new CustomEvent("poll",{composed:!0,bubbles:!1}))}onSourceFocus(){this._focusElement.innerText="✓"}onSourceBlur(){this._focusElement.innerText=""}onAnimationFrame(t){if(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this._autopoll&&this.poll(),this.debug){t-this._pollCountDelay>1e3&&(this._pollCountDelay=t,this._pollCount>0?(this._pollElement.innerText="✓",this._pollCount=0):this._pollElement.innerText="")}}_clearSourceElement(){if(this._inputSource){let t=this._inputSource,e=this._sourceElement;this._inputSource=null,this._sourceElement=null,e.removeEventListener("focus",this.onSourceFocus),e.removeEventListener("blur",this.onSourceBlur),t.destroy()}}_setSourceElement(t){if(this._clearSourceElement(),!t)throw new Error("Event target not found.");let e=O.for(t);e.addEventListener("input",this.onSourceInput),e.addEventListener("poll",this.onSourcePoll),t.addEventListener("focus",this.onSourceFocus),t.addEventListener("blur",this.onSourceBlur),this._sourceElement=t,this._inputSource=e}}window.customElements.define("input-source",W);class H extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<input-map class="hidden">\n    <input-source debug></input-source>\n</input-map>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block}.hidden{display:none}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,disabled:Boolean,autopoll:Boolean,debug:Boolean}}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get observedAttributes(){return["for","disabled","autopoll","debug","src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._inputContext=new C,this._mapElement=this.shadowRoot.querySelector("input-map"),this._sourceElement=this.shadowRoot.querySelector("input-source")}get context(){return this._inputContext}get source(){return this._sourceElement.source}get map(){return this._mapElement.map}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let i=t[e];delete t[e],t[e]=i}}(this,"src")}attributeChangedCallback(t,e,i){switch(t){case"for":this._for=i;break;case"disabled":this._disabled=null!==i;break;case"autopoll":this._autopoll=null!==i;break;case"debug":this._debug=null!==i}((t,e,i)=>{switch(t){case"for":this._sourceElement.for=i,this._inputContext.attach(this._sourceElement.source);break;case"disabled":this._inputContext.disabled=null!==i;break;case"autopoll":this._sourceElement.autopoll=null!==i;break;case"src":this._mapElement.src=i,this._inputContext.setInputMap(this._mapElement.map);break;case"debug":this._mapElement.classList.toggle("hidden",null===i);break;case"id":this._sourceElement.id=i;break;case"class":this._sourceElement.className=i}})(t,0,i)}get src(){return this._mapElement.src}set src(t){this._mapElement.src=t}}window.customElements.define("input-context",H);const q=(new C).setInputMap({activate:{key:"Mouse:Button0",event:"up"},mark:{key:"Mouse:Button2",event:"up"},restart:{key:"Keyboard:KeyR",event:"up"},cursorX:{key:"Mouse:PosX",scale:1},cursorY:{key:"Mouse:PosY",scale:1}}),K=q.getInput("cursorX"),U=q.getInput("cursorY"),B=q.getInput("activate"),z=q.getInput("mark"),$=q.getInput("restart");var V="undefined"!=typeof Float32Array?Float32Array:Array;function X(){var t=new V(16);return V!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Y(){var t=new V(3);return V!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function G(t,e,i){var s=new V(3);return s[0]=t,s[1]=e,s[2]=i,s}function Z(t,e,i){var s=e[0],n=e[1],o=e[2],r=i[0],l=i[1],a=i[2];return t[0]=n*a-o*l,t[1]=o*r-s*a,t[2]=s*l-n*r,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var J,Q=function(t){var e=t[0],i=t[1],s=t[2];return Math.hypot(e,i,s)};J=Y();!function(){var t,e=(t=new V(4),V!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function tt(){var t=new V(4);return V!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function et(t,e,i,s){var n,o,r,l,a,h=e[0],d=e[1],u=e[2],c=e[3],p=i[0],m=i[1],f=i[2],g=i[3];return(o=h*p+d*m+u*f+c*g)<0&&(o=-o,p=-p,m=-m,f=-f,g=-g),1-o>1e-6?(n=Math.acos(o),r=Math.sin(n),l=Math.sin((1-s)*n)/r,a=Math.sin(s*n)/r):(l=1-s,a=s),t[0]=l*h+a*p,t[1]=l*d+a*m,t[2]=l*u+a*f,t[3]=l*c+a*g,t}var it,st,nt,ot,rt,lt,at,ht=function(t,e){var i=e[0],s=e[1],n=e[2],o=e[3],r=i*i+s*s+n*n+o*o;return r>0&&(r=1/Math.sqrt(r)),t[0]=i*r,t[1]=s*r,t[2]=n*r,t[3]=o*r,t};it=Y(),st=G(1,0,0),nt=G(0,1,0),ot=tt(),rt=tt(),lt=new V(9),V!=Float32Array&&(lt[1]=0,lt[2]=0,lt[3]=0,lt[5]=0,lt[6]=0,lt[7]=0),lt[0]=1,lt[4]=1,lt[8]=1,at=lt;class dt{static screenToWorld(t,e,i,s){let n=function(t,e,i){var s=e[0],n=e[1],o=e[2],r=e[3],l=e[4],a=e[5],h=e[6],d=e[7],u=e[8],c=e[9],p=e[10],m=e[11],f=e[12],g=e[13],b=e[14],v=e[15],y=i[0],w=i[1],_=i[2],E=i[3];return t[0]=y*s+w*l+_*u+E*f,t[1]=y*n+w*a+_*c+E*g,t[2]=y*o+w*h+_*p+E*b,t[3]=y*r+w*d+_*m+E*v,y=i[4],w=i[5],_=i[6],E=i[7],t[4]=y*s+w*l+_*u+E*f,t[5]=y*n+w*a+_*c+E*g,t[6]=y*o+w*h+_*p+E*b,t[7]=y*r+w*d+_*m+E*v,y=i[8],w=i[9],_=i[10],E=i[11],t[8]=y*s+w*l+_*u+E*f,t[9]=y*n+w*a+_*c+E*g,t[10]=y*o+w*h+_*p+E*b,t[11]=y*r+w*d+_*m+E*v,y=i[12],w=i[13],_=i[14],E=i[15],t[12]=y*s+w*l+_*u+E*f,t[13]=y*n+w*a+_*c+E*g,t[14]=y*o+w*h+_*p+E*b,t[15]=y*r+w*d+_*m+E*v,t}(X(),s,i);!function(t,e){var i=e[0],s=e[1],n=e[2],o=e[3],r=e[4],l=e[5],a=e[6],h=e[7],d=e[8],u=e[9],c=e[10],p=e[11],m=e[12],f=e[13],g=e[14],b=e[15],v=i*l-s*r,y=i*a-n*r,w=i*h-o*r,_=s*a-n*l,E=s*h-o*l,x=n*h-o*a,M=d*f-u*m,S=d*g-c*m,k=d*b-p*m,A=u*g-c*f,L=u*b-p*f,O=c*b-p*g,C=v*O-y*L+w*A+_*k-E*S+x*M;C&&(C=1/C,t[0]=(l*O-a*L+h*A)*C,t[1]=(n*L-s*O-o*A)*C,t[2]=(f*x-g*E+b*_)*C,t[3]=(c*E-u*x-p*_)*C,t[4]=(a*k-r*O-h*S)*C,t[5]=(i*O-n*k+o*S)*C,t[6]=(g*w-m*x-b*y)*C,t[7]=(d*x-c*w+p*y)*C,t[8]=(r*L-l*k+h*M)*C,t[9]=(s*k-i*L-o*M)*C,t[10]=(m*E-f*w+b*v)*C,t[11]=(u*w-d*E-p*v)*C,t[12]=(l*S-r*A-a*M)*C,t[13]=(i*A-s*S+n*M)*C,t[14]=(f*y-m*_-g*v)*C,t[15]=(d*_-u*y+c*v)*C)}(n,n);let o=G(t,e,0);return function(t,e,i){var s=e[0],n=e[1],o=e[2],r=i[3]*s+i[7]*n+i[11]*o+i[15];r=r||1,t[0]=(i[0]*s+i[4]*n+i[8]*o+i[12])/r,t[1]=(i[1]*s+i[5]*n+i[9]*o+i[13])/r,t[2]=(i[2]*s+i[6]*n+i[10]*o+i[14])/r}(o,o,n),o}constructor(t=-1,e=1,i=-1,s=1,n=0,o=1){this.position=Y(),this.rotation=tt(),this.scale=G(1,1,1),this.clippingPlane={left:t,right:e,top:i,bottom:s,near:n,far:o},this._viewMatrix=X(),this._projectionMatrix=X()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,i=0,s=1){let n=G(t,e,i);!function(t,e,i,s){var n=e[0],o=e[1],r=e[2];t[0]=n+s*(i[0]-n),t[1]=o+s*(i[1]-o),t[2]=r+s*(i[2]-r)}(this.position,this.position,n,Math.min(1,s))}getViewMatrix(t=this._viewMatrix){let e=-Math.round(this.x),i=-Math.round(this.y),s=0===this.z?1:1/this.z,n=G(e,i,0),o=G(this.scale[0]*s,this.scale[1]*s,1);return function(t,e,i,s){var n=e[0],o=e[1],r=e[2],l=e[3],a=n+n,h=o+o,d=r+r,u=n*a,c=n*h,p=n*d,m=o*h,f=o*d,g=r*d,b=l*a,v=l*h,y=l*d,w=s[0],_=s[1],E=s[2];t[0]=(1-(m+g))*w,t[1]=(c+y)*w,t[2]=(p-v)*w,t[3]=0,t[4]=(c-y)*_,t[5]=(1-(u+g))*_,t[6]=(f+b)*_,t[7]=0,t[8]=(p+v)*E,t[9]=(f-b)*E,t[10]=(1-(u+m))*E,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1}(t,this.rotation,n,o),t}getProjectionMatrix(t=this._projectionMatrix){let{left:e,right:i,top:s,bottom:n,near:o,far:r}=this.clippingPlane;return function(t,e,i,s,n,o,r){var l=1/(e-i),a=1/(s-n),h=1/(o-r);t[0]=-2*l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+i)*l,t[13]=(n+s)*a,t[14]=(r+o)*h,t[15]=1}(t,e,i,s,n,o,r),t}}class ut{constructor(){this.prevTransformMatrix=null,this.domProjectionMatrix=new DOMMatrix,this.domViewMatrix=new DOMMatrix,this.ctx=null}begin(t,e,i){if(this.ctx)throw new Error("View already begun - maybe missing end() call?");e&&ct(this.domViewMatrix,e),i&&ct(this.domProjectionMatrix,i),this.prevTransformMatrix=t.getTransform(),t.setTransform(this.domProjectionMatrix);const{a:s,b:n,c:o,d:r,e:l,f:a}=this.domViewMatrix;t.transform(s,n,o,r,l,a),this.ctx=t}end(t){t.setTransform(this.prevTransformMatrix),this.ctx=null}}function ct(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}const pt=16;function mt(){this.mines=new r(16,16),this.minesView=new ut,this.camera=new dt,this.camera.x=-32,this.camera.y=-32,this.firstAction=!1,this.health=3,this.gameOver=!1,this.gameWin=!1,this.gameTime=0}function ft(t){}function gt(t){var e,s;if($.value)bt(this);else if(this.gameOver||this.gameWin){if(B.value||z.value)return void bt(this)}else{const n=this.display.width,o=this.display.height;this.firstAction&&(this.gameTime+=t);let r=!1;if(B.value){let t=K.value*n,l=U.value*o,a=dt.screenToWorld(t,l,this.camera.getViewMatrix(),this.camera.getProjectionMatrix()),h=i(Math.floor(a[0]/pt),0,this.mines.width-1),d=i(Math.floor(a[1]/pt),0,this.mines.height-1);this.mines.dig(h,d)||(s=1,(e=this).health-=s,e.health<=0&&function(t){t.gameOver=!0}(e)),this.mines.checkWinCondition()&&function(t){t.gameWin=!0}(this),r=!0}if(z.value){let t=K.value*n,e=U.value*o,s=dt.screenToWorld(t,e,this.camera.getViewMatrix(),this.camera.getProjectionMatrix()),l=i(Math.floor(s[0]/pt),0,this.mines.width-1),a=i(Math.floor(s[1]/pt),0,this.mines.height-1);this.mines.mark(l,a),r=!0}r&&!this.firstAction&&(this.firstAction=!0)}}function bt(t){t.mines.reset(),t.gameOver=!1,t.gameWin=!1,t.gameTime=0,t.firstAction=!1,t.health=3}async function vt(t,e){return new Promise(((e,i)=>{let s=new Image;s.addEventListener("load",(()=>{e(s)})),s.addEventListener("error",(t=>{i(t)})),s.src=t}))}const yt={LOADED:!1,TILE_IMAGE:null,NUMS_IMAGE:null,MARK_IMAGE:null};async function wt(){await async function(){yt.TILE_IMAGE=await vt("mines/tile.png"),yt.NUMS_IMAGE=await vt("mines/nums.png"),yt.MARK_IMAGE=await vt("mines/flag.png"),yt.LOADED=!0}()}function _t(t,e){let s=t.context;const n=e.camera.getViewMatrix(),o=e.camera.getProjectionMatrix();e.minesView.begin(s,n,o),function(t,e,i=16){if(!yt.LOADED)throw new Error("Assets for this renderer have not yet been loaded.");const s=e.width,n=e.height,o=e.data,r=i/2;t.fillStyle="#777777",t.fillRect(0,0,s*i,n*i),function(t,e,i,s,n,o,r){t.strokeStyle="#888888",t.beginPath();for(let o=0;o<n;o+=r)t.moveTo(e,o+i),t.lineTo(e+s,o+i);for(let r=0;r<s;r+=o)t.moveTo(r+e,i),t.lineTo(r+e,i+n);t.stroke()}(t,0,0,s*i,n*i,i,i);for(let e=0;e<n;++e)for(let n=0;n<s;++n){let l=n*i,a=e*i,h=n+e*s;if(o.solids[h]>0)t.drawImage(yt.TILE_IMAGE,l,a,i,i),o.marks[h]>0&&t.drawImage(yt.MARK_IMAGE,l,a,i,i);else if(o.tiles[h]>0)t.fillStyle="rgba(0, 0, 0, 0.2)",t.fillRect(l,a,i,i),t.textAlign="center",t.textBaseline="middle",t.font="10px sans-serif",t.fillStyle="#000000",t.fillText("X",l+r,a+r);else if(o.overlay[h]>0){let e=o.overlay[h]-1;t.drawImage(yt.NUMS_IMAGE,32*e,0,32,32,l,a,i,i)}}}(s,e.mines,pt),e.minesView.end(s);const r=e.mines.width,l=e.mines.height,a=32,h=pt;let d=K.value*t.width,u=U.value*t.height,c=dt.screenToWorld(d,u,n,o),p=i(Math.floor(c[0]/h),0,r-1),m=i(Math.floor(c[1]/h),0,l-1);s.fillStyle="rgba(0, 0, 0, 0.2)",s.fillRect(32+p*h,a+m*h,h,h),s.fillStyle="rgba(0, 0, 0, 0.3)",s.fillRect(0,0,t.width,a),s.fillRect(0,t.height-a,t.width,a),s.fillRect(0,a,32,t.height-64),s.fillRect(t.width-32,a,32,t.height-64);for(let t=0;t<3;++t){let i=t<e.health?"salmon":"darkgray";s.fillStyle=i,s.fillRect(0+t*h,0,13,13)}e.gameOver?(Et(s,t.width/2,t.height/2,.7*t.width,8,"black"),xt(s,t.width/2+1,t.height/2+1,"Game Over",32,"black"),xt(s,t.width/2-1,t.height/2-1,"Game Over",32,"white"),xt(s,t.width/2+1,t.height/2+24+1,"Click to continue",16,"black"),xt(s,t.width/2-1,t.height/2+24-1,"Click to continue",16,"white")):e.gameWin&&(Et(s,t.width/2,t.height/2,.7*t.width,8,"black"),xt(s,t.width/2+1,t.height/2+1,"Success!",32,"black"),xt(s,t.width/2-1,t.height/2-1,"Success!",32,"gold"),xt(s,t.width/2+1,t.height/2+24+1,"Click to continue",16,"black"),xt(s,t.width/2-1,t.height/2+24-1,"Click to continue",16,"white")),xt(s,t.width/2,t.height-h,`Time: ${Math.floor(e.gameTime)}`,16,"white")}function Et(t,e,i,s,n,o){t.translate(e,i);{let e=s/2,i=n/2;t.fillStyle=o,t.fillRect(-e,-i,s,n)}t.translate(-e,-i)}function xt(t,e,i,s,n,o){t.translate(e,i),t.textAlign="center",t.textBaseline="middle",t.font=`${n}px sans-serif`,t.fillStyle=o,t.fillText(s,0,0),t.translate(-e,-i)}document.addEventListener("DOMContentLoaded",(async function(){const t=document.querySelector("display-port"),e=t.canvas.getContext("2d");e.imageSmoothingEnabled=!1,function(){const t=O.for(document.querySelector("#main"));q.attach(t)}();const i={display:t};await wt.call(i),mt.call(i),t.addEventListener("frame",(s=>{const n=s.detail.deltaTime/1e3;ft.call(i,n),q.source.poll(),gt.call(i,n);const o={context:e,width:t.width,height:t.height};e.clearRect(0,0,o.width,o.height),_t.call(i,o,i)}))}))}();
