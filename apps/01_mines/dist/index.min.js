!function(){"use strict";const t="noscale",e="stretch",n=Symbol("template"),i=Symbol("style");class s extends HTMLElement{static get[n](){let t=document.createElement("template");return t.innerHTML='\n<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <canvas></canvas>\n    <slot></slot>\n</div>',Object.defineProperty(this,n,{value:t}),t}static get[i](){let t=document.createElement("style");return t.innerHTML='\n:host {\n    display: inline-block;\n    color: #555555;\n}\n.container {\n    display: flex;\n    position: relative;\n    width: 100%;\n    height: 100%;\n}\ncanvas {\n    background: #000000;\n    margin: auto;\n    image-rendering: pixelated;\n}\nlabel {\n    font-family: monospace;\n    color: currentColor;\n    position: absolute;\n}\n#title {\n    left: 0.5rem;\n    top: 0.5rem;\n}\n#fps {\n    right: 0.5rem;\n    top: 0.5rem;\n}\n#dimension {\n    left: 0.5rem;\n    bottom: 0.5rem;\n}\n.hidden {\n    display: none;\n}\n:host([debug]) .container {\n    outline: 6px dashed rgba(0, 0, 0, 0.1);\n    outline-offset: -4px;\n    background-color: rgba(0, 0, 0, 0.1);\n}\n:host([mode="noscale"]) canvas {\n    margin: 0;\n    top: 0;\n    left: 0;\n}\n:host([mode="fit"]), :host([mode="center"]), :host([mode="stretch"]) {\n    width: 100%;\n    height: 100%;\n}\n:host([full]) {\n    width: 100vw!important;\n    height: 100vh!important;\n}\n:host([disabled]) {\n    display: none;\n}\nslot {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    top: 0;\n    left: 0;\n\n    pointer-events: none;\n}\n::slotted(*) {\n    pointer-events: auto;\n}',Object.defineProperty(this,i,{value:t}),t}static get observedAttributes(){return["width","height","disabled","onframe","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[n].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[i].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this._onframe=null,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){this.hasAttribute("mode")||(this.mode="noscale"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=n;break;case"height":this._height=n;break;case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"onframe":this.onframe=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}}update(e){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const n=e-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=e,this.debug){const e=n<=0?"--":String(Math.round(1e3/n)).padStart(2,"0");if(this._fpsElement.innerText!==e&&(this._fpsElement.innerText=e),this.mode===t){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:e,prevTime:this._prevAnimationFrameTime,deltaTime:n,canvas:this._canvasElement,get context(){let t=this.canvas.getContext("2d");return t.imageSmoothingEnabled=!1,t}},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}updateCanvasSize(){let n=this.shadowRoot.host.getBoundingClientRect();const i=n.width,s=n.height;let r=this._canvasElement,a=this._width,o=this._height;const h=this.mode;if(h===e)a=i,o=s;else if(h!==t){if(i<a||s<o||"fit"===h){let t=i/a,e=s/o;t<e?(a=i,o*=t):(a*=e,o=s)}}a=Math.floor(a),o=Math.floor(o),r.clientWidth===a&&r.clientHeight===o||(r.width=this._width,r.height=this._height,r.style=`width: ${a}px; height: ${o}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:a,height:o},bubbles:!1,composed:!0})))}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}get width(){return this._width}set width(t){this.setAttribute("width",t)}get height(){return this._height}set height(t){this.setAttribute("height",t)}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get debug(){return this.hasAttribute("debug")}set debug(t){t?this.setAttribute("debug",""):this.removeAttribute("debug")}}window.customElements.define("display-port",s);class r{static addInputEventListener(t,e){}static removeInputEventListener(t,e){}constructor(t){this.eventTarget=t}}class a{constructor(){this.down=0,this.up=0,this.value=0,this.next={up:0,down:0}}update(t,e){"down"===t?this.next.down=e:this.next.up=e}poll(){this.value?this.up&&!this.next.up&&(this.value=0):this.next.down&&(this.value=1),this.down=this.next.down,this.up=this.next.up,this.next.down=0,this.next.up=0}toString(){return this.value}}class o{constructor(){this.value=0}update(t,e){this.value=e}poll(){}toString(){return this.value}}class h extends o{constructor(){super(),this.next=0}update(t,e){this.next+=e}poll(){this.value=this.next,this.next=0}}const l=Symbol("keyboardEventContext");class u extends r{static addInputEventListener(t,e){let n;if(l in e)n=e[l];else{n={handler:e,target:t,down:null,up:null,_keyEvent:{type:"key",target:t,device:"keyboard",key:null,event:null,value:null,control:!1,shift:!1,alt:!1}};let i=d.bind(n),s=c.bind(n);n.down=i,n.up=s,e[l]=n}return t.addEventListener("keyup",n.up),t.addEventListener("keydown",n.down),t}static removeInputEventListener(t,e){if(l in e){let n=e[l];t.removeEventListener("keyup",n.up),t.removeEventListener("keydown",n.down)}return t}constructor(t,e){if(super(t),this._buttons=[],this._managed=Array.isArray(e),this.onManagedKeyEvent=this.onManagedKeyEvent.bind(this),this.onUnmanagedKeyEvent=this.onUnmanagedKeyEvent.bind(this),this._managed){for(let t of e){let e=new a;this[t]=e,this._buttons.push(e)}u.addInputEventListener(t,this.onManagedKeyEvent)}else u.addInputEventListener(t,this.onUnmanagedKeyEvent)}get Up(){return Math.min((this.ArrowUp||0)+(this.KeyW||0),1)}get Down(){return Math.min((this.ArrowDown||0)+(this.KeyS||0),1)}get Left(){return Math.min((this.ArrowLeft||0)+(this.KeyA||0),1)}get Right(){return Math.min((this.ArrowRight||0)+(this.KeyD||0),1)}destroy(){this._managed?u.removeInputEventListener(this.eventTarget,this.onManagedKeyEvent):u.removeInputEventListener(this.eventTarget,this.onUnmanagedKeyEvent),this.eventTarget=null}poll(){for(let t of this._buttons)t.poll();return this}onUnmanagedKeyEvent(t){if(!(t.key in this)){let e=new a;this[t.key]=e,this._buttons.push(e)}return this[t.key].update(t.event,t.value),!0}onManagedKeyEvent(t){if(t.key in this)return this[t.key].update(t.event,t.value),!0}}function d(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._keyEvent;return e.key=t.code,e.event="down",e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.handler.call(void 0,e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}function c(t){let e=this._keyEvent;if(e.key=t.code,e.event="up",e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.handler.call(void 0,e))return t.preventDefault(),t.stopPropagation(),!1}const p=Symbol("mouseEventContext");class m extends r{static addInputEventListener(t,e){let n;if(p in e)n=e[p];else{n={handler:e,target:t,down:null,up:null,move:null,contextmenu:null,_down:!1,_keyEvent:{type:"key",target:t,device:"mouse",key:null,event:null,value:null},_posEvent:{type:"pos",target:t,device:"mouse",key:"pos",event:"move",x:0,y:0,dx:0,dy:0}};let i=f.bind(n),s=g.bind(n),r=v.bind(n),a=b.bind(n);n.down=i,n.up=s,n.move=r,n.contextmenu=a,e[p]=n}return t.addEventListener("mousedown",n.down),document.addEventListener("mouseup",n.up),t.addEventListener("contextmenu",n.contextmenu),document.addEventListener("mousemove",n.move),t}static removeInputEventListener(t,e){if(p in e){let n=e[p];t.removeEventListener("mousedown",n.down),document.removeEventListener("mouseup",n.up),t.removeEventListener("contextmenu",n.contextmenu),document.removeEventListener("mousemove",n.move)}return t}constructor(t){super(t),this.x=new o,this.y=new o,this.dx=new h,this.dy=new h,this.Button0=new a,this.Button1=new a,this.Button2=new a,this.Button3=new a,this.Button4=new a,this.onMouseEvent=this.onMouseEvent.bind(this),m.addInputEventListener(t,this.onMouseEvent)}get Left(){return this.Button0}get Middle(){return this.Button1}get Right(){return this.Button2}destroy(){m.removeInputEventListener(this.eventTarget,this.onMouseEvent),this.eventTarget=null}poll(){return this.x.poll(),this.y.poll(),this.dx.poll(),this.dy.poll(),this.Button0.poll(),this.Button1.poll(),this.Button2.poll(),this.Button3.poll(),this.Button4.poll(),this}onMouseEvent(t){let{key:e,event:n}=t;switch(e){case 0:this.Button0.update(n,t.value);break;case 1:this.Button1.update(n,t.value);break;case 2:this.Button2.update(n,t.value);break;case 3:this.Button3.update(n,t.value);break;case 4:this.Button4.update(n,t.value);break;case"pos":return this.x.update(n,t.x),this.y.update(n,t.y),this.dx.update(n,t.dx),void this.dy.update(n,t.dy)}return!0}}function f(t){this._down=!0;let e=this._keyEvent;if(e.key=t.button,e.event="down",e.value=1,this.handler.call(void 0,e)&&document.activeElement===this.target)return t.preventDefault(),t.stopPropagation(),!1}function g(t){if(this._down){this._down=!1;let e=this._keyEvent;if(e.key=t.button,e.event="up",e.value=1,this.handler.call(void 0,e))return t.preventDefault(),t.stopPropagation(),!1}}function v(t){let e=this.target,{clientWidth:n,clientHeight:i}=e,s=this.target.getBoundingClientRect(),r=t.movementX/n,a=t.movementY/i,o=(t.clientX-s.left)/n,h=(t.clientY-s.top)/i,l=this._posEvent;if(l.x=o,l.y=h,l.dx=r,l.dy=a,void 0!==this.handler.call(void 0,l))throw new Error("Return value must be 'undefined'. Mouse position and movement events cannot be consumed.")}function b(t){return t.preventDefault(),t.stopPropagation(),!1}const y=Symbol("template"),w=Symbol("style");class E extends HTMLElement{static toInputMap(t){let e={};for(let n of t)if(n instanceof E){let t,i=n.input;switch(i in e?t=e[i]:e[i]=t=[],n.type){case"action":t.push({key:n.key,event:n.event});break;case"range":t.push({key:n.key,scale:n.scale});break;default:throw new Error("Unknown input type.")}}return e}static get[y](){let t=document.createElement("template");return t.innerHTML="\n<kbd></kbd>",Object.defineProperty(this,y,{value:t}),t}static get[w](){let t=document.createElement("style");return t.innerHTML="\n:host {\n    display: inline-block;\n}\nkbd {\n    background-color: #EEEEEE;\n    border-radius: 3px;\n    border: 1px solid #B4B4B4;\n    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;\n    color: #333333;\n    font-size: 0.85em;\n    font-weight: 700;\n    line-height: 1;\n    padding: 2px 4px;\n    white-space: nowrap;\n}\n",Object.defineProperty(this,w,{value:t}),t}static get observedAttributes(){return["input","key","scale","event"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[y].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[w].cloneNode(!0)),this.keyElement=this.shadowRoot.querySelector("kbd")}attributeChangedCallback(t,e,n){switch(t){case"key":this.keyElement.textContent=n}}get type(){return this.hasAttribute("event")?"action":"range"}get input(){return this.getAttribute("input")}set input(t){this.setAttribute("input",t)}get key(){return this.getAttribute("key")}set key(t){this.setAttribute("key",t)}get scale(){return Number(this.getAttribute("scale"))}set scale(t){this.setAttribute("scale",t)}get event(){return this.getAttribute("event")}set event(t){this.setAttribute("event",t)}}window.customElements.define("input-key",E);class x{constructor(t,e){this.inputName=t,this.inputType=e,this.value=0,this._onchange=null,this._eventListeners=new Map}update(t){if(this.value!==t){if(this.value=t,this._eventListeners.has("change"))for(let t of this._eventListeners.get("change"))t.call(void 0,this);return!0}return!1}get onchange(){return this._onchange}set onchange(t){this._onchange&&this.removeEventListener("change",this._onchange),this._onchange=t,this.addEventListener("change",t)}addEventListener(t,e){if(this._eventListeners.has(t)){this._eventListeners.get(t).push(e)}else this._eventListeners.set(t,[e])}removeEventListener(t,e){if(this._eventListeners.has(t)){let n=this._eventListeners.get(t);n.splice(n.indexOf(e),1)}}toString(){return this.value}}class _{constructor(t,e,n){this.keyName=t,this.keyEvent=e,this.scale=n,this.value=0}consumeKey(){this.value=0}updateKey(t,e){if(e===this.keyName)if(this.keyEvent){if(this.keyEvent===t.event)return this.value=t.value*this.scale,!0}else switch(t.event){case"down":return this.value=this.scale,!0;case"up":return this.value=0,!0;default:return void(this.value=t.value*this.scale)}}}const k=Symbol("template"),N=Symbol("style");class A extends HTMLElement{static get[k](){let t=document.createElement("template");return t.innerHTML='\n<table>\n    <thead>\n        <tr class="header">\n            <th id="title" colspan=3>input-context</th>\n            <th id="poll">&nbsp;</th>\n        </tr>\n        <tr class="hint">\n            <th>input</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n<slot></slot>',Object.defineProperty(this,k,{value:t}),t}static get[N](){let t=document.createElement("style");return t.innerHTML='\n:host {\n    display: inline-block;\n}\nslot {\n    display: none;\n}\ntable {\n    border-collapse: collapse;\n}\ntable, th, td {\n    border: 1px solid gray;\n}\n#poll {\n    position: relative;\n    font-size: 0.9em;\n}\n#poll:after {\n    content: "(poll)";\n    position: absolute;\n    left: 0;\n    right: 0;\n    z-index: -1;\n    opacity: 0.1;\n    font-family: monospace;\n    letter-spacing: 3px;\n    overflow: hidden;\n}\n.hint > th {\n    font-size: 0.5em;\n    font-family: monospace;\n    padding: 0 10px;\n    letter-spacing: 3px;\n    background-color: #AAA;\n    color: #666666;\n}\nth, td {\n    padding: 5px 10px;\n}\ntd {\n    text-align: center;\n}\nkbd {\n    display: inline-block;\n    background-color: #EEEEEE;\n    border-radius: 3px;\n    border: 1px solid #B4B4B4;\n    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;\n    color: #333333;\n    font-size: 0.85em;\n    font-weight: 700;\n    line-height: 1;\n    padding: 2px 4px;\n    white-space: nowrap;\n}\noutput {\n    font-family: monospace;\n    border-radius: 0.3em;\n    padding: 3px;\n}\n.flash {\n    animation: fadein 4s;\n}\n@keyframes fadein {\n    0%, 10% { background-color: rgba(0, 0, 255, 0.3); }\n    100% { background-color: rgba(0, 0, 255, 0); }\n}\n',Object.defineProperty(this,N,{value:t}),t}static get observedAttributes(){return["for","strict","onattach","ondetach","id","class"]}constructor(t=null){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[k].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[N].cloneNode(!0)),this._onattach=null,this._ondetach=null,this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._tableBody=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot"),this._tableInputs={},this._lastPollTime=0,this._pollWarningTimeoutHandle=0,this._animationFrameHandle=0,this._inputTarget=null,this._inputMap=t,this._inputs={},this._inputKeys={},this._keys={},this.onInputEvent=this.onInputEvent.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this),t&&M(this,t)}connectedCallback(){if(this.hasAttribute("for")||this.setAttribute("for",""),!this._inputMap){this._inputMap={};const t=E.toInputMap(this._children.assignedNodes()),e=this.src;e?fetch(e).then(t=>t.json()).then(e=>{this._inputMap={...e,...t},M(this,this._inputMap)}):(this._inputMap={...t},M(this,this._inputMap))}this._lastPollTime=0,this._pollWarningTimeoutHandle=setTimeout(()=>{this._lastPollTime<=0?(this._pollElement.textContent="✗",console.warn("[INPUT] No input updated. Did you forget to poll() the input context?")):this._pollElement.textContent="✓"},3e3),this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame)}disconnectedCallback(){cancelAnimationFrame(this._animationFrameHandle),clearTimeout(this._pollWarningTimeoutHandle)}attributeChangedCallback(t,e,n){switch(t){case"for":let t;t=n?document.getElementById(n):document.querySelector("display-port")||document.querySelector("canvas"),this._inputTarget&&this.detach(),t&&this.attach(t);break;case"onattach":this.onattach=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"ondetach":this.ondetach=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"id":case"class":this._titleElement.innerHTML=`input-context${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}}get src(){return this.getAttribute("src")}set src(t){this.setAttribute("src",t)}get for(){return this.getAttribute("for")}set for(t){this.setAttribute("for",t)}get strict(){return this.hasAttribute("strict")}set strict(t){t?this.setAttribute("strict",""):this.removeAttribute("strict")}get auto(){return this.hasAttribute("auto")}set auto(t){t?this.setAttribute("auto",""):this.removeAttribute("auto")}get onattach(){return this._onattach}set onattach(t){this._onattach&&this.removeEventListener("attach",this._onattach),this._onattach=t,this._onattach&&this.addEventListener("attach",t)}get ondetach(){return this._ondetach}set ondetach(t){this._ondetach&&this.removeEventListener("detach",this._ondetach),this._ondetach=t,this._ondetach&&this.addEventListener("detach",t)}attach(t){if(!t)throw new Error("Cannot attach input context to null.");if(this._inputTarget){if(this._inputTarget!==t)throw new Error("Input context already attached to another element.");return this}let e=t;return e&&(e.canvas?(u.addInputEventListener(e,this.onInputEvent),m.addInputEventListener(e.canvas,this.onInputEvent)):(u.addInputEventListener(e,this.onInputEvent),m.addInputEventListener(e,this.onInputEvent)),this.dispatchEvent(new CustomEvent("attach",{composed:!0,bubbles:!1,detail:{eventTarget:e,inputCallback:this.onInputEvent}}))),this._inputTarget=e,this}detach(){if(!this._inputTarget)return this;let t=this._inputTarget;return this._inputTarget=null,t.canvas?(u.removeInputEventListener(t,this.onInputEvent),m.removeInputEventListener(t.canvas,this.onInputEvent)):(u.removeInputEventListener(t,this.onInputEvent),m.removeInputEventListener(t,this.onInputEvent)),this.dispatchEvent(new CustomEvent("detach",{composed:!0,bubbles:!1,detail:{eventTarget:t,inputCallback:this.onInputEvent}})),this}poll(){this._lastPollTime=performance.now();for(let t in this._inputs){let e=this._inputs[t];switch(e.inputType){case"action":let n=!1;for(let i of this._inputKeys[t]){let t=i.value;if(t){e.update(t,i),i.consumeKey(),n=!0;break}}n||e.update(0,null);break;case"range":let i=0;for(let e of this._inputKeys[t])i+=e.value;e.update(i,null);break;default:throw new Error("Unknown input type.")}}}onInputEvent(t){let e=t.type;switch(e){case"key":{const e=t.device+":"+t.key;if(e in this._keys){let n=!1;for(let i of this._keys[e])i.updateKey(t,e)&&(n=!0);if(n)return!0}}break;case"pos":{const e=["x","y","dx","dy"];for(let n of e){t.value=t[n];const e=t.device+":"+t.key+"."+n;if(e in this._keys){let n=!1;for(let i of this._keys[e])i.updateKey(t,e)&&(n=!0);if(n)return!0}}}break;default:throw new Error(`Unknown input event type '${e}'.`)}}onAnimationFrame(t){this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.auto&&this.poll();for(let t in this._inputs){let e,n=this._inputs[t];e=n.value?Number(n.value).toFixed(2):0;let i=this._tableInputs[t];if(i.textContent!=e){i.textContent=e;let t=i.parentNode;i.parentNode.removeChild(i),t.appendChild(i)}}}getInput(t){if(t in this._inputs)return this._inputs[t];if(this.strict)throw new Error(`Cannot find input with name '${t}'.`);{let e=new x(t,"range");return this._inputs[t]=e,e}}getInputValue(t){if(t in this._inputs)return this._inputs[t].value;if(this.strict)throw new Error(`Cannot find input with name '${t}'.`);return 0}}function M(t,e){for(let n in e){let i=e[n];if(Array.isArray(i))for(let e of i)T(t,n,e),"string"==typeof e&&(e={key:e,event:"down"}),L(t,n,e);else T(t,n,i),"string"==typeof i&&(i={key:i,event:"down"}),L(t,n,i)}}function I(t){if("object"==typeof t){if("type"in t)return t.type;if("scale"in t)return"range";if("event"in t)return"action";throw new Error(`Missing 'scale' or 'event' for input option '${inputName}'.`)}if("string"==typeof t)return"action";throw new Error("Invalid type for input mapping option.")}function L(t,e,n){let i=document.createElement("tr");{let t=document.createElement("td");t.textContent=e,t.classList.add("name"),i.appendChild(t)}{let t=document.createElement("td");t.classList.add("key");let e=document.createElement("kbd");e.textContent=n.key,t.appendChild(e),i.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp");switch(I(n)){case"action":e.textContent=n.event;break;case"range":e.textContent=Number(n.scale).toFixed(2);break;default:e.textContent="<?>"}t.classList.add("mod"),t.appendChild(e),i.appendChild(t)}if(e in t._tableInputs){let t=document.createElement("td");t.classList.add("value"),i.appendChild(t)}else{let n=document.createElement("td"),s=document.createElement("output");s.textContent=0,s.classList.add("flash"),n.classList.add("value"),n.appendChild(s),i.appendChild(n),t._tableInputs[e]=s}t._tableBody.appendChild(i)}function T(t,e,n){let i=I(n);switch(i){case"action":C(t,e,"string"==typeof n?{key:n,event:"down"}:n);break;case"range":!function(t,e,n){const{key:i,scale:s}=n;let r,a,o;if(e in t._inputs){if(r=t._inputs[e],a=t._inputKeys[e],"range"!==r.inputType)throw new Error(`Cannot register mismatched 'range' type input for '${r.inputType}' type input '${e}'.`)}else r=new x(e,"range"),a=[],t._inputs[e]=r,t._inputKeys[e]=a;i in t._keys?o=t._keys[i]:(o=[],t._keys[i]=o);let h=new _(i,null,s);o.push(h),a.push(h)}(t,e,n);break;default:throw new Error(`Unknown input type '${i}'.`)}}function C(t,e,n){const{key:i,event:s}=n;let r,a,o;if(e in t._inputs){if(r=t._inputs[e],a=t._inputKeys[e],"action"!==r.inputType)throw new Error(`Cannot register mismatched 'action' type input for '${r.inputType}' type input '${e}'.`)}else r=new x(e,"action"),a=[],t._inputs[e]=r,t._inputKeys[e]=a;i in t._keys?o=t._keys[i]:(o=[],t._keys[i]=o);let h=new _(i,s,1);o.push(h),a.push(h)}window.customElements.define("input-context",A);class S{next(){return Math.random()}}let F;class R{constructor(t=new S){this.generator=t}static next(){return F.next()}next(){return this.generator.next()}static choose(t){return F.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return F.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static sign(){return F.sign()}sign(){return this.generator.next()<.5?-1:1}}F=new R;var K="undefined"!=typeof Float32Array?Float32Array:Array;function B(){var t=new K(16);return K!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function P(){var t=new K(3);return K!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function q(t,e,n){var i=new K(3);return i[0]=t,i[1]=e,i[2]=n,i}function $(t,e,n){var i=e[0],s=e[1],r=e[2],a=n[0],o=n[1],h=n[2];return t[0]=s*h-r*o,t[1]=r*a-i*h,t[2]=i*o-s*a,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var j,H=function(t){var e=t[0],n=t[1],i=t[2];return Math.hypot(e,n,i)};j=P();!function(){var t,e=(t=new K(4),K!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function O(){var t=new K(4);return K!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function U(t,e,n,i){var s,r,a,o,h,l=e[0],u=e[1],d=e[2],c=e[3],p=n[0],m=n[1],f=n[2],g=n[3];return(r=l*p+u*m+d*f+c*g)<0&&(r=-r,p=-p,m=-m,f=-f,g=-g),1-r>1e-6?(s=Math.acos(r),a=Math.sin(s),o=Math.sin((1-i)*s)/a,h=Math.sin(i*s)/a):(o=1-i,h=i),t[0]=o*l+h*p,t[1]=o*u+h*m,t[2]=o*d+h*f,t[3]=o*c+h*g,t}var W,D,z,G,V,X,Y,J=function(t,e){var n=e[0],i=e[1],s=e[2],r=e[3],a=n*n+i*i+s*s+r*r;return a>0&&(a=1/Math.sqrt(a)),t[0]=n*a,t[1]=i*a,t[2]=s*a,t[3]=r*a,t};W=P(),D=q(1,0,0),z=q(0,1,0),G=O(),V=O(),X=new K(9),K!=Float32Array&&(X[1]=0,X[2]=0,X[3]=0,X[5]=0,X[6]=0,X[7]=0),X[0]=1,X[4]=1,X[8]=1,Y=X;q(0,0,0),q(1,0,0),q(0,1,0),q(0,0,1);function Q(t){const e=[],n=[],i=[],s=[],r=[],a=[],o=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,h=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,l=/vt\s+(\S+)\s+(\S+)/g,u=/f\s+(([^\/\s]*)\/([^\/\s]*)\/?([^\/\s]*))\s+(([^\/\s]*)\/([^\/\s]*)\/?([^\/\s]*))\s+(([^\/\s]*)\/([^\/\s]*)\/?([^\/\s]*))(\s+(([^\/\s]*)\/([^\/\s]*)\/?([^\/\s]*)))?/g,d=/f\s+([^\/\s]+)\s+([^\/\s]+)\s+([^\/\s]+)/g;let c,p,m,f,g,v,b=!1,y=null;for(t=t.replace(/^#.*/g,"");null!=(y=o.exec(t));)c=Number.parseFloat(y[1]),p=Number.parseFloat(y[2]),m=Number.parseFloat(y[3]),e.push(c),e.push(p),e.push(m);for(;null!=(y=h.exec(t));)c=Number.parseFloat(y[1]),p=Number.parseFloat(y[2]),m=Number.parseFloat(y[3]),i.push(c),i.push(p),i.push(m);for(;null!=(y=l.exec(t));)c=Number.parseFloat(y[1]),p=Number.parseFloat(y[2]),n.push(c),n.push(p);for(;null!=(y=u.exec(t));)c=Number.parseInt(y[2]),Number.isNaN(c)&&(c=1),p=Number.parseInt(y[6]),Number.isNaN(p)&&(p=1),m=Number.parseInt(y[10]),Number.isNaN(m)&&(m=1),s.push(c),s.push(p),s.push(m),c=Number.parseInt(y[4]),Number.isNaN(c)?(c=Number.parseInt(y[3]),p=Number.parseInt(y[7]),m=Number.parseInt(y[11]),a.push(c),a.push(p),a.push(m),r.push(1),r.push(1),r.push(1)):(p=Number.parseInt(y[8]),Number.isNaN(p)&&(p=1),m=Number.parseInt(y[12]),Number.isNaN(m)&&(m=1),a.push(c),a.push(p),a.push(m),c=Number.parseInt(y[3]),Number.isNaN(c)&&(c=1),p=Number.parseInt(y[7]),Number.isNaN(p)&&(p=1),m=Number.parseInt(y[11]),Number.isNaN(m)&&(m=1),r.push(c),r.push(p),r.push(m)),void 0!==y[13]&&(f=Number.parseInt(y[15]),Number.isNaN(f)&&(f=1),s.push(f),f=Number.parseInt(y[17]),Number.isNaN(f)?(f=Number.parseInt(y[16]),a.push(f),r.push(1)):(a.push(f),f=Number.parseInt(y[16]),r.push(f)),b=!0);for(;null!=(y=d.exec(t));)c=Number.parseInt(y[2]),p=Number.parseInt(y[6]),m=Number.parseInt(y[10]),s.push(c),s.push(p),s.push(m),r.push(1),r.push(1),r.push(1),a.push(1),a.push(1),a.push(1),void 0!==y[13]&&(f=Number.parseInt(y[14]),s.push(f),r.push(1),a.push(1),b=!0);v=s.length;const w=new Float32Array(3*v);for(let t=0;t<v;++t)g=s[t]-1,w[3*t+0]=e[3*g+0],w[3*t+1]=e[3*g+1],w[3*t+2]=e[3*g+2];v=r.length;const E=new Float32Array(2*v);for(let t=0;t<v;++t)g=r[t]-1,E[2*t+0]=n[2*g+0],E[2*t+1]=n[2*g+1];v=a.length;const x=new Float32Array(3*v);for(let t=0;t<v;++t)g=a[t]-1,x[3*t+0]=i[3*g+0],x[3*t+1]=i[3*g+1],x[3*t+2]=i[3*g+2];v=s.length;const _=new Uint16Array(v);for(let t=0;t<v;++t)_[t]=t;return b&&console.warn("WebGL does not support quad faces, only triangles."),{positions:w,texcoords:E,normals:x,indices:_}}function Z(t){const e=[],n=[],i=[],s=[],r=[],a=[],o=/v( +[\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)/g,h=/vn( +[\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)/g,l=/vt( +[\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)/g,u=/f( +([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))?/g,d=/f( +[\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)( [\d|\.|\+|\-|e]+)/g;let c,p,m,f,g,v,b=!1,y=null;for(t=t.replace(/^#.*/g,"");null!=(y=o.exec(t));)c=Number.parseFloat(y[1]),p=Number.parseFloat(y[2]),m=Number.parseFloat(y[3]),e.push(c),e.push(p),e.push(m);for(;null!=(y=h.exec(t));)c=Number.parseFloat(y[1]),p=Number.parseFloat(y[2]),m=Number.parseFloat(y[3]),i.push(c),i.push(p),i.push(m);for(;null!=(y=l.exec(t));)c=Number.parseFloat(y[1]),p=Number.parseFloat(y[2]),n.push(c),n.push(p);for(;null!=(y=u.exec(t));)c=Number.parseInt(y[2]),Number.isNaN(c)&&(c=1),p=Number.parseInt(y[6]),Number.isNaN(p)&&(p=1),m=Number.parseInt(y[10]),Number.isNaN(m)&&(m=1),s.push(c),s.push(p),s.push(m),c=Number.parseInt(y[3]),Number.isNaN(c)&&(c=1),p=Number.parseInt(y[7]),Number.isNaN(p)&&(p=1),m=Number.parseInt(y[11]),Number.isNaN(m)&&(m=1),r.push(c),r.push(p),r.push(m),c=Number.parseInt(y[4]),Number.isNaN(c)&&(c=1),p=Number.parseInt(y[8]),Number.isNaN(p)&&(p=1),m=Number.parseInt(y[12]),Number.isNaN(m)&&(m=1),a.push(c),a.push(p),a.push(m),void 0!==y[13]&&(f=Number.parseInt(y[14]),Number.isNaN(f)&&(f=1),s.push(f),f=Number.parseInt(y[15]),Number.isNaN(f)&&(f=1),r.push(f),f=Number.parseInt(y[16]),Number.isNaN(f)&&(f=1),a.push(f),b=!0);for(;null!=(y=d.exec(t));)c=Number.parseInt(y[2]),p=Number.parseInt(y[6]),m=Number.parseInt(y[10]),s.push(c),s.push(p),s.push(m),r.push(1),r.push(1),r.push(1),a.push(1),a.push(1),a.push(1),void 0!==y[13]&&(f=Number.parseInt(y[14]),s.push(f),r.push(1),a.push(1),b=!0);v=s.length;const w=new Float32Array(3*v);for(let t=0;t<v;++t)g=s[t]-1,w[3*t+0]=e[3*g+0],w[3*t+1]=e[3*g+1],w[3*t+2]=e[3*g+2];v=r.length;const E=new Float32Array(2*v);for(let t=0;t<v;++t)g=r[t]-1,E[2*t+0]=n[2*g+0],E[2*t+1]=n[2*g+1];v=a.length;const x=new Float32Array(3*v);for(let t=0;t<v;++t)g=a[t]-1,x[3*t+0]=i[3*g+0],x[3*t+1]=i[3*g+1],x[3*t+2]=i[3*g+2];v=s.length;const _=new Uint16Array(v);for(let t=0;t<v;++t)_[t]=t;return b&&console.warn("WebGL does not support quad faces, only triangles."),{positions:w,texcoords:E,normals:x,indices:_}}let tt={};function et(t,e){tt[t]=e}function nt(t){if(t in tt)return tt[t];throw new Error(`Unknown asset type '${t}'.`)}async function it(t,e={},n="."){if(t.indexOf(":")<0)throw new Error("Missing type for asset source.");let[i,s]=t.split(":"),r=nt(i);return await r(n+"/"+s,e)}et("image",(async function(t,e){return new Promise((e,n)=>{let i=new Image;i.addEventListener("load",()=>{e(i)}),i.addEventListener("error",t=>{n(t)}),i.src=t})})),et("text",(async function(t,e){return(await fetch(t)).text()})),et("json",(async function(t,e){let n=await fetch(t);return await n.json()})),et("bytes",(async function(t,e){let n=await fetch(t);return await n.arrayBuffer()})),et("obj",(async function(t,e){let n=await fetch(t),i=await n.text();{const t=10;for(let e=0;e<t;++e){performance.now();Z(i);performance.now()}}{const t=10;for(let e=0;e<t;++e){performance.now();Q(i);performance.now()}}return Q(i)}));var st=Object.freeze({__proto__:null,defineAssetLoader:et,getAssetLoader:nt,loadAssetMap:async function(t,e="."){let n={};for(let i of Object.keys(t)){let s=t[i];if("string"==typeof s)n[i]=await it(s,void 0,e);else{if("object"!=typeof s)throw new Error("Unknown entry type in asset map.");if(!("src"in s))throw new Error("Missing required field 'src' for entry in asset map.");if("name"in s&&s.name!==i)throw new Error(`Cannot redefine name for asset '${i}' for entry in asset map.`);n[i]=await it(s.src,s,e)}}return n},loadAssetList:async function(t,e="."){let n={};for(let i of t)if("string"==typeof i)n[i]=await it(i,void 0,e);else{if("object"!=typeof i)throw new Error("Unknown entry type in asset list.");if(!("src"in i))throw new Error("Missing required field 'src' for entry in asset list.");n["name"in i?i.name:i.src]=await it(i.src,i,e)}return n},loadAsset:it});function rt(t,e,n){return Math.min(n,Math.max(e,t))}!async function(t){document.addEventListener("click",()=>{"suspended"===t.state&&t.resume()})}(new AudioContext);class at{constructor(t,e,n=new R){this.width=t,this.height=e,this.length=t*e,this.rand=n,this.dangerCount=.2*this.length,this.data={tiles:new Array(length),overlay:new Array(length),regions:new Array(length),solids:new Array(length),marks:new Array(length)},ot(this,this.dangerCount,this.rand)}dig(t,e){const n=this.width,i=this.height;let s=this.data,r=t+e*n;if(s.solids[r]<=0)return!0;if(s.marks[r]>0)return!0;if(s.tiles[r]>0)return s.solids[r]=0,!1;let a=new Set,o=[];for(o.push(r);o.length>0;){let t=o.pop();a.add(t);let e=t%n,r=Math.floor(t/n);if(s.solids[t]=0,s.overlay[t]<=0){let t=lt(e,r,n,i);for(let e of t)!a.has(e)&&s.marks[e]<=0&&o.push(e)}}return!0}mark(t,e){const n=this.width;let i=this.data,s=t+e*n;return!(i.solids[s]<=0)&&(i.marks[s]>0?i.marks[s]=0:i.marks[s]=1,!0)}checkWinCondition(){const t=this.data;for(let e=0;e<t.tiles.length;++e)if(t.solids[e]>0&&t.tiles[e]<=0)return!1;return!0}reset(){ot(this,this.dangerCount,this.rand)}clear(){let t=this.data;for(let e=0;e<this.length;++e)t.tiles[e]=0,t.overlay[e]=0,t.solids[e]=1,t.regions[e]=0,t.marks[e]=0}}function ot(t,e,n){t.clear();const i=t.width,s=t.height,r=t.rand;let a=t.data;for(let t=0;t<e;++t){let e=Math.floor(n.range(0,i)),r=Math.floor(n.range(0,s)),o=e+r*i,h=1;if(0===a.tiles[o]){a.tiles[o]+=h,a.overlay[o]=1/0;for(let t of lt(e,r,i,s))a.overlay[t]+=h}else--t}const o=Array.from(function(t,e,n,i){const s=t.tiles.length;let r=new Map,a=new Map,o=1;for(let h=0;h<s;++h)if(i(h))t.regions[h]=-1;else{let s=ht(t,e,n,h,o++,i);if(s){if(a.has(s.tileIndex)){const t=a.get(s.tileIndex);r.delete(t),a.delete(s.tileIndex)}a.set(s.tileIndex,s.regionIndex),r.set(s.regionIndex,s)}}return r}(a,i,s,t=>a.overlay[t]>0).values()).sort((t,e)=>t.count-e.count),h=[[o[0]]];let l=0;for(let t of o)h[l][0].count!==t.count?h[++l]=[t]:h[l].push(t);let u=h[Math.floor(h.length/2)],d=r.choose(u).tileIndex,c=d%i,p=Math.floor(d/i);t.dig(c,p)}function ht(t,e,n,i,s,r){let a=1/0,o=new Set,h=[];for(h.push(i);h.length>0;){let i=h.pop();if(r(i))continue;o.add(i);let l=i%e,u=Math.floor(i/e);t.regions[i]=s,i<a&&(a=i);let d=lt(l,u,e,n);for(let t of d)o.has(t)||h.push(t)}return a<1/0?{tileIndex:a,regionIndex:s,count:o.size}:null}function lt(t,e,n,i){let s=[],r=t+e*n;return t>0&&s.push(r-1),t<n-1&&s.push(r+1),e>0&&s.push(r-n),e<i-1&&s.push(r+n),t>0&&e>0&&s.push(r-1-n),t<n-1&&e>0&&s.push(r+1-n),t>0&&e<i-1&&s.push(r-1+n),t<n-1&&e<i-1&&s.push(r+1+n),s}const ut=new A({activate:{key:"mouse:0",event:"up"},mark:{key:"mouse:2",event:"up"},restart:{key:"keyboard:KeyR",event:"up"},cursorX:{key:"mouse:pos.x",scale:1},cursorY:{key:"mouse:pos.y",scale:1}}),dt=ut.getInput("cursorX"),ct=ut.getInput("cursorY"),pt=ut.getInput("activate"),mt=ut.getInput("mark"),ft=ut.getInput("restart");class gt{static screenToWorld(t,e,n,i){let s=function(t,e,n){var i=e[0],s=e[1],r=e[2],a=e[3],o=e[4],h=e[5],l=e[6],u=e[7],d=e[8],c=e[9],p=e[10],m=e[11],f=e[12],g=e[13],v=e[14],b=e[15],y=n[0],w=n[1],E=n[2],x=n[3];return t[0]=y*i+w*o+E*d+x*f,t[1]=y*s+w*h+E*c+x*g,t[2]=y*r+w*l+E*p+x*v,t[3]=y*a+w*u+E*m+x*b,y=n[4],w=n[5],E=n[6],x=n[7],t[4]=y*i+w*o+E*d+x*f,t[5]=y*s+w*h+E*c+x*g,t[6]=y*r+w*l+E*p+x*v,t[7]=y*a+w*u+E*m+x*b,y=n[8],w=n[9],E=n[10],x=n[11],t[8]=y*i+w*o+E*d+x*f,t[9]=y*s+w*h+E*c+x*g,t[10]=y*r+w*l+E*p+x*v,t[11]=y*a+w*u+E*m+x*b,y=n[12],w=n[13],E=n[14],x=n[15],t[12]=y*i+w*o+E*d+x*f,t[13]=y*s+w*h+E*c+x*g,t[14]=y*r+w*l+E*p+x*v,t[15]=y*a+w*u+E*m+x*b,t}(B(),i,n);!function(t,e){var n=e[0],i=e[1],s=e[2],r=e[3],a=e[4],o=e[5],h=e[6],l=e[7],u=e[8],d=e[9],c=e[10],p=e[11],m=e[12],f=e[13],g=e[14],v=e[15],b=n*o-i*a,y=n*h-s*a,w=n*l-r*a,E=i*h-s*o,x=i*l-r*o,_=s*l-r*h,k=u*f-d*m,N=u*g-c*m,A=u*v-p*m,M=d*g-c*f,I=d*v-p*f,L=c*v-p*g,T=b*L-y*I+w*M+E*A-x*N+_*k;T&&(T=1/T,t[0]=(o*L-h*I+l*M)*T,t[1]=(s*I-i*L-r*M)*T,t[2]=(f*_-g*x+v*E)*T,t[3]=(c*x-d*_-p*E)*T,t[4]=(h*A-a*L-l*N)*T,t[5]=(n*L-s*A+r*N)*T,t[6]=(g*w-m*_-v*y)*T,t[7]=(u*_-c*w+p*y)*T,t[8]=(a*I-o*A+l*k)*T,t[9]=(i*A-n*I-r*k)*T,t[10]=(m*x-f*w+v*b)*T,t[11]=(d*w-u*x-p*b)*T,t[12]=(o*N-a*M-h*k)*T,t[13]=(n*M-i*N+s*k)*T,t[14]=(f*y-m*E-g*b)*T,t[15]=(u*E-d*y+c*b)*T)}(s,s);let r=q(t,e,0);return function(t,e,n){var i=e[0],s=e[1],r=e[2],a=n[3]*i+n[7]*s+n[11]*r+n[15];a=a||1,t[0]=(n[0]*i+n[4]*s+n[8]*r+n[12])/a,t[1]=(n[1]*i+n[5]*s+n[9]*r+n[13])/a,t[2]=(n[2]*i+n[6]*s+n[10]*r+n[14])/a}(r,r,s),r}constructor(t=-1,e=1,n=-1,i=1,s=0,r=1){this.position=P(),this.rotation=O(),this.scale=q(1,1,1),this.clippingPlane={left:t,right:e,top:n,bottom:i,near:s,far:r},this._viewMatrix=B(),this._projectionMatrix=B()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,n=0,i=1){let s=q(t,e,n);!function(t,e,n,i){var s=e[0],r=e[1],a=e[2];t[0]=s+i*(n[0]-s),t[1]=r+i*(n[1]-r),t[2]=a+i*(n[2]-a)}(this.position,this.position,s,Math.min(1,i))}getViewMatrix(t=this._viewMatrix){let e=-Math.round(this.x),n=-Math.round(this.y),i=0===this.z?1:1/this.z,s=q(e,n,0),r=q(this.scale[0]*i,this.scale[1]*i,1);return function(t,e,n,i){var s=e[0],r=e[1],a=e[2],o=e[3],h=s+s,l=r+r,u=a+a,d=s*h,c=s*l,p=s*u,m=r*l,f=r*u,g=a*u,v=o*h,b=o*l,y=o*u,w=i[0],E=i[1],x=i[2];t[0]=(1-(m+g))*w,t[1]=(c+y)*w,t[2]=(p-b)*w,t[3]=0,t[4]=(c-y)*E,t[5]=(1-(d+g))*E,t[6]=(f+v)*E,t[7]=0,t[8]=(p+b)*x,t[9]=(f-v)*x,t[10]=(1-(d+m))*x,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(t,this.rotation,s,r),t}getProjectionMatrix(t=this._projectionMatrix){let{left:e,right:n,top:i,bottom:s,near:r,far:a}=this.clippingPlane;return function(t,e,n,i,s,r,a){var o=1/(e-n),h=1/(i-s),l=1/(r-a);t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+n)*o,t[13]=(s+i)*h,t[14]=(a+r)*l,t[15]=1}(t,e,n,i,s,r,a),t}}class vt{constructor(){this.prevTransformMatrix=null,this.domProjectionMatrix=new DOMMatrix,this.domViewMatrix=new DOMMatrix,this.ctx=null}begin(t,e,n){if(this.ctx)throw new Error("View already begun - maybe missing end() call?");e&&bt(this.domViewMatrix,e),n&&bt(this.domProjectionMatrix,n),this.prevTransformMatrix=t.getTransform(),t.setTransform(this.domProjectionMatrix);const{a:i,b:s,c:r,d:a,e:o,f:h}=this.domViewMatrix;t.transform(i,s,r,a,o,h),this.ctx=t}end(t){t.setTransform(this.prevTransformMatrix),this.ctx=null}}function bt(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}const yt=16;function wt(){this.mines=new at(16,16),this.minesView=new vt,this.camera=new gt,this.camera.x=-32,this.camera.y=-32,this.firstAction=!1,this.health=3,this.gameOver=!1,this.gameWin=!1,this.gameTime=0}function Et(t){}function xt(t){var e,n;if(ft.value)_t(this);else if(this.gameOver||this.gameWin){if(pt.value||mt.value)return void _t(this)}else{const i=this.display.width,s=this.display.height;this.firstAction&&(this.gameTime+=t);let r=!1;if(pt.value){let t=dt.value*i,a=ct.value*s,o=gt.screenToWorld(t,a,this.camera.getViewMatrix(),this.camera.getProjectionMatrix()),h=rt(Math.floor(o[0]/yt),0,this.mines.width-1),l=rt(Math.floor(o[1]/yt),0,this.mines.height-1);this.mines.dig(h,l)||(n=1,(e=this).health-=n,e.health<=0&&function(t){t.gameOver=!0}(e)),this.mines.checkWinCondition()&&function(t){t.gameWin=!0}(this),r=!0}if(mt.value){let t=dt.value*i,e=ct.value*s,n=gt.screenToWorld(t,e,this.camera.getViewMatrix(),this.camera.getProjectionMatrix()),a=rt(Math.floor(n[0]/yt),0,this.mines.width-1),o=rt(Math.floor(n[1]/yt),0,this.mines.height-1);this.mines.mark(a,o),r=!0}r&&!this.firstAction&&(this.firstAction=!0)}}function _t(t){t.mines.reset(),t.gameOver=!1,t.gameWin=!1,t.gameTime=0,t.firstAction=!1,t.health=3}const kt={LOADED:!1,TILE_IMAGE:null,NUMS_IMAGE:null,MARK_IMAGE:null};async function Nt(){await async function(){kt.TILE_IMAGE=await st.loadAsset("image:mines/tile.png",{}),kt.NUMS_IMAGE=await st.loadAsset("image:mines/nums.png",{}),kt.MARK_IMAGE=await st.loadAsset("image:mines/flag.png",{}),kt.LOADED=!0}()}function At(t,e){let n=t.context;const i=e.camera.getViewMatrix(),s=e.camera.getProjectionMatrix();e.minesView.begin(n,i,s),function(t,e,n=16){if(!kt.LOADED)throw new Error("Assets for this renderer have not yet been loaded.");const i=e.width,s=e.height,r=e.data,a=n/2;t.fillStyle="#777777",t.fillRect(0,0,i*n,s*n),function(t,e,n,i,s,r,a){t.strokeStyle="#888888",t.beginPath();for(let r=0;r<s;r+=a)t.moveTo(e,r+n),t.lineTo(e+i,r+n);for(let a=0;a<i;a+=r)t.moveTo(a+e,n),t.lineTo(a+e,n+s);t.stroke()}(t,0,0,i*n,s*n,n,n);for(let e=0;e<s;++e)for(let s=0;s<i;++s){let o=s*n,h=e*n,l=s+e*i;if(r.solids[l]>0)t.drawImage(kt.TILE_IMAGE,o,h,n,n),r.marks[l]>0&&t.drawImage(kt.MARK_IMAGE,o,h,n,n);else if(r.tiles[l]>0)t.fillStyle="rgba(0, 0, 0, 0.2)",t.fillRect(o,h,n,n),t.textAlign="center",t.textBaseline="middle",t.font="10px sans-serif",t.fillStyle="#000000",t.fillText("X",o+a,h+a);else if(r.overlay[l]>0){let e=r.overlay[l]-1;t.drawImage(kt.NUMS_IMAGE,32*e,0,32,32,o,h,n,n)}}}(n,e.mines,yt),e.minesView.end(n);const r=e.mines.width,a=e.mines.height,o=32,h=yt;let l=dt.value*t.width,u=ct.value*t.height,d=gt.screenToWorld(l,u,i,s),c=rt(Math.floor(d[0]/h),0,r-1),p=rt(Math.floor(d[1]/h),0,a-1);n.fillStyle="rgba(0, 0, 0, 0.2)",n.fillRect(32+c*h,o+p*h,h,h),n.fillStyle="rgba(0, 0, 0, 0.3)",n.fillRect(0,0,t.width,o),n.fillRect(0,t.height-o,t.width,o),n.fillRect(0,o,32,t.height-64),n.fillRect(t.width-32,o,32,t.height-64);for(let t=0;t<3;++t){let i=t<e.health?"salmon":"darkgray";n.fillStyle=i,n.fillRect(0+t*h,0,13,13)}e.gameOver?(Mt(n,t.width/2,t.height/2,.7*t.width,8,"black"),It(n,t.width/2+1,t.height/2+1,"Game Over",32,"black"),It(n,t.width/2-1,t.height/2-1,"Game Over",32,"white"),It(n,t.width/2+1,t.height/2+24+1,"Click to continue",16,"black"),It(n,t.width/2-1,t.height/2+24-1,"Click to continue",16,"white")):e.gameWin&&(Mt(n,t.width/2,t.height/2,.7*t.width,8,"black"),It(n,t.width/2+1,t.height/2+1,"Success!",32,"black"),It(n,t.width/2-1,t.height/2-1,"Success!",32,"gold"),It(n,t.width/2+1,t.height/2+24+1,"Click to continue",16,"black"),It(n,t.width/2-1,t.height/2+24-1,"Click to continue",16,"white")),It(n,t.width/2,t.height-h,"Time: "+Math.floor(e.gameTime),16,"white")}function Mt(t,e,n,i,s,r){t.translate(e,n);{let e=i/2,n=s/2;t.fillStyle=r,t.fillRect(-e,-n,i,s)}t.translate(-e,-n)}function It(t,e,n,i,s,r){t.translate(e,n),t.textAlign="center",t.textBaseline="middle",t.font=s+"px sans-serif",t.fillStyle=r,t.fillText(i,0,0),t.translate(-e,-n)}document.addEventListener("DOMContentLoaded",(async function(){const t=document.querySelector("display-port"),e=t.canvas.getContext("2d");e.imageSmoothingEnabled=!1,document.body.appendChild(ut);const n={display:t};await Nt.call(n),wt.call(n),t.addEventListener("frame",i=>{const s=i.detail.deltaTime/1e3;Et.call(n,s),ut.poll(),xt.call(n,s);const r={context:e,width:t.width,height:t.height};e.clearRect(0,0,r.width,r.height),At.call(n,r,n)})}))}();
