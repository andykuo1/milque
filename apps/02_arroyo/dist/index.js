!function(){"use strict";var t="undefined"!=typeof Float32Array?Float32Array:Array;function e(){var e=new t(16);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function n(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function i(e,n,i){var s=new t(3);return s[0]=e,s[1]=n,s[2]=i,s}function s(t,e,n){var i=e[0],s=e[1],o=e[2],r=n[0],a=n[1],l=n[2];return t[0]=s*l-o*a,t[1]=o*r-i*l,t[2]=i*a-s*r,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var o,r=function(t){var e=t[0],n=t[1],i=t[2];return Math.hypot(e,n,i)};o=n();!function(){var e,n=(e=new t(4),t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function a(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function l(t,e,n,i){var s,o,r,a,l,h=e[0],c=e[1],u=e[2],d=e[3],p=n[0],m=n[1],f=n[2],g=n[3];return(o=h*p+c*m+u*f+d*g)<0&&(o=-o,p=-p,m=-m,f=-f,g=-g),1-o>1e-6?(s=Math.acos(o),r=Math.sin(s),a=Math.sin((1-i)*s)/r,l=Math.sin(i*s)/r):(a=1-i,l=i),t[0]=a*h+l*p,t[1]=a*c+l*m,t[2]=a*u+l*f,t[3]=a*d+l*g,t}var h,c,u,d,p,m,f,g=function(t,e){var n=e[0],i=e[1],s=e[2],o=e[3],r=n*n+i*i+s*s+o*o;return r>0&&(r=1/Math.sqrt(r)),t[0]=n*r,t[1]=i*r,t[2]=s*r,t[3]=o*r,t};h=n(),c=i(1,0,0),u=i(0,1,0),d=a(),p=a(),m=new t(9),t!=Float32Array&&(m[1]=0,m[2]=0,m[3]=0,m[5]=0,m[6]=0,m[7]=0),m[0]=1,m[4]=1,m[8]=1,f=m;const b="noscale";class v extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <canvas></canvas>\n    <slot></slot>\n</div>',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block;color:#555}.container{display:flex;position:relative;width:100%;height:100%}canvas{background:#000;margin:auto;-ms-interpolation-mode:nearest-neighbor;image-rendering:-moz-crisp-edges;image-rendering:pixelated}label{font-family:monospace;color:currentColor;position:absolute}#title{left:.5rem;top:.5rem}#fps{right:.5rem;top:.5rem}#dimension{left:.5rem;bottom:.5rem}.hidden{display:none}:host([debug]) .container{outline:6px dashed rgba(0,0,0,.1);outline-offset:-4px;background-color:rgba(0,0,0,.1)}:host([mode=noscale]) canvas{margin:0;top:0;left:0}:host([mode=center]),:host([mode=fit]),:host([mode=stretch]){width:100%;height:100%}:host([full]){width:100vw!important;height:100vh!important}:host([disabled]){display:none}slot{display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}::slotted(*){pointer-events:auto}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{width:Number,height:Number,disabled:Boolean,debug:Boolean,mode:{type:String,value:"fit",observed:!1}}}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get height(){return this._height}set height(t){this.setAttribute("height",String(t))}get width(){return this._width}set width(t){this.setAttribute("width",String(t))}static get customEvents(){return["frame"]}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}static get observedAttributes(){return["onframe","width","height","disabled","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this._onframe=null,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onframe")){let t=this.onframe;delete this.onframe,this.onframe=t}if(Object.prototype.hasOwnProperty.call(this,"width")){let t=this.width;delete this.width,this.width=t}if(Object.prototype.hasOwnProperty.call(this,"height")){let t=this.height;delete this.height,this.height=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}if(Object.prototype.hasOwnProperty.call(this,"mode")){let t=this.mode;delete this.mode,this.mode=t}this.hasAttribute("mode")||this.setAttribute("mode","fit"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=Number(n);break;case"height":this._height=Number(n);break;case"disabled":this._disabled=null!==n;break;case"debug":this._debug=null!==n;break;case"onframe":this.onframe=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}})(t,0,n)}update(t){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const e=t-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=t,this.debug){const t=e<=0?"--":String(Math.round(1e3/e)).padStart(2,"0");if(this._fpsElement.innerText!==t&&(this._fpsElement.innerText=t),this.mode===b){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:t,prevTime:this._prevAnimationFrameTime,deltaTime:e,canvas:this._canvasElement},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}updateCanvasSize(){let t=this.shadowRoot.host.getBoundingClientRect();const e=t.width,n=t.height;let i=this._canvasElement,s=this._width,o=this._height;const r=this.mode;if("stretch"===r)s=e,o=n;else if(r!==b){if(e<s||n<o||"fit"===r){let t=e/s,i=n/o;t<i?(s=e,o*=t):(s*=i,o=n)}}s=Math.floor(s),o=Math.floor(o),i.clientWidth===s&&i.clientHeight===o||(i.width=this._width,i.height=this._height,i.style=`width: ${s}px; height: ${o}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:s,height:o},bubbles:!1,composed:!0})))}}window.customElements.define("display-port",v);const y=1,k=2,w=3,_={NULL:0,DOWN:1,UP:2,MOVE:3,parse(t){if("string"!=typeof t)return _.NULL;switch(t.toLowerCase()){case"down":return _.DOWN;case"up":return _.UP;case"move":return _.MOVE;default:return _.NULL}}},E="*";class x{constructor(t,e){this.deviceName=t,this.eventTarget=e,this.listeners={}}destroy(){this.listeners={}}addInputListener(t,e){let n=this.listeners[t];n?n.push(e):(n=[e],this.listeners[t]=n)}removeInputListener(t,e){let n=this.listeners[t];n&&(n.indexOf(e),n.splice(e,1))}dispatchInput(t){const{keyCode:e}=t,n=this.listeners[e];let i=!1;if(n){for(let e of n)i|=e(t);return i}for(let e of this.listeners["*"])i|=e(t);return i}}class C{static createAdapter(t,e,n,i,s,o){return{target:t,adapterId:e,deviceName:n,keyCode:i,scale:s,eventCode:o}}constructor(){this.adapters={"*":M()}}add(t){for(let e of t){const{deviceName:t,keyCode:n}=e;let i;t in this.adapters?i=this.adapters[t]:(i=M(),this.adapters[t]=i),n in i?i[n].push(e):i[n]=[e]}}delete(t){for(let e of t){const{deviceName:t,keyCode:n}=e;if(t in this.adapters){let i=this.adapters[t];if(n in i){let t=i[n],s=t.indexOf(e);s>=0&&t.splice(s,1)}}}}clear(){for(let t in this.adapters)this.adapters[t]=M()}poll(t,e,n){const i=this.findAdapters(t,e);for(let t of i){const e=t.eventCode;if(e===_.NULL){const{target:e,scale:i}=t,s=n.value*i;e.poll(s,t)}else{const{target:i,scale:s}=t,o=n.getEvent(e)*s;i.poll(o,t)}}return i.length>0}update(t,e,n){let i=!1;for(let s of this.findAdapters(t,e)){const t=s.eventCode;if(t!==_.NULL){const{target:e,scale:o}=s,r=n.getEvent(t)*o;e.update(r,s),i=!0}}return i}reset(t,e,n){let i=!1;for(let n of this.findAdapters(t,e))n.target.reset(),i=!0;return i}findAdapters(t,e){let n=[];if(t in this.adapters){let i=this.adapters[t];e in i&&n.push(...i[e]),n.push(...i["*"])}let i=this.adapters["*"];return e in i&&n.push(...i[e]),n.push(...i["*"]),n}}function M(){return{[E]:[]}}class I{constructor(){this.value=0}update(t){this.value=t}poll(){this.value=0}getEvent(t){return 0}getState(){return this.value}}class L extends I{constructor(t){super(),this.update=this.update.bind(this),Array.isArray(t)||(t=[t]);let e=[],n=0;for(let i of t){"string"==typeof i&&(i={key:i});const{key:t,scale:s=1,event:o="null"}=i,{deviceName:r,keyCode:a}=S(t),l=_.parse(o),h=Number(s);let c=C.createAdapter(this,n,r,a,h,l);e.push(c),++n}this.adapters=e,this.values=new Array(e.length).fill(0),this.next={values:new Array(e.length).fill(0),value:0}}poll(t,e){const n=e.adapterId;let i=this.values[n];this.values[n]=t,this.value=this.value-i+t,this.next.values[n]=0,this.next.value+=t-i}update(t,e){const n=e.adapterId;let i=this.next.values[n];this.next.values[n]=t,this.next.value+=t-i}reset(){this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function S(t){let e=t.indexOf(":");if(e>=0)return{deviceName:t.substring(0,e),keyCode:t.substring(e+1)};throw new Error("Invalid key string - missing device separator ':'.")}function A(t,e){return`${t}:${e}`}class B extends x{constructor(t,e={}){super("Keyboard",t);const{repeat:n=!1}=e;this.repeat=n,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:_.NULL,type:y,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)}destroy(){let t=this.eventTarget;t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._eventObject;return e.keyCode=t.code,e.event=_.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onKeyUp(t){let e=this._eventObject;if(e.keyCode=t.code,e.event=_.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}}class T extends x{constructor(t,e={eventsOnFocus:!0}){super("Mouse",t),this.canvasTarget=t instanceof HTMLCanvasElement&&t||t.canvas||t.querySelector("canvas")||t.shadowRoot&&t.shadowRoot.querySelector("canvas")||t,this.eventsOnFocus=e.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:_.NULL,type:y,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:t,deviceName:this.deviceName,keyCode:"Position",event:_.MOVE,type:k,x:0,y:0,dx:0,dy:0},this._wheelObject={target:t,deviceName:this.deviceName,keyCode:"Wheel",event:_.MOVE,type:w,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("contextmenu",this.onContextMenu),t.addEventListener("wheel",this.onWheel),t.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let t=this.eventTarget;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("contextmenu",this.onContextMenu),t.removeEventListener("wheel",this.onWheel),t.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(t=!0){t?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(t){this._downHasFocus=!0;let e=this._eventObject;if(e.keyCode="Button"+t.button,e.event=_.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)&&document.activeElement===this.eventTarget)return t.preventDefault(),t.stopPropagation(),!1}onContextMenu(t){return t.preventDefault(),t.stopPropagation(),!1}onWheel(t){let e=this._wheelObject;switch(t.deltaMode){case WheelEvent.DOM_DELTA_LINE:e.dx=10*t.deltaX,e.dy=10*t.deltaY,e.dz=10*t.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:e.dx=100*t.deltaX,e.dy=100*t.deltaY,e.dz=100*t.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:e.dx=t.deltaX,e.dy=t.deltaY,e.dz=t.deltaZ}if(this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}onMouseUp(t){if(!this._downHasFocus)return;this._downHasFocus=!1;let e=this._eventObject;return e.keyCode="Button"+t.button,e.event=_.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onMouseMove(t){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const e=this.canvasTarget,{clientWidth:n,clientHeight:i}=e,s=e.getBoundingClientRect();let o=t.movementX/n,r=t.movementY/i,a=(t.clientX-s.left)/n,l=(t.clientY-s.top)/i,h=this._positionObject;h.x=a,h.y=l,h.dx=o,h.dy=r,this.dispatchInput(h)}}class O extends I{constructor(){super(),this.delta=0,this.next={delta:0}}update(t,e){this.value=t,this.next.delta+=e}poll(){this.delta=this.next.delta,this.next.delta=0}getEvent(t){switch(t){case _.MOVE:return this.delta;default:return super.getEvent(t)}}}class N extends I{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(t){t?this.next.down=!0:this.next.up=!0}poll(){const{up:t,down:e}=this.next;this.value?this.up&&!t&&(this.value=0):e&&(this.value=1),this.down=e,this.up=t,this.next.down=!1,this.next.up=!1}getEvent(t){switch(t){case _.DOWN:return 1&this.down;case _.UP:return 1&this.up;default:return super.getEvent(t)}}}const P=1,j=2;const W=Symbol("inputSource");class X{static for(t){if(Object.prototype.hasOwnProperty.call(t,W))return t[W];{let e=new X([new B(t),new T(t)]);return Object.defineProperty(t,W,{value:e}),e}}constructor(t){this.onInputEvent=this.onInputEvent.bind(this);let e={},n={};for(let i of t){const t=i.deviceName;e[t]=i,n[t]={},i.addInputListener(E,this.onInputEvent)}this.devices=e,this.inputs=n,this.listeners={poll:[],update:[]}}destroy(){this.clear();for(let t in this.devices){let e=this.devices[t];e.removeInputListener(E,this.onInputEvent),e.destroy()}}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let n=this.listeners[t],i=n.indexOf(e);n.splice(i,1)}}dispatchEvent(t,e){for(let n of this.listeners[t])n(e)}_dispatchInputEvent(t,e,n,i){this.dispatchEvent("input",{stage:t,deviceName:e,keyCode:n,input:i})}_dispatchPollEvent(){this.dispatchEvent("poll",{})}poll(){for(const t in this.inputs){const e=this.inputs[t];for(const n in e){let i=e[n];i.poll(),this._dispatchInputEvent(j,t,n,i)}}this._dispatchPollEvent()}onInputEvent(t){const e=t.deviceName;switch(t.type){case y:{const n=t.keyCode;let i=this.inputs[e][n];i&&(i.update(t.event===_.DOWN),this._dispatchInputEvent(P,e,n,i))}break;case k:{let n=this.inputs[e],i=n.PosX;i&&(i.update(t.x,t.dx),this._dispatchInputEvent(P,e,"PosX",i));let s=n.PosY;s&&(s.update(t.y,t.dy),this._dispatchInputEvent(P,e,"PosY",s))}break;case w:{let n=this.inputs[e],i=n.WheelX;i&&(i.update(t.dx,t.dx),this._dispatchInputEvent(P,e,"WheelX",i));let s=n.WheelY;s&&(s.update(t.dy,t.dy),this._dispatchInputEvent(P,e,"WheelY",s));let o=n.WheelZ;o&&(o.update(t.dz,t.dz),this._dispatchInputEvent(P,e,"WheelZ",o))}}}add(t,e){if(!(t in this.devices))throw new Error("Invalid device name - missing device with name in source.");let n=function(t,e){return"Mouse"===t&&("PosX"===e||"PosY"===e||"WheelX"===e||"WheelY"===e||"WheelZ"===e)}(t,e)?new O:new N;return this.inputs[t][e]=n,this}delete(t,e){delete this.inputs[t][e]}get(t,e){return this.inputs[t][e]}has(t,e){return t in this.inputs&&e in this.inputs[t]}clear(){for(let t in this.devices)this.inputs[t]={}}}class H{constructor(t={}){const{disabled:e=!0}=t;this.source=null,this._disabled=e,this._ignoreInput=e,this.adapters=new C,this.inputs={},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this)}get disabled(){return this._disabled}set disabled(t){this.toggle(!t)}setInputMap(t){return this._setupInputs(this.source,t),this}attach(t){return this._setupInputs(t,null),this.toggle(!0),this}detach(){return this.toggle(!1),this._setupInputs(null,null),this}_setupInputs(t,e){const n=this.disabled;this.disabled=!0;const i=this.source,s=this.inputs,o=i!==t&&i,r=this.inputs&&e;if(o||r){o&&(i.removeEventListener("poll",this.onSourcePoll),i.removeEventListener("input",this.onSourceInput));for(let t in s){let{adapters:e}=s[t];for(let t of e){const{deviceName:e,keyCode:n}=t;0===F(i,e,n)&&i.delete(e,n)}}r&&(this.adapters.clear(),this.inputs={})}if(e){let t={};for(let n in e){let i=e[n],s=new L(i),o=s.adapters;this.adapters.add(o),t[n]=s}this.inputs=t}if(t){!function(t){R in t||(t[R]={})}(t);const e=this.inputs;for(let n in e){let{adapters:i}=e[n];for(let e of i){const{deviceName:n,keyCode:i}=e;1===Y(t,n,i)&&t.add(n,i)}}this.source!==t&&(t.addEventListener("poll",this.onSourcePoll),t.addEventListener("input",this.onSourceInput),this.source=t)}this.disabled=n}onSourceInput(t){if(t.consumed||this._ignoreInput){const{deviceName:e,keyCode:n,input:i}=t;this.adapters.reset(e,n,i)}else{const{stage:e,deviceName:n,keyCode:i,input:s}=t;switch(e){case j:this.adapters.poll(n,i,s);break;case P:this.adapters.update(n,i,s)}t.consumed=!0}}onSourcePoll(t){this._ignoreInput!==this.disabled&&(this._ignoreInput=this.disabled)}toggle(t=this._disabled){if(t){if(!this.source)throw new Error("Input source must be set before enabling input context.");Object.keys(this.inputs).length<=0&&console.warn("No inputs found for enabled input context - did you forget to setInputMap()?")}return this._disabled=!t,this}getInput(t){return this.inputs[t]}getInputValue(t){return t in this.inputs?this.inputs[t].value:0}}const R=Symbol("inputRefCounts");function Y(t,e,n){const i=A(e,n);let s=t[R],o=s[i]+1||1;return s[i]=o,o}function F(t,e,n){const i=A(e,n);let s=t[R],o=s[i]-1||0;return s[i]=Math.max(o,0),o}class D extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<kbd>\n    <span id="key"><slot></slot></span>\n    <span id="value" class="hidden"></span>\n</kbd>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML='kbd{position:relative;display:inline-block;border-radius:3px;border:1px solid #888;font-size:.85em;font-weight:700;text-rendering:optimizeLegibility;line-height:12px;height:14px;padding:2px 4px;color:#444;background-color:#eee;box-shadow:inset 0 -3px 0 #aaa;overflow:hidden}kbd:empty:after{content:"<?>";opacity:.6}.disabled{opacity:.6;box-shadow:none;background-color:#aaa}.hidden{display:none}#value{position:absolute;top:0;bottom:0;right:0;font-size:.85em;padding:2px 4px 0;color:#ccc;background-color:#333;box-shadow:inset 0 3px 0 #222}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{name:String,value:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get value(){return this._value}set value(t){this.setAttribute("value",t)}get name(){return this._name}set name(t){this.setAttribute("name",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._keyboardElement=this.shadowRoot.querySelector("kbd"),this._keyElement=this.shadowRoot.querySelector("#key"),this._valueElement=this.shadowRoot.querySelector("#value")}attributeChangedCallback(t,e,n){switch(t){case"name":this._name=n;break;case"value":this._value=n;break;case"disabled":this._disabled=null!==n}((t,e,n)=>{switch(t){case"name":this._keyElement.innerText=n;break;case"value":null!==n?(this._valueElement.classList.toggle("hidden",!1),this._valueElement.innerText=n,this._keyboardElement.style.paddingRight=`${this._valueElement.clientWidth+4}px`):this._valueElement.classList.toggle("hidden",!0);break;case"disabled":this._keyboardElement.classList.toggle("disabled",null!==n)}})(t,0,n)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"name")){let t=this.name;delete this.name,this.name=t}if(Object.prototype.hasOwnProperty.call(this,"value")){let t=this.value;delete this.value,this.value=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}}static get observedAttributes(){return["name","value","disabled"]}}window.customElements.define("input-key",D);class K extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<table>\n    <thead>\n        <tr class="tableHeader">\n            <th colspan=4>\n                <slot id="title">input-map</slot>\n            </th>\n        </tr>\n        <tr class="colHeader">\n            <th>name</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:block}table{border-collapse:collapse}table,td,th{border:1px solid #666}td,th{padding:5px 10px}td{text-align:center}thead th{padding:0}.colHeader>th{font-size:.8em;padding:0 10px;letter-spacing:3px;background-color:#aaa;color:#666}.colHeader>th,output{font-family:monospace}output{border-radius:.3em;padding:3px}tr:not(.primary) .name,tr:not(.primary) .value{opacity:.3}tr:nth-child(2n){background-color:#eee}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get observedAttributes(){return["src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._inputMap={},this._titleElement=this.shadowRoot.querySelector("#title"),this._tableElements={},this._bodyElement=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot")}get map(){return this._inputMap}connectedCallback(){!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let n=t[e];delete t[e],t[e]=n}}(this,"src")}attributeChangedCallback(t,e,n){switch(t){case"src":if(this._src!==n)if(this._src=n,n.trim().startsWith("{")){let t=JSON.parse(n);this._setInputMap(t)}else fetch(n).then((t=>t.json())).then((t=>this._setInputMap(t)));break;case"id":case"class":this._titleElement.innerHTML=`input-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}}get src(){return this.getAttribute("src")}set src(t){switch(typeof t){case"object":{let e=JSON.stringify(t);this._src=e,this._setInputMap(t),this.setAttribute("src",e)}break;case"string":this.setAttribute("src",t);break;default:this.setAttribute("src",JSON.stringify(t))}}_setInputMap(t){let e=[];for(let n in t){U(e,n,t[n])}this._bodyElement.innerHTML="";for(let t of e)this._bodyElement.appendChild(t);this._inputMap=t}}function U(t,e,n){if(Array.isArray(n)){U(t,e,n[0]);let i=n.length;for(let s=1;s<i;++s)t.push($(e,n[s],!1))}else t.push($(e,n,!0));return t}function $(t,e,n=!0){if("object"==typeof e){const{key:i,event:s,scale:o}=e;return q(t,i,s,o,0,n)}return q(t,e,null,1,0,n)}function q(t,e,n,i,s,o=!0){let r=document.createElement("tr");o&&r.classList.add("primary");{let e=document.createElement("td");e.textContent=t,e.classList.add("name"),r.appendChild(e)}{let t=document.createElement("td");t.classList.add("key");let n=new D;n.innerText=e,t.appendChild(n),r.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp"),s=[];"string"==typeof n&&"null"!==n&&s.push(n),"number"==typeof i&&1!==i&&s.push(`×${i.toFixed(2)}`),e.innerText=s.join(" "),t.classList.add("mod"),t.appendChild(e),r.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("output");e.innerText=Number(s).toFixed(2),e.classList.add("value"),t.appendChild(e),r.appendChild(t)}return r}window.customElements.define("input-map",K);class z extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="hidden">\n    <label id="title">\n        input-source\n    </label>\n    <span>|</span>\n    <p>\n        <label for="poll">poll</label>\n        <output id="poll"></output>\n    </p>\n    <p>\n        <label for="focus">focus</label>\n        <output id="focus"></output>\n    </p>\n</div>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=':host{display:inline-block}.hidden{display:none}div{font-family:monospace;color:#666;outline:1px solid #666;padding:4px}p{display:inline;margin:0;padding:0}#focus:empty:after,#poll:empty:after{content:"✗";color:red}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean,debug:Boolean}}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get customEvents(){return["input","poll"]}get onpoll(){return this._onpoll}set onpoll(t){this._onpoll&&this.removeEventListener("poll",this._onpoll),this._onpoll=t,this._onpoll&&this.addEventListener("poll",t)}get oninput(){return this._oninput}set oninput(t){this._oninput&&this.removeEventListener("input",this._oninput),this._oninput=t,this._oninput&&this.addEventListener("input",t)}static get observedAttributes(){return["oninput","onpoll","for","autopoll","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._autopoll=!1,this._containerElement=this.shadowRoot.querySelector("div"),this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._focusElement=this.shadowRoot.querySelector("#focus"),this._pollCount=0,this._pollCountDelay=0,this._sourceElement=null,this._inputSource=null,this._animationFrameHandle=null,this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceFocus=this.onSourceFocus.bind(this),this.onSourceBlur=this.onSourceBlur.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this)}get source(){return this._inputSource}poll(){this._inputSource.poll()}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"oninput")){let t=this.oninput;delete this.oninput,this.oninput=t}if(Object.prototype.hasOwnProperty.call(this,"onpoll")){let t=this.onpoll;delete this.onpoll,this.onpoll=t}if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.hasAttribute("for")||this._setSourceElement(this),this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame)}disconnectedCallback(){cancelAnimationFrame(this._animationFrameHandle),this._clearSourceElement()}attributeChangedCallback(t,e,n){switch(t){case"for":this._for=n;break;case"autopoll":this._autopoll=null!==n;break;case"debug":this._debug=null!==n;break;case"oninput":this.oninput=new Function("event","with(document){with(this){"+n+"}}").bind(this);break;case"onpoll":this.onpoll=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"for":this._setSourceElement(n?document.getElementById(n):this);break;case"id":case"class":{let t=this.className?"."+this.className:"",e=this.hasAttribute("id")?"#"+this.getAttribute("id"):"";this._titleElement.innerHTML=t+e}break;case"debug":this._containerElement.classList.toggle("hidden",n)}})(t,0,n)}onSourceInput(t){this.dispatchEvent(new CustomEvent("input",{composed:!0,bubbles:!1,detail:t}))}onSourcePoll(){this._pollCount+=1,this.dispatchEvent(new CustomEvent("poll",{composed:!0,bubbles:!1}))}onSourceFocus(){this._focusElement.innerText="✓"}onSourceBlur(){this._focusElement.innerText=""}onAnimationFrame(t){if(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this._autopoll&&this.poll(),this.debug){t-this._pollCountDelay>1e3&&(this._pollCountDelay=t,this._pollCount>0?(this._pollElement.innerText="✓",this._pollCount=0):this._pollElement.innerText="")}}_clearSourceElement(){if(this._inputSource){let t=this._inputSource,e=this._sourceElement;this._inputSource=null,this._sourceElement=null,e.removeEventListener("focus",this.onSourceFocus),e.removeEventListener("blur",this.onSourceBlur),t.destroy()}}_setSourceElement(t){if(this._clearSourceElement(),!t)throw new Error("Event target not found.");let e=X.for(t);e.addEventListener("input",this.onSourceInput),e.addEventListener("poll",this.onSourcePoll),t.addEventListener("focus",this.onSourceFocus),t.addEventListener("blur",this.onSourceBlur),this._sourceElement=t,this._inputSource=e}}window.customElements.define("input-source",z);class V extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<input-map class="hidden">\n    <input-source debug></input-source>\n</input-map>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block}.hidden{display:none}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,disabled:Boolean,autopoll:Boolean,debug:Boolean}}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get observedAttributes(){return["for","disabled","autopoll","debug","src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._inputContext=new H,this._mapElement=this.shadowRoot.querySelector("input-map"),this._sourceElement=this.shadowRoot.querySelector("input-source")}get context(){return this._inputContext}get source(){return this._sourceElement.source}get map(){return this._mapElement.map}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let n=t[e];delete t[e],t[e]=n}}(this,"src")}attributeChangedCallback(t,e,n){switch(t){case"for":this._for=n;break;case"disabled":this._disabled=null!==n;break;case"autopoll":this._autopoll=null!==n;break;case"debug":this._debug=null!==n}((t,e,n)=>{switch(t){case"for":this._sourceElement.for=n,this._inputContext.attach(this._sourceElement.source);break;case"disabled":this._inputContext.disabled=null!==n;break;case"autopoll":this._sourceElement.autopoll=null!==n;break;case"src":this._mapElement.src=n,this._inputContext.setInputMap(this._mapElement.map);break;case"debug":this._mapElement.classList.toggle("hidden",null===n);break;case"id":this._sourceElement.id=n;break;case"class":this._sourceElement.className=n}})(t,0,n)}get src(){return this._mapElement.src}set src(t){this._mapElement.src=t}}window.customElements.define("input-context",V);class J{next(){return Math.random()}}let G;class Z{constructor(t=new J){this.generator=t}static next(){return G.next()}next(){return this.generator.next()}static choose(t){return G.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return G.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static sign(){return G.sign()}sign(){return this.generator.next()<.5?-1:1}}G=new Z;function Q(t,e){const n=document.createElement("a"),i=e.indexOf(";");e=e.substring(0,i+1)+"headers=Content-Disposition%3A%20attachment%3B%20filename="+t+";"+e.substring(i+1),n.setAttribute("href",e),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}const tt=["svg","g"];function et(t,e=t.cloneNode(!0)){let n=t.childNodes,i=e.childNodes;for(var s=0;s<i.length;s++){let t=i[s],e=t.tagName;if(-1!=tt.indexOf(e))et(n[s],t);else if(n[s]instanceof Element){const e=window.getComputedStyle(n[s]);let i=[];for(let t of Object.keys(e))i.push(`${t}:${e.getPropertyValue(t)};`);t.setAttribute("style",i.join(""))}}return e}var nt=Object.freeze({__proto__:null,FILE_TYPE_PNG:"png",FILE_TYPE_SVG:"svg",downloadText:function(t,e){Q(t,"data:text/plain; charset=utf-8,"+encodeURIComponent(e))},downloadImageFromSVG:function(t,e,n,i,s){const o=function(t){const e=et(t),n=(new XMLSerializer).serializeToString(e);return new Blob([n],{type:"image/svg+xml"})}(n);switch(e){case"png":{const n=URL.createObjectURL(o),r=document.createElement("canvas"),a=r.getContext("2d"),l=window.devicePixelRatio||1;r.width=i*l,r.height=s*l,r.style.width=i+"px",r.style.height=s+"px",a.setTransform(l,0,0,l,0,0);const h=new Image;h.onload=()=>{a.drawImage(h,0,0),URL.revokeObjectURL(n);const i=r.toDataURL("image/"+e).replace("image/"+e,"image/octet-stream");Q(t,i)},h.src=n}break;case"svg":{const e=new FileReader;e.onload=()=>{Q(t,e.result)},e.readAsDataURL(o)}break;default:throw new Error("Unknown file type '"+e+"'")}},downloadURL:Q});var it=Object.freeze({__proto__:null,uploadFile:async function(t=[],e=!1){return new Promise(((n,i)=>{const s=document.createElement("input");s.addEventListener("change",(t=>{n(e?t.target.files:t.target.files[0])})),s.type="file",s.accept=t.join(","),s.style.display="none",s.toggleAttribute("multiple",e),document.body.appendChild(s),s.click(),document.body.removeChild(s)}))}});const st={on(t,e,n=e){let i;if(this.__events.has(t)?i=this.__events.get(t):(i=new Map,this.__events.set(t,i)),i.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return i.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,((...i)=>{this.off(t,n),e.apply(this.__context||this,i)}),n)},emit(t,...e){if(this.__events.has(t)){let n=[];const i=Array.from(this.__events.get(t).values());for(const t of i){let i=t.apply(this.__context||this,e);i&&n.push(i)}return n}return this.__events.set(t,new Map),[]}};function ot(t){const e=Object.create(st);return e.__events=new Map,e.__context=t,e}function rt(t,e){const n=Object.assign(t,st);return n.__events=new Map,n.__context=e,n}function at(t,e){const n=t.prototype;return Object.assign(n,st),n.__events=new Map,n.__context=e,n}var lt={create:ot,assign:rt,mixin:at},ht=Object.freeze({__proto__:null,create:ot,assign:rt,mixin:at,default:lt});function ct(t,e,n){return t+(e-t)*n}const ut=new AudioContext;!async function(t){document.addEventListener("click",(()=>{"suspended"===t.state&&t.resume()}))}(ut);const dt={gain:0,pitch:0,pan:0,loop:!1};class pt{constructor(t,e,n=!1){this.context=t,this.buffer=e,this._source=null,this.playing=!1,this.loop=n,this.onAudioSourceEnded=this.onAudioSourceEnded.bind(this)}onAudioSourceEnded(){this._playing=!1}play(t=dt){if(!this.buffer)return;this._source&&this.destroy();const e=this.context;let n=e.createBufferSource();n.addEventListener("ended",this.onAudioSourceEnded),n.buffer=this.buffer,n.loop=t.loop;let i=n;if(t.pitch&&(n.detune.value=100*t.pitch),t.gain){const n=e.createGain();n.gain.value=t.gain,i=i.connect(n)}if(t.pan){const n=e.createStereoPanner();n.pan.value=t.pan,i=i.connect(n)}i.connect(e.destination),n.start(),this._source=n,this._playing=!0}pause(){this._source.stop(),this._playing=!1}destroy(){this._source&&this._source.disconnect(),this._source=null}}var mt=Object.freeze({__proto__:null,AUDIO_CONTEXT:ut,AUDIO_ASSET_TAG:"audio",loadAudio:async function(t,e={}){const n=ut;let i=await fetch(t),s=await i.arrayBuffer(),o=await n.decodeAudioData(s);return new pt(n,o,Boolean(e.loop))}});i(0,0,0),i(1,0,0),i(0,1,0),i(0,0,1);class ft{static addInputEventListener(t,e){}static removeInputEventListener(t,e){}constructor(t){this.eventTarget=t}}class gt{constructor(){this.down=0,this.up=0,this.value=0,this.next={up:0,down:0}}update(t,e){"down"===t?this.next.down=e:this.next.up=e}poll(){this.value?this.up&&!this.next.up&&(this.value=0):this.next.down&&(this.value=1),this.down=this.next.down,this.up=this.next.up,this.next.down=0,this.next.up=0}toString(){return this.value}}class bt{constructor(){this.value=0}update(t,e){this.value=e}poll(){}toString(){return this.value}}class vt extends bt{constructor(){super(),this.next=0}update(t,e){this.next+=e}poll(){this.value=this.next,this.next=0}}const yt=Symbol("keyboardEventContext");class kt extends ft{static addInputEventListener(t,e){let n;if(yt in e)n=e[yt];else{n={handler:e,target:t,down:null,up:null,_keyEvent:{type:"key",target:t,device:"keyboard",key:null,event:null,value:null,control:!1,shift:!1,alt:!1}};let i=wt.bind(n),s=_t.bind(n);n.down=i,n.up=s,e[yt]=n}return t.addEventListener("keyup",n.up),t.addEventListener("keydown",n.down),t}static removeInputEventListener(t,e){if(yt in e){let n=e[yt];t.removeEventListener("keyup",n.up),t.removeEventListener("keydown",n.down)}return t}constructor(t,e){if(super(t),this._buttons=[],this._managed=Array.isArray(e),this.onManagedKeyEvent=this.onManagedKeyEvent.bind(this),this.onUnmanagedKeyEvent=this.onUnmanagedKeyEvent.bind(this),this._managed){for(let t of e){let e=new gt;this[t]=e,this._buttons.push(e)}kt.addInputEventListener(t,this.onManagedKeyEvent)}else kt.addInputEventListener(t,this.onUnmanagedKeyEvent)}get Up(){return Math.min((this.ArrowUp||0)+(this.KeyW||0),1)}get Down(){return Math.min((this.ArrowDown||0)+(this.KeyS||0),1)}get Left(){return Math.min((this.ArrowLeft||0)+(this.KeyA||0),1)}get Right(){return Math.min((this.ArrowRight||0)+(this.KeyD||0),1)}destroy(){this._managed?kt.removeInputEventListener(this.eventTarget,this.onManagedKeyEvent):kt.removeInputEventListener(this.eventTarget,this.onUnmanagedKeyEvent),this.eventTarget=null}poll(){for(let t of this._buttons)t.poll();return this}onUnmanagedKeyEvent(t){if(!(t.key in this)){let e=new gt;this[t.key]=e,this._buttons.push(e)}return this[t.key].update(t.event,t.value),!0}onManagedKeyEvent(t){if(t.key in this)return this[t.key].update(t.event,t.value),!0}}function wt(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._keyEvent;return e.key=t.code,e.event="down",e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.handler.call(void 0,e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}function _t(t){let e=this._keyEvent;if(e.key=t.code,e.event="up",e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.handler.call(void 0,e))return t.preventDefault(),t.stopPropagation(),!1}const Et=Symbol("mouseEventContext");class xt extends ft{static addInputEventListener(t,e){let n;if(Et in e)n=e[Et];else{n={handler:e,target:t,down:null,up:null,move:null,contextmenu:null,_down:!1,_keyEvent:{type:"key",target:t,device:"mouse",key:null,event:null,value:null},_posEvent:{type:"pos",target:t,device:"mouse",key:"pos",event:"move",x:0,y:0,dx:0,dy:0}};let i=Ct.bind(n),s=Mt.bind(n),o=It.bind(n),r=Lt.bind(n);n.down=i,n.up=s,n.move=o,n.contextmenu=r,e[Et]=n}return t.addEventListener("mousedown",n.down),document.addEventListener("mouseup",n.up),t.addEventListener("contextmenu",n.contextmenu),document.addEventListener("mousemove",n.move),t}static removeInputEventListener(t,e){if(Et in e){let n=e[Et];t.removeEventListener("mousedown",n.down),document.removeEventListener("mouseup",n.up),t.removeEventListener("contextmenu",n.contextmenu),document.removeEventListener("mousemove",n.move)}return t}constructor(t){super(t),this.x=new bt,this.y=new bt,this.dx=new vt,this.dy=new vt,this.Button0=new gt,this.Button1=new gt,this.Button2=new gt,this.Button3=new gt,this.Button4=new gt,this.onMouseEvent=this.onMouseEvent.bind(this),xt.addInputEventListener(t,this.onMouseEvent)}get Left(){return this.Button0}get Middle(){return this.Button1}get Right(){return this.Button2}destroy(){xt.removeInputEventListener(this.eventTarget,this.onMouseEvent),this.eventTarget=null}poll(){return this.x.poll(),this.y.poll(),this.dx.poll(),this.dy.poll(),this.Button0.poll(),this.Button1.poll(),this.Button2.poll(),this.Button3.poll(),this.Button4.poll(),this}onMouseEvent(t){let{key:e,event:n}=t;switch(e){case 0:this.Button0.update(n,t.value);break;case 1:this.Button1.update(n,t.value);break;case 2:this.Button2.update(n,t.value);break;case 3:this.Button3.update(n,t.value);break;case 4:this.Button4.update(n,t.value);break;case"pos":return this.x.update(n,t.x),this.y.update(n,t.y),this.dx.update(n,t.dx),void this.dy.update(n,t.dy)}return!0}}function Ct(t){this._down=!0;let e=this._keyEvent;if(e.key=t.button,e.event="down",e.value=1,this.handler.call(void 0,e)&&document.activeElement===this.target)return t.preventDefault(),t.stopPropagation(),!1}function Mt(t){if(this._down){this._down=!1;let e=this._keyEvent;if(e.key=t.button,e.event="up",e.value=1,this.handler.call(void 0,e))return t.preventDefault(),t.stopPropagation(),!1}}function It(t){let e=this.target,{clientWidth:n,clientHeight:i}=e,s=this.target.getBoundingClientRect(),o=t.movementX/n,r=t.movementY/i,a=(t.clientX-s.left)/n,l=(t.clientY-s.top)/i,h=this._posEvent;if(h.x=a,h.y=l,h.dx=o,h.dy=r,void 0!==this.handler.call(void 0,h))throw new Error("Return value must be 'undefined'. Mouse position and movement events cannot be consumed.")}function Lt(t){return t.preventDefault(),t.stopPropagation(),!1}class St{constructor(t,e){this.inputName=t,this.inputType=e,this.value=0,this._onchange=null,this._eventListeners=new Map}update(t){if(this.value!==t){if(this.value=t,this._eventListeners.has("change"))for(let t of this._eventListeners.get("change"))t.call(void 0,this);return!0}return!1}get onchange(){return this._onchange}set onchange(t){this._onchange&&this.removeEventListener("change",this._onchange),this._onchange=t,this.addEventListener("change",t)}addEventListener(t,e){if(this._eventListeners.has(t)){this._eventListeners.get(t).push(e)}else this._eventListeners.set(t,[e])}removeEventListener(t,e){if(this._eventListeners.has(t)){let n=this._eventListeners.get(t);n.splice(n.indexOf(e),1)}}toString(){return this.value}}const At=Symbol("template"),Bt=Symbol("style");class Tt extends HTMLElement{static toInputMap(t){let e={};for(let n of t)if(n instanceof Tt){let t,i=n.input;switch(i in e?t=e[i]:e[i]=t=[],n.type){case"action":t.push({key:n.key,event:n.event});break;case"range":t.push({key:n.key,scale:n.scale});break;default:throw new Error("Unknown input type.")}}return e}static get[At](){let t=document.createElement("template");return t.innerHTML="\n<kbd></kbd>",Object.defineProperty(this,At,{value:t}),t}static get[Bt](){let t=document.createElement("style");return t.innerHTML="\n:host {\n    display: inline-block;\n}\nkbd {\n    background-color: #EEEEEE;\n    border-radius: 3px;\n    border: 1px solid #B4B4B4;\n    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;\n    color: #333333;\n    font-size: 0.85em;\n    font-weight: 700;\n    line-height: 1;\n    padding: 2px 4px;\n    white-space: nowrap;\n}\n",Object.defineProperty(this,Bt,{value:t}),t}static get observedAttributes(){return["input","key","scale","event"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[At].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Bt].cloneNode(!0)),this.keyElement=this.shadowRoot.querySelector("kbd")}attributeChangedCallback(t,e,n){switch(t){case"key":this.keyElement.textContent=n}}get type(){return this.hasAttribute("event")?"action":"range"}get input(){return this.getAttribute("input")}set input(t){this.setAttribute("input",t)}get key(){return this.getAttribute("key")}set key(t){this.setAttribute("key",t)}get scale(){return Number(this.getAttribute("scale"))}set scale(t){this.setAttribute("scale",t)}get event(){return this.getAttribute("event")}set event(t){this.setAttribute("event",t)}}window.customElements.define("input-key",Tt);class Ot{constructor(t,e,n){this.keyName=t,this.keyEvent=e,this.scale=n,this.value=0}consumeKey(){this.value=0}updateKey(t,e){if(e===this.keyName)if(this.keyEvent){if(this.keyEvent===t.event)return this.value=t.value*this.scale,!0}else switch(t.event){case"down":return this.value=this.scale,!0;case"up":return this.value=0,!0;default:return void(this.value=t.value*this.scale)}}}const Nt=Symbol("template"),Pt=Symbol("style");class jt extends HTMLElement{static get[Nt](){let t=document.createElement("template");return t.innerHTML='\n<table>\n    <thead>\n        <tr class="header">\n            <th id="title" colspan=3>input-context</th>\n            <th id="poll">&nbsp;</th>\n        </tr>\n        <tr class="hint">\n            <th>input</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n<slot></slot>',Object.defineProperty(this,Nt,{value:t}),t}static get[Pt](){let t=document.createElement("style");return t.innerHTML='\n:host {\n    display: inline-block;\n}\nslot {\n    display: none;\n}\ntable {\n    border-collapse: collapse;\n}\ntable, th, td {\n    border: 1px solid gray;\n}\n#poll {\n    position: relative;\n    font-size: 0.9em;\n}\n#poll:after {\n    content: "(poll)";\n    position: absolute;\n    left: 0;\n    right: 0;\n    z-index: -1;\n    opacity: 0.1;\n    font-family: monospace;\n    letter-spacing: 3px;\n    overflow: hidden;\n}\n.hint > th {\n    font-size: 0.5em;\n    font-family: monospace;\n    padding: 0 10px;\n    letter-spacing: 3px;\n    background-color: #AAA;\n    color: #666666;\n}\nth, td {\n    padding: 5px 10px;\n}\ntd {\n    text-align: center;\n}\nkbd {\n    display: inline-block;\n    background-color: #EEEEEE;\n    border-radius: 3px;\n    border: 1px solid #B4B4B4;\n    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;\n    color: #333333;\n    font-size: 0.85em;\n    font-weight: 700;\n    line-height: 1;\n    padding: 2px 4px;\n    white-space: nowrap;\n}\noutput {\n    font-family: monospace;\n    border-radius: 0.3em;\n    padding: 3px;\n}\n.flash {\n    animation: fadein 4s;\n}\n@keyframes fadein {\n    0%, 10% { background-color: rgba(0, 0, 255, 0.3); }\n    100% { background-color: rgba(0, 0, 255, 0); }\n}\n',Object.defineProperty(this,Pt,{value:t}),t}static get observedAttributes(){return["for","strict","onattach","ondetach","id","class"]}constructor(t=null){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Nt].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Pt].cloneNode(!0)),this._onattach=null,this._ondetach=null,this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._tableBody=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot"),this._tableInputs={},this._lastPollTime=0,this._pollWarningTimeoutHandle=0,this._animationFrameHandle=0,this._inputTarget=null,this._inputMap=t,this._inputs={},this._inputKeys={},this._keys={},this.onInputEvent=this.onInputEvent.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this),t&&Wt(this,t)}connectedCallback(){if(this.hasAttribute("for")||this.setAttribute("for",""),!this._inputMap){this._inputMap={};const t=Tt.toInputMap(this._children.assignedNodes()),e=this.src;e?fetch(e).then((t=>t.json())).then((e=>{this._inputMap={...e,...t},Wt(this,this._inputMap)})):(this._inputMap={...t},Wt(this,this._inputMap))}this._lastPollTime=0,this._pollWarningTimeoutHandle=setTimeout((()=>{this._lastPollTime<=0?(this._pollElement.textContent="✗",console.warn("[INPUT] No input updated. Did you forget to poll() the input context?")):this._pollElement.textContent="✓"}),3e3),this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame)}disconnectedCallback(){cancelAnimationFrame(this._animationFrameHandle),clearTimeout(this._pollWarningTimeoutHandle)}attributeChangedCallback(t,e,n){switch(t){case"for":{let t;t=n?document.getElementById(n):document.querySelector("display-port")||document.querySelector("canvas"),this._inputTarget&&this.detach(),t&&this.attach(t)}break;case"onattach":this.onattach=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"ondetach":this.ondetach=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"id":case"class":this._titleElement.innerHTML=`input-context${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}}get src(){return this.getAttribute("src")}set src(t){this.setAttribute("src",t)}get for(){return this.getAttribute("for")}set for(t){this.setAttribute("for",t)}get strict(){return this.hasAttribute("strict")}set strict(t){t?this.setAttribute("strict",""):this.removeAttribute("strict")}get auto(){return this.hasAttribute("auto")}set auto(t){t?this.setAttribute("auto",""):this.removeAttribute("auto")}get onattach(){return this._onattach}set onattach(t){this._onattach&&this.removeEventListener("attach",this._onattach),this._onattach=t,this._onattach&&this.addEventListener("attach",t)}get ondetach(){return this._ondetach}set ondetach(t){this._ondetach&&this.removeEventListener("detach",this._ondetach),this._ondetach=t,this._ondetach&&this.addEventListener("detach",t)}attach(t){if(!t)throw new Error("Cannot attach input context to null.");if(this._inputTarget){if(this._inputTarget!==t)throw new Error("Input context already attached to another element.");return this}let e=t;return e&&(e.canvas?(kt.addInputEventListener(e,this.onInputEvent),xt.addInputEventListener(e.canvas,this.onInputEvent)):(kt.addInputEventListener(e,this.onInputEvent),xt.addInputEventListener(e,this.onInputEvent)),this.dispatchEvent(new CustomEvent("attach",{composed:!0,bubbles:!1,detail:{eventTarget:e,inputCallback:this.onInputEvent}}))),this._inputTarget=e,this}detach(){if(!this._inputTarget)return this;let t=this._inputTarget;return this._inputTarget=null,t.canvas?(kt.removeInputEventListener(t,this.onInputEvent),xt.removeInputEventListener(t.canvas,this.onInputEvent)):(kt.removeInputEventListener(t,this.onInputEvent),xt.removeInputEventListener(t,this.onInputEvent)),this.dispatchEvent(new CustomEvent("detach",{composed:!0,bubbles:!1,detail:{eventTarget:t,inputCallback:this.onInputEvent}})),this}poll(){this._lastPollTime=performance.now();for(let t in this._inputs){let e=this._inputs[t];switch(e.inputType){case"action":{let n=!1;for(let i of this._inputKeys[t]){let t=i.value;if(t){e.update(t,i),i.consumeKey(),n=!0;break}}n||e.update(0,null)}break;case"range":{let n=0;for(let e of this._inputKeys[t])n+=e.value;e.update(n,null)}break;default:throw new Error("Unknown input type.")}}}onInputEvent(t){let e=t.type;switch(e){case"key":{const e=t.device+":"+t.key;if(e in this._keys){let n=!1;for(let i of this._keys[e])i.updateKey(t,e)&&(n=!0);if(n)return!0}}break;case"pos":{const e=["x","y","dx","dy"];for(let n of e){t.value=t[n];const e=t.device+":"+t.key+"."+n;if(e in this._keys){let n=!1;for(let i of this._keys[e])i.updateKey(t,e)&&(n=!0);if(n)return!0}}}break;default:throw new Error(`Unknown input event type '${e}'.`)}}onAnimationFrame(t){this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.auto&&this.poll();for(let t in this._inputs){let e,n=this._inputs[t];e=n.value?Number(n.value).toFixed(2):0;let i=this._tableInputs[t];if(i.textContent!=e){i.textContent=e;let t=i.parentNode;i.parentNode.removeChild(i),t.appendChild(i)}}}getInput(t){if(t in this._inputs)return this._inputs[t];if(this.strict)throw new Error(`Cannot find input with name '${t}'.`);{let e=new St(t,"range");return this._inputs[t]=e,e}}getInputValue(t){if(t in this._inputs)return this._inputs[t].value;if(this.strict)throw new Error(`Cannot find input with name '${t}'.`);return 0}}function Wt(t,e){for(let n in e){let i=e[n];if(Array.isArray(i))for(let e of i)Rt(t,n,e),"string"==typeof e&&(e={key:e,event:"down"}),Ht(t,n,e);else Rt(t,n,i),"string"==typeof i&&(i={key:i,event:"down"}),Ht(t,n,i)}}function Xt(t){if("object"==typeof t){if("type"in t)return t.type;if("scale"in t)return"range";if("event"in t)return"action";throw new Error(`Missing 'scale' or 'event' for input option '${t}'.`)}if("string"==typeof t)return"action";throw new Error("Invalid type for input mapping option.")}function Ht(t,e,n){let i=document.createElement("tr");{let t=document.createElement("td");t.textContent=e,t.classList.add("name"),i.appendChild(t)}{let t=document.createElement("td");t.classList.add("key");let e=document.createElement("kbd");e.textContent=n.key,t.appendChild(e),i.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp");switch(Xt(n)){case"action":e.textContent=n.event;break;case"range":e.textContent=Number(n.scale).toFixed(2);break;default:e.textContent="<?>"}t.classList.add("mod"),t.appendChild(e),i.appendChild(t)}if(e in t._tableInputs){let t=document.createElement("td");t.classList.add("value"),i.appendChild(t)}else{let n=document.createElement("td"),s=document.createElement("output");s.textContent=0,s.classList.add("flash"),n.classList.add("value"),n.appendChild(s),i.appendChild(n),t._tableInputs[e]=s}t._tableBody.appendChild(i)}function Rt(t,e,n){let i=Xt(n);switch(i){case"action":Yt(t,e,"string"==typeof n?{key:n,event:"down"}:n);break;case"range":!function(t,e,n){const{key:i,scale:s}=n;let o,r,a;if(e in t._inputs){if(o=t._inputs[e],r=t._inputKeys[e],"range"!==o.inputType)throw new Error(`Cannot register mismatched 'range' type input for '${o.inputType}' type input '${e}'.`)}else o=new St(e,"range"),r=[],t._inputs[e]=o,t._inputKeys[e]=r;i in t._keys?a=t._keys[i]:(a=[],t._keys[i]=a);let l=new Ot(i,null,s);a.push(l),r.push(l)}(t,e,n);break;default:throw new Error(`Unknown input type '${i}'.`)}}function Yt(t,e,n){const{key:i,event:s}=n;let o,r,a;if(e in t._inputs){if(o=t._inputs[e],r=t._inputKeys[e],"action"!==o.inputType)throw new Error(`Cannot register mismatched 'action' type input for '${o.inputType}' type input '${e}'.`)}else o=new St(e,"action"),r=[],t._inputs[e]=o,t._inputKeys[e]=r;i in t._keys?a=t._keys[i]:(a=[],t._keys[i]=a);let l=new Ot(i,s,1);a.push(l),r.push(l)}window.customElements.define("input-context",jt);class Ft{constructor(){this.prevTransformMatrix=null,this.domProjectionMatrix=new DOMMatrix,this.domViewMatrix=new DOMMatrix,this.ctx=null}begin(t,e,n){if(this.ctx)throw new Error("View already begun - maybe missing end() call?");e&&Dt(this.domViewMatrix,e),n&&Dt(this.domProjectionMatrix,n),this.prevTransformMatrix=t.getTransform(),t.setTransform(this.domProjectionMatrix);const{a:i,b:s,c:o,d:r,e:a,f:l}=this.domViewMatrix;t.transform(i,s,o,r,a,l),this.ctx=t}end(t){t.setTransform(this.prevTransformMatrix),this.ctx=null}}function Dt(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}class Kt{static screenToWorld(t,n,s,o){let r=function(t,e,n){var i=e[0],s=e[1],o=e[2],r=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],p=e[10],m=e[11],f=e[12],g=e[13],b=e[14],v=e[15],y=n[0],k=n[1],w=n[2],_=n[3];return t[0]=y*i+k*a+w*u+_*f,t[1]=y*s+k*l+w*d+_*g,t[2]=y*o+k*h+w*p+_*b,t[3]=y*r+k*c+w*m+_*v,y=n[4],k=n[5],w=n[6],_=n[7],t[4]=y*i+k*a+w*u+_*f,t[5]=y*s+k*l+w*d+_*g,t[6]=y*o+k*h+w*p+_*b,t[7]=y*r+k*c+w*m+_*v,y=n[8],k=n[9],w=n[10],_=n[11],t[8]=y*i+k*a+w*u+_*f,t[9]=y*s+k*l+w*d+_*g,t[10]=y*o+k*h+w*p+_*b,t[11]=y*r+k*c+w*m+_*v,y=n[12],k=n[13],w=n[14],_=n[15],t[12]=y*i+k*a+w*u+_*f,t[13]=y*s+k*l+w*d+_*g,t[14]=y*o+k*h+w*p+_*b,t[15]=y*r+k*c+w*m+_*v,t}(e(),o,s);!function(t,e){var n=e[0],i=e[1],s=e[2],o=e[3],r=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],p=e[11],m=e[12],f=e[13],g=e[14],b=e[15],v=n*a-i*r,y=n*l-s*r,k=n*h-o*r,w=i*l-s*a,_=i*h-o*a,E=s*h-o*l,x=c*f-u*m,C=c*g-d*m,M=c*b-p*m,I=u*g-d*f,L=u*b-p*f,S=d*b-p*g,A=v*S-y*L+k*I+w*M-_*C+E*x;A&&(A=1/A,t[0]=(a*S-l*L+h*I)*A,t[1]=(s*L-i*S-o*I)*A,t[2]=(f*E-g*_+b*w)*A,t[3]=(d*_-u*E-p*w)*A,t[4]=(l*M-r*S-h*C)*A,t[5]=(n*S-s*M+o*C)*A,t[6]=(g*k-m*E-b*y)*A,t[7]=(c*E-d*k+p*y)*A,t[8]=(r*L-a*M+h*x)*A,t[9]=(i*M-n*L-o*x)*A,t[10]=(m*_-f*k+b*v)*A,t[11]=(u*k-c*_-p*v)*A,t[12]=(a*C-r*I-l*x)*A,t[13]=(n*I-i*C+s*x)*A,t[14]=(f*y-m*w-g*v)*A,t[15]=(c*w-u*y+d*v)*A)}(r,r);let a=i(t,n,0);return function(t,e,n){var i=e[0],s=e[1],o=e[2],r=n[3]*i+n[7]*s+n[11]*o+n[15];r=r||1,t[0]=(n[0]*i+n[4]*s+n[8]*o+n[12])/r,t[1]=(n[1]*i+n[5]*s+n[9]*o+n[13])/r,t[2]=(n[2]*i+n[6]*s+n[10]*o+n[14])/r}(a,a,r),a}constructor(t=-1,s=1,o=-1,r=1,l=0,h=1){this.position=n(),this.rotation=a(),this.scale=i(1,1,1),this.clippingPlane={left:t,right:s,top:o,bottom:r,near:l,far:h},this._viewMatrix=e(),this._projectionMatrix=e()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,n=0,s=1){let o=i(t,e,n);!function(t,e,n,i){var s=e[0],o=e[1],r=e[2];t[0]=s+i*(n[0]-s),t[1]=o+i*(n[1]-o),t[2]=r+i*(n[2]-r)}(this.position,this.position,o,Math.min(1,s))}getViewMatrix(t=this._viewMatrix){let e=-Math.round(this.x),n=-Math.round(this.y),s=0===this.z?1:1/this.z,o=i(e,n,0),r=i(this.scale[0]*s,this.scale[1]*s,1);return function(t,e,n,i){var s=e[0],o=e[1],r=e[2],a=e[3],l=s+s,h=o+o,c=r+r,u=s*l,d=s*h,p=s*c,m=o*h,f=o*c,g=r*c,b=a*l,v=a*h,y=a*c,k=i[0],w=i[1],_=i[2];t[0]=(1-(m+g))*k,t[1]=(d+y)*k,t[2]=(p-v)*k,t[3]=0,t[4]=(d-y)*w,t[5]=(1-(u+g))*w,t[6]=(f+b)*w,t[7]=0,t[8]=(p+v)*_,t[9]=(f-b)*_,t[10]=(1-(u+m))*_,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(t,this.rotation,o,r),t}getProjectionMatrix(t=this._projectionMatrix){let{left:e,right:n,top:i,bottom:s,near:o,far:r}=this.clippingPlane;return function(t,e,n,i,s,o,r){var a=1/(e-n),l=1/(i-s),h=1/(o-r);t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*a,t[13]=(s+i)*l,t[14]=(r+o)*h,t[15]=1}(t,e,n,i,s,o,r),t}}function Ut(t,e){return t+","+e}function $t(t){let e=t.indexOf(",");return[Number(t.substring(0,e)),Number(t.substring(e+1))]}class qt{constructor(t,e,n,i,s){this.chunkManager=t,this.chunkId=e,this.chunkCoordX=n,this.chunkCoordY=i,this._data=s}get data(){return this._data}}class zt{constructor(t,e){const n=t*e;this.block=new Uint8Array(n).fill(0),this.meta=new Uint8Array(n).fill(0),this.neighbor=new Uint8Array(n).fill(15)}}class Vt{constructor(t,e){this._chunkWidth=t,this._chunkHeight=e,this._x=0,this._y=0,this._blockCoordX=0,this._blockCoordY=0,this._index=0,this._chunkCoordX=0,this._chunkCoordY=0,this._chunkId=null}get x(){return this._x}get y(){return this._y}get blockCoordX(){return this._blockCoordX}get blockCoordY(){return this._blockCoordY}get index(){return this._index}get chunkCoordX(){return this._chunkCoordX}get chunkCoordY(){return this._chunkCoordY}get chunkId(){return this._chunkId}clone(){return new Vt(this._chunkWidth,this._chunkHeight)}set(t,e){this._x=t,this._y=e;const n=this._chunkWidth,i=this._chunkHeight;return this._blockCoordX=t<0?Math.abs(n+Math.floor(t))%n:Math.floor(t)%n,this._blockCoordY=e<0?Math.abs(i+Math.floor(e))%i:Math.floor(e)%i,this._index=this._blockCoordX+this._blockCoordY*n,this._chunkCoordX=Math.floor(t/n),this._chunkCoordY=Math.floor(e/i),this._chunkId=Ut(this._chunkCoordX,this._chunkCoordY),this}copy(t=this.clone()){return t._x=this.x,t._y=this.y,t._blockCoordX=this.blockCoordX,t._blockCoordY=this.blockCoordY,t._index=this.index,t._chunkCoordX=this.chunkCoordX,t._chunkCoordY=this.chunkCoordY,t._chunkId=this.chunkId,t}offset(t=this,e=0,n=0){return t.set(this.x+e,this.y+n)}down(t=this,e=1){return t.set(this.x,this.y+e)}up(t=this,e=1){return t.set(this.x,this.y-e)}right(t=this,e=1){return t.set(this.x+e,this.y)}left(t=this,e=1){return t.set(this.x-e,this.y)}reset(t=null){return t?t.copy(this):this.set(0,0)}equals(t){return Math.abs(this.x-t.x)<Number.EPSILON&&Math.abs(this.y-t.y)<Number.EPSILON}toString(t=!1){return`BlockPos(${this.x},${this.y})`+(t?`:Chunk[${this.chunkId}]@{${this.blockCoordX},${this.blockCoordY}}[${this.index}],`:"")}}class Jt extends class{constructor(t,e){this.chunkWidth=t,this.chunkHeight=e,this.chunks={}}clear(){this.chunks={}}getChunkById(t){if(t in this.chunks)return this.chunks[t];{const[e,n]=$t(t);let i=new zt(this.chunkWidth,this.chunkHeight),s=new qt(this,t,e,n,i);return this.chunks[t]=s,s}}getChunkByCoord(t,e){const n=Ut(t,e);return this.getChunkById(n)}getChunksWithinBounds(t,e){let n=[];const i=t.chunkCoordX,s=t.chunkCoordY,o=e.chunkCoordX,r=e.chunkCoordY;for(let t=s;t<=r;++t)for(let e=i;e<=o;++e){const i=Ut(e,t);n.push(this.getChunkById(i))}return n}getLoadedChunks(){let t=[];for(let e of Object.keys(this.chunks)){let n=this.chunks[e];t.push(n)}return t}}{constructor(t=-1/0,e=-1/0,n=1/0,i=1/0,s=(Number.isFinite(n-t)?n-t:16),o=(Number.isFinite(i-e)?i-e:16)){super(s,o),this.bounds={left:t,right:n,top:e,bottom:i}}isWithinBounds(t){if(!t)return!1;const{x:e,y:n}=t;return e<=this.bounds.right&&e>=this.bounds.left&&n<=this.bounds.bottom&&n>=this.bounds.top}isWithinLoaded(t){return t.chunkId in this.chunks}getChunk(t){return this.getChunkById(t.chunkId)}getBlockId(t){return this.getChunkById(t.chunkId).data.block[t.index]}getBlockMeta(t){return this.getChunkById(t.chunkId).data.meta[t.index]}getBlockNeighbor(t){return this.getChunkById(t.chunkId).data.neighbor[t.index]}setBlockId(t,e){return this.getChunkById(t.chunkId).data.block[t.index]=e,this}setBlockMeta(t,e){return this.getChunkById(t.chunkId).data.meta[t.index]=e,this}setBlockNeighbor(t,e){return this.getChunkById(t.chunkId).data.neighbor[t.index]=e,this}at(t,e){return new Vt(this.chunkWidth,this.chunkHeight).set(t,e)}}class Gt{constructor(t,e,n){this.blockRegistry=t,this.blockId=e,this.blockOpts=n;for(let[i,s]of n)this[i]=t.getComponent(i,e)}toString(){return`Block#${this.blockId}`}}const Zt=new class{constructor(){this.blocks={},this.components={}}register(t,...e){if(t in this.blocks)throw new Error(`BlockId '${t}' already registered.`);const n=e.map((t=>Array.isArray(t)?t:[t,!0]));for(let[e,i]of n){e in this.components||(this.components[e]={});let n,s=this.components[e];if(t in s)throw new Error(`Component '${e}' for block '${t}' already registered.`);n="object"==typeof i?Object.assign({},i):i,s[t]=n}let i=new Gt(this,t,n);return this.blocks[t]=i,i}getBlock(t){return t in this.blocks?this.blocks[t]:null}getBlocks(){return Object.values(this.blocks)}getBlockIds(){return Object.keys(this.blocks)}getBlockComponents(t){let e=[];for(let n of this.components)t in n&&e.push(n[t]);return e}hasComponent(t,e){return t in this.components&&e in this.components[t]}getComponent(t,e){if(t in this.components){let n=this.components[t];if(e in n)return n[e]}return null}getComponents(t){if(t in this.components){let e=this.components[t];return Object.values(e)}}getComponentNames(){return Object.keys(this.components)}},Qt=(Zt.register(0,"air"),Zt.register(1,"fluid",["color","dodgerblue"],["material","fluid"]),Zt.register(3,"solid","grassSoil",["color","saddlebrown"],["material","dirt"])),te=Zt.register(4,"solid",["color","gold"],["material","metal"]),ee=Zt.register(5,"solid",["color","limegreen"],["material","dirt"]),ne=(Zt.register(6,"solid",["color","slategray"],["material","stone"]),Zt.register(7,"solid",["color","salmon"],["material","stone"]),Zt.register(8,"solid",["color","powderblue"],["material","metal"]),Zt.register(9,"solid",["color","rebeccapurple"],["material","stone"]),Zt.register(10,"solid",["color","teal"],["material","stone"]),Zt.register(11,"solid",["color","mediumvioletred"],["material","stone"]),Zt.register(12,"solid",["color","navajowhite"],["material","dirt"]),"place");const ie="worldUpdate",se="blockUpdate";function oe(t,e){t.emit("chunkUpdate",t,e)}function re(t,e,n){t.emit(se,t,e,n)}const ae="air",le="fluid";function he(t,e,n){Zt.hasComponent(le,n)&&t.map.setBlockMeta(e,3)}function ce(t){let e=t.map.getLoadedChunks().sort(((t,e)=>t.chunkCoordY<e.chunkCoordY?1:t.chunkCoordY>e.chunkCoordY?-1:t.chunkCoordX<e.chunkCoordX?1:t.chunkCoordX>e.chunkCoordX?-1:0));for(let n of e)ue(t,n)}function ue(t,e){const n=t.map,i=e.chunkCoordX*n.chunkWidth,s=e.chunkCoordY*n.chunkHeight;let o=n.at(0,0);for(let e=n.chunkHeight-1;e>=0;--e)for(let r=0;r<n.chunkWidth;++r){o.set(r+i,e+s);let a=n.getBlockId(o);Zt.hasComponent(le,a)&&de(t,o)}}function de(t,e){const n=t.map;!function(t,e){let n=e.copy().down();return pe(t,e,n,3)}(n,e)&&function(t,e){let n=!1,i=t.getBlockMeta(e),s=e.copy();i<=1?(e.offset(s,1*Z.sign(),0),n|=pe(t,e,s,1,!1)):(e.offset(s,1*Z.sign(),0),n|=pe(t,e,s,1,!1),e.offset(s,1*Z.sign(),0),n|=pe(t,e,s,1,!1))}(n,e)}function pe(t,e,n,i,s=!0){if(!t.isWithinBounds(n))return!1;if(!t.isWithinLoaded(n))return t.setBlockId(e,0),t.setBlockMeta(e,0),!0;let o=t.getBlockId(e),r=t.getBlockMeta(e),a=t.getBlockId(n),l=t.getBlockMeta(n);if(i>r&&(i=r),Zt.hasComponent(ae,a)){let s=r-i;return s<=0?(t.setBlockId(n,o).setBlockMeta(n,r).setBlockId(e,0).setBlockMeta(e,0),!0):(t.setBlockId(n,o).setBlockMeta(n,i).setBlockMeta(e,s),!0)}if(Zt.hasComponent(le,a)&&l<3){if(!s&&r<=l)return!1;if(l+i<=3)return t.setBlockMeta(n,l+i),i>=r?t.setBlockId(e,0).setBlockMeta(e,0):t.setBlockMeta(e,r-i),!0;{t.setBlockMeta(n,3);let s=i-(3-l);return t.setBlockMeta(e,s),!0}}}function me(t,e,n,i){let s=e.map.getBlockId(n);Zt.hasComponent("air",s)||(Zt.hasComponent("fluid",s)?function(t,e,n,i,s){const o=e.map,r=o.getBlockMeta(n),a=r<=0?1:r/3,l=Zt.getComponent("color",s);t.fillStyle=l,t.fillRect(0,(1-a)*i,i,i*a);let h=Date.now()/2e3,c=n.x/o.chunkWidth,u=n.y/o.chunkHeight,d=n.blockCoordX%2==0,p=n.blockCoordY%2==0,m=Math.sin(h+c-u+(d?.3:0)+(p?.1:0));t.fillStyle=`rgba(0, 0, 100, ${(m+1)/2*.4})`,t.fillRect(0,(1-a)*i,i,i*a)}(t,e,n,i,s):Zt.hasComponent("solid",s)&&function(t,e,n,i,s){const o=e.map,r=Zt.getComponent("color",s);if(t.fillStyle=r,t.fillRect(0,0,i,i),s===te.blockId){let e=Date.now()/500,s=n.x/o.chunkWidth,r=n.y/o.chunkHeight,a=Math.sin(e+4*s+4*r);t.fillStyle=`rgba(255, 255, 255, ${Math.max(0,a-.6)})`,t.fillRect(0,0,i,i)}else if(s===Qt.blockId){let e=n.blockCoordX%2==0,s=n.blockCoordY%2==0;t.fillStyle=`rgba(0, 0, 0, ${e&&s?.1:0})`,t.fillRect(0,0,i,i);const r=o.getBlockNeighbor(n),a=Math.ceil(i/4);if(!((2&r)>>1>0)){let e=o.getBlockId(n.up());Zt.hasComponent(ae,e)&&(t.fillStyle="limegreen",t.fillRect(0,0,i,a)),n.down()}}else if(s===ee.blockId){let e=n.blockCoordX%2==0;t.fillStyle=`rgba(0, 0, 0, ${e?.1:0})`,t.fillRect(0,0,i,i)}}(t,e,n,i,s))}function fe(t,e,n){const i=e.chunkWidth*n,s=e.chunkHeight*n;for(let o of e.getLoadedChunks()){const r=o.chunkCoordX*i,a=o.chunkCoordY*s;t.translate(r,a),ge(t,e,o,n),t.translate(-r,-a)}}function ge(t,e,n,i){const s=e.chunkWidth,o=e.chunkHeight,r=n.chunkCoordX*s,a=n.chunkCoordY*o;let l=e.at(r,a);for(let n=0;n<o;++n)for(let o=0;o<s;++o)l.set(o+r,n+a),t.translate(o*i,n*i),me(t,{map:e},l,i),t.translate(-o*i,-n*i)}function be(t,e,n,i=0){const s=t.map.getBlockId(e),o=Zt.hasComponent(le,n);if(o){if(!Zt.hasComponent(ae,s))return}else{!function(t,e,n){t.emit("break",t,e,n)}(t,e,s);Zt.hasComponent(le,s)||function(t,e,n){const i=t.map;let s=e.clone();i.isWithinBounds(e.right(s))&&i.getBlockId(s)===n&&i.setBlockNeighbor(s,11&i.getBlockNeighbor(s)),i.isWithinBounds(e.up(s))&&i.getBlockId(s)===n&&i.setBlockNeighbor(s,7&i.getBlockNeighbor(s)),i.isWithinBounds(e.left(s))&&i.getBlockId(s)===n&&i.setBlockNeighbor(s,14&i.getBlockNeighbor(s)),i.isWithinBounds(e.down(s))&&i.getBlockId(s)===n&&i.setBlockNeighbor(s,13&i.getBlockNeighbor(s)),i.setBlockNeighbor(e,0)}(t,e,s)}t.map.setBlockId(e,n),t.map.setBlockMeta(e,i),o||function(t,e,n){const i=t.map;let s=e.clone(),o=0;i.isWithinBounds(e.right(s))&&i.getBlockId(s)===n&&(o|=1,i.setBlockNeighbor(s,4|i.getBlockNeighbor(s))),i.isWithinBounds(e.up(s))&&i.getBlockId(s)===n&&(o|=2,i.setBlockNeighbor(s,8|i.getBlockNeighbor(s))),i.isWithinBounds(e.left(s))&&i.getBlockId(s)===n&&(o|=4,i.setBlockNeighbor(s,1|i.getBlockNeighbor(s))),i.isWithinBounds(e.down(s))&&i.getBlockId(s)===n&&(o|=8,i.setBlockNeighbor(s,2|i.getBlockNeighbor(s))),i.setBlockNeighbor(e,o)}(t,e,n),function(t,e,n){t.emit(ne,t,e,n)}(t,e,n)}function ve(t,e,n){const i=t.map;let s=i.getBlockId(n);if(Zt.hasComponent("grassSoil",s)){let e=i.getBlockId(n.up());Zt.hasComponent(ae,e)&&Z.next()<.001&&be(t,n,5)}}const ye="material",ke={};function we(t){switch(function(t){return Zt.hasComponent(ye,t)?Zt.getComponent(ye,t):"stone"}(t)){case"dirt":ke.dirt.play({pitch:Z.range(-5,5)});break;case"fluid":ke.fluid.play({pitch:Z.range(-5,5)});break;case"metal":ke.metal.play({gain:4,pitch:Z.range(-5,5)});break;case"stone":default:ke.stone.play({gain:1.5,pitch:Z.range(-5,5)})}}function _e(t){let e=t.map.getLoadedChunks().sort(((t,e)=>t.chunkCoordY<e.chunkCoordY?1:t.chunkCoordY>e.chunkCoordY?-1:t.chunkCoordX<e.chunkCoordX?1:t.chunkCoordX>e.chunkCoordX?-1:0));for(let n of e)Ee(t,n)}function Ee(t,e){const n=t.map,i=e.chunkCoordX*n.chunkWidth,s=e.chunkCoordY*n.chunkHeight;let o=n.at(0,0);for(let e=n.chunkHeight-1;e>=0;--e)for(let r=0;r<n.chunkWidth;++r){o.set(r+i,e+s);let a=n.getBlockId(o);Zt.hasComponent("falling",a)&&xe(t,o)}}function xe(t,e){!function(t,e){let n=e.copy().down();(function(t,e,n){if(!t.isWithinBounds(n))return!1;if(!t.isWithinLoaded(n))return t.setBlockId(e,0),!0;let i=t.getBlockId(e),s=t.getBlockId(n);if(Zt.hasComponent("air",s))t.setBlockId(n,i).setBlockId(e,0)})(t,e,n)}(t.map,e)}const Ce=[[{w:1,h:4,m:[1,1,1,1]},{w:4,h:1,m:[1,1,1,1]}],[{w:2,h:2,m:[1,1,1,1]}],[{w:3,h:2,m:[0,1,0,1,1,1]},{w:2,h:3,m:[1,0,1,1,1,0]},{w:3,h:2,m:[1,1,1,0,1,0]},{w:2,h:3,m:[0,1,1,1,0,1]}],[{w:2,h:3,m:[0,1,0,1,1,1]},{w:3,h:2,m:[1,0,0,1,1,1]},{w:2,h:3,m:[1,1,1,0,1,0]},{w:3,h:2,m:[1,1,1,0,0,1]}],[{w:2,h:3,m:[1,0,1,0,1,1]},{w:3,h:2,m:[0,0,1,1,1,1]},{w:2,h:3,m:[1,1,0,1,0,1]},{w:3,h:2,m:[1,1,1,1,0,0]}],[{w:3,h:2,m:[0,1,1,1,1,0]},{w:2,h:3,m:[1,0,1,1,0,1]}],[{w:3,h:2,m:[1,1,0,0,1,1]},{w:2,h:3,m:[0,1,1,1,1,0]}]];let Me=1/0,Ie=1/0,Le=1,Se=1;for(let t of Ce)for(let e of t)Me=Math.min(e.w,Me),Ie=Math.min(e.h,Ie),Le=Math.max(e.w,Le),Se=Math.max(e.h,Se);const Ae=Le,Be=Se,Te=[1,3,4,6,7,8,9,10,11,12];function Oe(t,e,n,i,s,o,r,a,l){const h=s.map;if(e.placing){const t=e.shape,n=Math.min(h.bounds.right-t.w,Math.max(h.bounds.left,o-Math.floor((t.w-1)/2))),i=Math.min(h.bounds.bottom-t.h,Math.max(h.bounds.top,r-Math.floor((t.h-1)/2)));if(e.floating){const s=Math.sign(n-e.placeX),o=Math.sign(i-e.placeY);Ne(t,e.placeX+s,e.placeY+o,h)||(e.floating=!1),e.placeX+=s,e.placeY+=o,e.valid=!1}else{const s=e.placeX;s<n?Ne(t,s+1,e.placeY,h)||(e.placeX+=1):s>n&&(Ne(t,s-1,e.placeY,h)||(e.placeX-=1));const o=e.placeY;o<i?Ne(t,e.placeX,o+1,h)||(e.placeY+=1):o>i&&(Ne(t,e.placeX,o-1,h)||(e.placeY-=1)),e.valid=function(t,e,n,i,s){if(Zt.hasComponent(le,t))return!0;let o=s.at(n,i);const{w:r,h:a,m:l}=e;for(let t=0;t<a;++t)for(let e=0;e<r;++e){if(o.set(e+n,t+i),l[e+t*r]){if(!s.isWithinLoaded(o))continue;if(15!==s.getBlockNeighbor(o))return!0}}return!1}(e.value,t,e.placeX,e.placeY,h)}}e.placeTicks<=0?e.placing?(n.value&&e.valid&&(!function(t,e,n,i,s){const{w:o,h:r,m:a}=e;let l=s.map.at(0,0);for(let e=0;e<r;++e)for(let r=0;r<o;++r){a[r+e*o]&&(l.set(r+n,e+i),be(s,l,t))}}(e.value,e.shape,e.placeX,e.placeY,s),e.placing=!1,e.placeTicks=30,a(e)),i.value&&(e.placing=!1)):(!function(t){const e=Z.choose(Ce),n=Math.floor(Z.range(0,e.length)),i=t.value;let s=!1;switch(i){case 0:s=!0;break;case 1:s=Z.next()<1/4;break;case 3:s=Z.next()<1/8;break;case 4:s=Z.next()<1/4;break;case 6:s=Z.next()<1/8;break;default:s=Z.next()<1/6}const o=s?Z.choose(Te):i;t.value=o,t.shapeType=e,t.shape=e[n],t.shapeMap.clear(),function(t,e,n,i,s){const{w:o,h:r,m:a}=e;let l=s.at(0,0);for(let e=0;e<r;++e)for(let r=0;r<o;++r){a[r+e*o]&&(l.set(r+n,e+i),s.setBlockId(l,t))}}(o,t.shape,0,0,t.shapeMap)}(e),e.placing=!0,e.floating=!0,e.valid=!1,l(e)):e.placeTicks-=t}function Ne(t,e,n,i){const{w:s,h:o,m:r}=t;let a=i.at(0,0);for(let t=0;t<o;++t)for(let o=0;o<s;++o){if(r[o+t*s]){if(a.set(o+e,t+n),!i.isWithinLoaded(a))continue;let s=i.getBlockId(a);if(Zt.hasComponent(le,s)){if(i.getBlockMeta(a)>=3)return!0}else if(!Zt.hasComponent(ae,s))return!0}}return!1}function Pe(t,e){const n=t.map.chunkWidth,i=t.map.chunkHeight;if(n!==e.chunkWidth||i!==e.chunkHeight)return null;t.score=e.score||0,t.cameraX=e.cameraX||0,t.cameraY=e.cameraY||0;const s=n*i;for(let o of Object.keys(e.chunks)){const r=e.chunks[o],[a,l]=$t(o);let h=new zt(n,i);for(let t=0;t<s;++t)h.block[t]=r.block[t],h.meta[t]=r.meta[t],h.neighbor[t]=r.neighbor[t];let c=new qt(this,o,a,l,h);t.map.chunks[o]=c}return t}function je(t,e){const n=t.map.chunkWidth,i=t.map.chunkHeight;e.score=t.score,e.cameraX=t.cameraX,e.cameraY=t.cameraY,e.chunkWidth=n,e.chunkHeight=i;let s={};const o=n*i;for(let e of t.map.getLoadedChunks()){const t=e.chunkId;let n={block:new Array(o),meta:new Array(o),neighbor:new Array(o)};for(let t=0;t<o;++t)n.block[t]=e.data.block[t],n.meta[t]=e.data.meta[t],n.neighbor[t]=e.data.neighbor[t];s[t]=n}return e.chunks=s,e}document.addEventListener("DOMContentLoaded",(async function(){const t=document.querySelector("display-port"),e=document.querySelector("input-context"),n=e.getInput("cursorX"),i=e.getInput("cursorY"),s=e.getInput("place"),o=e.getInput("rotate"),r=(e.getInput("debug"),e.getInput("reset")),a=e.getInput("save"),l=e.getInput("load"),h=t.canvas.getContext("2d");h.imageSmoothingEnabled=!1,await async function(t){const e="";We.flick=await mt.loadAudio(e+"arroyo/flick.wav"),We.melt=await mt.loadAudio(e+"arroyo/melt.mp3"),We.reset=We.flick,We.background=We.melt,await async function(){}()}(),await async function(t){ke.dirt=await mt.loadAudio("arroyo/dirt.wav"),ke.stone=await mt.loadAudio("arroyo/stone.wav"),ke.fluid=await mt.loadAudio("arroyo/waterpop.wav"),ke.metal=await mt.loadAudio("arroyo/ding.wav")}();const c=new Ft,u=new Kt,d={map:new Jt,score:0,cameraX:0,cameraY:0,time:0,firstPlace:!0};ht.assign(d),function(t){t.on(ne,he),t.on(ie,ce)}(d),function(t){t.on(se,ve)}(d),function(t){t.on(ie,_e)}(d);let p=localStorage.getItem("worldData");p&&Pe(d,JSON.parse(p))||Xe(d,t);let m=0,f=0;u.moveTo(d.cameraX,d.cameraY);let g={placing:!1,floating:!0,shape:null,shapeType:null,shapeMap:new Jt(0,0,Ae,Be),value:0,placeX:0,placeY:0,placeTicks:0};t.addEventListener("frame",(e=>{const p=e.detail.deltaTime/1e3*60;if(r.value)return localStorage.removeItem("worldData"),d.map.clear(),void Xe(d,t);if(a.value){let t=je(d,{});nt.downloadText("worldData.json",JSON.stringify(t))}else l.value?it.uploadFile([".json"],!1).then((t=>t.text())).then((e=>{let n=JSON.parse(e);d.map.clear(),n&&Pe(d,n)||Xe(d,t)})):d.time+=p;{let e=t.width/t.height,s=e<=1?e:1,o=e<=1?1:1/e,r=n.value-.5,a=i.value-.5;const l=4;let h=Math.atan2(a,r),c=function(t,e,n,i){let s=n-t,o=i-e;return Math.sqrt(s*s+o*o)}(0,0,r,a),m=c<.3?0:c-.3,f=Math.cos(h)*m*4*d.map.chunkWidth*s*l,g=Math.sin(h)*m*4*d.map.chunkWidth*o*l;u.moveTo(ct(u.x,d.cameraX+f,.1*p),ct(u.y,d.cameraY+g,.1*p))}let b=u.getViewMatrix(),v=u.getProjectionMatrix();const[y,k]=Kt.screenToWorld(n.value*t.width,i.value*t.height,b,v),w=Math.floor(y/4),_=Math.floor(k/4);if(Oe(p,g,s,o,d,w,_,(function(e){const[n,i]=Kt.screenToWorld(t.width/2,t.height/2,b,v),s=Math.floor(n/4),o=Math.floor(i/4);let r=Math.ceil((e.placeX-s)/4),a=Math.ceil((e.placeY-o)/4);d.cameraX+=4*r,d.cameraY+=4*a,d.score+=1,we(e.value),d.firstPlace&&(d.firstPlace=!1,We.background.play())}),(function(e){let[s,o]=function(t,e,n,i,s,o,r){let a=0,l=0;switch((t<=.5?0:2)+(e<=.5?0:1)){case 0:{let t=Kt.screenToWorld(0,0,o,r);a=t[0],l=t[1]}break;case 1:{let t=Kt.screenToWorld(0,s,o,r);a=t[0],l=t[1]}break;case 2:{let t=Kt.screenToWorld(i,0,o,r);a=t[0],l=t[1]}break;case 3:{let t=Kt.screenToWorld(i,s,o,r);a=t[0],l=t[1]}}return[Math.floor(a/n),Math.floor(l/n)]}(n.value,i.value,4,t.width,t.height,b,v);e.placeX=s,e.placeY=o,We.reset.play({pitch:Z.range(-5,5)})})),function(t){t.emit("update",t)}(d),m<=0){m=10;{!function(t){t.emit(ie,t)}(d);const t=d.map.getLoadedChunks(),e=d.map.chunkWidth,n=d.map.chunkHeight;let i=d.map.at(0,0);for(let s of t){const t=s.chunkCoordX*e,o=s.chunkCoordY*n;oe(d,s);for(let r=0;r<n;++r)for(let n=0;n<e;++n)i.set(n+t,r+o),re(d,s,i)}}}else m-=p;if(f<=0){f=100;let t=je(d,{});localStorage.setItem("worldData",JSON.stringify(t))}else f-=p;h.clearRect(0,0,t.width,t.height),c.begin(h,b,v),fe(h,d.map,4),g.placing&&(h.translate(4*g.placeX,4*g.placeY),function(t,e,n){fe(t,e.shapeMap,n)}(h,g,4),h.translate(4*-g.placeX,4*-g.placeY)),c.end(h),d.time<300&&(h.fillStyle=`rgba(0, 0, 0, ${1-d.time/300})`,h.fillRect(0,0,t.width,t.height)),h.fillStyle="white",h.fillText(d.score,4,12)}))}));const We={};function Xe(t,e){t.score=0,t.time=0,t.firstPlace=!0;let n=t.map.at(0,0),i=n.clone();be(t,n,te.blockId),be(t,n.offset(i,-1,0),te.blockId),be(t,n.offset(i,0,-1),te.blockId),be(t,n.offset(i,-1,-1),te.blockId),t.cameraX=-e.width/2,t.cameraY=-e.height/2}}();
