!function(){"use strict";const t="noscale";class e extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <div class="content">\n        <canvas>\n            Oh no! Your browser does not support canvas.\n        </canvas>\n        <slot id="inner"></slot>\n    </div>\n    <slot name="frame"></slot>\n</div>',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block;color:#555}.container{display:flex;position:relative;width:100%;height:100%}.content{position:relative;margin:auto}.content>*{width:100%;height:100%}canvas{background:#000;-ms-interpolation-mode:nearest-neighbor;image-rendering:-moz-crisp-edges;image-rendering:pixelated}label{font-family:monospace;color:currentColor}#inner,label{position:absolute}#inner{display:flex;flex-direction:column;align-items:center;justify-content:center;top:0;left:0;pointer-events:none}#title{left:.5rem;top:.5rem}#fps{right:.5rem;top:.5rem}#dimension{left:.5rem;bottom:.5rem}.hidden{display:none}:host([debug]) .container{outline:6px dashed rgba(0,0,0,.1);outline-offset:-4px;background-color:rgba(0,0,0,.1)}:host([mode=noscale]) canvas{margin:0;top:0;left:0}:host([mode=center]),:host([mode=fit]),:host([mode=stretch]){width:100%;height:100%}:host([full]){width:100vw!important;height:100vh!important}:host([disabled]){display:none}slot{display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}::slotted(*){pointer-events:auto}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get observedAttributes(){return["onframe","width","height","disabled","debug","id","class"]}static get properties(){return{width:Number,height:Number,disabled:Boolean,debug:Boolean,mode:{type:String,value:"fit",observed:!1}}}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get height(){return this._height}set height(t){this.setAttribute("height",String(t))}get width(){return this._width}set width(t){this.setAttribute("width",String(t))}static get customEvents(){return["frame"]}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._contentElement=this.shadowRoot.querySelector(".content"),this._innerElement=this.shadowRoot.querySelector("#inner"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onframe")){let t=this.onframe;delete this.onframe,this.onframe=t}if(Object.prototype.hasOwnProperty.call(this,"width")){let t=this.width;delete this.width,this.width=t}if(Object.prototype.hasOwnProperty.call(this,"height")){let t=this.height;delete this.height,this.height=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}if(Object.prototype.hasOwnProperty.call(this,"mode")){let t=this.mode;delete this.mode,this.mode=t}this.hasAttribute("mode")||this.setAttribute("mode","fit"),this.hasAttribute("tabindex")||this.setAttribute("tabindex","0"),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=Number(n);break;case"height":this._height=Number(n);break;case"disabled":this._disabled=null!==n;break;case"debug":this._debug=null!==n;break;case"onframe":this.onframe=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}})(t,0,n)}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}update(e){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const n=e-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=e,this.debug){const e=n<=0?"--":String(Math.round(1e3/n)).padStart(2,"0");if(this._fpsElement.textContent!==e&&(this._fpsElement.textContent=e),this.mode===t){let t=`${this._width}x${this._height}`;this._dimensionElement.textContent!==t&&(this._dimensionElement.textContent=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.textContent!==t&&(this._dimensionElement.textContent=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:e,prevTime:this._prevAnimationFrameTime,deltaTime:n,canvas:this._canvasElement},bubbles:!1,composed:!0}))}updateCanvasSize(){let e=this.shadowRoot.host.getBoundingClientRect();const n=e.width,s=e.height;let i=this._canvasElement,o=this._width,r=this._height;const a=this.mode;if("stretch"===a)o=n,r=s;else if(a!==t){if(n<o||s<r||"fit"===a){let t=n/o,e=s/r;t<e?(o=n,r*=t):(o*=e,r=s)}}o=Math.floor(o),r=Math.floor(r);let l=.5*Math.min(o/this._width,r/this._height);this._innerElement.style=`font-size: ${l}em`,i.clientWidth===o&&i.clientHeight===r||(i.width=this._width,i.height=this._height,this._contentElement.style=`width: ${o}px; height: ${r}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:o,height:r},bubbles:!1,composed:!0})))}}window.customElements.define("display-port",e);const n=1,s=2,i=3,o={NULL:0,DOWN:1,UP:2,MOVE:3,parse(t){if("string"!=typeof t)return o.NULL;switch(t.toLowerCase()){case"down":return o.DOWN;case"up":return o.UP;case"move":return o.MOVE;default:return o.NULL}}},r="*";class a{static isAxis(t){return!1}static isButton(t){return!1}constructor(t,e){this.deviceName=t,this.eventTarget=e,this.listeners={}}destroy(){this.listeners={}}addInputListener(t,e){let n=this.listeners[t];n?n.push(e):(n=[e],this.listeners[t]=n)}removeInputListener(t,e){let n=this.listeners[t];n&&(n.indexOf(e),n.splice(e,1))}dispatchInput(t){const{keyCode:e}=t,n=this.listeners[e];let s=0;if(n){for(let e of n)s|=e(t);return Boolean(s)}for(let e of this.listeners["*"])s|=e(t);return Boolean(s)}}class l{static createAdapter(t,e,n,s,i,o){return{target:t,adapterId:e,deviceName:n,keyCode:s,scale:i,eventCode:o}}constructor(){this.adapters={"*":h()}}add(t){for(let e of t){const{deviceName:t,keyCode:n}=e;let s;t in this.adapters?s=this.adapters[t]:(s=h(),this.adapters[t]=s),n in s?s[n].push(e):s[n]=[e]}}delete(t){for(let e of t){const{deviceName:t,keyCode:n}=e;if(t in this.adapters){let s=this.adapters[t];if(n in s){let t=s[n],i=t.indexOf(e);i>=0&&t.splice(i,1)}}}}clear(){for(let t in this.adapters)this.adapters[t]=h()}poll(t,e,n){const s=this.findAdapters(t,e);for(let t of s){const e=t.eventCode;if(e===o.NULL){const{target:e,scale:s}=t,i=n.value*s;e.poll(i,t)}else{const{target:s,scale:i}=t,o=n.getEvent(e)*i;s.poll(o,t)}}return s.length>0}update(t,e,n){let s=!1;for(let i of this.findAdapters(t,e)){const t=i.eventCode;if(t!==o.NULL){const{target:e,scale:o}=i,r=n.getEvent(t)*o;e.update(r,i),s=!0}}return s}reset(t,e,n){let s=!1;for(let n of this.findAdapters(t,e))n.target.reset(),s=!0;return s}findAdapters(t,e){let n=[];if(t in this.adapters){let s=this.adapters[t];e in s&&n.push(...s[e]),n.push(...s["*"])}let s=this.adapters["*"];return e in s&&n.push(...s[e]),n.push(...s["*"]),n}}function h(){return{[r]:[]}}class c{constructor(){this.value=0,this.prev=0}update(t){this.value=t}poll(){this.prev=this.value,this.value=0}getEvent(t){return 0}getState(){return this.value}getPrevState(){return this.prev}}class u extends c{constructor(){super(),this.delta=0,this.next={delta:0}}update(t,e){this.value=t,this.next.delta+=e}poll(){this.prev=this.value,this.delta=this.next.delta,this.next.delta=0}getEvent(t){switch(t){case o.MOVE:return this.delta;default:return super.getEvent(t)}}}class d extends c{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(t){t?this.next.down=!0:this.next.up=!0}poll(){this.prev=this.value;const{up:t,down:e}=this.next;this.value?this.up&&!t&&(this.value=0):e&&(this.value=1),this.down=e,this.up=t,this.next.down=!1,this.next.up=!1}getEvent(t){switch(t){case o.DOWN:return 1&this.down;case o.UP:return 1&this.up;default:return super.getEvent(t)}}}const p=1,m=2;class g{constructor(t=[]){this.onInputEvent=this.onInputEvent.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this);let e={},n={};for(let s of t){const t=s.deviceName;if(t in e)throw new Error(`Another device with name '${t}' already exists.`);e[t]=s,n[t]={},s.addInputListener(r,this.onInputEvent)}this.devices=e,this.keyMap=n,this.listeners={poll:[],update:[]},this._lastPollTime=-1,this._autopoll=!1,this._animationFrameHandle=null}get polling(){return performance.now()-this._lastPollTime<1e3}destroy(){this.clearKeys();for(let t in this.devices){let e=this.devices[t];e.removeInputListener(r,this.onInputEvent),e.destroy()}this.devices={}}poll(t=performance.now()){for(const t in this.keyMap){let e=this.keyMap[t];for(const n in e){let s=f(e[n]);s.poll(),this.dispatchInputEvent(m,t,n,s)}}this.dispatchPollEvent(t),this._lastPollTime=t}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let n=this.listeners[t],s=n.indexOf(e);n.splice(s,1)}}countEventListeners(t){if(!(t in this.listeners))throw new Error(`Cannot count listeners for unknown event '${t}'.`);return this.listeners[t].length}dispatchEvent(t,e){for(let n of this.listeners[t])n(e)}dispatchInputEvent(t,e,n,s){this.dispatchEvent("input",{stage:t,deviceName:e,keyCode:n,input:s})}dispatchPollEvent(t){this.dispatchEvent("poll",{now:t})}onInputEvent(t){const e=t.deviceName,r=this.keyMap[e];switch(t.type){case n:{const n=t.keyCode;let s=f(r[n]);if(s)return s.update(t.event===o.DOWN),this.dispatchInputEvent(p,e,n,s),!0}break;case s:{let n=f(r.PosX);n&&(n.update(t.x,t.dx),this.dispatchInputEvent(p,e,"PosX",n));let s=f(r.PosY);s&&(s.update(t.y,t.dy),this.dispatchInputEvent(p,e,"PosY",s))}break;case i:{let n=f(r.WheelX);n&&(n.update(t.dx,t.dx),this.dispatchInputEvent(p,e,"WheelX",n));let s=f(r.WheelY);s&&(s.update(t.dy,t.dy),this.dispatchInputEvent(p,e,"WheelY",s));let i=f(r.WheelZ);i&&(i.update(t.dz,t.dz),this.dispatchInputEvent(p,e,"WheelZ",i))}}}onAnimationFrame(t){this._autopoll&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.poll(t))}set autopoll(t){this._autopoll=t,this._animationFrameHandle&&(cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=null),t&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame))}get autopoll(){return this._autopoll}registerKey(t,e){if(!(t in this.devices))throw new Error(`Invalid device name - missing device with name '${t}' in source.`);let n=this.keyMap[t];if(e in n)n[e].refs+=1;else{let s,i=this.devices[t].constructor;if(i.isAxis(e))s=new u;else{if(!i.isButton(e))throw new Error(`Unknown key code '${e}' for device ${t}.`);s=new d}n[e]=function(t=null){return{refs:1,input:t}}(s)}return this}unregisterKey(t,e){let n=this.keyMap[t];if(n){let t=n[e];t&&(!function(t){t.refs-=1}(t),t.refs<=0&&delete n[e])}}hasKey(t,e){return t in this.keyMap&&e in this.keyMap[t]}clearKeys(){for(let t in this.devices){let e=this.keyMap[t];for(let t in e)e[t].refs=0;this.keyMap[t]={}}}getInputByKey(t,e){return f(this.keyMap[t][e])}}function f(t){return t?t.input:null}class b extends c{constructor(){super(),this.update=this.update.bind(this),this.adapters=[],this.values=[],this.next={values:[],value:0}}hydrate(t){if(!t)return;Array.isArray(t)||(t=[t]);let e=[],n=0;for(let s of t){"string"==typeof s&&(s={key:s});const{key:t,scale:i=1,event:r="null"}=s,{deviceName:a,keyCode:h}=v(t),c=o.parse(r),u=Number(i);let d=l.createAdapter(this,n,a,h,u,c);e.push(d),++n}this.adapters=e,this.values=new Array(e.length).fill(0),this.next={values:new Array(e.length).fill(0),value:0}}poll(t,e){this.prev=this.value;const n=e.adapterId;let s=this.values[n];this.values[n]=t,this.value=this.value-s+t,this.next.values[n]=0,this.next.value+=t-s}update(t,e){const n=e.adapterId;let s=this.next.values[n];this.next.values[n]=t,this.next.value+=t-s}reset(){this.prev=0,this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function v(t){let e=t.indexOf(":");if(e>=0)return{deviceName:t.substring(0,e),keyCode:t.substring(e+1)};throw new Error("Invalid key string - missing device separator ':'.")}class y{constructor(){this._source=null,this._mapping=null,this._disabled=!0,this._ignoreInputs=this._disabled,this.adapters=new l,this.inputs={},this.listeners={change:[],attach:[],detach:[]},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this)}get source(){return this._source}get mapping(){return this._mapping}get disabled(){return this._disabled}set disabled(t){this.toggle(!t)}setInputMapping(t){const e=this.disabled;this.disabled=!0;let n=this.source,s=this.inputs;n&&w(n,s),this.adapters.clear();let i=this.source,o={};if(t){for(let e in t){let n=t[e],i=s[e]||new b;i.hydrate(n);let r=i.adapters;this.adapters.add(r),o[e]=i}i&&k(i,o)}return this.inputs=o,this._mapping=t,this.dispatchChangeEvent(),this.disabled=!this.source||!this.inputs||e,this}attach(t){if(this.source)throw new Error("Already attached to existing input source.");if(!t)throw new Error("Missing input source to attach context.");return k(t,this.inputs),t.addEventListener("poll",this.onSourcePoll),t.addEventListener("input",this.onSourceInput),this._source=t,this.toggle(!0),this.dispatchAttachEvent(),this}detach(){let t=this.source,e=this.inputs;return t&&(this.toggle(!1),t.removeEventListener("poll",this.onSourcePoll),t.removeEventListener("input",this.onSourceInput),e&&w(t,e),this._source=null,this.dispatchDetachEvent()),this}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let n=this.listeners[t],s=n.indexOf(e);n.splice(s,1)}}countEventListeners(t){if(!(t in this.listeners))throw new Error(`Cannot count listeners for unknown event '${t}'.`);return this.listeners[t].length}dispatchEvent(t,e){for(let n of this.listeners[t])n(e)}dispatchChangeEvent(){this.dispatchEvent("change",{})}dispatchAttachEvent(){this.dispatchEvent("attach",{})}dispatchDetachEvent(){this.dispatchEvent("detach",{})}onSourceInput(t){if(t.consumed||this._ignoreInputs){const{deviceName:e,keyCode:n,input:s}=t;this.adapters.reset(e,n,s)}else{const{stage:e,deviceName:n,keyCode:s,input:i}=t;switch(e){case m:this.adapters.poll(n,s,i);break;case p:this.adapters.update(n,s,i);break;default:throw new Error("Unknown input source stage.")}t.consumed=!0}}onSourcePoll(t){this._ignoreInputs!==this.disabled&&(this._ignoreInputs=this.disabled)}toggle(t=this._disabled){let e=!t;if(!e&&!this.source)throw new Error("Input source must be set before enabling input context.");return this._disabled=e,this}hasInput(t){return t in this.inputs&&this.inputs[t].adapters.length>0}getInput(t){if(t in this.inputs)return this.inputs[t];{let e=new b;return this.inputs[t]=e,this._mapping[t]="",this.dispatchChangeEvent(),e}}getInputState(t){return t in this.inputs?this.inputs[t].value:0}getInputChanged(t){if(t in this.inputs){let e=this.inputs[t];return e.value-e.prev}return 0}}function k(t,e){for(let n in e){let{adapters:s}=e[n];for(let e of s){const{deviceName:n,keyCode:s}=e;t.registerKey(n,s)}}}function w(t,e){for(let n in e){let{adapters:s}=e[n];for(let e of s){const{deviceName:n,keyCode:s}=e;t.unregisterKey(n,s)}}}class _ extends a{static isAxis(t){return!1}static isButton(t){return!0}constructor(t,e={}){super("Keyboard",t);const{repeat:s=!1}=e;this.repeat=s,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:o.NULL,type:n,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)}destroy(){let t=this.eventTarget;t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._eventObject;return e.keyCode=t.code,e.event=o.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onKeyUp(t){let e=this._eventObject;if(e.keyCode=t.code,e.event=o.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}}class E extends a{static isAxis(t){return"PosX"===t||"PosY"===t||"WheelX"===t||"WheelY"===t||"WheelZ"===t}static isButton(t){return!this.isAxis(t)}constructor(t,e={eventsOnFocus:!0}){super("Mouse",t),this.canvasTarget=t instanceof HTMLCanvasElement&&t||t.canvas||t.querySelector("canvas")||t.shadowRoot&&t.shadowRoot.querySelector("canvas")||t,this.eventsOnFocus=e.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:o.NULL,type:n,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:t,deviceName:this.deviceName,keyCode:"Position",event:o.MOVE,type:s,x:0,y:0,dx:0,dy:0},this._wheelObject={target:t,deviceName:this.deviceName,keyCode:"Wheel",event:o.MOVE,type:i,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("contextmenu",this.onContextMenu),t.addEventListener("wheel",this.onWheel),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let t=this.eventTarget;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("contextmenu",this.onContextMenu),t.removeEventListener("wheel",this.onWheel),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(t=!0){t?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(t){this._downHasFocus=!0;let e=this._eventObject;if(e.keyCode="Button"+t.button,e.event=o.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)&&document.activeElement===this.eventTarget)return t.preventDefault(),t.stopPropagation(),!1}onContextMenu(t){return t.preventDefault(),t.stopPropagation(),!1}onWheel(t){let e=this._wheelObject;switch(t.deltaMode){case WheelEvent.DOM_DELTA_LINE:e.dx=10*t.deltaX,e.dy=10*t.deltaY,e.dz=10*t.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:e.dx=100*t.deltaX,e.dy=100*t.deltaY,e.dz=100*t.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:e.dx=t.deltaX,e.dy=t.deltaY,e.dz=t.deltaZ}if(this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}onMouseUp(t){if(!this._downHasFocus)return;this._downHasFocus=!1;let e=this._eventObject;return e.keyCode="Button"+t.button,e.event=o.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onMouseMove(t){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const e=this.canvasTarget,{clientWidth:n,clientHeight:s}=e,i=e.getBoundingClientRect();let o=t.movementX/n,r=t.movementY/s,a=(t.clientX-i.left)/n,l=(t.clientY-i.top)/s,h=this._positionObject;h.x=a,h.y=l,h.dx=o,h.dy=r,this.dispatchInput(h)}}class x extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<kbd>\n    <span id="key"><slot></slot></span>\n    <span id="value" class="hidden"></span>\n</kbd>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML='kbd{position:relative;display:inline-block;border-radius:3px;border:1px solid #888;font-size:.85em;font-weight:700;text-rendering:optimizeLegibility;line-height:12px;height:14px;padding:2px 4px;color:#444;background-color:#eee;box-shadow:inset 0 -3px 0 #aaa;overflow:hidden}kbd:empty:after{content:"<?>";opacity:.6}.disabled{opacity:.6;box-shadow:none;background-color:#aaa}.hidden{display:none}#value{position:absolute;top:0;bottom:0;right:0;font-size:.85em;padding:2px 4px 0;color:#ccc;background-color:#333;box-shadow:inset 0 3px 0 #222}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{name:String,value:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get value(){return this._value}set value(t){this.setAttribute("value",t)}get name(){return this._name}set name(t){this.setAttribute("name",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._keyboardElement=this.shadowRoot.querySelector("kbd"),this._keyElement=this.shadowRoot.querySelector("#key"),this._valueElement=this.shadowRoot.querySelector("#value")}attributeChangedCallback(t,e,n){switch(t){case"name":this._name=n;break;case"value":this._value=n;break;case"disabled":this._disabled=null!==n}((t,e,n)=>{switch(t){case"name":this._keyElement.textContent=n;break;case"value":null!==n?(this._valueElement.classList.toggle("hidden",!1),this._valueElement.textContent=n,this._keyboardElement.style.paddingRight=`${this._valueElement.clientWidth+4}px`):this._valueElement.classList.toggle("hidden",!0);break;case"disabled":this._keyboardElement.classList.toggle("disabled",null!==n)}})(t,0,n)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"name")){let t=this.name;delete this.name,this.name=t}if(Object.prototype.hasOwnProperty.call(this,"value")){let t=this.value;delete this.value,this.value=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}}static get observedAttributes(){return["name","value","disabled"]}}window.customElements.define("input-key",x);class C extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<table>\n    <thead>\n        <tr class="tableHeader">\n            <th colspan=4>\n                <slot></slot>\n            </th>\n        </tr>\n        <tr class="colHeader">\n            <th>name</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:block}table{border-collapse:collapse}table,td,th{border:1px solid #666}td,th{padding:5px 10px}td{text-align:center}thead th{padding:0}.colHeader>th{font-size:.8em;padding:0 10px;letter-spacing:3px;background-color:#aaa;color:#666}.colHeader>th,output{font-family:monospace}output{border-radius:.3em;padding:3px}tr:not(.primary) .name,tr:not(.primary) .value{opacity:.3}tr:nth-child(2n){background-color:#eee}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get customEvents(){return["load"]}get onload(){return this._onload}set onload(t){this._onload&&this.removeEventListener("load",this._onload),this._onload=t,this._onload&&this.addEventListener("load",t)}static get observedAttributes(){return["onload","src"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._inputMap=null,this._tableElements={},this._titleElement=this.shadowRoot.querySelector("#title"),this._bodyElement=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot")}get map(){return this._inputMap}get mapElements(){return this._tableElements}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onload")){let t=this.onload;delete this.onload,this.onload=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let n=t[e];delete t[e],t[e]=n}}(this,"src")}attributeChangedCallback(t,e,n){switch(t){case"onload":this.onload=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"src":if(this._src!==n)if(this._src=n,n.trim().startsWith("{")){let t=JSON.parse(n);this._setInputMap(t)}else fetch(n).then((t=>t.json())).then((t=>this._setInputMap(t)))}})(t,0,n)}get src(){return this.getAttribute("src")}set src(t){switch(typeof t){case"object":{let e=JSON.stringify(t);this._src=e,this._setInputMap(t),this.setAttribute("src",e)}break;case"string":this.setAttribute("src",t);break;default:this.setAttribute("src",JSON.stringify(t))}}_setInputMap(t){let e={},n=[];for(let s in t){let i=[];M(i,s,t[s]),e[s]=i,n.push(...i)}this._bodyElement.innerHTML="";for(let t of n)this._bodyElement.appendChild(t);this._inputMap=t,this._tableElements=e,this.dispatchEvent(new CustomEvent("load",{bubbles:!1,composed:!0,detail:{map:t}}))}}function M(t,e,n){if(Array.isArray(n)){M(t,e,n[0]);let s=n.length;for(let i=1;i<s;++i)t.push(S(e,n[i],!1))}else t.push(S(e,n,!0));return t}function S(t,e,n=!0){if("object"==typeof e){const{key:s,event:i,scale:o}=e;return I(t,s,i,o,0,n)}return I(t,e,null,1,0,n)}function I(t,e,n,s,i,o=!0){let r=document.createElement("tr");o&&r.classList.add("primary");{let e=document.createElement("td");e.textContent=t,e.classList.add("name"),r.appendChild(e)}{let t=document.createElement("td");t.classList.add("key");let n=new x;n.innerText=e,t.appendChild(n),r.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp"),i=[];"string"==typeof n&&"null"!==n&&i.push(n),"number"==typeof s&&1!==s&&i.push(`×(${s.toFixed(2)})`),e.innerText=i.join(" "),t.classList.add("mod"),t.appendChild(e),r.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("output");e.innerText=Number(i).toFixed(2),e.classList.add("value"),t.appendChild(e),r.appendChild(t)}return r}window.customElements.define("input-map",C);const L=Symbol("inputSourceState");class B extends g{static for(t){if(t)return function(t){if(O(t)){let e=Object.getOwnPropertyDescriptor(t,L);return e.value.refs+=1,e.value.state}{let e=new g([new _(t),new E(t)]);return Object.defineProperty(t,L,{value:{state:e,refs:1},configurable:!0}),e}}(t);throw new Error("Cannot get input source for null event target.")}static delete(t){t&&function(t){if(O(t)){let e=Object.getOwnPropertyDescriptor(t,L);if(e.value.refs-=1,e.value.refs<=0){let n=e.value.state;delete t[L],n.destroy()}}}(t)}constructor(){throw super(),new Error("Cannot construct InputSource with new - use InputSourceState() instead.")}}function O(t){return Object.prototype.hasOwnProperty.call(t,L)&&Object.getOwnPropertyDescriptor(t,L).value}class A extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div>\n    <label id="title">\n        input-source\n    </label>\n    <span>|</span>\n    <p>\n        <label for="poll">poll</label>\n        <output id="poll"></output>\n    </p>\n    <p>\n        <label for="focus">focus</label>\n        <output id="focus"></output>\n    </p>\n</div>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=':host{display:inline-block}div{font-family:monospace;color:#666;outline:1px solid #666;padding:4px}p{display:inline;margin:0;padding:0}#focus:empty:after,#poll:empty:after{content:"✗";color:red}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean}}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get customEvents(){return["input","poll","change"]}get onchange(){return this._onchange}set onchange(t){this._onchange&&this.removeEventListener("change",this._onchange),this._onchange=t,this._onchange&&this.addEventListener("change",t)}get onpoll(){return this._onpoll}set onpoll(t){this._onpoll&&this.removeEventListener("poll",this._onpoll),this._onpoll=t,this._onpoll&&this.addEventListener("poll",t)}get oninput(){return this._oninput}set oninput(t){this._oninput&&this.removeEventListener("input",this._oninput),this._oninput=t,this._oninput&&this.addEventListener("input",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._containerElement=this.shadowRoot.querySelector("div"),this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._focusElement=this.shadowRoot.querySelector("#focus"),this._eventTarget=null,this._sourceState=null,this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceInput=this.onSourceInput.bind(this),this.onTargetFocus=this.onTargetFocus.bind(this),this.onTargetBlur=this.onTargetBlur.bind(this),this.onPollStatusCheck=this.onPollStatusCheck.bind(this),this._intervalHandle=null}get eventTarget(){return this._eventTarget}get source(){return this._sourceState}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"oninput")){let t=this.oninput;delete this.oninput,this.oninput=t}if(Object.prototype.hasOwnProperty.call(this,"onpoll")){let t=this.onpoll;delete this.onpoll,this.onpoll=t}if(Object.prototype.hasOwnProperty.call(this,"onchange")){let t=this.onchange;delete this.onchange,this.onchange=t}if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}this.hasAttribute("tabindex")||this.setAttribute("tabindex","0"),this.hasAttribute("for")||this._eventTarget||this.setEventTarget(this),this._intervalHandle=setInterval(this.onPollStatusCheck,1e3)}disconnectedCallback(){this.clearEventTarget(),clearInterval(this._intervalHandle)}attributeChangedCallback(t,e,n){switch(t){case"for":this._for=n;break;case"autopoll":this._autopoll=null!==n;break;case"oninput":this.oninput=new Function("event","with(document){with(this){"+n+"}}").bind(this);break;case"onpoll":this.onpoll=new Function("event","with(document){with(this){"+n+"}}").bind(this);break;case"onchange":this.onchange=new Function("event","with(document){with(this){"+n+"}}").bind(this)}((t,e,n)=>{switch(t){case"for":{let t,e;n?(t=document.getElementById(n),e=`${t.tagName.toLowerCase()}#${n}`):(t=this,e="input-source"),this.setEventTarget(n?document.getElementById(n):this),this._titleElement.innerHTML=`for(${e})`}break;case"autopoll":this._sourceState&&(this._sourceState.autopoll=this._autopoll)}})(t,0,n)}setEventTarget(t){if(this.clearEventTarget(),t){let e=B.for(t);this._sourceState=e,this._eventTarget=t,e.autopoll=this.autopoll,e.addEventListener("poll",this.onSourcePoll),e.addEventListener("input",this.onSourceInput),t.addEventListener("focus",this.onTargetFocus),t.addEventListener("blur",this.onTargetBlur),this.dispatchEvent(new CustomEvent("change",{composed:!0,bubbles:!1}))}return this}clearEventTarget(){if(this._eventTarget){let t=this._eventTarget,e=this._sourceState;this._eventTarget=null,this._sourceState=null,t&&(t.removeEventListener("focus",this.onTargetFocus),t.removeEventListener("blur",this.onTargetBlur),e.removeEventListener("poll",this.onSourcePoll),e.removeEventListener("input",this.onSourceInput),B.delete(t))}}poll(t){this._sourceState.poll(t)}onPollStatusCheck(){this._sourceState&&this._sourceState.polling?this._pollElement.innerHTML="✓":this._pollElement.innerHTML=""}onSourceInput({stage:t,deviceName:e,keyCode:n,input:s}){this.dispatchEvent(new CustomEvent("input",{composed:!0,bubbles:!1,detail:{stage:t,deviceName:e,keyCode:n,input:s}}))}onSourcePoll({now:t}){this.dispatchEvent(new CustomEvent("poll",{composed:!0,bubbles:!1,detail:{now:t}}))}onTargetFocus(){this._focusElement.innerHTML="✓"}onTargetBlur(){this._focusElement.innerHTML=""}static get observedAttributes(){return["oninput","onpoll","onchange","for","autopoll"]}}window.customElements.define("input-source",A);class T extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML="<input-map>\n    <slot></slot>\n    <input-source></input-source>\n</input-map>\n",Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get observedAttributes(){return["for","autopoll","disabled","src"]}constructor(t=new y){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._mapElement=this.shadowRoot.querySelector("input-map"),this._sourceElement=this.shadowRoot.querySelector("input-source"),this._context=t,this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceChange=this.onSourceChange.bind(this),this.onContextChange=this.onContextChange.bind(this),this._sourceElement.addEventListener("poll",this.onSourcePoll),this._sourceElement.addEventListener("change",this.onSourceChange),this._context.addEventListener("change",this.onContextChange)}get context(){return this._context}get source(){return this._sourceElement.source}get mapping(){return this._mapElement.map}get src(){return this._src}set src(t){this.setAttribute("src","string"==typeof t?t:JSON.stringify(t))}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let n=t[e];delete t[e],t[e]=n}}(this,"src")}attributeChangedCallback(t,e,n){switch(t){case"for":this._for=n;break;case"autopoll":this._autopoll=null!==n;break;case"disabled":this._disabled=null!==n}((t,e,n)=>{switch(t){case"for":this._sourceElement.for=n;break;case"src":if(this._src!==n)if(this._src=n,n.trim().startsWith("{")){let t=JSON.parse(n);this.updateMapping(t)}else fetch(n).then((t=>t.json())).then((t=>this.updateMapping(t)));break;case"autopoll":this._sourceElement.autopoll=this._autopoll;break;case"disabled":this._context.source&&(this._context.disabled=this._disabled)}})(t,0,n)}updateMapping(t){this._context.setInputMapping(t),this._mapElement.src=t}onSourcePoll(){for(let[t,e]of Object.entries(this._mapElement.mapElements)){let n=this._context.getInputState(t);e[0].querySelector("output").innerText=Number(n).toFixed(2)}}onSourceChange(){this._context.source&&this._context.detach(),this._sourceElement.source&&(this._context.attach(this._sourceElement.source),this._context.disabled=this._disabled)}onContextChange(){this._mapElement.src=this._context.mapping}hasInput(t){return this._context.hasInput(t)}getInput(t){return this._context.getInput(t)}getInputState(t){return this._context.getInputState(t)}getInputChanged(t){return this._context.getInputChanged(t)}}function P(t){t instanceof PromiseRejectionEvent?window.alert(t.reason.stack):t instanceof ErrorEvent?window.alert(t.error.stack):window.alert(JSON.stringify(t))}window.customElements.define("input-port",T),window.addEventListener("error",P,!0),window.addEventListener("unhandledrejection",P,!0);class N{next(){return 0}}class j extends N{next(){return Math.random()}}class X extends N{constructor(t){super(),this.seed=t,this.a=t}next(){var t=this.a+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}class Y{static get RAND(){let t=new this;return Object.defineProperty(this,"RAND",{value:t}),t}constructor(t){this.generator="number"==typeof t?new X(t):t||new j}static next(){return this.RAND.next()}next(){return this.generator.next()}static choose(t){return this.RAND.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return this.RAND.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static rangeInt(t,e){return this.RAND.rangeInt(t,e)}rangeInt(t,e){return Math.trunc(this.range(t,e))}static sign(){return this.RAND.sign()}sign(){return this.generator.next()<.5?-1:1}}function W(t,e){const n=document.createElement("a"),s=e.indexOf(";");e=e.substring(0,s+1)+"headers=Content-Disposition%3A%20attachment%3B%20filename="+t+";"+e.substring(s+1),n.setAttribute("href",e),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}const R=["svg","g"];function H(t,e=t.cloneNode(!0)){let n=t.childNodes,s=e.childNodes;for(var i=0;i<s.length;i++){let t=s[i],e=t.tagName;if(-1!=R.indexOf(e))H(n[i],t);else if(n[i]instanceof Element){const e=window.getComputedStyle(n[i]);let s=[];for(let t of Object.keys(e))s.push(`${t}:${e.getPropertyValue(t)};`);t.setAttribute("style",s.join(""))}}return e}var F=Object.freeze({__proto__:null,FILE_TYPE_PNG:"png",FILE_TYPE_SVG:"svg",downloadText:function(t,e){W(t,"data:text/plain; charset=utf-8,"+encodeURIComponent(e))},downloadImageFromSVG:function(t,e,n,s,i){const o=function(t){const e=H(t),n=(new XMLSerializer).serializeToString(e);return new Blob([n],{type:"image/svg+xml"})}(n);switch(e){case"png":{const n=URL.createObjectURL(o),r=document.createElement("canvas"),a=r.getContext("2d"),l=window.devicePixelRatio||1;r.width=s*l,r.height=i*l,r.style.width=s+"px",r.style.height=i+"px",a.setTransform(l,0,0,l,0,0);const h=new Image;h.onload=()=>{a.drawImage(h,0,0),URL.revokeObjectURL(n);const s=r.toDataURL("image/"+e).replace("image/"+e,"image/octet-stream");W(t,s)},h.src=n}break;case"svg":{const e=new FileReader;e.onload=()=>{W(t,e.result)},e.readAsDataURL(o)}break;default:throw new Error("Unknown file type '"+e+"'")}},downloadURL:W});var D=Object.freeze({__proto__:null,uploadFile:async function(t=[],e=!1){return new Promise(((n,s)=>{const i=document.createElement("input");i.addEventListener("change",(t=>{n(e?t.target.files:t.target.files[0])})),i.type="file",i.accept=t.join(","),i.style.display="none",i.toggleAttribute("multiple",e),document.body.appendChild(i),i.click(),document.body.removeChild(i)}))}});const $={on(t,e,n=e){let s;if(this.__events.has(t)?s=this.__events.get(t):(s=new Map,this.__events.set(t,s)),s.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return s.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,((...s)=>{this.off(t,n),e.apply(this.__context||this,s)}),n)},emit(t,...e){if(this.__events.has(t)){let n=[];const s=Array.from(this.__events.get(t).values());for(const t of s){let s=t.apply(this.__context||this,e);s&&n.push(s)}return n}return this.__events.set(t,new Map),[]}};function U(t){const e=Object.create($);return e.__events=new Map,e.__context=t,e}function K(t,e){const n=Object.assign(t,$);return n.__events=new Map,n.__context=e,n}function q(t,e){const n=t.prototype;return Object.assign(n,$),n.__events=new Map,n.__context=e,n}var z={create:U,assign:K,mixin:q},V=Object.freeze({__proto__:null,create:U,assign:K,mixin:q,default:z});function J(t,e,n){return t+(e-t)*n}var Z="undefined"!=typeof Float32Array?Float32Array:Array;function G(){var t=new Z(16);return Z!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Q(){var t=new Z(3);return Z!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function tt(t,e,n){var s=new Z(3);return s[0]=t,s[1]=e,s[2]=n,s}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function et(){var t=new Z(4);return Z!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Q(),function(){var t,e=(t=new Z(4),Z!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var nt;Q(),tt(1,0,0),tt(0,1,0),et(),et(),nt=new Z(9),Z!=Float32Array&&(nt[1]=0,nt[2]=0,nt[3]=0,nt[5]=0,nt[6]=0,nt[7]=0),nt[0]=1,nt[4]=1,nt[8]=1;class st{static screenToWorld(t,e,n,s){let i=function(t,e,n){var s=e[0],i=e[1],o=e[2],r=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],p=e[10],m=e[11],g=e[12],f=e[13],b=e[14],v=e[15],y=n[0],k=n[1],w=n[2],_=n[3];return t[0]=y*s+k*a+w*u+_*g,t[1]=y*i+k*l+w*d+_*f,t[2]=y*o+k*h+w*p+_*b,t[3]=y*r+k*c+w*m+_*v,y=n[4],k=n[5],w=n[6],_=n[7],t[4]=y*s+k*a+w*u+_*g,t[5]=y*i+k*l+w*d+_*f,t[6]=y*o+k*h+w*p+_*b,t[7]=y*r+k*c+w*m+_*v,y=n[8],k=n[9],w=n[10],_=n[11],t[8]=y*s+k*a+w*u+_*g,t[9]=y*i+k*l+w*d+_*f,t[10]=y*o+k*h+w*p+_*b,t[11]=y*r+k*c+w*m+_*v,y=n[12],k=n[13],w=n[14],_=n[15],t[12]=y*s+k*a+w*u+_*g,t[13]=y*i+k*l+w*d+_*f,t[14]=y*o+k*h+w*p+_*b,t[15]=y*r+k*c+w*m+_*v,t}(G(),s,n);!function(t,e){var n=e[0],s=e[1],i=e[2],o=e[3],r=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],p=e[11],m=e[12],g=e[13],f=e[14],b=e[15],v=n*a-s*r,y=n*l-i*r,k=n*h-o*r,w=s*l-i*a,_=s*h-o*a,E=i*h-o*l,x=c*g-u*m,C=c*f-d*m,M=c*b-p*m,S=u*f-d*g,I=u*b-p*g,L=d*b-p*f,B=v*L-y*I+k*S+w*M-_*C+E*x;B&&(B=1/B,t[0]=(a*L-l*I+h*S)*B,t[1]=(i*I-s*L-o*S)*B,t[2]=(g*E-f*_+b*w)*B,t[3]=(d*_-u*E-p*w)*B,t[4]=(l*M-r*L-h*C)*B,t[5]=(n*L-i*M+o*C)*B,t[6]=(f*k-m*E-b*y)*B,t[7]=(c*E-d*k+p*y)*B,t[8]=(r*I-a*M+h*x)*B,t[9]=(s*M-n*I-o*x)*B,t[10]=(m*_-g*k+b*v)*B,t[11]=(u*k-c*_-p*v)*B,t[12]=(a*C-r*S-l*x)*B,t[13]=(n*S-s*C+i*x)*B,t[14]=(g*y-m*w-f*v)*B,t[15]=(c*w-u*y+d*v)*B)}(i,i);let o=tt(t,e,0);return function(t,e,n){var s=e[0],i=e[1],o=e[2],r=n[3]*s+n[7]*i+n[11]*o+n[15];r=r||1,t[0]=(n[0]*s+n[4]*i+n[8]*o+n[12])/r,t[1]=(n[1]*s+n[5]*i+n[9]*o+n[13])/r,t[2]=(n[2]*s+n[6]*i+n[10]*o+n[14])/r}(o,o,i),o}constructor(t=-1,e=1,n=-1,s=1,i=0,o=1){this.position=Q(),this.rotation=et(),this.scale=tt(1,1,1),this.clippingPlane={left:t,right:e,top:n,bottom:s,near:i,far:o},this._viewMatrix=G(),this._projectionMatrix=G()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,n=0,s=1){let i=tt(t,e,n);!function(t,e,n,s){var i=e[0],o=e[1],r=e[2];t[0]=i+s*(n[0]-i),t[1]=o+s*(n[1]-o),t[2]=r+s*(n[2]-r)}(this.position,this.position,i,Math.min(1,s))}getViewMatrix(t=this._viewMatrix){let e=-Math.round(this.x),n=-Math.round(this.y),s=0===this.z?1:1/this.z,i=tt(e,n,0),o=tt(this.scale[0]*s,this.scale[1]*s,1);return function(t,e,n,s){var i=e[0],o=e[1],r=e[2],a=e[3],l=i+i,h=o+o,c=r+r,u=i*l,d=i*h,p=i*c,m=o*h,g=o*c,f=r*c,b=a*l,v=a*h,y=a*c,k=s[0],w=s[1],_=s[2];t[0]=(1-(m+f))*k,t[1]=(d+y)*k,t[2]=(p-v)*k,t[3]=0,t[4]=(d-y)*w,t[5]=(1-(u+f))*w,t[6]=(g+b)*w,t[7]=0,t[8]=(p+v)*_,t[9]=(g-b)*_,t[10]=(1-(u+m))*_,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(t,this.rotation,i,o),t}getProjectionMatrix(t=this._projectionMatrix){let{left:e,right:n,top:s,bottom:i,near:o,far:r}=this.clippingPlane;return function(t,e,n,s,i,o,r){var a=1/(e-n),l=1/(s-i),h=1/(o-r);t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*a,t[13]=(i+s)*l,t[14]=(r+o)*h,t[15]=1}(t,e,n,s,i,o,r),t}}function it(t,e){return t+","+e}function ot(t){let e=t.indexOf(",");return[Number(t.substring(0,e)),Number(t.substring(e+1))]}class rt{constructor(t,e,n,s,i){this.chunkManager=t,this.chunkId=e,this.chunkCoordX=n,this.chunkCoordY=s,this._data=i}get data(){return this._data}}class at{constructor(t,e){const n=t*e;this.block=new Uint8Array(n).fill(0),this.meta=new Uint8Array(n).fill(0),this.neighbor=new Uint8Array(n).fill(15)}}class lt{constructor(t,e){this._chunkWidth=t,this._chunkHeight=e,this._x=0,this._y=0,this._blockCoordX=0,this._blockCoordY=0,this._index=0,this._chunkCoordX=0,this._chunkCoordY=0,this._chunkId=null}get x(){return this._x}get y(){return this._y}get blockCoordX(){return this._blockCoordX}get blockCoordY(){return this._blockCoordY}get index(){return this._index}get chunkCoordX(){return this._chunkCoordX}get chunkCoordY(){return this._chunkCoordY}get chunkId(){return this._chunkId}clone(){return new lt(this._chunkWidth,this._chunkHeight)}set(t,e){this._x=t,this._y=e;const n=this._chunkWidth,s=this._chunkHeight;return this._blockCoordX=t<0?Math.abs(n+Math.floor(t))%n:Math.floor(t)%n,this._blockCoordY=e<0?Math.abs(s+Math.floor(e))%s:Math.floor(e)%s,this._index=this._blockCoordX+this._blockCoordY*n,this._chunkCoordX=Math.floor(t/n),this._chunkCoordY=Math.floor(e/s),this._chunkId=it(this._chunkCoordX,this._chunkCoordY),this}copy(t=this.clone()){return t._x=this.x,t._y=this.y,t._blockCoordX=this.blockCoordX,t._blockCoordY=this.blockCoordY,t._index=this.index,t._chunkCoordX=this.chunkCoordX,t._chunkCoordY=this.chunkCoordY,t._chunkId=this.chunkId,t}offset(t=this,e=0,n=0){return t.set(this.x+e,this.y+n)}down(t=this,e=1){return t.set(this.x,this.y+e)}up(t=this,e=1){return t.set(this.x,this.y-e)}right(t=this,e=1){return t.set(this.x+e,this.y)}left(t=this,e=1){return t.set(this.x-e,this.y)}reset(t=null){return t?t.copy(this):this.set(0,0)}equals(t){return Math.abs(this.x-t.x)<Number.EPSILON&&Math.abs(this.y-t.y)<Number.EPSILON}toString(t=!1){return`BlockPos(${this.x},${this.y})`+(t?`:Chunk[${this.chunkId}]@{${this.blockCoordX},${this.blockCoordY}}[${this.index}],`:"")}}class ht extends class{constructor(t,e){this.chunkWidth=t,this.chunkHeight=e,this.chunks={}}clear(){this.chunks={}}getChunkById(t){if(t in this.chunks)return this.chunks[t];{const[e,n]=ot(t);let s=new at(this.chunkWidth,this.chunkHeight),i=new rt(this,t,e,n,s);return this.chunks[t]=i,i}}getChunkByCoord(t,e){const n=it(t,e);return this.getChunkById(n)}getChunksWithinBounds(t,e){let n=[];const s=t.chunkCoordX,i=t.chunkCoordY,o=e.chunkCoordX,r=e.chunkCoordY;for(let t=i;t<=r;++t)for(let e=s;e<=o;++e){const s=it(e,t);n.push(this.getChunkById(s))}return n}getLoadedChunks(){let t=[];for(let e of Object.keys(this.chunks)){let n=this.chunks[e];t.push(n)}return t}}{constructor(t=-1/0,e=-1/0,n=1/0,s=1/0,i=(Number.isFinite(n-t)?n-t:16),o=(Number.isFinite(s-e)?s-e:16)){super(i,o),this.bounds={left:t,right:n,top:e,bottom:s}}isWithinBounds(t){if(!t)return!1;const{x:e,y:n}=t;return e<=this.bounds.right&&e>=this.bounds.left&&n<=this.bounds.bottom&&n>=this.bounds.top}isWithinLoaded(t){return t.chunkId in this.chunks}getChunk(t){return this.getChunkById(t.chunkId)}getBlockId(t){return this.getChunkById(t.chunkId).data.block[t.index]}getBlockMeta(t){return this.getChunkById(t.chunkId).data.meta[t.index]}getBlockNeighbor(t){return this.getChunkById(t.chunkId).data.neighbor[t.index]}setBlockId(t,e){return this.getChunkById(t.chunkId).data.block[t.index]=e,this}setBlockMeta(t,e){return this.getChunkById(t.chunkId).data.meta[t.index]=e,this}setBlockNeighbor(t,e){return this.getChunkById(t.chunkId).data.neighbor[t.index]=e,this}at(t,e){return new lt(this.chunkWidth,this.chunkHeight).set(t,e)}}class ct{constructor(t,e,n){this.blockRegistry=t,this.blockId=e,this.blockOpts=n;for(let[s,i]of n)this[s]=t.getComponent(s,e)}toString(){return`Block#${this.blockId}`}}const ut=new class{constructor(){this.blocks={},this.components={}}register(t,...e){if(t in this.blocks)throw new Error(`BlockId '${t}' already registered.`);const n=e.map((t=>Array.isArray(t)?t:[t,!0]));for(let[e,s]of n){e in this.components||(this.components[e]={});let n,i=this.components[e];if(t in i)throw new Error(`Component '${e}' for block '${t}' already registered.`);n="object"==typeof s?Object.assign({},s):s,i[t]=n}let s=new ct(this,t,n);return this.blocks[t]=s,s}getBlock(t){return t in this.blocks?this.blocks[t]:null}getBlocks(){return Object.values(this.blocks)}getBlockIds(){return Object.keys(this.blocks)}getBlockComponents(t){let e=[];for(let n of this.components)t in n&&e.push(n[t]);return e}hasComponent(t,e){return t in this.components&&e in this.components[t]}getComponent(t,e){if(t in this.components){let n=this.components[t];if(e in n)return n[e]}return null}getComponents(t){if(t in this.components){let e=this.components[t];return Object.values(e)}}getComponentNames(){return Object.keys(this.components)}};ut.register(0,"air"),ut.register(1,"fluid",["color","dodgerblue"],["material","fluid"]);const dt=ut.register(3,"solid","grassSoil",["color","saddlebrown"],["material","dirt"]),pt=ut.register(4,"solid",["color","gold"],["material","metal"]),mt=ut.register(5,"solid",["color","limegreen"],["material","dirt"]);ut.register(6,"solid",["color","slategray"],["material","stone"]),ut.register(7,"solid",["color","salmon"],["material","stone"]),ut.register(8,"solid",["color","powderblue"],["material","metal"]),ut.register(9,"solid",["color","rebeccapurple"],["material","stone"]),ut.register(10,"solid",["color","teal"],["material","stone"]),ut.register(11,"solid",["color","mediumvioletred"],["material","stone"]),ut.register(12,"solid",["color","navajowhite"],["material","dirt"]);const gt="worldUpdate",ft="blockUpdate";function bt(t,e){t.emit("chunkUpdate",t,e)}function vt(t,e,n){t.emit(ft,t,e,n)}const yt="place";const kt="air",wt="fluid";function _t(t,e,n){ut.hasComponent(wt,n)&&t.map.setBlockMeta(e,3)}function Et(t){let e=t.map.getLoadedChunks().sort(((t,e)=>t.chunkCoordY<e.chunkCoordY?1:t.chunkCoordY>e.chunkCoordY?-1:t.chunkCoordX<e.chunkCoordX?1:t.chunkCoordX>e.chunkCoordX?-1:0));for(let n of e)xt(t,n)}function xt(t,e){const n=t.map,s=e.chunkCoordX*n.chunkWidth,i=e.chunkCoordY*n.chunkHeight;let o=n.at(0,0);for(let e=n.chunkHeight-1;e>=0;--e)for(let r=0;r<n.chunkWidth;++r){o.set(r+s,e+i);let a=n.getBlockId(o);ut.hasComponent(wt,a)&&Ct(t,o)}}function Ct(t,e){const n=t.map;!function(t,e){let n=e.copy().down();return Mt(t,e,n,3)}(n,e)&&function(t,e){let n=!1,s=t.getBlockMeta(e),i=e.copy();s<=1?(e.offset(i,1*Y.sign(),0),n|=Mt(t,e,i,1,!1)):(e.offset(i,1*Y.sign(),0),n|=Mt(t,e,i,1,!1),e.offset(i,1*Y.sign(),0),n|=Mt(t,e,i,1,!1))}(n,e)}function Mt(t,e,n,s,i=!0){if(!t.isWithinBounds(n))return!1;if(!t.isWithinLoaded(n))return t.setBlockId(e,0),t.setBlockMeta(e,0),!0;let o=t.getBlockId(e),r=t.getBlockMeta(e),a=t.getBlockId(n),l=t.getBlockMeta(n);if(s>r&&(s=r),ut.hasComponent(kt,a)){let i=r-s;return i<=0?(t.setBlockId(n,o).setBlockMeta(n,r).setBlockId(e,0).setBlockMeta(e,0),!0):(t.setBlockId(n,o).setBlockMeta(n,s).setBlockMeta(e,i),!0)}if(ut.hasComponent(wt,a)&&l<3){if(!i&&r<=l)return!1;if(l+s<=3)return t.setBlockMeta(n,l+s),s>=r?t.setBlockId(e,0).setBlockMeta(e,0):t.setBlockMeta(e,r-s),!0;{t.setBlockMeta(n,3);let i=s-(3-l);return t.setBlockMeta(e,i),!0}}}function St(t,e,n,s=0){const i=t.map.getBlockId(e),o=ut.hasComponent(wt,n);if(o){if(!ut.hasComponent(kt,i))return}else{!function(t,e,n){t.emit("break",t,e,n)}(t,e,i);ut.hasComponent(wt,i)||function(t,e,n){const s=t.map;let i=e.clone();s.isWithinBounds(e.right(i))&&s.getBlockId(i)===n&&s.setBlockNeighbor(i,11&s.getBlockNeighbor(i)),s.isWithinBounds(e.up(i))&&s.getBlockId(i)===n&&s.setBlockNeighbor(i,7&s.getBlockNeighbor(i)),s.isWithinBounds(e.left(i))&&s.getBlockId(i)===n&&s.setBlockNeighbor(i,14&s.getBlockNeighbor(i)),s.isWithinBounds(e.down(i))&&s.getBlockId(i)===n&&s.setBlockNeighbor(i,13&s.getBlockNeighbor(i)),s.setBlockNeighbor(e,0)}(t,e,i)}t.map.setBlockId(e,n),t.map.setBlockMeta(e,s),o||function(t,e,n){const s=t.map;let i=e.clone(),o=0;s.isWithinBounds(e.right(i))&&s.getBlockId(i)===n&&(o|=1,s.setBlockNeighbor(i,4|s.getBlockNeighbor(i))),s.isWithinBounds(e.up(i))&&s.getBlockId(i)===n&&(o|=2,s.setBlockNeighbor(i,8|s.getBlockNeighbor(i))),s.isWithinBounds(e.left(i))&&s.getBlockId(i)===n&&(o|=4,s.setBlockNeighbor(i,1|s.getBlockNeighbor(i))),s.isWithinBounds(e.down(i))&&s.getBlockId(i)===n&&(o|=8,s.setBlockNeighbor(i,2|s.getBlockNeighbor(i))),s.setBlockNeighbor(e,o)}(t,e,n),function(t,e,n){t.emit(yt,t,e,n)}(t,e,n)}function It(t,e,n){const s=t.map;let i=s.getBlockId(n);if(ut.hasComponent("grassSoil",i)){let e=s.getBlockId(n.up());ut.hasComponent(kt,e)&&Y.next()<.001&&St(t,n,5)}}const Lt=new AudioContext;!async function(t){document.addEventListener("click",(()=>{"suspended"===t.state&&t.resume()}))}(Lt);const Bt={gain:0,pitch:0,pan:0,loop:!1};class Ot{constructor(t,e,n=!1){this.context=t,this.buffer=e,this._source=null,this.playing=!1,this.loop=n,this.onAudioSourceEnded=this.onAudioSourceEnded.bind(this)}onAudioSourceEnded(){this._playing=!1}play(t=Bt){if(!this.buffer)return;this._source&&this.destroy();const e=this.context;let n=e.createBufferSource();n.addEventListener("ended",this.onAudioSourceEnded),n.buffer=this.buffer,n.loop=t.loop;let s=n;if(t.pitch&&(n.detune.value=100*t.pitch),t.gain){const n=e.createGain();n.gain.value=t.gain,s=s.connect(n)}if(t.pan){const n=e.createStereoPanner();n.pan.value=t.pan,s=s.connect(n)}s.connect(e.destination),n.start(),this._source=n,this._playing=!0}pause(){this._source.stop(),this._playing=!1}destroy(){this._source&&this._source.disconnect(),this._source=null}}const At=(new class{constructor(){this.assetPath="../../../res/",this.loaders={},this.assets={},this.loadingQueue=[]}registerLoader(t,e){return this.loaders[t]=e,this}registerAsset(t,e,n,s=null){t in this.assets||(this.assets[t]={});let i={value:null,url:n,opts:s};return this.assets[t][e]=i,this.loadingQueue.push(i),this}async loadAssets(){let t={},e=[];for(let n of Object.keys(this.assets)){let s=this.assets[n];if(!(n in this.loaders))throw new Error(`Missing loader for '${n}'.`);{let i=this.loaders[n];for(let n of Object.keys(s)){const{url:o,opts:r}=s[n];let a;const l=o+"?opts="+JSON.stringify(r);if(l in t)a=t[l];else try{a=await i.call(void 0,this.assetPath+o,r||{}),t[l]=a}catch(t){e.push(t);continue}s[n].value=a}}}if(e.length>0)throw new Error("Failed to load assets: "+e)}getAsset(t,e){return this.assets[t][e].value}}).registerLoader("audio",(async function(t,e={}){const n=Lt;let s=await fetch(t),i=await s.arrayBuffer(),o=await n.decodeAudioData(i);return new Ot(n,o,Boolean(e.loop))})),Tt="material";function Pt(t){switch(function(t){return ut.hasComponent(Tt,t)?ut.getComponent(Tt,t):"stone"}(t)){case"dirt":At.getAsset("audio","dirt").play({pitch:Y.range(-5,5)});break;case"fluid":At.getAsset("audio","fluid").play({pitch:Y.range(-5,5)});break;case"metal":At.getAsset("audio","metal").play({gain:4,pitch:Y.range(-5,5)});break;case"stone":default:At.getAsset("audio","stone").play({gain:1.5,pitch:Y.range(-5,5)})}}function Nt(t){let e=t.map.getLoadedChunks().sort(((t,e)=>t.chunkCoordY<e.chunkCoordY?1:t.chunkCoordY>e.chunkCoordY?-1:t.chunkCoordX<e.chunkCoordX?1:t.chunkCoordX>e.chunkCoordX?-1:0));for(let n of e)jt(t,n)}function jt(t,e){const n=t.map,s=e.chunkCoordX*n.chunkWidth,i=e.chunkCoordY*n.chunkHeight;let o=n.at(0,0);for(let e=n.chunkHeight-1;e>=0;--e)for(let r=0;r<n.chunkWidth;++r){o.set(r+s,e+i);let a=n.getBlockId(o);ut.hasComponent("falling",a)&&Xt(t,o)}}function Xt(t,e){!function(t,e){let n=e.copy().down();(function(t,e,n){if(!t.isWithinBounds(n))return!1;if(!t.isWithinLoaded(n))return t.setBlockId(e,0),!0;let s=t.getBlockId(e),i=t.getBlockId(n);if(ut.hasComponent("air",i))t.setBlockId(n,s).setBlockId(e,0)})(t,e,n)}(t.map,e)}const Yt=[[{w:1,h:4,m:[1,1,1,1]},{w:4,h:1,m:[1,1,1,1]}],[{w:2,h:2,m:[1,1,1,1]}],[{w:3,h:2,m:[0,1,0,1,1,1]},{w:2,h:3,m:[1,0,1,1,1,0]},{w:3,h:2,m:[1,1,1,0,1,0]},{w:2,h:3,m:[0,1,1,1,0,1]}],[{w:2,h:3,m:[0,1,0,1,1,1]},{w:3,h:2,m:[1,0,0,1,1,1]},{w:2,h:3,m:[1,1,1,0,1,0]},{w:3,h:2,m:[1,1,1,0,0,1]}],[{w:2,h:3,m:[1,0,1,0,1,1]},{w:3,h:2,m:[0,0,1,1,1,1]},{w:2,h:3,m:[1,1,0,1,0,1]},{w:3,h:2,m:[1,1,1,1,0,0]}],[{w:3,h:2,m:[0,1,1,1,1,0]},{w:2,h:3,m:[1,0,1,1,0,1]}],[{w:3,h:2,m:[1,1,0,0,1,1]},{w:2,h:3,m:[0,1,1,1,1,0]}]];let Wt=1/0,Rt=1/0,Ht=1,Ft=1;for(let t of Yt)for(let e of t)Wt=Math.min(e.w,Wt),Rt=Math.min(e.h,Rt),Ht=Math.max(e.w,Ht),Ft=Math.max(e.h,Ft);const Dt=Ht,$t=Ft,Ut=[1,3,4,6,7,8,9,10,11,12];function Kt(t,e,n,s,i,o,r,a,l){const h=i.map;if(e.placing){const t=e.shape,n=Math.min(h.bounds.right-t.w,Math.max(h.bounds.left,o-Math.floor((t.w-1)/2))),s=Math.min(h.bounds.bottom-t.h,Math.max(h.bounds.top,r-Math.floor((t.h-1)/2)));if(e.floating){const i=Math.sign(n-e.placeX),o=Math.sign(s-e.placeY);qt(t,e.placeX+i,e.placeY+o,h)||(e.floating=!1),e.placeX+=i,e.placeY+=o,e.valid=!1}else{const i=e.placeX;i<n?qt(t,i+1,e.placeY,h)||(e.placeX+=1):i>n&&(qt(t,i-1,e.placeY,h)||(e.placeX-=1));const o=e.placeY;o<s?qt(t,e.placeX,o+1,h)||(e.placeY+=1):o>s&&(qt(t,e.placeX,o-1,h)||(e.placeY-=1)),e.valid=function(t,e,n,s,i){if(ut.hasComponent(wt,t))return!0;let o=i.at(n,s);const{w:r,h:a,m:l}=e;for(let t=0;t<a;++t)for(let e=0;e<r;++e){if(o.set(e+n,t+s),l[e+t*r]){if(!i.isWithinLoaded(o))continue;if(15!==i.getBlockNeighbor(o))return!0}}return!1}(e.value,t,e.placeX,e.placeY,h)}}e.placeTicks<=0?e.placing?(n.value&&e.valid&&(!function(t,e,n,s,i){const{w:o,h:r,m:a}=e;let l=i.map.at(0,0);for(let e=0;e<r;++e)for(let r=0;r<o;++r){a[r+e*o]&&(l.set(r+n,e+s),St(i,l,t))}}(e.value,e.shape,e.placeX,e.placeY,i),e.placing=!1,e.placeTicks=30,a(e)),s.value&&(e.placing=!1)):(!function(t){const e=Y.choose(Yt),n=Math.floor(Y.range(0,e.length)),s=t.value;let i=!1;switch(s){case 0:i=!0;break;case 1:i=Y.next()<1/4;break;case 3:i=Y.next()<1/8;break;case 4:i=Y.next()<1/4;break;case 6:i=Y.next()<1/8;break;default:i=Y.next()<1/6}const o=i?Y.choose(Ut):s;t.value=o,t.shapeType=e,t.shape=e[n],t.shapeMap.clear(),function(t,e,n,s,i){const{w:o,h:r,m:a}=e;let l=i.at(0,0);for(let e=0;e<r;++e)for(let r=0;r<o;++r){a[r+e*o]&&(l.set(r+n,e+s),i.setBlockId(l,t))}}(o,t.shape,0,0,t.shapeMap)}(e),e.placing=!0,e.floating=!0,e.valid=!1,l(e)):e.placeTicks-=t}function qt(t,e,n,s){const{w:i,h:o,m:r}=t;let a=s.at(0,0);for(let t=0;t<o;++t)for(let o=0;o<i;++o){if(r[o+t*i]){if(a.set(o+e,t+n),!s.isWithinLoaded(a))continue;let i=s.getBlockId(a);if(ut.hasComponent(wt,i)){if(s.getBlockMeta(a)>=3)return!0}else if(!ut.hasComponent(kt,i))return!0}}return!1}function zt(t,e){const n=t.map.chunkWidth,s=t.map.chunkHeight;if(n!==e.chunkWidth||s!==e.chunkHeight)return null;t.score=e.score||0,t.cameraX=e.cameraX||0,t.cameraY=e.cameraY||0;const i=n*s;for(let o of Object.keys(e.chunks)){const r=e.chunks[o],[a,l]=ot(o);let h=new at(n,s);for(let t=0;t<i;++t)h.block[t]=r.block[t],h.meta[t]=r.meta[t],h.neighbor[t]=r.neighbor[t];let c=new rt(this,o,a,l,h);t.map.chunks[o]=c}return t}function Vt(t,e){const n=t.map.chunkWidth,s=t.map.chunkHeight;e.score=t.score,e.cameraX=t.cameraX,e.cameraY=t.cameraY,e.chunkWidth=n,e.chunkHeight=s;let i={};const o=n*s;for(let e of t.map.getLoadedChunks()){const t=e.chunkId;let n={block:new Array(o),meta:new Array(o),neighbor:new Array(o)};for(let t=0;t<o;++t)n.block[t]=e.data.block[t],n.meta[t]=e.data.meta[t],n.neighbor[t]=e.data.neighbor[t];i[t]=n}return e.chunks=i,e}class Jt{constructor(){this.prevTransformMatrix=null,this.domProjectionMatrix=new DOMMatrix,this.domViewMatrix=new DOMMatrix,this.ctx=null}begin(t,e,n){if(this.ctx)throw new Error("View already begun - maybe missing end() call?");e&&Zt(this.domViewMatrix,e),n&&Zt(this.domProjectionMatrix,n),this.prevTransformMatrix=t.getTransform(),t.setTransform(this.domProjectionMatrix);const{a:s,b:i,c:o,d:r,e:a,f:l}=this.domViewMatrix;t.transform(s,i,o,r,a,l),this.ctx=t}end(t){t.setTransform(this.prevTransformMatrix),this.ctx=null}}function Zt(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}const Gt=.1;function Qt(t,e,n,s){let i=e.map.getBlockId(n);ut.hasComponent("air",i)||(ut.hasComponent("fluid",i)?function(t,e,n,s,i){const o=e.map,r=o.getBlockMeta(n),a=r<=0?1:r/3,l=ut.getComponent("color",i);t.fillStyle=l,t.fillRect(0,(1-a)*s,s,s*a);let h=Date.now()/2e3,c=n.x/o.chunkWidth,u=n.y/o.chunkHeight,d=n.blockCoordX%2==0,p=n.blockCoordY%2==0,m=Math.sin(h+c-u+(d?.3:0)+(p?.1:0));t.fillStyle=`rgba(0, 0, 100, ${(m+1)/2*.4})`,t.fillRect(0,(1-a)*s,s,s*a)}(t,e,n,s,i):ut.hasComponent("solid",i)&&function(t,e,n,s,i){const o=e.map,r=ut.getComponent("color",i);if(t.fillStyle=r,t.fillRect(0,0,s,s),i===pt.blockId){let e=Date.now()/500,i=n.x/o.chunkWidth,r=n.y/o.chunkHeight,a=Math.sin(e+4*i+4*r);t.fillStyle=`rgba(255, 255, 255, ${Math.max(0,a-.6)})`,t.fillRect(0,0,s,s)}else if(i===dt.blockId){let e=n.blockCoordX%2==0,i=n.blockCoordY%2==0;t.fillStyle=`rgba(0, 0, 0, ${e&&i?.1:0})`,t.fillRect(0,0,s,s);const r=o.getBlockNeighbor(n),a=Math.ceil(s/4);if(!((2&r)>>1>0)){let e=o.getBlockId(n.up());ut.hasComponent(kt,e)&&(t.fillStyle="limegreen",t.fillRect(0,0,s,a)),n.down()}}else if(i===mt.blockId){let e=n.blockCoordX%2==0;t.fillStyle=`rgba(0, 0, 0, ${e?.1:0})`,t.fillRect(0,0,s,s)}}(t,e,n,s,i))}function te(t,e,n){const s=e.chunkWidth*n,i=e.chunkHeight*n;for(let o of e.getLoadedChunks()){const r=o.chunkCoordX*s,a=o.chunkCoordY*i;t.translate(r,a),ee(t,e,o,n),t.translate(-r,-a)}}function ee(t,e,n,s){const i=e.chunkWidth,o=e.chunkHeight,r=n.chunkCoordX*i,a=n.chunkCoordY*o;let l=e.at(r,a);for(let n=0;n<o;++n)for(let o=0;o<i;++o)l.set(o+r,n+a),t.translate(o*s,n*s),Qt(t,{map:e},l,s),t.translate(-o*s,-n*s)}async function ne(t){await async function(){}();const e=t.display,n=e.canvas.getContext("2d");n.imageSmoothingEnabled=!1;const s=new Jt;let i=t.world,o=t.camera,r=t.placement;return function(){let t=o.getViewMatrix(),a=o.getProjectionMatrix();n.clearRect(0,0,e.width,e.height),s.begin(n,t,a),te(n,i.map,4),r.placing&&(n.translate(4*r.placeX,4*r.placeY),function(t,e,n){te(t,e.shapeMap,n)}(n,r,4),n.translate(4*-r.placeX,4*-r.placeY)),s.end(n),i.time<300&&(n.fillStyle=`rgba(0, 0, 0, ${1-i.time/300})`,n.fillRect(0,0,e.width,e.height)),n.fillStyle="white",n.fillText(i.score,4,12)}}function se(t,e){t.score=0,t.time=0,t.firstPlace=!0;let n=t.map.at(0,0),s=n.clone();St(t,n,pt.blockId),St(t,n.offset(s,-1,0),pt.blockId),St(t,n.offset(s,0,-1),pt.blockId),St(t,n.offset(s,-1,-1),pt.blockId),t.cameraX=-e.width/2,t.cameraY=-e.height/2}document.addEventListener("DOMContentLoaded",(async function(){const t=document.querySelector("#display"),e=document.querySelector("#input");e.src={PointerX:"Mouse:PosX",PointerY:"Mouse:PosY",Place:"Mouse:Button0",Change:{key:"Mouse:Button2",event:"down"},Reset:"Keyboard:KeyR",Save:"Keyboard:KeyS",Load:"Keyboard:KeyL"},await async function(t){t.registerAsset("audio","flick","arroyo/flick.wav"),t.registerAsset("audio","melt","arroyo/melt.mp3"),t.registerAsset("audio","reset","arroyo/flick.wav"),t.registerAsset("audio","background","arroyo/melt.mp3"),await async function(t){t.registerAsset("audio","dirt","arroyo/dirt.wav"),t.registerAsset("audio","stone","arroyo/stone.wav"),t.registerAsset("audio","fluid","arroyo/waterpop.wav"),t.registerAsset("audio","metal","arroyo/ding.wav")}(t),await t.loadAssets()}(At);const n={map:new ht,score:0,cameraX:0,cameraY:0,time:0,firstPlace:!0};V.assign(n),function(t){t.on(yt,_t),t.on(gt,Et)}(n),function(t){t.on(ft,It)}(n),function(t){t.on(gt,Nt)}(n);let s=localStorage.getItem("worldData");s&&zt(n,JSON.parse(s))||se(n,t);let i={placing:!1,floating:!0,shape:null,shapeType:null,shapeMap:new ht(0,0,Dt,$t),value:0,placeX:0,placeY:0,placeTicks:0};const o=new st;o.moveTo(n.cameraX,n.cameraY);const r={display:t,input:e,world:n,camera:o,placement:i,blockTicks:0,autoSaveTicks:0},a=await ne(r);t.addEventListener("frame",(t=>{const e=t.detail.deltaTime/1e3*60;(function(t){const e=t.world,n=t.display,s=t.input;if(s.getInputState("Reset"))return localStorage.removeItem("worldData"),e.map.clear(),se(e,n),!0;if(s.getInputState("Save")){let t=Vt(e,{});return F.downloadText("worldData.json",JSON.stringify(t)),!0}if(s.getInputState("Load"))return D.uploadFile([".json"],!1).then((t=>t.text())).then((t=>{let s=JSON.parse(t);e.map.clear(),s&&zt(e,s)||se(e,n)})),!0;return!1})(r)||(n.time+=e,function(t,e,n){const s=t.display,i=t.input,o=t.world,r=i.getInput("PointerX"),a=i.getInput("PointerY");let l=s.width/s.height,h=l<=1?l:1,c=l<=1?1:1/l,u=r.value-.5,d=a.value-.5;const p=4;let m=Math.atan2(d,u),g=function(t,e,n,s){let i=n-t,o=s-e;return Math.sqrt(i*i+o*o)}(0,0,u,d),f=g<.3?0:g-.3,b=Math.cos(m)*f*4*o.map.chunkWidth*h*p,v=Math.sin(m)*f*4*o.map.chunkWidth*c*p;n.moveTo(J(n.x,o.cameraX+b,e*Gt),J(n.y,o.cameraY+v,e*Gt))}(r,e,o),function(t,e){let n=t.world;const s=t.display,i=t.input,o=t.camera,r=t.placement;let a=o.getViewMatrix(),l=o.getProjectionMatrix();const[h,c]=st.screenToWorld(i.getInputState("PointerX")*s.width,i.getInputState("PointerY")*s.height,a,l),u=Math.floor(h/4),d=Math.floor(c/4);function p(t){const[e,i]=st.screenToWorld(s.width/2,s.height/2,a,l),o=Math.floor(e/4),r=Math.floor(i/4);let h=Math.ceil((t.placeX-o)/4),c=Math.ceil((t.placeY-r)/4);n.cameraX+=4*h,n.cameraY+=4*c,n.score+=1,Pt(t.value),n.firstPlace&&(n.firstPlace=!1,At.getAsset("audio","background").play())}function m(t){let[e,n]=function(t,e,n,s,i,o,r){let a=0,l=0;switch((t<=.5?0:2)+(e<=.5?0:1)){case 0:{let t=st.screenToWorld(0,0,o,r);a=t[0],l=t[1]}break;case 1:{let t=st.screenToWorld(0,i,o,r);a=t[0],l=t[1]}break;case 2:{let t=st.screenToWorld(s,0,o,r);a=t[0],l=t[1]}break;case 3:{let t=st.screenToWorld(s,i,o,r);a=t[0],l=t[1]}}return[Math.floor(a/n),Math.floor(l/n)]}(i.getInputState("PointerX"),i.getInputState("PointerY"),4,s.width,s.height,a,l);t.placeX=e,t.placeY=n,At.getAsset("audio","reset").play({pitch:Y.range(-5,5)})}Kt(e,r,i.getInput("Place"),i.getInput("Rotate"),n,u,d,p,m)}(r,e),function(t,e){let n=t.blockTicks||0;const s=t.world;if(function(t){t.emit("update",t)}(s),n<=0){n=10;{!function(t){t.emit(gt,t)}(s);const t=s.map.getLoadedChunks(),e=s.map.chunkWidth,n=s.map.chunkHeight;let i=s.map.at(0,0);for(let o of t){const t=o.chunkCoordX*e,r=o.chunkCoordY*n;bt(s,o);for(let a=0;a<n;++a)for(let n=0;n<e;++n)i.set(n+t,a+r),vt(s,o,i)}}}else n-=e;t.blockTicks=n}(r,e),function(t,e){let n=t.autoSaveTicks||0,s=t.world;if(n<=0){n=100;let t=Vt(s,{});localStorage.setItem("worldData",JSON.stringify(t))}else n-=e;t.autoSaveTicks=n}(r,e),a())}))}))}();
