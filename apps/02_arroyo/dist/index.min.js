!function(){"use strict";const t="noscale",e="stretch",n=Symbol("template"),i=Symbol("style");class o extends HTMLElement{static get[n](){let t=document.createElement("template");return t.innerHTML='\n<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <canvas></canvas>\n    <slot></slot>\n</div>',Object.defineProperty(this,n,{value:t}),t}static get[i](){let t=document.createElement("style");return t.innerHTML='\n:host {\n    display: inline-block;\n    color: #555555;\n}\n.container {\n    display: flex;\n    position: relative;\n    width: 100%;\n    height: 100%;\n}\ncanvas {\n    background: #000000;\n    margin: auto;\n    image-rendering: pixelated;\n}\nlabel {\n    font-family: monospace;\n    color: currentColor;\n    position: absolute;\n}\n#title {\n    left: 0.5rem;\n    top: 0.5rem;\n}\n#fps {\n    right: 0.5rem;\n    top: 0.5rem;\n}\n#dimension {\n    left: 0.5rem;\n    bottom: 0.5rem;\n}\n.hidden {\n    display: none;\n}\n:host([debug]) .container {\n    outline: 6px dashed rgba(0, 0, 0, 0.1);\n    outline-offset: -4px;\n    background-color: rgba(0, 0, 0, 0.1);\n}\n:host([mode="noscale"]) canvas {\n    margin: 0;\n    top: 0;\n    left: 0;\n}\n:host([mode="fit"]), :host([mode="center"]), :host([mode="stretch"]) {\n    width: 100%;\n    height: 100%;\n}\n:host([full]) {\n    width: 100vw!important;\n    height: 100vh!important;\n}\n:host([disabled]) {\n    display: none;\n}\nslot {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    top: 0;\n    left: 0;\n\n    pointer-events: none;\n}\n::slotted(*) {\n    pointer-events: auto;\n}',Object.defineProperty(this,i,{value:t}),t}static get observedAttributes(){return["width","height","disabled","onframe","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[n].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[i].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this._onframe=null,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){this.hasAttribute("mode")||(this.mode="noscale"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=n;break;case"height":this._height=n;break;case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"onframe":this.onframe=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}}update(e){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const n=e-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=e,this.debug){const e=n<=0?"--":String(Math.round(1e3/n)).padStart(2,"0");if(this._fpsElement.innerText!==e&&(this._fpsElement.innerText=e),this.mode===t){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:e,prevTime:this._prevAnimationFrameTime,deltaTime:n,canvas:this._canvasElement,get context(){let t=this.canvas.getContext("2d");return t.imageSmoothingEnabled=!1,t}},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}updateCanvasSize(){let n=this.shadowRoot.host.getBoundingClientRect();const i=n.width,o=n.height;let s=this._canvasElement,r=this._width,a=this._height;const h=this.mode;if(h===e)r=i,a=o;else if(h!==t){if(i<r||o<a||"fit"===h){let t=i/r,e=o/a;t<e?(r=i,a*=t):(r*=e,a=o)}}r=Math.floor(r),a=Math.floor(a),s.clientWidth===r&&s.clientHeight===a||(s.width=this._width,s.height=this._height,s.style=`width: ${r}px; height: ${a}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:r,height:a},bubbles:!1,composed:!0})))}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}get width(){return this._width}set width(t){this.setAttribute("width",t)}get height(){return this._height}set height(t){this.setAttribute("height",t)}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get debug(){return this.hasAttribute("debug")}set debug(t){t?this.setAttribute("debug",""):this.removeAttribute("debug")}}window.customElements.define("display-port",o);class s{static addInputEventListener(t,e){}static removeInputEventListener(t,e){}constructor(t){this.eventTarget=t}}class r{constructor(){this.down=0,this.up=0,this.value=0,this.next={up:0,down:0}}update(t,e){"down"===t?this.next.down=e:this.next.up=e}poll(){this.value?this.up&&!this.next.up&&(this.value=0):this.next.down&&(this.value=1),this.down=this.next.down,this.up=this.next.up,this.next.down=0,this.next.up=0}toString(){return this.value}}class a{constructor(){this.value=0}update(t,e){this.value=e}poll(){}toString(){return this.value}}class h extends a{constructor(){super(),this.next=0}update(t,e){this.next+=e}poll(){this.value=this.next,this.next=0}}const l=Symbol("keyboardEventContext");class c extends s{static addInputEventListener(t,e){let n;if(l in e)n=e[l];else{n={handler:e,target:t,down:null,up:null,_keyEvent:{type:"key",target:t,device:"keyboard",key:null,event:null,value:null,control:!1,shift:!1,alt:!1}};let i=u.bind(n),o=d.bind(n);n.down=i,n.up=o,e[l]=n}return t.addEventListener("keyup",n.up),t.addEventListener("keydown",n.down),t}static removeInputEventListener(t,e){if(l in e){let n=e[l];t.removeEventListener("keyup",n.up),t.removeEventListener("keydown",n.down)}return t}constructor(t,e){if(super(t),this._buttons=[],this._managed=Array.isArray(e),this.onManagedKeyEvent=this.onManagedKeyEvent.bind(this),this.onUnmanagedKeyEvent=this.onUnmanagedKeyEvent.bind(this),this._managed){for(let t of e){let e=new r;this[t]=e,this._buttons.push(e)}c.addInputEventListener(t,this.onManagedKeyEvent)}else c.addInputEventListener(t,this.onUnmanagedKeyEvent)}get Up(){return Math.min((this.ArrowUp||0)+(this.KeyW||0),1)}get Down(){return Math.min((this.ArrowDown||0)+(this.KeyS||0),1)}get Left(){return Math.min((this.ArrowLeft||0)+(this.KeyA||0),1)}get Right(){return Math.min((this.ArrowRight||0)+(this.KeyD||0),1)}destroy(){this._managed?c.removeInputEventListener(this.eventTarget,this.onManagedKeyEvent):c.removeInputEventListener(this.eventTarget,this.onUnmanagedKeyEvent),this.eventTarget=null}poll(){for(let t of this._buttons)t.poll();return this}onUnmanagedKeyEvent(t){if(!(t.key in this)){let e=new r;this[t.key]=e,this._buttons.push(e)}return this[t.key].update(t.event,t.value),!0}onManagedKeyEvent(t){if(t.key in this)return this[t.key].update(t.event,t.value),!0}}function u(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._keyEvent;return e.key=t.code,e.event="down",e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.handler.call(void 0,e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}function d(t){let e=this._keyEvent;if(e.key=t.code,e.event="up",e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.handler.call(void 0,e))return t.preventDefault(),t.stopPropagation(),!1}const p=Symbol("mouseEventContext");class m extends s{static addInputEventListener(t,e){let n;if(p in e)n=e[p];else{n={handler:e,target:t,down:null,up:null,move:null,contextmenu:null,_down:!1,_keyEvent:{type:"key",target:t,device:"mouse",key:null,event:null,value:null},_posEvent:{type:"pos",target:t,device:"mouse",key:"pos",event:"move",x:0,y:0,dx:0,dy:0}};let i=f.bind(n),o=g.bind(n),s=k.bind(n),r=b.bind(n);n.down=i,n.up=o,n.move=s,n.contextmenu=r,e[p]=n}return t.addEventListener("mousedown",n.down),document.addEventListener("mouseup",n.up),t.addEventListener("contextmenu",n.contextmenu),document.addEventListener("mousemove",n.move),t}static removeInputEventListener(t,e){if(p in e){let n=e[p];t.removeEventListener("mousedown",n.down),document.removeEventListener("mouseup",n.up),t.removeEventListener("contextmenu",n.contextmenu),document.removeEventListener("mousemove",n.move)}return t}constructor(t){super(t),this.x=new a,this.y=new a,this.dx=new h,this.dy=new h,this.Button0=new r,this.Button1=new r,this.Button2=new r,this.Button3=new r,this.Button4=new r,this.onMouseEvent=this.onMouseEvent.bind(this),m.addInputEventListener(t,this.onMouseEvent)}get Left(){return this.Button0}get Middle(){return this.Button1}get Right(){return this.Button2}destroy(){m.removeInputEventListener(this.eventTarget,this.onMouseEvent),this.eventTarget=null}poll(){return this.x.poll(),this.y.poll(),this.dx.poll(),this.dy.poll(),this.Button0.poll(),this.Button1.poll(),this.Button2.poll(),this.Button3.poll(),this.Button4.poll(),this}onMouseEvent(t){let{key:e,event:n}=t;switch(e){case 0:this.Button0.update(n,t.value);break;case 1:this.Button1.update(n,t.value);break;case 2:this.Button2.update(n,t.value);break;case 3:this.Button3.update(n,t.value);break;case 4:this.Button4.update(n,t.value);break;case"pos":return this.x.update(n,t.x),this.y.update(n,t.y),this.dx.update(n,t.dx),void this.dy.update(n,t.dy)}return!0}}function f(t){this._down=!0;let e=this._keyEvent;if(e.key=t.button,e.event="down",e.value=1,this.handler.call(void 0,e)&&document.activeElement===this.target)return t.preventDefault(),t.stopPropagation(),!1}function g(t){if(this._down){this._down=!1;let e=this._keyEvent;if(e.key=t.button,e.event="up",e.value=1,this.handler.call(void 0,e))return t.preventDefault(),t.stopPropagation(),!1}}function k(t){let e=this.target,{clientWidth:n,clientHeight:i}=e,o=this.target.getBoundingClientRect(),s=t.movementX/n,r=t.movementY/i,a=(t.clientX-o.left)/n,h=(t.clientY-o.top)/i,l=this._posEvent;if(l.x=a,l.y=h,l.dx=s,l.dy=r,void 0!==this.handler.call(void 0,l))throw new Error("Return value must be 'undefined'. Mouse position and movement events cannot be consumed.")}function b(t){return t.preventDefault(),t.stopPropagation(),!1}const v=Symbol("template"),y=Symbol("style");class w extends HTMLElement{static toInputMap(t){let e={};for(let n of t)if(n instanceof w){let t,i=n.input;switch(i in e?t=e[i]:e[i]=t=[],n.type){case"action":t.push({key:n.key,event:n.event});break;case"range":t.push({key:n.key,scale:n.scale});break;default:throw new Error("Unknown input type.")}}return e}static get[v](){let t=document.createElement("template");return t.innerHTML="\n<kbd></kbd>",Object.defineProperty(this,v,{value:t}),t}static get[y](){let t=document.createElement("style");return t.innerHTML="\n:host {\n    display: inline-block;\n}\nkbd {\n    background-color: #EEEEEE;\n    border-radius: 3px;\n    border: 1px solid #B4B4B4;\n    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;\n    color: #333333;\n    font-size: 0.85em;\n    font-weight: 700;\n    line-height: 1;\n    padding: 2px 4px;\n    white-space: nowrap;\n}\n",Object.defineProperty(this,y,{value:t}),t}static get observedAttributes(){return["input","key","scale","event"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[v].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[y].cloneNode(!0)),this.keyElement=this.shadowRoot.querySelector("kbd")}attributeChangedCallback(t,e,n){switch(t){case"key":this.keyElement.textContent=n}}get type(){return this.hasAttribute("event")?"action":"range"}get input(){return this.getAttribute("input")}set input(t){this.setAttribute("input",t)}get key(){return this.getAttribute("key")}set key(t){this.setAttribute("key",t)}get scale(){return Number(this.getAttribute("scale"))}set scale(t){this.setAttribute("scale",t)}get event(){return this.getAttribute("event")}set event(t){this.setAttribute("event",t)}}window.customElements.define("input-key",w);class _{constructor(t,e){this.inputName=t,this.inputType=e,this.value=0,this._onchange=null,this._eventListeners=new Map}update(t){if(this.value!==t){if(this.value=t,this._eventListeners.has("change"))for(let t of this._eventListeners.get("change"))t.call(void 0,this);return!0}return!1}get onchange(){return this._onchange}set onchange(t){this._onchange&&this.removeEventListener("change",this._onchange),this._onchange=t,this.addEventListener("change",t)}addEventListener(t,e){if(this._eventListeners.has(t)){this._eventListeners.get(t).push(e)}else this._eventListeners.set(t,[e])}removeEventListener(t,e){if(this._eventListeners.has(t)){let n=this._eventListeners.get(t);n.splice(n.indexOf(e),1)}}toString(){return this.value}}class x{constructor(t,e,n){this.keyName=t,this.keyEvent=e,this.scale=n,this.value=0}consumeKey(){this.value=0}updateKey(t,e){if(e===this.keyName)if(this.keyEvent){if(this.keyEvent===t.event)return this.value=t.value*this.scale,!0}else switch(t.event){case"down":return this.value=this.scale,!0;case"up":return this.value=0,!0;default:return void(this.value=t.value*this.scale)}}}const E=Symbol("template"),C=Symbol("style");class M extends HTMLElement{static get[E](){let t=document.createElement("template");return t.innerHTML='\n<table>\n    <thead>\n        <tr class="header">\n            <th id="title" colspan=3>input-context</th>\n            <th id="poll">&nbsp;</th>\n        </tr>\n        <tr class="hint">\n            <th>input</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n<slot></slot>',Object.defineProperty(this,E,{value:t}),t}static get[C](){let t=document.createElement("style");return t.innerHTML='\n:host {\n    display: inline-block;\n}\nslot {\n    display: none;\n}\ntable {\n    border-collapse: collapse;\n}\ntable, th, td {\n    border: 1px solid gray;\n}\n#poll {\n    position: relative;\n    font-size: 0.9em;\n}\n#poll:after {\n    content: "(poll)";\n    position: absolute;\n    left: 0;\n    right: 0;\n    z-index: -1;\n    opacity: 0.1;\n    font-family: monospace;\n    letter-spacing: 3px;\n    overflow: hidden;\n}\n.hint > th {\n    font-size: 0.5em;\n    font-family: monospace;\n    padding: 0 10px;\n    letter-spacing: 3px;\n    background-color: #AAA;\n    color: #666666;\n}\nth, td {\n    padding: 5px 10px;\n}\ntd {\n    text-align: center;\n}\nkbd {\n    display: inline-block;\n    background-color: #EEEEEE;\n    border-radius: 3px;\n    border: 1px solid #B4B4B4;\n    box-shadow: 0 1px 1px rgba(0, 0, 0, .2), 0 2px 0 0 rgba(255, 255, 255, .7) inset;\n    color: #333333;\n    font-size: 0.85em;\n    font-weight: 700;\n    line-height: 1;\n    padding: 2px 4px;\n    white-space: nowrap;\n}\noutput {\n    font-family: monospace;\n    border-radius: 0.3em;\n    padding: 3px;\n}\n.flash {\n    animation: fadein 4s;\n}\n@keyframes fadein {\n    0%, 10% { background-color: rgba(0, 0, 255, 0.3); }\n    100% { background-color: rgba(0, 0, 255, 0); }\n}\n',Object.defineProperty(this,C,{value:t}),t}static get observedAttributes(){return["for","strict","onattach","ondetach","id","class"]}constructor(t=null){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[E].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[C].cloneNode(!0)),this._onattach=null,this._ondetach=null,this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._tableBody=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot"),this._tableInputs={},this._lastPollTime=0,this._pollWarningTimeoutHandle=0,this._animationFrameHandle=0,this._inputTarget=null,this._inputMap=t,this._inputs={},this._inputKeys={},this._keys={},this.onInputEvent=this.onInputEvent.bind(this),this.onAnimationFrame=this.onAnimationFrame.bind(this),t&&B(this,t)}connectedCallback(){if(this.hasAttribute("for")||this.setAttribute("for",""),!this._inputMap){this._inputMap={};const t=w.toInputMap(this._children.assignedNodes()),e=this.src;e?fetch(e).then(t=>t.json()).then(e=>{this._inputMap={...e,...t},B(this,this._inputMap)}):(this._inputMap={...t},B(this,this._inputMap))}this._lastPollTime=0,this._pollWarningTimeoutHandle=setTimeout(()=>{this._lastPollTime<=0?(this._pollElement.textContent="✗",console.warn("[INPUT] No input updated. Did you forget to poll() the input context?")):this._pollElement.textContent="✓"},3e3),this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame)}disconnectedCallback(){cancelAnimationFrame(this._animationFrameHandle),clearTimeout(this._pollWarningTimeoutHandle)}attributeChangedCallback(t,e,n){switch(t){case"for":let t;t=n?document.getElementById(n):document.querySelector("display-port")||document.querySelector("canvas"),this._inputTarget&&this.detach(),t&&this.attach(t);break;case"onattach":this.onattach=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"ondetach":this.ondetach=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"id":case"class":this._titleElement.innerHTML=`input-context${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}}get src(){return this.getAttribute("src")}set src(t){this.setAttribute("src",t)}get for(){return this.getAttribute("for")}set for(t){this.setAttribute("for",t)}get strict(){return this.hasAttribute("strict")}set strict(t){t?this.setAttribute("strict",""):this.removeAttribute("strict")}get auto(){return this.hasAttribute("auto")}set auto(t){t?this.setAttribute("auto",""):this.removeAttribute("auto")}get onattach(){return this._onattach}set onattach(t){this._onattach&&this.removeEventListener("attach",this._onattach),this._onattach=t,this._onattach&&this.addEventListener("attach",t)}get ondetach(){return this._ondetach}set ondetach(t){this._ondetach&&this.removeEventListener("detach",this._ondetach),this._ondetach=t,this._ondetach&&this.addEventListener("detach",t)}attach(t){if(!t)throw new Error("Cannot attach input context to null.");if(this._inputTarget){if(this._inputTarget!==t)throw new Error("Input context already attached to another element.");return this}let e=t;return e&&(e.canvas?(c.addInputEventListener(e,this.onInputEvent),m.addInputEventListener(e.canvas,this.onInputEvent)):(c.addInputEventListener(e,this.onInputEvent),m.addInputEventListener(e,this.onInputEvent)),this.dispatchEvent(new CustomEvent("attach",{composed:!0,bubbles:!1,detail:{eventTarget:e,inputCallback:this.onInputEvent}}))),this._inputTarget=e,this}detach(){if(!this._inputTarget)return this;let t=this._inputTarget;return this._inputTarget=null,t.canvas?(c.removeInputEventListener(t,this.onInputEvent),m.removeInputEventListener(t.canvas,this.onInputEvent)):(c.removeInputEventListener(t,this.onInputEvent),m.removeInputEventListener(t,this.onInputEvent)),this.dispatchEvent(new CustomEvent("detach",{composed:!0,bubbles:!1,detail:{eventTarget:t,inputCallback:this.onInputEvent}})),this}poll(){this._lastPollTime=performance.now();for(let t in this._inputs){let e=this._inputs[t];switch(e.inputType){case"action":let n=!1;for(let i of this._inputKeys[t]){let t=i.value;if(t){e.update(t,i),i.consumeKey(),n=!0;break}}n||e.update(0,null);break;case"range":let i=0;for(let e of this._inputKeys[t])i+=e.value;e.update(i,null);break;default:throw new Error("Unknown input type.")}}}onInputEvent(t){let e=t.type;switch(e){case"key":{const e=t.device+":"+t.key;if(e in this._keys){let n=!1;for(let i of this._keys[e])i.updateKey(t,e)&&(n=!0);if(n)return!0}}break;case"pos":{const e=["x","y","dx","dy"];for(let n of e){t.value=t[n];const e=t.device+":"+t.key+"."+n;if(e in this._keys){let n=!1;for(let i of this._keys[e])i.updateKey(t,e)&&(n=!0);if(n)return!0}}}break;default:throw new Error(`Unknown input event type '${e}'.`)}}onAnimationFrame(t){this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.auto&&this.poll();for(let t in this._inputs){let e,n=this._inputs[t];e=n.value?Number(n.value).toFixed(2):0;let i=this._tableInputs[t];if(i.textContent!=e){i.textContent=e;let t=i.parentNode;i.parentNode.removeChild(i),t.appendChild(i)}}}getInput(t){if(t in this._inputs)return this._inputs[t];if(this.strict)throw new Error(`Cannot find input with name '${t}'.`);{let e=new _(t,"range");return this._inputs[t]=e,e}}getInputValue(t){if(t in this._inputs)return this._inputs[t].value;if(this.strict)throw new Error(`Cannot find input with name '${t}'.`);return 0}}function B(t,e){for(let n in e){let i=e[n];if(Array.isArray(i))for(let e of i)L(t,n,e),"string"==typeof e&&(e={key:e,event:"down"}),A(t,n,e);else L(t,n,i),"string"==typeof i&&(i={key:i,event:"down"}),A(t,n,i)}}function I(t){if("object"==typeof t){if("type"in t)return t.type;if("scale"in t)return"range";if("event"in t)return"action";throw new Error(`Missing 'scale' or 'event' for input option '${inputName}'.`)}if("string"==typeof t)return"action";throw new Error("Invalid type for input mapping option.")}function A(t,e,n){let i=document.createElement("tr");{let t=document.createElement("td");t.textContent=e,t.classList.add("name"),i.appendChild(t)}{let t=document.createElement("td");t.classList.add("key");let e=document.createElement("kbd");e.textContent=n.key,t.appendChild(e),i.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp");switch(I(n)){case"action":e.textContent=n.event;break;case"range":e.textContent=Number(n.scale).toFixed(2);break;default:e.textContent="<?>"}t.classList.add("mod"),t.appendChild(e),i.appendChild(t)}if(e in t._tableInputs){let t=document.createElement("td");t.classList.add("value"),i.appendChild(t)}else{let n=document.createElement("td"),o=document.createElement("output");o.textContent=0,o.classList.add("flash"),n.classList.add("value"),n.appendChild(o),i.appendChild(n),t._tableInputs[e]=o}t._tableBody.appendChild(i)}function L(t,e,n){let i=I(n);switch(i){case"action":T(t,e,"string"==typeof n?{key:n,event:"down"}:n);break;case"range":!function(t,e,n){const{key:i,scale:o}=n;let s,r,a;if(e in t._inputs){if(s=t._inputs[e],r=t._inputKeys[e],"range"!==s.inputType)throw new Error(`Cannot register mismatched 'range' type input for '${s.inputType}' type input '${e}'.`)}else s=new _(e,"range"),r=[],t._inputs[e]=s,t._inputKeys[e]=r;i in t._keys?a=t._keys[i]:(a=[],t._keys[i]=a);let h=new x(i,null,o);a.push(h),r.push(h)}(t,e,n);break;default:throw new Error(`Unknown input type '${i}'.`)}}function T(t,e,n){const{key:i,event:o}=n;let s,r,a;if(e in t._inputs){if(s=t._inputs[e],r=t._inputKeys[e],"action"!==s.inputType)throw new Error(`Cannot register mismatched 'action' type input for '${s.inputType}' type input '${e}'.`)}else s=new _(e,"action"),r=[],t._inputs[e]=s,t._inputKeys[e]=r;i in t._keys?a=t._keys[i]:(a=[],t._keys[i]=a);let h=new x(i,o,1);a.push(h),r.push(h)}window.customElements.define("input-context",M);class S{next(){return Math.random()}}let N;class X{constructor(t=new S){this.generator=t}static next(){return N.next()}next(){return this.generator.next()}static choose(t){return N.choose(t)}choose(t){return t[Math.floor(this.generator.next()*t.length)]}static range(t,e){return N.range(t,e)}range(t,e){return(e-t)*this.generator.next()+t}static sign(){return N.sign()}sign(){return this.generator.next()<.5?-1:1}}N=new X;const Y=new AudioContext;!async function(t){document.addEventListener("click",()=>{"suspended"===t.state&&t.resume()})}(Y);const W={gain:0,pitch:0,pan:0,loop:!1};class R{constructor(t,e,n=!1){this.context=t,this.buffer=e,this._source=null,this.playing=!1,this.loop=n,this.onAudioSourceEnded=this.onAudioSourceEnded.bind(this)}onAudioSourceEnded(){this._playing=!1}play(t=W){if(!this.buffer)return;this._source&&this.destroy();const e=this.context;let n=e.createBufferSource();n.addEventListener("ended",this.onAudioSourceEnded),n.buffer=this.buffer,n.loop=t.loop;let i=n;if(t.pitch&&(n.detune.value=100*t.pitch),t.gain){const n=e.createGain();n.gain.value=t.gain,i=i.connect(n)}if(t.pan){const n=e.createStereoPanner();n.pan.value=t.pan,i=i.connect(n)}i.connect(e.destination),n.start(),this._source=n,this._playing=!0}pause(){this._source.stop(),this._playing=!1}destroy(){this._source&&this._source.disconnect(),this._source=null}}var $=Object.freeze({__proto__:null,AUDIO_CONTEXT:Y,AUDIO_ASSET_TAG:"audio",loadAudio:async function(t,e={}){const n=Y;let i=await fetch(t),o=await i.arrayBuffer(),s=await n.decodeAudioData(o);return new R(n,s,Boolean(e.loop))}});function H(t,e){const n=document.createElement("a"),i=e.indexOf(";");e=e.substring(0,i+1)+"headers=Content-Disposition%3A%20attachment%3B%20filename="+t+";"+e.substring(i+1),n.setAttribute("href",e),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}const F=["svg","g"];var O=Object.freeze({__proto__:null,FILE_TYPE_PNG:"png",FILE_TYPE_SVG:"svg",downloadText:function(t,e){H(t,"data:text/plain; charset=utf-8,"+encodeURIComponent(e))},downloadImageFromSVG:function(t,e,n,i,o){const s=function(t){const e=function t(e,n=e.cloneNode(!0)){let i=e.childNodes,o=n.childNodes;for(var s=0;s<o.length;s++){let e=o[s],n=e.tagName;if(-1!=F.indexOf(n))t(i[s],e);else if(i[s]instanceof Element){const t=window.getComputedStyle(i[s]);let n=[];for(let e of Object.keys(t))n.push(`${e}:${t.getPropertyValue(e)};`);e.setAttribute("style",n.join(""))}}return n}(t),n=(new XMLSerializer).serializeToString(e);return new Blob([n],{type:"image/svg+xml"})}(n);switch(e){case"png":{const n=URL.createObjectURL(s),r=document.createElement("canvas"),a=r.getContext("2d"),h=window.devicePixelRatio||1;r.width=i*h,r.height=o*h,r.style.width=i+"px",r.style.height=o+"px",a.setTransform(h,0,0,h,0,0);const l=new Image;l.onload=()=>{a.drawImage(l,0,0),URL.revokeObjectURL(n);const i=r.toDataURL("image/"+e).replace("image/"+e,"image/octet-stream");H(t,i)},l.src=n}break;case"svg":{const e=new FileReader;e.onload=()=>{H(t,e.result)},e.readAsDataURL(s)}break;default:throw new Error("Unknown file type '"+e+"'")}},downloadURL:H});var j=Object.freeze({__proto__:null,uploadFile:async function(t=[],e=!1){return new Promise((n,i)=>{const o=document.createElement("input");o.addEventListener("change",t=>{n(e?t.target.files:t.target.files[0])}),o.type="file",o.accept=t.join(","),o.style.display="none",o.toggleAttribute("multiple",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)})}});const P={on(t,e,n=e){let i;if(this.__events.has(t)?i=this.__events.get(t):(i=new Map,this.__events.set(t,i)),i.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return i.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,(...i)=>{this.off(t,n),e.apply(this.__context||this,i)},n)},emit(t,...e){if(this.__events.has(t)){let n=[];const i=Array.from(this.__events.get(t).values());for(const t of i){let i=t.apply(this.__context||this,e);i&&n.push(i)}return n}return this.__events.set(t,new Map),[]}};function K(t){const e=Object.create(P);return e.__events=new Map,e.__context=t,e}function U(t,e){const n=Object.assign(t,P);return n.__events=new Map,n.__context=e,n}function q(t,e){const n=t.prototype;return Object.assign(n,P),n.__events=new Map,n.__context=e,n}var D={create:K,assign:U,mixin:q},z=Object.freeze({__proto__:null,create:K,assign:U,mixin:q,default:D});function V(t,e,n){return t+(e-t)*n}var G="undefined"!=typeof Float32Array?Float32Array:Array;function J(){var t=new G(16);return G!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Q(){var t=new G(3);return G!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Z(t,e,n){var i=new G(3);return i[0]=t,i[1]=e,i[2]=n,i}function tt(t,e,n){var i=e[0],o=e[1],s=e[2],r=n[0],a=n[1],h=n[2];return t[0]=o*h-s*a,t[1]=s*r-i*h,t[2]=i*a-o*r,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var et,nt=function(t){var e=t[0],n=t[1],i=t[2];return Math.hypot(e,n,i)};et=Q();!function(){var t,e=(t=new G(4),G!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function it(){var t=new G(4);return G!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function ot(t,e,n,i){var o,s,r,a,h,l=e[0],c=e[1],u=e[2],d=e[3],p=n[0],m=n[1],f=n[2],g=n[3];return(s=l*p+c*m+u*f+d*g)<0&&(s=-s,p=-p,m=-m,f=-f,g=-g),1-s>1e-6?(o=Math.acos(s),r=Math.sin(o),a=Math.sin((1-i)*o)/r,h=Math.sin(i*o)/r):(a=1-i,h=i),t[0]=a*l+h*p,t[1]=a*c+h*m,t[2]=a*u+h*f,t[3]=a*d+h*g,t}var st,rt,at,ht,lt,ct,ut,dt=function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],r=n*n+i*i+o*o+s*s;return r>0&&(r=1/Math.sqrt(r)),t[0]=n*r,t[1]=i*r,t[2]=o*r,t[3]=s*r,t};st=Q(),rt=Z(1,0,0),at=Z(0,1,0),ht=it(),lt=it(),ct=new G(9),G!=Float32Array&&(ct[1]=0,ct[2]=0,ct[3]=0,ct[5]=0,ct[6]=0,ct[7]=0),ct[0]=1,ct[4]=1,ct[8]=1,ut=ct;class pt{constructor(){this.prevTransformMatrix=null,this.domProjectionMatrix=new DOMMatrix,this.domViewMatrix=new DOMMatrix,this.ctx=null}begin(t,e,n){if(this.ctx)throw new Error("View already begun - maybe missing end() call?");e&&mt(this.domViewMatrix,e),n&&mt(this.domProjectionMatrix,n),this.prevTransformMatrix=t.getTransform(),t.setTransform(this.domProjectionMatrix);const{a:i,b:o,c:s,d:r,e:a,f:h}=this.domViewMatrix;t.transform(i,o,s,r,a,h),this.ctx=t}end(t){t.setTransform(this.prevTransformMatrix),this.ctx=null}}function mt(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}class ft{static screenToWorld(t,e,n,i){let o=function(t,e,n){var i=e[0],o=e[1],s=e[2],r=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],p=e[10],m=e[11],f=e[12],g=e[13],k=e[14],b=e[15],v=n[0],y=n[1],w=n[2],_=n[3];return t[0]=v*i+y*a+w*u+_*f,t[1]=v*o+y*h+w*d+_*g,t[2]=v*s+y*l+w*p+_*k,t[3]=v*r+y*c+w*m+_*b,v=n[4],y=n[5],w=n[6],_=n[7],t[4]=v*i+y*a+w*u+_*f,t[5]=v*o+y*h+w*d+_*g,t[6]=v*s+y*l+w*p+_*k,t[7]=v*r+y*c+w*m+_*b,v=n[8],y=n[9],w=n[10],_=n[11],t[8]=v*i+y*a+w*u+_*f,t[9]=v*o+y*h+w*d+_*g,t[10]=v*s+y*l+w*p+_*k,t[11]=v*r+y*c+w*m+_*b,v=n[12],y=n[13],w=n[14],_=n[15],t[12]=v*i+y*a+w*u+_*f,t[13]=v*o+y*h+w*d+_*g,t[14]=v*s+y*l+w*p+_*k,t[15]=v*r+y*c+w*m+_*b,t}(J(),i,n);!function(t,e){var n=e[0],i=e[1],o=e[2],s=e[3],r=e[4],a=e[5],h=e[6],l=e[7],c=e[8],u=e[9],d=e[10],p=e[11],m=e[12],f=e[13],g=e[14],k=e[15],b=n*a-i*r,v=n*h-o*r,y=n*l-s*r,w=i*h-o*a,_=i*l-s*a,x=o*l-s*h,E=c*f-u*m,C=c*g-d*m,M=c*k-p*m,B=u*g-d*f,I=u*k-p*f,A=d*k-p*g,L=b*A-v*I+y*B+w*M-_*C+x*E;L&&(L=1/L,t[0]=(a*A-h*I+l*B)*L,t[1]=(o*I-i*A-s*B)*L,t[2]=(f*x-g*_+k*w)*L,t[3]=(d*_-u*x-p*w)*L,t[4]=(h*M-r*A-l*C)*L,t[5]=(n*A-o*M+s*C)*L,t[6]=(g*y-m*x-k*v)*L,t[7]=(c*x-d*y+p*v)*L,t[8]=(r*I-a*M+l*E)*L,t[9]=(i*M-n*I-s*E)*L,t[10]=(m*_-f*y+k*b)*L,t[11]=(u*y-c*_-p*b)*L,t[12]=(a*C-r*B-h*E)*L,t[13]=(n*B-i*C+o*E)*L,t[14]=(f*v-m*w-g*b)*L,t[15]=(c*w-u*v+d*b)*L)}(o,o);let s=Z(t,e,0);return function(t,e,n){var i=e[0],o=e[1],s=e[2],r=n[3]*i+n[7]*o+n[11]*s+n[15];r=r||1,t[0]=(n[0]*i+n[4]*o+n[8]*s+n[12])/r,t[1]=(n[1]*i+n[5]*o+n[9]*s+n[13])/r,t[2]=(n[2]*i+n[6]*o+n[10]*s+n[14])/r}(s,s,o),s}constructor(t=-1,e=1,n=-1,i=1,o=0,s=1){this.position=Q(),this.rotation=it(),this.scale=Z(1,1,1),this.clippingPlane={left:t,right:e,top:n,bottom:i,near:o,far:s},this._viewMatrix=J(),this._projectionMatrix=J()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,e,n=0,i=1){let o=Z(t,e,n);!function(t,e,n,i){var o=e[0],s=e[1],r=e[2];t[0]=o+i*(n[0]-o),t[1]=s+i*(n[1]-s),t[2]=r+i*(n[2]-r)}(this.position,this.position,o,Math.min(1,i))}getViewMatrix(t=this._viewMatrix){let e=-Math.round(this.x),n=-Math.round(this.y),i=0===this.z?1:1/this.z,o=Z(e,n,0),s=Z(this.scale[0]*i,this.scale[1]*i,1);return function(t,e,n,i){var o=e[0],s=e[1],r=e[2],a=e[3],h=o+o,l=s+s,c=r+r,u=o*h,d=o*l,p=o*c,m=s*l,f=s*c,g=r*c,k=a*h,b=a*l,v=a*c,y=i[0],w=i[1],_=i[2];t[0]=(1-(m+g))*y,t[1]=(d+v)*y,t[2]=(p-b)*y,t[3]=0,t[4]=(d-v)*w,t[5]=(1-(u+g))*w,t[6]=(f+k)*w,t[7]=0,t[8]=(p+b)*_,t[9]=(f-k)*_,t[10]=(1-(u+m))*_,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1}(t,this.rotation,o,s),t}getProjectionMatrix(t=this._projectionMatrix){let{left:e,right:n,top:i,bottom:o,near:s,far:r}=this.clippingPlane;return function(t,e,n,i,o,s,r){var a=1/(e-n),h=1/(i-o),l=1/(s-r);t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+n)*a,t[13]=(o+i)*h,t[14]=(r+s)*l,t[15]=1}(t,e,n,i,o,s,r),t}}function gt(t,e){return t+","+e}function kt(t){let e=t.indexOf(",");return[Number(t.substring(0,e)),Number(t.substring(e+1))]}class bt{constructor(t,e,n,i,o){this.chunkManager=t,this.chunkId=e,this.chunkCoordX=n,this.chunkCoordY=i,this._data=o}get data(){return this._data}}class vt{constructor(t,e){const n=t*e;this.block=new Uint8Array(n).fill(0),this.meta=new Uint8Array(n).fill(0),this.neighbor=new Uint8Array(n).fill(15)}}class yt{constructor(t,e){this._chunkWidth=t,this._chunkHeight=e,this._x=0,this._y=0,this._blockCoordX=0,this._blockCoordY=0,this._index=0,this._chunkCoordX=0,this._chunkCoordY=0,this._chunkId=null}get x(){return this._x}get y(){return this._y}get blockCoordX(){return this._blockCoordX}get blockCoordY(){return this._blockCoordY}get index(){return this._index}get chunkCoordX(){return this._chunkCoordX}get chunkCoordY(){return this._chunkCoordY}get chunkId(){return this._chunkId}clone(){return new yt(this._chunkWidth,this._chunkHeight)}set(t,e){this._x=t,this._y=e;const n=this._chunkWidth,i=this._chunkHeight;return this._blockCoordX=t<0?Math.abs(n+Math.floor(t))%n:Math.floor(t)%n,this._blockCoordY=e<0?Math.abs(i+Math.floor(e))%i:Math.floor(e)%i,this._index=this._blockCoordX+this._blockCoordY*n,this._chunkCoordX=Math.floor(t/n),this._chunkCoordY=Math.floor(e/i),this._chunkId=gt(this._chunkCoordX,this._chunkCoordY),this}copy(t=this.clone()){return t._x=this.x,t._y=this.y,t._blockCoordX=this.blockCoordX,t._blockCoordY=this.blockCoordY,t._index=this.index,t._chunkCoordX=this.chunkCoordX,t._chunkCoordY=this.chunkCoordY,t._chunkId=this.chunkId,t}offset(t=this,e=0,n=0){return t.set(this.x+e,this.y+n)}down(t=this,e=1){return t.set(this.x,this.y+e)}up(t=this,e=1){return t.set(this.x,this.y-e)}right(t=this,e=1){return t.set(this.x+e,this.y)}left(t=this,e=1){return t.set(this.x-e,this.y)}reset(t=null){return t?t.copy(this):this.set(0,0)}equals(t){return Math.abs(this.x-t.x)<Number.EPSILON&&Math.abs(this.y-t.y)<Number.EPSILON}toString(t=!1){return`BlockPos(${this.x},${this.y})`+(t?`:Chunk[${this.chunkId}]@{${this.blockCoordX},${this.blockCoordY}}[${this.index}],`:"")}}class wt extends class{constructor(t,e){this.chunkWidth=t,this.chunkHeight=e,this.chunks={}}clear(){this.chunks={}}getChunkById(t){if(t in this.chunks)return this.chunks[t];{const[e,n]=kt(t);let i=new vt(this.chunkWidth,this.chunkHeight),o=new bt(this,t,e,n,i);return this.chunks[t]=o,o}}getChunkByCoord(t,e){const n=gt(t,e);return this.getChunkById(n)}getChunksWithinBounds(t,e){let n=[];const i=t.chunkCoordX,o=t.chunkCoordY,s=e.chunkCoordX,r=e.chunkCoordY;for(let t=o;t<=r;++t)for(let e=i;e<=s;++e){const i=gt(e,t);n.push(this.getChunkById(i))}return n}getLoadedChunks(){let t=[];for(let e of Object.keys(this.chunks)){let n=this.chunks[e];t.push(n)}return t}}{constructor(t=-1/0,e=-1/0,n=1/0,i=1/0,o=(Number.isFinite(n-t)?n-t:16),s=(Number.isFinite(i-e)?i-e:16)){super(o,s),this.bounds={left:t,right:n,top:e,bottom:i}}isWithinBounds(t){if(!t)return!1;const{x:e,y:n}=t;return e<=this.bounds.right&&e>=this.bounds.left&&n<=this.bounds.bottom&&n>=this.bounds.top}isWithinLoaded(t){return t.chunkId in this.chunks}getChunk(t){return this.getChunkById(t.chunkId)}getBlockId(t){return this.getChunkById(t.chunkId).data.block[t.index]}getBlockMeta(t){return this.getChunkById(t.chunkId).data.meta[t.index]}getBlockNeighbor(t){return this.getChunkById(t.chunkId).data.neighbor[t.index]}setBlockId(t,e){return this.getChunkById(t.chunkId).data.block[t.index]=e,this}setBlockMeta(t,e){return this.getChunkById(t.chunkId).data.meta[t.index]=e,this}setBlockNeighbor(t,e){return this.getChunkById(t.chunkId).data.neighbor[t.index]=e,this}at(t,e){return new yt(this.chunkWidth,this.chunkHeight).set(t,e)}}class _t{constructor(t,e,n){this.blockRegistry=t,this.blockId=e,this.blockOpts=n;for(let[i,o]of n)this[i]=t.getComponent(i,e)}toString(){return"Block#"+this.blockId}}const xt=new class{constructor(){this.blocks={},this.components={}}register(t,...e){if(t in this.blocks)throw new Error(`BlockId '${t}' already registered.`);const n=e.map(t=>Array.isArray(t)?t:[t,!0]);for(let[e,i]of n){e in this.components||(this.components[e]={});let n,o=this.components[e];if(t in o)throw new Error(`Component '${e}' for block '${t}' already registered.`);n="object"==typeof i?Object.assign({},i):i,o[t]=n}let i=new _t(this,t,n);return this.blocks[t]=i,i}getBlock(t){return t in this.blocks?this.blocks[t]:null}getBlocks(){return Object.values(this.blocks)}getBlockIds(){return Object.keys(this.blocks)}getBlockComponents(t){let e=[];for(let n of this.components)t in n&&e.push(n[t]);return e}hasComponent(t,e){return t in this.components&&e in this.components[t]}getComponent(t,e){if(t in this.components){let n=this.components[t];if(e in n)return n[e]}return null}getComponents(t){if(t in this.components){let e=this.components[t];return Object.values(e)}}getComponentNames(){return Object.keys(this.components)}},Et=(xt.register(0,"air"),xt.register(1,"fluid",["color","dodgerblue"],["material","fluid"]),xt.register(3,"solid","grassSoil",["color","saddlebrown"],["material","dirt"])),Ct=xt.register(4,"solid",["color","gold"],["material","metal"]),Mt=xt.register(5,"solid",["color","limegreen"],["material","dirt"]),Bt=(xt.register(6,"solid",["color","slategray"],["material","stone"]),xt.register(7,"solid",["color","salmon"],["material","stone"]),xt.register(8,"solid",["color","powderblue"],["material","metal"]),xt.register(9,"solid",["color","rebeccapurple"],["material","stone"]),xt.register(10,"solid",["color","teal"],["material","stone"]),xt.register(11,"solid",["color","mediumvioletred"],["material","stone"]),xt.register(12,"solid",["color","navajowhite"],["material","dirt"]),"place");const It="worldUpdate",At="blockUpdate";function Lt(t,e){t.emit("chunkUpdate",t,e)}function Tt(t,e,n){t.emit(At,t,e,n)}const St="air",Nt="fluid";function Xt(t,e,n){xt.hasComponent(Nt,n)&&t.map.setBlockMeta(e,3)}function Yt(t){let e=t.map.getLoadedChunks().sort((t,e)=>t.chunkCoordY<e.chunkCoordY?1:t.chunkCoordY>e.chunkCoordY?-1:t.chunkCoordX<e.chunkCoordX?1:t.chunkCoordX>e.chunkCoordX?-1:0);for(let n of e)Wt(t,n)}function Wt(t,e){const n=t.map,i=e.chunkCoordX*n.chunkWidth,o=e.chunkCoordY*n.chunkHeight;let s=n.at(0,0);for(let e=n.chunkHeight-1;e>=0;--e)for(let r=0;r<n.chunkWidth;++r){s.set(r+i,e+o);let a=n.getBlockId(s);xt.hasComponent(Nt,a)&&Rt(t,s)}}function Rt(t,e){const n=t.map;!function(t,e){let n=e.copy().down();return $t(t,e,n,3)}(n,e)&&function(t,e){let n=!1,i=t.getBlockMeta(e),o=e.copy();i<=1?(e.offset(o,1*X.sign(),0),n|=$t(t,e,o,1,!1)):(e.offset(o,1*X.sign(),0),n|=$t(t,e,o,1,!1),e.offset(o,1*X.sign(),0),n|=$t(t,e,o,1,!1))}(n,e)}function $t(t,e,n,i,o=!0){if(!t.isWithinBounds(n))return!1;if(!t.isWithinLoaded(n))return t.setBlockId(e,0),t.setBlockMeta(e,0),!0;let s=t.getBlockId(e),r=t.getBlockMeta(e),a=t.getBlockId(n),h=t.getBlockMeta(n);if(i>r&&(i=r),xt.hasComponent(St,a)){let o=r-i;return o<=0?(t.setBlockId(n,s).setBlockMeta(n,r).setBlockId(e,0).setBlockMeta(e,0),!0):(t.setBlockId(n,s).setBlockMeta(n,i).setBlockMeta(e,o),!0)}if(xt.hasComponent(Nt,a)&&h<3){if(!o&&r<=h)return!1;if(h+i<=3)return t.setBlockMeta(n,h+i),i>=r?t.setBlockId(e,0).setBlockMeta(e,0):t.setBlockMeta(e,r-i),!0;{t.setBlockMeta(n,3);let o=i-(3-h);return t.setBlockMeta(e,o),!0}}}function Ht(t,e,n,i){let o=e.map.getBlockId(n);xt.hasComponent("air",o)||(xt.hasComponent("fluid",o)?function(t,e,n,i,o){const s=e.map,r=s.getBlockMeta(n),a=r<=0?1:r/3,h=xt.getComponent("color",o);t.fillStyle=h,t.fillRect(0,(1-a)*i,i,i*a);let l=Date.now()/2e3,c=n.x/s.chunkWidth,u=n.y/s.chunkHeight,d=n.blockCoordX%2==0,p=n.blockCoordY%2==0,m=Math.sin(l+c-u+(d?.3:0)+(p?.1:0));t.fillStyle=`rgba(0, 0, 100, ${(m+1)/2*.4})`,t.fillRect(0,(1-a)*i,i,i*a)}(t,e,n,i,o):xt.hasComponent("solid",o)&&function(t,e,n,i,o){const s=e.map,r=xt.getComponent("color",o);if(t.fillStyle=r,t.fillRect(0,0,i,i),o===Ct.blockId){let e=Date.now()/500,o=n.x/s.chunkWidth,r=n.y/s.chunkHeight,a=Math.sin(e+4*o+4*r);t.fillStyle=`rgba(255, 255, 255, ${Math.max(0,a-.6)})`,t.fillRect(0,0,i,i)}else if(o===Et.blockId){let e=n.blockCoordX%2==0,o=n.blockCoordY%2==0;t.fillStyle=`rgba(0, 0, 0, ${e&&o?.1:0})`,t.fillRect(0,0,i,i);const r=s.getBlockNeighbor(n),a=Math.ceil(i/4);if(!((2&r)>>1>0)){let e=s.getBlockId(n.up());xt.hasComponent(St,e)&&(t.fillStyle="limegreen",t.fillRect(0,0,i,a)),n.down()}}else if(o===Mt.blockId){let e=n.blockCoordX%2==0;t.fillStyle=`rgba(0, 0, 0, ${e?.1:0})`,t.fillRect(0,0,i,i)}}(t,e,n,i,o))}function Ft(t,e,n){const i=e.chunkWidth*n,o=e.chunkHeight*n;for(let s of e.getLoadedChunks()){const r=s.chunkCoordX*i,a=s.chunkCoordY*o;t.translate(r,a),Ot(t,e,s,n),t.translate(-r,-a)}}function Ot(t,e,n,i){const o=e.chunkWidth,s=e.chunkHeight,r=n.chunkCoordX*o,a=n.chunkCoordY*s;let h=e.at(r,a);for(let n=0;n<s;++n)for(let s=0;s<o;++s)h.set(s+r,n+a),t.translate(s*i,n*i),Ht(t,{map:e},h,i),t.translate(-s*i,-n*i)}function jt(t,e,n,i=0){const o=t.map.getBlockId(e),s=xt.hasComponent(Nt,n);if(s){if(!xt.hasComponent(St,o))return}else{!function(t,e,n){t.emit("break",t,e,n)}(t,e,o);xt.hasComponent(Nt,o)||function(t,e,n){const i=t.map;let o=e.clone();i.isWithinBounds(e.right(o))&&i.getBlockId(o)===n&&i.setBlockNeighbor(o,11&i.getBlockNeighbor(o)),i.isWithinBounds(e.up(o))&&i.getBlockId(o)===n&&i.setBlockNeighbor(o,7&i.getBlockNeighbor(o)),i.isWithinBounds(e.left(o))&&i.getBlockId(o)===n&&i.setBlockNeighbor(o,14&i.getBlockNeighbor(o)),i.isWithinBounds(e.down(o))&&i.getBlockId(o)===n&&i.setBlockNeighbor(o,13&i.getBlockNeighbor(o)),i.setBlockNeighbor(e,0)}(t,e,o)}t.map.setBlockId(e,n),t.map.setBlockMeta(e,i),s||function(t,e,n){const i=t.map;let o=e.clone(),s=0;i.isWithinBounds(e.right(o))&&i.getBlockId(o)===n&&(s|=1,i.setBlockNeighbor(o,4|i.getBlockNeighbor(o))),i.isWithinBounds(e.up(o))&&i.getBlockId(o)===n&&(s|=2,i.setBlockNeighbor(o,8|i.getBlockNeighbor(o))),i.isWithinBounds(e.left(o))&&i.getBlockId(o)===n&&(s|=4,i.setBlockNeighbor(o,1|i.getBlockNeighbor(o))),i.isWithinBounds(e.down(o))&&i.getBlockId(o)===n&&(s|=8,i.setBlockNeighbor(o,2|i.getBlockNeighbor(o))),i.setBlockNeighbor(e,s)}(t,e,n),function(t,e,n){t.emit(Bt,t,e,n)}(t,e,n)}function Pt(t,e,n){const i=t.map;let o=i.getBlockId(n);if(xt.hasComponent("grassSoil",o)){let e=i.getBlockId(n.up());xt.hasComponent(St,e)&&X.next()<.001&&jt(t,n,5)}}const Kt="material",Ut={};function qt(t){switch(function(t){return xt.hasComponent(Kt,t)?xt.getComponent(Kt,t):"stone"}(t)){case"dirt":Ut.dirt.play({pitch:X.range(-5,5)});break;case"fluid":Ut.fluid.play({pitch:X.range(-5,5)});break;case"metal":Ut.metal.play({gain:4,pitch:X.range(-5,5)});break;case"stone":default:Ut.stone.play({gain:1.5,pitch:X.range(-5,5)})}}function Dt(t){let e=t.map.getLoadedChunks().sort((t,e)=>t.chunkCoordY<e.chunkCoordY?1:t.chunkCoordY>e.chunkCoordY?-1:t.chunkCoordX<e.chunkCoordX?1:t.chunkCoordX>e.chunkCoordX?-1:0);for(let n of e)zt(t,n)}function zt(t,e){const n=t.map,i=e.chunkCoordX*n.chunkWidth,o=e.chunkCoordY*n.chunkHeight;let s=n.at(0,0);for(let e=n.chunkHeight-1;e>=0;--e)for(let r=0;r<n.chunkWidth;++r){s.set(r+i,e+o);let a=n.getBlockId(s);xt.hasComponent("falling",a)&&Vt(t,s)}}function Vt(t,e){!function(t,e){let n=e.copy().down();(function(t,e,n){if(!t.isWithinBounds(n))return!1;if(!t.isWithinLoaded(n))return t.setBlockId(e,0),!0;let i=t.getBlockId(e),o=t.getBlockId(n);if(xt.hasComponent("air",o))t.setBlockId(n,i).setBlockId(e,0)})(t,e,n)}(t.map,e)}const Gt=[[{w:1,h:4,m:[1,1,1,1]},{w:4,h:1,m:[1,1,1,1]}],[{w:2,h:2,m:[1,1,1,1]}],[{w:3,h:2,m:[0,1,0,1,1,1]},{w:2,h:3,m:[1,0,1,1,1,0]},{w:3,h:2,m:[1,1,1,0,1,0]},{w:2,h:3,m:[0,1,1,1,0,1]}],[{w:2,h:3,m:[0,1,0,1,1,1]},{w:3,h:2,m:[1,0,0,1,1,1]},{w:2,h:3,m:[1,1,1,0,1,0]},{w:3,h:2,m:[1,1,1,0,0,1]}],[{w:2,h:3,m:[1,0,1,0,1,1]},{w:3,h:2,m:[0,0,1,1,1,1]},{w:2,h:3,m:[1,1,0,1,0,1]},{w:3,h:2,m:[1,1,1,1,0,0]}],[{w:3,h:2,m:[0,1,1,1,1,0]},{w:2,h:3,m:[1,0,1,1,0,1]}],[{w:3,h:2,m:[1,1,0,0,1,1]},{w:2,h:3,m:[0,1,1,1,1,0]}]];let Jt=1/0,Qt=1/0,Zt=1,te=1;for(let t of Gt)for(let e of t)Jt=Math.min(e.w,Jt),Qt=Math.min(e.h,Qt),Zt=Math.max(e.w,Zt),te=Math.max(e.h,te);const ee=Zt,ne=te,ie=[1,3,4,6,7,8,9,10,11,12];function oe(t,e,n,i,o,s,r,a,h){const l=o.map;if(e.placing){const t=e.shape,n=Math.min(l.bounds.right-t.w,Math.max(l.bounds.left,s-Math.floor((t.w-1)/2))),i=Math.min(l.bounds.bottom-t.h,Math.max(l.bounds.top,r-Math.floor((t.h-1)/2)));if(e.floating){const o=Math.sign(n-e.placeX),s=Math.sign(i-e.placeY);se(t,e.placeX+o,e.placeY+s,l)||(e.floating=!1),e.placeX+=o,e.placeY+=s,e.valid=!1}else{const o=e.placeX;o<n?se(t,o+1,e.placeY,l)||(e.placeX+=1):o>n&&(se(t,o-1,e.placeY,l)||(e.placeX-=1));const s=e.placeY;s<i?se(t,e.placeX,s+1,l)||(e.placeY+=1):s>i&&(se(t,e.placeX,s-1,l)||(e.placeY-=1)),e.valid=function(t,e,n,i,o){if(xt.hasComponent(Nt,t))return!0;let s=o.at(n,i);const{w:r,h:a,m:h}=e;for(let t=0;t<a;++t)for(let e=0;e<r;++e){if(s.set(e+n,t+i),h[e+t*r]){if(!o.isWithinLoaded(s))continue;if(15!==o.getBlockNeighbor(s))return!0}}return!1}(e.value,t,e.placeX,e.placeY,l)}}e.placeTicks<=0?e.placing?(n.value&&e.valid&&(!function(t,e,n,i,o){const{w:s,h:r,m:a}=e;let h=o.map.at(0,0);for(let e=0;e<r;++e)for(let r=0;r<s;++r){a[r+e*s]&&(h.set(r+n,e+i),jt(o,h,t))}}(e.value,e.shape,e.placeX,e.placeY,o),e.placing=!1,e.placeTicks=30,a(e)),i.value&&(e.placing=!1)):(!function(t){const e=X.choose(Gt),n=Math.floor(X.range(0,e.length)),i=t.value;let o=!1;switch(i){case 0:o=!0;break;case 1:o=X.next()<1/4;break;case 3:o=X.next()<1/8;break;case 4:o=X.next()<1/4;break;case 6:o=X.next()<1/8;break;default:o=X.next()<1/6}const s=o?X.choose(ie):i;t.value=s,t.shapeType=e,t.shape=e[n],t.shapeMap.clear(),function(t,e,n,i,o){const{w:s,h:r,m:a}=e;let h=o.at(0,0);for(let e=0;e<r;++e)for(let r=0;r<s;++r){a[r+e*s]&&(h.set(r+n,e+i),o.setBlockId(h,t))}}(s,t.shape,0,0,t.shapeMap)}(e),e.placing=!0,e.floating=!0,e.valid=!1,h(e)):e.placeTicks-=t}function se(t,e,n,i){const{w:o,h:s,m:r}=t;let a=i.at(0,0);for(let t=0;t<s;++t)for(let s=0;s<o;++s){if(r[s+t*o]){if(a.set(s+e,t+n),!i.isWithinLoaded(a))continue;let o=i.getBlockId(a);if(xt.hasComponent(Nt,o)){if(i.getBlockMeta(a)>=3)return!0}else if(!xt.hasComponent(St,o))return!0}}return!1}function re(t,e){const n=t.map.chunkWidth,i=t.map.chunkHeight;if(n!==e.chunkWidth||i!==e.chunkHeight)return null;t.score=e.score||0,t.cameraX=e.cameraX||0,t.cameraY=e.cameraY||0;const o=n*i;for(let s of Object.keys(e.chunks)){const r=e.chunks[s],[a,h]=kt(s);let l=new vt(n,i);for(let t=0;t<o;++t)l.block[t]=r.block[t],l.meta[t]=r.meta[t],l.neighbor[t]=r.neighbor[t];let c=new bt(this,s,a,h,l);t.map.chunks[s]=c}return t}function ae(t,e){const n=t.map.chunkWidth,i=t.map.chunkHeight;e.score=t.score,e.cameraX=t.cameraX,e.cameraY=t.cameraY,e.chunkWidth=n,e.chunkHeight=i;let o={};const s=n*i;for(let e of t.map.getLoadedChunks()){const t=e.chunkId;let n={block:new Array(s),meta:new Array(s),neighbor:new Array(s)};for(let t=0;t<s;++t)n.block[t]=e.data.block[t],n.meta[t]=e.data.meta[t],n.neighbor[t]=e.data.neighbor[t];o[t]=n}return e.chunks=o,e}document.addEventListener("DOMContentLoaded",(async function(){const t=document.querySelector("display-port"),e=document.querySelector("input-context"),n=e.getInput("cursorX"),i=e.getInput("cursorY"),o=e.getInput("place"),s=e.getInput("rotate"),r=(e.getInput("debug"),e.getInput("reset")),a=e.getInput("save"),h=e.getInput("load"),l=t.canvas.getContext("2d");l.imageSmoothingEnabled=!1,await async function(t){const e="";he.flick=await $.loadAudio(e+"arroyo/flick.wav"),he.melt=await $.loadAudio(e+"arroyo/melt.mp3"),he.reset=he.flick,he.background=he.melt,await async function(){}()}(),await async function(t){Ut.dirt=await $.loadAudio("arroyo/dirt.wav"),Ut.stone=await $.loadAudio("arroyo/stone.wav"),Ut.fluid=await $.loadAudio("arroyo/waterpop.wav"),Ut.metal=await $.loadAudio("arroyo/ding.wav")}();const c=new pt,u=new ft,d={map:new wt,score:0,cameraX:0,cameraY:0,time:0,firstPlace:!0};z.assign(d),function(t){t.on(Bt,Xt),t.on(It,Yt)}(d),function(t){t.on(At,Pt)}(d),function(t){t.on(It,Dt)}(d);let p=localStorage.getItem("worldData");p&&re(d,JSON.parse(p))||le(d,t);let m=0,f=0;u.moveTo(d.cameraX,d.cameraY);let g={placing:!1,floating:!0,shape:null,shapeType:null,shapeMap:new wt(0,0,ee,ne),value:0,placeX:0,placeY:0,placeTicks:0};t.addEventListener("frame",e=>{const p=e.detail.deltaTime/1e3*60;if(r.value)return localStorage.removeItem("worldData"),d.map.clear(),void le(d,t);if(a.value){let t=ae(d,{});O.downloadText("worldData.json",JSON.stringify(t))}else h.value?j.uploadFile([".json"],!1).then(t=>t.text()).then(e=>{let n=JSON.parse(e);d.map.clear(),n&&re(d,n)||le(d,t)}):d.time+=p;{let e=t.width/t.height,o=e<=1?e:1,s=e<=1?1:1/e,r=n.value-.5,a=i.value-.5;const h=4;let l=Math.atan2(a,r),c=function(t,e,n,i){let o=n-t,s=i-e;return Math.sqrt(o*o+s*s)}(0,0,r,a),m=c<.3?0:c-.3,f=Math.cos(l)*m*4*d.map.chunkWidth*o*h,g=Math.sin(l)*m*4*d.map.chunkWidth*s*h;u.moveTo(V(u.x,d.cameraX+f,.1*p),V(u.y,d.cameraY+g,.1*p))}let k=u.getViewMatrix(),b=u.getProjectionMatrix();const[v,y]=ft.screenToWorld(n.value*t.width,i.value*t.height,k,b),w=Math.floor(v/4),_=Math.floor(y/4);if(oe(p,g,o,s,d,w,_,(function(e){const[n,i]=ft.screenToWorld(t.width/2,t.height/2,k,b),o=Math.floor(n/4),s=Math.floor(i/4);let r=Math.ceil((e.placeX-o)/4),a=Math.ceil((e.placeY-s)/4);d.cameraX+=4*r,d.cameraY+=4*a,d.score+=1,qt(e.value),d.firstPlace&&(d.firstPlace=!1,he.background.play())}),(function(e){let[o,s]=function(t,e,n,i,o,s,r){let a=0,h=0;switch((t<=.5?0:2)+(e<=.5?0:1)){case 0:{let t=ft.screenToWorld(0,0,s,r);a=t[0],h=t[1]}break;case 1:{let t=ft.screenToWorld(0,o,s,r);a=t[0],h=t[1]}break;case 2:{let t=ft.screenToWorld(i,0,s,r);a=t[0],h=t[1]}break;case 3:{let t=ft.screenToWorld(i,o,s,r);a=t[0],h=t[1]}}return[Math.floor(a/n),Math.floor(h/n)]}(n.value,i.value,4,t.width,t.height,k,b);e.placeX=o,e.placeY=s,he.reset.play({pitch:X.range(-5,5)})})),function(t){t.emit("update",t)}(d),m<=0){m=10;{!function(t){t.emit(It,t)}(d);const t=d.map.getLoadedChunks(),e=d.map.chunkWidth,n=d.map.chunkHeight;let i=d.map.at(0,0);for(let o of t){const t=o.chunkCoordX*e,s=o.chunkCoordY*n;Lt(d,o);for(let r=0;r<n;++r)for(let n=0;n<e;++n)i.set(n+t,r+s),Tt(d,o,i)}}}else m-=p;if(f<=0){f=100;let t=ae(d,{});localStorage.setItem("worldData",JSON.stringify(t))}else f-=p;l.clearRect(0,0,t.width,t.height),c.begin(l,k,b),Ft(l,d.map,4),g.placing&&(l.translate(4*g.placeX,4*g.placeY),function(t,e,n){Ft(t,e.shapeMap,n)}(l,g,4),l.translate(4*-g.placeX,4*-g.placeY)),c.end(l),d.time<300&&(l.fillStyle=`rgba(0, 0, 0, ${1-d.time/300})`,l.fillRect(0,0,t.width,t.height)),l.fillStyle="white",l.fillText(d.score,4,12)})}));const he={};function le(t,e){t.score=0,t.time=0,t.firstPlace=!0;let n=t.map.at(0,0),i=n.clone();jt(t,n,Ct.blockId),jt(t,n.offset(i,-1,0),Ct.blockId),jt(t,n.offset(i,0,-1),Ct.blockId),jt(t,n.offset(i,-1,-1),Ct.blockId),t.cameraX=-e.width/2,t.cameraY=-e.height/2}}();
