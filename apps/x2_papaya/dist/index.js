!function(){"use strict";const t="noscale";class e extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="container">\n    <label class="hidden" id="title">display-port</label>\n    <label class="hidden" id="fps">00</label>\n    <label class="hidden" id="dimension">0x0</label>\n    <canvas></canvas>\n    <slot></slot>\n</div>',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block;color:#555}.container{display:flex;position:relative;width:100%;height:100%}canvas{background:#000;margin:auto;-ms-interpolation-mode:nearest-neighbor;image-rendering:-moz-crisp-edges;image-rendering:pixelated}label{font-family:monospace;color:currentColor;position:absolute}#title{left:.5rem;top:.5rem}#fps{right:.5rem;top:.5rem}#dimension{left:.5rem;bottom:.5rem}.hidden{display:none}:host([debug]) .container{outline:6px dashed rgba(0,0,0,.1);outline-offset:-4px;background-color:rgba(0,0,0,.1)}:host([mode=noscale]) canvas{margin:0;top:0;left:0}:host([mode=center]),:host([mode=fit]),:host([mode=stretch]){width:100%;height:100%}:host([full]){width:100vw!important;height:100vh!important}:host([disabled]){display:none}slot{display:flex;flex-direction:column;align-items:center;justify-content:center;position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}::slotted(*){pointer-events:auto}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{width:Number,height:Number,disabled:Boolean,debug:Boolean,mode:{type:String,value:"fit",observed:!1}}}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get height(){return this._height}set height(t){this.setAttribute("height",String(t))}get width(){return this._width}set width(t){this.setAttribute("width",String(t))}static get customEvents(){return["frame"]}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}static get observedAttributes(){return["onframe","width","height","disabled","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._canvasElement=this.shadowRoot.querySelector("canvas"),this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=300,this._height=150,this._onframe=null,this.update=this.update.bind(this)}get canvas(){return this._canvasElement}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onframe")){let t=this.onframe;delete this.onframe,this.onframe=t}if(Object.prototype.hasOwnProperty.call(this,"width")){let t=this.width;delete this.width,this.width=t}if(Object.prototype.hasOwnProperty.call(this,"height")){let t=this.height;delete this.height,this.height=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}if(Object.prototype.hasOwnProperty.call(this,"mode")){let t=this.mode;delete this.mode,this.mode=t}this.hasAttribute("mode")||this.setAttribute("mode","fit"),this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,s){switch(t){case"width":this._width=Number(s);break;case"height":this._height=Number(s);break;case"disabled":this._disabled=null!==s;break;case"debug":this._debug=null!==s;break;case"onframe":this.onframe=new Function("event","with(document){with(this){"+s+"}}").bind(this)}((t,e,s)=>{switch(t){case"disabled":s?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",s),this._fpsElement.classList.toggle("hidden",s),this._dimensionElement.classList.toggle("hidden",s)}})(t,0,s)}update(e){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const s=e-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=e,this.debug){const e=s<=0?"--":String(Math.round(1e3/s)).padStart(2,"0");if(this._fpsElement.innerText!==e&&(this._fpsElement.innerText=e),this.mode===t){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:e,prevTime:this._prevAnimationFrameTime,deltaTime:s,canvas:this._canvasElement},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}updateCanvasSize(){let e=this.shadowRoot.host.getBoundingClientRect();const s=e.width,n=e.height;let i=this._canvasElement,r=this._width,o=this._height;const a=this.mode;if("stretch"===a)r=s,o=n;else if(a!==t){if(s<r||n<o||"fit"===a){let t=s/r,e=n/o;t<e?(r=s,o*=t):(r*=e,o=n)}}r=Math.floor(r),o=Math.floor(o),i.clientWidth===r&&i.clientHeight===o||(i.width=this._width,i.height=this._height,i.style=`width: ${r}px; height: ${o}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:r,height:o},bubbles:!1,composed:!0})))}}window.customElements.define("display-port",e);const s=1,n=2,i=3,r={NULL:0,DOWN:1,UP:2,MOVE:3,parse(t){if("string"!=typeof t)return r.NULL;switch(t.toLowerCase()){case"down":return r.DOWN;case"up":return r.UP;case"move":return r.MOVE;default:return r.NULL}}},o="*";class a{constructor(t,e){this.deviceName=t,this.eventTarget=e,this.listeners={}}destroy(){this.listeners={}}addInputListener(t,e){let s=this.listeners[t];s?s.push(e):(s=[e],this.listeners[t]=s)}removeInputListener(t,e){let s=this.listeners[t];s&&(s.indexOf(e),s.splice(e,1))}dispatchInput(t){const{keyCode:e}=t,s=this.listeners[e];let n=!1;if(s){for(let e of s)n|=e(t);return n}for(let e of this.listeners["*"])n|=e(t);return n}}class l{static createAdapter(t,e,s,n,i,r){return{target:t,adapterId:e,deviceName:s,keyCode:n,scale:i,eventCode:r}}constructor(){this.adapters={"*":u()}}add(t){for(let e of t){const{deviceName:t,keyCode:s}=e;let n;t in this.adapters?n=this.adapters[t]:(n=u(),this.adapters[t]=n),s in n?n[s].push(e):n[s]=[e]}}delete(t){for(let e of t){const{deviceName:t,keyCode:s}=e;if(t in this.adapters){let n=this.adapters[t];if(s in n){let t=n[s],i=t.indexOf(e);i>=0&&t.splice(i,1)}}}}clear(){for(let t in this.adapters)this.adapters[t]=u()}poll(t,e,s){const n=this.findAdapters(t,e);for(let t of n){const e=t.eventCode;if(e===r.NULL){const{target:e,scale:n}=t,i=s.value*n;e.poll(i,t)}else{const{target:n,scale:i}=t,r=s.getEvent(e)*i;n.poll(r,t)}}return n.length>0}update(t,e,s){let n=!1;for(let i of this.findAdapters(t,e)){const t=i.eventCode;if(t!==r.NULL){const{target:e,scale:r}=i,o=s.getEvent(t)*r;e.update(o,i),n=!0}}return n}reset(t,e,s){let n=!1;for(let s of this.findAdapters(t,e))s.target.reset(),n=!0;return n}findAdapters(t,e){let s=[];if(t in this.adapters){let n=this.adapters[t];e in n&&s.push(...n[e]),s.push(...n["*"])}let n=this.adapters["*"];return e in n&&s.push(...n[e]),s.push(...n["*"]),s}}function u(){return{[o]:[]}}class h{constructor(){this.value=0}update(t){this.value=t}poll(){this.value=0}getEvent(t){return 0}getState(){return this.value}}class c extends h{constructor(){super(),this.update=this.update.bind(this),this.adapters=[],this.values=[],this.next={values:[],value:0}}hydrate(t){Array.isArray(t)||(t=[t]);let e=[],s=0;for(let n of t){"string"==typeof n&&(n={key:n});const{key:t,scale:i=1,event:o="null"}=n,{deviceName:a,keyCode:u}=d(t),h=r.parse(o),c=Number(i);let p=l.createAdapter(this,s,a,u,c,h);e.push(p),++s}this.adapters=e,this.values=new Array(e.length).fill(0),this.next={values:new Array(e.length).fill(0),value:0}}poll(t,e){const s=e.adapterId;let n=this.values[s];this.values[s]=t,this.value=this.value-n+t,this.next.values[s]=0,this.next.value+=t-n}update(t,e){const s=e.adapterId;let n=this.next.values[s];this.next.values[s]=t,this.next.value+=t-n}reset(){this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function d(t){let e=t.indexOf(":");if(e>=0)return{deviceName:t.substring(0,e),keyCode:t.substring(e+1)};throw new Error("Invalid key string - missing device separator ':'.")}function p(t,e){return`${t}:${e}`}class m extends a{constructor(t,e={}){super("Keyboard",t);const{repeat:n=!1}=e;this.repeat=n,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:r.NULL,type:s,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp)}destroy(){let t=this.eventTarget;t.removeEventListener("keydown",this.onKeyDown),t.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(t){if(t.repeat)return t.preventDefault(),t.stopPropagation(),!1;let e=this._eventObject;return e.keyCode=t.code,e.event=r.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onKeyUp(t){let e=this._eventObject;if(e.keyCode=t.code,e.event=r.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}}class f extends a{constructor(t,e={eventsOnFocus:!0}){super("Mouse",t),this.canvasTarget=t instanceof HTMLCanvasElement&&t||t.canvas||t.querySelector("canvas")||t.shadowRoot&&t.shadowRoot.querySelector("canvas")||t,this.eventsOnFocus=e.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:t,deviceName:this.deviceName,keyCode:"",event:r.NULL,type:s,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:t,deviceName:this.deviceName,keyCode:"Position",event:r.MOVE,type:n,x:0,y:0,dx:0,dy:0},this._wheelObject={target:t,deviceName:this.deviceName,keyCode:"Wheel",event:r.MOVE,type:i,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("contextmenu",this.onContextMenu),t.addEventListener("wheel",this.onWheel),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let t=this.eventTarget;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("contextmenu",this.onContextMenu),t.removeEventListener("wheel",this.onWheel),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(t=!0){t?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(t){this._downHasFocus=!0;let e=this._eventObject;if(e.keyCode="Button"+t.button,e.event=r.DOWN,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)&&document.activeElement===this.eventTarget)return t.preventDefault(),t.stopPropagation(),!1}onContextMenu(t){return t.preventDefault(),t.stopPropagation(),!1}onWheel(t){let e=this._wheelObject;switch(t.deltaMode){case WheelEvent.DOM_DELTA_LINE:e.dx=10*t.deltaX,e.dy=10*t.deltaY,e.dz=10*t.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:e.dx=100*t.deltaX,e.dy=100*t.deltaY,e.dz=100*t.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:e.dx=t.deltaX,e.dy=t.deltaY,e.dz=t.deltaZ}if(this.dispatchInput(e))return t.preventDefault(),t.stopPropagation(),!1}onMouseUp(t){if(!this._downHasFocus)return;this._downHasFocus=!1;let e=this._eventObject;return e.keyCode="Button"+t.button,e.event=r.UP,e.value=1,e.control=t.ctrlKey,e.shift=t.shiftKey,e.alt=t.altKey,this.dispatchInput(e)?(t.preventDefault(),t.stopPropagation(),!1):void 0}onMouseMove(t){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const e=this.canvasTarget,{clientWidth:s,clientHeight:n}=e,i=e.getBoundingClientRect();let r=t.movementX/s,o=t.movementY/n,a=(t.clientX-i.left)/s,l=(t.clientY-i.top)/n,u=this._positionObject;u.x=a,u.y=l,u.dx=r,u.dy=o,this.dispatchInput(u)}}class b extends h{constructor(){super(),this.delta=0,this.next={delta:0}}update(t,e){this.value=t,this.next.delta+=e}poll(){this.delta=this.next.delta,this.next.delta=0}getEvent(t){switch(t){case r.MOVE:return this.delta;default:return super.getEvent(t)}}}class v extends h{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(t){t?this.next.down=!0:this.next.up=!0}poll(){const{up:t,down:e}=this.next;this.value?this.up&&!t&&(this.value=0):e&&(this.value=1),this.down=e,this.up=t,this.next.down=!1,this.next.up=!1}getEvent(t){switch(t){case r.DOWN:return 1&this.down;case r.UP:return 1&this.up;default:return super.getEvent(t)}}}const _=1,g=2;const E=Symbol("inputSource");class y{static for(t){if(Object.prototype.hasOwnProperty.call(t,E))return t[E];{let e=new y([new m(t),new f(t)]);return Object.defineProperty(t,E,{value:e}),e}}constructor(t){this.onInputEvent=this.onInputEvent.bind(this);let e={},s={};for(let n of t){const t=n.deviceName;e[t]=n,s[t]={},n.addInputListener(o,this.onInputEvent)}this.devices=e,this.inputs=s,this.listeners={poll:[],update:[]},this._autopoll=!1,this._animationFrameHandle=null,this.onAnimationFrame=this.onAnimationFrame.bind(this)}set autopoll(t){this._autopoll=t,t?this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame):cancelAnimationFrame(this._animationFrameHandle)}get autopoll(){return this._autopoll}destroy(){this.clear();for(let t in this.devices){let e=this.devices[t];e.removeInputListener(o,this.onInputEvent),e.destroy()}}addEventListener(t,e){t in this.listeners?this.listeners[t].unshift(e):this.listeners[t]=[e]}removeEventListener(t,e){if(t in this.listeners){let s=this.listeners[t],n=s.indexOf(e);s.splice(n,1)}}dispatchEvent(t,e){for(let s of this.listeners[t])s(e)}_dispatchInputEvent(t,e,s,n){this.dispatchEvent("input",{stage:t,deviceName:e,keyCode:s,input:n})}_dispatchPollEvent(t){this.dispatchEvent("poll",{now:t})}poll(t=performance.now()){for(const t in this.inputs){const e=this.inputs[t];for(const s in e){let n=e[s];n.poll(),this._dispatchInputEvent(g,t,s,n)}}this._dispatchPollEvent(t)}onAnimationFrame(t){this._autopoll&&(this._animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.poll(t))}onInputEvent(t){const e=t.deviceName;switch(t.type){case s:{const s=t.keyCode;let n=this.inputs[e][s];if(n)return n.update(t.event===r.DOWN),this._dispatchInputEvent(_,e,s,n),!0}break;case n:{let s=this.inputs[e],n=s.PosX;n&&(n.update(t.x,t.dx),this._dispatchInputEvent(_,e,"PosX",n));let i=s.PosY;i&&(i.update(t.y,t.dy),this._dispatchInputEvent(_,e,"PosY",i))}break;case i:{let s=this.inputs[e],n=s.WheelX;n&&(n.update(t.dx,t.dx),this._dispatchInputEvent(_,e,"WheelX",n));let i=s.WheelY;i&&(i.update(t.dy,t.dy),this._dispatchInputEvent(_,e,"WheelY",i));let r=s.WheelZ;r&&(r.update(t.dz,t.dz),this._dispatchInputEvent(_,e,"WheelZ",r))}}}add(t,e){if(!(t in this.devices))throw new Error("Invalid device name - missing device with name in source.");let s=function(t,e){return"Mouse"===t&&("PosX"===e||"PosY"===e||"WheelX"===e||"WheelY"===e||"WheelZ"===e)}(t,e)?new b:new v;return this.inputs[t][e]=s,this}delete(t,e){delete this.inputs[t][e]}get(t,e){return this.inputs[t][e]}has(t,e){return t in this.inputs&&e in this.inputs[t]}clear(){for(let t in this.devices)this.inputs[t]={}}}class w{constructor(t={}){const{disabled:e=!0}=t;this.source=null,this._disabled=e,this._ignoreInput=e,this.adapters=new l,this.inputs={},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this)}get disabled(){return this._disabled}set disabled(t){this.toggle(!t)}setInputMap(t){return this._setupInputs(this.source,t),this}attach(t){return this._setupInputs(t,null),this.toggle(!0),this}detach(){return this.toggle(!1),this._setupInputs(null,null),this}_setupInputs(t,e){const s=this.disabled;this.disabled=!0;const n=this.source,i=this.inputs,r=n!==t&&n,o=this.inputs&&e;if(r||o){r&&(n.removeEventListener("poll",this.onSourcePoll),n.removeEventListener("input",this.onSourceInput));for(let t in i){let{adapters:e}=i[t];for(let t of e){const{deviceName:e,keyCode:s}=t;0===T(n,e,s)&&n.delete(e,s)}}o&&(this.adapters.clear(),this.inputs={})}if(e){let t={};for(let s in e){let n=e[s],r=i[s]||new c;r.hydrate(n);let o=r.adapters;this.adapters.add(o),t[s]=r}this.inputs=t}if(t){!function(t){A in t||(t[A]={})}(t);const e=this.inputs;for(let s in e){let{adapters:n}=e[s];for(let e of n){const{deviceName:s,keyCode:n}=e;1===S(t,s,n)&&t.add(s,n)}}this.source!==t&&(t.addEventListener("poll",this.onSourcePoll),t.addEventListener("input",this.onSourceInput),this.source=t)}this.disabled=s}onSourceInput(t){if(t.consumed||this._ignoreInput){const{deviceName:e,keyCode:s,input:n}=t;this.adapters.reset(e,s,n)}else{const{stage:e,deviceName:s,keyCode:n,input:i}=t;switch(e){case g:this.adapters.poll(s,n,i);break;case _:this.adapters.update(s,n,i)}t.consumed=!0}}onSourcePoll(t){this._ignoreInput!==this.disabled&&(this._ignoreInput=this.disabled)}toggle(t=this._disabled){if(t){if(!this.source)throw new Error("Input source must be set before enabling input context.");Object.keys(this.inputs).length<=0&&console.warn("No inputs found for enabled input context - did you forget to setInputMap()?")}return this._disabled=!t,this}getInput(t){if(t in this.inputs)return this.inputs[t];{let e=new c;return this.inputs[t]=e,e}}hasInput(t){return t in this.inputs&&this.inputs[t].adapters.length>0}getInputValue(t){return t in this.inputs?this.inputs[t].value:0}}const A=Symbol("inputRefCounts");function S(t,e,s){const n=p(e,s);let i=t[A],r=i[n]+1||1;return i[n]=r,r}function T(t,e,s){const n=p(e,s);let i=t[A],r=i[n]-1||0;return i[n]=Math.max(r,0),r}class N extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<kbd>\n    <span id="key"><slot></slot></span>\n    <span id="value" class="hidden"></span>\n</kbd>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML='kbd{position:relative;display:inline-block;border-radius:3px;border:1px solid #888;font-size:.85em;font-weight:700;text-rendering:optimizeLegibility;line-height:12px;height:14px;padding:2px 4px;color:#444;background-color:#eee;box-shadow:inset 0 -3px 0 #aaa;overflow:hidden}kbd:empty:after{content:"<?>";opacity:.6}.disabled{opacity:.6;box-shadow:none;background-color:#aaa}.hidden{display:none}#value{position:absolute;top:0;bottom:0;right:0;font-size:.85em;padding:2px 4px 0;color:#ccc;background-color:#333;box-shadow:inset 0 3px 0 #222}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{name:String,value:String,disabled:Boolean}}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get value(){return this._value}set value(t){this.setAttribute("value",t)}get name(){return this._name}set name(t){this.setAttribute("name",t)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._keyboardElement=this.shadowRoot.querySelector("kbd"),this._keyElement=this.shadowRoot.querySelector("#key"),this._valueElement=this.shadowRoot.querySelector("#value")}attributeChangedCallback(t,e,s){switch(t){case"name":this._name=s;break;case"value":this._value=s;break;case"disabled":this._disabled=null!==s}((t,e,s)=>{switch(t){case"name":this._keyElement.innerText=s;break;case"value":null!==s?(this._valueElement.classList.toggle("hidden",!1),this._valueElement.innerText=s,this._keyboardElement.style.paddingRight=`${this._valueElement.clientWidth+4}px`):this._valueElement.classList.toggle("hidden",!0);break;case"disabled":this._keyboardElement.classList.toggle("disabled",null!==s)}})(t,0,s)}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"name")){let t=this.name;delete this.name,this.name=t}if(Object.prototype.hasOwnProperty.call(this,"value")){let t=this.value;delete this.value,this.value=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}}static get observedAttributes(){return["name","value","disabled"]}}window.customElements.define("input-key",N);class x extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<table>\n    <thead>\n        <tr class="tableHeader">\n            <th colspan=4>\n                <slot id="title">input-map</slot>\n            </th>\n        </tr>\n        <tr class="colHeader">\n            <th>name</th>\n            <th>key</th>\n            <th>mod</th>\n            <th>value</th>\n        </tr>\n    </thead>\n    <tbody>\n    </tbody>\n</table>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:block}table{border-collapse:collapse}table,td,th{border:1px solid #666}td,th{padding:5px 10px}td{text-align:center}thead th{padding:0}.colHeader>th{font-size:.8em;padding:0 10px;letter-spacing:3px;background-color:#aaa;color:#666}.colHeader>th,output{font-family:monospace}output{border-radius:.3em;padding:3px}tr:not(.primary) .name,tr:not(.primary) .value{opacity:.3}tr:nth-child(2n){background-color:#eee}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get customEvents(){return["load"]}get onload(){return this._onload}set onload(t){this._onload&&this.removeEventListener("load",this._onload),this._onload=t,this._onload&&this.addEventListener("load",t)}static get observedAttributes(){return["onload","src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._src="",this._inputMap=null,this._tableElements={},this._titleElement=this.shadowRoot.querySelector("#title"),this._bodyElement=this.shadowRoot.querySelector("tbody"),this._children=this.shadowRoot.querySelector("slot")}get map(){return this._inputMap}get mapElements(){return this._tableElements}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"onload")){let t=this.onload;delete this.onload,this.onload=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let s=t[e];delete t[e],t[e]=s}}(this,"src")}attributeChangedCallback(t,e,s){switch(t){case"onload":this.onload=new Function("event","with(document){with(this){"+s+"}}").bind(this)}((t,e,s)=>{switch(t){case"src":if(this._src!==s)if(this._src=s,s.trim().startsWith("{")){let t=JSON.parse(s);this._setInputMap(t)}else fetch(s).then((t=>t.json())).then((t=>this._setInputMap(t)));break;case"id":case"class":this._titleElement.innerHTML=`input-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`}})(t,0,s)}get src(){return this.getAttribute("src")}set src(t){switch(typeof t){case"object":{let e=JSON.stringify(t);this._src=e,this._setInputMap(t),this.setAttribute("src",e)}break;case"string":this.setAttribute("src",t);break;default:this.setAttribute("src",JSON.stringify(t))}}_setInputMap(t){let e={},s=[];for(let n in t){let i=[];L(i,n,t[n]),e[n]=i,s.push(...i)}this._bodyElement.innerHTML="";for(let t of s)this._bodyElement.appendChild(t);this._inputMap=t,this._tableElements=e,this.dispatchEvent(new CustomEvent("load",{bubbles:!1,composed:!0,detail:{map:t}}))}}function L(t,e,s){if(Array.isArray(s)){L(t,e,s[0]);let n=s.length;for(let i=1;i<n;++i)t.push(M(e,s[i],!1))}else t.push(M(e,s,!0));return t}function M(t,e,s=!0){if("object"==typeof e){const{key:n,event:i,scale:r}=e;return I(t,n,i,r,0,s)}return I(t,e,null,1,0,s)}function I(t,e,s,n,i,r=!0){let o=document.createElement("tr");r&&o.classList.add("primary");{let e=document.createElement("td");e.textContent=t,e.classList.add("name"),o.appendChild(e)}{let t=document.createElement("td");t.classList.add("key");let s=new N;s.innerText=e,t.appendChild(s),o.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("samp"),i=[];"string"==typeof s&&"null"!==s&&i.push(s),"number"==typeof n&&1!==n&&i.push(`×(${n.toFixed(2)})`),e.innerText=i.join(" "),t.classList.add("mod"),t.appendChild(e),o.appendChild(t)}{let t=document.createElement("td"),e=document.createElement("output");e.innerText=Number(i).toFixed(2),e.classList.add("value"),t.appendChild(e),o.appendChild(t)}return o}window.customElements.define("input-map",x);class O extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<div class="hidden">\n    <label id="title">\n        input-source\n    </label>\n    <span>|</span>\n    <p>\n        <label for="poll">poll</label>\n        <output id="poll"></output>\n    </p>\n    <p>\n        <label for="focus">focus</label>\n        <output id="focus"></output>\n    </p>\n</div>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=':host{display:inline-block}.hidden{display:none}div{font-family:monospace;color:#666;outline:1px solid #666;padding:4px}p{display:inline;margin:0;padding:0}#focus:empty:after,#poll:empty:after{content:"✗";color:red}',Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,autopoll:Boolean,debug:Boolean}}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get autopoll(){return this._autopoll}set autopoll(t){this.toggleAttribute("autopoll",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get customEvents(){return["input","poll"]}get onpoll(){return this._onpoll}set onpoll(t){this._onpoll&&this.removeEventListener("poll",this._onpoll),this._onpoll=t,this._onpoll&&this.addEventListener("poll",t)}get oninput(){return this._oninput}set oninput(t){this._oninput&&this.removeEventListener("input",this._oninput),this._oninput=t,this._oninput&&this.addEventListener("input",t)}static get observedAttributes(){return["oninput","onpoll","for","autopoll","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._containerElement=this.shadowRoot.querySelector("div"),this._titleElement=this.shadowRoot.querySelector("#title"),this._pollElement=this.shadowRoot.querySelector("#poll"),this._focusElement=this.shadowRoot.querySelector("#focus"),this._pollCount=0,this._pollCountDelay=0,this._sourceElement=null,this._inputSource=null,this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this),this.onSourceFocus=this.onSourceFocus.bind(this),this.onSourceBlur=this.onSourceBlur.bind(this)}get source(){return this._inputSource}poll(){this._inputSource.poll()}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"oninput")){let t=this.oninput;delete this.oninput,this.oninput=t}if(Object.prototype.hasOwnProperty.call(this,"onpoll")){let t=this.onpoll;delete this.onpoll,this.onpoll=t}if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"autopoll")){let t=this.autopoll;delete this.autopoll,this.autopoll=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}this.hasAttribute("tabindex")||this.setAttribute("tabindex",0),this.hasAttribute("for")||this._setSourceElement(this)}disconnectedCallback(){this._clearSourceElement()}attributeChangedCallback(t,e,s){switch(t){case"for":this._for=s;break;case"autopoll":this._autopoll=null!==s;break;case"debug":this._debug=null!==s;break;case"oninput":this.oninput=new Function("event","with(document){with(this){"+s+"}}").bind(this);break;case"onpoll":this.onpoll=new Function("event","with(document){with(this){"+s+"}}").bind(this)}((t,e,s)=>{switch(t){case"for":this._setSourceElement(s?document.getElementById(s):this);break;case"id":case"class":{let t=this.className?"."+this.className:"",e=this.hasAttribute("id")?"#"+this.getAttribute("id"):"";this._titleElement.innerHTML=t+e}break;case"debug":this._containerElement.classList.toggle("hidden",s)}})(t,0,s)}onSourceInput(t){this.dispatchEvent(new CustomEvent("input",{composed:!0,bubbles:!1,detail:t}))}onSourcePoll(t){const{now:e}=t;if(this._pollCount+=1,this.dispatchEvent(new CustomEvent("poll",{composed:!0,bubbles:!1})),this.debug){e-this._pollCountDelay>1e3&&(this._pollCountDelay=e,this._pollCount>0?(this._pollElement.innerText="✓",this._pollCount=0):this._pollElement.innerText="")}}onSourceFocus(){this._focusElement.innerText="✓"}onSourceBlur(){this._focusElement.innerText=""}_clearSourceElement(){if(this._inputSource){let t=this._inputSource,e=this._sourceElement;this._inputSource=null,this._sourceElement=null,e.removeEventListener("focus",this.onSourceFocus),e.removeEventListener("blur",this.onSourceBlur),t.destroy()}}_setSourceElement(t){if(this._clearSourceElement(),!t)throw new Error("Event target not found.");let e=y.for(t);e.addEventListener("input",this.onSourceInput),e.addEventListener("poll",this.onSourcePoll),t.addEventListener("focus",this.onSourceFocus),t.addEventListener("blur",this.onSourceBlur),this._sourceElement=t,this._inputSource=e}}window.customElements.define("input-source",O);class C extends HTMLElement{static get[Symbol.for("cuttleTemplate")](){let t=document.createElement("template");return t.innerHTML='<input-map class="hidden">\n    <slot></slot>\n    <input-source debug></input-source>\n</input-map>\n',Object.defineProperty(this,Symbol.for("cuttleTemplate"),{value:t}),t}static get[Symbol.for("cuttleStyle")](){let t=document.createElement("style");return t.innerHTML=":host{display:inline-block}.hidden{display:none}",Object.defineProperty(this,Symbol.for("cuttleStyle"),{value:t}),t}static get properties(){return{for:String,disabled:Boolean,debug:Boolean}}get debug(){return this._debug}set debug(t){this.toggleAttribute("debug",t)}get disabled(){return this._disabled}set disabled(t){this.toggleAttribute("disabled",t)}get for(){return this._for}set for(t){this.setAttribute("for",t)}static get observedAttributes(){return["for","disabled","debug","src","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleTemplate")].content.cloneNode(!0)),this.shadowRoot.appendChild(this.constructor[Symbol.for("cuttleStyle")].cloneNode(!0)),this._inputContext=new w,this._mapElement=this.shadowRoot.querySelector("input-map"),this._sourceElement=this.shadowRoot.querySelector("input-source"),this.onInputMapLoad=this.onInputMapLoad.bind(this),this.onInputSourcePoll=this.onInputSourcePoll.bind(this),this._mapElement.addEventListener("load",this.onInputMapLoad),this._sourceElement.addEventListener("poll",this.onInputSourcePoll)}get context(){return this._inputContext}get source(){return this._sourceElement.source}get map(){return this._mapElement.map}onInputMapLoad(){let t=this._sourceElement.source,e=this._mapElement.map;t&&e&&(this._inputContext.setInputMap(e).attach(t),this._inputContext.disabled=this._disabled)}onInputSourcePoll(){for(let[t,e]of Object.entries(this._mapElement.mapElements)){let s=this._inputContext.getInputValue(t);e[0].querySelector("output").innerText=Number(s).toFixed(2)}}connectedCallback(){if(Object.prototype.hasOwnProperty.call(this,"for")){let t=this.for;delete this.for,this.for=t}if(Object.prototype.hasOwnProperty.call(this,"disabled")){let t=this.disabled;delete this.disabled,this.disabled=t}if(Object.prototype.hasOwnProperty.call(this,"debug")){let t=this.debug;delete this.debug,this.debug=t}!function(t,e){if(Object.prototype.hasOwnProperty.call(t,e)){let s=t[e];delete t[e],t[e]=s}}(this,"src")}attributeChangedCallback(t,e,s){switch(t){case"for":this._for=s;break;case"disabled":this._disabled=null!==s;break;case"debug":this._debug=null!==s}((t,e,s)=>{switch(t){case"for":{this._sourceElement.for=s;let t=this._sourceElement.source,e=this._mapElement.map;e&&(this._inputContext.setInputMap(e).attach(t),this._inputContext.disabled=this._disabled)}break;case"src":this._mapElement.src=s;break;case"disabled":{let t=this._sourceElement.source,e=this._mapElement.map;t&&e&&(this._inputContext.disabled=this._disabled)}break;case"debug":this._mapElement.classList.toggle("hidden",null===s);break;case"id":this._sourceElement.id=s;break;case"class":this._sourceElement.className=s}})(t,0,s)}get src(){return this._mapElement.src}set src(t){this._mapElement.src=t}}window.customElements.define("input-context",C);var P=1e-6,R="undefined"!=typeof Float32Array?Float32Array:Array;function k(){var t=new R(16);return R!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function F(){var t=new R(3);return R!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function D(t,e,s){var n=new R(3);return n[0]=t,n[1]=e,n[2]=s,n}function U(t,e,s,n){return t[0]=e,t[1]=s,t[2]=n,t}function j(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t}function B(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function H(t,e){var s=e[0],n=e[1],i=e[2],r=s*s+n*n+i*i;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function V(t,e,s){var n=e[0],i=e[1],r=e[2],o=s[0],a=s[1],l=s[2];return t[0]=i*l-r*a,t[1]=r*o-n*l,t[2]=n*a-i*o,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var W,q=function(t){var e=t[0],s=t[1],n=t[2];return Math.hypot(e,s,n)};W=F();!function(){var t,e=(t=new R(4),R!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function Y(){var t=new R(4);return R!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function G(t,e,s,n){var i,r,o,a,l,u=e[0],h=e[1],c=e[2],d=e[3],p=s[0],m=s[1],f=s[2],b=s[3];return(r=u*p+h*m+c*f+d*b)<0&&(r=-r,p=-p,m=-m,f=-f,b=-b),1-r>P?(i=Math.acos(r),o=Math.sin(i),a=Math.sin((1-n)*i)/o,l=Math.sin(n*i)/o):(a=1-n,l=n),t[0]=a*u+l*p,t[1]=a*h+l*m,t[2]=a*c+l*f,t[3]=a*d+l*b,t}var z,K,X,$,Z,J,Q,tt=function(t,e){var s=e[0],n=e[1],i=e[2],r=e[3],o=s*s+n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o)),t[0]=s*o,t[1]=n*o,t[2]=i*o,t[3]=r*o,t};z=F(),K=D(1,0,0),X=D(0,1,0),$=Y(),Z=Y(),J=new R(9),R!=Float32Array&&(J[1]=0,J[2]=0,J[3]=0,J[5]=0,J[6]=0,J[7]=0),J[0]=1,J[4]=1,J[8]=1,Q=J;async function et(t,e){return(await fetch(t)).text()}async function st(t,e){let s=await fetch(t);return function(t){const e=[],s=[],n=[],i=[],r=[],o=[],a=/^#.*/g,l=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,u=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,h=/vt\s+(\S+)\s+(\S+)/g,c=/f\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))(\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*)))?/g,d=/f\s+([^/\s]+)\s+([^/\s]+)\s+([^/\s]+)/g;let p,m,f,b,v,_,g=!1,E=null;t=t.replace(a,"");for(;null!=(E=l.exec(t));)p=Number.parseFloat(E[1]),m=Number.parseFloat(E[2]),f=Number.parseFloat(E[3]),e.push(p),e.push(m),e.push(f);for(;null!=(E=u.exec(t));)p=Number.parseFloat(E[1]),m=Number.parseFloat(E[2]),f=Number.parseFloat(E[3]),n.push(p),n.push(m),n.push(f);for(;null!=(E=h.exec(t));)p=Number.parseFloat(E[1]),m=Number.parseFloat(E[2]),s.push(p),s.push(m);for(;null!=(E=c.exec(t));)p=Number.parseInt(E[2]),Number.isNaN(p)&&(p=1),m=Number.parseInt(E[6]),Number.isNaN(m)&&(m=1),f=Number.parseInt(E[10]),Number.isNaN(f)&&(f=1),i.push(p),i.push(m),i.push(f),p=Number.parseInt(E[4]),Number.isNaN(p)?(p=Number.parseInt(E[3]),m=Number.parseInt(E[7]),f=Number.parseInt(E[11]),o.push(p),o.push(m),o.push(f),r.push(1),r.push(1),r.push(1)):(m=Number.parseInt(E[8]),Number.isNaN(m)&&(m=1),f=Number.parseInt(E[12]),Number.isNaN(f)&&(f=1),o.push(p),o.push(m),o.push(f),p=Number.parseInt(E[3]),Number.isNaN(p)&&(p=1),m=Number.parseInt(E[7]),Number.isNaN(m)&&(m=1),f=Number.parseInt(E[11]),Number.isNaN(f)&&(f=1),r.push(p),r.push(m),r.push(f)),void 0!==E[13]&&(b=Number.parseInt(E[15]),Number.isNaN(b)&&(b=1),i.push(b),b=Number.parseInt(E[17]),Number.isNaN(b)?(b=Number.parseInt(E[16]),o.push(b),r.push(1)):(o.push(b),b=Number.parseInt(E[16]),r.push(b)),g=!0);for(;null!=(E=d.exec(t));)p=Number.parseInt(E[2]),m=Number.parseInt(E[6]),f=Number.parseInt(E[10]),i.push(p),i.push(m),i.push(f),r.push(1),r.push(1),r.push(1),o.push(1),o.push(1),o.push(1),void 0!==E[13]&&(b=Number.parseInt(E[14]),i.push(b),r.push(1),o.push(1),g=!0);_=i.length;const y=new Float32Array(3*_);for(let t=0;t<_;++t)v=i[t]-1,y[3*t+0]=e[3*v+0],y[3*t+1]=e[3*v+1],y[3*t+2]=e[3*v+2];_=r.length;const w=new Float32Array(2*_);for(let t=0;t<_;++t)v=r[t]-1,w[2*t+0]=s[2*v+0],w[2*t+1]=s[2*v+1];_=o.length;const A=new Float32Array(3*_);for(let t=0;t<_;++t)v=o[t]-1,A[3*t+0]=n[3*v+0],A[3*t+1]=n[3*v+1],A[3*t+2]=n[3*v+2];_=i.length;const S=new Uint16Array(_);for(let t=0;t<_;++t)S[t]=t;g&&console.warn("WebGL does not support quad faces, only triangles.");return{positions:y,texcoords:w,normals:A,indices:S}}(await s.text())}function nt(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext}function it(t,e){switch(e){case t.FLOAT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 4;case t.FLOAT_MAT3:return 9;case t.FLOAT_MAT4:return 16;default:throw new Error("Invalid vertex attribute type.")}}class rt{constructor(t,e){this.gl=t,this.target=e}data(t,e){const s=this.gl,n=this.target;if(!ArrayBuffer.isView(t))throw new Error("Source data must be a typed array.");return s.bufferData(n,t,e||s.STATIC_DRAW),this}subData(t,e=0,s,n){const i=this.gl,r=this.target;if(!ArrayBuffer.isView(t))throw new Error("Source data must be a typed array.");if(s)if(nt(i))i.bufferSubData(r,e,t,s,n);else{const o=n?t.subarray(s,s+n):t.subarray(s);i.bufferSubData(r,e,o)}else i.bufferSubData(r,e,t);return this}}class ot extends rt{static from(t,e,s){return new ot(t,e,s)}constructor(t,e,s){super(t,e),this.handle=s||t.createBuffer(),t.bindBuffer(e,this.handle)}build(){return this.handle}}function at(t,e){switch(e){case Int8Array:return t.BYTE;case Uint8Array:return t.UNSIGNED_BYTE;case Int16Array:return t.SHORT;case Uint16Array:return t.UNSIGNED_SHORT;case Int32Array:return t.INT;case Uint32Array:return t.UNSIGNED_INT;case Float32Array:return t.FLOAT;default:throw new Error("Cannot find valid buffer type for typed array.")}}class lt extends ot{constructor(t,e){super(t,e),this.bufferType=t.FLOAT}data(t,e){let s=super.data(t,e);const n=t.constructor;return this.bufferType=at(this.gl,n),s}subData(t,e,s,n){let i=super.subData(t,e,s,n);const r=t.constructor;return this.bufferType=at(this.gl,r),i}build(){const t=super.build(),e=this.gl,s=this.target,n=this.bufferType;return new ut(e,s,n,t)}}class ut{static from(t,e){return new lt(t,e)}constructor(t,e,s,n){this.gl=t,this.target=e,this.handle=n,this.type=s,this.bindContext=new ht(t,this)}bind(t){return t.bindBuffer(this.target,this.handle),this.bindContext.gl=t,this.bindContext}}class ht extends rt{constructor(t,e){super(t,e.target),this.parent=e}}function ct(t,e){switch(e){case t.FLOAT:return t.uniform1f;case t.FLOAT_VEC2:return t.uniform2fv;case t.FLOAT_VEC3:return t.uniform3fv;case t.FLOAT_VEC4:return t.uniform4fv;case t.INT:return t.uniform1i;case t.INT_VEC2:return t.uniform2iv;case t.INT_VEC3:return t.uniform3iv;case t.INT_VEC4:return t.uniform4iv;case t.BOOL:return t.uniform1i;case t.BOOL_VEC2:return t.uniform2iv;case t.BOOL_VEC3:return t.uniform3iv;case t.BOOL_VEC4:return t.uniform4iv;case t.FLOAT_MAT2:return pt;case t.FLOAT_MAT3:return mt;case t.FLOAT_MAT4:return ft;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return t.uniform1i}if(nt(t))switch(e){case t.UNSIGNED_INT:return t.uniform1ui;case t.UNSIGNED_INT_VEC2:return t.uniform2uiv;case t.UNSIGNED_INT_VEC3:return t.uniform3uiv;case t.UNSIGNED_INT_VEC4:return t.uniform4uiv;case t.FLOAT_MAT2x3:return bt;case t.FLOAT_MAT2x4:return vt;case t.FLOAT_MAT3x2:return _t;case t.FLOAT_MAT3x4:return gt;case t.FLOAT_MAT4x2:return Et;case t.FLOAT_MAT4x3:return yt;case t.SAMPLER_3D:case t.SAMPLER_2D_SHADOW:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_CUBE_SHADOW:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:return t.uniform1i}throw new Error("Cannot find uniform function for gl enum.")}function dt(t,e){switch(e){case t.FLOAT:return t.uniform1fv;case t.FLOAT_VEC2:return t.uniform2fv;case t.FLOAT_VEC3:return t.uniform3fv;case t.FLOAT_VEC4:return t.uniform4fv;case t.INT:return t.uniform1iv;case t.INT_VEC2:return t.uniform2iv;case t.INT_VEC3:return t.uniform3iv;case t.INT_VEC4:return t.uniform4iv;case t.BOOL:return t.uniform1iv;case t.BOOL_VEC2:return t.uniform2iv;case t.BOOL_VEC3:return t.uniform3iv;case t.BOOL_VEC4:return t.uniform4iv;case t.FLOAT_MAT2:return pt;case t.FLOAT_MAT3:return mt;case t.FLOAT_MAT4:return ft;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return t.uniform1iv}if(nt(t))switch(e){case t.UNSIGNED_INT:return t.uniform1uiv;case t.UNSIGNED_INT_VEC2:return t.uniform2uiv;case t.UNSIGNED_INT_VEC3:return t.uniform3uiv;case t.UNSIGNED_INT_VEC4:return t.uniform4uiv;case t.FLOAT_MAT2x3:return bt;case t.FLOAT_MAT2x4:return vt;case t.FLOAT_MAT3x2:return _t;case t.FLOAT_MAT3x4:return gt;case t.FLOAT_MAT4x2:return Et;case t.FLOAT_MAT4x3:return yt;case t.SAMPLER_3D:case t.SAMPLER_2D_SHADOW:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_CUBE_SHADOW:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:return t.uniform1iv}throw new Error("Cannot find array uniform function for gl enum.")}function pt(t,e){this.uniformMatrix2fv(t,!1,e)}function mt(t,e){this.uniformMatrix3fv(t,!1,e)}function ft(t,e){this.uniformMatrix4fv(t,!1,e)}function bt(t,e){this.uniformMatrix2x3fv(t,!1,e)}function vt(t,e){this.uniformMatrix2x4fv(t,!1,e)}function _t(t,e){this.uniformMatrix3x2fv(t,!1,e)}function gt(t,e){this.uniformMatrix3x4fv(t,!1,e)}function Et(t,e){this.uniformMatrix4x2fv(t,!1,e)}function yt(t,e){this.uniformMatrix4x3fv(t,!1,e)}class wt{static from(t,e){return new wt(t,e)}constructor(t,e){this.handle=e||t.createProgram(),this.shaders=[],this.gl=t}shader(t,e){let s=function(t,e,s){let n=t.createShader(e);return t.shaderSource(n,s),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)||(console.error(t.getShaderInfoLog(n)+`\nFailed to compile shader:\n${s}`),t.deleteShader(n)),n}(this.gl,t,e);return this.shaders.push(s),this}link(){return function(t,e,s){for(let n of s)t.attachShader(e,n);t.linkProgram(e);for(let n of s)t.detachShader(e,n),t.deleteShader(n);t.getProgramParameter(e,t.LINK_STATUS)||(console.error(t.getProgramInfoLog(e)),t.deleteProgram(e))}(this.gl,this.handle,this.shaders),this.shaders.length=0,this.handle}}class At extends wt{constructor(t){super(t)}link(){const t=super.link();return new St(this.gl,t)}}class St{static from(t){return new At(t)}constructor(t,e){this.handle=e,this.activeUniforms=function(t,e){let s={};const n=function(t,e){let s=[];const n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){let n=t.getActiveUniform(e,i);if(!n)break;s.push(n)}return s}(t,e);for(let i of n){const n=i.name,r=i.size,o=i.type,a=t.getUniformLocation(e,n);let l;l=r<=1?ct(t,o):dt(t,o),s[n]={type:o,length:r,location:a,set:l}}return s}(t,e),this.activeAttributes=function(t,e){let s={};const n=function(t,e){let s=[];const n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let i=0;i<n;++i){let n=t.getActiveAttrib(e,i);n&&s.push(n)}return s}(t,e);for(let i of n){const n=i.name,r=i.size,o=i.type,a=t.getAttribLocation(e,n),l=it(t,o);s[n]={type:o,length:r,location:a,size:l}}return s}(t,e),this.drawContext=new Tt(t,this)}bind(t){return t.useProgram(this.handle),this.drawContext.gl=t,this.drawContext}}class Tt{constructor(t,e){this.gl=t,this.parent=e}uniform(t,e){const s=this.parent.activeUniforms;if(t in s){let n=s[t],i=n.location;n.set.call(this.gl,i,e)}return this}attribute(t,e,s,n=!1,i=0,r=0){const o=this.gl,a=this.parent.activeAttributes;if(t in a){let l=a[t],u=l.location,h=l.size;s?(o.bindBuffer(o.ARRAY_BUFFER,s),o.vertexAttribPointer(u,h,e,n,i,r),o.enableVertexAttribArray(u)):o.disableVertexAttribArray(u)}return this}draw(t,e,s,n,i=null){return function(t,e,s,n,i){i?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.drawElements(e,n,t.UNSIGNED_SHORT,s)):t.drawArrays(e,s,n)}(t,e,s,n,i),this.parent}}D(0,1,0);const Nt=Math.PI/3;class xt extends class{constructor(t,e,s){this.canvas=t,this.projectionMatrix=e,this.viewMatrix=s,this.resize=this.resize.bind(this),t.addEventListener("resize",this.resize),setTimeout(this.resize,0)}destroy(){this.canvas.removeEventListener("resize",this.resize)}resize(){}}{constructor(t,e=Nt,s=.1,n=1e3){super(t,k(),k()),this.fieldOfView=e,this.clippingPlane={near:s,far:n}}resize(){const t=this.canvas.width/this.canvas.height,{near:e,far:s}=this.clippingPlane;!function(t,e,s,n,i){var r,o=1/Math.tan(e/2);t[0]=o/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(r=1/(n-i),t[10]=(i+n)*r,t[14]=2*i*n*r):(t[10]=-1,t[14]=-2*n)}(this.projectionMatrix,this.fieldOfView,t,e,s)}}const Lt=Math.PI/180;class Mt{constructor(t={locky:!1}){this.locky=t.locky,this.position=F(),this.forward=D(0,0,-1),this.right=D(1,0,0),this.up=D(0,1,0),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.pitch=0,this.yaw=-90}look(t,e,s=1){return this.pitch=Math.min(89.9,Math.max(-89.9,this.pitch+e*s)),this.yaw=(this.yaw+t*s)%360,this}move(t,e=0,s=0,n=1){return this.forwardAmount+=t*n,this.rightAmount+=e*n,this.upAmount+=s*n,this}apply(t){let{position:e,forward:s,right:n,up:i,forwardAmount:r,rightAmount:o,upAmount:a,pitch:l,yaw:u}=this,h=u*Lt,c=l*Lt,d=Math.cos(h),p=Math.cos(c),m=Math.sin(h),f=d*p,b=Math.sin(c),v=m*p;H(s,U(s,f,this.locky?0:b,v)),H(n,V(n,s,i));let _=F();return B(_,s,r),j(e,e,_),B(_,n,o),j(e,e,_),B(_,i,a),j(e,e,_),this.forwardAmount=0,this.rightAmount=0,this.upAmount=0,this.locky&&U(s,f,b,v),function(t,e,s,n){var i,r,o,a,l,u,h,c,d,p,m=e[0],f=e[1],b=e[2],v=n[0],_=n[1],g=n[2],E=s[0],y=s[1],w=s[2];Math.abs(m-E)<P&&Math.abs(f-y)<P&&Math.abs(b-w)<P?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(t):(h=m-E,c=f-y,d=b-w,i=_*(d*=p=1/Math.hypot(h,c,d))-g*(c*=p),r=g*(h*=p)-v*d,o=v*c-_*h,(p=Math.hypot(i,r,o))?(i*=p=1/p,r*=p,o*=p):(i=0,r=0,o=0),a=c*o-d*r,l=d*i-h*o,u=h*r-c*i,(p=Math.hypot(a,l,u))?(a*=p=1/p,l*=p,u*=p):(a=0,l=0,u=0),t[0]=i,t[1]=a,t[2]=h,t[3]=0,t[4]=r,t[5]=l,t[6]=c,t[7]=0,t[8]=o,t[9]=u,t[10]=d,t[11]=0,t[12]=-(i*m+r*f+o*b),t[13]=-(a*m+l*f+u*b),t[14]=-(h*m+c*f+d*b),t[15]=1)}(t,e,j(_,e,s),i),t}}window.addEventListener("DOMContentLoaded",(async function(){const t=document.querySelector("#main"),e=document.querySelector("#input");e.source.autopoll=!0,s=t,s.addEventListener("focus",(()=>{document.pointerLockElement!==s&&s.requestPointerLock()})),document.addEventListener("pointerlockchange",(()=>{document.pointerLockElement!==s&&s.blur()}));var s;const n=t.canvas.getContext("webgl");if(!n)throw new Error("Your browser does not support WebGL.");n.enable(n.DEPTH_TEST);const i=await et("main.vert"),r=await et("main.frag"),o=await st("cube.obj"),a=await async function(t,e){return new Promise(((e,s)=>{let n=new Image;n.addEventListener("load",(()=>{e(n)})),n.addEventListener("error",(t=>{s(t)})),n.src=t}))}("color.png"),l=St.from(n).shader(n.VERTEX_SHADER,i).shader(n.FRAGMENT_SHADER,r).link(),u=function(t,e){return{position:ut.from(t,t.ARRAY_BUFFER).data(e.positions).build(),texcoord:ut.from(t,t.ARRAY_BUFFER).data(e.texcoords).build(),normal:ut.from(t,t.ARRAY_BUFFER).data(e.normals).build(),element:ut.from(t,t.ELEMENT_ARRAY_BUFFER).data(e.indices).build(),elementOffset:0,elementCount:e.indices.length}}(n,o),h={[Symbol.iterator](){return this.instances[Symbol.iterator]()},instances:[],create(t=0,e=0,s=0,n=t+1,i=e+1,r=s+1){let o=t,a=e,l=s,u=n,h=i,c=r;o>u&&(o=n,u=t),a>h&&(a=i,h=e),l>c&&(l=r,c=s);let d=(u-o)/2,p=(h-a)/2,m=(c-l)/2,f=o+d,b=a+p,v=l+m,_=k();!function(t,e,s,n){var i=e[0],r=e[1],o=e[2],a=e[3],l=i+i,u=r+r,h=o+o,c=i*l,d=i*u,p=i*h,m=r*u,f=r*h,b=o*h,v=a*l,_=a*u,g=a*h,E=n[0],y=n[1],w=n[2];t[0]=(1-(m+b))*E,t[1]=(d+g)*E,t[2]=(p-_)*E,t[3]=0,t[4]=(d-g)*y,t[5]=(1-(c+b))*y,t[6]=(f+v)*y,t[7]=0,t[8]=(p+_)*w,t[9]=(f-v)*w,t[10]=(1-(c+m))*w,t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1}(_,Y(),D(f,b,v),D(d,p,m));let g={transform:_,color:D(1*Math.random(),1*Math.random(),1*Math.random())};return this.instances.push(g),g}};h.create(),h.create(2,1),h.create(-10,-1,-10,10,-2,10);const c=n.createTexture();n.bindTexture(n.TEXTURE_2D,c),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,a),n.generateMipmap(n.TEXTURE_2D),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);const d=new xt(t.canvas),p=new Mt({locky:!0}),m=(e.context.getInput("PointerX"),e.context.getInput("PointerY"),e.context.getInput("PointerDown")),f=e.context.getInput("LookX"),b=e.context.getInput("LookY"),v=e.context.getInput("MoveX"),_=e.context.getInput("MoveY"),g=e.context.getInput("MoveZ");t.addEventListener("frame",(({deltaTime:t})=>{p.look(100*f.value,100*-b.value),p.move(.1*g.value,.1*v.value,.1*_.value),p.apply(d.viewMatrix),m.value&&(h.instances[0].color[0]=Math.random()),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,c);let e=l.bind(n).uniform("u_projection",d.projectionMatrix).uniform("u_view",d.viewMatrix);for(let t of h)e.attribute("a_position",u.position.type,u.position.handle).attribute("a_texcoord",u.texcoord.type,u.texcoord.handle).uniform("u_model",t.transform).uniform("u_color",t.color).uniform("u_texture",0).draw(n,n.TRIANGLES,u.elementOffset,u.elementCount,u.element.handle)}))}))}();
