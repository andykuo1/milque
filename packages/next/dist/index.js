!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gl-matrix")):"function"==typeof define&&define.amd?define(["exports","gl-matrix"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Next={},t.glMatrix)}(this,(function(t,e){"use strict";async function r(t,e){return new Promise(((e,r)=>{let n=new Image;n.addEventListener("load",(()=>{e(n)})),n.addEventListener("error",(t=>{r(t)})),n.src=t}))}var n=Object.freeze({__proto__:null,loadImage:r});async function s(t,e){return(await fetch(t)).text()}var o=Object.freeze({__proto__:null,loadText:s});async function i(t,e){let r=await fetch(t);return await r.arrayBuffer()}var a=Object.freeze({__proto__:null,loadBytes:i});async function l(t,e){let r=await fetch(t);return await r.json()}var u=Object.freeze({__proto__:null,loadJSON:l});async function c(t,e){let r=await fetch(t),n=await r.text();{const t=10;for(let e=0;e<t;++e){performance.now();f(n);performance.now()}}{const t=10;for(let e=0;e<t;++e){performance.now();h(n);performance.now()}}return h(n)}function h(t){const e=[],r=[],n=[],s=[],o=[],i=[],a=/v\s+(\S+)\s+(\S+)\s+(\S+)/g,l=/vn\s+(\S+)\s+(\S+)\s+(\S+)/g,u=/vt\s+(\S+)\s+(\S+)/g,c=/f\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*))(\s+(([^/\s]*)\/([^/\s]*)\/?([^/\s]*)))?/g,h=/f\s+([^/\s]+)\s+([^/\s]+)\s+([^/\s]+)/g;let f,d,p,m,y,x,b=!1,g=null;for(t=t.replace(/^#.*/g,"");null!=(g=a.exec(t));)f=Number.parseFloat(g[1]),d=Number.parseFloat(g[2]),p=Number.parseFloat(g[3]),e.push(f),e.push(d),e.push(p);for(;null!=(g=l.exec(t));)f=Number.parseFloat(g[1]),d=Number.parseFloat(g[2]),p=Number.parseFloat(g[3]),n.push(f),n.push(d),n.push(p);for(;null!=(g=u.exec(t));)f=Number.parseFloat(g[1]),d=Number.parseFloat(g[2]),r.push(f),r.push(d);for(;null!=(g=c.exec(t));)f=Number.parseInt(g[2]),Number.isNaN(f)&&(f=1),d=Number.parseInt(g[6]),Number.isNaN(d)&&(d=1),p=Number.parseInt(g[10]),Number.isNaN(p)&&(p=1),s.push(f),s.push(d),s.push(p),f=Number.parseInt(g[4]),Number.isNaN(f)?(f=Number.parseInt(g[3]),d=Number.parseInt(g[7]),p=Number.parseInt(g[11]),i.push(f),i.push(d),i.push(p),o.push(1),o.push(1),o.push(1)):(d=Number.parseInt(g[8]),Number.isNaN(d)&&(d=1),p=Number.parseInt(g[12]),Number.isNaN(p)&&(p=1),i.push(f),i.push(d),i.push(p),f=Number.parseInt(g[3]),Number.isNaN(f)&&(f=1),d=Number.parseInt(g[7]),Number.isNaN(d)&&(d=1),p=Number.parseInt(g[11]),Number.isNaN(p)&&(p=1),o.push(f),o.push(d),o.push(p)),void 0!==g[13]&&(m=Number.parseInt(g[15]),Number.isNaN(m)&&(m=1),s.push(m),m=Number.parseInt(g[17]),Number.isNaN(m)?(m=Number.parseInt(g[16]),i.push(m),o.push(1)):(i.push(m),m=Number.parseInt(g[16]),o.push(m)),b=!0);for(;null!=(g=h.exec(t));)f=Number.parseInt(g[2]),d=Number.parseInt(g[6]),p=Number.parseInt(g[10]),s.push(f),s.push(d),s.push(p),o.push(1),o.push(1),o.push(1),i.push(1),i.push(1),i.push(1),void 0!==g[13]&&(m=Number.parseInt(g[14]),s.push(m),o.push(1),i.push(1),b=!0);x=s.length;const w=new Float32Array(3*x);for(let t=0;t<x;++t)y=s[t]-1,w[3*t+0]=e[3*y+0],w[3*t+1]=e[3*y+1],w[3*t+2]=e[3*y+2];x=o.length;const A=new Float32Array(2*x);for(let t=0;t<x;++t)y=o[t]-1,A[2*t+0]=r[2*y+0],A[2*t+1]=r[2*y+1];x=i.length;const N=new Float32Array(3*x);for(let t=0;t<x;++t)y=i[t]-1,N[3*t+0]=n[3*y+0],N[3*t+1]=n[3*y+1],N[3*t+2]=n[3*y+2];x=s.length;const _=new Uint16Array(x);for(let t=0;t<x;++t)_[t]=t;return b&&console.warn("WebGL does not support quad faces, only triangles."),{positions:w,texcoords:A,normals:N,indices:_}}function f(t){const e=[],r=[],n=[],s=[],o=[],i=[],a=/v( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,l=/vn( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,u=/vt( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g,c=/f( +([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))( ([\d]*)\/([\d]*)\/([\d]*))?/g,h=/f( +[\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)( [\d|.|+|\-|e]+)/g;let f,d,p,m,y,x,b=!1,g=null;for(t=t.replace(/^#.*/g,"");null!=(g=a.exec(t));)f=Number.parseFloat(g[1]),d=Number.parseFloat(g[2]),p=Number.parseFloat(g[3]),e.push(f),e.push(d),e.push(p);for(;null!=(g=l.exec(t));)f=Number.parseFloat(g[1]),d=Number.parseFloat(g[2]),p=Number.parseFloat(g[3]),n.push(f),n.push(d),n.push(p);for(;null!=(g=u.exec(t));)f=Number.parseFloat(g[1]),d=Number.parseFloat(g[2]),r.push(f),r.push(d);for(;null!=(g=c.exec(t));)f=Number.parseInt(g[2]),Number.isNaN(f)&&(f=1),d=Number.parseInt(g[6]),Number.isNaN(d)&&(d=1),p=Number.parseInt(g[10]),Number.isNaN(p)&&(p=1),s.push(f),s.push(d),s.push(p),f=Number.parseInt(g[3]),Number.isNaN(f)&&(f=1),d=Number.parseInt(g[7]),Number.isNaN(d)&&(d=1),p=Number.parseInt(g[11]),Number.isNaN(p)&&(p=1),o.push(f),o.push(d),o.push(p),f=Number.parseInt(g[4]),Number.isNaN(f)&&(f=1),d=Number.parseInt(g[8]),Number.isNaN(d)&&(d=1),p=Number.parseInt(g[12]),Number.isNaN(p)&&(p=1),i.push(f),i.push(d),i.push(p),void 0!==g[13]&&(m=Number.parseInt(g[14]),Number.isNaN(m)&&(m=1),s.push(m),m=Number.parseInt(g[15]),Number.isNaN(m)&&(m=1),o.push(m),m=Number.parseInt(g[16]),Number.isNaN(m)&&(m=1),i.push(m),b=!0);for(;null!=(g=h.exec(t));)f=Number.parseInt(g[2]),d=Number.parseInt(g[6]),p=Number.parseInt(g[10]),s.push(f),s.push(d),s.push(p),o.push(1),o.push(1),o.push(1),i.push(1),i.push(1),i.push(1),void 0!==g[13]&&(m=Number.parseInt(g[14]),s.push(m),o.push(1),i.push(1),b=!0);x=s.length;const w=new Float32Array(3*x);for(let t=0;t<x;++t)y=s[t]-1,w[3*t+0]=e[3*y+0],w[3*t+1]=e[3*y+1],w[3*t+2]=e[3*y+2];x=o.length;const A=new Float32Array(2*x);for(let t=0;t<x;++t)y=o[t]-1,A[2*t+0]=r[2*y+0],A[2*t+1]=r[2*y+1];x=i.length;const N=new Float32Array(3*x);for(let t=0;t<x;++t)y=i[t]-1,N[3*t+0]=n[3*y+0],N[3*t+1]=n[3*y+1],N[3*t+2]=n[3*y+2];x=s.length;const _=new Uint16Array(x);for(let t=0;t<x;++t)_[t]=t;return b&&console.warn("WebGL does not support quad faces, only triangles."),{positions:w,texcoords:A,normals:N,indices:_}}var d=Object.freeze({__proto__:null,loadOBJ:c});let p={};function m(t,e){p[t]=e}function y(t){if(t in p)return p[t];throw new Error(`Unknown asset type '${t}'.`)}async function x(t,e={},r="."){if(t.indexOf(":")<0)throw new Error("Missing type for asset source.");let[n,s]=t.split(":"),o=y(n);return await o(r+"/"+s,e)}m("image",r),m("text",s),m("json",l),m("bytes",i),m("obj",c);var b=Object.freeze({__proto__:null,defineAssetLoader:m,getAssetLoader:y,loadAssetMap:async function(t,e="."){let r={};for(let n of Object.keys(t)){let s=t[n];if("string"==typeof s)r[n]=await x(s,void 0,e);else{if("object"!=typeof s)throw new Error("Unknown entry type in asset map.");if(!("src"in s))throw new Error("Missing required field 'src' for entry in asset map.");if("name"in s&&s.name!==n)throw new Error(`Cannot redefine name for asset '${n}' for entry in asset map.`);r[n]=await x(s.src,s,e)}}return r},loadAssetList:async function(t,e="."){let r={};for(let n of t)if("string"==typeof n)r[n]=await x(n,void 0,e);else{if("object"!=typeof n)throw new Error("Unknown entry type in asset list.");if(!("src"in n))throw new Error("Missing required field 'src' for entry in asset list.");r["name"in n?n.name:n.src]=await x(n.src,n,e)}return r},loadAsset:x});const g=1e-8;function w(t,e,r){return Math.min(Math.max(t,e),r)}function A(t,e,r,n){return{x:t,y:e,rx:r,ry:n}}function N(t,e,r){let n=r.x-e.x,s=r.rx+e.rx-Math.abs(n);if(s<0)return null;let o=r.y-e.y,i=r.ry+e.ry-Math.abs(o);if(i<0)return null;if(s<i){let o=Math.sign(n);t.dx=s*o,t.dy=0,t.nx=o,t.ny=0,t.x=e.x+e.rx*o,t.y=r.y}else{let n=Math.sign(o);t.dx=0,t.dy=i*n,t.nx=0,t.ny=n,t.x=r.x,t.y=e.y+e.ry*n}return t}function _(t,e,r,n){let s=r-e.x,o=e.rx-Math.abs(s);if(o<0)return null;let i=n-e.y,a=e.ry-Math.abs(i);if(a<0)return null;if(o<a){let r=Math.sign(s);t.dx=o*r,t.dy=0,t.nx=r,t.ny=0,t.x=e.x+e.rx*r,t.y=n}else{let n=Math.sign(i);t.dx=0,t.dy=a*n,t.nx=0,t.ny=n,t.x=r,t.y=e.y+e.ry*n}return t}function M(t,e,r,n,s,o,i=0,a=0){if(Math.abs(s)<g&&Math.abs(o)<g&&0===i&&0===a)return _(t,e,r,n);let l=e.rx,u=e.ry,c=i,h=a,f=1/(s||g),d=1/(o||g),p=Math.sign(f),m=Math.sign(d),y=(e.x-p*(l+c)-r)*f,x=(e.y-m*(u+h)-n)*d,b=(e.x+p*(l+c)-r)*f,A=(e.y+m*(u+h)-n)*d;if(y>A||x>b)return null;let N=Math.max(y,x),M=Math.min(b,A);if(N>1||M<0)return null;let v=w(N,0,1),T=(1-v)*-s,E=(1-v)*-o,I=r+s*v,S=n+o*v;return y>x?(t.time=v,t.nx=-p,t.ny=0,t.dx=T,t.dy=E,t.x=I,t.y=S):(t.time=v,t.nx=0,t.ny=-m,t.dx=T,t.dy=E,t.x=I,t.y=S),t}function v(t,e,r,n,s){if(Math.abs(n)<g&&Math.abs(s)<g){let n=N({},r,e);return n&&(n.time=0),t.x=e.x,t.y=e.y,t.time=n?0:1,t.hit=n,t}let o=function(t,e,r,n,s){return M(t,e,r.x,r.y,n,s,r.rx,r.ry)}({},r,e,n,s);if(o){let i,a,l=w(o.time,0,1),u=Math.sqrt(n*n+s*s);u?(i=n/u,a=s/u):(i=0,a=0),o.x=w(o.x+i*e.rx,r.x-r.rx,r.x+r.rx),o.y=w(o.y+a*e.ry,r.y-r.ry,r.y+r.ry),t.time=l,t.x=e.x+n*l,t.y=e.y+s*l,t.hit=o}else t.time=1,t.x=e.x+n,t.y=e.y+s,t.hit=o;return t}function T(t,e,r,n,s){let o={};t.time=1,t.x=e.x+n,t.y=e.y+s,t.hit=null;for(let i=0,a=r.length;i<a;++i){let a=v(o,e,r[i],n,s);a.time<=t.time&&(t.time=a.time,t.x=a.x,t.y=a.y,t.hit=a.hit)}return t}var E=Object.freeze({__proto__:null,EPSILON:g,clamp:w,createAABB:A,createRect:function(t,e,r,n){let s=Math.abs(r-t)/2,o=Math.abs(n-e)/2;return A(Math.min(t,r)+s,Math.min(e,n)+o,s,o)},testAABB:function(t,e){return!(Math.abs(t.x-e.x)>t.rx+e.rx)&&!(Math.abs(t.y-e.y)>t.ry+e.ry)},intersectAABB:N,intersectPoint:_,intersectSegment:M,sweepInto:T});function I(t,e=[]){for(let r of t)switch(r.type){case"point":r.hit=null;for(let t of e)if(r.hit=_({},t,r.x,r.y),r.hit)break;break;case"segment":r.hit=null;for(let t of e)if(r.hit=M({},t,r.x,r.y,r.dx,r.dy,r.px,r.py),r.hit)break;break;case"aabb":r.hit=null;for(let t of e)if(r.hit=N({},t,r),r.hit)break}}function S(t,e=[],r=1){for(let n of t){let t,s=n.dx*r,o=n.dy*r,i=0,a={},l=null,u=100;do{if(t=T(a,n,e,s,o),n.x=t.x-Math.sign(s)*g,n.y=t.y-Math.sign(o)*g,i+=t.time,t.hit){s+=t.hit.nx*Math.abs(s),o+=t.hit.ny*Math.abs(o),l=t.hit;let e=Math.max(1-i,0);s*=e,o*=e,Math.abs(s)<g&&(s=0),Math.abs(o)<g&&(o=0)}}while(i<1&&--u>=0);n.dx=s,n.dy=o,n.hit=l}}var F=Object.freeze({__proto__:null,computeIntersections:I,resolveIntersections:S});var O=Object.freeze({__proto__:null,createIntersectionWorld:function(){return{dynamics:[],masks:[],statics:[],update(t){S(this.dynamics,this.statics,t),I(this.masks,this.statics)},render(t){t.save(),t.strokeStyle="green";for(let e of this.statics)t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry);t.strokeStyle="lime";for(let e of this.dynamics)t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry);t.strokeStyle="blue";for(let e of this.masks)switch(e.type){case"point":t.save(),t.fillStyle="red",t.fillRect(e.x-1,e.y-1,2,2),t.restore();break;case"segment":t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+e.dx,e.y+e.dy),t.stroke();break;case"aabb":t.strokeRect(e.x-e.rx,e.y-e.ry,2*e.rx,2*e.ry)}t.restore()}}}});const R=new AudioContext;!async function(t){document.addEventListener("click",(()=>{"suspended"===t.state&&t.resume()}))}(R);const B={gain:0,pitch:0,pan:0,loop:!1};class k{constructor(t,e,r=!1){this.context=t,this.buffer=e,this._source=null,this.playing=!1,this.loop=r,this.onAudioSourceEnded=this.onAudioSourceEnded.bind(this)}onAudioSourceEnded(){this._playing=!1}play(t=B){if(!this.buffer)return;this._source&&this.destroy();const e=this.context;let r=e.createBufferSource();r.addEventListener("ended",this.onAudioSourceEnded),r.buffer=this.buffer,r.loop=t.loop;let n=r;if(t.pitch&&(r.detune.value=100*t.pitch),t.gain){const r=e.createGain();r.gain.value=t.gain,n=n.connect(r)}if(t.pan){const r=e.createStereoPanner();r.pan.value=t.pan,n=n.connect(r)}n.connect(e.destination),r.start(),this._source=r,this._playing=!0}pause(){this._source.stop(),this._playing=!1}destroy(){this._source&&this._source.disconnect(),this._source=null}}var z=Object.freeze({__proto__:null,AUDIO_CONTEXT:R,AUDIO_ASSET_TAG:"audio",loadAudio:async function(t,e={}){const r=R;let n=await fetch(t),s=await n.arrayBuffer(),o=await r.decodeAudioData(s);return new k(r,o,Boolean(e.loop))}});class C{static currentTime(){return performance.now()}static start(t){let e=new C(t,!1);return e.start(),e}constructor(t,e=!1){this.app=t,this._controlled=e,this._animationFrameHandle=null,this.prevFrameTime=0,this.started=!1,this.paused=!1,this.fixedTimeStep=1/60,this.prevAccumulatedTime=0,this._onstart=null,this._onstop=null,this._onpreupdate=null,this._onupdate=null,this._onfixedupdate=null,this._onpostupdate=null,this._onpause=null,this._onresume=null,this.onAnimationFrame=this.onAnimationFrame.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this)}setFixedUpdatesPerSecond(t){return this.fixedTimeStep=1/t,this}onWindowFocus(){this.started&&this.resume()}onWindowBlur(){this.started&&this.pause()}onAnimationFrame(t){if(this._controlled)throw new Error("Cannot run controlled game loop; call step() instead.");if(!this.started)throw new Error("Must be called after start().");this.animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.step(t)}step(t=C.currentTime()){if(!this.started)return!1;const e=t-this.prevFrameTime;if(this.prevFrameTime=t,this.paused)return!1;if(this.app.preUpdate&&this.app.preUpdate(e),this.app.update&&this.app.update(e),this.prevAccumulatedTime+=e/1e3,this.prevAccumulatedTime>250*this.fixedTimeStep){let t=250*this.fixedTimeStep,e=Math.floor((this.prevAccumulatedTime-t)/this.fixedTimeStep);this.prevAccumulatedTime=t,console.error(`[ApplicationLoop] Too many updates! Skipped ${e} fixed updates.`)}for(;this.prevAccumulatedTime>=this.fixedTimeStep;)this.prevAccumulatedTime-=this.fixedTimeStep,this.app.fixedUpdate&&this.app.fixedUpdate();this.app.postUpdate&&this.app.postUpdate(e)}start(){if(this.started)throw new Error("Loop already started.");return window.addEventListener("focus",this.onWindowFocus),window.addEventListener("blur",this.onWindowBlur),this.started=!0,this.prevFrameTime=C.currentTime(),this.app.start&&this.app.start(),this.controlled||this.onAnimationFrame(this.prevFrameTime),this}stop(){if(!this.started)throw new Error("Loop not yet started.");return window.removeEventListener("focus",this.onWindowFocus),window.removeEventListener("blur",this.onWindowBlur),this.started=!1,this.app.stop&&this.app.stop(),this._controlled||this.animationFrameHandle&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null),this}pause(){return this.paused||(this.paused=!0,this.app.pause&&this.app.pause()),this}resume(){return this.pause?(this.prevFrameTime=C.currentTime(),this.paused=!1,this.app.resume&&this.app.resume(),this):this}}class L{constructor(t){this.context=t,this.display=null,this.renderContext=null}setDisplay(t){return this.display=t,this.renderContext=t.canvas.getContext("2d"),this}start(){this.context.start()}update(t){this.context.update(t),this.context.render(this.renderContext)}}const U=Symbol("game"),P=Symbol("loop");var j=Object.freeze({__proto__:null,start:function(t){let e={...t},r=new L(e),n=new C(r);return e[U]=r,e[P]=n,e.display=null,window.addEventListener("DOMContentLoaded",(()=>{let t=document.querySelector("display-port");if(!t)throw new Error("Cannot find display-port in document.");r.setDisplay(t),e.display=t,e.load().then((()=>n.start()))})),e},stop:function(t){t[P].stop(),delete t[U],delete t[P]}});const V={x:0,y:0,width:1,height:1,color:"dodgerblue",solid:!0},D=Symbol("BoxRendererInfo");function G(t,e,r,n){return e?t in e?e[t]:t in r?r[t]:n[t]:r&&t in r?r[t]:n[t]}const W={x:0,y:0,width:1,height:1,spriteImage:null},Y=Symbol("SpriteRendererInfo");function X(t,e,r,n){return e?t in e?e[t]:t in r?r[t]:n[t]:r&&t in r?r[t]:n[t]}class q{static createBounds(t,e,r,n){return{x:t,y:e,rx:r,ry:n}}constructor(t=0,e=q.createBounds(0,0,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)){this.level=t,this.bounds=e,this.boxes=[],this.nodes=new Array(4)}insertAll(t){for(let e of t)this.insert(e)}insert(t){let e=this.nodes[0];if(e){let e=this.findQuadIndex(t);if(e>=0)return void this.nodes[e].insert(t)}if(this.boxes.push(t),this.boxes.length>10&&this.level<5){e||this.split();for(let t=this.boxes.length-1;t>=0;--t){let e=this.boxes[t],r=this.findQuadIndex(e);r>=0&&(this.boxes.splice(t,1),this.nodes[r].insert(e))}}}retrieve(t,e=[],r={}){const{includeSelf:n=!1}=r;if(this.nodes[0]){let r=this.findQuadIndex(t);r>=0&&this.nodes[r].retrieve(t,e)}let s=this.boxes;if(n)e.push(...s);else{let r=s.indexOf(t);for(let t=0;t<r;++t)e.push(s[t]);let n=s.length;for(let t=r+1;t<n;++t)e.push(s[t])}return e}clear(){this.boxes.length=0;for(let t=0;t<this.nodes.length;++t){let e=this.nodes[t];e&&(e.clear(),this.nodes[t]=null)}}split(){let{x:t,y:e,rx:r,ry:n}=this.bounds,s=this.level+1,o=this.constructor;this.nodes[0]=new o(s,q.createBounds(t+r,e,r,n)),this.nodes[1]=new o(s,q.createBounds(t,e,r,n)),this.nodes[2]=new o(s,q.createBounds(t,e+n,r,n)),this.nodes[3]=new o(s,q.createBounds(t+r,e+n,r,n))}findQuadIndex(t){const{x:e,y:r,rx:n,ry:s}=this.bounds,o=e+n,i=r+s,{x:a,y:l,rx:u,ry:c}=t,h=l<i&&l+2*c<i,f=l>i;let d=-1;return a<o&&a+2*u<o?h?d=1:f&&(d=2):a>o&&(h?d=0:f&&(d=3)),d}}function $(t,e,r,n,s,o,i){return{x:t,y:e,dx:r,dy:n,nx:s,ny:o,time:i}}function H(t,e){let r=e.x-t.x,n=e.rx+t.rx-Math.abs(r);if(n<0)return null;let s=e.y-t.y,o=e.ry+t.ry-Math.abs(s);if(o<0)return null;if(n<o){let s=Math.sign(r);return $(t.x+t.rx*s,e.y,n*s,0,s,0,0)}{let r=Math.sign(s);return $(e.x,t.y+t.ry*r,0,o*r,0,r,0)}}const Q=Symbol("maskCount");class J{constructor(t,e,r,n,s,o){this.aabbGraph=t,this.mask=e,this.x=r,this.y=n,this.rx=s,this.ry=o}setPosition(t,e){return this.x=t,this.y=e,this}setSize(t,e){return this.setHalfSize(t/2,e/2)}setHalfSize(t,e){return this.rx=t,this.ry=e,this}}const Z={};function K(t,e,r){null===t?(r.rootNodes.push(e),e.parentNode=null):(t.childNodes.push(e),e.parentNode=t)}function tt(t,e,r){if(null===t){let t=r.rootNodes.indexOf(e);r.rootNodes.splice(t,1),e.parentNode=void 0}else{let r=t.childNodes.indexOf(e);t.childNodes.splice(r,1),e.parentNode=void 0}}function et(t,e,r,n,s){if(r>=100)return;let o=n(e.owner,e);if(!1===o)return;let i=e.childNodes;s&&rt(t.nodes,i,e,s);for(let t of i)et(t,r+1,n);"function"==typeof o&&o(e.owner,e)}function rt(t,e,r,n){let s=e.map((t=>t.owner));n(s,r);for(let r=0;r<s.length;++r)e[r]=t.get(s[r]);e.length=s.length}class nt{constructor(t,e,r,n){this.sceneGraph=t,this.owner=e,this.parentNode=r,this.childNodes=n}}const st=e.vec3.fromValues(0,0,0),ot=e.vec3.fromValues(1,0,0),it=e.vec3.fromValues(0,1,0),at=e.vec3.fromValues(0,0,1);function lt(){return{translation:e.vec3.create(),rotation:e.quat.create(),scale:e.vec3.fromValues(1,1,1)}}function ut(t,r=e.mat4.create()){return e.mat4.fromRotationTranslationScale(r,t.rotation,t.translation,t.scale)}var ct=Object.freeze({__proto__:null,ORIGIN:st,XAXIS:ot,YAXIS:it,ZAXIS:at,create:lt,lookAt:function(t,r=st){const n=e.vec3.create();e.vec3.subtract(n,r,t.position),e.vec3.normalize(n,n);const s=e.vec3.dot(at,n);if(Math.abs(s- -1)<Number.EPSILON)return e.quat.set(t.rotation,0,0,1,Math.PI),t;if(Math.abs(s-1)<Number.EPSILON)return e.quat.set(t.rotation,0,0,0,1),t;e.vec3.cross(n,at,n),e.vec3.normalize(n,n);const o=Math.acos(s)/2,i=Math.sin(o);return t.rotation[0]=n[0]*i,t.rotation[1]=n[1]*i,t.rotation[2]=n[2]*i,t.rotation[3]=Math.cos(o),t},getTransformationMatrix:ut,getForwardVector:function(t,r=e.vec3.create()){return e.vec3.transformQuat(r,at,t.rotation),r},getUpVector:function(t,r=e.vec3.create()){return e.vec3.transformQuat(r,it,t.rotation),r},getRightVector:function(t,r=e.vec3.create()){return e.vec3.transformQuat(r,ot,t.rotation),r}});function ht(t,e,r,n,s){if(!s){const e=Math.random(),r=Math.random(),n=Math.random();s=[];for(let o=0;o<t.length;o+=3)s.push(e,r,n)}return{position:t,texcoord:e,normal:r,indices:n,color:s,elementSize:3,elementCount:n.length}}function ft(t,e,r,n){for(let s=0;s<n.color.length;s+=3)n.color[s+0]=t,n.color[s+1]=e,n.color[s+2]=r;return n}function dt(t,r){const n=r.position,s=r.normal,o=e.mat3.create();e.mat3.normalFromMat4(o,t);const i=e.vec3.create();for(let r=0;r<n.length;r+=3)i[0]=n[r+0],i[1]=n[r+1],i[2]=n[r+2],e.vec3.transformMat4(i,i,t),n[r+0]=i[0],n[r+1]=i[1],n[r+2]=i[2],i[0]=s[r+0],i[1]=s[r+1],i[2]=s[r+2],e.vec3.transformMat3(i,i,o),s[r+0]=i[0],s[r+1]=i[1],s[r+2]=i[2];return r}function pt(...t){const e=[],r=[],n=[],s=[],o=[];let i=0;for(const a of t)e.push(...a.position),r.push(...a.texcoord),n.push(...a.normal),o.push(...a.color),s.push(...a.indices.map((t=>t+i))),i+=a.position.length/3;return ht(e,r,n,s,o)}function mt(t=!1){let e;if(t){const t=.5,r=.5;e=[0-t,0-r,0,0+t,0-r,0,0-t,0+r,0,0+t,0+r,0]}else e=[0,0,0,1,0,0,0,1,0,1,1,0];return ht(e,[0,0,1,0,0,1,1,1],[0,0,1,0,0,1,0,0,1,0,0,1],[0,1,2,2,1,3])}var yt=Object.freeze({__proto__:null,create:mt});function xt(t=!0){const r=mt(!0);if(t){const t=mt(!0);return dt(e.mat4.fromYRotation(e.mat4.create(),Math.PI),t),ft(r.color[0],r.color[1],r.color[2],t),pt(r,t)}return r}var bt=Object.freeze({__proto__:null,create:xt});function gt(t=!0,r=!0,n=!0,s=!0,o=!0,i=!0){const a=Math.PI/2,l=e.mat4.create(),u=[];if(t){const t=xt(!1);e.mat4.fromTranslation(l,[0,0,.5]),dt(l,t),u.push(t)}if(n){const t=xt(!1);e.mat4.fromXRotation(l,-a),e.mat4.translate(l,l,[0,0,.5]),dt(l,t),u.push(t)}if(r){const t=xt(!1);e.mat4.fromYRotation(l,Math.PI),e.mat4.translate(l,l,[0,0,.5]),dt(l,t),u.push(t)}if(s){const t=xt(!1);e.mat4.fromXRotation(l,a),e.mat4.translate(l,l,[0,0,.5]),dt(l,t),u.push(t)}if(o){const t=xt(!1);e.mat4.fromYRotation(l,-a),e.mat4.translate(l,l,[0,0,.5]),dt(l,t),u.push(t)}if(i){const t=xt(!1);e.mat4.fromYRotation(l,a),e.mat4.translate(l,l,[0,0,.5]),dt(l,t),u.push(t)}return pt(...u)}var wt=Object.freeze({__proto__:null,create:gt});var At=Object.freeze({__proto__:null,create:function(){const t=.2,r=e.mat4.create(),n=gt(!0,!0,!0,!0,!1,!0);e.mat4.fromTranslation(r,[.1,.4,0]),e.mat4.scale(r,r,[.4,t,t]),dt(r,n),ft(n.color[0],n.color[1],n.color[2],n);const s=gt(!0,!0,!0,!0,!1,!0);e.mat4.fromScaling(r,[t,t,t]),dt(r,s),ft(n.color[0],n.color[1],n.color[2],s);const o=gt(!0,!0,!0,!0,!0,!0);return e.mat4.fromTranslation(r,[-.2,0,0]),e.mat4.scale(r,r,[t,1,t]),dt(r,o),ft(n.color[0],n.color[1],n.color[2],o),pt(o,n,s)}}),Nt=Object.freeze({__proto__:null,Quad:yt,Plane:bt,Cube:wt,GlyphF:At,create:ht,applyColor:ft,applyTransformation:dt,joinGeometry:pt});function _t(t,e,r,n){if(!n){const e=Math.random(),r=Math.random(),s=Math.random();n=[];for(let o=0;o<t.length;o+=3)n.push(e,r,s)}return{position:t,texcoord:e,indices:r,color:n,elementSize:2,elementCount:r.length}}function Mt(t,r){const n=r.position,s=e.vec2.create();for(let r=0;r<n.length;r+=2)s[0]=n[r+0],s[1]=n[r+1],e.vec3.transformMat3(s,s,t),n[r+0]=s[0],n[r+1]=s[1];return r}function vt(...t){const e=[],r=[],n=[],s=[];let o=0;for(const i of t){e.push(...i.position),r.push(...i.texcoord),s.push(...i.color);for(let t=0;t<i.indices.length;++t){const e=i.indices[t];n.push(e+o)}o+=i.position.length/2}return _t(e,r,n,s)}function Tt(t=!1){let e;if(t){const t=.5,r=.5;e=[0-t,0-r,0+t,0-r,0-t,0+r,0+t,0+r]}else e=[0,0,1,0,0,1,1,1];return _t(e,[0,0,1,0,0,1,1,1],[0,1,2,2,1,3])}var Et=Object.freeze({__proto__:null,create:Tt});var It=Object.freeze({__proto__:null,create:function(){const t=.2,r=e.mat3.create(),n=Tt();e.mat3.fromTranslation(r,[.1,.4]),e.mat3.scale(r,r,[.4,t]),Mt(r,n),ft(n.color[0],n.color[1],n.color[2],n);const s=Tt();e.mat3.fromScaling(r,[t,t]),Mt(r,s),ft(n.color[0],n.color[1],n.color[2],s);const o=Tt();return e.mat3.fromTranslation(r,[-.2,0]),e.mat3.scale(r,r,[t,1]),Mt(r,o),ft(n.color[0],n.color[1],n.color[2],o),vt(o,n,s)}}),St=Object.freeze({__proto__:null,Quad2D:Et,GlyphF2D:It,applyColor2D:ft,create:_t,applyTransformation2D:Mt,joinGeometry2D:vt});function Ft(t,e,r){const n=t.createShader(e);if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(n);throw t.deleteShader(n),new Error(e)}return n}function Ot(t,e,r,n=[]){const s=t.createProgram();t.attachShader(s,e),t.attachShader(s,r);for(let e=0;e<n.length;++e)t.bindAttribLocation(s,e,n[e]);if(t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){const e=t.getProgramInfoLog(s);throw t.deleteProgram(s),new Error(e)}return s}function Rt(t,e){const r={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<n;++s){const n=t.getActiveAttrib(e,s);if(!n)break;const o=n.name,i=t.getAttribLocation(e,o);r[o]=Bt(i)}return r}function Bt(t){const e=function(t,e,r){e.enableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,r.handle),e.vertexAttribPointer(t,r.size,r.type,r.normalize,r.stride,r.offset)}.bind(null,t);return e.location=t,e}function kt(t,e){const r={},n={textureUnit:0},s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let o=0;o<s;++o){const s=t.getActiveUniform(e,o);if(!s)break;let i=s.name;"[0]"===i.substring(i.length-3)&&(i=i.substring(0,i.length-3));const a=zt(t,e,s,n);r[i]=a}return r}function zt(t,e,r,n){const s=r.name,o=t.getUniformLocation(e,s),i=r.type,a=r.size>1&&"[0]"===s.substring(s.length-3),l=Lt(t,i);if(!l)throw new Error(`Unknown uniform type 0x${i.toString(16)}.`);switch(i){case t.FLOAT:case t.INT:case t.BOOL:return l.setter(o,a);case t.SAMPLER_2D:case t.SAMPLER_CUBE:{let t;if(a){t=[];for(let e=0;e<r.size;++e)t.push(n.textureUnit++)}else t=n.textureUnit++;return l.setter(o,a,t)}default:return l.setter(o)}}let Ct=null;function Lt(t,e){if(Ct)return Ct[e];function r(t,e,r=!1,n=0){if(r&&!Array.isArray(n))throw new Error("Cannot create sampler array for non-array texture unit.");const s=(r?function(t,e,r,n,s){n.uniform1fv(t,e),s.forEach(((t,s)=>{n.activeTexture(n.TEXTURE0+e[s]),n.bindTexture(r,t)}))}:function(t,e,r,n,s){n.uniform1i(t,e),n.activeTexture(n.TEXTURE0+e),n.bindTexture(r,s)}).bind(null,e,n,t);return s.location=e,s}return Ct={[t.FLOAT]:{TypedArray:Float32Array,size:4,setter(t,e=!1){const r=(e?function(t,e,r){e.uniform1fv(t,r)}:function(t,e,r){e.uniform1f(t,r)}).bind(null,t);return r.location=t,r}},[t.FLOAT_VEC2]:{TypedArray:Float32Array,size:8,setter(t){const e=function(t,e,r){e.uniform2fv(t,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_VEC3]:{TypedArray:Float32Array,size:12,setter(t){const e=function(t,e,r){e.uniform3fv(t,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_VEC4]:{TypedArray:Float32Array,size:16,setter(t){const e=function(t,e,r){e.uniform4fv(t,r)}.bind(null,t);return e.location=t,e}},[t.INT]:{TypedArray:Int32Array,size:4,setter(t,e=!1){const r=(e?function(t,e,r){e.uniform1iv(t,r)}:function(t,e,r){e.uniform1i(t,r)}).bind(null,t);return r.location=t,r}},[t.INT_VEC2]:{TypedArray:Int32Array,size:8,setter(t){const e=function(t,e,r){e.uniform2iv(t,r)}.bind(null,t);return e.location=t,e}},[t.INT_VEC3]:{TypedArray:Int32Array,size:12,setter(t){const e=function(t,e,r){e.uniform3iv(t,r)}.bind(null,t);return e.location=t,e}},[t.INT_VEC4]:{TypedArray:Int32Array,size:16,setter(t){const e=function(t,e,r){e.uniform4iv(t,r)}.bind(null,t);return e.location=t,e}},[t.BOOL]:{TypedArray:Uint32Array,size:4,setter(t,e=!1){const r=(e?function(t,e,r){e.uniform1iv(t,r)}:function(t,e,r){e.uniform1i(t,r)}).bind(null,t);return r.location=t,r}},[t.BOOL_VEC2]:{TypedArray:Uint32Array,size:8,setter(t){const e=function(t,e,r){e.uniform2iv(t,r)}.bind(null,t);return e.location=t,e}},[t.BOOL_VEC3]:{TypedArray:Uint32Array,size:12,setter(t){const e=function(t,e,r){e.uniform3iv(t,r)}.bind(null,t);return e.location=t,e}},[t.BOOL_VEC4]:{TypedArray:Uint32Array,size:16,setter(t){const e=function(t,e,r){e.uniform4iv(t,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT2]:{TypedArray:Float32Array,size:16,setter(t){const e=function(t,e,r){e.uniformMatrix2fv(t,!1,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT3]:{TypedArray:Float32Array,size:36,setter(t){const e=function(t,e,r){e.uniformMatrix3fv(t,!1,r)}.bind(null,t);return e.location=t,e}},[t.FLOAT_MAT4]:{TypedArray:Float32Array,size:64,setter(t){const e=function(t,e,r){e.uniformMatrix4fv(t,!1,r)}.bind(null,t);return e.location=t,e}},[t.SAMPLER_2D]:{TypedArray:null,size:0,setter:r.bind(null,t.TEXTURE_2D)},[t.SAMPLER_CUBE]:{TypedArray:null,size:0,setter:r.bind(null,t.TEXTURE_CUBE)}},Ct[e]}function Ut(t,e,r,n,s=!1,o=0,i=0,a=t.ARRAY_BUFFER,l=t.STATIC_DRAW){const u=t.createBuffer(),c=jt(t,e);if(!c)throw new Error(`Unknown uniform type 0x${e.toString(16)}.`);if(r instanceof c.TypedArray)t.bindBuffer(a,u),t.bufferData(a,r,l);else if(Array.isArray(r))r=new c.TypedArray(r),t.bindBuffer(a,u),t.bufferData(a,r,l);else{if("number"!=typeof r)throw new Error("Unknown buffer data type - can only be a TypedArray, an Array, or a number.");t.bindBuffer(a,u),t.bufferData(a,r,l)}return{handle:u,size:n,type:e,normalize:s,stride:o,offset:i,updateData(t,r,n=0,s=t.STATIC_DRAW){t.bindBuffer(t.ARRAY_BUFFER,this.handle);const o=jt(t,e);r instanceof o.TypedArray||(r=new o.TypedArray(r)),n>0?t.bufferSubData(t.ARRAY_BUFFER,n,r):t.bufferData(t.ARRAY_BUFFER,r,s)}}}let Pt=null;function jt(t,e){return Pt||(Pt={[t.BYTE]:{TypedArray:Int8Array,size:1},[t.SHORT]:{TypedArray:Int16Array,size:2},[t.UNSIGNED_BYTE]:{TypedArray:Uint8Array,size:1},[t.UNSIGNED_SHORT]:{TypedArray:Uint16Array,size:2},[t.FLOAT]:{TypedArray:Float32Array,size:4}}),Pt[e]}var Vt=Object.freeze({__proto__:null,SceneGraph:class{constructor(){this.root=this.createSceneNode(lt(),null)}update(){this.root.updateWorldMatrix()}createSceneNode(t=lt(),r=this.root){const n={sceneGraph:this,transform:t,localMatrix:e.mat4.create(),worldMatrix:e.mat4.create(),parent:null,children:[],setParent(t){if(this.parent){const t=this.parent.children.indexOf(this);this.parent.children.splice(t,1)}return t&&t.children.push(this),this.parent=r,this},updateWorldMatrix(t){ut(this.transform,this.localMatrix),t?e.mat4.multiply(this.worldMatrix,t,this.localMatrix):e.mat4.copy(this.worldMatrix,this.localMatrix);for(const t of this.children)t.updateWorldMatrix(this.worldMatrix)}};return r&&n.setParent(r),n}},Transform:ct,Geometry:Nt,Geometry2D:St,createShaderProgramInfo:function(t,e,r,n=[]){const s=Ft(t,t.VERTEX_SHADER,e),o=Ft(t,t.FRAGMENT_SHADER,r),i=Ot(t,s,o,n);return t.detachShader(i,s),t.detachShader(i,o),t.deleteShader(s),t.deleteShader(o),{handle:i,_gl:t,uniforms:kt(t,i),attributes:Rt(t,i),uniform(t,e){return t in this.uniforms&&this.uniforms[t](this._gl,e),this},attribute(t,e){return t in this.attributes&&this.attributes[t](this._gl,e),this},elementAttribute(t){return this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t),this}}},createShader:Ft,createShaderProgram:Ot,createShaderProgramAttributeSetters:Rt,createShaderProgramAttributeSetter:Bt,createShaderProgramUniformSetters:kt,createShaderProgramUniformSetter:zt,getUniformTypeInfo:Lt,createBufferInfo:Ut,createElementBufferInfo:function(t,e,r,n=0,s=0,o=t.STATIC_DRAW){return Ut(t,e,r,1,!1,n,s,t.ELEMENT_ARRAY_BUFFER,o)},getBufferTypeInfo:jt,createVertexArrayInfo:function(t,e=[]){const r=t.createVertexArray(),n={};for(let t=0;t<e.length;++t)n[e[t]]={location:t,setter:Bt(t)};return{handle:r,attributes:n,_gl:t,elementBuffer:null,elementType:null,elementCount:0,attributeBuffers:{},setElementCount(t){return this.elementCount=t,this},elementAttribute(t){this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t.handle);const e=jt(this._gl,t.type);return this.elementCount=this._gl.getBufferParameter(this._gl.ELEMENT_ARRAY_BUFFER,this._gl.BUFFER_SIZE)/e.size,this.elementBuffer=t,this.elementType=t.type,this},sharedAttribute(t,e){return t in this.attributes&&this.attributes[t].setter(this._gl,e),this.attributeBuffers[t]=e,this},programAttribute(t,e,...r){for(const n of r)n.attribute(t,e);return this.attributeBuffers[t]=e,this}}},createTextureInfo:function(t){return{handle:t.createTexture()}},createDrawInfo:function(t,e,r,n=0,s=null){return{programInfo:t,vertexArrayInfo:e,uniforms:r,drawArrayOffset:n,drawMode:s}},draw:function(t,e,r={}){for(const n of e){const e=n.programInfo,s=n.vertexArrayInfo,o=n.uniforms,i=n.drawArrayOffset,a=n.drawMode||t.TRIANGLES;t.useProgram(e.handle),t.bindVertexArray(s.handle);for(const[t,n]of Object.entries(r))e.uniform(t,n);for(const[t,r]of Object.entries(o))e.uniform(t,r);s.elementBuffer?t.drawElements(a,s.elementCount,s.elementType,i*s.elementBuffer.size):t.drawArrays(a,i,s.elementCount)}}});class Dt{getViewMatrix(t){}getProjectionMatrix(t){}}class Gt extends Dt{constructor(t=-1,r=1,n=-1,s=1,o=0,i=1){super(),this.position=e.vec3.create(),this.rotation=e.quat.create(),this.scale=e.vec3.fromValues(1,1,1),this.clippingPlane={left:t,right:r,top:n,bottom:s,near:o,far:i}}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,r,n=0,s=1){let o=e.vec3.fromValues(t,r,n);return e.vec3.lerp(this.position,this.position,o,Math.max(Math.min(s,1),0)),this}getViewMatrix(t){let r=-Math.round(this.x),n=-Math.round(this.y),s=0===this.z?1:1/this.z,o=e.vec3.fromValues(r,n,0),i=e.vec3.fromValues(this.scale[0]*s,this.scale[1]*s,1);return e.mat4.fromRotationTranslationScale(t,this.rotation,o,i),t}getProjectionMatrix(t){let{left:r,right:n,top:s,bottom:o,near:i,far:a}=this.clippingPlane;return e.mat4.ortho(t,r,n,s,o,i,a),t}}function Wt(t,e){return t.a=e[0],t.b=e[1],t.c=e[4],t.d=e[5],t.e=e[12],t.f=e[13],t}var Yt=Object.freeze({__proto__:null,CanvasView2D:class{constructor(t,e=new Gt){this.display=t,this.camera=e,this.viewTransformDOMMatrix=new DOMMatrix}transformScreenToWorld(t,r){let n=e.mat4.create();this.getViewProjectionMatrix(n),e.mat4.invert(n,n);let s=e.vec3.fromValues(t,r,0);return e.vec3.transformMat4(s,s,n),s}transformCanvas(t){let r=this.viewTransformDOMMatrix,n=e.mat4.create();this.getViewProjectionMatrix(n),Wt(r,n);const{a:s,b:o,c:i,d:a,e:l,f:u}=r;t.transform(s,o,i,a,l,u)}getViewProjectionMatrix(t){const r=this.display.width,n=this.display.height;let s=e.mat4.create();const o=this.camera.getProjectionMatrix(s),i=this.camera.getViewMatrix(t);e.mat4.multiply(s,i,o);const a=e.mat4.fromTranslation(t,[r/2,n/2,0]);return e.mat4.multiply(t,a,s),t}},setDOMMatrix:Wt,Camera:Dt,Camera2D:Gt,Camera3D:class extends Dt{static screenToWorld(t,r,n,s){let o=e.mat4.multiply(e.mat4.create(),s,n);e.mat4.invert(o,o);let i=e.vec3.fromValues(t,r,0);return e.vec3.transformMat4(i,i,o),i}constructor(t,r,n=.1,s=1e3){super(),this.position=e.vec3.create(),this.rotation=e.quat.create(),this.fieldOfView=t,this.aspectRatio=r,this.clippingPlane={near:n,far:s},this._viewMatrix=e.mat4.create(),this._projectionMatrix=e.mat4.create()}get x(){return this.position[0]}set x(t){this.position[0]=t}get y(){return this.position[1]}set y(t){this.position[1]=t}get z(){return this.position[2]}set z(t){this.position[2]=t}moveTo(t,r,n,s=1){let o=e.vec3.fromValues(t,r,n);e.vec3.lerp(this.position,this.position,o,Math.min(1,s))}getViewMatrix(t=this._viewMatrix){let r=-this.x,n=-this.y,s=-this.z,o=e.vec3.fromValues(r,n,s);return e.mat4.fromRotationTranslation(t,this.rotation,o),t}getProjectionMatrix(t=this._projectionMatrix){let{near:r,far:n}=this.clippingPlane;return e.mat4.perspective(t,this.fieldOfView,this.aspectRatio,r,n),t}}});t.ApplicationLoop=C,t.AssetLoader=b,t.Audio=z,t.AxisAlignedBoundingBox=J,t.AxisAlignedBoundingBoxGraph=class{constructor(t={}){this.masks=new Map,this.boxes=new Set,this.dynamics=new Map,this.quadtree=new q}add(t,e,r={}){let n=function(t,e,r,n){return{owner:t,name:e,box:r,get:n}}(t,e,null,null);if(this.masks.has(t)){if(e in this.masks.get(t))throw new Error(`Mask ${e} already exists for owner.`);{let r=this.masks.get(t);r[e]=n,r[Q]++}}else this.masks.set(t,{[Q]:1,[e]:n});if(Array.isArray(r)){const t=r[0]||0,e=r[1]||0,s=r[2]/2||0,o=r[3]/2||0;let i=new J(this,n,t,e,s,o);this.boxes.add(i),n.box=i}else if("object"==typeof r){let e=r.x||0,s=r.y||0,o=r.rx||r.width/2||0,i=r.ry||r.height/2||0;"object"==typeof t&&(e||(e=t.x||0),s||(s=t.y||0),o||(o=t.width/2||0),i||(i=t.height/2||0));let a=new J(this,n,e,s,o,i);this.boxes.add(a),n.box=a,"get"in r&&(n.get=r.get,n.get(a,t),this.dynamics.set(n,{halfdx:0,halfdy:0}))}else{if("function"!=typeof r)throw new Error("Invalid mask option type.");{let e=new J(this,n,0,0,0,0);this.boxes.add(e),n.box=e,n.get=r,n.get(e,t),this.dynamics.set(n,{halfdx:0,halfdy:0})}}}remove(t,e){if(this.masks.has(t)){let r=this.masks.get(t),n=r[e];if(n){return n.get&&this.dynamics.delete(n),this.boxes.delete(n.box),r[e]=null,--r[Q]<=0&&this.masks.delete(t),!0}return!1}return!1}get(t,e){return this.masks.has(t)?this.masks.get(t)[e]:null}count(t){return this.masks.has(t)?this.masks.get(t)[Q]:0}clear(){this.boxes.clear(),this.masks.clear(),this.dynamics.clear(),this.quadtree.clear()}solve(t){for(let t of this.dynamics.keys()){let{box:e,owner:r}=t,n=e.x,s=e.y;t.get(e,r);let o=this.dynamics.get(t),i=(e.x-n)/2,a=(e.y-s)/2;o.halfMotionX=i,o.halfMotionY=a,e.x-=i,e.y-=a,e.rx+=Math.abs(i),e.ry+=Math.abs(a)}null==t&&(t=this.masks.keys());let e=[],r=this.quadtree;r.clear(),r.insertAll(this.boxes);for(let t of this.dynamics.keys()){const{box:e}=t,{halfMotionX:r,halfMotionY:n}=this.dynamics.get(t);e.x+=r,e.y+=n,e.rx-=Math.abs(r),e.ry-=Math.abs(n)}let n=[];for(let s of t){let t=Object.values(this.masks.get(s));for(let o of t){const{box:t}=o;r.retrieve(t,n);let i=0,a=0;if(this.dynamics.has(o)){const{halfMotionX:t,halfMotionY:e}=this.dynamics.get(o);i=2*t,a=2*e}for(let r of n){let n=H(t,r);n&&e.push({owner:s,other:r.mask.owner,ownerMask:o,otherMask:r.mask,hit:n,dx:i,dy:a})}n.length=0}}return e}},t.BoxRenderer=class{static get Info(){return D}static draw(t,e,r){const n=r?{...V,...r}:V;for(let r of e){const e=r[D],s=G("x",e,r,n),o=G("y",e,r,n),i=G("width",e,r,n),a=G("height",e,r,n),l=G("color",e,r,n),u=G("solid",e,r,n);t.translate(s,o);{const e=i/2,r=a/2;u?(t.fillStyle=l,t.fillRect(-e,-r,i,a)):(t.strokeStyle=l,t.strokeRect(-e,-r,i,a))}t.translate(-s,-o)}}},t.ByteLoader=a,t.EntityManager=class{constructor(t={}){const{componentFactoryMap:e={},strictMode:r=!1}=t;let n={},s={};for(let t in e){let r,o,i=e[t];try{r="create"in i?i.create:"function"==typeof i?i:null,o="destroy"in i?i.destroy:null}catch(t){throw new Error("Unsupported component factory options.")}n[t]={owner:i,create:r,destroy:o},s[t]={}}this.factoryMap=n,this.instances=s,this.entities=new Set,this.nextAvailableEntityId=1,this.strictMode=r}create(t){if(void 0!==t){if("string"!=typeof t)throw new Error("Invalid type for entity id - must be a string.")}else t=String(this.nextAvailableEntityId++);if(this.entities.has(t))throw new Error(`Invalid duplicate entity id '${t}' allocated for new entity.`);return this.entities.add(t),t}destroy(t){for(let e in this.instances)this.remove(e,t);this.entities.delete(t)}add(t,e,r){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);this.factoryMap[t]={owner:{},create:null,destroy:null},this.instances[t]={}}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);if(!this.entities.has(e))throw new Error(`Entity '${e}' does not exist.`);if(this.instances[t][e])throw new Error(`Entity already has component '${t}'.`);const{create:n}=this.factoryMap[t];let s=n?n(void 0!==r?r:Z,e,this):r?{...r}:{};s&&(this.instances[t][e]=s)}remove(t,e){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);return}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);let r=this.instances[t],n=r[e];if(n){r[e]=null;const{destroy:s}=this.factoryMap[t];s&&s(n,e,this)}}get(t,e){if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);return this.instances[t][e]||null}has(t,e){return t in this.instances&&Boolean(this.instances[t][e])}clear(t){if(!(t in this.factoryMap)){if(this.strictMode)throw new Error(`Missing component factory for '${t}'.`);return}if(!(t in this.instances))throw new Error(`Missing component instance mapping for '${t}'.`);let e=this.instances[t];const{destroy:r}=this.factoryMap[t];if(r)for(let n in e){let s=e[n];e[n]=null,r(s,t,n,this)}this.instances[t]={}}getEntityIds(){return this.entities}getComponentFactory(t){return t in this.factoryMap?this.factoryMap[t].owner:null}getComponentNames(){return Object.keys(this.factoryMap)}getComponentEntityIds(t){return t in this.instances?Object.keys(this.instances[t]):[]}getComponentInstances(t){return t in this.instances?Object.values(this.instances[t]):[]}},t.Game=j,t.ImageLoader=n,t.IntersectionHelper=E,t.IntersectionResolver=F,t.IntersectionWorld=O,t.JSONLoader=u,t.Mogli=Vt,t.OBJLoader=d,t.QuadTree=q,t.SceneGraph=class{constructor(t={}){this.nodeConstructor=t.nodeConstructor||nt,this.nodes=new Map,this.rootNodes=[]}add(t,e=null){if(null===t)throw new Error("Cannot add null as child to scene graph.");if(null===e||this.nodes.has(e)){let r=null===e?null:this.nodes.get(e);if(this.nodes.has(t)){let e=this.nodes.get(t);return tt(e.parentNode,e,this),K(r,e,this),e}{let e=new this.nodeConstructor(this,t,null,[]);return this.nodes.set(t,e),K(r,e,this),e}}throw new Error("No node in scene graph exists for parent.")}remove(t){if(null===t)return this.clear(),!0;if(this.nodes.has(t)){let e=this.nodes.get(t);return tt(e.parentNode,e,this),et(this,e,0,(t=>{this.nodes.delete(t)})),!0}return!1}replace(t,e){if(null===t)throw new Error("Cannot replace null for child in scene graph.");if(this.nodes.has(t)){let r=this.nodes.get(t),n=r.parentNode,s=[...r.childNodes];if(tt(n,r,this),r.childNodes.length=0,null===e)null===n?this.rootNodes.push(...s):n.childNodes.push(...s);else{let t;this.nodes.has(e)?(t=this.nodes.get(e),tt(t.parentNode,t,this),t.childNodes.push(...s)):(t=new this.nodeConstructor(this,e,null,s),this.nodes.set(e,t)),K(n,t,this)}for(let t of s)t.parentNode=n;return e}if(null===t)return this.replace(this.root.owner,e);throw new Error("Cannot find target object to replace in scene graph.")}clear(){this.nodes.clear(),this.rootNodes.length=0}get(t){return this.nodes.get(t)}walk(t,e,r={}){const{childrenOnly:n=!0,childrenCallback:s}=r;if(null===t){rt(this.nodes,this.rootNodes,null,s);for(let t of this.rootNodes)et(this,t,0,e,s)}else{const r=this.get(t);if(r)throw new Error("No node in scene graph exists for walk start.");if(n){rt(this.nodes,r.childNodes,r,s);for(let t of r.childNodes)et(this,t,0,e,s)}else et(this,r,0,e,s)}}},t.SceneNode=nt,t.SpriteRenderer=class{static get Info(){return Y}static draw(t,e,r){const n=r?{...W,...r}:W;for(let r of e){const e=r[Y],s=X("x",e,r,n),o=X("y",e,r,n),i=X("spriteImage",e,r,n);if(i){const e=i.width,r=i.height;t.translate(s,o);{const n=e/2,s=r/2;t.drawImage(i,-n,-s)}t.translate(-s,-o)}else{const e=10,r=10;t.translate(s,o);{const n=e/2,s=r/2;t.strokeStyle="black",t.strokeRect(-n,-s,e,r),t.textAlign="center",t.textBaseline="middle",t.strokeText("?",0,0,e)}t.translate(-s,-o)}}}},t.TextLoader=o,t.View=Yt,t.testAxisAlignedBoundingBox=function(t,e){return!(Math.abs(t.x-e.x)>t.rx+e.rx||Math.abs(t.y-e.y)>t.ry+e.ry)},Object.defineProperty(t,"__esModule",{value:!0})}));
