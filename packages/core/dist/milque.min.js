!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@milque/input")):"function"==typeof define&&define.amd?define(["exports","@milque/input"],e):e((t=t||self).Core={},t.Input)}(this,(function(t,e){"use strict";var n=Object.freeze({__proto__:null,get Display(){return j},get Audio(){return P},get Input(){return V},get Random(){return B},get Utils(){return M},get Game(){return q},get default(){return n},get RandomGenerator(){return r},get SimpleRandomGenerator(){return i},get Eventable(){return c},get View(){return d},get ViewHelper(){return f},get ViewPort(){return p},get AbstractCamera(){return m},get GameLoop(){return _},get SceneManager(){return x},get SceneBase(){return w}});class r{constructor(t){this._seed=t}get seed(){return this._seed}random(){return Math.random()}randomRange(t,e){return this.random()*(e-t)+t}randomChoose(t){return t[Math.floor(this.random()*t.length)]}randomSign(){return this.random()<.5?-1:1}}class i extends r{constructor(t=0){super(Math.abs(t%2147483647)),this._next=this.seed}random(){return this._next=Math.abs(16807*this._next%2147483647-1),this._next/2147483646}}const s={on(t,e,n=e){let r;if(this.__events.has(t)?r=this.__events.get(t):(r=new Map,this.__events.set(t,r)),r.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return r.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,(...r)=>{this.off(t,n),e.apply(this.__context||this,r)},n)},emit(t,...e){if(this.__events.has(t)){const n=Array.from(this.__events.get(t).values());for(const t of n)t.apply(this.__context||this,e)}else this.__events.set(t,new Map);return this}};function a(t){const e=Object.create(s);return e.__events=new Map,e.__context=t,e}function o(t,e){const n=Object.assign(t,s);return n.__events=new Map,n.__context=e,n}function u(t,e){const n=t.prototype;return Object.assign(n,s),n.__events=new Map,n.__context=e,n}var h={create:a,assign:o,mixin:u},c=Object.freeze({__proto__:null,create:a,assign:o,mixin:u,default:h});function l(t,e){let n=document.createElement("canvas");n.width=t,n.height=e,n.style="image-rendering: pixelated";let r=n.getContext("2d");return r.imageSmoothingEnabled=!1,{canvas:n,context:r}}var d=Object.freeze({__proto__:null,createView:function(t=640,e=480){let{canvas:n,context:r}=l(t,e);return{_canvas:n,_context:r,_width:t,_height:e,get canvas(){return this._canvas},get context(){return this._context},get width(){return this._width},set width(t){this._width=t,this._canvas.width=t},get height(){return this._height},set height(t){this._height=t,this._canvas.height=t}}},createViewBuffer:l,drawBufferToCanvas:function(t,e,n=0,r=0,i=t.canvas.clientWidth,s=t.canvas.clientHeight){t.drawImage(e,n,r,i,s)}});var f=Object.freeze({__proto__:null,setViewTransform:function(t,e){e?(t.context.setTransform(...e.getProjectionMatrix()),t.context.transform(...e.getViewMatrix())):t.context.setTransform(1,0,0,1,0,0)}});class p{constructor(t,e){this._canvas=t,this._context=e}getX(){return 0}getY(){return 0}getWidth(){return this._canvas.clientWidth}getHeight(){return this._canvas.clientHeight}getCanvas(){return this._canvas}getContext(){return this._context}}class m{getProjectionMatrix(){return[1,0,0,1,0,0]}getViewMatrix(){return[1,0,0,1,0,0]}}class _{constructor(t={}){this.prevFrameTime=0,this.animationFrameHandle=null,this.started=!1,this.paused=!1,this.deltaTimeFactor=.001,this.gameContext=t,this.run=this.run.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.pause=this.pause.bind(this),this.resume=this.resume.bind(this),this.__context=t}setDeltaTimeFactor(t){return this.deltaTimeFactor=t,this}run(t){this.animationFrameHandle=requestAnimationFrame(this.run);const e=(t-this.prevFrameTime)*this.deltaTimeFactor;this.prevFrameTime=t,"function"==typeof this.gameContext.update&&this.gameContext.update.call(this.gameContext,e),this.emit("update",e)}start(){if(this.started)throw new Error("Loop already started.");window.addEventListener("focus",this.resume),window.addEventListener("blur",this.pause),this.prevFrameTime=performance.now(),this.started=!0,"function"==typeof this.gameContext.start&&this.gameContext.start.call(this.gameContext),this.emit("start"),this.run(this.prevFrameTime)}stop(){if(!this.started)throw new Error("Loop not yet started.");window.removeEventListener("focus",this.resume),window.removeEventListener("blur",this.pause),cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null,this.started=!1,"function"==typeof this.gameContext.stop&&this.gameContext.stop.call(this.gameContext),this.emit("stop")}pause(){this.started&&!this.paused&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null,this.paused=!0,"function"==typeof this.gameContext.pause&&this.gameContext.pause.call(this.gameContext),this.emit("pause"))}resume(){this.started&&this.pause&&(this.prevFrameTime=performance.now(),this.paused=!1,"function"==typeof this.gameContext.resume&&this.gameContext.resume.call(this.gameContext),this.emit("resume"),this.run(this.prevFrameTime))}}u(_);const g={};class x{constructor(){this.registry=new Map,this.sharedContext={},this._scene=null,this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null}setSharedContext(t){return this.sharedContext=t,this}register(t,e){if("string"!=typeof t)throw new Error("Scene name must be a string.");return this.registry.set(t,e),this}unregister(t){return this.registry.delete(t),this}nextScene(t,e=null,n={}){if(this._nextScene)throw new Error("Cannot change scenes during a scene transition.");if("string"==typeof t){if(!this.registry.has(t))throw new Error(`Cannot find scene with name '${t}'.`);t=this.registry.get(t)}if("function"==typeof t)t=new t;else{if("object"!=typeof t)throw new Error("Scene type not supported.");Object.isExtensible(t)||(r=t,t={...r})}var r;this._nextScene=t,this._nextLoadOpts=n,this._nextTransition=e||g}update(t){if(this._transition)this._updateStep(t,this._transition);else if(this._nextScene){const t=this._nextScene,e=this._nextLoadOpts,n=this._nextTransition;this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null,this._transition=n;let r=Promise.resolve(),i=this._scene;i&&("onStop"in i&&i.onStop(this.sharedContext),"unload"in i&&(r=r.then(()=>i.unload(this.sharedContext)))),"load"in t&&(r=r.then(()=>t.load(this.sharedContext,e))),r=r.then(()=>{this._scene=t,this._transition=null,"onStart"in this._scene&&this._scene.onStart(this.sharedContext)})}else this._scene&&this._updateStep(t,this._scene)}_updateStep(t,e){"onPreUpdate"in e&&e.onPreUpdate(t),this.emit("preupdate",t),"onUpdate"in e&&e.onUpdate(t),this.emit("update",t),"onPostUpdate"in e&&e.onPostUpdate(t),this.emit("postupdate",t)}getCurrentScene(){return this._scene}getNextScene(){return this._nextScene}[Symbol.iterator](){return this.registry[Symbol.iterator]()}}u(x);class w{async load(t,e){}async unload(t){}onStart(t){}onStop(t){}onPreUpdate(t){}onUpdate(t){}onPostUpdate(t){}}function v(t,e,n){return t<e?e:t>n?n:t}function y(t){window.addEventListener("DOMContentLoaded",t)}function C(t,e,n){let r=n-e,i=(t-e)%r;return i<0&&(i+=r),i+e}var S,b,M=Object.freeze({__proto__:null,randomHexColor:function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},loadImage:function(t){let e=new Image;return e.src=t,e},clampRange:v,clearScreen:function(t,e,n){t.fillStyle="black",t.fillRect(0,0,e,n)},drawText:function(t,e,n,r,i=0,s=16,a="white"){t.translate(n,r),i&&t.rotate(i),t.textAlign="center",t.textBaseline="middle",t.font=`${s}px sans-serif`,t.fillStyle=a,t.fillText(e,0,0),i&&t.rotate(-i),t.translate(-n,-r)},drawBox:function(t,e,n,r=0,i=16,s=i,a="white",o=!1){t.translate(e,n),r&&t.rotate(r),o?(t.strokeStyle=a,t.strokeRect(-i/2,-s/2,i,s)):(t.fillStyle=a,t.fillRect(-i/2,-s/2,i,s)),r&&t.rotate(-r),t.translate(-e,-n)},intersectBox:function(t,e){return 2*Math.abs(t.x-e.x)<t.width+e.width&&2*Math.abs(t.y-e.y)<t.height+e.height},applyMotion:function(t,e=1,n=e){1!==e&&(t.dx*=e),1!==n&&(t.dy*=n),t.x+=t.dx,t.y+=t.dy},withinRadius:function(t,e,n){const r=t.x-e.x,i=t.y-e.y;return r*r+i*i<=n*n},onDOMLoaded:y,lerp:function(t,e,n){return t+(e-t)*n},distance2D:function(t,e){let n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},direction2D:function(t,e){let n=e.x-t.x,r=e.y-t.y;return Math.atan2(r,n)},lookAt2D:function(t,e,n){return v(t+C(e-t,-Math.PI,Math.PI),t-n,t+n)},cycleRange:C,drawCircle:function(t,e,n,r=16,i="white",s=!1){t.fillStyle=i,t.strokeStyle=i,t.beginPath(),t.arc(e,n,r,0,2*Math.PI),s?t.stroke():t.fill()},uuid:function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)}});function E(t,e,n=320,r=n){b=e,(S=t).width=n,S.height=r}function T(){return b}function O(){return S.clientWidth}function F(){return S.clientHeight}y(()=>{if(!S){let t=null,e=null,n=document.querySelector("display-port");n?(t=n.getCanvas(),e=n.getContext()):t=document.querySelector("canvas"),t&&(e||(e=t.getContext("2d")),E(t,e))}});var j=Object.freeze({__proto__:null,createCanvas:function(t=320,e=t,n=document.body){const r=document.createElement("canvas");n.appendChild(r),E(r,t,e)},attachCanvas:E,drawBufferToScreen:function(t,e=0,n=0,r=O(),i=F()){T().drawImage(t.canvas,e,n,r,i)},getCanvas:function(){return S},getDrawContext:T,getClientWidth:O,getClientHeight:F,getClientOffsetX:function(){return S.offsetLeft},getClientOffsetY:function(){return S.offsetTop}}),L=new AudioContext;var P=Object.freeze({__proto__:null,createSound:function(t,e=!1){const n={_playing:!1,_data:null,_source:null,play(){if(!this._data)return;this._source&&this.destroy();let t=L.createBufferSource();t.loop=e,t.buffer=this._data,t.addEventListener("ended",()=>{this._playing=!1}),t.connect(L.destination),t.start(0),this._source=t,this._playing=!0},pause(){this._source.stop(),this._playing=!1},destroy(){this._source&&this._source.disconnect(),this._source=null},isPaused(){return!this._playing}};return fetch(t).then(t=>t.arrayBuffer()).then(t=>L.decodeAudioData(t)).then(t=>n._data=t),n}}),R=e.InputSource.createSource(),I=e.InputContext.createContext().attach(R);function A(t){return R.element&&R.detach(),R.attach(t)}y(()=>{if(!R.element){let t=null,e=document.querySelector("display-port");t=e?e.getCanvas():document.querySelector("canvas"),t&&A(t)}});var H=1;function U(){return`__input#${H++}`}var V=Object.freeze({__proto__:null,attachCanvas:A,createContext:function(t=0,n=!0){return e.InputContext.createContext().setPriority(t).toggle(n).attach(R)},createInput:function(t){return I.registerInput(U(),t)},createAction:function(...t){return I.registerAction(U(),...t)},createRange:function(t){return I.registerRange(U(),t)},createState:function(t){return I.registerState(U(),t)},poll:function(){return R.poll()},handleEvent:function(t,e){return R.handleEvent(t,e)}});const z=new r;var B=Object.freeze({__proto__:null,createRandom:function(t=0){return new i(t)},random:function(){return z.random()},randomRange:function(t,e){return z.randomRange(t,e)},randomChoose:function(t){return z.randomChoose(t)},randomSign:function(){return z.randomSign()}});const D=new Map;var q=Object.freeze({__proto__:null,start:function(t){let e;if(D.has(t))throw new Error("Cannot start game loop with duplicate handle.");{let n;n="object"==typeof t?t:{},e=new _(n)}return D.set(t,e),setTimeout(()=>e.start(),0),e},stop:function(t){if(D.has(t)){let e=D.get(t);return e.stop(),D.delete(t),e}return null},createGameLoop:function(t={}){return new _(t)}});t.AbstractCamera=m,t.Audio=P,t.Display=j,t.Eventable=c,t.Game=q,t.GameLoop=_,t.Input=V,t.Random=B,t.RandomGenerator=r,t.SceneBase=w,t.SceneManager=x,t.SimpleRandomGenerator=i,t.Utils=M,t.View=d,t.ViewHelper=f,t.ViewPort=p,t.default=n,Object.defineProperty(t,"__esModule",{value:!0})}));
