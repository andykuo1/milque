!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Core={})}(this,(function(t){"use strict";class e{constructor(t){this._seed=t}get seed(){return this._seed}random(){return Math.random()}randomRange(t,e){return this.random()*(e-t)+t}randomChoose(t){return t[Math.floor(this.random()*t.length)]}randomSign(){return this.random()<.5?-1:1}}class n extends e{constructor(t=0){super(Math.abs(t%2147483647)),this._next=this.seed}random(){return this._next=Math.abs(16807*this._next%2147483647-1),this._next/2147483646}}const s={on(t,e,n=e){let s;if(this.__events.has(t)?s=this.__events.get(t):(s=new Map,this.__events.set(t,s)),s.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return s.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,(...s)=>{this.off(t,n),e.apply(this.__context||this,s)},n)},emit(t,...e){if(this.__events.has(t)){const n=Array.from(this.__events.get(t).values());for(const t of n)t.apply(this.__context||this,e)}else this.__events.set(t,new Map);return this}};function i(t){const e=Object.create(s);return e.__events=new Map,e.__context=t,e}function r(t,e){const n=Object.assign(t,s);return n.__events=new Map,n.__context=e,n}function a(t,e){const n=t.prototype;return Object.assign(n,s),n.__events=new Map,n.__context=e,n}var o={create:i,assign:r,mixin:a},h=Object.freeze({__proto__:null,create:i,assign:r,mixin:a,default:o});function c(t,e){let n=document.createElement("canvas");n.width=t,n.height=e,n.style="image-rendering: pixelated";let s=n.getContext("2d");return s.imageSmoothingEnabled=!1,{canvas:n,context:s}}var u=Object.freeze({__proto__:null,createView:function(t=640,e=480){let{canvas:n,context:s}=c(t,e);return{_canvas:n,_context:s,_width:t,_height:e,get canvas(){return this._canvas},get context(){return this._context},get width(){return this._width},set width(t){this._width=t,this._canvas.width=t},get height(){return this._height},set height(t){this._height=t,this._canvas.height=t}}},createViewBuffer:c,drawBufferToCanvas:function(t,e,n=0,s=0,i=t.canvas.clientWidth,r=t.canvas.clientHeight){t.drawImage(e,n,s,i,r)}});var d=Object.freeze({__proto__:null,setViewTransform:function(t,e){e?(t.context.setTransform(...e.getProjectionMatrix()),t.context.transform(...e.getViewMatrix())):t.context.setTransform(1,0,0,1,0,0)}});class l{constructor(t={}){this.prevFrameTime=0,this.animationFrameHandle=null,this.started=!1,this.paused=!1,this.deltaTimeFactor=.001,this.gameContext=t,this.run=this.run.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.pause=this.pause.bind(this),this.resume=this.resume.bind(this),this.__context=t}setDeltaTimeFactor(t){return this.deltaTimeFactor=t,this}run(t){this.animationFrameHandle=requestAnimationFrame(this.run);const e=(t-this.prevFrameTime)*this.deltaTimeFactor;this.prevFrameTime=t,"function"==typeof this.gameContext.update&&this.gameContext.update.call(this.gameContext,e),this.emit("update",e)}start(){if(this.started)throw new Error("Loop already started.");window.addEventListener("focus",this.resume),window.addEventListener("blur",this.pause),this.prevFrameTime=performance.now(),this.started=!0,"function"==typeof this.gameContext.start&&this.gameContext.start.call(this.gameContext),this.emit("start"),this.run(this.prevFrameTime)}stop(){if(!this.started)throw new Error("Loop not yet started.");window.removeEventListener("focus",this.resume),window.removeEventListener("blur",this.pause),cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null,this.started=!1,"function"==typeof this.gameContext.stop&&this.gameContext.stop.call(this.gameContext),this.emit("stop")}pause(){this.started&&!this.paused&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null,this.paused=!0,"function"==typeof this.gameContext.pause&&this.gameContext.pause.call(this.gameContext),this.emit("pause"))}resume(){this.started&&this.pause&&(this.prevFrameTime=performance.now(),this.paused=!1,"function"==typeof this.gameContext.resume&&this.gameContext.resume.call(this.gameContext),this.emit("resume"),this.run(this.prevFrameTime))}}a(l);const _={};class m{constructor(){this.registry=new Map,this.sharedContext={},this._scene=null,this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null}setSharedContext(t){return this.sharedContext=t,this}register(t,e){if("string"!=typeof t)throw new Error("Scene name must be a string.");return this.registry.set(t,e),this}unregister(t){return this.registry.delete(t),this}nextScene(t,e=null,n={}){if(this._nextScene)throw new Error("Cannot change scenes during a scene transition.");if("string"==typeof t){if(!this.registry.has(t))throw new Error(`Cannot find scene with name '${t}'.`);t=this.registry.get(t)}if("function"==typeof t)t=new t;else{if("object"!=typeof t)throw new Error("Scene type not supported.");Object.isExtensible(t)||(s=t,t={...s})}var s;this._nextScene=t,this._nextLoadOpts=n,this._nextTransition=e||_}update(t){if(this._transition)this._updateStep(t,this._transition);else if(this._nextScene){const t=this._nextScene,e=this._nextLoadOpts,n=this._nextTransition;this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null,this._transition=n;let s=Promise.resolve(),i=this._scene;i&&("onStop"in i&&i.onStop(this.sharedContext),"unload"in i&&(s=s.then(()=>i.unload(this.sharedContext)))),"load"in t&&(s=s.then(()=>t.load(this.sharedContext,e))),s=s.then(()=>{this._scene=t,this._transition=null,"onStart"in this._scene&&this._scene.onStart(this.sharedContext)})}else this._scene&&this._updateStep(t,this._scene)}_updateStep(t,e){"onPreUpdate"in e&&e.onPreUpdate(t),this.emit("preupdate",t),"onUpdate"in e&&e.onUpdate(t),this.emit("update",t),"onPostUpdate"in e&&e.onPostUpdate(t),this.emit("postupdate",t)}getCurrentScene(){return this._scene}getNextScene(){return this._nextScene}[Symbol.iterator](){return this.registry[Symbol.iterator]()}}a(m);var p=new AudioContext;var f=Object.freeze({__proto__:null,createSound:function(t,e=!1){const n={_playing:!1,_data:null,_source:null,play(){if(!this._data)return;this._source&&this.destroy();let t=p.createBufferSource();t.loop=e,t.buffer=this._data,t.addEventListener("ended",()=>{this._playing=!1}),t.connect(p.destination),t.start(0),this._source=t,this._playing=!0},pause(){this._source.stop(),this._playing=!1},destroy(){this._source&&this._source.disconnect(),this._source=null},isPaused(){return!this._playing}};return fetch(t).then(t=>t.arrayBuffer()).then(t=>p.decodeAudioData(t)).then(t=>n._data=t),n}});const g=new e;var x=Object.freeze({__proto__:null,createRandom:function(t=0){return new n(t)},random:function(){return g.random()},randomRange:function(t,e){return g.randomRange(t,e)},randomChoose:function(t){return g.randomChoose(t)},randomSign:function(){return g.randomSign()}});const w=new Map;var v=Object.freeze({__proto__:null,start:function(t){let e;if(w.has(t))throw new Error("Cannot start game loop with duplicate handle.");{let n;n="object"==typeof t?t:{},e=new l(n)}return w.set(t,e),setTimeout(()=>e.start(),0),e},stop:function(t){if(w.has(t)){let e=w.get(t);return e.stop(),w.delete(t),e}return null},createGameLoop:function(t={}){return new l(t)}});t.AbstractCamera=class{getProjectionMatrix(){return[1,0,0,1,0,0]}getViewMatrix(){return[1,0,0,1,0,0]}},t.Audio=f,t.Eventable=h,t.Game=v,t.GameLoop=l,t.Random=x,t.RandomGenerator=e,t.SceneBase=class{async load(t,e){}async unload(t){}onStart(t){}onStop(t){}onPreUpdate(t){}onUpdate(t){}onPostUpdate(t){}},t.SceneManager=m,t.SimpleRandomGenerator=n,t.View=u,t.ViewHelper=d,t.ViewPort=class{constructor(t,e){this._canvas=t,this._context=e}getX(){return 0}getY(){return 0}getWidth(){return this._canvas.clientWidth}getHeight(){return this._canvas.clientHeight}getCanvas(){return this._canvas}getContext(){return this._context}},Object.defineProperty(t,"__esModule",{value:!0})}));
