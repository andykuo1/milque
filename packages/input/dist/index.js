!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Input={})}(this,(function(e){"use strict";const t={NULL:0,KEY:1,POS:2,WHEEL:3},s={NULL:0,DOWN:1,UP:2,MOVE:3,parse(e){if("string"!=typeof e)return s.NULL;switch(e.toLowerCase()){case"down":return s.DOWN;case"up":return s.UP;case"move":return s.MOVE;default:return s.NULL}}},n="*";class i{constructor(e,t){this.deviceName=e,this.eventTarget=t,this.listeners={}}destroy(){this.listeners={}}addInputListener(e,t){let s=this.listeners[e];s?s.push(t):(s=[t],this.listeners[e]=s)}removeInputListener(e,t){let s=this.listeners[e];s&&(s.indexOf(t),s.splice(t,1))}dispatchInput(e){const{keyCode:t}=e,s=this.listeners[t];let n=!1;if(s){for(let t of s)n|=t(e);return n}for(let t of this.listeners["*"])n|=t(e);return n}}class o{static createAdapter(e,t,s,n,i,o){return{target:e,adapterId:t,deviceName:s,keyCode:n,scale:i,eventCode:o}}constructor(){this.adapters={"*":r()}}add(e){for(let t of e){const{deviceName:e,keyCode:s}=t;let n;e in this.adapters?n=this.adapters[e]:(n=r(),this.adapters[e]=n),s in n?n[s].push(t):n[s]=[t]}}delete(e){for(let t of e){const{deviceName:e,keyCode:s}=t;if(e in this.adapters){let n=this.adapters[e];if(s in n){let e=n[s],i=e.indexOf(t);i>=0&&e.splice(i,1)}}}}clear(){for(let e in this.adapters)this.adapters[e]=r()}poll(e,t,n){const i=this.findAdapters(e,t);for(let e of i){const t=e.eventCode;if(t===s.NULL){const{target:t,scale:s}=e,i=n.value*s;t.poll(i,e)}else{const{target:s,scale:i}=e,o=n.getEvent(t)*i;s.poll(o,e)}}return i.length>0}update(e,t,n){let i=!1;for(let o of this.findAdapters(e,t)){const e=o.eventCode;if(e!==s.NULL){const{target:t,scale:s}=o,r=n.getEvent(e)*s;t.update(r,o),i=!0}}return i}reset(e,t,s){let n=!1;for(let s of this.findAdapters(e,t))s.target.reset(),n=!0;return n}findAdapters(e,t){let s=[];if(e in this.adapters){let n=this.adapters[e];t in n&&s.push(...n[t]),s.push(...n["*"])}let n=this.adapters["*"];return t in n&&s.push(...n[t]),s.push(...n["*"]),s}}function r(){return{[n]:[]}}class a{constructor(){this.value=0}update(e){this.value=e}poll(){this.value=0}getEvent(e){return 0}getState(){return this.value}}const u=":";class h extends a{constructor(e){super(),this.update=this.update.bind(this),Array.isArray(e)||(e=[e]);let t=[],n=0;for(let i of e){"string"==typeof i&&(i={key:i});const{key:e,scale:r=1,event:a="null"}=i,{deviceName:u,keyCode:h}=l(e),d=s.parse(a),p=Number(r);let c=o.createAdapter(this,n,u,h,p,d);t.push(c),++n}this.adapters=t,this.values=new Array(t.length).fill(0),this.next={values:new Array(t.length).fill(0),value:0}}poll(e,t){const s=t.adapterId;let n=this.values[s];this.values[s]=e,this.value=this.value-n+e,this.next.values[s]=0,this.next.value+=e-n}update(e,t){const s=t.adapterId;let n=this.next.values[s];this.next.values[s]=e,this.next.value+=e-n}reset(){this.values.fill(0),this.value=0,this.next.values.fill(0),this.next.value=0}}function l(e){let t=e.indexOf(u);if(t>=0)return{deviceName:e.substring(0,t),keyCode:e.substring(t+1)};throw new Error("Invalid key string - missing device separator ':'.")}function d(e,t){return`${e}:${t}`}class p extends i{constructor(e,n={}){super("Keyboard",e);const{repeat:i=!1}=n;this.repeat=i,this._eventObject={target:e,deviceName:this.deviceName,keyCode:"",event:s.NULL,type:t.KEY,value:0,control:!1,shift:!1,alt:!1},this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),e.addEventListener("keydown",this.onKeyDown),e.addEventListener("keyup",this.onKeyUp)}destroy(){let e=this.eventTarget;e.removeEventListener("keydown",this.onKeyDown),e.removeEventListener("keyup",this.onKeyUp),super.destroy()}onKeyDown(e){if(e.repeat)return e.preventDefault(),e.stopPropagation(),!1;let t=this._eventObject;return t.keyCode=e.code,t.event=s.DOWN,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t)?(e.preventDefault(),e.stopPropagation(),!1):void 0}onKeyUp(e){let t=this._eventObject;if(t.keyCode=e.code,t.event=s.UP,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t))return e.preventDefault(),e.stopPropagation(),!1}}class c extends i{constructor(e,n={eventsOnFocus:!0}){super("Mouse",e),this.canvasTarget=e instanceof HTMLCanvasElement&&e||e.canvas||e.querySelector("canvas")||e.shadowRoot&&e.shadowRoot.querySelector("canvas")||e,this.eventsOnFocus=n.eventsOnFocus,this._downHasFocus=!1,this._eventObject={target:e,deviceName:this.deviceName,keyCode:"",event:s.NULL,type:t.KEY,value:0,control:!1,shift:!1,alt:!1},this._positionObject={target:e,deviceName:this.deviceName,keyCode:"Position",event:s.MOVE,type:t.POS,x:0,y:0,dx:0,dy:0},this._wheelObject={target:e,deviceName:this.deviceName,keyCode:"Wheel",event:s.MOVE,type:t.WHEEL,dx:0,dy:0,dz:0},this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onWheel=this.onWheel.bind(this),e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("contextmenu",this.onContextMenu),e.addEventListener("wheel",this.onWheel),e.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){let e=this.eventTarget;e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("contextmenu",this.onContextMenu),e.removeEventListener("wheel",this.onWheel),e.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),super.destroy()}setPointerLock(e=!0){e?this.eventTarget.requestPointerLock():this.eventTarget.exitPointerLock()}hasPointerLock(){return document.pointerLockElement===this.eventTarget}onMouseDown(e){this._downHasFocus=!0;let t=this._eventObject;if(t.keyCode="Button"+e.button,t.event=s.DOWN,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t)&&document.activeElement===this.eventTarget)return e.preventDefault(),e.stopPropagation(),!1}onContextMenu(e){return e.preventDefault(),e.stopPropagation(),!1}onWheel(e){let t=this._wheelObject;switch(e.deltaMode){case WheelEvent.DOM_DELTA_LINE:t.dx=10*e.deltaX,t.dy=10*e.deltaY,t.dz=10*e.deltaZ;break;case WheelEvent.DOM_DELTA_PAGE:t.dx=100*e.deltaX,t.dy=100*e.deltaY,t.dz=100*e.deltaZ;break;case WheelEvent.DOM_DELTA_PIXEL:default:t.dx=e.deltaX,t.dy=e.deltaY,t.dz=e.deltaZ}if(this.dispatchInput(t))return e.preventDefault(),e.stopPropagation(),!1}onMouseUp(e){if(!this._downHasFocus)return;this._downHasFocus=!1;let t=this._eventObject;return t.keyCode="Button"+e.button,t.event=s.UP,t.value=1,t.control=e.ctrlKey,t.shift=e.shiftKey,t.alt=e.altKey,this.dispatchInput(t)?(e.preventDefault(),e.stopPropagation(),!1):void 0}onMouseMove(e){if(this.eventsOnFocus&&document.activeElement!==this.eventTarget)return;const t=this.canvasTarget,{clientWidth:s,clientHeight:n}=t,i=t.getBoundingClientRect();let o=e.movementX/s,r=e.movementY/n,a=(e.clientX-i.left)/s,u=(e.clientY-i.top)/n,h=this._positionObject;h.x=a,h.y=u,h.dx=o,h.dy=r,this.dispatchInput(h)}}class v extends a{constructor(){super(),this.delta=0,this.next={delta:0}}update(e,t){this.value=e,this.next.delta+=t}poll(){this.delta=this.next.delta,this.next.delta=0}getEvent(e){switch(e){case s.MOVE:return this.delta;default:return super.getEvent(e)}}}class f extends a{constructor(){super(),this.down=!1,this.up=!1,this.next={down:!1,up:!1}}update(e){e?this.next.down=!0:this.next.up=!0}poll(){const{up:e,down:t}=this.next;this.value?this.up&&!e&&(this.value=0):t&&(this.value=1),this.down=t,this.up=e,this.next.down=!1,this.next.up=!1}getEvent(e){switch(e){case s.DOWN:return 1&this.down;case s.UP:return 1&this.up;default:return super.getEvent(e)}}}const y={NULL:0,UPDATE:1,POLL:2};function E(e,t){return"Mouse"===e&&("PosX"===t||"PosY"===t||"WheelX"===t||"WheelY"===t||"WheelZ"===t)}const g=Symbol("inputSource");class m{static for(e){if(Object.prototype.hasOwnProperty.call(e,g))return e[g];{let t=new m([new p(e),new c(e)]);return Object.defineProperty(e,g,{value:t}),t}}constructor(e){this.onInputEvent=this.onInputEvent.bind(this);let t={},s={};for(let i of e){const e=i.deviceName;t[e]=i,s[e]={},i.addInputListener(n,this.onInputEvent)}this.devices=t,this.inputs=s,this.listeners={poll:[],update:[]}}destroy(){this.clear();for(let e in this.devices){let t=this.devices[e];t.removeInputListener(n,this.onInputEvent),t.destroy()}}addEventListener(e,t){e in this.listeners?this.listeners[e].unshift(t):this.listeners[e]=[t]}removeEventListener(e,t){if(e in this.listeners){let s=this.listeners[e],n=s.indexOf(t);s.splice(n,1)}}dispatchEvent(e,t){for(let s of this.listeners[e])s(t)}_dispatchInputEvent(e,t,s,n){this.dispatchEvent("input",{stage:e,deviceName:t,keyCode:s,input:n})}_dispatchPollEvent(){this.dispatchEvent("poll",{})}poll(){for(const e in this.inputs){const t=this.inputs[e];for(const s in t){let n=t[s];n.poll(),this._dispatchInputEvent(y.POLL,e,s,n)}}this._dispatchPollEvent()}onInputEvent(e){const n=e.deviceName;switch(e.type){case t.KEY:{const t=e.keyCode;let i=this.inputs[n][t];i&&(i.update(e.event===s.DOWN),this._dispatchInputEvent(y.UPDATE,n,t,i))}break;case t.POS:{let t=this.inputs[n],s=t.PosX;s&&(s.update(e.x,e.dx),this._dispatchInputEvent(y.UPDATE,n,"PosX",s));let i=t.PosY;i&&(i.update(e.y,e.dy),this._dispatchInputEvent(y.UPDATE,n,"PosY",i))}break;case t.WHEEL:{let t=this.inputs[n],s=t.WheelX;s&&(s.update(e.dx,e.dx),this._dispatchInputEvent(y.UPDATE,n,"WheelX",s));let i=t.WheelY;i&&(i.update(e.dy,e.dy),this._dispatchInputEvent(y.UPDATE,n,"WheelY",i));let o=t.WheelZ;o&&(o.update(e.dz,e.dz),this._dispatchInputEvent(y.UPDATE,n,"WheelZ",o))}}}add(e,t){if(!(e in this.devices))throw new Error("Invalid device name - missing device with name in source.");let s=E(e,t)?new v:new f;return this.inputs[e][t]=s,this}delete(e,t){delete this.inputs[e][t]}get(e,t){return this.inputs[e][t]}has(e,t){return e in this.inputs&&t in this.inputs[e]}clear(){for(let e in this.devices)this.inputs[e]={}}}const L=Symbol("inputRefCounts");function I(e,t,s){const n=d(t,s);let i=e[L],o=i[n]+1||1;return i[n]=o,o}function b(e,t,s){const n=d(t,s);let i=e[L],o=i[n]-1||0;return i[n]=Math.max(o,0),o}e.AdapterManager=o,e.Axis=v,e.Button=f,e.Input=a,e.InputContext=class{constructor(e={}){const{disabled:t=!0}=e;this.source=null,this._disabled=t,this._ignoreInput=t,this.adapters=new o,this.inputs={},this.onSourceInput=this.onSourceInput.bind(this),this.onSourcePoll=this.onSourcePoll.bind(this)}get disabled(){return this._disabled}set disabled(e){this.toggle(!e)}setInputMap(e){return this._setupInputs(this.source,e),this}attach(e){return this._setupInputs(e,null),this.toggle(!0),this}detach(){return this.toggle(!1),this._setupInputs(null,null),this}_setupInputs(e,t){const s=this.disabled;this.disabled=!0;const n=this.source,i=this.inputs,o=n!==e&&n,r=this.inputs&&t;if(o||r){o&&(n.removeEventListener("poll",this.onSourcePoll),n.removeEventListener("input",this.onSourceInput));for(let e in i){let{adapters:t}=i[e];for(let e of t){const{deviceName:t,keyCode:s}=e;0===b(n,t,s)&&n.delete(t,s)}}r&&(this.adapters.clear(),this.inputs={})}if(t){let e={};for(let s in t){let n=t[s],i=new h(n),o=i.adapters;this.adapters.add(o),e[s]=i}this.inputs=e}if(e){!function(e){L in e||(e[L]={})}(e);const t=this.inputs;for(let s in t){let{adapters:n}=t[s];for(let t of n){const{deviceName:s,keyCode:n}=t;1===I(e,s,n)&&e.add(s,n)}}this.source!==e&&(e.addEventListener("poll",this.onSourcePoll),e.addEventListener("input",this.onSourceInput),this.source=e)}this.disabled=s}onSourceInput(e){if(e.consumed||this._ignoreInput){const{deviceName:t,keyCode:s,input:n}=e;this.adapters.reset(t,s,n)}else{const{stage:t,deviceName:s,keyCode:n,input:i}=e;switch(t){case y.POLL:this.adapters.poll(s,n,i);break;case y.UPDATE:this.adapters.update(s,n,i)}e.consumed=!0}}onSourcePoll(e){this._ignoreInput!==this.disabled&&(this._ignoreInput=this.disabled)}toggle(e=this._disabled){if(e){if(!this.source)throw new Error("Input source must be set before enabling input context.");Object.keys(this.inputs).length<=0&&console.warn("No inputs found for enabled input context - did you forget to setInputMap()?")}return this._disabled=!e,this}getInput(e){return this.inputs[e]}getInputValue(e){return e in this.inputs?this.inputs[e].value:0}},e.InputDevice=i,e.InputEventCode=s,e.InputSource=m,e.InputSourceStage=y,e.InputType=t,e.KEY_STRING_DEVICE_SEPARATOR=u,e.Keyboard=p,e.Mouse=c,e.Synthetic=h,e.WILDCARD_DEVICE_MATCHER="*",e.WILDCARD_KEY_MATCHER=n,e.isInputAxis=E,e.parseKeyString=l,e.stringifyDeviceKeyCodePair=d,Object.defineProperty(e,"__esModule",{value:!0})}));
