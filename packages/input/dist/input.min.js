!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Input={})}(this,(function(e){"use strict";const t=Symbol("any");class n{static parse(e){let s=e.indexOf("["),r=e.indexOf("]"),o=e.indexOf("."),i=null,u=null,h=null;return i=s<=0||0===o?t:e.substring(0,s),u=s<0||r<0||s+1===r?t:e.substring(s+1,r),h=o<0||e.trim().endsWith(".")?t:e.substring(o+1),new n(i,u,h)}constructor(e,t,n){this.source=e,this.code=t,this.mode=n,this.string=`${this.source.toString()}[${this.code.toString()}].${this.mode.toString()}`}matches(e){return!(this.source!==t&&e.source!==t&&this.source!==e.source||this.code!==t&&e.code!==t&&this.code!==e.code||this.mode!==t&&e.mode!==t&&this.mode!==e.mode)}toString(){return this.string}}n.ANY=t;class s{constructor(e){this.prev=e,this.value=e,this.next=e}update(e,t){return!1}consume(){return this.next}poll(){return this.prev=this.value,this.value=this.next,this.next=this.consume(),this}}class r extends s{constructor(e){super(!1),this.eventKeys=[];for(let t of e)this.eventKeys.push(n.parse(t))}consume(){return!1}update(e,t=!0){for(let n of this.eventKeys)if(n.matches(e))return this.next=t,!0;return!1}}class o extends s{constructor(e){super(0),this.eventKey=n.parse(e)}consume(){switch(this.eventKey.string){case"mouse[pos].dx":case"mouse[pos].dy":return 0;case"mouse[pos].x":case"mouse[pos].y":default:return this.next}}update(e,t=1){return!!this.eventKey.matches(e)&&(this.next=t,!0)}}class i extends s{constructor(e){super(0),this.eventKeyEntries=[];for(let t of Object.keys(e))this.eventKeyEntries.push({key:n.parse(t),value:e[t]})}update(e,t=!0){if(t)for(let t of this.eventKeyEntries)if(t.key.matches(e))return this.next=t.value,!0;return!1}}function u(){return{_source:null,_priority:0,_active:!0,inputs:new Map,get active(){return this._active},get source(){return this._source},get priority(){return this._priority},attach(e){return this._source=e,this._source.addContext(this),this},detach(){return this._source.removeContext(this),this._source=null,this},setPriority(e){if(e>100||e<-100)throw new Error("Context priority must be between [-100, 100].");return this._priority!==e&&(this._source?(this._source.removeContext(this),this._priority=e,this._source.addContext(this)):this._priority=e),this},registerInput(e,t){return this.inputs.set(e,t),t},registerAction(e,...t){return this.registerInput(e,new r(t))},registerRange(e,t){return this.registerInput(e,new o(t))},registerState(e,t){return this.registerInput(e,new i(t))},toggle(e){return void 0===e&&(e=!this._active),this._active=e,this},enable(){return this.toggle(!0)},disable(){return this.toggle(!1)},poll(){for(let e of this.inputs.values())e.poll()},update(e,t){let n;for(let s of this.inputs.values())n|=s.update(e,t);return n}}}var h=Object.freeze({__proto__:null,MIN_CONTEXT_PRIORITY:-100,MAX_CONTEXT_PRIORITY:100,createContext:u});class a{constructor(){this.sourceElement=null,this.eventHandler=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}attach(e=document){return this.sourceElement=e,this.sourceElement.addEventListener("mousedown",this.onMouseDown),this.sourceElement.addEventListener("mouseup",this.onMouseUp),this.sourceElement.addEventListener("contextmenu",this.onContextMenu),document.addEventListener("mousemove",this.onMouseMove),this}detach(){return this.sourceElement.removeEventListener("mousedown",this.onMouseDown),this.sourceElement.removeEventListener("mouseup",this.onMouseUp),this.sourceElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),this.sourceElement=null,this}setEventHandler(e){return this.eventHandler=e,this}onMouseDown(e){if(!this.eventHandler)return;let t;t=this.eventHandler.call(this,`mouse[${e.button}].down`,!0),t&&(e.preventDefault(),e.stopPropagation())}onMouseUp(e){this.eventHandler&&(e.preventDefault(),e.stopPropagation(),this.eventHandler.call(this,`mouse[${e.button}].up`,!0))}onMouseMove(e){if(!this.eventHandler)return;const t=this.sourceElement,n=t.clientWidth,s=t.clientHeight;this.eventHandler.call(this,"mouse[pos].x",(e.pageX-t.offsetLeft)/n),this.eventHandler.call(this,"mouse[pos].y",(e.pageY-t.offsetTop)/s),this.eventHandler.call(this,"mouse[pos].dx",e.movementX/n),this.eventHandler.call(this,"mouse[pos].dy",e.movementY/s)}onContextMenu(e){e.preventDefault(),e.stopPropagation()}}class c{constructor(){this.sourceElement=null,this.eventHandler=null,this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this)}attach(e=document){return this.sourceElement=e,this.sourceElement.addEventListener("keydown",this.onKeyDown),this.sourceElement.addEventListener("keyup",this.onKeyUp),this}detach(){return this.sourceElement.removeEventListener("keydown",this.onKeyDown),this.sourceElement.removeEventListener("keyup",this.onKeyUp),this.sourceElement=null,this}setEventHandler(e){return this.eventHandler=e,this}onKeyDown(e){if(!this.eventHandler)return;let t;t=e.repeat?this.eventHandler.call(this,`key[${e.key}].repeat`,!0):this.eventHandler.call(this,`key[${e.key}].down`,!0),t&&(e.preventDefault(),e.stopPropagation())}onKeyUp(e){if(!this.eventHandler)return;let t;t=this.eventHandler.call(this,`key[${e.key}].up`,!0),t&&(e.preventDefault(),e.stopPropagation())}}function l(){let e={_contexts:new Array(200),element:null,keyboard:new c,mouse:new a,attach(e){return this.element=e,this.keyboard.attach(),this.mouse.attach(e),this},detach(){return this.element=null,this.keyboard.detach(),this.mouse.detach(),this},addContext(e){const t=e.priority- -100;return this._contexts[t]||(this._contexts[t]=[]),this._contexts[t].push(e),this},removeContext(e){const t=e.priority- -100;let n=this._contexts[t];return n&&n.splice(n.indexOf(e),1),this},poll(){for(let e of this._contexts)if(e)for(let t of e)t.active&&t.poll()},handleEvent(e,t){const s=n.parse(e);for(let e of this._contexts)if(e)for(let n of e)if(n.active){let e;if(e=n.update(s,t),e)return!0}return!1}};return e.handleEvent=e.handleEvent.bind(e),e.keyboard.setEventHandler(e.handleEvent),e.mouse.setEventHandler(e.handleEvent),e}var d=Object.freeze({__proto__:null,createSource:l});var p=l(),v=u().attach(p);function m(e){return p.element&&p.detach(),p.attach(e)}window.addEventListener("DOMContentLoaded",()=>{if(!p.element){let e=null,t=document.querySelector("display-port");e=t?t.getCanvas():document.querySelector("canvas"),e&&m(e)}});var f=1;function y(){return`__input#${f++}`}var E=Object.freeze({__proto__:null,attachCanvas:m,createContext:function(e=0,t=!0){return u().setPriority(e).toggle(t).attach(p)},createInput:function(e){return v.registerInput(y(),e)},createAction:function(...e){return v.registerAction(y(),...e)},createRange:function(e){return v.registerRange(y(),e)},createState:function(e){return v.registerState(y(),e)},poll:function(){return p.poll()},handleEvent:function(e,t){return p.handleEvent(e,t)}});e.AbstractInputAdapter=s,e.ActionInputAdapter=r,e.DOUBLE_ACTION_TIME=300,e.DoubleActionInputAdapter=class extends r{constructor(e){super(e),this.actionTime=0}update(e,t=!0){let n=Date.now();for(let s of this.eventKeys)if(s.matches(e))return t?n-this.actionTime<=300?(this.actionTime=0,this.next=!0,!0):(this.actionTime=n,!1):(this.next=!1,!0);return!1}},e.EventKey=n,e.Input=E,e.InputContext=h,e.InputSource=d,e.Keyboard=c,e.Mouse=a,e.RangeInputAdapter=o,e.StateInputAdapter=i,Object.defineProperty(e,"__esModule",{value:!0})}));
