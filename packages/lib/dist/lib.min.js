!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@milque/input"),require("@milque/util"),require("@milque/entity"),require("@milque/display"),require("@milque/core")):"function"==typeof define&&define.amd?define(["exports","@milque/input","@milque/util","@milque/entity","@milque/display","@milque/core"],e):e((t=t||self).Lib={},t.input,t.util,t.entity,t.display,t.core)}(this,(function(t,e,r,i,n,s){"use strict";const o=e.Input.createContext().disable(),a=o.registerRange("x","mouse[pos].x"),l=o.registerRange("y","mouse[pos].y"),u=o.registerState("ldown",{"mouse[0].up":0,"mouse[0].down":1}),h=o.registerState("rdown",{"mouse[2].up":0,"mouse[2].down":1}),c=o.registerAction("click","mouse.up"),m=o.registerAction("lclick","mouse[0].up"),d=o.registerAction("rclick","mouse[2].up");var x=Object.freeze({__proto__:null,CONTEXT:o,POS_X:a,POS_Y:l,LEFT_DOWN:u,RIGHT_DOWN:h,CLICK:c,LEFT_CLICK:m,RIGHT_CLICK:d});const f=e.Input.createContext().disable(),p=f.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),g=f.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),w=f.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),y=f.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1});var T=Object.freeze({__proto__:null,CONTEXT:f,UP:p,DOWN:g,LEFT:w,RIGHT:y});const S=e.Input.createContext().disable(),k=S.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),_=S.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),M=S.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),O=S.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1}),v=S.registerState("zoomin",{"key[z].up":0,"key[z].down":1}),C=S.registerState("zoomout",{"key[x].up":0,"key[x].down":1}),R=S.registerState("rollleft",{"key[q].up":0,"key[q].down":1}),A=S.registerState("rollright",{"key[e].up":0,"key[e].down":1});var b,D=Object.freeze({__proto__:null,CONTEXT:S,UP:k,DOWN:_,LEFT:M,RIGHT:O,ZOOM_IN:v,ZOOM_OUT:C,ROLL_LEFT:R,ROLL_RIGHT:A,doCameraMove:function(t,e=6,r=.02,i=.01){const n=O.value-M.value,s=_.value-k.value,o=C.value-v.value;A.value,R.value;let a=o*r+1,l=t.transform.scaleX*a,u=t.transform.scaleY*a;t.transform.setScale(l,u);let h=n*e/l,c=s*e/u;t.transform.x+=h,t.transform.y+=c}});const L=s.View.createView();function P(t,e=null,r={}){b.nextScene(t,e,r)}function q(t){let o={loop:new s.GameLoop,scenes:new s.SceneManager,entities:new i.EntityManager,_renderTargets:new Map,addRenderTarget(t,e=null,r=null,i=null,n=t){return this._renderTargets.set(n,{view:t,renderer:e,viewPort:r,context:i}),this},removeRenderTarget(t){return this._renderTargets.delete(t),this},clearRenderTargets(){return this._renderTargets.clear(),this},nextScene(t,e=null,r={}){this.scenes.nextScene(t,e,r)},start(){return this.loop.start(),this},stop(){return this.loop.stop(),this},update(t){this.scenes.update(t),this.render()},render(){if(this._renderTargets.size<=0){let t=this.scenes.getCurrentScene();this._renderStep(L,t?t.onRender:null,null,t,!0)}else{let t=this.scenes.getCurrentScene(),e=!0;for(let r of this._renderTargets.values()){let i=r.view,n=r.renderer||(t?t.onRender:null),s=r.viewPort,o=r.context||t;this._renderStep(i,n,s,o,e),e=!1}}},_renderStep(t,e=null,i=null,o=null,a=!0){t.context.setTransform(1,0,0,1,0,0),a?r.Utils.clearScreen(t.context,t.width,t.height):t.context.clearRect(0,0,t.width,t.height),e&&e.call(o,t.context,t,this.scenes.getCurrentScene()),i?s.View.drawBufferToCanvas(i.getContext(),t.canvas,i.getX(),i.getY(),i.getWidth(),i.getHeight()):n.Display.getDrawContext()&&s.View.drawBufferToCanvas(n.Display.getDrawContext(),t.canvas)}};return o.loop.on("update",o.update.bind(o)),o.scenes.on("preupdate",()=>e.Input.poll()),o.scenes.setSharedContext(o),o.scenes.nextScene(t),o}var F=Object.freeze({__proto__:null,DEFAULT_VIEW:L,registerScene:function(t,e){b||(b=q(e)),b.scenes.register(t,e)},start:function(t){return b||(b=q(t)),b.start()},nextScene:P,stop:function(){b.stop()},getScene:function(){return b.scenes.getCurrentScene()},createGame:q});const I=e.Input.createContext(),z=I.registerAction("continue","key.down","mouse.down");class U{constructor(t=0,e=0){this.matrix=[1,0,0,1,t,e]}setMatrix(t,e,r,i,n,s){return this.matrix[0]=t,this.matrix[1]=e,this.matrix[2]=r,this.matrix[3]=i,this.matrix[4]=n,this.matrix[5]=s,this}setPosition(t,e){return this.matrix[4]=t,this.matrix[5]=e,this}setRotation(t){return this.rotation=t,this}setScale(t,e=t){let r=Math.sin(this.rotation);return this.matrix[0]=t,this.matrix[1]=r*e,this.matrix[2]=-r*t,this.matrix[3]=e,this}get x(){return this.matrix[4]}set x(t){this.matrix[4]=t}get y(){return this.matrix[5]}set y(t){this.matrix[5]=t}get rotation(){return Math.atan2(-this.matrix[2],this.matrix[0])}set rotation(t){let e=this.scaleX,r=this.scaleY;t=Math.abs(t),this.matrix[1]=Math.sin(t)*r,this.matrix[2]=-Math.sin(t)*e}get scaleX(){return this.matrix[0]}set scaleX(t){let e=this.rotation;this.matrix[0]=t,this.matrix[2]=-Math.sin(e)*t}get scaleY(){return this.matrix[3]}set scaleY(t){let e=this.rotation;this.matrix[1]=Math.sin(e)*t,this.matrix[3]=t}get a(){return this.matrix[0]}get b(){return this.matrix[1]}get c(){return this.matrix[2]}get d(){return this.matrix[3]}get e(){return this.matrix[4]}get f(){return this.matrix[5]}get 0(){return this.matrix[0]}set 0(t){this.matrix[0]=t}get 1(){return this.matrix[1]}set 1(t){this.matrix[1]=t}get 2(){return this.matrix[2]}set 2(t){this.matrix[2]=t}get 3(){return this.matrix[3]}set 3(t){this.matrix[3]=t}get 4(){return this.matrix[4]}set 4(t){this.matrix[4]=t}get 5(){return this.matrix[5]}set 5(t){this.matrix[5]=t}get 6(){return 0}get 7(){return 0}get 8(){return 1}get length(){return 9}}class E extends s.AbstractCamera{static applyTransform(t,e,r=0,i=0){e.setOffset(r,i),t.setTransform(...e.getProjectionMatrix()),t.transform(...e.getViewMatrix())}static resetTransform(t){t.setTransform(1,0,0,1,0,0)}static followTarget(t,e,i=1){e&&(t.transform.x=r.Utils.lerp(t.transform.x,e.x,i),t.transform.y=r.Utils.lerp(t.transform.y,e.y,i))}constructor(t=0,e=0,r=1){super(),this.target=null,this.speed=r,this.transform=new U,this.offsetX=t,this.offsetY=e}setOffset(t,e){return this.offsetX=t,this.offsetY=e,this}getProjectionMatrix(){return[this.transform.matrix[0],0,0,this.transform.matrix[3],this.offsetX,this.offsetY]}getViewMatrix(){let t=[...this.transform.matrix];return t[0]=Math.cos(this.transform.rotation),t[3]=t[0],t[4]=-t[4],t[5]=-t[5],t}}const G=new DOMPointReadOnly(0,0,0,1),X=new DOMPointReadOnly(32,32,0,1),j=1/Math.log(2);function W(t,e,r,i,n=32,s=n,o=1,a=!1){t.beginPath();for(let r=i%s;r<e.height;r+=s)t.moveTo(0,r),t.lineTo(e.width,r);for(let i=r%n;i<e.width;i+=n)t.moveTo(i,0),t.lineTo(i,e.height);if(t.strokeStyle="#333333",t.lineWidth=o,t.stroke(),t.lineWidth=1,a){const a=Math.min(n/4,16);t.textAlign="left",t.textBaseline="top",t.font=`bold ${a}px monospace`,t.fillStyle="#333333";for(let a=i%s;a<e.height;a+=s)for(let l=r%n;l<e.width;l+=n)t.fillText(`(${Math.round((l-r)/n)},${Math.round((a-i)/s)})`,l+2*o,a+2*o)}}function V(t,e,r,i,n=i){const s=.6*i;t.textAlign="center",t.textBaseline="middle",t.font=`${s}px monospace`,t.translate(e,r),t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.strokeStyle="#FF0000",t.stroke(),t.fillStyle="#FF0000",t.fillText("x",i+s,0),t.beginPath(),t.moveTo(0,0),t.lineTo(0,n),t.strokeStyle="#00FF00",t.stroke(),t.fillStyle="#00FF00",t.fillText("y",0,n+s);const o=s/4;t.fillStyle="#0000FF",t.fillRect(-o/2,-o/2,o,o),t.fillText("z",s/2,s/2),t.translate(-e,-r)}var Y=Object.freeze({__proto__:null,drawWorldGrid:function(t,e,r){const i=new DOMMatrixReadOnly(r.getViewMatrix()),n=new DOMMatrixReadOnly(r.getProjectionMatrix()).multiply(i),s=n.transformPoint(G),o=n.transformPoint(X),a=o.x-s.x,l=o.y-s.y,u=Math.floor((Math.log(e.width)-Math.log(a))*j);let h=Math.pow(2,u)*a,c=Math.pow(2,u)*l;0!==h&&0!==c&&(W(t,e,s.x,s.y,h,c,1,!1),W(t,e,s.x,s.y,h/2,c/2,.75,!1),W(t,e,s.x,s.y,h/4,c/4,.5,!1),W(t,e,s.x,s.y,h/8,c/8,.25,!1))},drawWorldTransformGizmo:function(t,e,r){const i=new DOMMatrixReadOnly(r.getViewMatrix()).transformPoint(G),n=e.width/32;t.fillStyle="#666666",t.textAlign="left",t.textBaseline="top",t.font=`${n}px monospace`,t.fillText(`(${-Math.floor(i.x)},${-Math.floor(i.y)})`,32,32),V(t,8,8,32,32)},drawGrid:W,drawTransformGizmo:V});var N=Object.freeze({__proto__:null,createSpawner:function(t){return{entities:new Set,factory:t,create(...t){return this.factory.apply(null,t)},destroy(t){this.entities.delete(t)},spawn(...t){let e=this.create(...t);return this.entities.add(e),e},clear(){this.entities.clear()},[Symbol.iterator](){return this.entities.values()}}}});t.Camera2D=E,t.Camera2DControls=D,t.CameraHelper=Y,t.EntitySpawner=N,t.Game=F,t.MouseControls=x,t.MoveControls=T,t.SplashScene=class{constructor(t,e){this.splashText=t,this.nextScene=e}async load(t){I.enable()}async unload(t){I.disable()}onStart(){this.time=0}onUpdate(t){this.time+=t,z.value&&this.time>75&&this.time<225&&(this.time=225),this.time>250&&P(this.nextScene)}onRender(t,e,i){let n=0;n=i.time<75?i.time/75:i.time>225?(250-i.time)/25:1,r.Utils.drawText(t,this.splashText,e.width/2,e.height/2,0,16,`rgba(255, 255, 255, ${n})`)}},t.Transform2D=U,Object.defineProperty(t,"__esModule",{value:!0})}));
