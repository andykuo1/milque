import{Input as t}from"@milque/input";import{EntityManager as e}from"@milque/entity";import{Display as r}from"@milque/display";import{GameLoop as n}from"@milque/game";import{Eventable as i}from"@milque/util";import{lerp as s}from"@milque/math";const o=t.createContext().disable(),a=o.registerRange("x","mouse[pos].x"),h=o.registerRange("y","mouse[pos].y"),l=o.registerState("ldown",{"mouse[0].up":0,"mouse[0].down":1}),c=o.registerState("rdown",{"mouse[2].up":0,"mouse[2].down":1}),u=o.registerAction("click","mouse.up"),d=o.registerAction("lclick","mouse[0].up"),x=o.registerAction("rclick","mouse[2].up");var m=Object.freeze({__proto__:null,CONTEXT:o,POS_X:a,POS_Y:h,LEFT_DOWN:l,RIGHT_DOWN:c,CLICK:u,LEFT_CLICK:d,RIGHT_CLICK:x});const g=t.createContext().disable(),f=g.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),p=g.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),w=g.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),_=g.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1});var y=Object.freeze({__proto__:null,CONTEXT:g,UP:f,DOWN:p,LEFT:w,RIGHT:_});const S=t.createContext().disable(),T=S.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),k=S.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),v=S.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),M=S.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1}),O=S.registerState("zoomin",{"key[z].up":0,"key[z].down":1}),C=S.registerState("zoomout",{"key[x].up":0,"key[x].down":1}),b=S.registerState("rollleft",{"key[q].up":0,"key[q].down":1}),R=S.registerState("rollright",{"key[e].up":0,"key[e].down":1});var P=Object.freeze({__proto__:null,CONTEXT:S,UP:T,DOWN:k,LEFT:v,RIGHT:M,ZOOM_IN:O,ZOOM_OUT:C,ROLL_LEFT:b,ROLL_RIGHT:R,doCameraMove:function(t,e=6,r=.02,n=.01){const i=M.value-v.value,s=k.value-T.value,o=C.value-O.value;R.value,b.value;let a=o*r+1,h=t.transform.scaleX*a,l=t.transform.scaleY*a;t.transform.setScale(h,l);let c=i*e/h,u=s*e/l;t.transform.x+=c,t.transform.y+=u}});const A={};class L{constructor(){this.registry=new Map,this.sharedContext={},this._scene=null,this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null}setSharedContext(t){return this.sharedContext=t,this}register(t,e){if("string"!=typeof t)throw new Error("Scene name must be a string.");return this.registry.set(t,e),this}unregister(t){return this.registry.delete(t),this}nextScene(t,e=null,r={}){if(this._nextScene)throw new Error("Cannot change scenes during a scene transition.");if("string"==typeof t){if(!this.registry.has(t))throw new Error(`Cannot find scene with name '${t}'.`);t=this.registry.get(t)}if("function"==typeof t)t=new t;else{if("object"!=typeof t)throw new Error("Scene type not supported.");Object.isExtensible(t)||(n=t,t={...n})}var n;this._nextScene=t,this._nextLoadOpts=r,this._nextTransition=e||A}update(t){if(this._transition)this._updateStep(t,this._transition);else if(this._nextScene){const t=this._nextScene,e=this._nextLoadOpts,r=this._nextTransition;this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null,this._transition=r;let n=Promise.resolve(),i=this._scene;i&&("onStop"in i&&i.onStop(this.sharedContext),"unload"in i&&(n=n.then(()=>i.unload(this.sharedContext)))),"load"in t&&(n=n.then(()=>t.load(this.sharedContext,e))),n=n.then(()=>{this._scene=t,this._transition=null,"onStart"in this._scene&&this._scene.onStart(this.sharedContext)})}else this._scene&&this._updateStep(t,this._scene)}_updateStep(t,e){"onPreUpdate"in e&&e.onPreUpdate(t),this.emit("preupdate",t),"onUpdate"in e&&e.onUpdate(t),this.emit("update",t),"onPostUpdate"in e&&e.onPostUpdate(t),this.emit("postupdate",t)}getCurrentScene(){return this._scene}getNextScene(){return this._nextScene}[Symbol.iterator](){return this.registry[Symbol.iterator]()}}i.mixin(L);class U{async load(t,e){}async unload(t){}onStart(t){}onStop(t){}onPreUpdate(t){}onUpdate(t){}onPostUpdate(t){}}function E(t=640,e=480){let{canvas:r,context:n}=z(t,e);return{_canvas:r,_context:n,_width:t,_height:e,get canvas(){return this._canvas},get context(){return this._context},get width(){return this._width},set width(t){this._width=t,this._canvas.width=t},get height(){return this._height},set height(t){this._height=t,this._canvas.height=t}}}function z(t,e){let r=document.createElement("canvas");r.width=t,r.height=e,r.style="image-rendering: pixelated";let n=r.getContext("2d");return n.imageSmoothingEnabled=!1,{canvas:r,context:n}}function D(t,e,r=0,n=0,i=t.canvas.clientWidth,s=t.canvas.clientHeight){t.drawImage(e,r,n,i,s)}var F=Object.freeze({__proto__:null,createView:E,createViewBuffer:z,drawBufferToCanvas:D});var j,W=Object.freeze({__proto__:null,setViewTransform:function(t,e){e?(t.context.setTransform(...e.getProjectionMatrix()),t.context.transform(...e.getViewMatrix())):t.context.setTransform(1,0,0,1,0,0)}});class X{constructor(t,e){this._canvas=t,this._context=e}getX(){return 0}getY(){return 0}getWidth(){return this._canvas.clientWidth}getHeight(){return this._canvas.clientHeight}getCanvas(){return this._canvas}getContext(){return this._context}}class I{getProjectionMatrix(){return[1,0,0,1,0,0]}getViewMatrix(){return[1,0,0,1,0,0]}}const G=E();function V(t,e=null,r={}){j.nextScene(t,e,r)}function Y(i){let s={loop:new n,scenes:new L,entities:new e,_renderTargets:new Map,addRenderTarget(t,e=null,r=null,n=null,i=t){return this._renderTargets.set(i,{view:t,renderer:e,viewPort:r,context:n}),this},removeRenderTarget(t){return this._renderTargets.delete(t),this},clearRenderTargets(){return this._renderTargets.clear(),this},nextScene(t,e=null,r={}){this.scenes.nextScene(t,e,r)},start(){return this.loop.start(),this},stop(){return this.loop.stop(),this},update(t){this.scenes.update(t),this.render()},render(){if(this._renderTargets.size<=0){let t=this.scenes.getCurrentScene();this._renderStep(G,t?t.onRender:null,null,t,!0)}else{let t=this.scenes.getCurrentScene(),e=!0;for(let r of this._renderTargets.values()){let n=r.view,i=r.renderer||(t?t.onRender:null),s=r.viewPort,o=r.context||t;this._renderStep(n,i,s,o,e),e=!1}}},_renderStep(t,e=null,n=null,i=null,s=!0){var o,a,h;t.context.setTransform(1,0,0,1,0,0),s?(o=t.context,a=t.width,h=t.height,o.fillStyle="black",o.fillRect(0,0,a,h)):t.context.clearRect(0,0,t.width,t.height),e&&e.call(i,t.context,t,this.scenes.getCurrentScene()),n?D(n.getContext(),t.canvas,n.getX(),n.getY(),n.getWidth(),n.getHeight()):r.getDrawContext()&&D(r.getDrawContext(),t.canvas)}};return s.loop.on("update",s.update.bind(s)),s.scenes.on("preupdate",()=>t.poll()),s.scenes.setSharedContext(s),s.scenes.nextScene(i),s}var $=Object.freeze({__proto__:null,DEFAULT_VIEW:G,registerScene:function(t,e){j||(j=Y(e)),j.scenes.register(t,e)},start:function(t){return j||(j=Y(t)),j.start()},nextScene:V,stop:function(){j.stop()},getScene:function(){return j.scenes.getCurrentScene()},createGame:Y});const H=t.createContext().disable(),N=H.registerAction("continue","key.down","mouse.down");class q{constructor(t,e){this.splashText=t,this.nextScene=e}async load(t){H.enable()}async unload(t){H.disable()}onStart(){this.time=0}onUpdate(t){this.time+=t,N.value&&this.time>75&&this.time<225&&(this.time=225),this.time>250&&V(this.nextScene)}onRender(t,e,r){let n=0;n=r.time<75?r.time/75:r.time>225?(250-r.time)/25:1,function(t,e,r,n,i=0,s=16,o="white"){t.translate(r,n),i&&t.rotate(i),t.textAlign="center",t.textBaseline="middle",t.font=`${s}px sans-serif`,t.fillStyle=o,t.fillText(e,0,0),i&&t.rotate(-i),t.translate(-r,-n)}(t,this.splashText,e.width/2,e.height/2,0,16,`rgba(255, 255, 255, ${n})`)}}class B{constructor(t=0,e=0){this.matrix=[1,0,0,1,t,e]}setMatrix(t,e,r,n,i,s){return this.matrix[0]=t,this.matrix[1]=e,this.matrix[2]=r,this.matrix[3]=n,this.matrix[4]=i,this.matrix[5]=s,this}setPosition(t,e){return this.matrix[4]=t,this.matrix[5]=e,this}setRotation(t){return this.rotation=t,this}setScale(t,e=t){let r=Math.sin(this.rotation);return this.matrix[0]=t,this.matrix[1]=r*e,this.matrix[2]=-r*t,this.matrix[3]=e,this}get x(){return this.matrix[4]}set x(t){this.matrix[4]=t}get y(){return this.matrix[5]}set y(t){this.matrix[5]=t}get rotation(){return Math.atan2(-this.matrix[2],this.matrix[0])}set rotation(t){let e=this.scaleX,r=this.scaleY;t=Math.abs(t),this.matrix[1]=Math.sin(t)*r,this.matrix[2]=-Math.sin(t)*e}get scaleX(){return this.matrix[0]}set scaleX(t){let e=this.rotation;this.matrix[0]=t,this.matrix[2]=-Math.sin(e)*t}get scaleY(){return this.matrix[3]}set scaleY(t){let e=this.rotation;this.matrix[1]=Math.sin(e)*t,this.matrix[3]=t}get a(){return this.matrix[0]}get b(){return this.matrix[1]}get c(){return this.matrix[2]}get d(){return this.matrix[3]}get e(){return this.matrix[4]}get f(){return this.matrix[5]}get 0(){return this.matrix[0]}set 0(t){this.matrix[0]=t}get 1(){return this.matrix[1]}set 1(t){this.matrix[1]=t}get 2(){return this.matrix[2]}set 2(t){this.matrix[2]=t}get 3(){return this.matrix[3]}set 3(t){this.matrix[3]=t}get 4(){return this.matrix[4]}set 4(t){this.matrix[4]=t}get 5(){return this.matrix[5]}set 5(t){this.matrix[5]=t}get 6(){return 0}get 7(){return 0}get 8(){return 1}get length(){return 9}}class K extends I{static applyTransform(t,e,r=0,n=0){e.setOffset(r,n),t.setTransform(...e.getProjectionMatrix()),t.transform(...e.getViewMatrix())}static resetTransform(t){t.setTransform(1,0,0,1,0,0)}static followTarget(t,e,r=1){e&&(t.transform.x=s(t.transform.x,e.x,r),t.transform.y=s(t.transform.y,e.y,r))}constructor(t=0,e=0,r=1){super(),this.target=null,this.speed=r,this.transform=new B,this.offsetX=t,this.offsetY=e}setOffset(t,e){return this.offsetX=t,this.offsetY=e,this}getProjectionMatrix(){return[this.transform.matrix[0],0,0,this.transform.matrix[3],this.offsetX,this.offsetY]}getViewMatrix(){let t=[...this.transform.matrix];return t[0]=Math.cos(this.transform.rotation),t[3]=t[0],t[4]=-t[4],t[5]=-t[5],t}}const Z=new DOMPointReadOnly(0,0,0,1),J=new DOMPointReadOnly(32,32,0,1),Q=1/Math.log(2);function tt(t,e,r,n,i=32,s=i,o=1,a=!1){t.beginPath();for(let r=n%s;r<e.height;r+=s)t.moveTo(0,r),t.lineTo(e.width,r);for(let n=r%i;n<e.width;n+=i)t.moveTo(n,0),t.lineTo(n,e.height);if(t.strokeStyle="#333333",t.lineWidth=o,t.stroke(),t.lineWidth=1,a){const a=Math.min(i/4,16);t.textAlign="left",t.textBaseline="top",t.font=`bold ${a}px monospace`,t.fillStyle="#333333";for(let a=n%s;a<e.height;a+=s)for(let h=r%i;h<e.width;h+=i)t.fillText(`(${Math.round((h-r)/i)},${Math.round((a-n)/s)})`,h+2*o,a+2*o)}}function et(t,e,r,n,i=n){const s=.6*n;t.textAlign="center",t.textBaseline="middle",t.font=`${s}px monospace`,t.translate(e,r),t.beginPath(),t.moveTo(0,0),t.lineTo(n,0),t.strokeStyle="#FF0000",t.stroke(),t.fillStyle="#FF0000",t.fillText("x",n+s,0),t.beginPath(),t.moveTo(0,0),t.lineTo(0,i),t.strokeStyle="#00FF00",t.stroke(),t.fillStyle="#00FF00",t.fillText("y",0,i+s);const o=s/4;t.fillStyle="#0000FF",t.fillRect(-o/2,-o/2,o,o),t.fillText("z",s/2,s/2),t.translate(-e,-r)}var rt=Object.freeze({__proto__:null,drawWorldGrid:function(t,e,r){const n=new DOMMatrixReadOnly(r.getViewMatrix()),i=new DOMMatrixReadOnly(r.getProjectionMatrix()).multiply(n),s=i.transformPoint(Z),o=i.transformPoint(J),a=o.x-s.x,h=o.y-s.y,l=Math.floor((Math.log(e.width)-Math.log(a))*Q);let c=Math.pow(2,l)*a,u=Math.pow(2,l)*h;0!==c&&0!==u&&(tt(t,e,s.x,s.y,c,u,1,!1),tt(t,e,s.x,s.y,c/2,u/2,.75,!1),tt(t,e,s.x,s.y,c/4,u/4,.5,!1),tt(t,e,s.x,s.y,c/8,u/8,.25,!1))},drawWorldTransformGizmo:function(t,e,r){const n=new DOMMatrixReadOnly(r.getViewMatrix()).transformPoint(Z),i=e.width/32;t.fillStyle="#666666",t.textAlign="left",t.textBaseline="top",t.font=`${i}px monospace`,t.fillText(`(${-Math.floor(n.x)},${-Math.floor(n.y)})`,32,32),et(t,8,8,32,32)},drawGrid:tt,drawTransformGizmo:et});var nt=Object.freeze({__proto__:null,createSpawner:function(t){return{entities:new Set,factory:t,create(...t){return this.factory.apply(null,t)},destroy(t){this.entities.delete(t)},spawn(...t){let e=this.create(...t);return this.entities.add(e),e},clear(){this.entities.clear()},[Symbol.iterator](){return this.entities.values()}}}});export{I as AbstractCamera,K as Camera2D,P as Camera2DControls,rt as CameraHelper,nt as EntitySpawner,$ as Game,m as MouseControls,y as MoveControls,U as SceneBase,L as SceneManager,q as SplashScene,B as Transform2D,F as View,W as ViewHelper,X as ViewPort};
