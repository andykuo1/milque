!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Milque={})}(this,function(t){"use strict";var e=new Map,n={id:null,canvas:null};function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(e.has(t)){var r=e.get(t);n.id=t,n.canvas=r}else i()}function i(){n.id=null,n.canvas=null}function a(){return n.canvas.width}function o(){return n.canvas.height}var s=Object.freeze({VIEW:n,attach:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i?(e.set(i,t),n.canvas||r(i)):(t||((t=document.createElement("canvas")).setAttribute("width",640),t.setAttribute("height",480),document.body.appendChild(t)),e.set(null,t),r(null))},detach:function(t){e.delete(t)},bind:r,unbind:i,width:a,height:o,clear:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#000000",e=n.canvas.getContext("2d");e.fillStyle=t,e.fillRect(0,0,a(),o())}});function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function h(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function l(t,e,n){return e&&h(t.prototype,e),n&&h(t,n),t}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function v(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_(t,e)}function f(t){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _(t,e){return(_=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function y(t,e,n){return(y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var i=new(Function.bind.apply(t,r));return n&&_(i,n.prototype),i}).apply(null,arguments)}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function p(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?d(t):e}function g(t,e,n){return(g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=f(t)););return t}(t,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(n):i.value}})(t,e,n||t)}function m(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{r||null==s.return||s.return()}finally{if(i)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function b(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function w(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(t){return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)})}var k=Object.freeze({uuid:w,lerp:function(t,e,n){return t*(1-n)+e*n},stringHash:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=0,n=0,r=t.length;n<r;n++)e=Math.imul(31,e)+t.charCodeAt(n)|0;return e},getDirectionalVector:function(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[0,0],s=n-t,u=r-e,h=Math.atan2(u,s)+a;return o[0]=Math.cos(h)*i,o[1]=Math.sin(h)*i,o},getMidPoint:function(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[0,0];return i[0]=t+(n-t)/2,i[1]=e+(r-e)/2,i},randomRange:function(t,e){return Math.random()*(e-t)+t},choose:function(t){return t[Math.floor(Math.random()*t.length)]},distanceSqu:function(t,e,n,r){var i=n-t,a=r-e;return i*i+a*a},distance:function(t,e,n,r){var i=n-t,a=r-e;return Math.sqrt(i*i+a*a)}}),x=function(){function t(){u(this,t),this.actions=new Set,this.states=new Set,this.ranges=new Map}return l(t,[{key:"clear",value:function(){this.actions.clear(),this.ranges.clear(),this.states.clear()}},{key:"setAction",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e?this.actions.add(t):this.actions.delete(t),this}},{key:"setState",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e?this.states.add(t):this.states.delete(t),this}},{key:"setRange",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return void 0===e?this.ranges.delete(t):this.ranges.set(t,e),this}},{key:"getAction",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!!this.actions.has(t)&&(e&&this.actions.delete(t),!0)}},{key:"getState",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!!this.states.has(t)&&(e&&this.states.delete(t),!0)}},{key:"getRange",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.ranges.has(t)){var n=this.ranges.get(t);return e&&this.ranges.delete(t),n}return 0}},{key:"hasAction",value:function(t){return this.actions.has(t)}},{key:"hasState",value:function(t){return this.states.has(t)}},{key:"hasRange",value:function(t){return this.ranges.has(t)}}]),t}(),M=function(){function t(){u(this,t),this.inputs=new Map}return l(t,[{key:"clear",value:function(){this.inputs.clear()}},{key:"register",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=t.eventKeys[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;this.inputs.has(o)?this.inputs.get(o).push(t):this.inputs.set(o,[t])}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}},{key:"unregister",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=t.eventKeys[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;if(this.inputs.has(o)){var s=this.inputs.get(o),u=s.indexOf(t);u>=0&&s.splice(u,1)}}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}},{key:"get",value:function(t){return this.inputs.has(t)?this.inputs.get(t):[]}},{key:"values",value:function(){return this.inputs.values()}}],[{key:"toEventKey",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return t+"["+e+"]"+(n?":"+n:"")}},{key:"fromEventKey",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=t.indexOf("[");if(n>=0){var r=t.substring(0,n).trim();e.push(r);var i=t.indexOf("]",n+1);if(!(i>=0))throw new Error("Invalid format - missing closing bracket for key.");var a=t.substring(n+1,i).trim();e.push(a);var o=t.indexOf(":",i+1);if(o>=0){var s=t.substring(o+1).trim();e.push(s)}}else e.push(t.trim());return e}}]),t}(),A=function(){function t(e){u(this,t),this.name=e,this.disabled=!1,this.mapping=new M}return l(t,[{key:"enable",value:function(){return this.disabled=!0,this}},{key:"disable",value:function(){return this.disabled=!0,this}}]),t}(),E=function(){function t(e){u(this,t),this.name=e;for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];this.eventKeys=r}return l(t,[{key:"update",value:function(t,e,n,r){return r}}]),t}(),P=function(t){function e(t){var n;u(this,e);for(var r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return p(this,(n=f(e)).call.apply(n,[this,t].concat(i)))}return v(e,E),l(e,[{key:"update",value:function(t,e,n,r){return"boolean"!=typeof r&&(r=Boolean(r)),r}}]),e}(),I=function(t){function e(t,n,r){var i;return u(this,e),(i=p(this,f(e).call(this,t,n,r))).active=!1,i}return v(e,E),l(e,[{key:"update",value:function(t,e,n,r){"boolean"!=typeof r&&(r=Boolean(r));var i=M.toEventKey(t.name,e,n);if(i===this.eventKeys[0])this.active=r;else{if(i!==this.eventKeys[1])return null;this.active=!r}return this.active}}]),e}(),O=function(t){function e(t,n,r,i){var a,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(u(this,e),a=p(this,f(e).call(this,t,n)),"number"!=typeof i||"number"!=typeof r||"number"!=typeof s||"number"!=typeof o)throw new Error("Range bounds for input not specified");if(i<r||s<o)throw new Error("Max range must be greater than min range");if(i===r||s===o)throw new Error("Range of input cannot be zero");return a.fromMin=r,a.fromMax=i,a.fromNormal=i-r,a.toMin=o,a.toMax=s,a.toNormal=s-o,a}return v(e,E),l(e,[{key:"update",value:function(t,e,n,r){return"number"!=typeof r&&(r=r?1:0),this.normalize(r)}},{key:"normalize",value:function(t){return(t-this.fromMin)/this.fromNormal*this.toNormal+this.toMin}}]),e}(),C=function(){function t(){u(this,t),this.devices={},this.contexts=new Map,this.currentState=new x,this.contexts.set("default",new A("default")),this.onInputEvent=this.onInputEvent.bind(this)}return l(t,[{key:"addDevice",value:function(t){this.devices[t.name]=t,t.addInputListener(this.onInputEvent)}},{key:"removeDevice",value:function(t){t.removeInputListener(this.onInputEvent),delete this.devices[t.name]}},{key:"getDevice",value:function(t){return this.devices[t.name]}},{key:"clearDevices",value:function(){for(var t=0,e=Object.keys(this.devices);t<e.length;t++){var n=e[t];this.devices[n].removeInputListener(this.onInputEvent),delete this.devices[n]}}},{key:"getDevices",value:function(){return Object.values(this.devices)}},{key:"poll",value:function(){this.propagateActiveStateInputs()}},{key:"propagateActiveStateInputs",value:function(){var t=this.currentState,e=!0,n=!1,r=void 0;try{for(var i,a=this.contexts.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;if(!o.disabled){var s=!0,u=!1,h=void 0;try{for(var l,c=o.mapping.values()[Symbol.iterator]();!(s=(l=c.next()).done);s=!0){var v=l.value,f=!0,_=!1,y=void 0;try{for(var d,p=v[Symbol.iterator]();!(f=(d=p.next()).done);f=!0){var g=d.value;if(g instanceof I&&g.active){t.setState(g.name,!0);break}}}catch(t){_=!0,y=t}finally{try{f||null==p.return||p.return()}finally{if(_)throw y}}}}catch(t){u=!0,h=t}finally{try{s||null==c.return||c.return()}finally{if(u)throw h}}}}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}},{key:"onInputEvent",value:function(t,e,n){for(var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=this.currentState,a=M.toEventKey(t.name,e,n),o=arguments.length,s=new Array(o>4?o-4:0),u=4;u<o;u++)s[u-4]=arguments[u];var h=!0,l=!1,c=void 0;try{for(var v,f=this.contexts.values()[Symbol.iterator]();!(h=(v=f.next()).done);h=!0){var _=v.value;if(!_.disabled){var y=!0,d=!1,p=void 0;try{for(var g,m=_.mapping.get(a)[Symbol.iterator]();!(y=(g=m.next()).done);y=!0){var b=g.value,w=b.update.apply(b,[t,e,n,r].concat(s));if(null!==w){if(b instanceof P)i.setAction(b.name,w);else if(b instanceof I)i.setState(b.name,w);else{if(!(b instanceof O))throw new Error("Unknown input class.");i.setRange(b.name,w)}break}}}catch(t){d=!0,p=t}finally{try{y||null==m.return||m.return()}finally{if(d)throw p}}}}}catch(t){l=!0,c=t}finally{try{h||null==f.return||f.return()}finally{if(l)throw c}}}},{key:"registerContext",value:function(t){var e=new A(t);return this.contexts.set(t,e),this}},{key:"unregisterContext",value:function(t){return this.contexts.delete(t),this}},{key:"getContext",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";return this.contexts.get(t)}}]),t}(),D=function(){function t(e){u(this,t),this.name=e,this.inputListeners=[],this.listeners=new Map}return l(t,[{key:"delete",value:function(){this.inputListeners.length=0,this.listeners.clear()}},{key:"addInputListener",value:function(t){this.inputListeners.push(t)}},{key:"removeInputListener",value:function(t){this.inputListeners.splice(this.inputListeners.indexOf(t),1)}},{key:"dispatchInput",value:function(t,e,n){for(var r=arguments.length,i=new Array(r>3?r-3:0),a=3;a<r;a++)i[a-3]=arguments[a];var o=!0,s=!1,u=void 0;try{for(var h,l=this.inputListeners[Symbol.iterator]();!(o=(h=l.next()).done);o=!0){var c=h.value;c.call.apply(c,[null,this,t,e,n].concat(i))}}catch(t){s=!0,u=t}finally{try{o||null==l.return||l.return()}finally{if(s)throw u}}}}]),t}(),S=function(t){function e(t){var n;return u(this,e),(n=p(this,f(e).call(this,"key"))).element=t,n.onKeyDown=n.onKeyDown.bind(d(n)),n.onKeyUp=n.onKeyUp.bind(d(n)),document.addEventListener("keydown",n.onKeyDown),document.addEventListener("keyup",n.onKeyUp),n}return v(e,D),l(e,[{key:"delete",value:function(){document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),g(f(e.prototype),"delete",this).call(this)}},{key:"onKeyDown",value:function(t){t.repeat||this.dispatchInput(t.key,"down",!0)}},{key:"onKeyUp",value:function(t){this.dispatchInput(t.key,"up",!0)}}]),e}(),B=function(t){function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return u(this,e),(n=p(this,f(e).call(this,"mouse"))).element=t,n.allowCursorLock=r,n.onMouseMove=n.onMouseMove.bind(d(n)),n.onMouseDown=n.onMouseDown.bind(d(n)),n.onMouseUp=n.onMouseUp.bind(d(n)),n._down=!1,t.addEventListener("mousedown",n.onMouseDown,!1),document.addEventListener("mousemove",n.onMouseMove,!1),n.onMouseClick=n.onMouseClick.bind(d(n)),t.addEventListener("click",n.onMouseClick,!1),n}return v(e,D),l(e,[{key:"delete",value:function(){this.hasPointerLock()&&document.exitPointerLock(),this.element.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),this.element.removeEventListener("click",this.onMouseClick),g(f(e.prototype),"delete",this).call(this)}},{key:"onMouseClick",value:function(t){this.allowCursorLock&&this.element.requestPointerLock()}},{key:"onMouseMove",value:function(t){if(!this.allowCursorLock||this.hasPointerLock())if(this.dispatchInput("move","x",t.movementX),this.dispatchInput("move","y",t.movementY),this.element instanceof Element){var e=this.element.getBoundingClientRect();this.dispatchInput("pos","x",t.clientX-e.left),this.dispatchInput("pos","y",t.clientY-e.top)}else this.dispatchInput("pos","x",t.pageX),this.dispatchInput("pos","y",t.pageY)}},{key:"onMouseDown",value:function(t){this.allowCursorLock&&!this.hasPointerLock()||(this._down&&document.removeEventListener("mouseup",this.onMouseUp),this._down=!0,document.addEventListener("mouseup",this.onMouseUp,!1),this.dispatchInput(t.button,"down",!0,t.clientX,t.clientY))}},{key:"onMouseUp",value:function(t){this.allowCursorLock&&!this.hasPointerLock()||(document.removeEventListener("mouseup",this.onMouseUp),this._down=!1,this.dispatchInput(t.button,"up",!0,t.clientX,t.clientY))}},{key:"hasPointerLock",value:function(){return document.pointerLockElement===this.element}}]),e}(),L=new C,T=new S(window),j=new B(window,!1);L.addDevice(T),L.addDevice(j);var R=Object.freeze({INPUT_MANAGER:L,KEYBOARD:T,MOUSE:j,Action:function(){for(var t={name:arguments.length>0&&void 0!==arguments[0]?arguments[0]:w(),input:null,attach:function(){if(this.input)throw new Error("Already attached input to source.");for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.input=y(P,[this.name].concat(e)),L.getContext().mapping.register(this.input),this},get:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.input){var e=L.currentState;if(e.hasAction(this.input.name))return e.getAction(this.input.name,t)}return!1}},e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return n.length>0&&t.attach.apply(t,n),t},State:function(){for(var t={name:arguments.length>0&&void 0!==arguments[0]?arguments[0]:w(),inputs:null,attach:function(){if(this.inputs)throw new Error("Already attached input to source.");this.inputs=[];for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=0,i=e;r<i.length;r++){var a=i[r],o=void 0,s=void 0;if(Array.isArray(a))o=a[0],s=a[1];else{var u=M.fromEventKey(a),h=m(u,2),l=h[0],c=h[1];o=M.toEventKey(l,c,"down"),s=M.toEventKey(l,c,"up")}var v=new I(this.name,o,s);L.getContext().mapping.register(v),this.inputs.push(v)}return this},get:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=L.currentState;return!!e.hasState(this.inputs[0].name)&&e.getState(this.inputs[0].name,t)}},e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return n.length>0&&t.attach.apply(t,n),t},Range:function(){for(var t={name:arguments.length>0&&void 0!==arguments[0]?arguments[0]:w(),input:null,attach:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:n;if(this.input)throw new Error("Already attached input to source.");return this.input=new O(this.name,t,e,n,r,i),L.getContext().mapping.register(this.input),this},get:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=L.currentState;return e.hasRange(this.input.name)?e.getRange(this.input.name,t):0}},e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return n.length>0&&t.attach.apply(t,n),t}}),F=function(){function t(){u(this,t)}return l(t,[{key:"create",value:function(){return this}},{key:"change",value:function(){return this}},{key:"destroy",value:function(){return!1}}]),t}(),U=function(t){function e(){var t;return u(this,e),(t=p(this,f(e).call(this))).entityManager=null,t.entityID=-1,t}return v(e,F),l(e,[{key:"create",value:function(t,e){this.entityManager=t,this.entityID=e;for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return this.onCreate.apply(this,r),this}},{key:"change",value:function(){return this.onChange.apply(this,arguments),this}},{key:"destroy",value:function(){var t=this.onDestroy();return this.entityManager.destroy(this.entityID,this.constructor),this.entityID=-1,t}},{key:"component",value:function(t){for(var e,n=this,r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];this.entityManager.has(this.entityID,t)?(e=this.entityManager).update.apply(e,[this.entityID,t].concat(i)):function(){for(var e,r=(e=n.entityManager).assign.apply(e,[n.entityID,t].concat(i)),a=function(){var t=s[o],e=Object.getOwnPropertyDescriptor(n,t);e&&e.value&&(r[t]=value),Object.defineProperty(n,t,{get:function(){return r[t]},set:function(e){r[t]=e},enumerable:!0})},o=0,s=Object.keys(r);o<s.length;o++)a()}();return this}},{key:"tag",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e?this.entityManager.assign(this.entityID,t):this.entityManager.remove(this.entityID,t),this}},{key:"remove",value:function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++)for(var o=a[i],s=this.entityManager.get(this.entityID,o),u=0,h=Object.keys(s);u<h.length;u++){var l=h[u];delete this[l]}return(t=this.entityManager).remove.apply(t,[this.entityID].concat(n)),this}},{key:"has",value:function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=this.entityManager).has.apply(t,[this.entityID].concat(n))}},{key:"get",value:function(t){for(var e,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(e=this.entityManager).get.apply(e,[this.entityID,t].concat(r))}},{key:"onCreate",value:function(){}},{key:"onChange",value:function(){}},{key:"onDestroy",value:function(){return!1}}]),e}(),K=function(){function t(e,n){u(this,t),this.entityManager=e,this.filter=n}return l(t,[{key:"subview",value:function(e){var n=this;return new t(this.entityManager,function(t){return n.filter(t)&&e(t)})}},{key:Symbol.iterator,value:function(){return{filter:this.filter,iterator:this.entityManager._entities[Symbol.iterator](),next:function(){for(var t;!(t=this.iterator.next()).done;){var e=t.value;if(this.filter(e))return{value:e,done:!1}}return{done:!0}}}}}]),t}(),N=function(){function t(e){u(this,t),this.components=new Map,this.factory=e}return l(t,null,[{key:"getComponentName",value:function(t){return"string"==typeof t?t:t.name}}]),l(t,[{key:"add",value:function(t){for(var e,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var a=(e=this.factory).create.apply(e,r);return this.components.set(t,a),a}},{key:"change",value:function(t){for(var e,n=this.components.get(t),r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return(e=this.factory).change.apply(e,[n].concat(i)),n}},{key:"remove",value:function(t){var e=this.components.get(t);this.factory.destroy(e),this.components.delete(t)}},{key:"get",value:function(t){return this.components.get(t)}},{key:"has",value:function(t){return this.components.has(t)}},{key:"clear",value:function(){this.components.clear()}}]),t}(),q=function(){function t(){u(this,t)}return l(t,[{key:"create",value:function(){return{}}},{key:"change",value:function(t){}},{key:"destroy",value:function(t){}}]),t}(),z=function(t){function e(t){var n;return u(this,e),(n=p(this,f(e).call(this))).tagName=t,n}return v(e,q),l(e,[{key:"create",value:function(){return null}}]),e}(),V=function(t){function e(t){var n;return u(this,e),(n=p(this,f(e).call(this))).componentHandler=t,n}return v(e,q),l(e,[{key:"create",value:function(){return this.componentHandler.apply(this,arguments)}},{key:"change",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i=this.componentHandler.apply(this,n),a=0,o=Object.keys(i);a<o.length;a++){var s=o[a];t[s]=i[s]}}},{key:"destroy",value:function(t){}}]),e}(),Y=function(t){function e(t){var n;return u(this,e),(n=p(this,f(e).call(this)))._cache=[],n.componentClass=t,n}return v(e,q),l(e,[{key:"create",value:function(){var t,e;if(this._cache.length>0)e=this._cache.shift();else{var n=this.componentClass;e=new n}return(t=e).create.apply(t,arguments),e}},{key:"change",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];t.change.apply(t,n)}},{key:"destroy",value:function(t){var e=t.destroy();e&&this._cache.push(e)}}]),e}(),H=new(function(){function t(){u(this,t),this._entities=new Set,this._componentManagers=new Map,this._nextEntityID=1}return l(t,[{key:"registerComponent",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)if("string"==typeof t)e=new z(t);else if(t.prototype instanceof F)e=new Y(t);else{if("function"!=typeof t)throw new Error("Cannot find factory for component type.");e=new V(t)}var n=new N(e);return this._componentManagers.set(t,n),n}},{key:"unregisterComponent",value:function(t){this._componentManagers.delete(t)}},{key:"create",value:function(){var t=this._nextEntityID++;this._entities.add(t);for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i];this.assign(t,o)}return t}},{key:"destroy",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!0,r=!1,i=void 0;try{for(var a,o=this._componentManagers.keys()[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value;if(s!==e){var u=this._componentManagers.get(s);u.has(t)&&u.remove(t)}}}catch(t){r=!0,i=t}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}this._entities.delete(t)}},{key:"entities",value:function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new K(this,function(e){return t.has.apply(t,[e].concat(n))})}},{key:"has",value:function(t){if(!this._entities.has(t))return!1;for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i];if(!this._componentManagers.has(o))return!1;if(!this._componentManagers.get(o).has(t))return!1}return!0}},{key:"get",value:function(t,e){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(r.length>0){var a=[];a.push(this._componentManagers.get(e).get(t));for(var o=0,s=r;o<s.length;o++){var u=s[o];a.push(this._componentManagers.get(u).get(t))}return a}return this._componentManagers.get(e).get(t)}},{key:"assign",value:function(t,e){var n,r;if("number"!=typeof t)throw new Error("Invalid entity handle - must be a number.");r=this._componentManagers.has(e)?this._componentManagers.get(e):this.registerComponent(e);for(var i=arguments.length,a=new Array(i>2?i-2:0),o=2;o<i;o++)a[o-2]=arguments[o];return(n=r).add.apply(n,[t].concat(a))}},{key:"change",value:function(t,e){if("number"!=typeof t)throw new Error("Invalid entity handle - must be a number.");for(var n=this._componentManagers.get(e),r=arguments.length,i=new Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];return n.change.apply(n,[t].concat(i))}},{key:"remove",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i];if(this._componentManagers.has(o)){var s=this._componentManagers.get(o);s.has(t)&&s.remove(t)}}}},{key:"clear",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e.length>0)for(var r=0,i=e;r<i.length;r++){var a=i[r];if(this._componentManagers.has(a)){var o=this._componentManagers.get(a);o.clear()}}else this._componentManagers.clear(),this._entities.clear()}}]),t}());var G=Object.freeze({ENTITY_MANAGER:H,ComponentBase:F,EntityBase:U,spawn:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:U,e=H.create(),n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return H.assign.apply(H,[e,t,H,e].concat(r))},entities:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return c({view:new K(H,function(t){return H.has.apply(H,[t,U].concat(e))})},Symbol.iterator,function(){return{iterator:this.view[Symbol.iterator](),next:function(){var t=this.iterator.next();return t.done?{done:!0}:{value:H.get(t.value,U),done:!1}}}})},components:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return c({view:new K(H,function(t){return H.has.apply(H,[t].concat(e))})},Symbol.iterator,function(){return{iterator:this.view[Symbol.iterator](),next:function(){var t=this.iterator.next();return t.done?{done:!0}:{value:H.get.apply(H,[t.value].concat(e)),done:!1}}}})}}),X=function(){function t(){u(this,t),this.tweens=new Map,this.cachedTweens=new Set,this.useCache=!1}return l(t,[{key:"add",value:function(t){this.useCache?this.cachedTweens.add(t):this.tweens.set(t.id,t)}},{key:"remove",value:function(t){this.cachedTweens.has(t)?this.cachedTweens.delete(t):this.tweens.delete(t.id)}},{key:"clear",value:function(){this.tweens.clear(),this.cachedTweens.clear()}},{key:"update",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];do{var n=!0,r=!1,i=void 0;try{for(var a,o=this.cachedTweens.values()[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value;this.add(s)}}catch(t){r=!0,i=t}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}this.cachedTweens.clear(),this.useCache=!0;var u=!0,h=!1,l=void 0;try{for(var c,v=this.tweens.keys()[Symbol.iterator]();!(u=(c=v.next()).done);u=!0){var f=c.value,_=this.tweens.get(f);_.update(t)||e||this.tweens.delete(f)}}catch(t){h=!0,l=t}finally{try{u||null==v.return||v.return()}finally{if(h)throw l}}this.useCache=!1}while(this.cachedTweens.size>0)}}]),t}(),W={on:function(t,e){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;if(this.__events.has(t)?n=this.__events.get(t):(n=new Map,this.__events.set(t,n)),n.has(r))throw new Error("Found callback for event '".concat(t,"' with the same handle '").concat(r,"'."));return n.set(r,e),this},off:function(t,e){if(!this.__events.has(t))throw new Error("Unable to find event '".concat(t,"'."));var n=this.__events.get(t);if(!n.has(e))throw new Error("Unable to find callback for event '".concat(t,"' with handle '").concat(e,"'."));return n.delete(e),this},once:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,i=function(){n.off(t,r),e.apply(void 0,arguments)};return this.on(t,i,r)},emit:function(t){if(this.__events.has(t)){for(var e=Array.from(this.__events.get(t).values()),n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];for(var a=0,o=e;a<o.length;a++){var s=o[a];s.apply(void 0,r)}}else this.__events.set(t,new Map);return this}},Q={create:function(){var t=Object.create(W);return t.__events=new Map,t},assign:function(t){var e=Object.assign(t,W);return e.__events=new Map,e},mixin:function(t){var e=t.prototype;Object.assign(e,W),e.__events=new Map}};function J(t){switch(t){case"linear":return Z.Both;case"quadratic":case"quadratic-both":case"quadratic-in-out":return $.Both;case"quadratic-in":return $.In;case"quadratic-out":return $.Out;case"cubic":case"cubic-both":case"cubic-in-out":return tt.Both;case"cubic-in":return tt.In;case"cubic-out":return tt.Out;case"sinusoidal":case"sinusoidal-both":case"sinusoidal-in-out":return et.Both;case"sinusoidal-in":return et.In;case"sinusoidal-out":return et.Out;case"exponential":case"exponential-both":case"exponential-in-out":return nt.Both;case"exponential-in":return nt.In;case"exponential-out":return nt.Out;case"circular":case"circular-both":case"circular-in-out":return rt.Both;case"circular-in":return rt.In;case"circular-out":return rt.Out;case"elastic":case"elastic-both":case"elastic-in-out":return it.Both;case"elastic-in":return it.In;case"elastic-out":return it.Out;case"back":case"back-both":case"back-in-out":return at.Both;case"back-in":return at.In;case"back-out":return at.Out;case"bounce":case"bounce-both":case"bounce-in-out":return ot.Both;case"bounce-in":return ot.In;case"bounce-out":return ot.Out;default:throw new Error("Unknown easing function name '".concat(t,"'."))}}var Z={Both:function(t){return t}},$={In:function(t){return t*t},Out:function(t){return t*(2-t)},Both:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},tt={In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},Both:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},et={In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},Both:function(t){return.5*(1-Math.cos(Math.PI*t))}},nt={In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},Both:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}},rt={In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},Both:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},it={In:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},Out:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},Both:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1}},at={In:function(t){var e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},Both:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}},ot={In:function(t){return 1-ot.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},Both:function(t){return t<.5?.5*ot.In(2*t):.5*ot.Out(2*t-1)+.5}},st=Object.freeze({getFunctionByName:J,Linear:Z,Quadratic:$,Cubic:tt,Sinusoidal:et,Exponential:nt,Circular:rt,Elastic:it,Back:at,Bounce:ot});function ut(t){switch(t){case"linear":return ht;case"bezier":return lt;case"catmullrom":return ct;default:throw new Error("Unknown interpolation function name '".concat(t,"'."))}}function ht(t,e){var n=t.length-1,r=n*e,i=Math.floor(r),a=vt;return e<0?a(t[0],t[1],r):e>1?a(t[n],t[n-1],n-r):a(t[i],t[i+1>n?n:i+1],r-i)}function lt(t,e){for(var n=0,r=t.length-1,i=Math.pow,a=ft,o=0;o<=r;o++)n+=i(1-e,r-o)*i(e,o)*t[o]*a(r,o);return n}function ct(t,e){var n=t.length-1,r=n*e,i=Math.floor(r),a=dt;return t[0]===t[n]?(e<0&&(i=Math.floor((function(t){throw new Error('"'+t+'" is read-only')}("f"),r=n*(1+e)))),a(t[(i-1+n)%n],t[i],t[(i+1)%n],t[(i+2)%n],r-i)):e<0?t[0]-(a(t[0],t[0],t[1],t[1],-r)-t[0]):e>1?t[n]-(a(t[n],t[n],t[n-1],t[n-1],r-n)-t[n]):a(t[i?i-1:0],t[i],t[n<i+1?n:i+1],t[n<i+2?n:i+2],r-i)}function vt(t,e,n){return(e-t)*n+t}function ft(t,e){var n=yt;return n(t)/n(e)/n(t-e)}var _t=[1];function yt(t){if(_t[t])return _t[t];for(var e=1,n=t;n>1;n--)e*=n;return _t[t]=e,e}function dt(t,e,n,r,i){var a=.5*(n-t),o=.5*(r-e),s=i*i;return(2*e-2*n+a+o)*(i*s)+(-3*e+3*n-2*a-o)*s+a*i+e}var pt=Object.freeze({getFunctionByName:ut,Linear:ht,Bezier:lt,CatmullRom:ct}),gt=1,mt=function(){function t(e){u(this,t),this.target=e,this.id=gt++,this.active=!1,this.startTime=0,this.startProperties={},this.repeatProperties={},this.reversed=!1,this.endProperties={},this.nexts=[],this.easingFunction=Z.Both,this.interpolationFunction=ht,this._duration=1e3,this._startDelay=0,this._repeatDelay=0,this._repeat=0,this._yoyo=!1,this.firstUpdate=!1}return l(t,null,[{key:"now",value:function(){return Date.now()}}]),l(t,[{key:"to",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this.endProperties=Object.create(t),void 0!==e&&(this._duration=e),this}},{key:"next",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.nexts=e,this}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;for(var n in this.startTime=void 0===e?t.now():e,this.startTime+=this._startDelay,this.endProperties){if(!(n in this.target))throw new Error("Cannot tween non-existent property.");var r=this.target[n];if("number"!=typeof r)throw new Error("Cannot tween non-number property.");var i=this.endProperties[n];if(Array.isArray(i))this.endProperties[n]=[r].concat(b(i));else if("function"!=typeof i&&"number"!=typeof i)throw new Error("Unable to tween unknown end property type.");this.startProperties[n]=r,this.repeatProperties[n]=this.startProperties[n]}return this.active=!0,this.firstUpdate=!0,this}},{key:"stop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active)return this;if(this.active=!1,t)this.update(1/0);else{var e=!0,n=!1,r=void 0;try{for(var i,a=this.nexts[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;o.stop()}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}return this}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.now();if(e<this.startTime)return!0;this.firstUpdate&&(this.firstUpdate=!1,this.emit("start",this.target));var n=this._duration>0?Math.min((e-this.startTime)/this._duration,1):1,r=this.easingFunction(n);for(var i in this.endProperties)if(i in this.startProperties){var a=this.startProperties[i],o=this.endProperties[i];this.target[i]=this.getTweenValue(a,o,r)}if(this.emit("update",this.target,n),n>=1){if(this._repeat>0){for(var s in Number.isFinite(this._repeat)&&--this._repeat,this.repeatProperties){if(this._yoyo){var u=this.repeatProperties[s];if(this.repeatProperties[s]=this.endProperties[s],this.endProperties[s]=u,"function"==typeof this.repeatProperties[s]){this.startProperties[s]=this.repeatProperties[s].call(null,this.endProperties[s]);continue}}else"function"==typeof this.endProperties[s]&&(this.repeatProperties[s]+=this.endProperties[s].call(null,this.repeatProperties[s]));this.startProperties[s]=this.repeatProperties[s]}return this._yoyo&&(this.reversed=!this.reversed),this._repeatDelay?this.startTime=e+this._repeatDelay:this.startTime=e+this._startDelay,this.emit("repeat",this.target),!0}this.active=!1,this.emit("complete",this.target);var h=!0,l=!1,c=void 0;try{for(var v,f=this.nexts[Symbol.iterator]();!(h=(v=f.next()).done);h=!0){var _=v.value;_.start(this.startTime+this._duration)}}catch(t){l=!0,c=t}finally{try{h||null==f.return||f.return()}finally{if(l)throw c}}return!1}return!0}},{key:"getTweenValue",value:function(t,e,n){var r;if("number"==typeof(r=Array.isArray(e)?this.interpolationFunction(e,n):"function"==typeof e?e.call(null,t):e))return t+(r-t)*n;throw new Error("Unable to tween unknown end property type.")}},{key:"ease",value:function(t){return this.easingFunction="string"==typeof t?J(t):t,this}},{key:"interpolate",value:function(t){return this.interpolationFunction="string"==typeof t?ut(t):t,this}},{key:"repeat",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this._repeat=t,void 0!==e&&(this._repeatDelay=e),this}},{key:"delay",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this._startDelay=t,void 0===e&&(this._repeatDelay=e),this}},{key:"yoyo",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._yoyo=t,this._repeat<=0&&(this._repeat=1),this}},{key:"setDuration",value:function(t){return this._duration=t,this}},{key:"setRepeatDelay",value:function(t){return this._repeatDelay=t,this}}]),t}();Q.mixin(mt);var bt=new X;var wt=Object.freeze({TWEEN_MANAGER:bt,Easing:st,Interpolation:pt,create:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,i=new mt(t).to(e,r).delay(n);return bt.add(i),i}});var kt=Object.freeze({randomColor:function(){for(var t="#",e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}}),xt=[],Mt=function(){function t(){u(this,t),this._bvh_parent=null,this._bvh_branch=!0,this._bvh_left=null,this._bvh_right=null,this._bvh_sort=0,this._bvh_min_x=0,this._bvh_min_y=0,this._bvh_max_x=0,this._bvh_max_y=0}return l(t,null,[{key:"getBranch",value:function(){return xt.length?xt.pop():new t}},{key:"releaseBranch",value:function(t){xt.push(t)}},{key:"sortBranches",value:function(t,e){return t.sort>e.sort?-1:1}}]),t}(),At=function(){function t(){u(this,t),this._hierarchy=null,this._bodies=[],this._dirty_branches=[]}return l(t,[{key:"insert",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e){var n=t._bvh;if(n&&n!==this)throw new Error("Body belongs to another collision system");t._bvh=this,this._bodies.push(t)}var r=t._polygon,i=t.x,a=t.y;r&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords();var o=t._bvh_padding,s=r?0:t.radius*t.scale,u=(r?t._min_x:i-s)-o,h=(r?t._min_y:a-s)-o,l=(r?t._max_x:i+s)+o,c=(r?t._max_y:a+s)+o;t._bvh_min_x=u,t._bvh_min_y=h,t._bvh_max_x=l,t._bvh_max_y=c;var v=this._hierarchy,f=0;if(v)for(;;){if(!v._bvh_branch){var _=v._bvh_parent,y=v._bvh_min_x,d=v._bvh_min_y,p=v._bvh_max_x,g=v._bvh_max_y,m=v._bvh_parent=t._bvh_parent=Mt.getBranch();m._bvh_parent=_,m._bvh_left=v,m._bvh_right=t,m._bvh_sort=f++,m._bvh_min_x=u<y?u:y,m._bvh_min_y=h<d?h:d,m._bvh_max_x=l>p?l:p,m._bvh_max_y=c>g?c:g,_?_._bvh_left===v?_._bvh_left=m:_._bvh_right=m:this._hierarchy=m;break}var b=v._bvh_left,w=b._bvh_min_y,k=b._bvh_max_x,x=b._bvh_max_y,M=u<b._bvh_min_x?u:b._bvh_min_x,A=h<w?h:w,E=l>k?l:k,P=c>x?c:x,I=(k-b._bvh_min_x)*(x-w),O=(E-M)*(P-A),C=O-I,D=v._bvh_right,S=D._bvh_min_x,B=D._bvh_min_y,L=D._bvh_max_x,T=D._bvh_max_y,j=u<S?u:S,R=h<B?h:B,F=l>L?l:L,U=c>T?c:T,K=(L-S)*(T-B),N=(F-j)*(U-R),q=N-K;v._bvh_sort=f++,v._bvh_min_x=M<j?M:j,v._bvh_min_y=A<R?A:R,v._bvh_max_x=E>F?E:F,v._bvh_max_y=P>U?P:U,v=C<=q?b:D}else this._hierarchy=t}},{key:"remove",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e){var n=t._bvh;if(n&&n!==this)throw new Error("Body belongs to another collision system");t._bvh=null,this._bodies.splice(this._bodies.indexOf(t),1)}if(this._hierarchy!==t){var r=t._bvh_parent,i=r._bvh_parent,a=r._bvh_left,o=a===t?r._bvh_right:a;if(o._bvh_parent=i,o._bvh_branch&&(o._bvh_sort=r._bvh_sort),i){i._bvh_left===r?i._bvh_left=o:i._bvh_right=o;for(var s=i;s;){var u=s._bvh_left,h=u._bvh_min_x,l=u._bvh_min_y,c=u._bvh_max_x,v=u._bvh_max_y,f=s._bvh_right,_=f._bvh_min_x,y=f._bvh_min_y,d=f._bvh_max_x,p=f._bvh_max_y;s._bvh_min_x=h<_?h:_,s._bvh_min_y=l<y?l:y,s._bvh_max_x=c>d?c:d,s._bvh_max_y=v>p?v:p,s=s._bvh_parent}}else this._hierarchy=o;Mt.releaseBranch(r)}else this._hierarchy=null}},{key:"update",value:function(){for(var t=this._bodies,e=t.length,n=0;n<e;++n){var r=t[n],i=!1;if(i||r.padding===r._bvh_padding||(r._bvh_padding=r.padding,i=!0),!i){var a=r._polygon;a&&(r._dirty_coords||r.x!==r._x||r.y!==r._y||r.angle!==r._angle||r.scale_x!==r._scale_x||r.scale_y!==r._scale_y)&&r._calculateCoords();var o=r.x,s=r.y,u=a?0:r.radius*r.scale,h=a?r._min_x:o-u,l=a?r._min_y:s-u,c=a?r._max_x:o+u,v=a?r._max_y:s+u;i=h<r._bvh_min_x||l<r._bvh_min_y||c>r._bvh_max_x||v>r._bvh_max_y}i&&(this.remove(r,!0),this.insert(r,!0))}}},{key:"potentials",value:function(t){var e=[],n=t._bvh_min_x,r=t._bvh_min_y,i=t._bvh_max_x,a=t._bvh_max_y,o=this._hierarchy,s=!0;if(!o||!o._bvh_branch)return e;for(;o;){if(s){s=!1;for(var u=o._bvh_branch?o._bvh_left:null;u&&u._bvh_max_x>=n&&u._bvh_max_y>=r&&u._bvh_min_x<=i&&u._bvh_min_y<=a;)u=(o=u)._bvh_branch?o._bvh_left:null}var h=o._bvh_branch,l=h?o._bvh_right:null;if(l&&l._bvh_max_x>n&&l._bvh_max_y>r&&l._bvh_min_x<i&&l._bvh_min_y<a)o=l,s=!0;else{h||o===t||e.push(o);var c=o._bvh_parent;if(!c)break;for(;c&&c._bvh_right===o;)c=(o=c)._bvh_parent;o=c}}return e}},{key:"draw",value:function(t){for(var e=this._bodies,n=e.length,r=0;r<n;++r)e[r].draw(t)}},{key:"drawBVH",value:function(t){for(var e=this._hierarchy,n=!0;e;){if(n){n=!1;for(var r=e._bvh_branch?e._bvh_left:null;r;)r=(e=r)._bvh_branch?e._bvh_left:null}var i=e._bvh_branch,a=e._bvh_min_x,o=e._bvh_min_y,s=e._bvh_max_x,u=e._bvh_max_y,h=i?e._bvh_right:null;if(t.moveTo(a,o),t.lineTo(s,o),t.lineTo(s,u),t.lineTo(a,u),t.lineTo(a,o),h)e=h,n=!0;else{var l=e._bvh_parent;if(!l)break;for(;l&&l._bvh_right===e;)l=(e=l)._bvh_parent;e=l}}}}]),t}();function Et(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=t._polygon,a=e._polygon,o=!1;return n&&(n.a=t,n.b=e,n.a_in_b=!0,n.b_in_a=!0,n.overlap=null,n.overlap_x=0,n.overlap_y=0),i&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords(),a&&(e._dirty_coords||e.x!==e._x||e.y!==e._y||e.angle!==e._angle||e.scale_x!==e._scale_x||e.scale_y!==e._scale_y)&&e._calculateCoords(),r&&!function(t,e){var n=t._polygon,r=n?0:t.x,i=n?0:t.y,a=n?0:t.radius*t.scale,o=n?t._min_x:r-a,s=n?t._min_y:i-a,u=n?t._max_x:r+a,h=n?t._max_y:i+a,l=e._polygon,c=l?0:e.x,v=l?0:e.y,f=l?0:e.radius*e.scale,_=l?e._min_x:c-f,y=l?e._min_y:v-f,d=l?e._max_x:c+f,p=l?e._max_y:v+f;return o<d&&s<p&&u>_&&h>y}(t,e)||(i&&t._dirty_normals&&t._calculateNormals(),a&&e._dirty_normals&&e._calculateNormals(),o=i&&a?function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=t._coords.length,i=e._coords.length;if(2===r&&2===i){var a=t._coords,o=e._coords;return n&&(n.overlap=0),a[0]===o[0]&&a[1]===o[1]}var s=t._coords,u=e._coords,h=t._normals,l=e._normals;if(r>2)for(var c=0,v=1;c<r;c+=2,v+=2)if(It(s,u,h[c],h[v],n))return!1;if(i>2)for(var f=0,_=1;f<i;f+=2,_+=2)if(It(s,u,l[f],l[_],n))return!1;return!0}(t,e,n):i?Pt(t,e,n,!1):a?Pt(e,t,n,!0):function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=t.radius*t.scale,i=e.radius*e.scale,a=e.x-t.x,o=e.y-t.y,s=r+i,u=a*a+o*o;if(u>s*s)return!1;if(n){var h=Math.sqrt(u);n.a_in_b=r<=i&&h<=i-r,n.b_in_a=i<=r&&h<=r-i,n.overlap=s-h,n.overlap_x=a/h,n.overlap_y=o/h}return!0}(t,e,n)),n&&(n.collision=o),o}function Pt(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=t._coords,a=t._edges,o=t._normals,s=e.x,u=e.y,h=e.radius*e.scale,l=2*h,c=h*h,v=i.length,f=!0,_=!0,y=null,d=0,p=0;if(2===v){var g=s-i[0],m=u-i[1],b=g*g+m*m;if(b>c)return!1;if(n){var w=Math.sqrt(b);y=h-w,d=g/w,p=m/w,_=!1}}else for(var k=0,x=1;k<v;k+=2,x+=2){var M=s-i[k],A=u-i[x],E=a[k],P=a[x],I=M*E+A*P,O=I<0?-1:I>E*E+P*P?1:0,C=!1,D=0,S=0,B=0;if(n&&f&&M*M+A*A>c&&(f=!1),O){var L=-1===O,T=L?0===k?v-2:k-2:k===v-2?0:k+2,j=T+1,R=s-i[T],F=u-i[j],U=a[T],K=a[j],N=R*U+F*K;if((N<0?-1:N>U*U+K*K?1:0)===-O){var q=L?M:R,z=L?A:F,V=q*q+z*z;if(V>c)return!1;if(n){var Y=Math.sqrt(V);C=!0,D=h-Y,S=q/Y,B=z/Y,_=!1}}}else{var H=o[k],G=o[x],X=M*H+A*G;if(X>0&&(X<0?-X:X)>h)return!1;n&&(C=!0,D=h-X,S=H,B=G,(_&&X>=0||D<l)&&(_=!1))}C&&(null===y||y>D)&&(y=D,d=S,p=B)}return n&&(n.a_in_b=r?_:f,n.b_in_a=r?f:_,n.overlap=y,n.overlap_x=r?-d:d,n.overlap_y=r?-p:p),!0}function It(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=t.length,o=e.length;if(!a||!o)return!0;for(var s=null,u=null,h=null,l=null,c=0,v=1;c<a;c+=2,v+=2){var f=t[c]*n+t[v]*r;(null===s||s>f)&&(s=f),(null===u||u<f)&&(u=f)}for(var _=0,y=1;_<o;_+=2,y+=2){var d=e[_]*n+e[y]*r;(null===h||h>d)&&(h=d),(null===l||l<d)&&(l=d)}if(s>l||u<h)return!0;if(i){var p=0;if(s<h)if(i.a_in_b=!1,u<l)p=u-h,i.b_in_a=!1;else{var g=u-h,m=l-s;p=g<m?g:-m}else if(i.b_in_a=!1,u>l)p=s-l,i.a_in_b=!1;else{var b=u-h,w=l-s;p=b<w?b:-w}var k=i.overlap,x=p<0?-p:p;if(null===k||k>x){var M=p<0?-1:1;i.overlap=x,i.overlap_x=n*M,i.overlap_y=r*M}}return!1}var Ot=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;u(this,t),this.x=e,this.y=n,this.padding=r,this._circle=!1,this._polygon=!1,this._point=!1,this._bvh=null,this._bvh_parent=null,this._bvh_branch=!1,this._bvh_padding=r,this._bvh_min_x=0,this._bvh_min_y=0,this._bvh_max_x=0,this._bvh_max_y=0}return l(t,[{key:"collides",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return Et(this,t,e,n)}},{key:"potentials",value:function(){var t=this._bvh;if(null===t)throw new Error("Body does not belong to a collision system");return t.potentials(this)}},{key:"remove",value:function(){var t=this._bvh;t&&t.remove(this,!1)}}]),t}(),Ct=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return u(this,e),(t=p(this,f(e).call(this,n,r,o))).radius=i,t.scale=a,t}return v(e,Ot),l(e,[{key:"draw",value:function(t){var e=this.x,n=this.y,r=this.radius*this.scale;t.moveTo(e+r,n),t.arc(e,n,r,0,2*Math.PI)}}]),e}(),Dt=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;return u(this,e),(t=p(this,f(e).call(this,n,r,h))).angle=a,t.scale_x=o,t.scale_y=s,t._polygon=!0,t._x=n,t._y=r,t._angle=a,t._scale_x=o,t._scale_y=s,t._min_x=0,t._min_y=0,t._max_x=0,t._max_y=0,t._points=null,t._coords=null,t._edges=null,t._normals=null,t._dirty_coords=!0,t._dirty_normals=!0,e.prototype.setPoints.call(d(t),i),t}return v(e,Ot),l(e,[{key:"draw",value:function(t){(this._dirty_coords||this.x!==this._x||this.y!==this._y||this.angle!==this._angle||this.scale_x!==this._scale_x||this.scale_y!==this._scale_y)&&this._calculateCoords();var e=this._coords;if(2===e.length)t.moveTo(e[0],e[1]),t.arc(e[0],e[1],1,0,2*Math.PI);else{t.moveTo(e[0],e[1]);for(var n=2;n<e.length;n+=2)t.lineTo(e[n],e[n+1]);e.length>4&&t.lineTo(e[0],e[1])}}},{key:"setPoints",value:function(t){var e=t.length;this._points=new Float64Array(2*e),this._coords=new Float64Array(2*e),this._edges=new Float64Array(2*e),this._normals=new Float64Array(2*e);for(var n=this._points,r=0,i=0,a=1;r<e;++r,i+=2,a+=2){var o=t[r];n[i]=o[0],n[a]=o[1]}this._dirty_coords=!0}},{key:"_calculateCoords",value:function(){for(var t,e,n,r,i=this.x,a=this.y,o=this.angle,s=this.scale_x,u=this.scale_y,h=this._points,l=this._coords,c=h.length,v=0,f=1;v<c;v+=2,f+=2){var _=h[v]*s,y=h[f]*u;if(o){var d=Math.cos(o),p=Math.sin(o),g=_;_=g*d-y*p,y=g*p+y*d}_+=i,y+=a,l[v]=_,l[f]=y,0===v?(t=e=_,n=r=y):(_<t?t=_:_>e&&(e=_),y<n?n=y:y>r&&(r=y))}this._x=i,this._y=a,this._angle=o,this._scale_x=s,this._scale_y=u,this._min_x=t,this._min_y=n,this._max_x=e,this._max_y=r,this._dirty_coords=!1,this._dirty_normals=!0}},{key:"_calculateNormals",value:function(){for(var t=this._coords,e=this._edges,n=this._normals,r=t.length,i=0,a=1;i<r;i+=2,a+=2){var o=i+2<r?i+2:0,s=t[o]-t[i],u=t[o+1]-t[a],h=s||u?Math.sqrt(s*s+u*u):0;e[i]=s,e[a]=u,n[i]=h?u/h:0,n[a]=h?-s/h:0}this._dirty_normals=!1}}]),e}(),St=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return u(this,e),(t=p(this,f(e).call(this,n,r,[[0,0]],0,1,1,i)))._point=!0,t}return v(e,Dt),l(e,[{key:"setPoints",value:function(){throw new Error("Cannt set points for a single point.")}}]),e}(),Bt=[[-.5,-.5],[-.5,.5],[.5,.5],[.5,-.5]],Lt=new(function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;u(this,t),this.broadPhase=e||new At,this.narrowPhase=n}return l(t,[{key:"addCircle",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=new Ct(t,e,n,r,i);return this.broadPhase.insert(a),a}},{key:"addBox",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=new Dt(t,e,Bt,i,n*a,r*a,o);return this.broadPhase.insert(s),s}},{key:"addPolygon",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[[0,0]],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=new Dt(t,e,n,r,i,a,o);return this.broadPhase.insert(s),s}},{key:"addPoint",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=new St(t,e,n);return this.broadPhase.insert(r),r}},{key:"add",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=0,i=e;r<i.length;r++){var a=i[r];this.broadPhase.insert(a,!1)}return this}},{key:"remove",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=0,i=e;r<i.length;r++){var a=i[r];this.broadPhase.remove(a,!1)}return this}},{key:"update",value:function(){return this.broadPhase.update(),this}},{key:"potentials",value:function(t){return this.broadPhase.potentials(t)}},{key:"collides",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Et(t,e,n,!0)}}]),t}());var Tt=Object.freeze({COLLISION_MANAGER:Lt,overlap:function(t,e,n,r,i,a,o,s){return t+n>=i&&i+o>=t&&e+r>=a&&a+s>=e},draw:function(){var t=n.canvas.getContext("2d");t.strokeStyle="#FFFFFF",t.beginPath(),Lt.broadPhase.draw(t),t.stroke(),t.strokeStyle="#00FF00",t.beginPath(),Lt.broadPhase.drawBVH(t),t.stroke()}}),jt=function(){function t(){u(this,t),this.handle=0,this.ticks=0,this._running=!1,this.run=this.run.bind(this)}return l(t,[{key:"hasStarted",value:function(){return this._running}},{key:"start",value:function(){return this.emit("start"),this.handle=requestAnimationFrame(this.run),this._running=!0,this.ticks=0,this}},{key:"stop",value:function(){return cancelAnimationFrame(this.handle),this.handle=0,this._running=!1,this.emit("stop"),this}},{key:"run",value:function(){this.handle=requestAnimationFrame(this.run),this.emit("update"),++this.ticks}}]),t}();Q.mixin(jt);var Rt=new jt;Rt.on("update",function(){L.poll(),bt.update(),Lt.update()}),t.Collision=Tt,t.Color=kt,t.Display=s,t.Entity=G,t.Eventable=Q,t.Game=Rt,t.Input=R,t.Math=k,t.Tween=wt,Object.defineProperty(t,"__esModule",{value:!0})});
