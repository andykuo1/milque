!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Milque={})}(this,function(t){"use strict";var e=new Map,n={id:null,canvas:null};function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(e.has(t)){var r=e.get(t);n.id=t,n.canvas=r}else i()}function i(){n.id=null,n.canvas=null}function a(){return n.canvas.width}function o(){return n.canvas.height}var s=Object.freeze({VIEW:n,attach:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i?(e.set(i,t),n.canvas||r(i)):(t||((t=document.createElement("canvas")).setAttribute("width",640),t.setAttribute("height",480),document.body.appendChild(t)),e.set(null,t),r(null))},detach:function(t){e.delete(t)},bind:r,unbind:i,width:a,height:o,clear:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#000000",e=n.canvas.getContext("2d");e.fillStyle=t,e.fillRect(0,0,a(),o())}});function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function h(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t}function l(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function f(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&y(t,e)}function v(t){return(v=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function y(t,e){return(y=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(t,e,n){return(p=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var i=new(Function.bind.apply(t,r));return n&&y(i,n.prototype),i}).apply(null,arguments)}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function g(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?d(t):e}function m(t,e,n){return(m="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=v(t)););return t}(t,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(n):i.value}})(t,e,n||t)}function w(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{r||null==s.return||s.return()}finally{if(i)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function k(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var b=function(){function t(){u(this,t),this.actions=new Set,this.states=new Set,this.ranges=new Map}return h(t,[{key:"clear",value:function(){this.actions.clear(),this.ranges.clear(),this.states.clear()}},{key:"setAction",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e?this.actions.add(t):this.actions.delete(t),this}},{key:"setState",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e?this.states.add(t):this.states.delete(t),this}},{key:"setRange",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return void 0===e?this.ranges.delete(t):this.ranges.set(t,e),this}},{key:"getAction",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!!this.actions.has(t)&&(e&&this.actions.delete(t),!0)}},{key:"getState",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!!this.states.has(t)&&(e&&this.states.delete(t),!0)}},{key:"getRange",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.ranges.has(t)){var n=this.ranges.get(t);return e&&this.ranges.delete(t),n}return 0}},{key:"hasAction",value:function(t){return this.actions.has(t)}},{key:"hasState",value:function(t){return this.states.has(t)}},{key:"hasRange",value:function(t){return this.ranges.has(t)}}]),t}(),M=function(){function t(){u(this,t),this.inputs=new Map}return h(t,[{key:"clear",value:function(){this.inputs.clear()}},{key:"register",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=t.eventKeys[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;this.inputs.has(o)?this.inputs.get(o).push(t):this.inputs.set(o,[t])}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}},{key:"unregister",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=t.eventKeys[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;if(this.inputs.has(o)){var s=this.inputs.get(o),u=s.indexOf(t);u>=0&&s.splice(u,1)}}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}},{key:"get",value:function(t){return this.inputs.has(t)?this.inputs.get(t):[]}},{key:"values",value:function(){return this.inputs.values()}}],[{key:"toEventKey",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return t+"["+e+"]"+(n?":"+n:"")}},{key:"fromEventKey",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=t.indexOf("[");if(n>=0){var r=t.substring(0,n).trim();e.push(r);var i=t.indexOf("]",n+1);if(!(i>=0))throw new Error("Invalid format - missing closing bracket for key.");var a=t.substring(n+1,i).trim();e.push(a);var o=t.indexOf(":",i+1);if(o>=0){var s=t.substring(o+1).trim();e.push(s)}}else e.push(t.trim());return e}}]),t}(),_=function(){function t(e){u(this,t),this.name=e,this.disabled=!1,this.mapping=new M}return h(t,[{key:"enable",value:function(){return this.disabled=!0,this}},{key:"disable",value:function(){return this.disabled=!0,this}}]),t}(),E=function(){function t(e){u(this,t),this.name=e;for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];this.eventKeys=r}return h(t,[{key:"update",value:function(t,e,n,r){return r}}]),t}(),A=function(t){function e(t){var n;u(this,e);for(var r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return g(this,(n=v(e)).call.apply(n,[this,t].concat(i)))}return f(e,E),h(e,[{key:"update",value:function(t,e,n,r){return"boolean"!=typeof r&&(r=Boolean(r)),r}}]),e}(),x=function(t){function e(t,n,r){var i;return u(this,e),(i=g(this,v(e).call(this,t,n,r))).active=!1,i}return f(e,E),h(e,[{key:"update",value:function(t,e,n,r){"boolean"!=typeof r&&(r=Boolean(r));var i=M.toEventKey(t.name,e,n);if(i===this.eventKeys[0])this.active=r;else{if(i!==this.eventKeys[1])return null;this.active=!r}return this.active}}]),e}(),O=function(t){function e(t,n,r,i){var a;if(u(this,e),a=g(this,v(e).call(this,t,n)),"number"!=typeof i||"number"!=typeof r)throw new Error("Range bounds for input not specified");if(i<r)throw new Error("Max range must be greater than min range");a.min=r,a.max=i;var o=i-r;if(0==o)throw new Error("Range of input cannot be zero");return a.normal=o,a}return f(e,E),h(e,[{key:"update",value:function(t,e,n,r){return"number"!=typeof r&&(r=r?1:0),this.normalize(r)}},{key:"normalize",value:function(t){return(t-this.min)/this.normal}}]),e}(),I=function(){function t(){u(this,t),this.devices={},this.contexts=new Map,this.currentState=new b,this.contexts.set("default",new _("default")),this.onInputEvent=this.onInputEvent.bind(this)}return h(t,[{key:"addDevice",value:function(t){this.devices[t.name]=t,t.addEventListener("input",this.onInputEvent)}},{key:"removeDevice",value:function(t){t.removeEventListener("input",this.onInputEvent),delete this.devices[t.name]}},{key:"getDevice",value:function(t){return this.devices[t.name]}},{key:"clearDevices",value:function(){for(var t=0,e=Object.keys(this.devices);t<e.length;t++){var n=e[t];this.devices[n].removeEventListener("input",this.onInputEvent),delete this.devices[n]}}},{key:"getDevices",value:function(){return Object.values(this.devices)}},{key:"poll",value:function(){this.propagateActiveStateInputs()}},{key:"propagateActiveStateInputs",value:function(){var t=this.currentState,e=!0,n=!1,r=void 0;try{for(var i,a=this.contexts.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;if(!o.disabled){var s=!0,u=!1,c=void 0;try{for(var h,l=o.mapping.values()[Symbol.iterator]();!(s=(h=l.next()).done);s=!0){var f=h.value,v=!0,y=!1,p=void 0;try{for(var d,g=f[Symbol.iterator]();!(v=(d=g.next()).done);v=!0){var m=d.value;if(m instanceof x&&m.active){t.setState(m.name,!0);break}}}catch(t){y=!0,p=t}finally{try{v||null==g.return||g.return()}finally{if(y)throw p}}}}catch(t){u=!0,c=t}finally{try{s||null==l.return||l.return()}finally{if(u)throw c}}}}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}},{key:"onInputEvent",value:function(t,e,n){for(var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=this.currentState,a=M.toEventKey(t.name,e,n),o=arguments.length,s=new Array(o>4?o-4:0),u=4;u<o;u++)s[u-4]=arguments[u];var c=!0,h=!1,l=void 0;try{for(var f,v=this.contexts.values()[Symbol.iterator]();!(c=(f=v.next()).done);c=!0){var y=f.value;if(!y.disabled){var p=!0,d=!1,g=void 0;try{for(var m,w=y.mapping.get(a)[Symbol.iterator]();!(p=(m=w.next()).done);p=!0){var k=m.value,b=k.update.apply(k,[t,e,n,r].concat(s));if(null!==b){if(k instanceof A)i.setAction(k.name,b);else if(k instanceof x)i.setState(k.name,b);else{if(!(k instanceof O))throw new Error("Unknown input class.");i.setRange(k.name,b)}break}}}catch(t){d=!0,g=t}finally{try{p||null==w.return||w.return()}finally{if(d)throw g}}}}}catch(t){h=!0,l=t}finally{try{c||null==v.return||v.return()}finally{if(h)throw l}}}},{key:"registerContext",value:function(t){var e=new _(t);return this.contexts.set(t,e),this}},{key:"unregisterContext",value:function(t){return this.contexts.delete(t),this}},{key:"getContext",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";return this.contexts.get(t)}}]),t}(),P=function(){function t(e){u(this,t),this.name=e,this.listeners=new Map}return h(t,[{key:"delete",value:function(){this.listeners.clear()}},{key:"addEventListener",value:function(t,e){this.listeners.has(t)?this.listeners.get(t).push(e):this.listeners.set(t,[e])}},{key:"removeEventListener",value:function(t,e){if(this.listeners.has(t)){var n=this.listeners.get(t),r=e.indexOf(e);r>=0&&n.splice(r,1)}}},{key:"dispatchEvent",value:function(t,e,n,r){if(this.listeners.has(t)){for(var i=arguments.length,a=new Array(i>4?i-4:0),o=4;o<i;o++)a[o-4]=arguments[o];var s=!0,u=!1,c=void 0;try{for(var h,l=this.listeners.get(t)[Symbol.iterator]();!(s=(h=l.next()).done);s=!0){var f=h.value;f.call.apply(f,[null,this,e,n,r].concat(a))}}catch(t){u=!0,c=t}finally{try{s||null==l.return||l.return()}finally{if(u)throw c}}}}}]),t}(),D=function(t){function e(t){var n;return u(this,e),(n=g(this,v(e).call(this,"key"))).element=t,n.onKeyDown=n.onKeyDown.bind(d(n)),n.onKeyUp=n.onKeyUp.bind(d(n)),document.addEventListener("keydown",n.onKeyDown),document.addEventListener("keyup",n.onKeyUp),n}return f(e,P),h(e,[{key:"delete",value:function(){document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("keyup",this.onKeyUp),m(v(e.prototype),"delete",this).call(this)}},{key:"onKeyDown",value:function(t){t.repeat||this.dispatchEvent("input",t.key,"down",!0)}},{key:"onKeyUp",value:function(t){this.dispatchEvent("input",t.key,"up",!0)}}]),e}(),S=function(t){function e(t){var n,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return u(this,e),(n=g(this,v(e).call(this,"mouse"))).element=t,n.allowCursorLock=r,n.onMouseMove=n.onMouseMove.bind(d(n)),n.onMouseDown=n.onMouseDown.bind(d(n)),n.onMouseUp=n.onMouseUp.bind(d(n)),n._down=!1,t.addEventListener("mousedown",n.onMouseDown,!1),document.addEventListener("mousemove",n.onMouseMove,!1),n.onMouseClick=n.onMouseClick.bind(d(n)),t.addEventListener("click",n.onMouseClick,!1),n}return f(e,P),h(e,[{key:"delete",value:function(){this.hasPointerLock()&&document.exitPointerLock(),this.element.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),this.element.removeEventListener("click",this.onMouseClick),m(v(e.prototype),"delete",this).call(this)}},{key:"onMouseClick",value:function(t){this.allowCursorLock&&this.element.requestPointerLock()}},{key:"onMouseMove",value:function(t){if(!this.allowCursorLock||this.hasPointerLock())if(this.dispatchEvent("input","move","x",t.movementX),this.dispatchEvent("input","move","y",t.movementY),this.element instanceof Element){var e=this.element.getBoundingClientRect();this.dispatchEvent("input","pos","x",t.clientX-e.left),this.dispatchEvent("input","pos","y",t.clientY-e.top)}else this.dispatchEvent("input","pos","x",t.pageX),this.dispatchEvent("input","pos","y",t.pageY)}},{key:"onMouseDown",value:function(t){this.allowCursorLock&&!this.hasPointerLock()||(this._down&&document.removeEventListener("mouseup",this.onMouseUp),this._down=!0,document.addEventListener("mouseup",this.onMouseUp,!1),this.dispatchEvent("input",t.button,"down",!0,t.clientX,t.clientY))}},{key:"onMouseUp",value:function(t){this.allowCursorLock&&!this.hasPointerLock()||(document.removeEventListener("mouseup",this.onMouseUp),this._down=!1,this.dispatchEvent("input",t.button,"up",!0,t.clientX,t.clientY))}},{key:"hasPointerLock",value:function(){return document.pointerLockElement===this.element}}]),e}(),C=new I,j=new D(window),L=new S(window,!1);C.addDevice(j),C.addDevice(L);var B=Object.freeze({INPUT_MANAGER:C,KEYBOARD:j,MOUSE:L,Action:function(t){for(var e={input:null,attach:function(){if(this.input)throw new Error("Already attached input to source.");for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return this.input=p(A,[t].concat(n)),C.getContext().mapping.register(this.input),this},get:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.input){var e=C.currentState;if(e.hasAction(this.input.name))return e.getAction(this.input.name,t)}return!1}},n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return r.length>0&&e.attach.apply(e,r),e},State:function(t){for(var e={inputs:null,attach:function(){if(this.inputs)throw new Error("Already attached input to source.");this.inputs=[];for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i],s=void 0,u=void 0;if(Array.isArray(o))s=o[0],u=o[1];else{var c=M.fromEventKey(o),h=w(c,2),l=h[0],f=h[1];s=M.toEventKey(l,f,"down"),u=M.toEventKey(l,f,"up")}var v=new x(t,s,u);C.getContext().mapping.register(v),this.inputs.push(v)}return this},get:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=C.currentState;return!!e.hasState(this.inputs[0].name)&&e.getState(this.inputs[0].name,t)}},n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return r.length>0&&e.attach.apply(e,r),e},Range:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i={input:null,attach:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(this.input)throw new Error("Already attached input to source.");return this.input=new O(t,e,n,r),C.getContext().mapping.register(this.input),this},get:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=C.currentState;return e.hasRange(this.input.name)?e.getRange(this.input.name,t):0}};return e&&i.attach(e,n,r),i}}),R=function(){function t(){u(this,t)}return h(t,[{key:"create",value:function(){return this}},{key:"change",value:function(){return this}},{key:"destroy",value:function(){return!1}}]),t}(),T=function(t){function e(){var t;return u(this,e),(t=g(this,v(e).call(this))).entityManager=null,t.entityID=-1,t}return f(e,R),h(e,[{key:"create",value:function(t,e){this.entityManager=t,this.entityID=e;for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return this.onCreate.apply(this,r),this}},{key:"change",value:function(){return this.onChange.apply(this,arguments),this}},{key:"destroy",value:function(){var t=this.onDestroy();return this.entityManager.destroy(this.entityID),this.entityID=-1,t}},{key:"component",value:function(t){for(var e,n=this,r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];this.entityManager.has(this.entityID,t)?(e=this.entityManager).update.apply(e,[this.entityID,t].concat(i)):function(){for(var e,r=(e=n.entityManager).assign.apply(e,[n.entityID,t].concat(i)),a=function(){var t=s[o];Object.getOwnPropertyDescriptor(n,t).value&&(r[t]=value),Object.defineProperty(n,t,{get:function(){return r[t]},set:function(e){r[t]=e},enumerable:!0})},o=0,s=Object.keys(r);o<s.length;o++)a()}();return this}},{key:"tag",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e?this.entityManager.assign(this.entityID,t):this.entityManager.remove(this.entityID,t),this}},{key:"remove",value:function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++)for(var o=a[i],s=this.entityManager.get(this.entityID,o),u=0,c=Object.keys(s);u<c.length;u++){var h=c[u];delete this[h]}return(t=this.entityManager).remove.apply(t,[this.entityID].concat(n)),this}},{key:"has",value:function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=this.entityManager).has.apply(t,[this.entityID].concat(n))}},{key:"get",value:function(t){for(var e,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(e=this.entityManager).get.apply(e,[this.entityID,t].concat(r))}},{key:"onCreate",value:function(){}},{key:"onChange",value:function(){}},{key:"onDestroy",value:function(){return!1}}]),e}(),U=function(){function t(e,n){u(this,t),this.entityManager=e,this.filter=n}return h(t,[{key:"subview",value:function(e){var n=this;return new t(this.entityManager,function(t){return n.filter(t)&&e(t)})}},{key:Symbol.iterator,value:function(){return{filter:this.filter,iterator:this.entityManager._entities[Symbol.iterator](),next:function(){for(var t;!(t=this.iterator.next()).done;){var e=t.value;if(this.filter(e))return{value:e,done:!1}}return{done:!0}}}}}]),t}(),K=function(){function t(e){u(this,t),this.components=new Map,this.factory=e}return h(t,null,[{key:"getComponentName",value:function(t){return"string"==typeof t?t:t.name}}]),h(t,[{key:"add",value:function(t){for(var e,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var a=(e=this.factory).create.apply(e,r);return this.components.set(t,a),a}},{key:"change",value:function(t){for(var e,n=this.components.get(t),r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return(e=this.factory).change.apply(e,[n].concat(i)),n}},{key:"remove",value:function(t){var e=this.components.get(t);this.factory.destroy(e),this.components.delete(t)}},{key:"get",value:function(t){return this.components.get(t)}},{key:"has",value:function(t){return this.components.has(t)}},{key:"clear",value:function(){this.components.clear()}}]),t}(),q=function(){function t(){u(this,t)}return h(t,[{key:"create",value:function(){return{}}},{key:"change",value:function(t){}},{key:"destroy",value:function(t){}}]),t}(),F=function(t){function e(t){var n;return u(this,e),(n=g(this,v(e).call(this))).tagName=t,n}return f(e,q),h(e,[{key:"create",value:function(){return null}}]),e}(),z=function(t){function e(t){var n;return u(this,e),(n=g(this,v(e).call(this))).componentHandler=t,n}return f(e,q),h(e,[{key:"create",value:function(){return this.componentHandler.apply(this,arguments)}},{key:"change",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i=this.componentHandler.apply(this,n),a=0,o=Object.keys(i);a<o.length;a++){var s=o[a];t[s]=i[s]}}},{key:"destroy",value:function(t){}}]),e}(),N=function(t){function e(t){var n;return u(this,e),(n=g(this,v(e).call(this)))._cache=[],n.componentClass=t,n}return f(e,q),h(e,[{key:"create",value:function(){var t,e;if(this._cache.length>0)e=this._cache.shift();else{var n=this.componentClass;e=new n}return(t=e).create.apply(t,arguments),e}},{key:"change",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];t.change.apply(t,n)}},{key:"destroy",value:function(t){var e=t.destroy();e&&this._cache.push(e)}}]),e}(),Y=new(function(){function t(){u(this,t),this._entities=new Set,this._componentManagers=new Map,this._nextEntityID=1}return h(t,[{key:"registerComponent",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)if("string"==typeof t)e=new F(t);else if(t.prototype instanceof R)e=new N(t);else{if("function"!=typeof t)throw new Error("Cannot find factory for component type.");e=new z(t)}var n=new K(e);return this._componentManagers.set(t,n),n}},{key:"unregisterComponent",value:function(t){this._componentManagers.delete(t)}},{key:"create",value:function(){var t=this._nextEntityID++;this._entities.add(t);for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i];this.assign(t,o)}return t}},{key:"destroy",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=this._componentManagers.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;o.has(t)&&o.remove(t)}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}this._entities.delete(t)}},{key:"entities",value:function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new U(this,function(e){return t.has.apply(t,[e].concat(n))})}},{key:"has",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i];if(!this._componentManagers.has(o))return!1;if(!this._componentManagers.get(o).has(t))return!1}return!0}},{key:"get",value:function(t,e){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(r.length>0){var a=[];a.push(this._componentManagers.get(e).get(t));for(var o=0,s=r;o<s.length;o++){var u=s[o];a.push(this._componentManagers.get(u).get(t))}return a}return this._componentManagers.get(e).get(t)}},{key:"assign",value:function(t,e){var n,r;if("number"!=typeof t)throw new Error("Invalid entity handle - must be a number.");r=this._componentManagers.has(e)?this._componentManagers.get(e):this.registerComponent(e);for(var i=arguments.length,a=new Array(i>2?i-2:0),o=2;o<i;o++)a[o-2]=arguments[o];return(n=r).add.apply(n,[t].concat(a))}},{key:"change",value:function(t,e){if("number"!=typeof t)throw new Error("Invalid entity handle - must be a number.");for(var n=this._componentManagers.get(e),r=arguments.length,i=new Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];return n.change.apply(n,[t].concat(i))}},{key:"remove",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];for(var i=0,a=n;i<a.length;i++){var o=a[i];if(this._componentManagers.has(o)){var s=this._componentManagers.get(o);s.has(t)&&s.remove(t)}}}},{key:"clear",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e.length>0)for(var r=0,i=e;r<i.length;r++){var a=i[r];if(this._componentManagers.has(a)){var o=this._componentManagers.get(a);o.clear()}}else this._componentManagers.clear(),this._entities.clear()}}]),t}());var V=Object.freeze({ENTITY_MANAGER:Y,EntityBase:T,spawn:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:T,e=Y.create(),n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return Y.assign.apply(Y,[e,t,Y,e].concat(r))},entities:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return l({view:new U(Y,function(t){return Y.has.apply(Y,[t,T].concat(e))})},Symbol.iterator,function(){return{iterator:this.view[Symbol.iterator](),next:function(){var t=this.iterator.next();return t.done?{done:!0}:{value:Y.get(t.value,T),done:!1}}}})},components:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return l({view:new U(Y,function(t){return Y.has.apply(Y,[t].concat(e))})},Symbol.iterator,function(){return{iterator:this.view[Symbol.iterator](),next:function(){var t=this.iterator.next();return t.done?{done:!0}:{value:Y.get.apply(Y,[t.value].concat(e)),done:!1}}}})}}),X=function(){function t(){u(this,t),this.tweens=new Map,this.cachedTweens=new Set,this.useCache=!1}return h(t,[{key:"add",value:function(t){this.useCache?this.cachedTweens.add(t):this.tweens.set(t.id,t)}},{key:"remove",value:function(t){this.cachedTweens.has(t)?this.cachedTweens.delete(t):this.tweens.delete(t.id)}},{key:"clear",value:function(){this.tweens.clear(),this.cachedTweens.clear()}},{key:"update",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];do{var n=!0,r=!1,i=void 0;try{for(var a,o=this.cachedTweens.values()[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value;this.add(s)}}catch(t){r=!0,i=t}finally{try{n||null==o.return||o.return()}finally{if(r)throw i}}this.cachedTweens.clear(),this.useCache=!0;var u=!0,c=!1,h=void 0;try{for(var l,f=this.tweens.keys()[Symbol.iterator]();!(u=(l=f.next()).done);u=!0){var v=l.value,y=this.tweens.get(v);y.update(t)||e||this.tweens.delete(v)}}catch(t){c=!0,h=t}finally{try{u||null==f.return||f.return()}finally{if(c)throw h}}this.useCache=!1}while(this.cachedTweens.size>0)}}]),t}(),G={on:function(t,e){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;if(this.__events.has(t)?n=this.__events.get(t):(n=new Map,this.__events.set(t,n)),n.has(r))throw new Error("Found callback for event '".concat(t,"' with the same handle '").concat(r,"'."));return n.set(r,e),this},off:function(t,e){if(!this.__events.has(t))throw new Error("Unable to find event '".concat(t,"'."));var n=this.__events.get(t);if(!n.has(e))throw new Error("Unable to find callback for event '".concat(t,"' with handle '").concat(e,"'."));return n.delete(e),this},once:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,i=function(){n.off(t,r),e.apply(void 0,arguments)};return this.on(t,i,r)},emit:function(t){if(this.__events.has(t)){for(var e=Array.from(this.__events.get(t).values()),n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];for(var a=0,o=e;a<o.length;a++){var s=o[a];s.apply(void 0,r)}}else this.__events.set(t,new Map);return this}},H={create:function(){var t=Object.create(G);return t.__events=new Map,t},assign:function(t){var e=Object.assign(t,G);return e.__events=new Map,e},mixin:function(t){var e=t.prototype;Object.assign(e,G),e.__events=new Map}};function W(t){switch(t){case"linear":return Q.Both;case"quadratic":case"quadratic-both":case"quadratic-in-out":return J.Both;case"quadratic-in":return J.In;case"quadratic-out":return J.Out;case"cubic":case"cubic-both":case"cubic-in-out":return Z.Both;case"cubic-in":return Z.In;case"cubic-out":return Z.Out;case"sinusoidal":case"sinusoidal-both":case"sinusoidal-in-out":return $.Both;case"sinusoidal-in":return $.In;case"sinusoidal-out":return $.Out;case"exponential":case"exponential-both":case"exponential-in-out":return tt.Both;case"exponential-in":return tt.In;case"exponential-out":return tt.Out;case"circular":case"circular-both":case"circular-in-out":return et.Both;case"circular-in":return et.In;case"circular-out":return et.Out;case"elastic":case"elastic-both":case"elastic-in-out":return nt.Both;case"elastic-in":return nt.In;case"elastic-out":return nt.Out;case"back":case"back-both":case"back-in-out":return rt.Both;case"back-in":return rt.In;case"back-out":return rt.Out;case"bounce":case"bounce-both":case"bounce-in-out":return it.Both;case"bounce-in":return it.In;case"bounce-out":return it.Out;default:throw new Error("Unknown easing function name '".concat(t,"'."))}}var Q={Both:function(t){return t}},J={In:function(t){return t*t},Out:function(t){return t*(2-t)},Both:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},Z={In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},Both:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},$={In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},Both:function(t){return.5*(1-Math.cos(Math.PI*t))}},tt={In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},Both:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}},et={In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},Both:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},nt={In:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},Out:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},Both:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1}},rt={In:function(t){var e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},Both:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}},it={In:function(t){return 1-it.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},Both:function(t){return t<.5?.5*it.In(2*t):.5*it.Out(2*t-1)+.5}},at=Object.freeze({getFunctionByName:W,Linear:Q,Quadratic:J,Cubic:Z,Sinusoidal:$,Exponential:tt,Circular:et,Elastic:nt,Back:rt,Bounce:it});function ot(t){switch(t){case"linear":return st;case"bezier":return ut;case"catmullrom":return ct;default:throw new Error("Unknown interpolation function name '".concat(t,"'."))}}function st(t,e){var n=t.length-1,r=n*e,i=Math.floor(r),a=ht;return e<0?a(t[0],t[1],r):e>1?a(t[n],t[n-1],n-r):a(t[i],t[i+1>n?n:i+1],r-i)}function ut(t,e){for(var n=0,r=t.length-1,i=Math.pow,a=lt,o=0;o<=r;o++)n+=i(1-e,r-o)*i(e,o)*t[o]*a(r,o);return n}function ct(t,e){var n=t.length-1,r=n*e,i=Math.floor(r),a=yt;return t[0]===t[n]?(e<0&&(i=Math.floor((function(t){throw new Error('"'+t+'" is read-only')}("f"),r=n*(1+e)))),a(t[(i-1+n)%n],t[i],t[(i+1)%n],t[(i+2)%n],r-i)):e<0?t[0]-(a(t[0],t[0],t[1],t[1],-r)-t[0]):e>1?t[n]-(a(t[n],t[n],t[n-1],t[n-1],r-n)-t[n]):a(t[i?i-1:0],t[i],t[n<i+1?n:i+1],t[n<i+2?n:i+2],r-i)}function ht(t,e,n){return(e-t)*n+t}function lt(t,e){var n=vt;return n(t)/n(e)/n(t-e)}var ft=[1];function vt(t){if(ft[t])return ft[t];for(var e=1,n=t;n>1;n--)e*=n;return ft[t]=e,e}function yt(t,e,n,r,i){var a=.5*(n-t),o=.5*(r-e),s=i*i;return(2*e-2*n+a+o)*(i*s)+(-3*e+3*n-2*a-o)*s+a*i+e}var pt=Object.freeze({getFunctionByName:ot,Linear:st,Bezier:ut,CatmullRom:ct}),dt=1,gt=function(){function t(e){u(this,t),this.target=e,this.id=dt++,this.active=!1,this.startTime=0,this.startProperties={},this.repeatProperties={},this.reversed=!1,this.endProperties={},this.nexts=[],this.easingFunction=Q.Both,this.interpolationFunction=st,this._duration=1e3,this._startDelay=0,this._repeatDelay=0,this._repeat=0,this._yoyo=!1,this.firstUpdate=!1}return h(t,null,[{key:"now",value:function(){return Date.now()}}]),h(t,[{key:"to",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this.endProperties=Object.create(t),void 0!==e&&(this._duration=e),this}},{key:"next",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.nexts=e,this}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;for(var n in this.startTime=void 0===e?t.now():e,this.startTime+=this._startDelay,this.endProperties){if(!(n in this.target))throw new Error("Cannot tween non-existent property.");var r=this.target[n];if("number"!=typeof r)throw new Error("Cannot tween non-number property.");var i=this.endProperties[n];if(Array.isArray(i))this.endProperties[n]=[r].concat(k(i));else if("function"!=typeof i&&"number"!=typeof i)throw new Error("Unable to tween unknown end property type.");this.startProperties[n]=r,this.repeatProperties[n]=this.startProperties[n]}return this.active=!0,this.firstUpdate=!0,this}},{key:"stop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.active)return this;if(this.active=!1,t)this.update(1/0);else{var e=!0,n=!1,r=void 0;try{for(var i,a=this.nexts[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;o.stop()}}catch(t){n=!0,r=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw r}}}return this}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.now();if(e<this.startTime)return!0;this.firstUpdate&&(this.firstUpdate=!1,this.emit("start",this.target));var n=this._duration>0?Math.min((e-this.startTime)/this._duration,1):1,r=this.easingFunction(n);for(var i in this.endProperties)if(i in this.startProperties){var a=this.startProperties[i],o=this.endProperties[i];this.target[i]=this.getTweenValue(a,o,r)}if(this.emit("update",this.target,n),n>=1){if(this._repeat>0){for(var s in Number.isFinite(this._repeat)&&--this._repeat,this.repeatProperties){if(this._yoyo){var u=this.repeatProperties[s];if(this.repeatProperties[s]=this.endProperties[s],this.endProperties[s]=u,"function"==typeof this.repeatProperties[s]){this.startProperties[s]=this.repeatProperties[s].call(null,this.endProperties[s]);continue}}else"function"==typeof this.endProperties[s]&&(this.repeatProperties[s]+=this.endProperties[s].call(null,this.repeatProperties[s]));this.startProperties[s]=this.repeatProperties[s]}return this._yoyo&&(this.reversed=!this.reversed),this._repeatDelay?this.startTime=e+this._repeatDelay:this.startTime=e+this._startDelay,this.emit("repeat",this.target),!0}this.active=!1,this.emit("complete",this.target);var c=!0,h=!1,l=void 0;try{for(var f,v=this.nexts[Symbol.iterator]();!(c=(f=v.next()).done);c=!0){var y=f.value;y.start(this.startTime+this._duration)}}catch(t){h=!0,l=t}finally{try{c||null==v.return||v.return()}finally{if(h)throw l}}return!1}return!0}},{key:"getTweenValue",value:function(t,e,n){var r;if("number"==typeof(r=Array.isArray(e)?this.interpolationFunction(e,n):"function"==typeof e?e.call(null,t):e))return t+(r-t)*n;throw new Error("Unable to tween unknown end property type.")}},{key:"ease",value:function(t){return this.easingFunction="string"==typeof t?W(t):t,this}},{key:"interpolate",value:function(t){return this.interpolationFunction="string"==typeof t?ot(t):t,this}},{key:"repeat",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this._repeat=t,void 0!==e&&(this._repeatDelay=e),this}},{key:"delay",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this._startDelay=t,void 0===e&&(this._repeatDelay=e),this}},{key:"yoyo",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._yoyo=t,this._repeat<=0&&(this._repeat=1),this}},{key:"setDuration",value:function(t){return this._duration=t,this}},{key:"setRepeatDelay",value:function(t){return this._repeatDelay=t,this}}]),t}();H.mixin(gt);var mt=new X;var wt=Object.freeze({TWEEN_MANAGER:mt,Easing:at,Interpolation:pt,create:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,i=new gt(t).to(e,r).delay(n);return mt.add(i),i}});var kt=Object.freeze({uuid:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(t){return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)})},lerp:function(t,e,n){return t*(1-n)+e*n},stringHash:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=0,n=0,r=t.length;n<r;n++)e=Math.imul(31,e)+t.charCodeAt(n)|0;return e},getDirectionalVector:function(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[0,0],s=n-t,u=r-e,c=Math.atan2(u,s)+a;return o[0]=Math.cos(c)*i,o[1]=Math.sin(c)*i,o},getMidPoint:function(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[0,0];return i[0]=t+(n-t)/2,i[1]=e+(r-e)/2,i},randomRange:function(t,e){return Math.random()*(e-t)+t},choose:function(t){return t[Math.floor(Math.random()*t.length)]},distanceSqu:function(t,e,n,r){var i=n-t,a=r-e;return i*i+a*a},distance:function(t,e,n,r){var i=n-t,a=r-e;return Math.sqrt(i*i+a*a)}});var bt=Object.freeze({randomColor:function(){for(var t="#",e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}}),Mt=function(){function t(){u(this,t),this.handle=0,this.ticks=0,this._running=!1,this.run=this.run.bind(this)}return h(t,[{key:"hasStarted",value:function(){return this._running}},{key:"start",value:function(){return this.emit("start"),this.handle=requestAnimationFrame(this.run),this._running=!0,this.ticks=0,this}},{key:"stop",value:function(){return cancelAnimationFrame(this.handle),this.handle=0,this._running=!1,this.emit("stop"),this}},{key:"run",value:function(){this.handle=requestAnimationFrame(this.run),this.emit("update"),++this.ticks}}]),t}();H.mixin(Mt);var _t=new Mt;_t.on("update",function(){C.poll(),mt.update()}),t.Color=bt,t.Display=s,t.Entity=V,t.Eventable=H,t.Game=_t,t.Input=B,t.Math=kt,t.Tween=wt,Object.defineProperty(t,"__esModule",{value:!0})});
