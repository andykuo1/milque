!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Milque={})}(this,(function(t){"use strict";var e=Object.freeze({__proto__:null,get default(){return e},get Audio(){return E},get Random(){return C},get Game(){return x},get RandomGenerator(){return n},get SimpleRandomGenerator(){return i},get Eventable(){return l},get View(){return c},get ViewHelper(){return d},get ViewPort(){return p},get AbstractCamera(){return m},get GameLoop(){return f},get SceneManager(){return g},get SceneBase(){return _},get Display(){return P},get MODE_NOSCALE(){return M},get MODE_CENTER(){return S},get MODE_FIT(){return H},get MODE_STRETCH(){return O},get DisplayPort(){return A},get QueryOperator(){return Y},get ComponentFactory(){return tt},get Component(){return N},get Entity(){return ot},get EntityWrapper(){return ht},get HotEntityReplacement(){return xt},get EntityManager(){return W},get EntityQuery(){return B},get ComponentBase(){return nt},get TagComponent(){return it},get EntityComponent(){return V},get EntityBase(){return rt},get HybridEntity(){return st},get HotEntityModule(){return Ct},get FineDiffStrategy(){return wt},get InputContext(){return Rt},get InputSource(){return kt},get Input(){return Kt},get EventKey(){return St},get AbstractInputAdapter(){return Ht},get ActionInputAdapter(){return Ot},get DOUBLE_ACTION_TIME(){return $t},get DoubleActionInputAdapter(){return Pt},get RangeInputAdapter(){return It},get StateInputAdapter(){return Tt},get Keyboard(){return jt},get Mouse(){return Dt},get Util(){return Wt}});class n{constructor(t){this._seed=t}get seed(){return this._seed}random(){return Math.random()}randomRange(t,e){return this.random()*(e-t)+t}randomChoose(t){return t[Math.floor(this.random()*t.length)]}randomSign(){return this.random()<.5?-1:1}}class i extends n{constructor(t=0){super(Math.abs(t%2147483647)),this._next=this.seed}random(){return this._next=Math.abs(16807*this._next%2147483647-1),this._next/2147483646}}const r={on(t,e,n=e){let i;if(this.__events.has(t)?i=this.__events.get(t):(i=new Map,this.__events.set(t,i)),i.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return i.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,(...i)=>{this.off(t,n),e.apply(this.__context||this,i)},n)},emit(t,...e){if(this.__events.has(t)){const n=Array.from(this.__events.get(t).values());for(const t of n)t.apply(this.__context||this,e)}else this.__events.set(t,new Map);return this}};function s(t){const e=Object.create(r);return e.__events=new Map,e.__context=t,e}function o(t,e){const n=Object.assign(t,r);return n.__events=new Map,n.__context=e,n}function a(t,e){const n=t.prototype;return Object.assign(n,r),n.__events=new Map,n.__context=e,n}var h={create:s,assign:o,mixin:a},l=Object.freeze({__proto__:null,create:s,assign:o,mixin:a,default:h});function u(t,e){let n=document.createElement("canvas");n.width=t,n.height=e,n.style="image-rendering: pixelated";let i=n.getContext("2d");return i.imageSmoothingEnabled=!1,{canvas:n,context:i}}var c=Object.freeze({__proto__:null,createView:function(t=640,e=480){let{canvas:n,context:i}=u(t,e);return{_canvas:n,_context:i,_width:t,_height:e,get canvas(){return this._canvas},get context(){return this._context},get width(){return this._width},set width(t){this._width=t,this._canvas.width=t},get height(){return this._height},set height(t){this._height=t,this._canvas.height=t}}},createViewBuffer:u,drawBufferToCanvas:function(t,e,n=0,i=0,r=t.canvas.clientWidth,s=t.canvas.clientHeight){t.drawImage(e,n,i,r,s)}});var d=Object.freeze({__proto__:null,setViewTransform:function(t,e){e?(t.context.setTransform(...e.getProjectionMatrix()),t.context.transform(...e.getViewMatrix())):t.context.setTransform(1,0,0,1,0,0)}});class p{constructor(t,e){this._canvas=t,this._context=e}getX(){return 0}getY(){return 0}getWidth(){return this._canvas.clientWidth}getHeight(){return this._canvas.clientHeight}getCanvas(){return this._canvas}getContext(){return this._context}}class m{getProjectionMatrix(){return[1,0,0,1,0,0]}getViewMatrix(){return[1,0,0,1,0,0]}}class f{constructor(t={}){this.prevFrameTime=0,this.animationFrameHandle=null,this.started=!1,this.paused=!1,this.deltaTimeFactor=.001,this.gameContext=t,this.run=this.run.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.pause=this.pause.bind(this),this.resume=this.resume.bind(this),this.__context=t}setDeltaTimeFactor(t){return this.deltaTimeFactor=t,this}run(t){this.animationFrameHandle=requestAnimationFrame(this.run);const e=(t-this.prevFrameTime)*this.deltaTimeFactor;this.prevFrameTime=t,"function"==typeof this.gameContext.update&&this.gameContext.update.call(this.gameContext,e),this.emit("update",e)}start(){if(this.started)throw new Error("Loop already started.");window.addEventListener("focus",this.resume),window.addEventListener("blur",this.pause),this.prevFrameTime=performance.now(),this.started=!0,"function"==typeof this.gameContext.start&&this.gameContext.start.call(this.gameContext),this.emit("start"),this.run(this.prevFrameTime)}stop(){if(!this.started)throw new Error("Loop not yet started.");window.removeEventListener("focus",this.resume),window.removeEventListener("blur",this.pause),cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null,this.started=!1,"function"==typeof this.gameContext.stop&&this.gameContext.stop.call(this.gameContext),this.emit("stop")}pause(){this.started&&!this.paused&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null,this.paused=!0,"function"==typeof this.gameContext.pause&&this.gameContext.pause.call(this.gameContext),this.emit("pause"))}resume(){this.started&&this.pause&&(this.prevFrameTime=performance.now(),this.paused=!1,"function"==typeof this.gameContext.resume&&this.gameContext.resume.call(this.gameContext),this.emit("resume"),this.run(this.prevFrameTime))}}a(f);const y={};class g{constructor(){this.registry=new Map,this.sharedContext={},this._scene=null,this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null}setSharedContext(t){return this.sharedContext=t,this}register(t,e){if("string"!=typeof t)throw new Error("Scene name must be a string.");return this.registry.set(t,e),this}unregister(t){return this.registry.delete(t),this}nextScene(t,e=null,n={}){if(this._nextScene)throw new Error("Cannot change scenes during a scene transition.");if("string"==typeof t){if(!this.registry.has(t))throw new Error(`Cannot find scene with name '${t}'.`);t=this.registry.get(t)}if("function"==typeof t)t=new t;else{if("object"!=typeof t)throw new Error("Scene type not supported.");Object.isExtensible(t)||(i=t,t={...i})}var i;this._nextScene=t,this._nextLoadOpts=n,this._nextTransition=e||y}update(t){if(this._transition)this._updateStep(t,this._transition);else if(this._nextScene){const t=this._nextScene,e=this._nextLoadOpts,n=this._nextTransition;this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null,this._transition=n;let i=Promise.resolve(),r=this._scene;r&&("onStop"in r&&r.onStop(this.sharedContext),"unload"in r&&(i=i.then(()=>r.unload(this.sharedContext)))),"load"in t&&(i=i.then(()=>t.load(this.sharedContext,e))),i=i.then(()=>{this._scene=t,this._transition=null,"onStart"in this._scene&&this._scene.onStart(this.sharedContext)})}else this._scene&&this._updateStep(t,this._scene)}_updateStep(t,e){"onPreUpdate"in e&&e.onPreUpdate(t),this.emit("preupdate",t),"onUpdate"in e&&e.onUpdate(t),this.emit("update",t),"onPostUpdate"in e&&e.onPostUpdate(t),this.emit("postupdate",t)}getCurrentScene(){return this._scene}getNextScene(){return this._nextScene}[Symbol.iterator](){return this.registry[Symbol.iterator]()}}a(g);class _{async load(t,e){}async unload(t){}onStart(t){}onStop(t){}onPreUpdate(t){}onUpdate(t){}onPostUpdate(t){}}var v=new AudioContext;var E=Object.freeze({__proto__:null,createSound:function(t,e=!1){const n={_playing:!1,_data:null,_source:null,play(){if(!this._data)return;this._source&&this.destroy();let t=v.createBufferSource();t.loop=e,t.buffer=this._data,t.addEventListener("ended",()=>{this._playing=!1}),t.connect(v.destination),t.start(0),this._source=t,this._playing=!0},pause(){this._source.stop(),this._playing=!1},destroy(){this._source&&this._source.disconnect(),this._source=null},isPaused(){return!this._playing}};return fetch(t).then(t=>t.arrayBuffer()).then(t=>v.decodeAudioData(t)).then(t=>n._data=t),n}});const w=new n;var C=Object.freeze({__proto__:null,createRandom:function(t=0){return new i(t)},random:function(){return w.random()},randomRange:function(t,e){return w.randomRange(t,e)},randomChoose:function(t){return w.randomChoose(t)},randomSign:function(){return w.randomSign()}});const b=new Map;var x=Object.freeze({__proto__:null,start:function(t){let e;if(b.has(t))throw new Error("Cannot start game loop with duplicate handle.");{let n;n="object"==typeof t?t:{},e=new f(n)}return b.set(t,e),setTimeout(()=>e.start(),0),e},stop:function(t){if(b.has(t)){let e=b.get(t);return e.stop(),b.delete(t),e}return null},createGameLoop:function(t={}){return new f(t)}});const M="noscale",S="center",H="fit",O="stretch",I=S,T=`\n<style>\n    :host {\n        display: inline-block;\n        color: #555555;\n    }\n    div {\n        display: flex;\n        position: relative;\n        width: 100%;\n        height: 100%;\n    }\n    canvas {\n        background: #000000;\n        margin: auto;\n    }\n    label {\n        font-family: monospace;\n        color: currentColor;\n        position: absolute;\n    }\n    #title {\n        left: 0.5rem;\n        top: 0.5rem;\n    }\n    #fps {\n        right: 0.5rem;\n        top: 0.5rem;\n    }\n    #dimension {\n        left: 0.5rem;\n        bottom: 0.5rem;\n    }\n    .hidden {\n        display: none;\n    }\n    :host([debug]) div {\n        outline: 8px dashed rgba(0, 0, 0, 0.4);\n        outline-offset: -4px;\n        background-color: rgba(0, 0, 0, 0.1);\n    }\n    :host([mode="${M}"]) canvas {\n        margin: 0;\n        top: 0;\n        left: 0;\n    }\n    :host([mode="${H}"]), :host([mode="${S}"]), :host([mode="${O}"]) {\n        width: 100%;\n        height: 100%;\n    }\n    :host([full]) {\n        width: 100vw!important;\n        height: 100vh!important;\n    }\n    :host([disabled]) {\n        display: none;\n    }\n</style>`;class A extends HTMLElement{static get observedAttributes(){return["width","height","disabled","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`<div>${T}\n<label class="hidden" id="title">display-port</label>\n<label class="hidden" id="fps">00</label>\n<label class="hidden" id="dimension">0x0</label>\n<canvas></canvas></div>`,this._canvasElement=this.shadowRoot.querySelector("canvas"),this._canvasContext=this._canvasElement.getContext("2d"),this._canvasContext.imageSmoothingEnabled=!1,this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=640,this._height=480,this.update=this.update.bind(this)}connectedCallback(){this.hasAttribute("mode")||(this.mode=I),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=n;break;case"height":this._height=n;break;case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}}update(t){if(this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize(),this.debug){const e=t-this._prevAnimationFrameTime,n=e<=0?"--":String(Math.round(1e3/e)).padStart(2,"0");if(this._prevAnimationFrameTime=t,this._fpsElement.innerText!==n&&(this._fpsElement.innerText=n),this.mode===M){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:t,context:this._canvasContext},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}updateCanvasSize(){let t=this.shadowRoot.host.getBoundingClientRect();const e=t.width,n=t.height;let i=this._canvasElement,r=this._width,s=this._height;const o=this.mode;if(o===O)r=e,s=n;else if(o!==M){if(e<r||n<s||o===H){let t=e/r,i=n/s;t<i?(r=e,s*=t):(r*=i,s=n)}}r=Math.floor(r),s=Math.floor(s),i.width===r&&i.height===s||(i.width=r,i.height=s,i.style=`width: ${r}px; height: ${s}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:r,height:s},bubbles:!1,composed:!0})))}getCanvas(){return this._canvasElement}getContext(){return this._canvasContext}get width(){return this._width}set width(t){this.setAttribute("width",t)}get height(){return this._height}set height(t){this.setAttribute("height",t)}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get debug(){return this.hasAttribute("debug")}set debug(t){t?this.setAttribute("debug",""):this.removeAttribute("debug")}}var R,D;function j(t,e,n=320,i=n){D=e,(R=t).width=n,R.height=i}function L(){return D}function k(){return R.clientWidth}function $(){return R.clientHeight}window.customElements.define("display-port",A),window.addEventListener("DOMContentLoaded",()=>{if(!R){let t=null,e=null,n=document.querySelector("display-port");n?(t=n.getCanvas(),e=n.getContext()):t=document.querySelector("canvas"),t&&(e||(e=t.getContext("2d")),j(t,e))}});var P=Object.freeze({__proto__:null,createCanvas:function(t=320,e=t,n=document.body){const i=document.createElement("canvas");n.appendChild(i),j(i,t,e)},attachCanvas:j,drawBufferToScreen:function(t,e=0,n=0,i=k(),r=$()){L().drawImage(t.canvas,e,n,i,r)},getCanvas:function(){return R},getDrawContext:L,getClientWidth:k,getClientHeight:$,getClientOffsetX:function(){return R.offsetLeft},getClientOffsetY:function(){return R.offsetTop}});function F(t){return t.name||t.toString()}var N=Object.freeze({__proto__:null,getComponentTypeName:F});const z=Symbol("operator"),U=Symbol("handler");class B{static select(t,e){return new B(e,!1).select(t)}static computeKey(t){let e=[];for(let n of t)"object"==typeof n&&z in n?e.push(n[z].toString()+F(n)):e.push(F(n));return e.sort().join("-")}constructor(t,e=!0){this._included=[],this._operated={};for(let e of t)if("object"==typeof e&&z in e){const t=e[z];t in this._operated?this._operated[t].components.push(e.component):this._operated[t]={components:[e.component],handler:e[U]}}else this._included.push(e);this.entityManager=null,this.persistent=e,this.entityIds=new Set,this.key=B.computeKey(t),this.onEntityCreate=this.onEntityCreate.bind(this),this.onEntityDestroy=this.onEntityDestroy.bind(this),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this)}matches(t,e){if(this.entityManager!==t)return!1;if(!t.hasComponent(e,...this._included))return!1;for(let n of Object.getOwnPropertyNames(this._operated))if(!n[U].call(this,t,e,n.components))return!1;return!0}select(t){let e=this.entityManager===t;if(this.persistent&&e)return this.entityIds;const n=this.entityManager;this.entityManager=t,this.entityIds.clear();for(let e of t.getEntityIds())this.matches(t,e)&&this.entityIds.add(e);return this.persistent&&!e&&(n&&(n.entityHandler.off("create",this.onEntityCreate),n.entityHandler.off("destroy",this.onEntityDestroy),n.componentHandler.off("add",this.onComponentAdd),n.componentHandler.off("remove",this.onComponentRemove)),this.entityManager.entityHandler.on("create",this.onEntityCreate),this.entityManager.entityHandler.on("destroy",this.onEntityDestroy),this.entityManager.componentHandler.on("add",this.onComponentAdd),this.entityManager.componentHandler.on("remove",this.onComponentRemove)),this.entityIds}selectComponent(t,e=this._included[0]){let n=this.select(t),i=[];for(let r of n)i.push(t.getComponent(r,e));return i}clear(){this.persistent&&(this.entityManager.entityHandler.off("create",this.onEntityCreate),this.entityManager.entityHandler.off("destroy",this.onEntityDestroy),this.entityManager.componentHandler.off("add",this.onComponentAdd),this.entityManager.componentHandler.off("remove",this.onComponentRemove)),this.entityIds.clear(),this.entityManager=null}onEntityCreate(t){this.matches(this.entityManager,t)&&this.entityIds.add(t)}onEntityDestroy(t){this.entityIds.has(t)&&this.entityIds.delete(t)}onComponentAdd(t,e,n,i){this.onComponentRemove(t,e,n)}onComponentRemove(t,e,n){this.matches(this.entityManager,t)?this.entityIds.add(t):this.entityIds.has(t)&&this.entityIds.delete(t)}}class K{constructor(){this._entities=new Set,this._nextAvailableEntityId=1,this._listeners=new Map}addEntityListener(t,e,n,i){const r=i&&void 0!==i.handle?i.handle:n;if(this._listeners.has(t)){let i=this._listeners.get(t);if(e in i){i[e].set(r,n)}else{let t=new Map;t.set(r,n),i[e]=t}}else{let s=new Set,o=new Map;o.set(r,n),i.once&&s.add(r);let a={onces:s,[e]:o};this._listeners.set(t,a)}}removeEntityListener(t,e,n,i){if(this._listeners.has(t)){let i=this._listeners.get(t);e in i&&(i[e].delete(n),i.onces.has(n)&&i.onces.delete(n))}}dispatchEntityEvent(t,e,n){if(this._listeners.has(t)){let i=this._listeners.get(t);if(e in i){let t=i.onces,r=i[e];for(let[e,i]of r.entries())i.apply(void 0,n),t.has(e)&&r.delete(e)}}}addEntityId(t){this._entities.add(t)}deleteEntityId(t){this._entities.delete(t),this.dispatchEntityEvent(t,"destroy",[t])}getNextAvailableEntityId(){return this._nextAvailableEntityId++}getEntityIds(){return this._entities}}class V{constructor(t){if(!t)throw new Error("Cannot create entity in null world.");const e=t.createEntity();t.componentHandler.putComponent(e,V,this,void 0),this.id=e}copy(t){throw new Error("Unsupported operation; cannot be initialized by existing values.")}reset(){return!1}}class q{constructor(t){this._entityHandler=t,this.componentTypeInstanceMap=new Map}createComponent(t,e){let n,i=typeof t;if("object"===i){if(!("create"in t))throw new Error(`Instanced component class '${getComponentTypeName(t)}' must at least have a create() function.`);n=t.create(this)}else if("function"===i){if(t.prototype instanceof V)throw new Error("This component cannot be added to an existing entity; it can only initialize itself.");n=new t(this)}else{if("symbol"===i)throw new Error("Symbols are not yet supported as components.");n=t}return e&&this.copyComponent(t,n,e),n}putComponent(t,e,n,i){let r;if(this.componentTypeInstanceMap.has(e)?r=this.componentTypeInstanceMap.get(e):this.componentTypeInstanceMap.set(e,r=new Map),r.has(t))throw new Error(`Cannot add more than one instance of component class '${getComponentTypeName(e)}' for entity '${t}'.`);r.set(t,n),this._entityHandler.dispatchEntityEvent(t,"componentadd",[t,e,n,i])}deleteComponent(t,e,n){let i;return this.componentTypeInstanceMap.get(e).delete(t),i=e!==n&&("reset"in e?e.reset(n):"reset"in n&&n.reset()),this._entityHandler.dispatchEntityEvent(t,"componentremove",[t,e,n]),n}copyComponent(t,e,n){if(t!==e)if("copy"in t)t.copy(e,n);else if("copy"in e)e.copy(n);else for(let t of Object.getOwnPropertyNames(n))e[t]=n[t]}hasComponentType(t){return this.componentTypeInstanceMap.has(t)}getComponentTypes(){return this.componentTypeInstanceMap.keys()}getComponentInstanceMapByType(t){return this.componentTypeInstanceMap.get(t)}getComponentInstanceMaps(){return this.componentTypeInstanceMap.values()}}class W{constructor(){this.entityHandler=new K,this.componentHandler=new q(this.entityHandler)}clear(){for(let t of this.entityHandler.getEntityIds())this.destroyEntity(t)}createEntity(...t){const e=this.entityHandler.getNextAvailableEntityId();this.entityHandler.addEntityId(e);for(let n of t)this.addComponent(e,n);return e}destroyEntity(t){for(let e of this.componentHandler.getComponentTypes())this.componentHandler.getComponentInstanceMapByType(e).has(t)&&this.removeComponent(t,e);this.entityHandler.deleteEntityId(t)}getEntityIds(){return this.entityHandler.getEntityIds()}addComponent(t,e,n){try{let i=this.componentHandler.createComponent(e,n);return this.componentHandler.putComponent(t,e,i,n),i}catch(n){console.error(`Failed to add component '${F(e)}' to entity '${t}'.`),console.error(n)}}removeComponent(t,e){try{let n=this.getComponent(t,e);return this.componentHandler.deleteComponent(t,e,n),n}catch(n){console.error(`Failed to remove component '${F(e)}' from entity '${t}'.`),console.error(n)}}clearComponents(t){for(let e of this.componentHandler.getComponentInstanceMaps())if(e.has(t)){let n=e.get(t);this.componentHandler.deleteComponent(t,componentType,n)}}getComponentTypesByEntityId(t){let e=[];for(let n of this.componentHandler.getComponentTypes()){this.componentHandler.getComponentInstanceMapByType(n).has(t)&&e.push(n)}return e}getComponent(t,e){return this.componentHandler.getComponentInstanceMapByType(e).get(t)}hasComponent(t,...e){for(let n of e){if(!this.componentHandler.hasComponentType(n))return!1;if(!this.componentHandler.getComponentInstanceMapByType(n).has(t))return!1}return!0}countComponents(t){let e=0;for(let n of this.componentHandler.getComponentInstanceMaps())n.has(t)&&++e;return e}find(t){return B.select(this,t)}[Symbol.iterator](){return this.getEntityIds()[Symbol.iterator]()}}function G(t,e=Symbol(t.name)){let n=function(n){return{[OPERATOR]:e,[HANDLER]:t,component:n}};return Object.defineProperty(n,"name",{value:name,configurable:!0}),n}const X=G((function(t,e,n){return!t.hasComponent(e,...n)}),Symbol("!"));var Y=Object.freeze({__proto__:null,createQueryOperator:G,Not:X});function Q(t,e){return{}}function J(t,e){Object.assign(t,e)}function Z(t){Object.getOwnPropertyNames(t).forEach(e=>delete t[e])}var tt=Object.freeze({__proto__:null,createComponentFactory:function(t,e=Q,n=J,i=Z){return{name:t,create:e,copy:n,reset:i}}});const et=Symbol("defaultUndefined");class nt{static get defaultValues(){return null}constructor(t,e,n=!0){"defaultValues"in this.constructor||(n?(this.constructor.defaultValues=null,this.constructor.defaultValues=new this.constructor):this.constructor.defaultValues=et)}copy(t){for(let e of Object.getOwnPropertyNames(t))this[e]=t[e]}reset(){if("defaultValues"in this.constructor){let t=this.constructor.defaultValues;if(t===et){for(let t of Object.getOwnPropertyNames(this))this[t]=void 0;return!0}return!!t&&(this.copy(this,this.constructor.defaultValues),!0)}return!1}}class it{}class rt extends V{constructor(t){super(t),this.entityManager=t}destroy(){this.entityManager.destroyEntity(this.entityId),this.entityManager=null}addComponent(t,e){return this.entityManager.addComponent(this.id,t,e),this}removeComponent(t){return this.entityManager.removeComponent(this.id,t),this}hasComponent(t){return this.entityManager.hasComponent(this.id,t)}getComponent(t){return this.entityManager.getComponent(this.id,t)}}class st extends rt{constructor(t){super(t),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this),this.entityManager.entityHandler.addEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.addEntityListener(this.id,"componentremove",this.onComponentRemove)}onDestroy(){}onComponentAdd(t,e,n,i){t===this.id&&function(t,e,n){if("object"==typeof n){let i=Object.getOwnPropertyNames(t),r={};for(let t of Object.getOwnPropertyNames(n)){if(i.includes(t))throw new Error(`Conflicting property names in entity for component '${getComponentTypeName(e)}'.`);r[t]={get:()=>n[t],set(e){n[t]=e},configurable:!0}}Object.defineProperties(t,r)}}(this,e,n)}onComponentRemove(t,e,n){e===EntityComponent?(this.entityManager.entityHandler.removeEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.removeEntityListener(this.id,"componentremove",this.onComponentRemove),this.onDestroy()):function(t,e,n){if("object"==typeof n)for(let e of Object.getOwnPropertyNames(n))delete t[e]}(this,0,n)}}var ot=Object.freeze({__proto__:null,getEntityById:function(t,e){return getComponent(e,EntityComponent)},getEntities:function(t){let e=[],n=t.query([EntityComponent]);for(let i of n){let n=t.getComponent(i,EntityComponent);e.push(n)}return e}});class at{constructor(t){this.entityManager=t,this.id=t.createEntity()}add(t,e){return this.entityManager.addComponent(this.id,t,e),this}remove(t){return this.entityManager.removeComponent(this.id,t),this}has(...t){return this.entityManager.hasComponent(this.id,...t)}destroy(){this.entityManager.destroyEntity(this.id)}getEntityId(){return this.id}}var ht=Object.freeze({__proto__:null,EntityWrapperBase:at,create:function(t){return new at(t)}});const lt=Symbol("functionName"),ut=Symbol("functionArguments");function ct(t,e=[]){let n=t;for(let t of e)n="object"==typeof t&&lt in t?n[t[lt]](...t[ut]):n[t];return n}function dt(t,e){return[...t,e]}function pt(t,e,n=[]){return[...t,{[lt]:e,[ut]:n}]}class mt extends Array{static createRecord(t,e,n,i=[]){return{type:t,path:i,key:e,value:n}}addRecord(t,e,n,i=[]){let r=mt.createRecord(t,e,n,i);return this.push(r),r}addRecords(t){this.push(...t)}}function ft(t,e,n){switch(n.type){case"new":case"edit":return e[n.key]=n.value,!0;case"delete":return delete e[n.key],!0}return!1}var yt=Object.freeze({__proto__:null,isType:function(t){return Array.isArray(t)},applyDiff:function(t,e,n){switch(n.type){case"arrayObjectEdit":return e[n.key]=n.value,!0;case"arrayObjectAppend":return(i=n.key).length<r&&(i.length=r),e[n.key]=n.value,!0;case"arrayObjectSplice":return e.splice(n.key,n.value),!0}var i,r;return!1},computeDiff:function(t,e,n=[],i={}){let r=new mt;const s=Math.min(t.length,e.length);for(let o=0;o<s;++o){let s=vt(t[o],e[o],dt(n,o),i);s?r.addRecords(s):r.addRecord("arrayObjectEdit",o,e[o],n)}if(!i.preserveSource&&t.length>e.length)r.addRecord("arrayObjectSplice",e.length,t.length-e.length,n);else if(e.length>t.length)for(let i=t.length;i<e.length;++i)r.addRecord("arrayObjectAppend",i,e[i],n);return r}});var gt=Object.freeze({__proto__:null,isType:function(t){return t instanceof Set},applyDiff:function(t,e,n){switch(n.type){case"setAdd":return e.add(n.key),!0;case"setDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],i={}){let r=new mt;for(let i of e)t.has(i)||r.addRecord("setAdd",i,void 0,n);if(!i.preserveSource)for(let i of t)e.has(i)||r.addRecord("setDelete",i,void 0,n);return r}});const _t={handlers:[yt,Object.freeze({__proto__:null,isType:function(t){return t instanceof Map},applyDiff:function(t,e,n){switch(n.type){case"mapNew":case"mapSet":return e.set(n.key,n.value),!0;case"mapDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],i={}){let r=new mt;for(let[s,o]of e)if(t.has(s)){let e=vt(t.get(s),o,pt(n,"get",[s]),i);e?r.addRecords(e):r.addRecord("mapSet",s,o,n)}else r.addRecord("mapNew",s,o,n);if(!i.preserveSource)for(let i of t.keys())e.has(i)||r.addRecord("mapDelete",i,void 0,n);return r}}),gt],preserveSource:!0,maxDepth:1e3};function vt(t,e,n=[],i=_t){if(n.length>=i.maxDepth)return null;if(typeof t!=typeof e)return null;if("object"==typeof t){for(let r of i.handlers){let s=r.isType(t);if(s^r.isType(e))return null;if(s)return r.computeDiff(t,e,n,i)}return function(t,e,n=[],i={}){let r=new mt,s=new Set(Object.getOwnPropertyNames(t));for(let o of Object.getOwnPropertyNames(e))if(s.has(o)){s.delete(o);let a=vt(t[o],e[o],dt(n,o),i);a?r.addRecords(a):r.addRecord("edit",o,e[o],n)}else r.addRecord("new",o,e[o],n);if(!i.preserveSource)for(let t of s)r.addRecord("delete",t,void 0,n);return r}(t,e,n,i)}return t===e?[]:null}function Et(t,e,n=_t){let i=t;for(let r of e){i=ct(t,r.path);let e=!1;for(let s of n.handlers)if(e=s.applyDiff(t,i,r),e)break;e||ft(0,i,r)}return t}function wt(t,e,n){const i=t.entityConstructor,r=t.entityManagers,s=e.entityConstructor;e.entityManagers;let o=new W,a=n&&n.worldObjectWrapper?n.worldObjectWrapper(o):o,h=i(a),l=s(a),u=new Map;for(let t of o.getComponentTypesByEntityId(l)){let e=o.getComponent(l,t),n=o.getComponent(h,t);if(n){let i=vt(n,e);u.set(t,i)}else u.set(t,!0)}for(let t of o.getComponentTypesByEntityId(h))u.has(t)||u.set(t,!1);o.clear();for(let e of r)for(let n of t.entities.get(e).values())for(let[t,i]of u.entries())if("boolean"==typeof i)i?e.addComponent(n,t):e.removeComponent(n,t);else{Et(e.getComponent(n,t),i)}}class Ct{constructor(t,e){this.moduleId=t.id,this.entityConstructor=e,this.entities=new Map}addEntity(t,e){if(this.entities.has(t))this.entities.get(t).add(e);else{let n=new Set;n.add(e),this.entities.set(t,n)}t.entityHandler.addEntityListener(e,"destroy",this.removeEntity.bind(this,t,e),{handle:`${this.moduleId}:${e}`})}removeEntity(t,e){t.entityHandler.removeEntityListener(e,"destroy",`${this.moduleId}:${e}`);let n=this.entities.get(t);n.delete(e),n.size<=0&&this.entities.delete(t)}replaceWith(t,e){(e&&e.replaceStrategy||wt).call(void 0,this,t,e&&e.replaceOpts),this.entityConstructor=t.entityConstructor;for(let e of t.entityManagers)for(let n of t.entities.get(e).values())t.removeEntity(e,n),this.addEntity(e,n)}isEmpty(){return this.entities.size<=0}get entityManagers(){return this.entities.keys()}}const bt=new Map;var xt=Object.freeze({__proto__:null,enableForEntity:function(t,e,n){if(!bt.has(t.id))throw new Error("Module must be accepted first for HER to enable hot entity replacement.");return bt.get(t.id).addEntity(e,n),n},acceptForModule:function(t,e,n){let i=new Ct(t,e);if(bt.has(t.id)){console.log(`Reloading '${t.id}'...`),bt.get(t.id).replaceWith(i,n)}else console.log(`Preparing '${t.id}'...`),bt.set(t.id,i);return t},getInstanceForModuleId:function(t){return HER_MODULES.get(t)}});const Mt=Symbol("any");class St{static parse(t){let e=t.indexOf("["),n=t.indexOf("]"),i=t.indexOf("."),r=null,s=null,o=null;return r=e<=0||0===i?Mt:t.substring(0,e),s=e<0||n<0||e+1===n?Mt:t.substring(e+1,n),o=i<0||t.trim().endsWith(".")?Mt:t.substring(i+1),new St(r,s,o)}constructor(t,e,n){this.source=t,this.code=e,this.mode=n,this.string=`${this.source.toString()}[${this.code.toString()}].${this.mode.toString()}`}matches(t){return!(this.source!==Mt&&t.source!==Mt&&this.source!==t.source||this.code!==Mt&&t.code!==Mt&&this.code!==t.code||this.mode!==Mt&&t.mode!==Mt&&this.mode!==t.mode)}toString(){return this.string}}St.ANY=Mt;class Ht{constructor(t){this.prev=t,this.value=t,this.next=t}update(t,e){return!1}consume(){return this.next}poll(){return this.prev=this.value,this.value=this.next,this.next=this.consume(),this}}class Ot extends Ht{constructor(t){super(!1),this.eventKeys=[];for(let e of t)this.eventKeys.push(St.parse(e))}consume(){return!1}update(t,e=!0){for(let n of this.eventKeys)if(n.matches(t))return this.next=e,!0;return!1}}class It extends Ht{constructor(t){super(0),this.eventKey=St.parse(t)}consume(){switch(this.eventKey.string){case"mouse[pos].dx":case"mouse[pos].dy":return 0;case"mouse[pos].x":case"mouse[pos].y":default:return this.next}}update(t,e=1){return!!this.eventKey.matches(t)&&(this.next=e,!0)}}class Tt extends Ht{constructor(t){super(0),this.eventKeyEntries=[];for(let e of Object.keys(t))this.eventKeyEntries.push({key:St.parse(e),value:t[e]})}update(t,e=!0){if(e)for(let e of this.eventKeyEntries)if(e.key.matches(t))return this.next=e.value,!0;return!1}}function At(){return{_source:null,_priority:0,_active:!0,inputs:new Map,get active(){return this._active},get source(){return this._source},get priority(){return this._priority},attach(t){return this._source=t,this._source.addContext(this),this},detach(){return this._source.removeContext(this),this._source=null,this},setPriority(t){if(t>100||t<-100)throw new Error("Context priority must be between [-100, 100].");return this._priority!==t&&(this._source?(this._source.removeContext(this),this._priority=t,this._source.addContext(this)):this._priority=t),this},registerInput(t,e){return this.inputs.set(t,e),e},registerAction(t,...e){return this.registerInput(t,new Ot(e))},registerRange(t,e){return this.registerInput(t,new It(e))},registerState(t,e){return this.registerInput(t,new Tt(e))},toggle(t){return void 0===t&&(t=!this._active),this._active=t,this},enable(){return this.toggle(!0)},disable(){return this.toggle(!1)},poll(){for(let t of this.inputs.values())t.poll()},update(t,e){let n;for(let i of this.inputs.values())n|=i.update(t,e);return n}}}var Rt=Object.freeze({__proto__:null,MIN_CONTEXT_PRIORITY:-100,MAX_CONTEXT_PRIORITY:100,createContext:At});class Dt{constructor(){this.sourceElement=null,this.eventHandler=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}attach(t=document){return this.sourceElement=t,this.sourceElement.addEventListener("mousedown",this.onMouseDown),this.sourceElement.addEventListener("mouseup",this.onMouseUp),this.sourceElement.addEventListener("contextmenu",this.onContextMenu),document.addEventListener("mousemove",this.onMouseMove),this}detach(){return this.sourceElement.removeEventListener("mousedown",this.onMouseDown),this.sourceElement.removeEventListener("mouseup",this.onMouseUp),this.sourceElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),this.sourceElement=null,this}setEventHandler(t){return this.eventHandler=t,this}onMouseDown(t){if(!this.eventHandler)return;let e;e=this.eventHandler.call(this,`mouse[${t.button}].down`,!0),e&&(t.preventDefault(),t.stopPropagation())}onMouseUp(t){this.eventHandler&&(t.preventDefault(),t.stopPropagation(),this.eventHandler.call(this,`mouse[${t.button}].up`,!0))}onMouseMove(t){if(!this.eventHandler)return;const e=this.sourceElement,n=e.clientWidth,i=e.clientHeight;this.eventHandler.call(this,"mouse[pos].x",(t.pageX-e.offsetLeft)/n),this.eventHandler.call(this,"mouse[pos].y",(t.pageY-e.offsetTop)/i),this.eventHandler.call(this,"mouse[pos].dx",t.movementX/n),this.eventHandler.call(this,"mouse[pos].dy",t.movementY/i)}onContextMenu(t){t.preventDefault(),t.stopPropagation()}}class jt{constructor(){this.sourceElement=null,this.eventHandler=null,this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this)}attach(t=document){return this.sourceElement=t,this.sourceElement.addEventListener("keydown",this.onKeyDown),this.sourceElement.addEventListener("keyup",this.onKeyUp),this}detach(){return this.sourceElement.removeEventListener("keydown",this.onKeyDown),this.sourceElement.removeEventListener("keyup",this.onKeyUp),this.sourceElement=null,this}setEventHandler(t){return this.eventHandler=t,this}onKeyDown(t){if(!this.eventHandler)return;let e;e=t.repeat?this.eventHandler.call(this,`key[${t.key}].repeat`,!0):this.eventHandler.call(this,`key[${t.key}].down`,!0),e&&(t.preventDefault(),t.stopPropagation())}onKeyUp(t){if(!this.eventHandler)return;let e;e=this.eventHandler.call(this,`key[${t.key}].up`,!0),e&&(t.preventDefault(),t.stopPropagation())}}function Lt(){let t={_contexts:new Array(200),element:null,keyboard:new jt,mouse:new Dt,attach(t){return this.element=t,this.keyboard.attach(),this.mouse.attach(t),this},detach(){return this.element=null,this.keyboard.detach(),this.mouse.detach(),this},addContext(t){const e=t.priority- -100;return this._contexts[e]||(this._contexts[e]=[]),this._contexts[e].push(t),this},removeContext(t){const e=t.priority- -100;let n=this._contexts[e];return n&&n.splice(n.indexOf(t),1),this},poll(){for(let t of this._contexts)if(t)for(let e of t)e.active&&e.poll()},handleEvent(t,e){const n=St.parse(t);for(let t of this._contexts)if(t)for(let i of t)if(i.active){let t;if(t=i.update(n,e),t)return!0}return!1}};return t.handleEvent=t.handleEvent.bind(t),t.keyboard.setEventHandler(t.handleEvent),t.mouse.setEventHandler(t.handleEvent),t}var kt=Object.freeze({__proto__:null,createSource:Lt});let $t=300;class Pt extends Ot{constructor(t){super(t),this.actionTime=0}update(t,e=!0){let n=Date.now();for(let i of this.eventKeys)if(i.matches(t))return e?n-this.actionTime<=$t?(this.actionTime=0,this.next=!0,!0):(this.actionTime=n,!1):(this.next=!1,!0);return!1}}var Ft=Lt(),Nt=At().attach(Ft);function zt(t){return Ft.element&&Ft.detach(),Ft.attach(t)}window.addEventListener("DOMContentLoaded",()=>{if(!Ft.element){let t=null,e=document.querySelector("display-port");t=e?e.getCanvas():document.querySelector("canvas"),t&&zt(t)}});var Ut=1;function Bt(){return`__input#${Ut++}`}var Kt=Object.freeze({__proto__:null,attachCanvas:zt,createContext:function(t=0,e=!0){return At().setPriority(t).toggle(e).attach(Ft)},createInput:function(t){return Nt.registerInput(Bt(),t)},createAction:function(...t){return Nt.registerAction(Bt(),...t)},createRange:function(t){return Nt.registerRange(Bt(),t)},createState:function(t){return Nt.registerState(Bt(),t)},poll:function(){return Ft.poll()},handleEvent:function(t,e){return Ft.handleEvent(t,e)}});function Vt(t,e,n){return t<e?e:t>n?n:t}function qt(t,e,n){let i=n-e,r=(t-e)%i;return r<0&&(r+=i),r+e}var Wt=Object.freeze({__proto__:null,uuid:function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)},clampRange:Vt,withinRadius:function(t,e,n){const i=t.x-e.x,r=t.y-e.y;return i*i+r*r<=n*n},lerp:function(t,e,n){return t+(e-t)*n},distance2D:function(t,e){let n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},direction2D:function(t,e){let n=e.x-t.x,i=e.y-t.y;return Math.atan2(i,n)},lookAt2D:function(t,e,n){return Vt(t+qt(e-t,-Math.PI,Math.PI),t-n,t+n)},cycleRange:qt,randomHexColor:function(){return"#"+Math.floor(16777215*Math.random()).toString(16)},loadImage:function(t){let e=new Image;return e.src=t,e},clearScreen:function(t,e,n){t.fillStyle="black",t.fillRect(0,0,e,n)},drawText:function(t,e,n,i,r=0,s=16,o="white"){t.translate(n,i),r&&t.rotate(r),t.textAlign="center",t.textBaseline="middle",t.font=`${s}px sans-serif`,t.fillStyle=o,t.fillText(e,0,0),r&&t.rotate(-r),t.translate(-n,-i)},drawBox:function(t,e,n,i=0,r=16,s=r,o="white",a=!1){t.translate(e,n),i&&t.rotate(i),a?(t.strokeStyle=o,t.strokeRect(-r/2,-s/2,r,s)):(t.fillStyle=o,t.fillRect(-r/2,-s/2,r,s)),i&&t.rotate(-i),t.translate(-e,-n)},intersectBox:function(t,e){return 2*Math.abs(t.x-e.x)<t.width+e.width&&2*Math.abs(t.y-e.y)<t.height+e.height},applyMotion:function(t,e=1,n=e){1!==e&&(t.dx*=e),1!==n&&(t.dy*=n),t.x+=t.dx,t.y+=t.dy},onDOMLoaded:function(t){window.addEventListener("DOMContentLoaded",t)},drawCircle:function(t,e,n,i=16,r="white",s=!1){t.fillStyle=r,t.strokeStyle=r,t.beginPath(),t.arc(e,n,i,0,2*Math.PI),s?t.stroke():t.fill()}});t.AbstractCamera=m,t.AbstractInputAdapter=Ht,t.ActionInputAdapter=Ot,t.Audio=E,t.Component=N,t.ComponentBase=nt,t.ComponentFactory=tt,t.DOUBLE_ACTION_TIME=$t,t.Display=P,t.DisplayPort=A,t.DoubleActionInputAdapter=Pt,t.Entity=ot,t.EntityBase=rt,t.EntityComponent=V,t.EntityManager=W,t.EntityQuery=B,t.EntityWrapper=ht,t.EventKey=St,t.Eventable=l,t.FineDiffStrategy=wt,t.Game=x,t.GameLoop=f,t.HotEntityModule=Ct,t.HotEntityReplacement=xt,t.HybridEntity=st,t.Input=Kt,t.InputContext=Rt,t.InputSource=kt,t.Keyboard=jt,t.MODE_CENTER=S,t.MODE_FIT=H,t.MODE_NOSCALE=M,t.MODE_STRETCH=O,t.Mouse=Dt,t.QueryOperator=Y,t.Random=C,t.RandomGenerator=n,t.RangeInputAdapter=It,t.SceneBase=_,t.SceneManager=g,t.SimpleRandomGenerator=i,t.StateInputAdapter=Tt,t.TagComponent=it,t.Util=Wt,t.View=c,t.ViewHelper=d,t.ViewPort=p,t.default=e,Object.defineProperty(t,"__esModule",{value:!0})}));
