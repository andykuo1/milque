!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Milque={})}(this,(function(t){"use strict";var e=Object.freeze({__proto__:null,get default(){return e},get Audio(){return i},get Display(){return _},get DisplayPort(){return l},get MODE_CENTER(){return o},get MODE_FIT(){return a},get MODE_NOSCALE(){return r},get MODE_STRETCH(){return h},get View(){return s},get Component(){return w},get ComponentBase(){return F},get ComponentFactory(){return L},get Entity(){return N},get EntityBase(){return j},get EntityComponent(){return M},get EntityManager(){return T},get EntityQuery(){return E},get EntityWrapper(){return U},get FineDiffStrategy(){return et},get HotEntityModule(){return nt},get HotEntityReplacement(){return st},get QueryOperator(){return k},get ReflexiveEntity(){return P},get TagComponent(){return $},get AbstractInputAdapter(){return at},get ActionInputAdapter(){return ht},get DOUBLE_ACTION_TIME(){return gt},get DoubleActionInputAdapter(){return _t},get EventKey(){return ot},get Input(){return Ct},get InputContext(){return ct},get InputSource(){return yt},get Keyboard(){return mt},get Mouse(){return pt},get RangeInputAdapter(){return ut},get StateInputAdapter(){return dt},get Eventable(){return Lt},get PriorityQueue(){return St},get uuid(){return Mt},get AbstractCamera(){return Me},get Camera2D(){return Te},get Camera2DControls(){return We},get CameraHelper(){return Re},get EntitySpawner(){return be},get Game(){return ge},get MouseControls(){return Qt},get MoveControls(){return ie},get SceneBase(){return Ce},get SceneManager(){return Ee},get SplashScene(){return we},get Transform2D(){return Se},get Random(){return qe},get RandomGenerator(){return Be},get RandomInterface(){return Ge},get SimpleRandomGenerator(){return Ke},get ApplicationLoop(){return Dt},get clampRange(){return Ft},get cycleRange(){return Ut},get direction2(){return Nt},get distance2(){return Pt},get lerp(){return jt},get lookAt2(){return zt},get withinRadius(){return $t}}),n=new AudioContext;var i=Object.freeze({__proto__:null,createSound:function(t,e=!1){const i={_playing:!1,_data:null,_source:null,play(){if(!this._data)return;this._source&&this.destroy();let t=n.createBufferSource();t.loop=e,t.buffer=this._data,t.addEventListener("ended",()=>{this._playing=!1}),t.connect(n.destination),t.start(0),this._source=t,this._playing=!0},pause(){this._source.stop(),this._playing=!1},destroy(){this._source&&this._source.disconnect(),this._source=null},isPaused(){return!this._playing}};return fetch(t).then(t=>t.arrayBuffer()).then(t=>n.decodeAudioData(t)).then(t=>i._data=t),i}});class s{constructor(t=640,e=480){this._buffer=function(t,e){let n=document.createElement("canvas");n.width=t,n.height=e,n.style="image-rendering: pixelated";let i=n.getContext("2d");return i.imageSmoothingEnabled=!1,{canvas:n,context:i}}(t,e),this._width=t,this._height=e}get canvas(){return this._buffer.canvas}get context(){return this._buffer.context}get width(){return this._width}set width(t){this._width=t,this._canvas.width=t}get height(){return this._height}set height(t){this._height=t,this._canvas.height=t}drawBufferToCanvas(t,e=0,n=0,i=t.canvas.clientWidth,s=t.canvas.clientHeight){t.drawImage(this._buffer.canvas,e,n,i,s)}}const r="noscale",o="center",a="fit",h="stretch",u=o,d=`\n<style>\n    :host {\n        display: inline-block;\n        color: #555555;\n    }\n    div {\n        display: flex;\n        position: relative;\n        width: 100%;\n        height: 100%;\n    }\n    canvas {\n        background: #000000;\n        margin: auto;\n    }\n    label {\n        font-family: monospace;\n        color: currentColor;\n        position: absolute;\n    }\n    #title {\n        left: 0.5rem;\n        top: 0.5rem;\n    }\n    #fps {\n        right: 0.5rem;\n        top: 0.5rem;\n    }\n    #dimension {\n        left: 0.5rem;\n        bottom: 0.5rem;\n    }\n    .hidden {\n        display: none;\n    }\n    :host([debug]) div {\n        outline: 8px dashed rgba(0, 0, 0, 0.4);\n        outline-offset: -4px;\n        background-color: rgba(0, 0, 0, 0.1);\n    }\n    :host([mode="${r}"]) canvas {\n        margin: 0;\n        top: 0;\n        left: 0;\n    }\n    :host([mode="${a}"]), :host([mode="${o}"]), :host([mode="${h}"]) {\n        width: 100%;\n        height: 100%;\n    }\n    :host([full]) {\n        width: 100vw!important;\n        height: 100vh!important;\n    }\n    :host([disabled]) {\n        display: none;\n    }\n</style>`;class l extends HTMLElement{static get observedAttributes(){return["width","height","disabled","onframe","debug","id","class"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`<div>${d}\n<label class="hidden" id="title">display-port</label>\n<label class="hidden" id="fps">00</label>\n<label class="hidden" id="dimension">0x0</label>\n<canvas></canvas></div>`,this._canvasElement=this.shadowRoot.querySelector("canvas"),this._canvasContext=this._canvasElement.getContext("2d"),this._canvasContext.imageSmoothingEnabled=!1,this._titleElement=this.shadowRoot.querySelector("#title"),this._fpsElement=this.shadowRoot.querySelector("#fps"),this._dimensionElement=this.shadowRoot.querySelector("#dimension"),this._animationRequestHandle=0,this._prevAnimationFrameTime=0,this._width=640,this._height=480,this._onframe=null,this.update=this.update.bind(this)}connectedCallback(){this.hasAttribute("mode")||(this.mode=u),this.updateCanvasSize(),this.resume()}disconnectedCallback(){this.pause()}attributeChangedCallback(t,e,n){switch(t){case"width":this._width=n;break;case"height":this._height=n;break;case"disabled":n?(this.update(0),this.pause()):this.resume();break;case"onframe":this.onframe=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"id":case"class":this._titleElement.innerHTML=`display-port${this.className?"."+this.className:""}${this.hasAttribute("id")?"#"+this.getAttribute("id"):""}`;break;case"debug":this._titleElement.classList.toggle("hidden",n),this._fpsElement.classList.toggle("hidden",n),this._dimensionElement.classList.toggle("hidden",n)}}update(t){this._animationRequestHandle=requestAnimationFrame(this.update),this.updateCanvasSize();const e=t-this._prevAnimationFrameTime;if(this._prevAnimationFrameTime=t,this.debug){const t=e<=0?"--":String(Math.round(1e3/e)).padStart(2,"0");if(this._fpsElement.innerText!==t&&(this._fpsElement.innerText=t),this.mode===r){let t=`${this._width}x${this._height}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}else{let t=`${this._width}x${this._height}|${this.shadowRoot.host.clientWidth}x${this.shadowRoot.host.clientHeight}`;this._dimensionElement.innerText!==t&&(this._dimensionElement.innerText=t)}}this.dispatchEvent(new CustomEvent("frame",{detail:{now:t,prev:this._prevAnimationFrameTime,delta:e,context:this._canvasContext},bubbles:!1,composed:!0}))}pause(){cancelAnimationFrame(this._animationRequestHandle)}resume(){this._animationRequestHandle=requestAnimationFrame(this.update)}clear(t){t?(this._canvasContext.fillStyle="black",this._canvasContext.fillRect(0,0,this._canvasElement.clientWidth,this._canvasElement.clientHeight)):this._canvasContext.clearRect(0,0,this._canvasElement.clientWidth,this._canvasElement.clientHeight)}updateCanvasSize(){let t=this.shadowRoot.host.getBoundingClientRect();const e=t.width,n=t.height;let i=this._canvasElement,s=this._width,o=this._height;const u=this.mode;if(u===h)s=e,o=n;else if(u!==r){if(e<s||n<o||u===a){let t=e/s,i=n/o;t<i?(s=e,o*=t):(s*=i,o=n)}}s=Math.floor(s),o=Math.floor(o),i.width===s&&i.height===o||(i.width=s,i.height=o,i.style=`width: ${s}px; height: ${o}px`,this.dispatchEvent(new CustomEvent("resize",{detail:{width:s,height:o},bubbles:!1,composed:!0})))}getCanvas(){return this._canvasElement}getContext(){return this._canvasContext}get onframe(){return this._onframe}set onframe(t){this._onframe&&this.removeEventListener("frame",this._onframe),this._onframe=t,this._onframe&&this.addEventListener("frame",t)}get width(){return this._width}set width(t){this.setAttribute("width",t)}get height(){return this._height}set height(t){this.setAttribute("height",t)}get mode(){return this.getAttribute("mode")}set mode(t){this.setAttribute("mode",t)}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get debug(){return this.hasAttribute("debug")}set debug(t){t?this.setAttribute("debug",""):this.removeAttribute("debug")}}var c,p;function m(t,e,n=320,i=n){p=e,(c=t).width=n,c.height=i}function f(){return p}function y(){return c.clientWidth}function g(){return c.clientHeight}window.customElements.define("display-port",l),window.addEventListener("DOMContentLoaded",()=>{if(!c){let t=null,e=null,n=document.querySelector("display-port");n?(t=n.getCanvas(),e=n.getContext()):t=document.querySelector("canvas"),t&&(e||(e=t.getContext("2d")),m(t,e))}});var _=Object.freeze({__proto__:null,createCanvas:function(t=320,e=t,n=document.body){const i=document.createElement("canvas");n.appendChild(i),m(i,t,e)},attachCanvas:m,drawBufferToScreen:function(t,e=0,n=0,i=y(),s=g()){f().drawImage(t.canvas,e,n,i,s)},getCanvas:function(){return c},getDrawContext:f,getClientWidth:y,getClientHeight:g,getClientOffsetX:function(){return c.offsetLeft},getClientOffsetY:function(){return c.offsetTop}});function v(t){return t.name||t.toString()}var w=Object.freeze({__proto__:null,getComponentTypeName:v});const b=Symbol("operator"),x=Symbol("handler");class E{static select(t,e){return new E(e,!1).select(t)}static computeKey(t){let e=[];for(let n of t)"object"==typeof n&&b in n?e.push(n[b].toString()+v(n)):e.push(v(n));return e.sort().join("-")}constructor(t,e=!0){this._included=[],this._operated={};for(let e of t)if("object"==typeof e&&b in e){const t=e[b];t in this._operated?this._operated[t].components.push(e.component):this._operated[t]={components:[e.component],handler:e[x]}}else this._included.push(e);this.entityManager=null,this.persistent=e,this.entityIds=new Set,this.key=E.computeKey(t),this.onEntityCreate=this.onEntityCreate.bind(this),this.onEntityDestroy=this.onEntityDestroy.bind(this),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this)}matches(t,e){if(this.entityManager!==t)return!1;if(!t.hasComponent(e,...this._included))return!1;for(let n of Object.getOwnPropertyNames(this._operated))if(!n[x].call(this,t,e,n.components))return!1;return!0}select(t){let e=this.entityManager===t;if(this.persistent&&e)return this.entityIds;const n=this.entityManager;this.entityManager=t,this.entityIds.clear();for(let e of t.getEntityIds())this.matches(t,e)&&this.entityIds.add(e);return this.persistent&&!e&&(n&&(n.entityHandler.off("create",this.onEntityCreate),n.entityHandler.off("destroy",this.onEntityDestroy),n.componentHandler.off("add",this.onComponentAdd),n.componentHandler.off("remove",this.onComponentRemove)),this.entityManager.entityHandler.on("create",this.onEntityCreate),this.entityManager.entityHandler.on("destroy",this.onEntityDestroy),this.entityManager.componentHandler.on("add",this.onComponentAdd),this.entityManager.componentHandler.on("remove",this.onComponentRemove)),this.entityIds}selectComponent(t,e=this._included[0]){let n=this.select(t),i=[];for(let s of n)i.push(t.getComponent(s,e));return i}clear(){this.persistent&&(this.entityManager.entityHandler.off("create",this.onEntityCreate),this.entityManager.entityHandler.off("destroy",this.onEntityDestroy),this.entityManager.componentHandler.off("add",this.onComponentAdd),this.entityManager.componentHandler.off("remove",this.onComponentRemove)),this.entityIds.clear(),this.entityManager=null}onEntityCreate(t){this.matches(this.entityManager,t)&&this.entityIds.add(t)}onEntityDestroy(t){this.entityIds.has(t)&&this.entityIds.delete(t)}onComponentAdd(t,e,n,i){this.onComponentRemove(t,e,n)}onComponentRemove(t,e,n){this.matches(this.entityManager,t)?this.entityIds.add(t):this.entityIds.has(t)&&this.entityIds.delete(t)}}class C{constructor(){this._entities=new Set,this._nextAvailableEntityId=1,this._listeners=new Map}addEntityListener(t,e,n,i){const s=i&&void 0!==i.handle?i.handle:n;if(this._listeners.has(t)){let i=this._listeners.get(t);if(e in i){i[e].set(s,n)}else{let t=new Map;t.set(s,n),i[e]=t}}else{let r=new Set,o=new Map;o.set(s,n),i.once&&r.add(s);let a={onces:r,[e]:o};this._listeners.set(t,a)}}removeEntityListener(t,e,n,i){if(this._listeners.has(t)){let i=this._listeners.get(t);e in i&&(i[e].delete(n),i.onces.has(n)&&i.onces.delete(n))}}dispatchEntityEvent(t,e,n){if(this._listeners.has(t)){let i=this._listeners.get(t);if(e in i){let t=i.onces,s=i[e];for(let[e,i]of s.entries())i.apply(void 0,n),t.has(e)&&s.delete(e)}}}addEntityId(t){this._entities.add(t)}deleteEntityId(t){this._entities.delete(t),this.dispatchEntityEvent(t,"destroy",[t])}hasEntityId(t){return this._entities.has(t)}getNextAvailableEntityId(){return this._nextAvailableEntityId++}getEntityIds(){return this._entities}}class M{constructor(t){if(!t)throw new Error("Cannot create entity in null world.");const e=t.createEntity();t.componentHandler.putComponent(e,M,this,void 0),this.id=e}copy(t){throw new Error("Unsupported operation; cannot be initialized by existing values.")}reset(){return!1}}class S{constructor(t){this._entityHandler=t,this.componentTypeInstanceMap=new Map}createComponent(t,e){let n,i=typeof t;if("object"===i){if(!("create"in t))throw new Error(`Instanced component class '${getComponentTypeName(t)}' must at least have a static create() function.`);n=t.create(this)}else if("function"===i){if(t.prototype instanceof M)throw new Error("This component cannot be added to an existing entity; it can only initialize itself.");n=new t(this)}else{if("symbol"===i)throw new Error("Symbols are not yet supported as components.");n=t}return e&&this.copyComponent(t,n,e),n}putComponent(t,e,n=e,i){let s;if(this.componentTypeInstanceMap.has(e)?s=this.componentTypeInstanceMap.get(e):this.componentTypeInstanceMap.set(e,s=new Map),s.has(t))throw new Error(`Cannot add more than one instance of component class '${getComponentTypeName(e)}' for entity '${t}'.`);s.set(t,n),this._entityHandler.dispatchEntityEvent(t,"componentadd",[t,e,n,i])}deleteComponent(t,e,n){let i;return this.componentTypeInstanceMap.get(e).delete(t),i=e!==n&&("reset"in e?e.reset(n):"reset"in n&&n.reset()),this._entityHandler.dispatchEntityEvent(t,"componentremove",[t,e,n]),n}copyComponent(t,e,n){if(t!==e)if("copy"in t)t.copy(e,n);else if("copy"in e)e.copy(n);else for(let t of Object.getOwnPropertyNames(n))e[t]=n[t]}hasComponentType(t){return this.componentTypeInstanceMap.has(t)}getComponentTypes(){return this.componentTypeInstanceMap.keys()}getComponentInstanceMapByType(t){return this.componentTypeInstanceMap.get(t)}getComponentInstanceMaps(){return this.componentTypeInstanceMap.values()}}class T{constructor(){this.entityHandler=new C,this.componentHandler=new S(this.entityHandler)}clear(){for(let t of this.entityHandler.getEntityIds())this.destroyEntity(t)}createEntity(...t){const e=this.entityHandler.getNextAvailableEntityId();this.entityHandler.addEntityId(e);for(let n of t)this.addComponent(e,n);return e}destroyEntity(t){for(let e of this.componentHandler.getComponentTypes())this.componentHandler.getComponentInstanceMapByType(e).has(t)&&this.removeComponent(t,e);this.entityHandler.deleteEntityId(t)}hasEntity(t){return this.entityHandler.hasEntityId(t)}getEntityIds(){return this.entityHandler.getEntityIds()}addComponent(t,e,n){try{let i=this.componentHandler.createComponent(e,n);return this.componentHandler.putComponent(t,e,i,n),i}catch(n){console.error(`Failed to add component '${v(e)}' to entity '${t}'.`),console.error(n)}}addTagComponent(t,e){try{let n=typeof e;if("symbol"===n)throw new Error("Symbols are not yet supported as tag components.");if("number"===n)throw new Error("Numbers are not yet supported as tag components.");if("string"!==n)throw new Error(`Component of type '${n}' cannot be a tag component.`);return this.componentHandler.putComponent(t,e),e}catch(n){console.error(`Failed to add tag component '${v(e)}' to entity '${t}'.`),console.error(n)}}removeComponent(t,e){try{let n=this.getComponent(t,e);return this.componentHandler.deleteComponent(t,e,n),n}catch(n){console.error(`Failed to remove component '${v(e)}' from entity '${t}'.`),console.error(n)}}clearComponents(t){for(let e of this.componentHandler.getComponentInstanceMaps())if(e.has(t)){let n=e.get(t);this.componentHandler.deleteComponent(t,componentType,n)}}getComponentTypesByEntityId(t){let e=[];for(let n of this.componentHandler.getComponentTypes()){this.componentHandler.getComponentInstanceMapByType(n).has(t)&&e.push(n)}return e}getComponent(t,e){return this.componentHandler.getComponentInstanceMapByType(e).get(t)}hasComponent(t,...e){for(let n of e){if(!this.componentHandler.hasComponentType(n))return!1;if(!this.componentHandler.getComponentInstanceMapByType(n).has(t))return!1}return!0}countComponents(t){let e=0;for(let n of this.componentHandler.getComponentInstanceMaps())n.has(t)&&++e;return e}find(t){return E.select(this,t)}[Symbol.iterator](){return this.getEntityIds()[Symbol.iterator]()}}function O(t,e=Symbol(t.name)){let n=function(n){return{[OPERATOR]:e,[HANDLER]:t,component:n}};return Object.defineProperty(n,"name",{value:name,configurable:!0}),n}const A=O((function(t,e,n){return!t.hasComponent(e,...n)}),Symbol("!"));var k=Object.freeze({__proto__:null,createQueryOperator:O,Not:A});function I(t,e){return{}}function H(t,e){Object.assign(t,e)}function R(t){Object.getOwnPropertyNames(t).forEach(e=>delete t[e])}var L=Object.freeze({__proto__:null,createComponentFactory:function(t,e=I,n=H,i=R){return{name:t,create:e,copy:n,reset:i}}});const D=Symbol("defaultUndefined");class F{static get defaultValues(){return null}constructor(t,e,n=!0){"defaultValues"in this.constructor||(n?(this.constructor.defaultValues=null,this.constructor.defaultValues=new this.constructor):this.constructor.defaultValues=D)}copy(t){for(let e of Object.getOwnPropertyNames(t))this[e]=t[e]}reset(){if("defaultValues"in this.constructor){let t=this.constructor.defaultValues;if(t===D){for(let t of Object.getOwnPropertyNames(this))this[t]=void 0;return!0}return!!t&&(this.copy(this,this.constructor.defaultValues),!0)}return!1}}class ${}class j extends M{constructor(t){super(t),this.entityManager=t}destroy(){this.entityManager.destroyEntity(this.id)}addComponent(t,e){return this.entityManager.addComponent(this.id,t,e),this}addTagComponent(t){return this.entityManager.addTagComponent(this.id,t),this}removeComponent(t){return this.entityManager.removeComponent(this.id,t),this}hasComponent(t){return this.entityManager.hasComponent(this.id,t)}getComponent(t){return this.entityManager.getComponent(this.id,t)}}class P extends j{constructor(t){super(t),this.onComponentAdd=this.onComponentAdd.bind(this),this.onComponentRemove=this.onComponentRemove.bind(this),this.entityManager.entityHandler.addEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.addEntityListener(this.id,"componentremove",this.onComponentRemove)}onDestroy(){}onComponentAdd(t,e,n,i){this.id===t&&function(t,e,n){if("object"==typeof n){let i=Object.getOwnPropertyNames(t),s={};for(let t of Object.getOwnPropertyNames(n)){if(i.includes(t))throw new Error(`Conflicting property names in entity for component '${getComponentTypeName(e)}'.`);s[t]={get:()=>n[t],set(e){n[t]=e},configurable:!0}}Object.defineProperties(t,s)}}(this,e,n)}onComponentRemove(t,e,n){this.id===t&&(e===M?(this.entityManager.entityHandler.removeEntityListener(this.id,"componentadd",this.onComponentAdd),this.entityManager.entityHandler.removeEntityListener(this.id,"componentremove",this.onComponentRemove),this.onDestroy()):function(t,e,n){if("object"==typeof n)for(let e of Object.getOwnPropertyNames(n))delete t[e]}(this,0,n))}}var N=Object.freeze({__proto__:null,getEntityById:function(t,e){return getComponent(e,EntityComponent)},getEntities:function(t){let e=[],n=t.query([EntityComponent]);for(let i of n){let n=t.getComponent(i,EntityComponent);e.push(n)}return e}});class z{constructor(t){this.entityManager=t,this.id=t.createEntity()}add(t,e){return this.entityManager.addComponent(this.id,t,e),this}remove(t){return this.entityManager.removeComponent(this.id,t),this}has(...t){return this.entityManager.hasComponent(this.id,...t)}destroy(){this.entityManager.destroyEntity(this.id)}getEntityId(){return this.id}}var U=Object.freeze({__proto__:null,EntityWrapperBase:z,create:function(t){return new z(t)}});const W=Symbol("functionName"),B=Symbol("functionArguments");function K(t,e=[]){let n=t;for(let t of e)n="object"==typeof t&&W in t?n[t[W]](...t[B]):n[t];return n}function G(t,e){return[...t,e]}function q(t,e,n=[]){return[...t,{[W]:e,[B]:n}]}class X extends Array{static createRecord(t,e,n,i=[]){return{type:t,path:i,key:e,value:n}}addRecord(t,e,n,i=[]){let s=X.createRecord(t,e,n,i);return this.push(s),s}addRecords(t){this.push(...t)}}function V(t,e,n){switch(n.type){case"new":case"edit":return e[n.key]=n.value,!0;case"delete":return delete e[n.key],!0}return!1}var Y=Object.freeze({__proto__:null,isType:function(t){return Array.isArray(t)},applyDiff:function(t,e,n){switch(n.type){case"arrayObjectEdit":return e[n.key]=n.value,!0;case"arrayObjectAppend":return(i=n.key).length<s&&(i.length=s),e[n.key]=n.value,!0;case"arrayObjectSplice":return e.splice(n.key,n.value),!0}var i,s;return!1},computeDiff:function(t,e,n=[],i={}){let s=new X;const r=Math.min(t.length,e.length);for(let o=0;o<r;++o){let r=J(t[o],e[o],G(n,o),i);r?s.addRecords(r):s.addRecord("arrayObjectEdit",o,e[o],n)}if(!i.preserveSource&&t.length>e.length)s.addRecord("arrayObjectSplice",e.length,t.length-e.length,n);else if(e.length>t.length)for(let i=t.length;i<e.length;++i)s.addRecord("arrayObjectAppend",i,e[i],n);return s}});var Q=Object.freeze({__proto__:null,isType:function(t){return t instanceof Set},applyDiff:function(t,e,n){switch(n.type){case"setAdd":return e.add(n.key),!0;case"setDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],i={}){let s=new X;for(let i of e)t.has(i)||s.addRecord("setAdd",i,void 0,n);if(!i.preserveSource)for(let i of t)e.has(i)||s.addRecord("setDelete",i,void 0,n);return s}});const Z={handlers:[Y,Object.freeze({__proto__:null,isType:function(t){return t instanceof Map},applyDiff:function(t,e,n){switch(n.type){case"mapNew":case"mapSet":return e.set(n.key,n.value),!0;case"mapDelete":return e.delete(n.key),!0}return!1},computeDiff:function(t,e,n=[],i={}){let s=new X;for(let[r,o]of e)if(t.has(r)){let e=J(t.get(r),o,q(n,"get",[r]),i);e?s.addRecords(e):s.addRecord("mapSet",r,o,n)}else s.addRecord("mapNew",r,o,n);if(!i.preserveSource)for(let i of t.keys())e.has(i)||s.addRecord("mapDelete",i,void 0,n);return s}}),Q],preserveSource:!0,maxDepth:1e3};function J(t,e,n=[],i=Z){if(n.length>=i.maxDepth)return null;if(typeof t!=typeof e)return null;if("object"==typeof t){for(let s of i.handlers){let r=s.isType(t);if(r^s.isType(e))return null;if(r)return s.computeDiff(t,e,n,i)}return function(t,e,n=[],i={}){let s=new X,r=new Set(Object.getOwnPropertyNames(t));for(let o of Object.getOwnPropertyNames(e))if(r.has(o)){r.delete(o);let a=J(t[o],e[o],G(n,o),i);a?s.addRecords(a):s.addRecord("edit",o,e[o],n)}else s.addRecord("new",o,e[o],n);if(!i.preserveSource)for(let t of r)s.addRecord("delete",t,void 0,n);return s}(t,e,n,i)}return t===e?[]:null}function tt(t,e,n=Z){let i=t;for(let s of e){i=K(t,s.path);let e=!1;for(let r of n.handlers)if(e=r.applyDiff(t,i,s),e)break;e||V(0,i,s)}return t}function et(t,e,n){const i=t.entityConstructor,s=t.entityManagers,r=e.entityConstructor;e.entityManagers;let o=new T,a=n&&n.worldObjectWrapper?n.worldObjectWrapper(o):o,h=i(a),u=r(a),d=new Map;for(let t of o.getComponentTypesByEntityId(u)){let e=o.getComponent(u,t),n=o.getComponent(h,t);if(n){let i=J(n,e);d.set(t,i)}else d.set(t,!0)}for(let t of o.getComponentTypesByEntityId(h))d.has(t)||d.set(t,!1);o.clear();for(let e of s)for(let n of t.entities.get(e).values())for(let[t,i]of d.entries())if("boolean"==typeof i)i?e.addComponent(n,t):e.removeComponent(n,t);else{tt(e.getComponent(n,t),i)}}class nt{constructor(t,e){this.moduleId=t.id,this.entityConstructor=e,this.entities=new Map}addEntity(t,e){if(this.entities.has(t))this.entities.get(t).add(e);else{let n=new Set;n.add(e),this.entities.set(t,n)}t.entityHandler.addEntityListener(e,"destroy",this.removeEntity.bind(this,t,e),{handle:`${this.moduleId}:${e}`})}removeEntity(t,e){t.entityHandler.removeEntityListener(e,"destroy",`${this.moduleId}:${e}`);let n=this.entities.get(t);n.delete(e),n.size<=0&&this.entities.delete(t)}replaceWith(t,e){(e&&e.replaceStrategy||et).call(void 0,this,t,e&&e.replaceOpts),this.entityConstructor=t.entityConstructor;for(let e of t.entityManagers)for(let n of t.entities.get(e).values())t.removeEntity(e,n),this.addEntity(e,n)}isEmpty(){return this.entities.size<=0}get entityManagers(){return this.entities.keys()}}const it=new Map;var st=Object.freeze({__proto__:null,enableForEntity:function(t,e,n){if(!it.has(t.id))throw new Error("Module must be accepted first for HER to enable hot entity replacement.");return it.get(t.id).addEntity(e,n),n},acceptForModule:function(t,e,n){let i=new nt(t,e);if(it.has(t.id)){console.log(`Reloading '${t.id}'...`),it.get(t.id).replaceWith(i,n)}else console.log(`Preparing '${t.id}'...`),it.set(t.id,i);return t},getInstanceForModuleId:function(t){return HER_MODULES.get(t)}});const rt=Symbol("any");class ot{static parse(t){let e=t.indexOf("["),n=t.indexOf("]"),i=t.indexOf("."),s=null,r=null,o=null;return s=e<=0||0===i?rt:t.substring(0,e),r=e<0||n<0||e+1===n?rt:t.substring(e+1,n),o=i<0||t.trim().endsWith(".")?rt:t.substring(i+1),new ot(s,r,o)}constructor(t,e,n){this.source=t,this.code=e,this.mode=n,this.string=`${this.source.toString()}[${this.code.toString()}].${this.mode.toString()}`}matches(t){return!(this.source!==rt&&t.source!==rt&&this.source!==t.source||this.code!==rt&&t.code!==rt&&this.code!==t.code||this.mode!==rt&&t.mode!==rt&&this.mode!==t.mode)}toString(){return this.string}}ot.ANY=rt;class at{constructor(t){this.prev=t,this.value=t,this.next=t}update(t,e){return!1}consume(){return this.next}poll(){return this.prev=this.value,this.value=this.next,this.next=this.consume(),this}}class ht extends at{constructor(t){super(!1),this.eventKeys=[];for(let e of t)this.eventKeys.push(ot.parse(e))}consume(){return!1}update(t,e=!0){for(let n of this.eventKeys)if(n.matches(t))return this.next=e,!0;return!1}}class ut extends at{constructor(t){super(0),this.eventKey=ot.parse(t)}consume(){switch(this.eventKey.string){case"mouse[pos].dx":case"mouse[pos].dy":return 0;case"mouse[pos].x":case"mouse[pos].y":default:return this.next}}update(t,e=1){return!!this.eventKey.matches(t)&&(this.next=e,!0)}}class dt extends at{constructor(t){super(0),this.eventKeyEntries=[];for(let e of Object.keys(t))this.eventKeyEntries.push({key:ot.parse(e),value:t[e]})}update(t,e=!0){if(e)for(let e of this.eventKeyEntries)if(e.key.matches(t))return this.next=e.value,!0;return!1}}function lt(){return{_source:null,_priority:0,_active:!0,inputs:new Map,get active(){return this._active},get source(){return this._source},get priority(){return this._priority},attach(t){return this._source=t,this._source.addContext(this),this},detach(){return this._source.removeContext(this),this._source=null,this},setPriority(t){if(t>100||t<-100)throw new Error("Context priority must be between [-100, 100].");return this._priority!==t&&(this._source?(this._source.removeContext(this),this._priority=t,this._source.addContext(this)):this._priority=t),this},registerInput(t,e){return this.inputs.set(t,e),e},registerAction(t,...e){return this.registerInput(t,new ht(e))},registerRange(t,e){return this.registerInput(t,new ut(e))},registerState(t,e){return this.registerInput(t,new dt(e))},toggle(t){return void 0===t&&(t=!this._active),this._active=t,this},enable(){return this.toggle(!0)},disable(){return this.toggle(!1)},poll(){for(let t of this.inputs.values())t.poll()},update(t,e){let n;for(let i of this.inputs.values())n|=i.update(t,e);return n}}}var ct=Object.freeze({__proto__:null,MIN_CONTEXT_PRIORITY:-100,MAX_CONTEXT_PRIORITY:100,createContext:lt});class pt{constructor(){this.sourceElement=null,this.eventHandler=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}attach(t=document){return this.sourceElement=t,this.sourceElement.addEventListener("mousedown",this.onMouseDown),this.sourceElement.addEventListener("mouseup",this.onMouseUp),this.sourceElement.addEventListener("contextmenu",this.onContextMenu),document.addEventListener("mousemove",this.onMouseMove),this}detach(){return this.sourceElement.removeEventListener("mousedown",this.onMouseDown),this.sourceElement.removeEventListener("mouseup",this.onMouseUp),this.sourceElement.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("mousemove",this.onMouseMove),this.sourceElement=null,this}setEventHandler(t){return this.eventHandler=t,this}onMouseDown(t){if(!this.eventHandler)return;let e;e=this.eventHandler.call(this,`mouse[${t.button}].down`,!0),e&&(t.preventDefault(),t.stopPropagation())}onMouseUp(t){this.eventHandler&&(t.preventDefault(),t.stopPropagation(),this.eventHandler.call(this,`mouse[${t.button}].up`,!0))}onMouseMove(t){if(!this.eventHandler)return;const e=this.sourceElement,n=e.clientWidth,i=e.clientHeight;this.eventHandler.call(this,"mouse[pos].x",(t.pageX-e.offsetLeft)/n),this.eventHandler.call(this,"mouse[pos].y",(t.pageY-e.offsetTop)/i),this.eventHandler.call(this,"mouse[pos].dx",t.movementX/n),this.eventHandler.call(this,"mouse[pos].dy",t.movementY/i)}onContextMenu(t){t.preventDefault(),t.stopPropagation()}}class mt{constructor(){this.sourceElement=null,this.eventHandler=null,this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this)}attach(t=document){return this.sourceElement=t,this.sourceElement.addEventListener("keydown",this.onKeyDown),this.sourceElement.addEventListener("keyup",this.onKeyUp),this}detach(){return this.sourceElement.removeEventListener("keydown",this.onKeyDown),this.sourceElement.removeEventListener("keyup",this.onKeyUp),this.sourceElement=null,this}setEventHandler(t){return this.eventHandler=t,this}onKeyDown(t){if(!this.eventHandler)return;let e;e=t.repeat?this.eventHandler.call(this,`key[${t.key}].repeat`,!0):this.eventHandler.call(this,`key[${t.key}].down`,!0),e&&(t.preventDefault(),t.stopPropagation())}onKeyUp(t){if(!this.eventHandler)return;let e;e=this.eventHandler.call(this,`key[${t.key}].up`,!0),e&&(t.preventDefault(),t.stopPropagation())}}function ft(){let t={_contexts:new Array(200),element:null,keyboard:new mt,mouse:new pt,attach(t){return this.element=t,this.keyboard.attach(),this.mouse.attach(t),this},detach(){return this.element=null,this.keyboard.detach(),this.mouse.detach(),this},addContext(t){const e=t.priority- -100;return this._contexts[e]||(this._contexts[e]=[]),this._contexts[e].push(t),this},removeContext(t){const e=t.priority- -100;let n=this._contexts[e];return n&&n.splice(n.indexOf(t),1),this},poll(){for(let t of this._contexts)if(t)for(let e of t)e.active&&e.poll()},handleEvent(t,e){const n=ot.parse(t);for(let t of this._contexts)if(t)for(let i of t)if(i.active){let t;if(t=i.update(n,e),t)return!0}return!1}};return t.handleEvent=t.handleEvent.bind(t),t.keyboard.setEventHandler(t.handleEvent),t.mouse.setEventHandler(t.handleEvent),t}var yt=Object.freeze({__proto__:null,createSource:ft});let gt=300;class _t extends ht{constructor(t){super(t),this.actionTime=0}update(t,e=!0){let n=Date.now();for(let i of this.eventKeys)if(i.matches(t))return e?n-this.actionTime<=gt?(this.actionTime=0,this.next=!0,!0):(this.actionTime=n,!1):(this.next=!1,!0);return!1}}var vt=ft(),wt=lt().attach(vt);function bt(t){return vt.element&&vt.detach(),vt.attach(t)}window.addEventListener("DOMContentLoaded",()=>{if(!vt.element){let t=null,e=document.querySelector("display-port");t=e?e.getCanvas():document.querySelector("canvas"),t&&bt(t)}});var xt=1;function Et(){return`__input#${xt++}`}var Ct=Object.freeze({__proto__:null,attachCanvas:bt,createContext:function(t=0,e=!0){return lt().setPriority(t).toggle(e).attach(vt)},createInput:function(t){return wt.registerInput(Et(),t)},createAction:function(...t){return wt.registerAction(Et(),...t)},createRange:function(t){return wt.registerRange(Et(),t)},createState:function(t){return wt.registerState(Et(),t)},poll:function(){return vt.poll()},handleEvent:function(t,e){return vt.handleEvent(t,e)}});function Mt(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,Mt)}class St{constructor(t){this._heap=[],this._comparator=t}get size(){return this._heap.length}clear(){this._heap.length=0}push(...t){for(const e of t)this._heap.push(e),this._shiftUp()}pop(){const t=this.peek();let e=this._heap.length-1;return e>0&&this._swap(0,e),this._heap.pop(),this._shiftDown(),t}replace(t){const e=this.peek();return this._heap[0]=t,this._shiftDown(),e}peek(){return this._heap[0]}_compare(t,e){return this._comparator(this._heap[t],this._heap[e])}_swap(t,e){let n=this._heap[t];this._heap[t]=this._heap[e],this._heap[e]=n}_shiftUp(){let t,e=this._heap.length-1;for(;e>0&&this._compare(e,t=(e+1>>>1)-1);)this._swap(e,t),e=t}_shiftDown(){const t=this._heap.length;let e,n=0,i=Tt(n),s=i<t,r=Ot(n),o=r<t;for(;s&&this._compare(i,n)||o&&this._compare(r,n);)e=o&&this._compare(r,i)?r:i,this._swap(n,e),n=e,i=Tt(n),s=i<t,r=Ot(n),o=r<t}values(){return this._heap}[Symbol.iterator](){return this._heap[Symbol.iterator]()}}function Tt(t){return 1+(t<<1)}function Ot(t){return t+1<<1}const At={on(t,e,n=e){let i;if(this.__events.has(t)?i=this.__events.get(t):(i=new Map,this.__events.set(t,i)),i.has(n))throw new Error(`Found callback for event '${t}' with the same handle '${n}'.`);return i.set(n,e),this},off(t,e){if(!this.__events.has(t))throw new Error(`Unable to find event '${t}'.`);{const n=this.__events.get(t);if(!n.has(e))throw new Error(`Unable to find callback for event '${t}' with handle '${e}'.`);n.delete(e)}return this},once(t,e,n=e){return this.on(t,(...i)=>{this.off(t,n),e.apply(this.__context||this,i)},n)},emit(t,...e){if(this.__events.has(t)){let n=[];const i=Array.from(this.__events.get(t).values());for(const t of i){let i=t.apply(this.__context||this,e);i&&n.push(i)}return n}return this.__events.set(t,new Map),[]}};function kt(t){const e=Object.create(At);return e.__events=new Map,e.__context=t,e}function It(t,e){const n=Object.assign(t,At);return n.__events=new Map,n.__context=e,n}function Ht(t,e){const n=t.prototype;return Object.assign(n,At),n.__events=new Map,n.__context=e,n}var Rt={create:kt,assign:It,mixin:Ht},Lt=Object.freeze({__proto__:null,create:kt,assign:It,mixin:Ht,default:Rt});class Dt extends HTMLElement{static currentTime(){return performance.now()}static get observedAttributes(){return["onstart","onstop","onpreupdate","onupdate","onfixedupdate","onpostupdate","onpause","onresume"]}constructor(t=!0,e=!1){super(),this._controlled=e,this._connectedStart=t,this._animationFrameHandle=null,this.prevFrameTime=0,this.started=!1,this.paused=!1,this.fixedTimeStep=1/60,this.prevAccumulatedTime=0,this._onstart=null,this._onstop=null,this._onpreupdate=null,this._onupdate=null,this._onfixedupdate=null,this._onpostupdate=null,this._onpause=null,this._onresume=null,this.onAnimationFrame=this.onAnimationFrame.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this)}setFixedUpdatesPerSecond(t){return this.fixedTimeStep=1/t,this}connectedCallback(){window.addEventListener("focus",this.onWindowFocus),window.addEventListener("blur",this.onWindowBlur),this._connectedStart&&this.start()}disconnectedCallback(){window.removeEventListener("focus",this.onWindowFocus),window.removeEventListener("blur",this.onWindowBlur),this.stop()}attributeChangedCallback(t,e,n){switch(t){case"onstart":this._onstart=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onstop":this._onstop=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onpreupdate":this._onpreupdate=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onupdate":this._onupdate=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onfixedupdate":this._onfixedupdate=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onpostupdate":this._onpostupdate=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onpause":this._onpause=new Function("event",`with(document){with(this){${n}}}`).bind(this);break;case"onresume":this._onresume=new Function("event",`with(document){with(this){${n}}}`).bind(this)}}onWindowFocus(){this.started&&this.resume()}onWindowBlur(){this.started&&this.pause()}onAnimationFrame(t){if(this._controlled)throw new Error("Cannot run controlled game loop; call step() instead.");if(!this.started)throw new Error("Must be called after start().");this.animationFrameHandle=requestAnimationFrame(this.onAnimationFrame),this.step(t)}step(t=Dt.currentTime()){if(!this.started)return!1;const e=.001*(t-this.prevFrameTime);if(this.prevFrameTime=t,this.paused)return!1;if(this.dispatchEvent(new CustomEvent("preupdate",{detail:{delta:e},bubbles:!1,composed:!0})),this.dispatchEvent(new CustomEvent("update",{detail:{delta:e},bubbles:!1,composed:!0})),this.prevAccumulatedTime+=e,this.prevAccumulatedTime>250*this.fixedTimeStep){let t=250*this.fixedTimeStep,e=(this.prevAccumulatedTime-t)/this.fixedTimeStep;this.prevAccumulatedTime=t,console.error(`[ApplicationLoop] Too many updates! Skipped ${e} fixed updates.`)}for(;this.prevAccumulatedTime>=this.fixedTimeStep;)this.prevAccumulatedTime-=this.fixedTimeStep,this.dispatchEvent(new CustomEvent("fixedupdate",{bubbles:!1,composed:!0}));this.dispatchEvent(new CustomEvent("postupdate",{detail:{delta:e},bubbles:!1,composed:!0}))}start(){if(this.started)throw new Error("Loop already started.");this.started=!0,this.prevFrameTime=Dt.currentTime(),this.dispatchEvent(new CustomEvent("start",{bubbles:!1,composed:!0})),this.controlled||this.onAnimationFrame(this.prevFrameTime)}stop(){if(!this.started)throw new Error("Loop not yet started.");this.started=!1,this.dispatchEvent(new CustomEvent("stop",{bubbles:!1,composed:!0})),this._controlled||this.animationFrameHandle&&(cancelAnimationFrame(this.animationFrameHandle),this.animationFrameHandle=null)}pause(){this.paused||(this.paused=!0,this.dispatchEvent(new CustomEvent("pause",{bubbles:!1,composed:!0})))}resume(){this.pause&&(this.paused=!1,this.dispatchEvent(new CustomEvent("resume",{bubbles:!1,composed:!0})))}get onstart(){return this._onstart}set onstart(t){this._onstart&&this.removeEventListener("start",this._onstart),this._onstart=t,this._onstart&&this.addEventListener("start",t)}get onstop(){return this._onstop}set onstop(t){this._onstop&&this.removeEventListener("stop",this._onstop),this._onstop=t,this._onstop&&this.addEventListener("stop",t)}get onpreupdate(){return this._onpreupdate}set onpreupdate(t){this._onpreupdate&&this.removeEventListener("preupdate",this._onpreupdate),this._onpreupdate=t,this._onpreupdate&&this.addEventListener("preupdate",t)}get onupdate(){return this._onupdate}set onupdate(t){this._onupdate&&this.removeEventListener("update",this._onupdate),this._onupdate=t,this._onupdate&&this.addEventListener("update",t)}get onfixedupdate(){return this._onfixedupdate}set onfixedupdate(t){this._onfixedupdate&&this.removeEventListener("fixedupdate",this._onfixedupdate),this._onfixedupdate=t,this._onfixedupdate&&this.addEventListener("fixedupdate",t)}get onpostupdate(){return this._onpostupdate}set onpostupdate(t){this._onpostupdate&&this.removeEventListener("postupdate",this._onpostupdate),this._onpostupdate=t,this._onpostupdate&&this.addEventListener("postupdate",t)}get onpause(){return this._onpause}set onpause(t){this._onpause&&this.removeEventListener("pause",this._onpause),this._onpause=t,this._onpause&&this.addEventListener("pause",t)}get onresume(){return this._onresume}set onresume(t){this._onresume&&this.removeEventListener("resume",this._onresume),this._onresume=t,this._onresume&&this.addEventListener("resume",t)}}function Ft(t,e,n){return t<e?e:t>n?n:t}function $t(t,e,n,i,s){const r=t-n,o=e-i;return r*r+o*o<=s*s}function jt(t,e,n){return t+(e-t)*n}function Pt(t,e,n,i){let s=n-t,r=i-e;return Math.sqrt(s*s+r*r)}function Nt(t,e,n,i){let s=n-t,r=i-e;return Math.atan2(r,s)}function zt(t,e,n){return Ft(t+Ut(e-t,-Math.PI,Math.PI),t-n,t+n)}function Ut(t,e,n){let i=n-e,s=(t-e)%i;return s<0&&(s+=i),s+e}window.customElements.define("application-loop",Dt);const Wt=Ct.createContext().disable(),Bt=Wt.registerRange("x","mouse[pos].x"),Kt=Wt.registerRange("y","mouse[pos].y"),Gt=Wt.registerState("ldown",{"mouse[0].up":0,"mouse[0].down":1}),qt=Wt.registerState("rdown",{"mouse[2].up":0,"mouse[2].down":1}),Xt=Wt.registerAction("click","mouse.up"),Vt=Wt.registerAction("lclick","mouse[0].up"),Yt=Wt.registerAction("rclick","mouse[2].up");var Qt=Object.freeze({__proto__:null,CONTEXT:Wt,POS_X:Bt,POS_Y:Kt,LEFT_DOWN:Gt,RIGHT_DOWN:qt,CLICK:Xt,LEFT_CLICK:Vt,RIGHT_CLICK:Yt});const Zt=Ct.createContext().disable(),Jt=Zt.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),te=Zt.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),ee=Zt.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),ne=Zt.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1});var ie=Object.freeze({__proto__:null,CONTEXT:Zt,UP:Jt,DOWN:te,LEFT:ee,RIGHT:ne});const se=Symbol("gameInfo");async function re(t){return he(await ae(t))}async function oe(t){return fe(t),await ye(t),t}async function ae(t){t||(t={});let e=t.load&&await t.load(t)||Object.isExtensible(t)&&t||{},n={game:t,view:null,viewport:null,display:null,loop:null,onframe:me.bind(void 0,e),onpreupdate:de.bind(void 0,e),onupdate:le.bind(void 0,e),onfixedupdate:ce.bind(void 0,e),onpostupdate:pe.bind(void 0,e),onfirstupdate:ue.bind(void 0,e)};return Object.defineProperty(e,se,{value:n,enumerable:!1,configurable:!0}),e}function he(t){let e=document.querySelector("display-port");e||(e=new l,e.toggleAttribute("full"),e.toggleAttribute("debug"),document.body.appendChild(e));let n=t.view||new s,i=t.viewport||{x:0,y:0,get width(){return e.getCanvas().clientWidth},get height(){return e.getCanvas().clientHeight}},r=new Dt,o=t[se];return o.view=n,o.viewport=i,o.display=e,o.loop=r,r.addEventListener("update",o.onfirstupdate,{once:!0}),r.start(),t}function ue(t,e){let{game:n,display:i,loop:s,onpreupdate:r,onupdate:o,onpostupdate:a,onfixedupdate:h,onframe:u}=t[se];n.start&&n.start.call(t),r.call(t,e),o.call(t,e),h.call(t,e),a.call(t,e),s.addEventListener("preupdate",r),s.addEventListener("update",o),s.addEventListener("fixedupdate",h),s.addEventListener("postupdate",a),i.addEventListener("frame",u)}function de(t,e){let{game:n}=t[se],i=e.detail.delta;n.preupdate&&n.preupdate.call(t,i)}function le(t,e){let{game:n}=t[se],i=e.detail.delta;n.update&&n.update.call(t,i)}function ce(t,e){let{game:n}=t[se];n.fixedupdate&&n.fixedupdate.call(t)}function pe(t,e){let{game:n}=t[se],i=e.detail.delta;n.postupdate&&n.postupdate.call(t,i)}function me(t,e){let{game:n,display:i,view:s,viewport:r}=t[se],o=e.detail.context;s.context.setTransform(1,0,0,1,0,0),s.context.clearRect(0,0,s.width,s.height),n.render&&n.render.call(t,s,t),i.clear("black"),s.drawBufferToCanvas(o,r.x,r.y,r.width,r.height)}function fe(t){let{game:e,loop:n,display:i,onframe:s,onpreupdate:r,onupdate:o,onfixedupdate:a,onpostupdate:h,onfirstupdate:u}=t[se];return n.removeEventListener("update",u),n.removeEventListener("preupdate",r),n.removeEventListener("update",o),n.removeEventListener("fixedupdate",a),n.removeEventListener("postupdate",h),i.removeEventListener("frame",s),n.stop(),e.stop&&e.stop.call(t),t}async function ye(t){let{game:e}=t[se];return e.unload&&await e.unload(t),t}var ge=Object.freeze({__proto__:null,getGameInfo:function(t){return t[se]},begin:re,end:oe,loadGame:ae,startGame:he,pauseGame:async function(t){let{loop:e}=t[se];e.pause()},resumeGame:async function(t){let{loop:e}=t[se];e.resume()},stopGame:fe,unloadGame:ye,nextGame:async function(t,e){return await oe(t),await re(e)}});const _e=Ct.createContext().disable(),ve=_e.registerAction("continue","key.down","mouse.down");class we{constructor(t,e){this.splashText=t,this.nextScene=e}async load(t){_e.enable()}async unload(t){_e.disable()}onStart(){this.time=0}onUpdate(t){this.time+=t,ve.value&&this.time>75&&this.time<225&&(this.time=225),this.time>250&&(void 0)(this.nextScene)}onRender(t,e,n){let i=0;i=n.time<75?n.time/75:n.time>225?(250-n.time)/25:1,function(t,e,n,i,s=0,r=16,o="white"){t.translate(n,i),s&&t.rotate(s),t.textAlign="center",t.textBaseline="middle",t.font=`${r}px sans-serif`,t.fillStyle=o,t.fillText(e,0,0),s&&t.rotate(-s),t.translate(-n,-i)}(t,this.splashText,e.width/2,e.height/2,0,16,`rgba(255, 255, 255, ${i})`)}}var be=Object.freeze({__proto__:null,createSpawner:function(t){return{entities:new Set,factory:t,create(...t){return this.factory.apply(null,t)},destroy(t){this.entities.delete(t)},spawn(...t){let e=this.create(...t);return this.entities.add(e),e},clear(){this.entities.clear()},[Symbol.iterator](){return this.entities.values()}}}});const xe={};class Ee{constructor(){this.registry=new Map,this.sharedContext={},this._scene=null,this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null}setSharedContext(t){return this.sharedContext=t,this}register(t,e){if("string"!=typeof t)throw new Error("Scene name must be a string.");return this.registry.set(t,e),this}unregister(t){return this.registry.delete(t),this}nextScene(t,e=null,n={}){if(this._nextScene)throw new Error("Cannot change scenes during a scene transition.");if("string"==typeof t){if(!this.registry.has(t))throw new Error(`Cannot find scene with name '${t}'.`);t=this.registry.get(t)}if("function"==typeof t)t=new t;else{if("object"!=typeof t)throw new Error("Scene type not supported.");Object.isExtensible(t)||(i=t,t={...i})}var i;this._nextScene=t,this._nextLoadOpts=n,this._nextTransition=e||xe}update(t){if(this._transition)this._updateStep(t,this._transition);else if(this._nextScene){const t=this._nextScene,e=this._nextLoadOpts,n=this._nextTransition;this._nextScene=null,this._nextLoadOpts=null,this._nextTransition=null,this._transition=n;let i=Promise.resolve(),s=this._scene;s&&("onStop"in s&&s.onStop(this.sharedContext),"unload"in s&&(i=i.then(()=>s.unload(this.sharedContext)))),"load"in t&&(i=i.then(()=>t.load(this.sharedContext,e))),i=i.then(()=>{this._scene=t,this._transition=null,"onStart"in this._scene&&this._scene.onStart(this.sharedContext)})}else this._scene&&this._updateStep(t,this._scene)}_updateStep(t,e){"onPreUpdate"in e&&e.onPreUpdate(t),this.emit("preupdate",t),"onUpdate"in e&&e.onUpdate(t),this.emit("update",t),"onPostUpdate"in e&&e.onPostUpdate(t),this.emit("postupdate",t)}getCurrentScene(){return this._scene}getNextScene(){return this._nextScene}[Symbol.iterator](){return this.registry[Symbol.iterator]()}}Lt.mixin(Ee);class Ce{async load(t,e){}async unload(t){}onStart(t){}onStop(t){}onPreUpdate(t){}onUpdate(t){}onPostUpdate(t){}}class Me{getProjectionMatrix(){return[1,0,0,1,0,0]}getViewMatrix(){return[1,0,0,1,0,0]}}class Se{constructor(t=0,e=0){this.matrix=[1,0,0,1,t,e]}setMatrix(t,e,n,i,s,r){return this.matrix[0]=t,this.matrix[1]=e,this.matrix[2]=n,this.matrix[3]=i,this.matrix[4]=s,this.matrix[5]=r,this}setPosition(t,e){return this.matrix[4]=t,this.matrix[5]=e,this}setRotation(t){return this.rotation=t,this}setScale(t,e=t){let n=Math.sin(this.rotation);return this.matrix[0]=t,this.matrix[1]=n*e,this.matrix[2]=-n*t,this.matrix[3]=e,this}get x(){return this.matrix[4]}set x(t){this.matrix[4]=t}get y(){return this.matrix[5]}set y(t){this.matrix[5]=t}get rotation(){return Math.atan2(-this.matrix[2],this.matrix[0])}set rotation(t){let e=this.scaleX,n=this.scaleY;t=Math.abs(t),this.matrix[1]=Math.sin(t)*n,this.matrix[2]=-Math.sin(t)*e}get scaleX(){return this.matrix[0]}set scaleX(t){let e=this.rotation;this.matrix[0]=t,this.matrix[2]=-Math.sin(e)*t}get scaleY(){return this.matrix[3]}set scaleY(t){let e=this.rotation;this.matrix[1]=Math.sin(e)*t,this.matrix[3]=t}get a(){return this.matrix[0]}get b(){return this.matrix[1]}get c(){return this.matrix[2]}get d(){return this.matrix[3]}get e(){return this.matrix[4]}get f(){return this.matrix[5]}get 0(){return this.matrix[0]}set 0(t){this.matrix[0]=t}get 1(){return this.matrix[1]}set 1(t){this.matrix[1]=t}get 2(){return this.matrix[2]}set 2(t){this.matrix[2]=t}get 3(){return this.matrix[3]}set 3(t){this.matrix[3]=t}get 4(){return this.matrix[4]}set 4(t){this.matrix[4]=t}get 5(){return this.matrix[5]}set 5(t){this.matrix[5]=t}get 6(){return 0}get 7(){return 0}get 8(){return 1}get length(){return 9}}class Te extends Me{static applyTransform(t,e,n=0,i=0){e.setOffset(n,i),t.setTransform(...e.getProjectionMatrix()),t.transform(...e.getViewMatrix())}static resetTransform(t){t.setTransform(1,0,0,1,0,0)}static followTarget(t,e,n=1){e&&(t.transform.x=jt(t.transform.x,e.x,n),t.transform.y=jt(t.transform.y,e.y,n))}constructor(t=0,e=0,n=1){super(),this.target=null,this.speed=n,this.transform=new Se,this.offsetX=t,this.offsetY=e}setOffset(t,e){return this.offsetX=t,this.offsetY=e,this}getProjectionMatrix(){return[this.transform.matrix[0],0,0,this.transform.matrix[3],this.offsetX,this.offsetY]}getViewMatrix(){let t=[...this.transform.matrix];return t[0]=Math.cos(this.transform.rotation),t[3]=t[0],t[4]=-t[4],t[5]=-t[5],t}}const Oe=new DOMPointReadOnly(0,0,0,1),Ae=new DOMPointReadOnly(32,32,0,1),ke=1/Math.log(2);function Ie(t,e,n,i,s=32,r=s,o=1,a=!1){t.beginPath();for(let n=i%r;n<e.height;n+=r)t.moveTo(0,n),t.lineTo(e.width,n);for(let i=n%s;i<e.width;i+=s)t.moveTo(i,0),t.lineTo(i,e.height);if(t.strokeStyle="#333333",t.lineWidth=o,t.stroke(),t.lineWidth=1,a){const a=Math.min(s/4,16);t.textAlign="left",t.textBaseline="top",t.font=`bold ${a}px monospace`,t.fillStyle="#333333";for(let a=i%r;a<e.height;a+=r)for(let h=n%s;h<e.width;h+=s)t.fillText(`(${Math.round((h-n)/s)},${Math.round((a-i)/r)})`,h+2*o,a+2*o)}}function He(t,e,n,i,s=i){const r=.6*i;t.textAlign="center",t.textBaseline="middle",t.font=`${r}px monospace`,t.translate(e,n),t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.strokeStyle="#FF0000",t.stroke(),t.fillStyle="#FF0000",t.fillText("x",i+r,0),t.beginPath(),t.moveTo(0,0),t.lineTo(0,s),t.strokeStyle="#00FF00",t.stroke(),t.fillStyle="#00FF00",t.fillText("y",0,s+r);const o=r/4;t.fillStyle="#0000FF",t.fillRect(-o/2,-o/2,o,o),t.fillText("z",r/2,r/2),t.translate(-e,-n)}var Re=Object.freeze({__proto__:null,drawWorldGrid:function(t,e,n){const i=new DOMMatrixReadOnly(n.getViewMatrix()),s=new DOMMatrixReadOnly(n.getProjectionMatrix()).multiply(i),r=s.transformPoint(Oe),o=s.transformPoint(Ae),a=o.x-r.x,h=o.y-r.y,u=Math.floor((Math.log(e.width)-Math.log(a))*ke);let d=Math.pow(2,u)*a,l=Math.pow(2,u)*h;0!==d&&0!==l&&(Ie(t,e,r.x,r.y,d,l,1,!1),Ie(t,e,r.x,r.y,d/2,l/2,.75,!1),Ie(t,e,r.x,r.y,d/4,l/4,.5,!1),Ie(t,e,r.x,r.y,d/8,l/8,.25,!1))},drawWorldTransformGizmo:function(t,e,n){const i=new DOMMatrixReadOnly(n.getViewMatrix()).transformPoint(Oe),s=e.width/32;t.fillStyle="#666666",t.textAlign="left",t.textBaseline="top",t.font=`${s}px monospace`,t.fillText(`(${-Math.floor(i.x)},${-Math.floor(i.y)})`,32,32),He(t,8,8,32,32)},drawGrid:Ie,drawTransformGizmo:He});const Le=Ct.createContext().disable(),De=Le.registerState("up",{"key[ArrowUp].up":0,"key[ArrowUp].down":1,"key[w].up":0,"key[w].down":1}),Fe=Le.registerState("down",{"key[ArrowDown].up":0,"key[ArrowDown].down":1,"key[s].up":0,"key[s].down":1}),$e=Le.registerState("left",{"key[ArrowLeft].up":0,"key[ArrowLeft].down":1,"key[a].up":0,"key[a].down":1}),je=Le.registerState("right",{"key[ArrowRight].up":0,"key[ArrowRight].down":1,"key[d].up":0,"key[d].down":1}),Pe=Le.registerState("zoomin",{"key[z].up":0,"key[z].down":1}),Ne=Le.registerState("zoomout",{"key[x].up":0,"key[x].down":1}),ze=Le.registerState("rollleft",{"key[q].up":0,"key[q].down":1}),Ue=Le.registerState("rollright",{"key[e].up":0,"key[e].down":1});var We=Object.freeze({__proto__:null,CONTEXT:Le,UP:De,DOWN:Fe,LEFT:$e,RIGHT:je,ZOOM_IN:Pe,ZOOM_OUT:Ne,ROLL_LEFT:ze,ROLL_RIGHT:Ue,doCameraMove:function(t,e=6,n=.02,i=.01){const s=je.value-$e.value,r=Fe.value-De.value,o=Ne.value-Pe.value;Ue.value,ze.value;let a=o*n+1,h=t.transform.scaleX*a,u=t.transform.scaleY*a;t.transform.setScale(h,u);let d=s*e/h,l=r*e/u;t.transform.x+=d,t.transform.y+=l}});class Be{next(){return Math.random()}}class Ke extends Be{constructor(t=0){super(),this._seed=Math.abs(t%2147483647),this._next=this._seed}next(){return this._next=Math.abs(16807*this._next%2147483647-1),this._next/2147483646}get seed(){return this._seed}}class Ge{constructor(t){this.generator=t}next(){return this.generator.next()}choose(t){return t[Math.floor(this.next()*t.length)]}range(t,e){return(e-t)*this.next()+t}sign(){return this.next()<.5?-1:1}}const qe=new class extends Ge{constructor(){super(new Be)}withGenerator(t){return new Ge(t)}withSeed(t){return new Ge(new Ke(t))}};t.AbstractCamera=Me,t.AbstractInputAdapter=at,t.ActionInputAdapter=ht,t.ApplicationLoop=Dt,t.Audio=i,t.Camera2D=Te,t.Camera2DControls=We,t.CameraHelper=Re,t.Component=w,t.ComponentBase=F,t.ComponentFactory=L,t.DOUBLE_ACTION_TIME=gt,t.Display=_,t.DisplayPort=l,t.DoubleActionInputAdapter=_t,t.Entity=N,t.EntityBase=j,t.EntityComponent=M,t.EntityManager=T,t.EntityQuery=E,t.EntitySpawner=be,t.EntityWrapper=U,t.EventKey=ot,t.Eventable=Lt,t.FineDiffStrategy=et,t.Game=ge,t.HotEntityModule=nt,t.HotEntityReplacement=st,t.Input=Ct,t.InputContext=ct,t.InputSource=yt,t.Keyboard=mt,t.MODE_CENTER=o,t.MODE_FIT=a,t.MODE_NOSCALE=r,t.MODE_STRETCH=h,t.Mouse=pt,t.MouseControls=Qt,t.MoveControls=ie,t.PriorityQueue=St,t.QueryOperator=k,t.Random=qe,t.RandomGenerator=Be,t.RandomInterface=Ge,t.RangeInputAdapter=ut,t.ReflexiveEntity=P,t.SceneBase=Ce,t.SceneManager=Ee,t.SimpleRandomGenerator=Ke,t.SplashScene=we,t.StateInputAdapter=dt,t.TagComponent=$,t.Transform2D=Se,t.View=s,t.clampRange=Ft,t.cycleRange=Ut,t.default=e,t.direction2=Nt,t.distance2=Pt,t.lerp=jt,t.lookAt2=zt,t.uuid=Mt,t.withinRadius=$t,Object.defineProperty(t,"__esModule",{value:!0})}));
